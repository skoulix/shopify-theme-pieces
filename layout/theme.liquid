<!doctype html>
<html class="no-js{% if settings.enable_smooth_scroll %} smooth-scroll-enabled{% endif %}{% if settings.enable_animations == false %} animations-disabled{% endif %}" lang="{{ request.locale.iso_code }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="{{ settings.color_primary }}">
    <meta name="theme-color" content="{{ settings.color_primary }}" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="{{ settings.color_background }}" media="(prefers-color-scheme: dark)">

    {%- comment -%} Resource Hints - Establish early connections to required origins {%- endcomment -%}
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    <link rel="dns-prefetch" href="https://shop.app">

    <link rel="canonical" href="{{ canonical_url }}">

    {% if settings.favicon != blank %}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
      <link rel="apple-touch-icon" href="{{ settings.favicon | image_url: width: 180, height: 180 }}">
    {% endif %}

    <title>
      {{ page_title }}
      {%- if current_tags %} &ndash; tagged "{{ current_tags | join: ', ' }}"{% endif %}
      {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif %}
      {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless %}
    </title>

    {% if page_description %}
      <meta name="description" content="{{ page_description | escape }}">
    {% endif %}

    {% render 'meta-tags' %}

    {%- comment -%} Structured Data (JSON-LD) {%- endcomment -%}
    {% render 'structured-data' %}

    {%- comment -%} CSS Variables & Font Loading {%- endcomment -%}
    {% render 'css-variables' %}

    {%- comment -%} Critical CSS - Inlined for fast initial render {%- endcomment -%}
    {% render 'critical-css' %}

    {%- comment -%} Accessibility utilities - Focus styles, screen reader support {%- endcomment -%}
    {% render 'accessibility' %}

    {%- comment -%} Error handling - Toast notifications, global error handler {%- endcomment -%}
    {% render 'error-handling' %}

    {%- comment -%} Non-critical CSS {%- endcomment -%}
    {{ 'phosphor-icons.css' | asset_url | stylesheet_tag }}
    {{ 'pieces-app.css' | asset_url | stylesheet_tag }}

    {%- comment -%} Pieces App - Swup, Lenis, GSAP (defer prevents render blocking) {%- endcomment -%}
    <script src="{{ 'pieces-app.js' | asset_url }}" type="module" defer></script>

    {{ content_for_header }}

    <script>
      document.documentElement.classList.replace('no-js', 'js');
      if (Shopify.designMode) document.documentElement.classList.add('shopify-design-mode');

      // Consolidated theme namespace to avoid global pollution
      window.Pieces = window.Pieces || {};

      // Theme settings - defined early so section scripts can access them
      window.Pieces.settings = {
        enableSmoothScroll: {{ settings.enable_smooth_scroll }},
        enableAnimations: {{ settings.enable_animations }},
        animationTriggerOffset: '{{ settings.animation_trigger_offset | default: "md" }}',
        enablePageTransitions: {{ settings.enable_page_transitions }},
        pageTransitionStyle: '{{ settings.page_transition_style | default: "slide" }}',
        cartType: '{{ settings.cart_type | default: "drawer" }}',
        moneyFormat: {{ shop.money_format | json }},
      };

      // Backwards compatibility - keep window.themeSettings for existing code
      window.themeSettings = window.Pieces.settings;

      // Global animation check - returns true if animations should run
      window.shouldAnimate = function() {
        return window.themeSettings.enableAnimations !== false &&
               !window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      };

      /**
       * Get ScrollTrigger start value based on theme animation trigger offset
       * Use this in section scripts for consistent animation timing
       * @param {string} defaultStart - Default start value (e.g., 'top 70%')
       * @returns {string} - Adjusted ScrollTrigger start value
       */
      window.getScrollStart = function(defaultStart) {
        var offset = window.themeSettings.animationTriggerOffset || 'md';
        var startValues = {
          none: defaultStart || 'top 85%',  // Trigger when element enters viewport
          sm: 'top 90%',                    // Early: element 10% visible
          md: 'top 80%',                    // Standard: element 20% visible
          lg: 'top 70%'                     // Late: element 30% visible
        };
        return startValues[offset] || startValues.md;
      };

      // Registry for swup event listeners to prevent duplicates
      window._swupListeners = window._swupListeners || {};

      /**
       * Register a swup:contentReplaced listener that only runs once per key
       * @param {string} key - Unique identifier for this listener
       * @param {Function} callback - Function to call on content replaced
       */
      window.onSwupContentReplaced = function(key, callback) {
        if (window._swupListeners[key]) return; // Already registered
        window._swupListeners[key] = true;
        window.addEventListener('swup:contentReplaced', callback);
      };

      // Global cleanup for elements moved to body that should be removed on page transition
      window.addEventListener('swup:contentReplaced', function() {
        // Remove sticky product bar from body when navigating away from product page
        // The bar is appended to body in sticky-product-bar.liquid but needs cleanup
        // when navigating to non-product pages
        const newContent = document.querySelector('#swup-container');
        const hasProductSection = newContent && newContent.querySelector('[data-product-form]');
        if (!hasProductSection) {
          document.querySelectorAll('body > [data-sticky-product-bar]').forEach(el => el.remove());
        }
      });
    </script>
  </head>

  <body class="antialiased bg-(--color-background) text-(--color-text) template-{{ template.name }}{% if template.suffix %} template-{{ template.name }}-{{ template.suffix }}{% endif %}">
    <a href="#main" class="skip-link">
      {{ 'accessibility.skip_to_text' | t }}
    </a>

    {% sections 'header-group' %}

    {%- comment -%} Spacer to prevent content jump when header is fixed {%- endcomment -%}
    <div class="header-spacer" data-header-spacer></div>

    {% render 'article-progress-bar' %}

    {%- comment -%} Main content wrapper for sticky footer reveal effect {%- endcomment -%}
    <div class="site-content" data-site-content>
      <main id="main" tabindex="-1">
        <div id="swup-container">
          {{ content_for_layout }}
        </div>
      </main>
    </div>

    {% sections 'footer-group' %}

    {%- comment -%} Cart Drawer or Notification based on theme settings {%- endcomment -%}
    {% case settings.cart_type %}
      {% when 'drawer' %}
        {% render 'cart-drawer' %}
      {% when 'notification' %}
        {% render 'cart-notification' %}
    {% endcase %}

    {%- comment -%} Newsletter Popup {%- endcomment -%}
    {% render 'newsletter-popup' %}

    {%- comment -%} Quick View Modal {%- endcomment -%}
    {% if settings.enable_quick_view %}
      {% render 'quick-view-modal' %}
    {% endif %}

    {%- comment -%} Size Chart Drawer - shell rendered here, content populated by product section {%- endcomment -%}
    {% render 'size-chart-drawer' %}

    {%- comment -%} Pickup Availability Drawer {%- endcomment -%}
    {% render 'pickup-availability-drawer' %}

    {%- comment -%} Compare Products Drawer {%- endcomment -%}
    {% if settings.enable_compare %}
      {% render 'compare-drawer' %}
    {% endif %}

    {%- comment -%} Wishlist Drawer {%- endcomment -%}
    {% if settings.enable_wishlist %}
      {% render 'wishlist-drawer' %}
    {% endif %}

    {%- comment -%} Quick Add Script {%- endcomment -%}
    <script>
      document.addEventListener('click', async function(e) {
        const quickAddBtn = e.target.closest('[data-quick-add]');
        if (!quickAddBtn) return;

        // Prevent double-clicks from triggering multiple adds
        if (quickAddBtn.disabled) return;

        e.preventDefault();
        e.stopPropagation(); // Prevent link navigation when button is inside an <a> tag
        const variantId = quickAddBtn.dataset.quickAdd;

        const addText = quickAddBtn.querySelector('[data-add-text]');
        const addingText = quickAddBtn.querySelector('[data-adding-text]');
        const addedText = quickAddBtn.querySelector('[data-added-text]');

        quickAddBtn.disabled = true;
        if (addText) addText.classList.add('hidden');
        if (addingText) addingText.classList.remove('hidden');

        try {
          const res = await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: variantId, quantity: 1 })
          });

          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(errorData.description || errorData.message || 'Failed to add to cart');
          }

          // Update cart count
          const cartRes = await fetch('/cart.js');
          const cart = await cartRes.json();
          document.querySelectorAll('[data-cart-count]').forEach(el => el.textContent = cart.item_count);

          // Dispatch cart updated event for reactive components (e.g., free shipping bar)
          document.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart } }));

          // Show success state
          if (addingText) addingText.classList.add('hidden');
          if (addedText) addedText.classList.remove('hidden');
          // For icon-only buttons (metro cards), add visual feedback class
          quickAddBtn.classList.add('is-added');

          // Handle cart type
          const cartType = window.themeSettings?.cartType || 'drawer';
          if (cartType === 'drawer') {
            document.dispatchEvent(new CustomEvent('cart:open', { detail: { skipFetch: true } }));
          } else if (cartType === 'notification') {
            // Get product info from the card for notification
            const card = quickAddBtn.closest('.product-card');
            const title = card?.querySelector('.product-card-title')?.textContent?.trim() || '';
            const image = card?.querySelector('.product-card-image img')?.src || '';
            document.dispatchEvent(new CustomEvent('cart:notification', {
              detail: {
                product: { title, image, variant_title: '' },
                cart: cart
              }
            }));
          } else if (cartType === 'page') {
            window.location.href = '/cart';
            return;
          }

          setTimeout(() => {
            quickAddBtn.disabled = false;
            quickAddBtn.classList.remove('is-added');
            if (addedText) addedText.classList.add('hidden');
            if (addText) addText.classList.remove('hidden');
          }, 2000);

        } catch (err) {
          quickAddBtn.disabled = false;
          if (addingText) addingText.classList.add('hidden');
          if (addText) addText.classList.remove('hidden');
          toast.error(err.message || 'Could not add to cart. Please try again.');
        }
      });
    </script>

    {%- comment -%} Page transition overlay for Swup (z-30 to stay below header z-40) {%- endcomment -%}
    {% if settings.enable_page_transitions %}
      <div class="page-transition-overlay fixed inset-0 z-30 pointer-events-none" style="background-color: {{ settings.page_transition_color | default: '#f5f5f5' }}; transform: scaleY(0);"></div>
    {% endif %}

    <script>
      window.routes = {
        rootUrl: '{{ routes.root_url }}',
        cartUrl: '{{ routes.cart_url }}',
        cart_add_url: '{{ routes.cart_add_url }}',
        cart_change_url: '{{ routes.cart_change_url }}',
        cart_update_url: '{{ routes.cart_update_url }}',
        predictive_search_url: '{{ routes.predictive_search_url }}',
        allProductsCollectionUrl: '{{ routes.all_products_collection_url }}',
      };

      window.themeStrings = {
        // Cart
        cartEmpty: `{{ 'cart.empty' | t }}`,
        cartEmptyDescription: `{{ 'cart.empty_description' | t }}`,
        cartStartShopping: `{{ 'cart.start_shopping' | t }}`,
        cartAddNote: `{{ 'cart.add_note' | t }}`,
        cartNotePlaceholder: `{{ 'cart.note_placeholder' | t }}`,
        cartSubtotal: `{{ 'cart.subtotal' | t }}`,
        cartTaxesNote: `{{ 'cart.taxes_shipping_note' | t }}`,
        cartViewCart: `{{ 'cart.view_cart' | t }}`,
        cartCheckout: `{{ 'cart.checkout' | t }}`,
        cartRemove: `{{ 'cart.remove' | t }}`,
        removeItem: `{{ 'cart.remove_item' | t }}`,
        error: `{{ 'sections.cart.cart_error' | t }}`,
        quantityError: `{{ 'sections.cart.cart_quantity_error_html' | t: quantity: '[quantity]' }}`,
        // Product
        addToCart: `{{ 'products.product.add_to_cart' | t }}`,
        soldOut: `{{ 'products.product.sold_out' | t }}`,
        unavailable: `{{ 'products.product.unavailable' | t }}`,
        // Accessibility
        decreaseQuantity: `{{ 'accessibility.decrease_quantity' | t }}`,
        increaseQuantity: `{{ 'accessibility.increase_quantity' | t }}`,
        quantity: `{{ 'accessibility.quantity' | t }}`,
        // General
        backHome: `{{ '404.back_home' | t }}`,
      };

      // Aliases
      window.Pieces.routes = window.routes;
      window.Pieces.strings = window.themeStrings;
      window.cartStrings = window.themeStrings;
      window.variantStrings = window.themeStrings;
    </script>
  </body>
</html>
