{%- comment -%}
  Logo Marquee Section - Infinite scrolling logo carousel with GSAP
  For "As seen in", partners, or brand logos
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = ''
    assign header_padding = '0'
    assign wrapper_max_width = 'none'
    assign wrapper_margin = '0'
    assign wrapper_padding = '0'
    assign mask_offset = '0'
  else
    assign container_class = 'page-container'
    assign header_padding = '0'
    assign wrapper_max_width = '1280px'
    assign wrapper_margin = '0 auto'
    assign wrapper_padding = '0 clamp(1rem, 3vw, 2rem)'
    assign mask_offset = 'clamp(1rem, 3vw, 2rem)'
  endif

  if section.settings.full_width and section.settings.label_alignment != 'center'
    assign header_padding = '0 var(--page-padding, clamp(1rem, 3vw, 2rem))'
  endif

  assign opacity = section.settings.logo_opacity | divided_by: 100.0

  capture filter_value
    if section.settings.grayscale
      echo 'grayscale(100%)'
    endif
    if section.settings.invert
      if section.settings.grayscale
        echo ' '
      endif
      echo 'invert(1)'
    endif
  endcapture

  capture filter_hover_value
    if section.settings.invert
      echo 'invert(1)'
    else
      echo 'none'
    endif
  endcapture
-%}

<section
  class="logo-marquee section-padding-sm color-{{ section.settings.color_scheme }}"
  style="--logo-marquee-align: {{ section.settings.label_alignment }}; --logo-marquee-header-padding: {{ header_padding }}; --logo-marquee-max-width: {{ wrapper_max_width }}; --logo-marquee-margin: {{ wrapper_margin }}; --logo-marquee-padding: {{ wrapper_padding }}; --logo-marquee-mask-offset: {{ mask_offset }}; --logo-marquee-height: {{ section.settings.logo_height }}px; --logo-marquee-max-logo-width: {{ section.settings.logo_max_width }}px; --logo-marquee-opacity: {{ opacity }}; --logo-marquee-filter: {{ filter_value | default: 'none' }}; --logo-marquee-filter-hover: {{ filter_hover_value }};"
  data-logo-marquee="{{ section.id }}"
  data-marquee-direction="{{ section.settings.direction }}"
  data-marquee-speed="{{ section.settings.speed }}"
  data-marquee-scroll-aware="{{ section.settings.scroll_aware }}"
  data-marquee-scroll-speed="{{ section.settings.scroll_speed }}"
  data-marquee-status="normal"
>
  <div class="{{ container_class }}">
    {% if section.settings.label != blank %}
      <div class="logo-marquee-header">
        <span class="text-label" data-tween data-tween-type="fade-up">
          {{ section.settings.label }}
        </span>
      </div>
    {% endif %}
  </div>

  <div class="logo-marquee-track-wrapper">
    <div class="logo-marquee-track" data-logo-track>
      {% for block in section.blocks %}
        <div class="logo-marquee-item" {{ block.shopify_attributes }}>
          {% if block.settings.logo != blank %}
            {% if block.settings.link != blank %}
              <a href="{{ block.settings.link }}" target="_blank" rel="noopener">
            {% endif %}

            {{ block.settings.logo | image_url: height: 200 | image_tag:
              loading: 'lazy',
          decoding: 'async',
              alt: block.settings.logo.alt | default: section.settings.label
            }}

            {% if block.settings.link != blank %}
              </a>
            {% endif %}
          {% else %}
            <div class="logo-marquee-placeholder">
              <i class="ph ph-image"></i>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const section = document.querySelector(`[data-logo-marquee="${sectionId}"]`);
  if (!section || section.dataset.marqueeInitialized) return;
  section.dataset.marqueeInitialized = 'true';

  const track = section.querySelector('[data-logo-track]');
  if (!track) return;

  // Configuration from data attributes
  const direction = section.dataset.marqueeDirection === 'right' ? 1 : -1;
  const baseSpeed = parseFloat(section.dataset.marqueeSpeed) || 30;
  const scrollAware = section.dataset.marqueeScrollAware === 'true';
  const scrollSpeedMultiplier = parseFloat(section.dataset.marqueeScrollSpeed) || 2;

  let tween = null;
  let isHovered = false;
  // Direction multiplier: -1 = left (content moves left/negative x), 1 = right (content moves right/positive x)
  // Setting "left" means visual movement to left, setting "right" means visual movement to right
  let currentDirection = direction === 1 ? 1 : -1; // right setting = 1, left setting = -1

  function initMarquee() {
    const gsap = window.pieces?.gsap || window.gsap;
    const ScrollTrigger = window.pieces?.ScrollTrigger || window.ScrollTrigger;

    if (!gsap || !ScrollTrigger) {
      requestAnimationFrame(initMarquee);
      return;
    }

    const items = track.querySelectorAll('.logo-marquee-item');
    if (items.length === 0) return;

    // Calculate total width of one set of items
    let oneSetWidth = 0;
    items.forEach(item => {
      oneSetWidth += item.offsetWidth;
    });

    // Clone items to fill the track for seamless loop
    const viewportWidth = window.innerWidth;
    const clonesNeeded = Math.ceil((viewportWidth * 3) / oneSetWidth) + 1;

    for (let i = 0; i < clonesNeeded; i++) {
      items.forEach(item => {
        const clone = item.cloneNode(true);
        clone.setAttribute('aria-hidden', 'true');
        clone.querySelectorAll('a').forEach(a => a.setAttribute('tabindex', '-1'));
        track.appendChild(clone);
      });
    }

    // Create wrap function for seamless looping
    const wrapX = gsap.utils.wrap(-oneSetWidth, 0);

    // Set initial position based on direction
    // For right direction (1), start at -oneSetWidth so we can move towards 0 (positive movement)
    // For left direction (-1), start at 0 so we can move towards -oneSetWidth (negative movement)
    const startX = currentDirection === 1 ? -oneSetWidth : 0;
    gsap.set(track, { x: startX });

    // Speed in pixels per second
    const pixelsPerSecond = oneSetWidth / baseSpeed;
    let currentX = startX;

    // Use gsap.ticker for smooth continuous animation
    function animate(time, deltaTime) {
      if (!tween || tween.paused) return;

      // Calculate movement based on direction and delta time
      const movement = (pixelsPerSecond * deltaTime / 1000) * currentDirection;
      currentX += movement;

      // Wrap the position
      currentX = wrapX(currentX);

      gsap.set(track, { x: currentX });
    }

    // Create a simple object to control play/pause state
    tween = {
      paused: false,
      pause: function() { this.paused = true; },
      play: function() { this.paused = false; },
      kill: function() { gsap.ticker.remove(animate); }
    };

    gsap.ticker.add(animate);

    // Scroll-aware direction inversion and acceleration (only if enabled in section settings)
    if (scrollAware) {
      const trackWrapper = section.querySelector('.logo-marquee-track-wrapper');
      // Store the initial direction for reference
      const initialDirection = currentDirection;
      let lastScrollY = window.scrollY;
      let scrollDelta = 0;
      const scrollThreshold = 50; // Minimum scroll distance to trigger direction change
      let currentScrollState = null; // null = initial, 'down' = scrolling down, 'up' = scrolling up

      // Direction inversion on scroll
      ScrollTrigger.create({
        trigger: section,
        start: 'top bottom',
        end: 'bottom top',
        onUpdate: function(self) {
          if (isHovered || !tween) return;

          // Calculate actual scroll delta
          const currentScrollY = window.scrollY;
          const delta = currentScrollY - lastScrollY;
          lastScrollY = currentScrollY;

          // Ignore tiny movements (Lenis settling, momentum)
          if (Math.abs(delta) < 3) return;

          // Accumulate scroll in same direction, reset if direction changes
          if ((delta > 0 && scrollDelta >= 0) || (delta < 0 && scrollDelta <= 0)) {
            scrollDelta += delta;
          } else {
            // Direction changed, reset delta
            scrollDelta = delta;
          }

          // Only trigger direction change after significant scroll
          if (Math.abs(scrollDelta) < scrollThreshold) return;

          // Determine new scroll state
          const newScrollState = scrollDelta > 0 ? 'down' : 'up';

          // Only change if scroll state actually changed
          if (currentScrollState === newScrollState) return;
          currentScrollState = newScrollState;
          scrollDelta = 0; // Reset after state change

          // Calculate new direction:
          // - Scroll down = NORMAL (same as initial)
          // - Scroll up = INVERTED (opposite of initial)
          let newDirection;
          if (newScrollState === 'down') {
            // Normal: same as initial direction
            newDirection = initialDirection;
            section.dataset.marqueeStatus = 'normal';
          } else {
            // Inverted: flip the initial direction
            newDirection = -initialDirection;
            section.dataset.marqueeStatus = 'inverted';
          }

          // Only change if direction actually changes
          if (currentDirection === newDirection) return;

          currentDirection = newDirection;
        }
      });

      // Scroll acceleration effect using scrub
      if (trackWrapper) {
        const scrollAcceleration = scrollSpeedMultiplier * 5; // Convert 1-5 to vw amount

        // Set wrapper styles for scroll effect
        trackWrapper.style.marginLeft = -scrollAcceleration + 'vw';
        trackWrapper.style.width = (scrollAcceleration * 2) + 100 + 'vw';

        // Create scrubbed timeline for scroll acceleration
        gsap.timeline({
          scrollTrigger: {
            trigger: section,
            start: 'top bottom',
            end: 'bottom top',
            scrub: 0
          }
        }).fromTo(trackWrapper,
          { x: (direction === -1 ? scrollAcceleration : -scrollAcceleration) + 'vw' },
          { x: (direction === -1 ? -scrollAcceleration : scrollAcceleration) + 'vw', ease: 'none' }
        );
      }
    }

    // Pause on hover
    let statusBeforeHover = section.dataset.marqueeStatus || 'normal';

    section.addEventListener('mouseenter', function() {
      statusBeforeHover = section.dataset.marqueeStatus || 'normal';
      isHovered = true;
      section.dataset.marqueeStatus = 'paused';
      tween.pause();
    });

    section.addEventListener('mouseleave', function() {
      isHovered = false;
      section.dataset.marqueeStatus = statusBeforeHover;
      tween.play();
    });

    // IntersectionObserver for play/pause optimization
    let statusBeforeOffscreen = section.dataset.marqueeStatus || 'normal';

    const observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          if (!isHovered && tween) {
            tween.play();
            section.dataset.marqueeStatus = statusBeforeOffscreen;
          }
        } else {
          if (tween) {
            statusBeforeOffscreen = section.dataset.marqueeStatus || 'normal';
            tween.pause();
            section.dataset.marqueeStatus = 'paused';
          }
        }
      });
    }, { threshold: 0 });

    observer.observe(section);
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMarquee);
  } else {
    requestAnimationFrame(initMarquee);
  }
})();
</script>

{% schema %}
{
  "name": "Logo Marquee",
  "tag": "section",
  "class": "logo-marquee-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "default": "As Featured In",
      "label": "Label"
    },
    {
      "type": "select",
      "id": "label_alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center",
      "label": "Label alignment"
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "select",
      "id": "direction",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left",
      "label": "Scroll direction"
    },
    {
      "type": "range",
      "id": "speed",
      "min": 10,
      "max": 60,
      "step": 5,
      "default": 30,
      "unit": "s",
      "label": "Animation speed",
      "info": "Duration for one complete loop"
    },
    {
      "type": "checkbox",
      "id": "scroll_aware",
      "default": true,
      "label": "Scroll-aware movement",
      "info": "Inverts direction and accelerates based on scroll"
    },
    {
      "type": "range",
      "id": "scroll_speed",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 2,
      "label": "Scroll acceleration",
      "info": "Max speed multiplier while scrolling"
    },
    {
      "type": "header",
      "content": "Logo Styling"
    },
    {
      "type": "range",
      "id": "logo_height",
      "min": 30,
      "max": 100,
      "step": 5,
      "default": 50,
      "unit": "px",
      "label": "Logo height"
    },
    {
      "type": "range",
      "id": "logo_max_width",
      "min": 80,
      "max": 200,
      "step": 10,
      "default": 120,
      "unit": "px",
      "label": "Logo max width"
    },
    {
      "type": "range",
      "id": "logo_opacity",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%",
      "label": "Logo opacity"
    },
    {
      "type": "checkbox",
      "id": "grayscale",
      "default": true,
      "label": "Grayscale logos",
      "info": "Color on hover"
    },
    {
      "type": "checkbox",
      "id": "invert",
      "default": false,
      "label": "Invert logos",
      "info": "Invert logo colors (useful for dark backgrounds)"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": true,
      "label": "Full width"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-2"
    }
  ],
  "blocks": [
    {
      "type": "logo",
      "name": "Logo",
      "settings": [
        {
          "type": "image_picker",
          "id": "logo",
          "label": "Logo image",
          "info": "Add alt text via the image's metadata in Files"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link (optional)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Logo Marquee",
      "category": "Social proof",
      "blocks": [
        { "type": "logo" },
        { "type": "logo" },
        { "type": "logo" },
        { "type": "logo" },
        { "type": "logo" },
        { "type": "logo" }
      ]
    }
  ]
}
{% endschema %}
