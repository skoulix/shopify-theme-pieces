{%- comment -%}
  Logo Marquee Section - Infinite scrolling logo carousel with GSAP
  For "As seen in", partners, or brand logos
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = ''
  else
    assign container_class = 'page-container'
  endif
-%}

<style>
  .logo-marquee-{{ section.id }} {
    padding: calc(var(--section-vertical-padding) * 0.6) 0;
    overflow: hidden;
  }

  .logo-marquee-header-{{ section.id }} {
    text-align: {{ section.settings.header_alignment }};
    margin-bottom: clamp(2rem, 4vh, 3rem);
  }

  .logo-marquee-label-{{ section.id }} {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.2em;
  }

  .logo-marquee-track-wrapper-{{ section.id }} {
    position: relative;
    overflow: hidden;
    {% unless section.settings.full_width %}
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 clamp(1rem, 3vw, 2rem);
    {% endunless %}
  }

  /* Gradient masks */
  .logo-marquee-track-wrapper-{{ section.id }}::before,
  .logo-marquee-track-wrapper-{{ section.id }}::after {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    width: clamp(50px, 10vw, 150px);
    z-index: 2;
    pointer-events: none;
  }

  .logo-marquee-track-wrapper-{{ section.id }}::before {
    left: {% if section.settings.full_width %}0{% else %}clamp(1rem, 3vw, 2rem){% endif %};
    background: linear-gradient(to right, var(--color-background), transparent);
  }

  .logo-marquee-track-wrapper-{{ section.id }}::after {
    right: {% if section.settings.full_width %}0{% else %}clamp(1rem, 3vw, 2rem){% endif %};
    background: linear-gradient(to left, var(--color-background), transparent);
  }

  .logo-marquee-track-{{ section.id }} {
    display: flex;
    width: max-content;
  }

  .logo-marquee-item-{{ section.id }} {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 clamp(1.5rem, 4vw, 3rem);
    height: {{ section.settings.logo_height }}px;
  }

  .logo-marquee-item-{{ section.id }} img {
    max-height: 100%;
    width: auto;
    max-width: {{ section.settings.logo_max_width }}px;
    object-fit: contain;
    opacity: {{ section.settings.logo_opacity | divided_by: 100.0 }};
    transition: opacity 0.3s ease, transform 0.3s ease, filter 0.3s ease;
    filter: {% if section.settings.grayscale %}grayscale(100%){% endif %}{% if section.settings.invert %}{% if section.settings.grayscale %} {% endif %}invert(1){% endif %};
  }

  .logo-marquee-item-{{ section.id }}:hover img {
    opacity: 1;
    transform: scale(1.05);
    filter: {% if section.settings.invert %}invert(1){% else %}none{% endif %};
  }

  .logo-marquee-item-{{ section.id }} svg {
    max-height: 100%;
    width: auto;
    max-width: {{ section.settings.logo_max_width }}px;
    fill: currentColor;
    opacity: {{ section.settings.logo_opacity | divided_by: 100.0 }};
    transition: opacity 0.3s ease;
  }

  .logo-marquee-item-{{ section.id }}:hover svg {
    opacity: 1;
  }

  /* Placeholder styling */
  .logo-marquee-placeholder-{{ section.id }} {
    display: flex;
    align-items: center;
    justify-content: center;
    width: {{ section.settings.logo_max_width }}px;
    height: 100%;
    background: var(--color-border);
    border-radius: 8px;
    opacity: 0.5;
  }

  .logo-marquee-placeholder-{{ section.id }} i {
    font-size: 1.5rem;
    opacity: 0.3;
  }

  /* Reduced motion - show static logos */
  @media (prefers-reduced-motion: reduce) {
    .logo-marquee-track-{{ section.id }} {
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
    }
  }

  html.animations-disabled .logo-marquee-track-{{ section.id }} {
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
  }

</style>

<section
  class="logo-marquee-{{ section.id }} color-{{ section.settings.color_scheme }}"
  data-logo-marquee="{{ section.id }}"
  data-direction="{{ section.settings.direction }}"
  data-speed="{{ section.settings.speed }}"
>
  <div class="{{ container_class }}">
    {% if section.settings.label != blank %}
      <div class="logo-marquee-header-{{ section.id }}">
        <span class="logo-marquee-label-{{ section.id }}" data-tween data-tween-type="fade-up">
          {{ section.settings.label }}
        </span>
      </div>
    {% endif %}
  </div>

  <div class="logo-marquee-track-wrapper-{{ section.id }}">
    <div class="logo-marquee-track-{{ section.id }}" data-logo-track>
      {% for block in section.blocks %}
        <div class="logo-marquee-item-{{ section.id }}" {{ block.shopify_attributes }}>
          {% if block.settings.logo != blank %}
            {% if block.settings.link != blank %}
              <a href="{{ block.settings.link }}" target="_blank" rel="noopener">
            {% endif %}

            {{ block.settings.logo | image_url: height: 200 | image_tag:
              loading: 'lazy',
          decoding: 'async',
              alt: block.settings.logo.alt | default: section.settings.label
            }}

            {% if block.settings.link != blank %}
              </a>
            {% endif %}
          {% else %}
            <div class="logo-marquee-placeholder-{{ section.id }}">
              <i class="ph ph-image"></i>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const section = document.querySelector(`[data-logo-marquee="${sectionId}"]`);
  if (!section || section.dataset.marqueeInitialized) return;
  section.dataset.marqueeInitialized = 'true';

  const track = section.querySelector('[data-logo-track]');
  if (!track) return;

  const direction = section.dataset.direction === 'right' ? 1 : -1;
  const speed = parseInt(section.dataset.speed, 10) || 30;

  // Check if animations should run
  const shouldAnimate = typeof window.shouldAnimate === 'function' ? window.shouldAnimate() : true;
  if (!shouldAnimate) return;

  let tween = null;
  let isInitialized = false;

  function initMarquee() {
    // Re-query section in case DOM was replaced
    const currentSection = document.querySelector(`[data-logo-marquee="${sectionId}"]`);
    const currentTrack = currentSection?.querySelector('[data-logo-track]');
    if (!currentSection || !currentTrack) return;

    // Kill existing animation
    if (tween) {
      tween.kill();
      tween = null;
    }

    const gsap = window.pieces?.gsap || window.gsap;
    if (!gsap) {
      setTimeout(initMarquee, 100);
      return;
    }

    const items = currentTrack.querySelectorAll('[class*="logo-marquee-item-"]');
    if (items.length === 0) return;

    // Only clone items on first init (check if already has clones)
    if (!isInitialized) {
      // Calculate total width of one set of items
      let totalWidth = 0;
      items.forEach(item => {
        totalWidth += item.offsetWidth;
      });

      // Clone items to fill the track for seamless loop
      const viewportWidth = window.innerWidth;
      const clonesNeeded = Math.ceil((viewportWidth * 2) / totalWidth) + 1;

      for (let i = 0; i < clonesNeeded; i++) {
        items.forEach(item => {
          const clone = item.cloneNode(true);
          clone.setAttribute('aria-hidden', 'true');
          clone.querySelectorAll('a').forEach(a => a.setAttribute('tabindex', '-1'));
          currentTrack.appendChild(clone);
        });
      }
    }

    // Calculate total width after cloning
    let totalWidth = 0;
    const allItems = currentTrack.querySelectorAll('[class*="logo-marquee-item-"]');
    // Only count original items (first set)
    const originalCount = items.length;
    for (let i = 0; i < originalCount; i++) {
      totalWidth += allItems[i].offsetWidth;
    }

    // Create the infinite scroll animation
    // For left scroll (direction -1): animate from 0 to -totalWidth, wrap using negative modulo
    // For right scroll (direction 1): start at -totalWidth and animate to 0, wrap using negative modulo
    if (direction === 1) {
      // Right scroll: start offset, animate towards 0
      gsap.set(currentTrack, { x: -totalWidth });
      tween = gsap.to(currentTrack, {
        x: 0,
        duration: speed,
        ease: 'none',
        repeat: -1,
        modifiers: {
          x: gsap.utils.unitize(x => {
            const val = parseFloat(x) % totalWidth;
            return val > 0 ? val - totalWidth : val;
          })
        }
      });
    } else {
      // Left scroll (default): animate from 0 to negative
      tween = gsap.to(currentTrack, {
        x: -totalWidth,
        duration: speed,
        ease: 'none',
        repeat: -1,
        modifiers: {
          x: gsap.utils.unitize(x => parseFloat(x) % totalWidth)
        }
      });
    }

    // Pause on hover (use currentSection)
    if (!isInitialized) {
      currentSection.addEventListener('mouseenter', () => {
        if (tween) gsap.to(tween, { timeScale: 0, duration: 0.5, ease: 'power2.out' });
      });

      currentSection.addEventListener('mouseleave', () => {
        if (tween) gsap.to(tween, { timeScale: 1, duration: 0.5, ease: 'power2.out' });
      });
    }

    isInitialized = true;
  }

  // Wait for GSAP to be available
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMarquee);
  } else {
    requestAnimationFrame(initMarquee);
  }
})();
</script>

{% schema %}
{
  "name": "Logo Marquee",
  "tag": "section",
  "class": "logo-marquee-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "default": "As Featured In",
      "label": "Label"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "default": "center",
      "label": "Header alignment"
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "select",
      "id": "direction",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left",
      "label": "Scroll direction"
    },
    {
      "type": "range",
      "id": "speed",
      "min": 10,
      "max": 60,
      "step": 5,
      "default": 30,
      "unit": "s",
      "label": "Animation speed",
      "info": "Lower = faster"
    },
    {
      "type": "header",
      "content": "Logo Styling"
    },
    {
      "type": "range",
      "id": "logo_height",
      "min": 30,
      "max": 100,
      "step": 5,
      "default": 50,
      "unit": "px",
      "label": "Logo height"
    },
    {
      "type": "range",
      "id": "logo_max_width",
      "min": 80,
      "max": 200,
      "step": 10,
      "default": 120,
      "unit": "px",
      "label": "Logo max width"
    },
    {
      "type": "range",
      "id": "logo_opacity",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 60,
      "unit": "%",
      "label": "Logo opacity"
    },
    {
      "type": "checkbox",
      "id": "grayscale",
      "default": true,
      "label": "Grayscale logos",
      "info": "Color on hover"
    },
    {
      "type": "checkbox",
      "id": "invert",
      "default": false,
      "label": "Invert logos",
      "info": "Invert logo colors (useful for dark backgrounds)"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": true,
      "label": "Full width"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-2"
    }
  ],
  "blocks": [
    {
      "type": "logo",
      "name": "Logo",
      "settings": [
        {
          "type": "image_picker",
          "id": "logo",
          "label": "Logo image",
          "info": "Add alt text via the image's metadata in Files"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link (optional)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Logo Marquee",
      "category": "Social proof",
      "blocks": [
        { "type": "logo" },
        { "type": "logo" },
        { "type": "logo" },
        { "type": "logo" },
        { "type": "logo" },
        { "type": "logo" }
      ]
    }
  ]
}
{% endschema %}
