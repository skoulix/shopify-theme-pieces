<style>
  #pinned-reveal-{{ section.id }} {
    background-color: var(--color-background);
    color: var(--color-text);
  }

  @media (min-width: 768px) {
    /* Main grid uses position relative for the pinned child */
    #pinned-reveal-{{ section.id }} .pinned-grid {
      position: relative;
    }

    /* Content blocks are 100vh each, vertically centered */
    #pinned-reveal-{{ section.id }} .pinned-content .slide-content {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* Images container - sticky positioning as fallback, GSAP will pin */
    #pinned-reveal-{{ section.id }} .pinned-images {
      height: 100vh;
      position: sticky;
      top: 0;
      align-self: flex-start;
    }

    /* Stack all images centered vertically with fixed height */
    #pinned-reveal-{{ section.id }} .pinned-images .slide-image {
      position: absolute;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      width: 100%;
      height: 400px;
      border-radius: var(--card-border-radius);
      overflow: hidden;
    }

    /* Image fills wrapper */
    #pinned-reveal-{{ section.id }} .pinned-images .slide-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }

    /* Placeholder SVG styling */
    #pinned-reveal-{{ section.id }} .pinned-images .slide-image svg {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  }

  /* Button styling - secondary buttons use text/background for visibility */
  #pinned-reveal-{{ section.id }} .btn--secondary {
    color: var(--color-text);
    border-color: var(--color-text);
  }
  #pinned-reveal-{{ section.id }} .btn--secondary::before {
    background: var(--color-text);
  }
  #pinned-reveal-{{ section.id }} .btn--secondary:hover,
  #pinned-reveal-{{ section.id }} .btn--secondary:hover span,
  #pinned-reveal-{{ section.id }} .btn--secondary:hover i {
    color: var(--color-background);
  }
  #pinned-reveal-{{ section.id }} .btn--solid-secondary {
    background: var(--color-text);
    border-color: var(--color-text);
    color: var(--color-background);
  }
  #pinned-reveal-{{ section.id }} .btn--solid-secondary::before {
    background: var(--color-background);
  }
  #pinned-reveal-{{ section.id }} .btn--solid-secondary:hover,
  #pinned-reveal-{{ section.id }} .btn--solid-secondary:hover span,
  #pinned-reveal-{{ section.id }} .btn--solid-secondary:hover i {
    color: var(--color-text);
  }
</style>

<div
  id="pinned-reveal-{{ section.id }}"
  class="pinned-reveal section-padding{% unless section.settings.padding == 'default' %}-{{ section.settings.padding }}{% endunless %} md:py-0 color-{{ section.settings.color_scheme }} relative transition-colors duration-500"
  data-section-id="{{ section.id }}"
>
  <div class="page-container">
    {%- comment -%} Mobile layout: interleaved image + content blocks {%- endcomment -%}
    <div class="pinned-grid-mobile md:hidden flex flex-col gap-y-6">
      {%- for block in section.blocks -%}
        {%- if block.type == 'slide' -%}
          <div class="mobile-block mb-8" data-index="{{ forloop.index0 }}" {{ block.shopify_attributes }}>
            {%- if block.settings.image != blank -%}
              <div class="mobile-image-wrapper w-full h-[360px] overflow-hidden mb-4 rounded-(--card-border-radius)">
                <img
                  class="mobile-parallax-img block w-full h-[130%] object-cover"
                  src="{{ block.settings.image | image_url: width: 1200 }}"
                  alt="{{ block.settings.image.alt | default: block.settings.title | default: section.settings.title }}"
                  width="{{ block.settings.image.width }}"
                  height="{{ block.settings.image.height }}"
                  loading="lazy"
                  decoding="async"
                >
              </div>
            {%- else -%}
              {%- liquid
                assign placeholder_names = 'lifestyle-1,lifestyle-2,product-1,product-2,collection-1,collection-2' | split: ','
                assign placeholder_index = forloop.index0 | modulo: 6
                assign placeholder_name = placeholder_names[placeholder_index]
              -%}
              <div class="mobile-image-wrapper w-full h-90 overflow-hidden mb-4 rounded-(--card-border-radius) bg-(--color-background-secondary) flex items-center justify-center p-8">
                {{ placeholder_name | placeholder_svg_tag: 'max-w-full max-h-full' }}
              </div>
            {%- endif -%}
            <div class="slide-content" data-bg-color="{{ block.settings.background_color | default: '#ffffff' }}">
              <div class="content w-full">
                {%- if block.settings.label != blank -%}
                  <span class="slide-label block text-sm{% if settings.headings_uppercase %} uppercase{% endif %} tracking-widest mb-4 opacity-60" data-tween data-tween-type="fade-up">
                    {{- block.settings.label -}}
                  </span>
                {%- endif -%}
                {%- if block.settings.title != blank -%}
                  <h2 class="slide-title text-3xl font-bold leading-tight tracking-tight mb-2" data-tween data-tween-type="fade-up">
                    {{- block.settings.title -}}
                  </h2>
                {%- endif -%}
                {%- if block.settings.text != blank -%}
                  <p class="slide-description text-base leading-relaxed mb-7 opacity-80" data-tween data-tween-type="fade-up">
                    {{- block.settings.text -}}
                  </p>
                {%- endif -%}
                {%- if block.settings.button_text != blank -%}
                  {% render 'button',
                    text: block.settings.button_text,
                    url: block.settings.button_link,
                    style: block.settings.button_style,
                    color: block.settings.button_color,
                    size: block.settings.button_size,
                    animate: true,
                    shopify_attributes: block.shopify_attributes
                  %}
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>

    {%- comment -%} Desktop/Tablet layout: two columns with pinned images {%- endcomment -%}
    <div class="pinned-grid hidden md:flex md:flex-row md:gap-8 lg:gap-16">
      {%- comment -%} Left column - Text content {%- endcomment -%}
      <div class="pinned-content md:w-1/2 lg:w-3/5 flex flex-col">
        {%- for block in section.blocks -%}
          {%- if block.type == 'slide' -%}
            <div
              class="slide-content py-5 max-w-2xl"
              data-index="{{ forloop.index0 }}"
              data-bg-color="{{ block.settings.background_color | default: '#ffffff' }}"
              {{ block.shopify_attributes }}
            >
              <div class="content w-full">
                {%- if block.settings.label != blank -%}
                  <span class="slide-label block text-sm{% if settings.headings_uppercase %} uppercase{% endif %} tracking-widest mb-4 opacity-60" data-tween data-tween-type="fade-up">
                    {{- block.settings.label -}}
                  </span>
                {%- endif -%}
                {%- if block.settings.title != blank -%}
                  <h2 class="slide-title text-3xl lg:text-[42px] font-bold leading-tight tracking-tight mb-2" data-tween data-tween-type="fade-up">
                    {{- block.settings.title -}}
                  </h2>
                {%- endif -%}
                {%- if block.settings.text != blank -%}
                  <p class="slide-description text-base lg:text-lg leading-relaxed mb-7 opacity-80" data-tween data-tween-type="fade-up">
                    {{- block.settings.text -}}
                  </p>
                {%- endif -%}
                {%- if block.settings.button_text != blank -%}
                  {% render 'button',
                    text: block.settings.button_text,
                    url: block.settings.button_link,
                    style: block.settings.button_style,
                    color: block.settings.button_color,
                    size: block.settings.button_size,
                    animate: true,
                    shopify_attributes: block.shopify_attributes
                  %}
                {%- endif -%}
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>

      {%- comment -%} Right column - Pinned images {%- endcomment -%}
      <div class="pinned-images md:w-1/2 lg:w-2/5">
        {%- for block in section.blocks -%}
          {%- if block.type == 'slide' -%}
            {%- if block.settings.image != blank -%}
              <div
                class="slide-image w-full overflow-hidden"
                data-index="{{ forloop.index0 }}"
              >
                <img
                  src="{{ block.settings.image | image_url: width: 1200 }}"
                  alt="{{ block.settings.image.alt | default: block.settings.title | default: section.settings.title }}"
                  width="{{ block.settings.image.width }}"
                  height="{{ block.settings.image.height }}"
                  loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                  fetchpriority="{% if forloop.first %}high{% else %}low{% endif %}"
                  decoding="async"
                >
              </div>
            {%- else -%}
              {%- liquid
                assign placeholder_names = 'lifestyle-1,lifestyle-2,product-1,product-2,collection-1,collection-2' | split: ','
                assign placeholder_index = forloop.index0 | modulo: 6
                assign placeholder_name = placeholder_names[placeholder_index]
              -%}
              <div
                class="slide-image w-full overflow-hidden aspect-3/4 bg-(--color-background-secondary) rounded-(--card-radius) flex items-center justify-center p-8"
                data-index="{{ forloop.index0 }}"
              >
                {{ placeholder_name | placeholder_svg_tag: 'max-w-full max-h-full' }}
              </div>
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const section = document.getElementById('pinned-reveal-' + sectionId);
  if (!section || section.dataset.pinnedRevealInitialized) return;
  section.dataset.pinnedRevealInitialized = 'true';

  // If animations disabled, skip
  if (typeof window.shouldAnimate === 'function' && !window.shouldAnimate()) return;

  function initPinnedReveal() {
    // Get gsap from window.pieces or window
    if (typeof gsap === 'undefined') {
      if (window.pieces && window.pieces.gsap) {
        window.gsap = window.pieces.gsap;
      } else {
        requestAnimationFrame(initPinnedReveal);
        return;
      }
    }

    // Get ScrollTrigger from window.pieces or window
    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);
    if (!ScrollTrigger) {
      requestAnimationFrame(initPinnedReveal);
      return;
    }

    gsap.registerPlugin(ScrollTrigger);

    // Wait for all images in section to load before initializing animations
    const images = section.querySelectorAll('img');
    const imagePromises = Array.from(images).map(function(img) {
      if (img.complete) return Promise.resolve();
      return new Promise(function(resolve) {
        img.addEventListener('load', resolve, { once: true });
        img.addEventListener('error', resolve, { once: true });
      });
    });

    Promise.all(imagePromises).then(function() {
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          initAnimations();
          ScrollTrigger.refresh(true);
        });
      });
    });
  }

  function initAnimations() {
    const isMobile = window.matchMedia('(max-width: 767px)').matches;
    const defaultBg = getComputedStyle(section).getPropertyValue('--color-background').trim() || '#ffffff';

    // Mobile parallax
    if (isMobile) {
      const mobileBlocks = gsap.utils.toArray('#pinned-reveal-' + sectionId + ' .mobile-block');
      const mobileImages = gsap.utils.toArray('#pinned-reveal-' + sectionId + ' .mobile-parallax-img');
      const mobileContentBlocks = gsap.utils.toArray('#pinned-reveal-' + sectionId + ' .pinned-grid-mobile .slide-content');
      const mobileBgColors = mobileContentBlocks.map(function(block) {
        return block.getAttribute('data-bg-color') || defaultBg;
      });

      mobileImages.forEach(function(img, index) {
        const wrapper = mobileBlocks[index];

        // Parallax effect - image moves slower than scroll
        gsap.fromTo(img,
          { yPercent: -15 },
          {
            yPercent: 15,
            ease: 'none',
            scrollTrigger: {
              trigger: wrapper,
              start: 'top bottom',
              end: 'bottom top',
              scrub: true
            }
          }
        );

        // Background color transition
        if (index > 0) {
          gsap.to(section, {
            backgroundColor: mobileBgColors[index],
            ease: 'none',
            scrollTrigger: {
              trigger: wrapper,
              start: 'top 60%',
              end: 'top 40%',
              scrub: true
            }
          });
        }
      });

      return;
    }

    // Get slide containers (works for both img and svg placeholders)
    const slideContainers = gsap.utils.toArray('#pinned-reveal-' + sectionId + ' .pinned-grid .slide-image');
    const contentBlocks = gsap.utils.toArray('#pinned-reveal-' + sectionId + ' .pinned-grid .slide-content');
    const bgColors = contentBlocks.map(function(block) {
      return block.getAttribute('data-bg-color') || defaultBg;
    });

    if (slideContainers.length === 0) return;

    // Set z-index for slide containers - first on top (highest z-index)
    slideContainers.forEach(function(element, index) {
      element.style.zIndex = slideContainers.length - index;
    });

    // Set initial state for all slide containers
    gsap.set(slideContainers, {
      clipPath: 'inset(0)'
    });

    // Create ScrollTrigger for each content block to trigger image transitions
    contentBlocks.forEach(function(contentBlock, index) {
      const currentSlide = slideContainers[index];
      const nextSlide = slideContainers[index + 1];
      const nextBgColor = bgColors[index + 1] || bgColors[index];

      if (nextSlide && currentSlide) {
        // Image reveal animation tied to scrolling past each content block
        // scrub: 0.5 adds smoothing (0.5s catch-up time) for more fluid feel
        gsap.timeline({
          scrollTrigger: {
            trigger: contentBlock,
            start: 'center center',
            end: 'bottom top',
            scrub: 0.5
          }
        })
        .to(section, {
          backgroundColor: nextBgColor,
          duration: 1,
          ease: 'none'
        }, 0)
        .to(currentSlide, {
          clipPath: 'inset(0px 0px 100%)',
          duration: 1,
          ease: 'none'
        }, 0);
      }
    });
  }

  // Wait for DOM, then images, then initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPinnedReveal);
  } else {
    initPinnedReveal();
  }
})();
</script>

{% schema %}
{
  "name": "t:sections.pinned_image_reveal.name",
  "tag": "section",
  "class": "pinned-reveal-section no-header-offset",
  "settings": [
    {
      "type": "select",
      "id": "padding",
      "label": "t:shared.settings.padding.label",
      "info": "t:shared.settings.padding.info",
      "default": "default",
      "options": [
        {
          "value": "default",
          "label": "t:shared.settings.padding.options__2.label"
        },
        {
          "value": "small",
          "label": "t:shared.settings.padding.options__1.label"
        },
        {
          "value": "large",
          "label": "t:shared.settings.padding.options__3.label"
        },
        {
          "value": "none",
          "label": "t:shared.settings.padding.options__0.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-1"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "t:shared.blocks.slide",
      "settings": [
        {
          "type": "header",
          "content": "t:shared.headers.image"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "t:shared.settings.image.label"
        },
        {
          "type": "header",
          "content": "t:shared.headers.content"
        },
        {
          "type": "text",
          "id": "label",
          "label": "t:shared.settings.label.label"
        },
        {
          "type": "text",
          "id": "title",
          "label": "t:shared.settings.title.label",
          "default": "t:sections.pinned_image_reveal.blocks.slide.settings.title.default"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "t:shared.settings.text.label",
          "default": "t:sections.pinned_image_reveal.blocks.slide.settings.text.default"
        },
        {
          "type": "header",
          "content": "t:shared.headers.button"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "t:shared.settings.button_text.label",
          "default": "t:shared.defaults.learn_more"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "t:shared.settings.button_link.label"
        },
        {
          "type": "select",
          "id": "button_style",
          "label": "t:shared.settings.button_style.label",
          "default": "outline",
          "options": [
            {
              "value": "solid",
              "label": "t:shared.settings.button_style.options__0.label"
            },
            {
              "value": "outline",
              "label": "t:shared.settings.button_style.options__1.label"
            }
          ]
        },
        {
          "type": "select",
          "id": "button_color",
          "label": "t:shared.settings.button_color.label",
          "default": "primary",
          "options": [
            {
              "value": "primary",
              "label": "t:shared.settings.button_color.options__0.label"
            },
            {
              "value": "secondary",
              "label": "t:shared.settings.button_color.options__1.label"
            }
          ]
        },
        {
          "type": "select",
          "id": "button_size",
          "label": "t:shared.settings.button_size.label",
          "default": "default",
          "options": [
            {
              "value": "small",
              "label": "t:shared.settings.button_size.options__0.label"
            },
            {
              "value": "default",
              "label": "t:shared.settings.button_size.options__1.label"
            },
            {
              "value": "large",
              "label": "t:shared.settings.button_size.options__2.label"
            }
          ]
        },
        {
          "type": "header",
          "content": "t:shared.headers.colors"
        },
        {
          "type": "color",
          "id": "background_color",
          "label": "t:sections.pinned_image_reveal.blocks.slide.settings.background_color.label",
          "info": "t:sections.pinned_image_reveal.blocks.slide.settings.background_color.info"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.pinned_image_reveal.presets.pinned_image_reveal.name",
      "category": "t:shared.categories.image_media",
      "blocks": [
        {
          "type": "slide",
          "settings": {
            "background_color": "#EDF9FF",
            "title": "t:sections.pinned_image_reveal.presets.pinned_image_reveal.blocks.slide.0.title",
            "button_text": "t:sections.pinned_image_reveal.presets.pinned_image_reveal.blocks.slide.0.button_text",
            "text": "t:sections.pinned_image_reveal.presets.pinned_image_reveal.blocks.slide.0.text"
          }
        },
        {
          "type": "slide",
          "settings": {
            "background_color": "#FFECF2",
            "title": "t:sections.pinned_image_reveal.presets.pinned_image_reveal.blocks.slide.1.title",
            "button_text": "t:sections.pinned_image_reveal.presets.pinned_image_reveal.blocks.slide.1.button_text",
            "text": "t:sections.pinned_image_reveal.presets.pinned_image_reveal.blocks.slide.1.text"
          }
        },
        {
          "type": "slide",
          "settings": {
            "background_color": "#FFE8DB",
            "title": "t:sections.pinned_image_reveal.presets.pinned_image_reveal.blocks.slide.2.title",
            "button_text": "t:sections.pinned_image_reveal.presets.pinned_image_reveal.blocks.slide.2.button_text",
            "text": "t:sections.pinned_image_reveal.presets.pinned_image_reveal.blocks.slide.2.text"
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}
