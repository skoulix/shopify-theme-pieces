{%- comment -%}
  Shoppable Videos - Video carousel with product integration
  Features: Keen Slider carousel, video lightbox, product overlays, add-to-cart
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif

  assign videos_mobile = section.settings.videos_mobile | default: '1'
  assign videos_tablet = section.settings.videos_tablet | default: '3'
  assign videos_desktop = section.settings.videos_desktop | default: '4'
  assign video_spacing = section.settings.video_spacing | default: 'medium'
  assign video_aspect_ratio = section.settings.video_aspect_ratio | default: '9/16'

  # Global card settings
  assign card_radius = settings.card_radius | default: 8
  assign card_border_width = settings.card_border_width | default: 0
  assign card_shadow = settings.card_shadow | default: 'none'
-%}

<style>
  .shoppable-videos-{{ section.id }} {
    background-color: var(--color-background);
    color: var(--color-text);
    padding: var(--section-vertical-padding) 0;
    overflow: hidden;
  }

  /* Header - matching testimonials */
  .shoppable-videos-header-{{ section.id }} {
    margin-bottom: clamp(3rem, 6vh, 5rem);
    text-align: {{ section.settings.header_alignment }};
  }

  /* Label, title, description use global .section-* classes from utilities.css */
  .shoppable-videos-header-{{ section.id }} .section-label {
    margin-bottom: 1.5rem;
  }

  .shoppable-videos-header-{{ section.id }} .section-description {
    {% if section.settings.header_alignment == 'center' %}
    margin-left: auto;
    margin-right: auto;
    {% elsif section.settings.header_alignment == 'right' %}
    margin-left: auto;
    {% endif %}
  }

  /* Video card styles */
  .shoppable-video-card-{{ section.id }} {
    position: relative;
    overflow: hidden;
    isolation: isolate;
    display: block;
    aspect-ratio: {{ video_aspect_ratio }};
    width: 100%;
    height: auto;
    border-radius: {{ card_radius }}px;
    {% if card_border_width > 0 %}
    border: {{ card_border_width }}px solid var(--color-border);
    {% endif %}
    {% case card_shadow %}
      {% when 'sm' %}
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      {% when 'md' %}
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      {% when 'lg' %}
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      {% when 'hard' %}
      box-shadow: 4px 4px 0 0 color-mix(in srgb, var(--color-text) 15%, transparent);
    {% endcase %}
  }

  .shoppable-video-card-{{ section.id }} .carousel-video {
    border-radius: {{ card_radius }}px;
  }

  .shoppable-video-slide-{{ section.id }} {
    flex-shrink: 0;
    {%- comment -%} Mobile: Centered with nearby slides visible {%- endcomment -%}
    {%- case videos_mobile -%}
      {%- when '2' -%}
        width: calc(50% - 0.5rem);
      {%- else -%}
        width: 75%;
    {%- endcase -%}
  }

  @media (min-width: 768px) {
    .shoppable-video-slide-{{ section.id }} {
      {%- comment -%} Tablet: Show configured number with peek {%- endcomment -%}
      {%- case videos_tablet -%}
        {%- when '2' -%}
          width: calc(45% - 0.5rem);
        {%- when '4' -%}
          width: calc(24% - 0.75rem);
        {%- else -%}
          width: calc(32% - 0.67rem);
      {%- endcase -%}
    }
  }

  @media (min-width: 1024px) {
    .shoppable-video-slide-{{ section.id }} {
      {%- comment -%} Desktop: Show configured number with peek for scrolling {%- endcomment -%}
      {%- case videos_desktop -%}
        {%- when '2' -%}
          width: calc(45% - 0.5rem);
        {%- when '3' -%}
          width: calc(32% - 0.67rem);
        {%- when '5' -%}
          width: calc(19% - 0.8rem);
        {%- when '6' -%}
          width: calc(16% - 0.83rem);
        {%- else -%}
          width: calc(24% - 0.75rem);
      {%- endcase -%}
    }
  }

  /* Play overlay */
  .shoppable-video-card-{{ section.id }}.cursor-pointer .play-overlay {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .shoppable-video-card-{{ section.id }}.cursor-pointer:hover .play-overlay {
    opacity: 1;
  }

  .shoppable-video-card-{{ section.id }}.cursor-default {
    cursor: default !important;
  }

  /* Navigation - matching testimonials style */
  .shoppable-videos-nav-{{ section.id }} {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-top: 3rem;
  }

  .shoppable-videos-nav-btn-{{ section.id }} {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid color-mix(in srgb, var(--color-text) 30%, transparent);
    color: var(--color-text);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .shoppable-videos-nav-btn-{{ section.id }}:hover {
    background: var(--color-text);
    color: var(--color-background);
  }

  .shoppable-videos-nav-btn-{{ section.id }}:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .shoppable-videos-nav-btn-{{ section.id }}:disabled:hover {
    background: transparent;
    color: var(--color-text);
  }

  /* Lightbox styles */
  .shoppable-video-lightbox {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .shoppable-video-lightbox.active {
    display: flex;
  }

  .shoppable-lightbox-content {
    display: flex;
    gap: 2rem;
    max-width: 1400px;
    width: 90%;
    max-height: 85vh;
  }

  .shoppable-lightbox-video {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .shoppable-lightbox-video video {
    width: 100%;
    height: auto;
    max-height: 75vh;
    max-width: 100%;
    object-fit: contain;
    transition: opacity 0.3s ease;
    border-radius: {{ card_radius }}px;
  }

  .shoppable-lightbox-product {
    width: 320px;
    background: white;
    padding: 1.5rem;
    border-radius: {{ card_radius }}px;
    overflow-y: auto;
    max-height: 75vh;
    flex-shrink: 0;
  }

  #shoppable-product-info-{{ section.id }} {
    transition: opacity 0.3s ease;
  }

  .shoppable-lightbox-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10000;
    color: white;
  }

  .shoppable-lightbox-close:hover {
    background: white;
    color: black;
  }

  /* Lightbox navigation buttons */
  .shoppable-lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10000;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
  }

  .shoppable-lightbox-nav:hover {
    background: white;
    color: black;
  }

  .shoppable-lightbox-nav.lightbox-prev { left: 2rem; }
  .shoppable-lightbox-nav.lightbox-next { right: 2rem; }
  .shoppable-lightbox-nav:disabled { opacity: 0.3; cursor: not-allowed; }
  .shoppable-lightbox-nav:disabled:hover { background: rgba(255, 255, 255, 0.1); color: white; transform: translateY(-50%); }

  /* Mobile responsive lightbox */
  @media (max-width: 768px) {
    .shoppable-lightbox-nav {
      width: 40px;
      height: 40px;
      top: auto;
      transform: none;
    }
    .shoppable-lightbox-nav.lightbox-prev { top: 20px; left: 20px; }
    .shoppable-lightbox-nav.lightbox-next { top: 20px; left: 70px; }
    .shoppable-lightbox-nav:hover { transform: none; }
    .shoppable-lightbox-nav:disabled:hover { transform: none; }

    .shoppable-lightbox-content {
      flex-direction: column;
      width: calc(100% - 1rem);
      max-width: calc(100% - 1rem);
      max-height: calc(100vh - 1rem);
      gap: 0;
      margin: 0.5rem;
    }

    .shoppable-lightbox-video {
      width: 100%;
      flex: 1;
      min-height: 0;
    }

    .shoppable-lightbox-video video {
      border-radius: {{ card_radius }}px {{ card_radius }}px 0 0 !important;
      max-height: 60vh;
      width: 100%;
    }

    .shoppable-lightbox-product {
      width: 100%;
      max-height: 35vh;
      border-radius: 0 0 {{ card_radius }}px {{ card_radius }}px;
      padding: 1rem;
    }
  }

  /* Slider container - transform-based infinite carousel */
  .shoppable-videos-slider-{{ section.id }} {
    position: relative;
    overflow: hidden;
  }

  .shoppable-videos-track-{{ section.id }} {
    display: flex;
    gap: {% case video_spacing %}{% when 'none' %}0{% when 'small' %}0.5rem{% when 'large' %}1.5rem{% else %}1rem{% endcase %};
    will-change: transform;
  }

  .shoppable-videos-track-{{ section.id }}.is-animating {
    transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
  }

</style>

<section
  class="shoppable-videos-{{ section.id }} color-{{ section.settings.color_scheme }}"
  data-shoppable-videos="{{ section.id }}"
>
  <div class="{{ container_class }}">
    {%- comment -%} Header - uses global data-tween system for animations {%- endcomment -%}
    {% if section.settings.label != blank or section.settings.title != blank or section.settings.description != blank %}
      <div class="shoppable-videos-header-{{ section.id }}" data-tween-group="shoppable-videos-header-{{ section.id }}">
        {% if section.settings.label != blank %}
          <span class="section-label" data-tween data-tween-type="fade-up">
            {{ section.settings.label }}
          </span>
        {% endif %}

        {% if section.settings.title != blank %}
          <h2 class="section-title font-heading" data-tween data-tween-type="split-text">
            {{ section.settings.title }}
          </h2>
        {% endif %}

        {% if section.settings.description != blank %}
          <p class="section-description mt-6" data-tween data-tween-type="fade-up">
            {{ section.settings.description }}
          </p>
        {% endif %}
      </div>
    {% endif %}

    <!-- Videos Carousel -->
    <div class="shoppable-videos-slider-{{ section.id }}" data-shoppable-videos-slider data-tween data-tween-type="fade-up">
      <div class="shoppable-videos-track-{{ section.id }}" data-shoppable-videos-track>
        {% for block in section.blocks %}
          {% if block.type == 'video' %}
            {%- liquid
              assign video_hosted = block.settings.video_hosted
              assign product = block.settings.product
              assign has_video = false

              if video_hosted != blank
                assign has_video = true
              endif
            -%}
            <div class="shoppable-video-slide-{{ section.id }}" data-video-slide {{ block.shopify_attributes }}>
                <div class="shoppable-video-card-{{ section.id }} relative w-full overflow-hidden {% if has_video %}cursor-pointer{% else %}cursor-default{% endif %} bg-[--color-background-secondary]"
                     {% if has_video %}
                       data-video-url="{{ video_hosted.sources[1].url | default: video_hosted.sources[0].url }}"
                     {% endif %}
                     {% if product != blank %}
                       data-product-id="{{ product.id }}"
                       data-product-title="{{ product.title | escape }}"
                       data-product-price="{{ product.price }}"
                       data-product-handle="{{ product.handle }}"
                       data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                       {% if product.compare_at_price > product.price %}
                         data-product-compare-price="{{ product.compare_at_price }}"
                       {% endif %}
                       data-product-image="{{ product.featured_image | image_url: width: 400 }}"
                     {% endif %}
                     data-video-index="{{ forloop.index0 }}"
                     {% if video_hosted.alt != blank %}aria-label="{{ video_hosted.alt }}"{% endif %}>

                  {% if has_video %}
                    {{ video_hosted | video_tag:
                      class: 'carousel-video absolute inset-0 z-0 w-full h-full object-cover block pointer-events-none',
                      autoplay: true,
                      muted: true,
                      loop: true,
                      playsinline: true,
                      preload: 'metadata'
                    }}
                  {% else %}
                    <div class="absolute inset-0 w-full h-full flex items-center justify-center z-0 bg-[--color-background-secondary]">
                      <i class="ph ph-video-camera text-6xl opacity-20"></i>
                    </div>
                  {% endif %}

                  {%- comment -%} Gradient overlay for readability {%- endcomment -%}
                  {% if has_video %}
                    <div class="absolute inset-0 z-[1] pointer-events-none" style="background: linear-gradient(to bottom, transparent 0%, transparent 50%, rgba(0,0,0,0.7) 100%); border-radius: {{ card_radius }}px;"></div>
                  {% endif %}

                  {% if has_video %}
                    <div class="play-overlay absolute inset-0 z-[2] flex items-center justify-center pointer-events-none">
                      <div class="bg-black/50 rounded-full p-4">
                        <i class="ph ph-arrows-out text-4xl text-white"></i>
                      </div>
                    </div>
                  {% endif %}

                  {% if section.settings.show_product_info and product != blank %}
                    <div class="shoppable-product-info absolute inset-x-0 bottom-0 p-3 pointer-events-none" style="z-index: 20; border-radius: 0 0 {{ card_radius }}px {{ card_radius }}px;">
                      <h3 class="text-white text-sm font-semibold mb-1 line-clamp-2">{{ product.title }}</h3>
                      <div class="text-sm text-white mb-2">
                        {% if product.compare_at_price > product.price %}
                          <span class="text-white/70 line-through mr-1">{{ product.compare_at_price | money }}</span>
                        {% endif %}
                        <span class="text-white font-bold">{{ product.price | money }}</span>
                      </div>
                      <div class="text-sm text-white font-medium uppercase tracking-wider">{{ 'general.shop_now' | t }} <i class="ph ph-arrow-right"></i></div>
                    </div>
                  {% endif %}

                </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Navigation Buttons -->
    {% if section.blocks.size > 1 %}
      <div class="shoppable-videos-nav-{{ section.id }}" data-tween data-tween-type="fade-up">
        <button type="button" class="shoppable-videos-nav-btn-{{ section.id }}" data-shoppable-videos-prev aria-label="{{ 'accessibility.previous_slide' | t }}">
          <i class="ph ph-arrow-left"></i>
        </button>
        <button type="button" class="shoppable-videos-nav-btn-{{ section.id }}" data-shoppable-videos-next aria-label="{{ 'accessibility.next_slide' | t }}">
          <i class="ph ph-arrow-right"></i>
        </button>
      </div>
    {% endif %}
  </div>
</section>

<!-- Video Lightbox -->
<div class="shoppable-video-lightbox" id="shoppable-video-lightbox-{{ section.id }}" role="dialog" aria-modal="true" aria-label="{{ 'accessibility.close' | t }}">
  <button class="shoppable-lightbox-close" aria-label="{{ 'accessibility.close' | t }}">
    <i class="ph ph-x text-xl"></i>
  </button>

  <button class="shoppable-lightbox-nav lightbox-prev" aria-label="{{ 'accessibility.previous_slide' | t }}">
    <i class="ph ph-arrow-left"></i>
  </button>
  <button class="shoppable-lightbox-nav lightbox-next" aria-label="{{ 'accessibility.next_slide' | t }}">
    <i class="ph ph-arrow-right"></i>
  </button>

  <div class="shoppable-lightbox-content">
    <div class="shoppable-lightbox-video">
      {%- comment -%} theme-check-disable RemoteAsset - src populated dynamically via JavaScript {%- endcomment -%}
      <video controls autoplay muted playsinline preload="none" id="shoppable-lightbox-video-{{ section.id }}">
        <source src="" type="video/mp4">
      </video>
      {%- comment -%} theme-check-enable RemoteAsset {%- endcomment -%}
    </div>

    <div class="shoppable-lightbox-product">
      <div id="shoppable-product-info-{{ section.id }}"></div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const section = document.querySelector('[data-shoppable-videos="{{ section.id }}"]');
  if (!section || section.dataset.shoppableInitialized) return;
  section.dataset.shoppableInitialized = 'true';

  // Header animations handled by global TweenManager via data-tween attributes

  // GSAP-powered infinite carousel
  const slider = section.querySelector('[data-shoppable-videos-slider]');
  const track = section.querySelector('[data-shoppable-videos-track]');
  const originalSlides = Array.from(section.querySelectorAll('[data-video-slide]'));
  const prevBtn = section.querySelector('[data-shoppable-videos-prev]');
  const nextBtn = section.querySelector('[data-shoppable-videos-next]');
  const totalOriginal = originalSlides.length;

  // Settings
  const autoplayEnabled = {{ section.settings.autoplay | json }};
  const autoplaySpeed = {{ section.settings.autoplay_speed | default: 5 }};
  const pauseOnHover = {{ section.settings.pause_on_hover | json }};

  // State
  let loop = null;
  let autoplayTl = null;
  let isPaused = false;

  if (totalOriginal <= 1) {
    if (prevBtn) prevBtn.style.display = 'none';
    if (nextBtn) nextBtn.style.display = 'none';
  }

  function initGsapCarousel() {
    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    if (!gsap || totalOriginal <= 1 || !track) return;

    // Get the gap value from the track for seamless looping
    const trackStyles = window.getComputedStyle(track);
    const gap = parseFloat(trackStyles.gap) || parseFloat(trackStyles.columnGap) || 0;

    // GSAP horizontalLoop helper - creates seamless infinite carousel
    // Based on GSAP's official helper: https://gsap.com/docs/v3/HelperFunctions/helpers/seamlessLoop
    function horizontalLoop(items, config) {
      items = gsap.utils.toArray(items);
      config = config || {};
      let tl = gsap.timeline({
        repeat: config.repeat,
        paused: config.paused,
        defaults: { ease: 'none' },
        onReverseComplete: function() {
          tl.totalTime(tl.rawTime() + tl.duration() * 100);
        }
      });
      let length = items.length;
      let startX = items[0].offsetLeft;
      let times = [];
      let widths = [];
      let xPercents = [];
      let curIndex = 0;
      let pixelsPerSecond = (config.speed || 1) * 100;
      let snap = config.snap === false ? v => v : gsap.utils.snap(config.snap || 1);
      let totalWidth;
      let curX;
      let distanceToStart;
      let distanceToLoop;
      let item;
      let i;

      gsap.set(items, {
        xPercent: function(i, el) {
          let w = widths[i] = parseFloat(gsap.getProperty(el, 'width', 'px'));
          xPercents[i] = snap(parseFloat(gsap.getProperty(el, 'x', 'px')) / w * 100 + gsap.getProperty(el, 'xPercent'));
          return xPercents[i];
        }
      });

      gsap.set(items, { x: 0 });

      totalWidth = items[length - 1].offsetLeft + xPercents[length - 1] / 100 * widths[length - 1] - startX + items[length - 1].offsetWidth * gsap.getProperty(items[length - 1], 'scaleX') + (parseFloat(config.paddingRight) || 0);

      for (i = 0; i < length; i++) {
        item = items[i];
        curX = xPercents[i] / 100 * widths[i];
        distanceToStart = item.offsetLeft + curX - startX;
        distanceToLoop = distanceToStart + widths[i] * gsap.getProperty(item, 'scaleX');
        tl.to(item, {
          xPercent: snap((curX - distanceToLoop) / widths[i] * 100),
          duration: distanceToLoop / pixelsPerSecond
        }, 0)
        .fromTo(item, {
          xPercent: snap((curX - distanceToLoop + totalWidth) / widths[i] * 100)
        }, {
          xPercent: xPercents[i],
          duration: (curX - distanceToLoop + totalWidth - curX) / pixelsPerSecond,
          immediateRender: false
        }, distanceToLoop / pixelsPerSecond)
        .add('label' + i, distanceToStart / pixelsPerSecond);
        times[i] = distanceToStart / pixelsPerSecond;
      }

      function toIndex(index, vars) {
        vars = vars || {};
        Math.abs(index - curIndex) > length / 2 && (index += index > curIndex ? -length : length);
        let newIndex = gsap.utils.wrap(0, length, index);
        let time = times[newIndex];
        if (time > tl.time() !== index > curIndex) {
          vars.modifiers = { time: gsap.utils.wrap(0, tl.duration()) };
          time += tl.duration() * (index > curIndex ? 1 : -1);
        }
        curIndex = newIndex;
        vars.overwrite = true;
        return tl.tweenTo(time, vars);
      }

      tl.next = function(vars) { return toIndex(curIndex + 1, vars); };
      tl.previous = function(vars) { return toIndex(curIndex - 1, vars); };
      tl.current = function() { return curIndex; };
      tl.toIndex = function(index, vars) { return toIndex(index, vars); };
      tl.times = times;

      tl.progress(1, true).progress(0, true);

      if (config.reversed) {
        tl.vars.onReverseComplete();
        tl.reverse();
      }

      return tl;
    }

    // Calculate speed - higher setting = faster
    const speed = autoplaySpeed * 0.5;

    // Create the horizontal loop
    loop = horizontalLoop(originalSlides, {
      speed: speed,
      repeat: -1,
      paused: !autoplayEnabled,
      paddingRight: gap
    });

    // Navigation buttons
    if (prevBtn) {
      prevBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        loop.previous({
          duration: 0.4,
          ease: 'power1.inOut',
          onComplete: function() {
            if (autoplayEnabled && !isPaused) {
              loop.play();
            }
          }
        });
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        loop.next({
          duration: 0.4,
          ease: 'power1.inOut',
          onComplete: function() {
            if (autoplayEnabled && !isPaused) {
              loop.play();
            }
          }
        });
      });
    }

    // Touch/drag support with Draggable if available
    let Draggable = window.Draggable;
    if (!Draggable && window.pieces && window.pieces.Draggable) {
      Draggable = window.pieces.Draggable;
    }

    if (Draggable) {
      let startProgress;
      Draggable.create(slider, {
        type: 'x',
        trigger: slider,
        onPress: function() {
          startProgress = loop.progress();
          loop.pause();
        },
        onDrag: function() {
          const totalWidth = originalSlides.reduce((acc, slide) => acc + slide.offsetWidth, 0);
          loop.progress(startProgress + (this.startX - this.x) / totalWidth);
        },
        onRelease: function() {
          if (autoplayEnabled && !isPaused) {
            loop.play();
          }
        },
        inertia: true
      });
    } else {
      // Fallback touch support
      let touchStartX = 0;
      let startProgress = 0;

      slider.addEventListener('touchstart', function(e) {
        touchStartX = e.touches[0].clientX;
        startProgress = loop.progress();
        loop.pause();
      }, { passive: true });

      slider.addEventListener('touchmove', function(e) {
        const diff = touchStartX - e.touches[0].clientX;
        const totalWidth = originalSlides.reduce((acc, slide) => acc + slide.offsetWidth, 0);
        loop.progress(startProgress + diff / totalWidth);
      }, { passive: true });

      slider.addEventListener('touchend', function() {
        if (autoplayEnabled && !isPaused) {
          loop.play();
        }
      }, { passive: true });
    }

    // Pause on hover
    if (pauseOnHover && autoplayEnabled) {
      slider.addEventListener('mouseenter', function() {
        loop.pause();
      });
      slider.addEventListener('mouseleave', function() {
        if (!isPaused) loop.play();
      });
    }

    // Pause when out of view
    const sectionObserver = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (autoplayEnabled) {
          if (entry.isIntersecting) {
            isPaused = false;
            loop.play();
          } else {
            isPaused = true;
            loop.pause();
          }
        }
      });
    }, { threshold: 0.1 });
    sectionObserver.observe(section);
  }

  // Initialize when GSAP is ready
  function waitForGsap() {
    let gsap = window.gsap || (window.pieces && window.pieces.gsap);
    if (gsap) {
      initGsapCarousel();
    } else {
      setTimeout(waitForGsap, 50);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForGsap);
  } else {
    waitForGsap();
  }

  // Video autoplay on visibility
  const videoObserver = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      const video = entry.target.querySelector('.carousel-video');
      if (!video) return;
      if (entry.isIntersecting) {
        video.play().catch(() => { video.muted = true; video.play().catch(() => {}); });
      } else {
        video.pause();
      }
    });
  }, { threshold: 0.5 });
  originalSlides.forEach(slide => videoObserver.observe(slide));

  // Lightbox functionality
  const lightbox = document.getElementById('shoppable-video-lightbox-{{ section.id }}');
  const lightboxVideo = document.getElementById('shoppable-lightbox-video-{{ section.id }}');
  const productInfo = document.getElementById('shoppable-product-info-{{ section.id }}');
  const closeBtn = lightbox ? lightbox.querySelector('.shoppable-lightbox-close') : null;
  const videoThumbnails = section.querySelectorAll('.shoppable-video-card-{{ section.id }}');
  let currentVideoIndex = 0;
  const lightboxPrevBtn = lightbox ? lightbox.querySelector('.lightbox-prev') : null;
  const lightboxNextBtn = lightbox ? lightbox.querySelector('.lightbox-next') : null;

  function updateLightboxNav() {
    if (lightboxPrevBtn) lightboxPrevBtn.disabled = currentVideoIndex <= 0;
    if (lightboxNextBtn) lightboxNextBtn.disabled = currentVideoIndex >= videoThumbnails.length - 1;
  }

  function openVideoAtIndex(index) {
    if (index < 0 || index >= videoThumbnails.length) return;
    currentVideoIndex = index;
    const thumb = videoThumbnails[index];
    const videoUrl = thumb.dataset.videoUrl;
    if (!videoUrl) return;

    if (lightboxVideo) {
      lightboxVideo.src = videoUrl;
      lightboxVideo.load();
      lightboxVideo.play().catch(() => { lightboxVideo.muted = true; lightboxVideo.play().catch(() => {}); });
    }

    if (thumb.dataset.productId && thumb.dataset.productTitle && thumb.dataset.variantId) {
      displayProductInfo({
        id: thumb.dataset.productId,
        title: thumb.dataset.productTitle,
        price: thumb.dataset.productPrice,
        compare_at_price: thumb.dataset.productComparePrice,
        handle: thumb.dataset.productHandle,
        variantId: thumb.dataset.variantId,
        image: thumb.dataset.productImage
      });
    } else if (productInfo) {
      productInfo.innerHTML = '';
    }

    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
    updateLightboxNav();
  }

  function closeLightbox() {
    if (lightbox) lightbox.classList.remove('active');
    if (lightboxVideo) { lightboxVideo.pause(); lightboxVideo.src = ''; }
    document.body.style.overflow = '';
  }

  if (lightboxPrevBtn) lightboxPrevBtn.addEventListener('click', () => { if (currentVideoIndex > 0) openVideoAtIndex(currentVideoIndex - 1); });
  if (lightboxNextBtn) lightboxNextBtn.addEventListener('click', () => { if (currentVideoIndex < videoThumbnails.length - 1) openVideoAtIndex(currentVideoIndex + 1); });
  if (closeBtn) closeBtn.addEventListener('click', closeLightbox);
  if (lightbox) lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });

  document.addEventListener('keydown', (e) => {
    if (!lightbox || !lightbox.classList.contains('active')) return;
    if (e.key === 'ArrowLeft' && currentVideoIndex > 0) openVideoAtIndex(currentVideoIndex - 1);
    else if (e.key === 'ArrowRight' && currentVideoIndex < videoThumbnails.length - 1) openVideoAtIndex(currentVideoIndex + 1);
    else if (e.key === 'Escape') closeLightbox();
  });

  videoThumbnails.forEach((thumb, index) => {
    thumb.addEventListener('click', (e) => {
      e.preventDefault();
      if (thumb.dataset.videoUrl) openVideoAtIndex(index);
    });
  });

  function displayProductInfo(product) {
    if (!productInfo) return;
    productInfo.innerHTML = `
      <div class="shoppable-product-lightbox-info">
        ${product.image ? `<img src="${product.image}" alt="${product.title}" class="w-full rounded-lg mb-4 object-cover aspect-square" loading="lazy" decoding="async">` : ''}
        <h3 class="text-base font-semibold mb-3"><a href="/products/${product.handle}" class="hover:underline">${product.title}</a></h3>
        <div class="text-lg font-bold mb-6">
          ${product.compare_at_price ? `<span class="text-gray-500 line-through text-sm mr-2">${formatMoney(product.compare_at_price)}</span>` : ''}
          ${formatMoney(product.price)}
        </div>
        <form class="shoppable-add-to-cart-form" data-product-id="${product.id}">
          <input type="hidden" name="id" value="${product.variantId}">
          <input type="hidden" name="quantity" value="1">
          <button type="submit" class="btn btn--primary w-full"><span>{{ 'products.product.add_to_cart' | t }}</span></button>
        </form>
      </div>
    `;

    const form = productInfo.querySelector('.shoppable-add-to-cart-form');
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const button = form.querySelector('button[type="submit"]');
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span>{{ "cart.adding" | t }}</span>';

        fetch('/cart/add.js', { method: 'POST', body: new FormData(form) })
          .then(async response => {
            if (response.ok) {
              const item = await response.json();
              button.innerHTML = '<span>{{ "cart.added" | t }}</span>';
              document.dispatchEvent(new CustomEvent('cart:refresh'));

              // Get updated cart for count and notification
              const cartResponse = await fetch('/cart.js');
              const cart = await cartResponse.json();

              // Update cart count in header
              document.querySelectorAll('[data-cart-count]').forEach(el => {
                el.textContent = cart.item_count;
              });

              // Dispatch cart updated event for reactive components (e.g., free shipping bar)
              document.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart } }));

              // Check cart type setting
              const cartType = window.themeSettings?.cartType || 'drawer';

              if (cartType === 'drawer') {
                if (typeof window.openCartDrawer === 'function') {
                  setTimeout(() => { closeLightbox(); window.openCartDrawer(); }, 500);
                } else if (window.refreshCartDrawer) {
                  await window.refreshCartDrawer();
                  setTimeout(() => { closeLightbox(); document.dispatchEvent(new CustomEvent('cart:open', { detail: { skipFetch: true } })); }, 500);
                } else {
                  setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
                }
              } else if (cartType === 'notification') {
                // Show notification instead of drawer
                const productInfo = {
                  title: item.product_title,
                  variant_title: item.variant_title !== 'Default Title' ? item.variant_title : null,
                  image: item.image ? item.image.replace(/(\.[^.]+)$/, '_200x$1') : null
                };
                document.dispatchEvent(new CustomEvent('cart:notification', {
                  detail: { product: productInfo, cart: cart }
                }));
                setTimeout(() => { closeLightbox(); button.innerHTML = originalText; button.disabled = false; }, 500);
              } else {
                // cartType === 'page' - redirect to cart
                closeLightbox();
                window.location.href = '/cart';
              }
            } else {
              button.innerHTML = '<span>{{ "cart.error" | t }}</span>';
              setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
            }
          })
          .catch(() => {
            button.innerHTML = '<span>{{ "cart.error" | t }}</span>';
            setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
          });
      });
    }
  }

  function formatMoney(cents) {
    if (typeof Shopify !== 'undefined' && Shopify.formatMoney) return Shopify.formatMoney(cents, {{ shop.money_format | json }});
    return new Intl.NumberFormat('{{ request.locale.iso_code | default: "en-US" }}', { style: 'currency', currency: '{{ cart.currency.iso_code | default: "USD" }}' }).format(cents / 100);
  }

})();
</script>

{% schema %}
{
  "name": "Shoppable Videos",
  "tag": "section",
  "class": "shoppable-videos-section",
  "settings": [
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label",
      "default": "Shop the look"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Shoppable Videos"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "default": "left",
      "label": "Header alignment"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "videos_desktop",
      "label": "Videos per row (Desktop)",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" },
        { "value": "5", "label": "5" },
        { "value": "6", "label": "6" }
      ],
      "default": "4"
    },
    {
      "type": "select",
      "id": "videos_tablet",
      "label": "Videos per row (Tablet)",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" }
      ],
      "default": "3"
    },
    {
      "type": "select",
      "id": "videos_mobile",
      "label": "Videos per row (Mobile)",
      "options": [
        { "value": "1", "label": "1 (peek nearby)" },
        { "value": "2", "label": "2" }
      ],
      "default": "1"
    },
    {
      "type": "select",
      "id": "video_spacing",
      "label": "Gap between videos",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "video_aspect_ratio",
      "label": "Video aspect ratio",
      "options": [
        { "value": "9/16", "label": "9:16 (Portrait)" },
        { "value": "3/4", "label": "3:4 (Instagram)" },
        { "value": "1/1", "label": "1:1 (Square)" },
        { "value": "4/3", "label": "4:3 (Standard)" },
        { "value": "16/9", "label": "16:9 (Landscape)" }
      ],
      "default": "9/16"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_product_info",
      "label": "Show product info on cards",
      "default": true
    },
    {
      "type": "header",
      "content": "Autoplay"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable autoplay",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Scroll speed",
      "default": 2,
      "min": 1,
      "max": 10,
      "step": 1,
      "info": "1 = slow, 10 = fast"
    },
    {
      "type": "checkbox",
      "id": "pause_on_hover",
      "label": "Pause on hover",
      "default": true
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    }
  ],
  "blocks": [
    {
      "type": "video",
      "name": "Video",
      "settings": [
        {
          "type": "video",
          "id": "video_hosted",
          "label": "Video",
          "info": "Upload MP4 video to Shopify"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shoppable Videos",
      "category": "Products",
      "blocks": [
        { "type": "video" },
        { "type": "video" },
        { "type": "video" },
        { "type": "video" }
      ]
    }
  ]
}
{% endschema %}
