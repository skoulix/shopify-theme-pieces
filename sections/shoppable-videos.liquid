{%- comment -%}
  Shoppable Videos - Video carousel with product integration
  Features: Keen Slider carousel, video lightbox, product overlays, add-to-cart
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif

  assign videos_mobile = section.settings.videos_mobile | default: '1'
  assign videos_tablet = section.settings.videos_tablet | default: '3'
  assign videos_desktop = section.settings.videos_desktop | default: '4'
  assign video_spacing = section.settings.video_spacing | default: 'medium'
  assign video_aspect_ratio = section.settings.video_aspect_ratio | default: '9/16'

  # Global card settings
  assign card_radius = settings.card_radius | default: 8
  assign card_border_width = settings.card_border_width | default: 0
  assign card_shadow = settings.card_shadow | default: 'none'
-%}

<style>
  .shoppable-videos-{{ section.id }} {
    background-color: {{ section.settings.background_color }};
    color: {{ section.settings.text_color }};
    padding: var(--section-vertical-padding) 0;
    overflow: hidden;
  }

  /* Header - matching testimonials */
  .shoppable-videos-header-{{ section.id }} {
    margin-bottom: clamp(3rem, 6vh, 5rem);
    text-align: {{ section.settings.header_alignment }};
  }

  .shoppable-videos-label-{{ section.id }} {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    margin-bottom: 1.5rem;
  }

  .shoppable-videos-label-{{ section.id }}.intro-visible {
    opacity: 0.5;
  }

  .shoppable-videos-title-{{ section.id }} {
    font-size: calc(clamp(2rem, 5vw, 3.5rem) * var(--heading-font-scale, 1));
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1;
  }

  .shoppable-videos-title-line:nth-child(2) {
    margin-left: clamp(0.5rem, 4vw, 2rem);
  }

  .shoppable-videos-description-{{ section.id }} {
    font-size: 1rem;
    opacity: 0.7;
    max-width: 42rem;
    margin-top: 1.5rem;
    {% if section.settings.header_alignment == 'center' %}
    margin-left: auto;
    margin-right: auto;
    {% endif %}
  }

  /* Video card styles */
  .shoppable-video-card-{{ section.id }} {
    position: relative;
    overflow: hidden;
    isolation: isolate;
    display: block;
    aspect-ratio: {{ video_aspect_ratio }};
    width: 100%;
    height: auto;
    border-radius: {{ card_radius }}px;
    {% if card_border_width > 0 %}
    border: {{ card_border_width }}px solid var(--color-border);
    {% endif %}
    {% case card_shadow %}
      {% when 'sm' %}
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      {% when 'md' %}
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      {% when 'lg' %}
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      {% when 'hard' %}
      box-shadow: 4px 4px 0 0 {{ section.settings.text_color }}15;
    {% endcase %}
  }

  /* Slider track */
  .shoppable-videos-track-{{ section.id }} {
    display: flex;
    gap: {% case video_spacing %}{% when 'none' %}0{% when 'small' %}0.5rem{% when 'large' %}1.5rem{% else %}1rem{% endcase %};
    transition: transform 0.8s cubic-bezier(0.65, 0, 0.35, 1);
  }

  .shoppable-video-slide-{{ section.id }} {
    flex-shrink: 0;
    {%- comment -%} Mobile: Show configured number with peek for next slide {%- endcomment -%}
    {%- case videos_mobile -%}
      {%- when '2' -%}
        width: calc(50% - 0.5rem);
      {%- else -%}
        width: calc(85% - 0.5rem);
    {%- endcase -%}
  }

  @media (min-width: 768px) {
    .shoppable-videos-track-{{ section.id }} {
      gap: {% case video_spacing %}{% when 'none' %}0{% when 'small' %}0.5rem{% when 'large' %}1.5rem{% else %}1rem{% endcase %};
    }

    .shoppable-video-slide-{{ section.id }} {
      {%- comment -%} Tablet: Show configured number with peek {%- endcomment -%}
      {%- case videos_tablet -%}
        {%- when '2' -%}
          width: calc(45% - 0.5rem);
        {%- when '4' -%}
          width: calc(24% - 0.75rem);
        {%- else -%}
          width: calc(32% - 0.67rem);
      {%- endcase -%}
    }
  }

  @media (min-width: 1024px) {
    .shoppable-video-slide-{{ section.id }} {
      {%- comment -%} Desktop: Show configured number with peek for scrolling {%- endcomment -%}
      {%- case videos_desktop -%}
        {%- when '2' -%}
          width: calc(45% - 0.5rem);
        {%- when '3' -%}
          width: calc(32% - 0.67rem);
        {%- when '5' -%}
          width: calc(19% - 0.8rem);
        {%- when '6' -%}
          width: calc(16% - 0.83rem);
        {%- else -%}
          width: calc(24% - 0.75rem);
      {%- endcase -%}
    }
  }

  /* Play overlay */
  .shoppable-video-card-{{ section.id }}.cursor-pointer .play-overlay {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .shoppable-video-card-{{ section.id }}.cursor-pointer:hover .play-overlay {
    opacity: 1;
  }

  .shoppable-video-card-{{ section.id }}.cursor-default {
    cursor: default !important;
  }

  /* Navigation - matching testimonials style */
  .shoppable-videos-nav-{{ section.id }} {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-top: 3rem;
  }

  .shoppable-videos-nav-btn-{{ section.id }} {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid {{ section.settings.text_color }}30;
    color: {{ section.settings.text_color }};
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .shoppable-videos-nav-btn-{{ section.id }}:hover {
    background: {{ section.settings.text_color }};
    color: {{ section.settings.background_color }};
  }

  .shoppable-videos-nav-btn-{{ section.id }}:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .shoppable-videos-nav-btn-{{ section.id }}:disabled:hover {
    background: transparent;
    color: {{ section.settings.text_color }};
  }

  /* Lightbox styles */
  .shoppable-video-lightbox {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .shoppable-video-lightbox.active {
    display: flex;
  }

  .shoppable-lightbox-content {
    display: flex;
    gap: 2rem;
    max-width: 1400px;
    width: 90%;
    max-height: 85vh;
  }

  .shoppable-lightbox-video {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .shoppable-lightbox-video video {
    width: 100%;
    height: auto;
    max-height: 75vh;
    max-width: 100%;
    object-fit: contain;
    transition: opacity 0.3s ease;
    border-radius: {{ card_radius }}px;
  }

  .shoppable-lightbox-product {
    width: 320px;
    background: white;
    padding: 1.5rem;
    border-radius: {{ card_radius }}px;
    overflow-y: auto;
    max-height: 75vh;
    flex-shrink: 0;
  }

  #shoppable-product-info-{{ section.id }} {
    transition: opacity 0.3s ease;
  }

  .shoppable-lightbox-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10000;
    color: white;
  }

  .shoppable-lightbox-close:hover {
    background: white;
    color: black;
  }

  /* Lightbox navigation buttons */
  .shoppable-lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10000;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
  }

  .shoppable-lightbox-nav:hover {
    background: white;
    color: black;
  }

  .shoppable-lightbox-nav.lightbox-prev { left: 2rem; }
  .shoppable-lightbox-nav.lightbox-next { right: 2rem; }
  .shoppable-lightbox-nav:disabled { opacity: 0.3; cursor: not-allowed; }
  .shoppable-lightbox-nav:disabled:hover { background: rgba(255, 255, 255, 0.1); color: white; transform: translateY(-50%); }

  /* Mobile responsive lightbox */
  @media (max-width: 768px) {
    .shoppable-lightbox-nav {
      width: 40px;
      height: 40px;
      top: auto;
      transform: none;
    }
    .shoppable-lightbox-nav.lightbox-prev { top: 20px; left: 20px; }
    .shoppable-lightbox-nav.lightbox-next { top: 20px; left: 70px; }
    .shoppable-lightbox-nav:hover { transform: none; }
    .shoppable-lightbox-nav:disabled:hover { transform: none; }

    .shoppable-lightbox-content {
      flex-direction: column;
      width: calc(100% - 1rem);
      max-width: calc(100% - 1rem);
      max-height: calc(100vh - 1rem);
      gap: 0;
      margin: 0.5rem;
    }

    .shoppable-lightbox-video {
      width: 100%;
      flex: 1;
      min-height: 0;
    }

    .shoppable-lightbox-video video {
      border-radius: {{ card_radius }}px {{ card_radius }}px 0 0 !important;
      max-height: 60vh;
      width: 100%;
    }

    .shoppable-lightbox-product {
      width: 100%;
      max-height: 35vh;
      border-radius: 0 0 {{ card_radius }}px {{ card_radius }}px;
      padding: 1rem;
    }
  }

  /* Slider container */
  .shoppable-videos-slider-{{ section.id }} {
    position: relative;
    overflow: visible;
  }

  /* Override data-intro transform once visible so slider translateX works */
  .shoppable-videos-slider-{{ section.id }}.intro-visible {
    transform: none !important;
  }

  /* Animation states */
  html.animations-disabled .shoppable-videos-{{ section.id }} [data-intro] {
    opacity: 1;
    transform: none;
  }

  html.animations-disabled .shoppable-videos-title-{{ section.id }} {
    opacity: 1;
    transform: none;
  }

  html.animations-disabled .shoppable-videos-label-{{ section.id }} {
    opacity: 0.5;
    transform: none;
  }
</style>

<section
  class="shoppable-videos-{{ section.id }}"
  data-shoppable-videos="{{ section.id }}"
>
  <div class="{{ container_class }}">
    {%- comment -%} Header {%- endcomment -%}
    {% if section.settings.label != blank or section.settings.title != blank or section.settings.description != blank %}
      <div class="shoppable-videos-header-{{ section.id }}">
        {% if section.settings.label != blank %}
          <span class="shoppable-videos-label-{{ section.id }}" data-intro>
            {{ section.settings.label }}
          </span>
        {% endif %}

        {% if section.settings.title != blank %}
          <h2 class="shoppable-videos-title-{{ section.id }} font-heading" data-shoppable-videos-title>
            {{ section.settings.title }}
          </h2>
        {% endif %}

        {% if section.settings.description != blank %}
          <p class="shoppable-videos-description-{{ section.id }}" data-intro>
            {{ section.settings.description }}
          </p>
        {% endif %}
      </div>
    {% endif %}

    <!-- Videos Carousel -->
    <div class="shoppable-videos-slider-{{ section.id }}" data-intro>
      <div class="shoppable-videos-track-{{ section.id }}" data-shoppable-videos-track>
        {% for block in section.blocks %}
          {% if block.type == 'video' %}
            {%- liquid
              assign video_hosted = block.settings.video_hosted
              assign product = block.settings.product
              assign has_video = false

              if video_hosted != blank
                assign has_video = true
              endif
            -%}
            <div class="shoppable-video-slide-{{ section.id }}" data-video-slide {{ block.shopify_attributes }}>
                <div class="shoppable-video-card-{{ section.id }} relative w-full overflow-hidden {% if has_video %}cursor-pointer{% else %}cursor-default{% endif %}"
                     style="background-color: {{ section.settings.text_color }}08;"
                     {% if has_video %}
                       data-video-url="{{ video_hosted.sources[1].url | default: video_hosted.sources[0].url }}"
                     {% endif %}
                     {% if product != blank %}
                       data-product-id="{{ product.id }}"
                       data-product-title="{{ product.title | escape }}"
                       data-product-price="{{ product.price }}"
                       data-product-handle="{{ product.handle }}"
                       data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                       {% if product.compare_at_price > product.price %}
                         data-product-compare-price="{{ product.compare_at_price }}"
                       {% endif %}
                       data-product-image="{{ product.featured_image | image_url: width: 400 }}"
                     {% endif %}
                     data-video-index="{{ forloop.index0 }}"
                     {% if video_hosted.alt != blank %}aria-label="{{ video_hosted.alt }}"{% endif %}>

                  {% if has_video %}
                    <video
                      class="carousel-video absolute inset-0 z-0 w-full h-full object-cover block pointer-events-none"
                      style="border-radius: {{ card_radius }}px;"
                      autoplay
                      muted
                      loop
                      playsinline
                      preload="metadata"
                      {% if video_hosted.alt != blank %}aria-label="{{ video_hosted.alt }}"{% endif %}>
                      {%- for source in video_hosted.sources -%}
                        <source src="{{ source.url }}" type="{{ source.mime_type }}">
                      {%- endfor -%}
                    </video>
                  {% else %}
                    <div class="absolute inset-0 w-full h-full flex items-center justify-center z-0" style="background: {{ section.settings.text_color }}08;">
                      <i class="ph ph-video-camera text-6xl" style="color: {{ section.settings.text_color }}20;"></i>
                    </div>
                  {% endif %}

                  {%- comment -%} Gradient overlay for readability {%- endcomment -%}
                  {% if has_video %}
                    <div class="absolute inset-0 z-[1] pointer-events-none" style="background: linear-gradient(to bottom, transparent 0%, transparent 50%, rgba(0,0,0,0.7) 100%); border-radius: {{ card_radius }}px;"></div>
                  {% endif %}

                  {% if has_video %}
                    <div class="play-overlay absolute inset-0 z-[2] flex items-center justify-center pointer-events-none">
                      <div class="bg-black/50 rounded-full p-4">
                        <i class="ph ph-arrows-out text-4xl text-white"></i>
                      </div>
                    </div>
                  {% endif %}

                  {% if section.settings.show_product_info and product != blank %}
                    <div class="shoppable-product-info absolute inset-x-0 bottom-0 p-3 pointer-events-none" style="z-index: 20; border-radius: 0 0 {{ card_radius }}px {{ card_radius }}px;">
                      <h3 class="text-white text-sm font-semibold mb-1 line-clamp-2">{{ product.title }}</h3>
                      <div class="text-sm text-white mb-2">
                        {% if product.compare_at_price > product.price %}
                          <span class="text-white/70 line-through mr-1">{{ product.compare_at_price | money }}</span>
                        {% endif %}
                        <span class="text-white font-bold">{{ product.price | money }}</span>
                      </div>
                      <div class="text-xs text-white font-medium uppercase tracking-wider">{{ 'general.shop_now' | t }} <i class="ph ph-arrow-right"></i></div>
                    </div>
                  {% endif %}

                </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Navigation Buttons -->
    {% if section.blocks.size > 1 %}
      <div class="shoppable-videos-nav-{{ section.id }}" data-intro>
        <button type="button" class="shoppable-videos-nav-btn-{{ section.id }}" data-shoppable-videos-prev aria-label="{{ 'accessibility.previous_slide' | t }}">
          <i class="ph ph-arrow-left"></i>
        </button>
        <button type="button" class="shoppable-videos-nav-btn-{{ section.id }}" data-shoppable-videos-next aria-label="{{ 'accessibility.next_slide' | t }}">
          <i class="ph ph-arrow-right"></i>
        </button>
      </div>
    {% endif %}
  </div>
</section>

<!-- Video Lightbox -->
<div class="shoppable-video-lightbox" id="shoppable-video-lightbox-{{ section.id }}" role="dialog" aria-modal="true" aria-label="{{ 'accessibility.close' | t }}">
  <button class="shoppable-lightbox-close" aria-label="{{ 'accessibility.close' | t }}">
    <i class="ph ph-x text-xl"></i>
  </button>

  <button class="shoppable-lightbox-nav lightbox-prev" aria-label="{{ 'accessibility.previous_slide' | t }}">
    <i class="ph ph-arrow-left"></i>
  </button>
  <button class="shoppable-lightbox-nav lightbox-next" aria-label="{{ 'accessibility.next_slide' | t }}">
    <i class="ph ph-arrow-right"></i>
  </button>

  <div class="shoppable-lightbox-content">
    <div class="shoppable-lightbox-video">
      <video controls autoplay muted playsinline preload="none" id="shoppable-lightbox-video-{{ section.id }}">
        <source src="" type="video/mp4">
      </video>
    </div>

    <div class="shoppable-lightbox-product">
      <div id="shoppable-product-info-{{ section.id }}"></div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const section = document.querySelector('[data-shoppable-videos="{{ section.id }}"]');
  if (!section || section.dataset.shoppableInitialized) return;
  section.dataset.shoppableInitialized = 'true';

  // Title/Label animations - called after GSAP loads
  function initAnimations() {
    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    let SplitText = window.SplitText;
    if (!SplitText && window.pieces && window.pieces.SplitText) {
      SplitText = window.pieces.SplitText;
    }

    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    // Title animation
    const shouldAnimate = typeof window.shouldAnimate === 'function' ? window.shouldAnimate() : true;
    const title = section.querySelector('[data-shoppable-videos-title]');
    const label = section.querySelector('.shoppable-videos-label-{{ section.id }}');

    if (shouldAnimate && title && gsap && SplitText && ScrollTrigger) {
      const split = new SplitText(title, { type: 'lines', linesClass: 'shoppable-videos-title-line' });

      split.lines.forEach(line => {
        const lineWrapper = document.createElement('div');
        lineWrapper.style.overflow = 'hidden';
        lineWrapper.style.display = 'block';
        line.parentNode.insertBefore(lineWrapper, line);
        lineWrapper.appendChild(line);
      });

      gsap.set(split.lines, { yPercent: 120 });

      gsap.to(split.lines, {
        yPercent: 0,
        duration: 1.2,
        ease: 'power4.out',
        stagger: 0.1,
        scrollTrigger: {
          trigger: section,
          start: 'top 70%',
          once: true
        }
      });
    }

    // Label animation
    if (shouldAnimate && label && gsap && ScrollTrigger) {
      gsap.set(label, { opacity: 0, y: 20 });
      gsap.to(label, {
        opacity: 0.5,
        y: 0,
        duration: 0.8,
        ease: 'power2.out',
        scrollTrigger: {
          trigger: section,
          start: 'top 70%',
          once: true
        },
        onComplete: function() {
          label.classList.add('intro-visible');
        }
      });
    } else if (label) {
      label.classList.add('intro-visible');
    }
  }

  // Slider functionality - matching testimonials pattern exactly
  const track = section.querySelector('[data-shoppable-videos-track]');
  const slides = section.querySelectorAll('[data-video-slide]');
  const prevBtn = section.querySelector('[data-shoppable-videos-prev]');
  const nextBtn = section.querySelector('[data-shoppable-videos-next]');

  if (slides.length <= 1) {
    // Hide nav if only one slide
    if (prevBtn) prevBtn.style.display = 'none';
    if (nextBtn) nextBtn.style.display = 'none';
  } else {
    let currentIndex = 0;
    const totalSlides = slides.length;

    function getSlideWidth() {
      const slide = slides[0];
      const trackStyle = getComputedStyle(track);
      const gap = parseFloat(trackStyle.gap) || 0;
      return slide.offsetWidth + gap;
    }

    function getMaxTranslate() {
      const slideWidth = slides[0].offsetWidth;
      const trackStyle = getComputedStyle(track);
      const gap = parseFloat(trackStyle.gap) || 0;
      const totalTrackWidth = (slideWidth * totalSlides) + (gap * (totalSlides - 1));
      const containerWidth = track.parentElement.offsetWidth;
      return Math.max(0, totalTrackWidth - containerWidth);
    }

    function updateSlider(index) {
      const slideWidth = getSlideWidth();
      let translateX = index * slideWidth;
      const maxTranslate = getMaxTranslate();
      translateX = Math.min(translateX, maxTranslate);
      track.style.transform = 'translateX(' + (-translateX) + 'px)';
      currentIndex = index;
    }

    function nextSlide() {
      const next = (currentIndex + 1) % totalSlides;
      updateSlider(next);
    }

    function prevSlide() {
      const prev = (currentIndex - 1 + totalSlides) % totalSlides;
      updateSlider(prev);
    }

    // Event listeners
    if (prevBtn) prevBtn.addEventListener('click', prevSlide);
    if (nextBtn) nextBtn.addEventListener('click', nextSlide);

    // Touch/swipe support
    let touchStartX = 0;
    track.addEventListener('touchstart', function(e) {
      touchStartX = e.touches[0].clientX;
    }, { passive: true });

    track.addEventListener('touchend', function(e) {
      const touchEndX = e.changedTouches[0].clientX;
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          nextSlide();
        } else {
          prevSlide();
        }
      }
    }, { passive: true });

    // Initial position
    updateSlider(0);

    // Recalculate on resize
    window.addEventListener('resize', function() {
      updateSlider(currentIndex);
    });
  }

  // Video autoplay on visibility
  const videoObserver = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      const video = entry.target.querySelector('.carousel-video');
      if (!video) return;
      if (entry.isIntersecting) {
        video.play().catch(() => { video.muted = true; video.play().catch(() => {}); });
      } else {
        video.pause();
      }
    });
  }, { threshold: 0.5 });
  slides.forEach(slide => videoObserver.observe(slide));

  // Lightbox functionality
  const lightbox = document.getElementById('shoppable-video-lightbox-{{ section.id }}');
  const lightboxVideo = document.getElementById('shoppable-lightbox-video-{{ section.id }}');
  const productInfo = document.getElementById('shoppable-product-info-{{ section.id }}');
  const closeBtn = lightbox ? lightbox.querySelector('.shoppable-lightbox-close') : null;
  const videoThumbnails = section.querySelectorAll('.shoppable-video-card-{{ section.id }}');
  let currentVideoIndex = 0;
  const lightboxPrevBtn = lightbox ? lightbox.querySelector('.lightbox-prev') : null;
  const lightboxNextBtn = lightbox ? lightbox.querySelector('.lightbox-next') : null;

  function updateLightboxNav() {
    if (lightboxPrevBtn) lightboxPrevBtn.disabled = currentVideoIndex <= 0;
    if (lightboxNextBtn) lightboxNextBtn.disabled = currentVideoIndex >= videoThumbnails.length - 1;
  }

  function openVideoAtIndex(index) {
    if (index < 0 || index >= videoThumbnails.length) return;
    currentVideoIndex = index;
    const thumb = videoThumbnails[index];
    const videoUrl = thumb.dataset.videoUrl;
    if (!videoUrl) return;

    if (lightboxVideo) {
      lightboxVideo.src = videoUrl;
      lightboxVideo.load();
      lightboxVideo.play().catch(() => { lightboxVideo.muted = true; lightboxVideo.play().catch(() => {}); });
    }

    if (thumb.dataset.productId && thumb.dataset.productTitle && thumb.dataset.variantId) {
      displayProductInfo({
        id: thumb.dataset.productId,
        title: thumb.dataset.productTitle,
        price: thumb.dataset.productPrice,
        compare_at_price: thumb.dataset.productComparePrice,
        handle: thumb.dataset.productHandle,
        variantId: thumb.dataset.variantId,
        image: thumb.dataset.productImage
      });
    } else if (productInfo) {
      productInfo.innerHTML = '';
    }

    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
    updateLightboxNav();
  }

  function closeLightbox() {
    if (lightbox) lightbox.classList.remove('active');
    if (lightboxVideo) { lightboxVideo.pause(); lightboxVideo.src = ''; }
    document.body.style.overflow = '';
  }

  if (lightboxPrevBtn) lightboxPrevBtn.addEventListener('click', () => { if (currentVideoIndex > 0) openVideoAtIndex(currentVideoIndex - 1); });
  if (lightboxNextBtn) lightboxNextBtn.addEventListener('click', () => { if (currentVideoIndex < videoThumbnails.length - 1) openVideoAtIndex(currentVideoIndex + 1); });
  if (closeBtn) closeBtn.addEventListener('click', closeLightbox);
  if (lightbox) lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });

  document.addEventListener('keydown', (e) => {
    if (!lightbox || !lightbox.classList.contains('active')) return;
    if (e.key === 'ArrowLeft' && currentVideoIndex > 0) openVideoAtIndex(currentVideoIndex - 1);
    else if (e.key === 'ArrowRight' && currentVideoIndex < videoThumbnails.length - 1) openVideoAtIndex(currentVideoIndex + 1);
    else if (e.key === 'Escape') closeLightbox();
  });

  videoThumbnails.forEach((thumb, index) => {
    thumb.addEventListener('click', (e) => {
      e.preventDefault();
      if (thumb.dataset.videoUrl) openVideoAtIndex(index);
    });
  });

  function displayProductInfo(product) {
    if (!productInfo) return;
    productInfo.innerHTML = `
      <div class="shoppable-product-lightbox-info">
        ${product.image ? `<img src="${product.image}" alt="${product.title}" class="w-full rounded-lg mb-4 object-cover aspect-square">` : ''}
        <h3 class="text-base font-semibold mb-3"><a href="/products/${product.handle}" class="hover:underline">${product.title}</a></h3>
        <div class="text-lg font-bold mb-6">
          ${product.compare_at_price ? `<span class="text-gray-500 line-through text-sm mr-2">${formatMoney(product.compare_at_price)}</span>` : ''}
          ${formatMoney(product.price)}
        </div>
        <form class="shoppable-add-to-cart-form" data-product-id="${product.id}">
          <input type="hidden" name="id" value="${product.variantId}">
          <input type="hidden" name="quantity" value="1">
          <button type="submit" class="btn btn--primary w-full"><span>{{ 'products.product.add_to_cart' | t }}</span></button>
        </form>
      </div>
    `;

    const form = productInfo.querySelector('.shoppable-add-to-cart-form');
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const button = form.querySelector('button[type="submit"]');
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span>{{ "cart.adding" | t }}</span>';

        fetch('/cart/add.js', { method: 'POST', body: new FormData(form) })
          .then(response => {
            if (response.ok) {
              button.innerHTML = '<span>{{ "cart.added" | t }}</span>';
              document.dispatchEvent(new CustomEvent('cart:refresh'));
              if (typeof window.openCartDrawer === 'function') {
                setTimeout(() => { closeLightbox(); window.openCartDrawer(); }, 500);
              } else {
                setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
              }
            } else {
              button.innerHTML = '<span>{{ "cart.error" | t }}</span>';
              setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
            }
          })
          .catch(() => {
            button.innerHTML = '<span>{{ "cart.error" | t }}</span>';
            setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
          });
      });
    }
  }

  function formatMoney(cents) {
    if (typeof Shopify !== 'undefined' && Shopify.formatMoney) return Shopify.formatMoney(cents, {{ shop.money_format | json }});
    return new Intl.NumberFormat('{{ request.locale.iso_code | default: "en-US" }}', { style: 'currency', currency: '{{ cart.currency.iso_code | default: "USD" }}' }).format(cents / 100);
  }

  // Initialize animations after DOM/GSAP ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimations);
  } else {
    requestAnimationFrame(initAnimations);
  }

  window.addEventListener('swup:contentReplaced', function() {
    requestAnimationFrame(initAnimations);
  });
})();
</script>

{% schema %}
{
  "name": "Shoppable Videos",
  "tag": "section",
  "class": "shoppable-videos-section",
  "settings": [
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label",
      "default": "Shop the look"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Shoppable Videos"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "select",
      "id": "header_alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "left",
      "label": "Header alignment"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "videos_desktop",
      "label": "Videos per row (Desktop)",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" },
        { "value": "5", "label": "5" },
        { "value": "6", "label": "6" }
      ],
      "default": "4"
    },
    {
      "type": "select",
      "id": "videos_tablet",
      "label": "Videos per row (Tablet)",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" }
      ],
      "default": "3"
    },
    {
      "type": "select",
      "id": "videos_mobile",
      "label": "Videos per row (Mobile)",
      "options": [
        { "value": "1", "label": "1 (peek nearby)" },
        { "value": "2", "label": "2" }
      ],
      "default": "1"
    },
    {
      "type": "select",
      "id": "video_spacing",
      "label": "Gap between videos",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "video_aspect_ratio",
      "label": "Video aspect ratio",
      "options": [
        { "value": "9/16", "label": "9:16 (Portrait)" },
        { "value": "3/4", "label": "3:4 (Instagram)" },
        { "value": "1/1", "label": "1:1 (Square)" },
        { "value": "4/3", "label": "4:3 (Standard)" },
        { "value": "16/9", "label": "16:9 (Landscape)" }
      ],
      "default": "9/16"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_product_info",
      "label": "Show product info on cards",
      "default": true
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#000000"
    }
  ],
  "blocks": [
    {
      "type": "video",
      "name": "Video",
      "settings": [
        {
          "type": "video",
          "id": "video_hosted",
          "label": "Video",
          "info": "Upload MP4 video to Shopify"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shoppable Videos",
      "category": "Products",
      "blocks": [
        { "type": "video" },
        { "type": "video" },
        { "type": "video" },
        { "type": "video" }
      ]
    }
  ]
}
{% endschema %}
