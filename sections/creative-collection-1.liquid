{%- comment -%}
  Creative Collection Section - Horizontal Scroll Gallery with GSAP Flip Animations
  Based on Moussa Mamadou's Webflow design

  Features:
  - Horizontal scrolling product gallery
  - GSAP Flip transitions to product detail overlay
  - Swup navigation to product page after animation completes
{%- endcomment -%}

{%- liquid
  if section.settings.collection != blank
    assign collection = collections[section.settings.collection]
  elsif collection != blank
    assign collection = collection
  else
    assign collection = collections.all
  endif
-%}

<style>
  .cc1-line, .cc1-word, .cc1-line-wrap, .cc1-char-wrap {
    overflow: hidden;
  }
  .cc1-line-wrap, .cc1-char-wrap {
    display: inline-block;
  }
  .cc1-cursor {
    position: fixed;
    width: 1.5rem;
    height: 1.5rem;
    z-index: 9999;
    pointer-events: none;
    transition: opacity 0.5s cubic-bezier(0.215, 0.61, 0.355, 1);
    opacity: 0;
  }
  .cc1-cursor.is-visible {
    opacity: 1;
  }
  .cc1-cursor.is-open .cc1-cross_button {
    transform: rotateZ(360deg);
  }
  .cc1-cross_button {
    transition: transform 0.5s cubic-bezier(0.215, 0.61, 0.355, 1);
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 1px solid black;
    background-color: white;
    transform: rotateZ(45deg);
  }
  .cc1-cross_button::after,
  .cc1-cross_button::before {
    content: "";
    position: absolute;
    background-color: black;
    top: 50%;
    left: 50%;
    width: calc(100% - 0.75rem);
    height: 1.1px;
  }
  .cc1-cross_button::after {
    transform: translate(-50%, -50%) rotateZ(-45deg);
  }
  .cc1-cross_button::before {
    transform: translate(-50%, -50%) rotateZ(45deg);
  }
  .cc1-content:nth-child(even) .cc1-content_title-top {
    justify-content: flex-end;
  }
  .cc1-content:nth-child(even) .cc1-content_title-bottom {
    justify-content: flex-start;
  }
  .cc1-content:nth-child(even) .cc1-content_text-left {
    justify-content: flex-start;
  }
  .cc1-content:nth-child(even) .cc1-content_text-right {
    justify-content: flex-end;
  }
  .cc1-section_content {
    position: fixed;
    top: 0;
    left: 0;
    flex-flow: row;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100vh;
    z-index: 50;
    background: #fff;
  }
  .cc1-section_content.cc1-is-hidden {
    z-index: -1;
    pointer-events: none;
  }
  .cc1-content_wrapper {
    aspect-ratio: 1;
    cursor: pointer;
    width: 50vw;
    max-height: 80vh;
    position: relative;
  }
  .cc1-title-small {
    text-transform: uppercase;
    font-size: clamp(0.9rem, 0.9vw, 2.5rem);
    font-weight: 600;
    line-height: 1.1;
    overflow: hidden;
  }
  .cc1-content {
    position: absolute;
    top: 0;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100vh;
    display: flex;
    box-sizing: border-box;
  }
  .cc1-gallery {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
  }
  .cc1-gallery_image {
    aspect-ratio: 1;
    cursor: pointer;
    overflow: hidden;
  }
  .cc1-section-wrapper {
    position: relative;
    width: 100%;
    min-height: 100vh;
  }
  .cc1-scroll-wrapper {
    position: relative;
    z-index: 1;
    width: 100%;
  }
  .cc1-content_text-right {
    gap: 0.5rem;
    flex-flow: column;
    width: 17vw;
    height: 100%;
    padding: 2.5em 0 2.5em 1em;
    display: flex;
    position: absolute;
    left: 100%;
  }
  .cc1-content_text-left {
    gap: 0.25rem;
    text-align: right;
    flex-flow: column;
    justify-content: flex-end;
    align-items: flex-end;
    width: 17vw;
    height: 100%;
    padding: 2.5em 1em 2.5em 0;
    display: flex;
    position: absolute;
    right: 100%;
  }
  .cc1-content_title-top {
    mix-blend-mode: difference;
    filter: invert();
    justify-content: flex-start;
    align-items: center;
    width: 105%;
    margin-left: 2em;
    display: flex;
    position: absolute;
    bottom: calc(100% - 2.5vw);
  }
  .cc1-content_title-bottom {
    color: #000;
    mix-blend-mode: difference;
    filter: invert();
    justify-content: flex-end;
    align-items: center;
    width: 105%;
    margin-left: 2em;
    display: flex;
    position: absolute;
    top: calc(100% - 2.5vw);
    left: 0%;
  }
  .cc1-title-big {
    color: #000;
    font-size: 6vw;
    font-weight: 600;
    line-height: 0.8em;
    text-transform: uppercase;
  }
  .cc1-scroll-content {
    width: 100%;
    padding: 4rem 0;
  }
  .cc1-image_container {
    width: 100%;
    height: 100%;
  }
  .cc1-image_container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .cc1-is-hidden {
    visibility: hidden;
  }
  .cc1-paragraph {
    font-size: clamp(0.9rem, 0.9vw, 2.5rem);
    line-height: 1.3;
    overflow: hidden;
    width: 100%;
    display: block;
    white-space: normal;
  }
  .cc1-price {
    font-size: clamp(1rem, 1.2vw, 2rem);
    font-weight: 500;
    margin-top: 0.5em;
  }
  .cc1-view-product {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1em;
    padding: 0.75em 1.5em;
    background: #000;
    color: #fff;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: background 0.3s ease;
  }
  .cc1-view-product:hover {
    background: #333;
  }

  @media screen and (max-width: 991px) {
    .cc1-content_text-right,
    .cc1-content_text-left {
      width: 20vw;
    }
  }
  @media screen and (max-width: 767px) {
    .cc1-gallery {
      grid-template-columns: 1fr;
      gap: 1.5rem;
      padding: 1rem;
    }
    .cc1-content_wrapper {
      width: 85vw;
      max-height: 65vh;
    }
    .cc1-content_text-right,
    .cc1-content_text-left {
      display: none;
    }
    .cc1-content_title-top,
    .cc1-content_title-bottom {
      width: 100%;
      margin-left: 0;
    }
  }
</style>

{%- comment -%} Custom Cursor {%- endcomment -%}
<div class="cc1-cursor" data-cc1-cursor="container">
  <div class="cc1-cross_button"></div>
</div>

{%- comment -%} Main Section Wrapper {%- endcomment -%}
<div class="cc1-section-wrapper">
  {%- comment -%} Horizontal Scroll Gallery {%- endcomment -%}
  <div class="cc1-scroll-wrapper" data-cc1-scroll="wrapper">
  <section class="cc1-scroll-content" data-cc1-scroll="content">
    <div class="cc1-gallery">
      {% for product in collection.products limit: section.settings.products_to_show %}
        <div
          class="cc1-gallery_image"
          data-cc1-gallery="image-wrapper"
          data-product-url="{{ product.url }}"
        >
          <div class="cc1-image_container" data-cc1-gallery="image">
            {% if product.featured_image %}
              {{ product.featured_image | image_url: width: 1200 | image_tag:
                loading: 'lazy',
                sizes: '(max-width: 767px) 100vw, 900px',
                widths: '500, 800, 1080, 1200',
                alt: product.title
              }}
            {% else %}
              <div class="flex h-full w-full items-center justify-center bg-gray-100">
                <i class="ph ph-image text-4xl text-gray-300"></i>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </section>
  </div>
</div>

{%- comment -%} Product Detail Overlays - Outside wrapper to avoid overflow clipping {%- endcomment -%}
<section class="cc1-section_content cc1-is-hidden" data-cc1-content="section">
  {% for product in collection.products limit: section.settings.products_to_show %}
    {%- assign title_words = product.title | split: ' ' -%}
    {%- assign first_word = title_words | first -%}
    {%- assign last_word = title_words | last -%}
    {%- if title_words.size == 1 -%}
      {%- assign last_word = product.type | default: 'Product' -%}
    {%- endif -%}

    <div class="cc1-content cc1-is-hidden" data-cc1-content="details" data-product-url="{{ product.url }}">
      <div class="cc1-content_wrapper" data-cc1-content="details-wrapper">
        <div class="cc1-content_title-top" data-cc1-content="text-top">
          <div class="cc1-title-big">{{ first_word }}</div>
        </div>
        <div class="cc1-content_title-bottom" data-cc1-content="text-bottom">
          <div class="cc1-title-big">{{ last_word }}</div>
        </div>
        <div class="cc1-content_text-left" data-cc1-content="text-left">
          <div class="cc1-title-small">{{ product.type | default: 'Collection' }}</div>
          <div class="cc1-paragraph">{{ product.description | strip_html | truncate: 100 }}</div>
        </div>
        <div class="cc1-content_text-right" data-cc1-content="text-right">
          <div class="cc1-title-small">{{ product.vendor | default: shop.name }}</div>
          <div class="cc1-paragraph">{{ product.metafields.custom.short_description | default: product.description | strip_html | truncate: 120 }}</div>
          <div class="cc1-price">{{ product.price | money }}</div>
          <a href="{{ product.url }}" class="cc1-view-product" data-cc1-view-product data-no-swup>
            <span>View Product</span>
            <i class="ph ph-arrow-right"></i>
          </a>
        </div>
        <div class="cc1-image_container" data-cc1-content="image">
          {% if product.featured_image %}
            {{ product.featured_image | image_url: width: 1200 | image_tag:
              loading: 'lazy',
              sizes: '50vw',
              widths: '500, 800, 1080, 1200',
              alt: product.title
            }}
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
</section>

<script>
(function() {
  // Prevent duplicate initialization
  const scrollWrapper = document.querySelector('[data-cc1-scroll="wrapper"]');
  if (!scrollWrapper) return;
  if (scrollWrapper.dataset.cc1Initialized) return;
  scrollWrapper.dataset.cc1Initialized = 'true';

  // Wait for GSAP and dependencies
  function initCreativeCollection() {
    if (typeof gsap === 'undefined' || typeof Flip === 'undefined') {
      // Try to get from window.pieces
      if (window.pieces && window.pieces.gsap) {
        window.gsap = window.pieces.gsap;
      } else {
        setTimeout(initCreativeCollection, 100);
        return;
      }
    }

    // Check if Flip plugin is registered
    if (!gsap.plugins || !gsap.plugins.flip) {
      gsap.registerPlugin(Flip);
    }

    const galleryImagesWrapper = document.querySelectorAll('[data-cc1-gallery="image-wrapper"]');
    const galleryImages = document.querySelectorAll('[data-cc1-gallery="image"]');
    const sectionContent = document.querySelector('[data-cc1-content="section"]');
    const contents = document.querySelectorAll('[data-cc1-content="details"]');
    const contentWrappers = document.querySelectorAll('[data-cc1-content="details-wrapper"]');
    const contentWrapperImages = document.querySelectorAll('[data-cc1-content="details-wrapper"] .cc1-image_container');
    const cursor = document.querySelector('[data-cc1-cursor="container"]');

    let currentOpenIndex = null;
    let isAnimating = false;
    let rafId = null;
    let cursorX = 0;
    let cursorY = 0;
    let targetX = 0;
    let targetY = 0;
    let originalUrl = window.location.href;

    // Initialize
    scrollWrapper.classList.remove('cc1-is-hidden');
    contents.forEach(content => content.classList.add('cc1-is-hidden'));
    contentWrapperImages.forEach(image => image.remove());

    // Scroll-triggered reveal animations for gallery items
    function initScrollAnimations() {
      galleryImagesWrapper.forEach((wrapper, index) => {
        // Set initial state
        gsap.set(wrapper, { opacity: 0, y: 60 });

        // Create scroll trigger for each item
        gsap.to(wrapper, {
          opacity: 1,
          y: 0,
          duration: 0.8,
          ease: 'power2.out',
          scrollTrigger: {
            trigger: wrapper,
            start: 'top 85%',
            toggleActions: 'play none none none'
          }
        });

        // Subtle parallax on images
        const img = wrapper.querySelector('img');
        if (img) {
          gsap.to(img, {
            yPercent: -10,
            ease: 'none',
            scrollTrigger: {
              trigger: wrapper,
              start: 'top bottom',
              end: 'bottom top',
              scrub: 0.5
            }
          });
        }
      });
    }

    // Wait for ScrollTrigger
    if (typeof ScrollTrigger !== 'undefined') {
      initScrollAnimations();
    } else if (window.pieces && window.pieces.ScrollTrigger) {
      gsap.registerPlugin(window.pieces.ScrollTrigger);
      initScrollAnimations();
    }

    // Cursor movement
    function updateCursor() {
      cursorX += (targetX - cursorX) * 0.15;
      cursorY += (targetY - cursorY) * 0.15;
      cursor.style.transform = `translate3d(${cursorX}px, ${cursorY}px, 0)`;
      rafId = requestAnimationFrame(updateCursor);
    }

    function handleMouseMove(e) {
      const cursorBounds = cursor.getBoundingClientRect();
      targetX = e.clientX - (cursorBounds.width * 3) / 4;
      targetY = e.clientY - (cursorBounds.height * 3) / 4;
      if (!rafId) rafId = requestAnimationFrame(updateCursor);
    }

    // Open product detail overlay
    function openContent(index) {
      if (isAnimating) return;
      isAnimating = true;

      contents[index].classList.remove('cc1-is-hidden');
      const currentWrapper = contentWrappers[index];

      // Get product URL for this item
      const productUrl = contents[index].getAttribute('data-product-url');

      // Set initial clipPath state for other images
      const otherImages = Array.from(galleryImagesWrapper).filter((_, i) => i !== index);
      gsap.set(otherImages, { clipPath: 'inset(0% 0 0 0)' });

      // Start with transparent background so clip effect on gallery is visible
      gsap.set(sectionContent, { backgroundColor: 'transparent' });

      const tl = gsap.timeline({
        duration: 1.25,
        ease: 'power4.inOut',
        onStart: () => {
          sectionContent.classList.remove('cc1-is-hidden');
        },
        onComplete: () => {
          isAnimating = false;
          currentOpenIndex = index;
          scrollWrapper.classList.add('cc1-is-hidden');
          cursor.classList.add('is-open');
          // Set background to white after transition
          gsap.set(sectionContent, { backgroundColor: '#fff' });

          // Delay URL update to happen after transition settles
          setTimeout(() => {
            if (productUrl && window.pieces && window.pieces.swup) {
              window.pieces.swup.updateUrl(productUrl);
            } else if (productUrl) {
              window.history.pushState({ swupPreview: true }, '', productUrl);
            }
          }, 200);
        },
      });

      tl.add(() => {
        const flipState = Flip.getState(galleryImages[index]);
        currentWrapper.appendChild(galleryImages[index]);
        Flip.from(flipState, {
          duration: 1.25,
          ease: 'power4.inOut',
        });
      }, 0)
      .to(
        otherImages,
        {
          clipPath: 'inset(100% 0 0 0)',
          duration: 0.75,
          ease: 'power3.inOut',
        },
        0
      )
      // Fade in white background after clip effect completes
      .to(
        sectionContent,
        {
          backgroundColor: '#fff',
          duration: 0.3,
          ease: 'power2.out',
        },
        0.6
      )
      .fromTo(
        contents[index].querySelectorAll('.cc1-title-big'),
        { clipPath: 'inset(0 100% 0 0)', xPercent: 10 },
        { clipPath: 'inset(0 0% 0 0)', xPercent: 0, duration: 0.75, ease: 'power3.out' },
        1.25
      )
      .fromTo(
        contents[index].querySelectorAll('.cc1-paragraph, .cc1-title-small, .cc1-price, .cc1-view-product'),
        { yPercent: 100, opacity: 0 },
        { yPercent: 0, opacity: 1, stagger: 0.05, duration: 0.6 },
        1.2
      );
    }

    // Close product detail overlay
    function hideContent(index) {
      if (isAnimating || currentOpenIndex === null) return;
      isAnimating = true;

      const currentWrapper = contentWrappers[index];
      scrollWrapper.classList.remove('cc1-is-hidden');

      const tl = gsap.timeline({
        duration: 1.25,
        ease: 'power4.inOut',
        onStart: () => {
          // Make section content background transparent so gallery clipPath is visible
          gsap.to(sectionContent, { backgroundColor: 'transparent', duration: 0.3 });
        },
        onComplete: () => {
          isAnimating = false;
          currentOpenIndex = null;
          cursor.classList.remove('is-open');
          sectionContent.classList.add('cc1-is-hidden');
          contents[index].classList.add('cc1-is-hidden');
          // Reset background for next open
          gsap.set(sectionContent, { backgroundColor: '#fff' });

          // Delay URL restore to happen after transition settles
          setTimeout(() => {
            if (window.pieces && window.pieces.swup) {
              window.pieces.swup.updateUrl(originalUrl, true);
            } else {
              window.history.replaceState({}, '', originalUrl);
            }
          }, 200);
        },
      });

      tl.to(
        contents[index].querySelectorAll('.cc1-title-big'),
        { clipPath: 'inset(0 100% 0 0)', xPercent: 10, duration: 0.5, ease: 'power3.in' },
        0
      )
      .to(
        contents[index].querySelectorAll('.cc1-paragraph, .cc1-title-small, .cc1-price, .cc1-view-product'),
        { yPercent: 100, opacity: 0, stagger: 0.02, duration: 0.4 },
        0
      )
      .add(() => {
        const contentWrapperImage = currentWrapper.querySelector('.cc1-image_container');
        if (!contentWrapperImage) return;
        const flipState = Flip.getState(contentWrapperImage);
        galleryImagesWrapper[index].appendChild(contentWrapperImage);
        Flip.from(flipState, {
          duration: 1.25,
          ease: 'power4.inOut',
        });
      }, 0.15)
      .to(
        Array.from(galleryImagesWrapper).filter((_, i) => i !== index),
        { clipPath: 'inset(0% 0 0 0)', duration: 0.75, ease: 'power3.inOut' },
        0.4
      )
      .set(galleryImagesWrapper, { clipPath: 'none' });
    }

    // Navigate to product page with Swup
    function navigateToProduct(url) {
      if (window.pieces && window.pieces.swup && window.pieces.swup.swup) {
        window.pieces.swup.navigateTo(url);
      } else {
        window.location.href = url;
      }
    }

    // Event listeners
    galleryImagesWrapper.forEach((image, index) => {
      image.addEventListener('click', () => {
        if (currentOpenIndex === null) openContent(index);
      });
      image.addEventListener('mouseenter', () => cursor.classList.add('is-visible'));
      image.addEventListener('mouseleave', () => cursor.classList.remove('is-visible'));
    });

    contentWrappers.forEach((content, index) => {
      content.addEventListener('click', (e) => {
        // Don't close if clicking on the view product button
        if (e.target.closest('[data-cc1-view-product]')) return;
        if (currentOpenIndex === index) hideContent(index);
      });
      content.addEventListener('mouseenter', () => cursor.classList.add('is-visible'));
      content.addEventListener('mouseleave', () => cursor.classList.remove('is-visible'));
    });

    // View Product button - navigate with animation
    document.querySelectorAll('[data-cc1-view-product]').forEach((btn, index) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const url = btn.getAttribute('href');

        // Animate out then navigate
        gsap.to(contents[index], {
          opacity: 0,
          scale: 1.05,
          duration: 0.5,
          ease: 'power2.in',
          onComplete: () => navigateToProduct(url)
        });
      });
    });

    window.addEventListener('mousemove', handleMouseMove);

    // Handle browser back button - close overlay instead of navigating
    function handlePopState(e) {
      if (currentOpenIndex !== null && !isAnimating) {
        // User pressed back while overlay is open - close it
        hideContent(currentOpenIndex);
      }
    }
    window.addEventListener('popstate', handlePopState);

    // Cleanup on Swup navigation
    window.addEventListener('swup:contentReplaced', () => {
      if (rafId) cancelAnimationFrame(rafId);
      window.removeEventListener('popstate', handlePopState);
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCreativeCollection);
  } else {
    initCreativeCollection();
  }
})();
</script>

{% schema %}
{
  "name": "Creative Collection 1",
  "tag": "section",
  "class": "creative-collection-1",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 6,
      "label": "Products to show"
    }
  ],
  "presets": [
    {
      "name": "Creative Collection 1",
      "category": "Collection"
    }
  ]
}
{% endschema %}
