{%- comment -%}
  FAQ Section - Accordion style questions and answers
  Reusable across all page types
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture
-%}

<div class="faq-section section-padding{% unless section.settings.padding == 'default' %}-{{ section.settings.padding }}{% endunless %} color-{{ section.settings.color_scheme }}" data-faq-section="{{ section.id }}">
  <div class="{{ container_class }}">
    {%- comment -%} Header {%- endcomment -%}
    <div class="section-header-spacing">
      {% render 'section-header',
        label: section.settings.label,
        title: section.settings.title,
        description: section.settings.description,
        alignment: section.settings.header_alignment,
        description_max_width: 'max-w-2xl',
        group_id: section.id
      %}
    </div>

    {%- comment -%} FAQ Items {%- endcomment -%}
    {% if section.blocks.size > 0 %}
      <div class="faq-list">
        {% for block in section.blocks %}
          {% if block.type == 'faq_item' %}
            <details class="faq-item" data-tween data-tween-type="fade-up" {{ block.shopify_attributes }}>
              <summary class="faq-question">
                <span class="faq-question-text">{{ block.settings.question }}</span>
                <span class="faq-icon">
                  <i class="ph ph-plus"></i>
                </span>
              </summary>
              <div class="faq-answer">
                <div class="faq-answer-inner">
                  <div class="faq-answer-text">
                    {{ block.settings.answer }}
                  </div>
                </div>
              </div>
            </details>
          {% endif %}
        {% endfor %}
      </div>
    {% else %}
      {%- comment -%} Placeholder for theme editor {%- endcomment -%}
      <div class="faq-list">
        {% for i in (1..3) %}
          <details class="faq-item" {% if forloop.first %}open{% endif %}>
            <summary class="faq-question">
              <span class="faq-question-text">What is your return policy?</span>
              <span class="faq-icon">
                <i class="ph ph-plus"></i>
              </span>
            </summary>
            <div class="faq-answer">
              <div class="faq-answer-inner">
                <div class="faq-answer-text">
                  We offer a 30-day return policy on all items. If you're not satisfied with your purchase, simply return it in its original condition for a full refund. Shipping costs for returns are the responsibility of the customer unless the item arrived damaged or defective.
                </div>
              </div>
            </div>
          </details>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<script data-swup-reload-script>
(function() {
  const SECTION_ID = '{{ section.id }}';

  function initFaqSection() {
    const section = document.querySelector('[data-faq-section="' + SECTION_ID + '"]');
    if (!section) return;

    // Skip if already initialized (check on the actual DOM element)
    if (section.dataset.faqInitialized === 'true') return;
    section.dataset.faqInitialized = 'true';

    // Accordion smooth close animation
    // The <details> element closes instantly by default, so we need to
    // intercept the close and wait for the CSS transition to complete
    const faqItems = section.querySelectorAll('.faq-item');
    faqItems.forEach(details => {
      const summary = details.querySelector('summary');
      const answer = details.querySelector('.faq-answer');

      summary.addEventListener('click', (e) => {
        e.preventDefault();

        // If closing (currently open)
        if (details.open && !details.classList.contains('is-closing')) {
          // Add closing class to trigger the transition
          details.classList.add('is-closing');
          // Wait for the transition to complete before actually closing
          answer.addEventListener('transitionend', function handler(event) {
            if (event.propertyName === 'grid-template-rows') {
              details.open = false;
              details.classList.remove('is-closing');
              answer.removeEventListener('transitionend', handler);
            }
          });
        } else if (!details.open) {
          // Opening: set open attribute, CSS will animate from 0fr to 1fr
          // Force a reflow before opening to ensure transition fires
          void answer.offsetHeight;
          details.open = true;
        }
      });
    });

  }

  // Initialize on page load
  initFaqSection();

  // Also listen for Swup content replacement (fallback if script doesn't re-execute)
  // Use a unique handler that checks if section exists before initializing
  window.addEventListener('swup:contentReplaced', function faqSwupHandler() {
    // Re-query the section since DOM was replaced
    const section = document.querySelector('[data-faq-section="' + SECTION_ID + '"]');
    if (section && section.dataset.faqInitialized !== 'true') {
      initFaqSection();
    }
  });
})();
</script>

{%- comment -%} FAQPage Structured Data for SEO {%- endcomment -%}
{%- if section.blocks.size > 0 -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {%- for block in section.blocks -%}
      {%- if block.type == 'faq_item' and block.settings.question != blank and block.settings.answer != blank -%}
    {
      "@type": "Question",
      "name": {{ block.settings.question | json }},
      "acceptedAnswer": {
        "@type": "Answer",
        "text": {{ block.settings.answer | strip_html | json }}
      }
    }{% unless forloop.last %},{% endunless %}
      {%- endif -%}
    {%- endfor -%}
  ]
}
</script>
{%- endif -%}

{% schema %}
{
  "name": "FAQ",
  "tag": "section",
  "class": "faq-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label",
      "default": "Support"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Frequently Asked Questions"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Find answers to common questions about our products and services."
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    },
    {
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "label": "Header alignment",
      "default": "left"
    },
    {
      "type": "select",
      "id": "padding",
      "label": "Section padding",
      "info": "Default padding is set in global theme settings",
      "default": "default",
      "options": [
        { "value": "default", "label": "Default" },
        { "value": "small", "label": "Small" },
        { "value": "large", "label": "Large" },
        { "value": "none", "label": "None" }
      ]
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-2"
    }
  ],
  "blocks": [
    {
      "type": "faq_item",
      "name": "Question",
      "settings": [
        {
          "type": "text",
          "id": "question",
          "label": "Question",
          "default": "What is your return policy?"
        },
        {
          "type": "richtext",
          "id": "answer",
          "label": "Answer",
          "default": "<p>We offer a 30-day return policy on all items. If you're not satisfied with your purchase, simply return it in its original condition for a full refund.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "FAQ",
      "category": "Text & content",
      "blocks": [
        {
          "type": "faq_item",
          "settings": {
            "question": "What is your return policy?",
            "answer": "<p>We offer a 30-day return policy on all items. If you're not satisfied with your purchase, simply return it in its original condition for a full refund.</p>"
          }
        },
        {
          "type": "faq_item",
          "settings": {
            "question": "How long does shipping take?",
            "answer": "<p>Standard shipping typically takes 5-7 business days. Express shipping is available for 2-3 business day delivery. International orders may take 10-14 business days.</p>"
          }
        },
        {
          "type": "faq_item",
          "settings": {
            "question": "Do you offer international shipping?",
            "answer": "<p>Yes, we ship to most countries worldwide. Shipping rates and delivery times vary by location. You can see the exact shipping cost at checkout.</p>"
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
  }
{% endschema %}
