{%- comment -%}
  FAQ Section - Accordion style questions and answers
  Reusable across all page types
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif
-%}

<style>


  .faq-section-{{ section.id }} .faq-item {
    border-bottom: 1px solid var(--color-border);
  }

  .faq-section-{{ section.id }} .faq-item:first-child {
    border-top: 1px solid var(--color-border);
  }

  .faq-section-{{ section.id }} .faq-question {
    padding: 1.5rem 0;
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    transition: opacity 0.3s ease;
  }

  .faq-section-{{ section.id }} .faq-question::-webkit-details-marker {
    display: none;
  }

  .faq-section-{{ section.id }} .faq-question:hover {
    opacity: 0.7;
  }

  .faq-section-{{ section.id }} .faq-question-text {
    font-size: clamp(1rem, 2vw, 1.25rem);
    font-weight: 500;
    line-height: 1.4;
  }

  .faq-section-{{ section.id }} .faq-icon {
    flex-shrink: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-border);
    border-radius: 50%;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
  }

  .faq-section-{{ section.id }} .faq-icon i {
    font-size: 0.875rem;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .faq-section-{{ section.id }} .faq-item[open] .faq-icon {
    background-color: var(--color-text);
    color: var(--color-background);
  }

  .faq-section-{{ section.id }} .faq-item[open] .faq-icon i {
    transform: rotate(45deg);
  }

  /* Smooth slide animation using grid */
  .faq-section-{{ section.id }} .faq-answer {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .faq-section-{{ section.id }} .faq-item[open] .faq-answer {
    grid-template-rows: 1fr;
  }

  /* When closing, animate back to 0fr while still open */
  .faq-section-{{ section.id }} .faq-item.is-closing .faq-answer {
    grid-template-rows: 0fr;
  }

  .faq-section-{{ section.id }} .faq-answer-inner {
    overflow: hidden;
  }

  .faq-section-{{ section.id }} .faq-answer-text {
    font-size: clamp(0.875rem, 1.5vw, 1rem);
    line-height: 1.7;
    opacity: 0.75;
    padding-bottom: 1.5rem;
    padding-right: 3rem;
  }

  /* Title line reveal animation (managed by TweenManager) */
  .tween-split-line:nth-child(2) { margin-left: clamp(0.5rem, 4vw, 2rem); }
</style>

<section class="faq-section-{{ section.id }} section-padding color-{{ section.settings.color_scheme }}" data-faq-section="{{ section.id }}">
  <div class="{{ container_class }}">
    {%- comment -%} Header {%- endcomment -%}
    {% if section.settings.label != blank or section.settings.title != blank or section.settings.description != blank %}
      <div class="section-header-spacing {% if section.settings.header_alignment == 'center' %}text-center{% elsif section.settings.header_alignment == 'right' %}text-right{% endif %}" data-tween-group="faq-header-{{ section.id }}">
        {% if section.settings.label != blank %}
          <span class="section-label" data-tween data-tween-type="fade-up">
            {{ section.settings.label }}
          </span>
        {% endif %}

        {% if section.settings.title != blank %}
          <h2 class="section-title" data-tween data-tween-type="split-text">
            {{ section.settings.title }}
          </h2>
        {% endif %}

        {% if section.settings.description != blank %}
          <p class="section-description max-w-2xl {% if section.settings.header_alignment == 'center' %}mx-auto{% elsif section.settings.header_alignment == 'right' %}ml-auto{% endif %}" data-tween data-tween-type="fade-up">
            {{ section.settings.description }}
          </p>
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} FAQ Items {%- endcomment -%}
    {% if section.blocks.size > 0 %}
      <div class="faq-list">
        {% for block in section.blocks %}
          {% if block.type == 'faq_item' %}
            <details class="faq-item" data-tween data-tween-type="fade-up" {{ block.shopify_attributes }}>
              <summary class="faq-question">
                <span class="faq-question-text">{{ block.settings.question }}</span>
                <span class="faq-icon">
                  <i class="ph ph-plus"></i>
                </span>
              </summary>
              <div class="faq-answer">
                <div class="faq-answer-inner">
                  <div class="faq-answer-text">
                    {{ block.settings.answer }}
                  </div>
                </div>
              </div>
            </details>
          {% endif %}
        {% endfor %}
      </div>
    {% else %}
      {%- comment -%} Placeholder for theme editor {%- endcomment -%}
      <div class="faq-list">
        {% for i in (1..3) %}
          <details class="faq-item" {% if forloop.first %}open{% endif %}>
            <summary class="faq-question">
              <span class="faq-question-text">What is your return policy?</span>
              <span class="faq-icon">
                <i class="ph ph-plus"></i>
              </span>
            </summary>
            <div class="faq-answer">
              <div class="faq-answer-inner">
                <div class="faq-answer-text">
                  We offer a 30-day return policy on all items. If you're not satisfied with your purchase, simply return it in its original condition for a full refund. Shipping costs for returns are the responsibility of the customer unless the item arrived damaged or defective.
                </div>
              </div>
            </div>
          </details>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</section>

<script data-swup-reload-script>
(function() {
  const SECTION_ID = '{{ section.id }}';

  function initFaqSection() {
    const section = document.querySelector('[data-faq-section="' + SECTION_ID + '"]');
    if (!section) return;

    // Skip if already initialized (check on the actual DOM element)
    if (section.dataset.faqInitialized === 'true') return;
    section.dataset.faqInitialized = 'true';

    // Accordion smooth close animation
    // The <details> element closes instantly by default, so we need to
    // intercept the close and wait for the CSS transition to complete
    const faqItems = section.querySelectorAll('.faq-item');
    faqItems.forEach(details => {
      const summary = details.querySelector('summary');
      const answer = details.querySelector('.faq-answer');

      summary.addEventListener('click', (e) => {
        e.preventDefault();

        // If closing (currently open)
        if (details.open && !details.classList.contains('is-closing')) {
          // Add closing class to trigger the transition
          details.classList.add('is-closing');
          // Wait for the transition to complete before actually closing
          answer.addEventListener('transitionend', function handler(event) {
            if (event.propertyName === 'grid-template-rows') {
              details.open = false;
              details.classList.remove('is-closing');
              answer.removeEventListener('transitionend', handler);
            }
          });
        } else if (!details.open) {
          // Opening: set open attribute, CSS will animate from 0fr to 1fr
          // Force a reflow before opening to ensure transition fires
          void answer.offsetHeight;
          details.open = true;
        }
      });
    });

  }

  // Initialize on page load
  initFaqSection();

  // Also listen for Swup content replacement (fallback if script doesn't re-execute)
  // Use a unique handler that checks if section exists before initializing
  window.addEventListener('swup:contentReplaced', function faqSwupHandler() {
    // Re-query the section since DOM was replaced
    const section = document.querySelector('[data-faq-section="' + SECTION_ID + '"]');
    if (section && section.dataset.faqInitialized !== 'true') {
      initFaqSection();
    }
  });
})();
</script>

{%- comment -%} FAQPage Structured Data for SEO {%- endcomment -%}
{%- if section.blocks.size > 0 -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {%- for block in section.blocks -%}
      {%- if block.type == 'faq_item' and block.settings.question != blank and block.settings.answer != blank -%}
    {
      "@type": "Question",
      "name": {{ block.settings.question | json }},
      "acceptedAnswer": {
        "@type": "Answer",
        "text": {{ block.settings.answer | strip_html | json }}
      }
    }{% unless forloop.last %},{% endunless %}
      {%- endif -%}
    {%- endfor -%}
  ]
}
</script>
{%- endif -%}

{% schema %}
{
  "name": "FAQ",
  "tag": "section",
  "class": "faq-section",
  "settings": [
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label",
      "default": "Support"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Frequently Asked Questions"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Find answers to common questions about our products and services."
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "default": "left",
      "label": "Header alignment"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-2"
    }
  ],
  "blocks": [
    {
      "type": "faq_item",
      "name": "Question",
      "settings": [
        {
          "type": "text",
          "id": "question",
          "label": "Question",
          "default": "What is your return policy?"
        },
        {
          "type": "richtext",
          "id": "answer",
          "label": "Answer",
          "default": "<p>We offer a 30-day return policy on all items. If you're not satisfied with your purchase, simply return it in its original condition for a full refund.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "FAQ",
      "category": "Text & content",
      "blocks": [
        {
          "type": "faq_item",
          "settings": {
            "question": "What is your return policy?",
            "answer": "<p>We offer a 30-day return policy on all items. If you're not satisfied with your purchase, simply return it in its original condition for a full refund.</p>"
          }
        },
        {
          "type": "faq_item",
          "settings": {
            "question": "How long does shipping take?",
            "answer": "<p>Standard shipping typically takes 5-7 business days. Express shipping is available for 2-3 business day delivery. International orders may take 10-14 business days.</p>"
          }
        },
        {
          "type": "faq_item",
          "settings": {
            "question": "Do you offer international shipping?",
            "answer": "<p>Yes, we ship to most countries worldwide. Shipping rates and delivery times vary by location. You can see the exact shipping cost at checkout.</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}
