{%- comment -%}
  Scroll Panels Section
  Inspired by tympanus.net/Development/ScrollPanels
  Panels stack and reveal as you scroll with pinned effect
{%- endcomment -%}

{%- liquid
  assign panel_count = section.blocks.size
  if panel_count == 0
    assign panel_count = 1
  endif
-%}

<style>
  .scroll-panels-{{ section.id }} {
    position: relative;
    background-color: var(--color-background);
    color: var(--color-text);
  }

  .scroll-panels-wrapper-{{ section.id }} {
    position: relative;
    height: {{ panel_count | times: 100 }}vh;
  }

  .scroll-panels-sticky-{{ section.id }} {
    position: sticky;
    top: 0;
    height: 100vh;
    overflow: hidden;
  }

  .scroll-panel-{{ section.id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: {% if section.settings.content_alignment == 'left' %}flex-start{% elsif section.settings.content_alignment == 'right' %}flex-end{% else %}center{% endif %};
    will-change: transform, opacity;
    padding: 0 var(--page-padding, 2rem);
  }

  .scroll-panel-bg-{{ section.id }} {
    position: absolute;
    inset: 0;
    overflow: hidden;
  }

  .scroll-panel-bg-{{ section.id }} img {
    position: relative;
    z-index: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scale(1.1);
    transition: transform 0.1s linear;
  }

  .scroll-panel-overlay-{{ section.id }} {
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    {%- assign overlay_alpha = section.settings.overlay_opacity | divided_by: 100.0 -%}
    {%- assign overlay_alpha_half = overlay_alpha | divided_by: 2.0 -%}
    background: linear-gradient(
      to bottom,
      {{ section.settings.overlay_color | color_modify: 'alpha', overlay_alpha }} 0%,
      {{ section.settings.overlay_color | color_modify: 'alpha', overlay_alpha_half }} 100%
    );
  }

  .scroll-panel-content-{{ section.id }} {
    position: relative;
    z-index: 2;
    text-align: {{ section.settings.content_alignment }};
    padding: clamp(2rem, 5vw, 4rem);
    max-width: 900px;
    {% if section.settings.content_alignment == 'left' %}
    margin-right: auto;
    margin-left: 0;
    {% elsif section.settings.content_alignment == 'right' %}
    margin-left: auto;
    margin-right: 0;
    {% endif %}
  }

  .scroll-panel-number-{{ section.id }} {
    font-size: 0.875rem;
    font-weight: 600;
    letter-spacing: 0.3em;
    {% if settings.headings_uppercase %}text-transform: uppercase;{% endif %}
    opacity: 0.6;
    margin-bottom: 1.5rem;
  }

  .scroll-panel-title-{{ section.id }} {
    font-size: calc(clamp(2.5rem, 8vw, 5rem) * var(--heading-font-scale, 1));
    font-weight: var(--font-heading-weight, 700);
    letter-spacing: calc(-0.03em + var(--heading-letter-spacing, 0em));
    line-height: 1;
    margin-bottom: 1.5rem;
  }

  .scroll-panel-text-{{ section.id }} {
    font-size: clamp(1rem, 2vw, 1.25rem);
    line-height: 1.6;
    opacity: 0.8;
    max-width: 600px;
    margin: 0 {% if section.settings.content_alignment == 'center' %}auto{% elsif section.settings.content_alignment == 'right' %}0 0 auto{% else %}0{% endif %} 2rem;
  }

  .scroll-panel-button-{{ section.id }} .btn--secondary {
    color: var(--color-text);
    border-color: var(--color-text);
  }
  .scroll-panel-button-{{ section.id }} .btn--secondary::before {
    background: var(--color-text);
  }
  .scroll-panel-button-{{ section.id }} .btn--secondary:hover,
  .scroll-panel-button-{{ section.id }} .btn--secondary:hover span,
  .scroll-panel-button-{{ section.id }} .btn--secondary:hover i {
    color: var(--color-background);
  }
  .scroll-panel-button-{{ section.id }} .btn--solid-secondary {
    background: var(--color-text);
    border-color: var(--color-text);
    color: var(--color-background);
  }
  .scroll-panel-button-{{ section.id }} .btn--solid-secondary::before {
    background: var(--color-background);
  }
  .scroll-panel-button-{{ section.id }} .btn--solid-secondary:hover,
  .scroll-panel-button-{{ section.id }} .btn--solid-secondary:hover span,
  .scroll-panel-button-{{ section.id }} .btn--solid-secondary:hover i {
    color: var(--color-text);
  }

  /* Placeholder styling */
  .scroll-panel-placeholder-{{ section.id }} {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
  }

  .scroll-panel-placeholder-{{ section.id }} i {
    font-size: 5rem;
    opacity: 0.15;
    color: var(--color-text);
  }

  /* Progress indicator */
  .scroll-panels-progress-{{ section.id }} {
    position: fixed;
    right: 2rem;
    top: 50%;
    transform: translateY(-50%);
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .scroll-panels-progress-{{ section.id }}.is-visible {
    opacity: 1;
    pointer-events: auto;
  }

  .scroll-panels-progress-dot-{{ section.id }} {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--color-text);
    opacity: 0.3;
    transition: opacity 0.3s ease, transform 0.3s ease;
    cursor: pointer;
  }

  .scroll-panels-progress-dot-{{ section.id }}:hover {
    opacity: 0.6;
  }

  .scroll-panels-progress-dot-{{ section.id }}.is-active {
    opacity: 1;
    transform: scale(1.25);
  }

  /* Animation styles */
  .scroll-panel-{{ section.id }}[data-panel-state="below"] {
    opacity: 0;
    transform: translateY(100%);
  }

  .scroll-panel-{{ section.id }}[data-panel-state="active"] {
    opacity: 1;
    transform: translateY(0);
  }

  .scroll-panel-{{ section.id }}[data-panel-state="above"] {
    opacity: 0;
    transform: translateY(-30%);
  }

  /* Note: This section requires scroll animation to function - no reduced motion fallback */
</style>

<section class="scroll-panels-{{ section.id }} color-{{ section.settings.color_scheme }}" data-scroll-panels="{{ section.id }}">
  <div class="scroll-panels-wrapper-{{ section.id }}" data-panels-wrapper>
    <div class="scroll-panels-sticky-{{ section.id }}" data-panels-sticky>
      {% for block in section.blocks %}
        <div
          class="scroll-panel-{{ section.id }}"
          data-panel="{{ forloop.index0 }}"
          data-panel-state="{% if forloop.first %}active{% else %}below{% endif %}"
          {{ block.shopify_attributes }}
        >
          <div class="scroll-panel-bg-{{ section.id }}">
            {% if block.settings.image != blank %}
              {{ block.settings.image | image_url: width: 2000 | image_tag:
                loading: 'eager',
                fetchpriority: 'high',
                decoding: 'async',
                class: 'scroll-panel-img',
                sizes: '100vw',
                alt: block.settings.image.alt | default: block.settings.title | default: section.settings.heading
              }}
            {% else %}
              <div class="scroll-panel-placeholder-{{ section.id }}">
                <i class="ph ph-image"></i>
              </div>
            {% endif %}
            <div class="scroll-panel-overlay-{{ section.id }}"></div>
          </div>

          <div class="scroll-panel-content-{{ section.id }}">
            {% if section.settings.show_numbers %}
              <div class="scroll-panel-number-{{ section.id }}">
                {{ forloop.index | prepend: '0' }} / {{ panel_count | prepend: '0' }}
              </div>
            {% endif %}

            {% if block.settings.title != blank %}
              <h2 class="scroll-panel-title-{{ section.id }} font-heading">
                {{ block.settings.title }}
              </h2>
            {% endif %}

            {% if block.settings.text != blank %}
              <p class="scroll-panel-text-{{ section.id }}">
                {{ block.settings.text }}
              </p>
            {% endif %}

            {% if block.settings.button_text != blank and block.settings.button_link != blank %}
              {%- liquid
                if block.settings.button_style == 'outline'
                  if block.settings.button_color == 'secondary'
                    assign btn_class = 'btn--secondary'
                  else
                    assign btn_class = 'btn--outline'
                  endif
                else
                  if block.settings.button_color == 'secondary'
                    assign btn_class = 'btn--solid-secondary'
                  else
                    assign btn_class = 'btn--primary'
                  endif
                endif
              -%}
              <div class="scroll-panel-button-{{ section.id }}">
                <a href="{{ block.settings.button_link }}" class="btn {{ btn_class }}{% if block.settings.button_size == 'small' %} btn--sm{% elsif block.settings.button_size == 'large' %} btn--lg{% endif %}">
                  <span>{{ block.settings.button_text }}</span>
                  <i class="ph ph-arrow-right"></i>
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  {% if section.settings.show_progress and section.blocks.size > 1 %}
    <div class="scroll-panels-progress-{{ section.id }}" data-panels-progress>
      {% for block in section.blocks %}
        <button
          class="scroll-panels-progress-dot-{{ section.id }}{% if forloop.first %} is-active{% endif %}"
          data-progress-dot="{{ forloop.index0 }}"
          aria-label="{{ 'accessibility.go_to_panel' | t: index: forloop.index }}"
        ></button>
      {% endfor %}
    </div>
  {% endif %}
</section>

<script>
(function() {
  const section = document.querySelector('[data-scroll-panels="{{ section.id }}"]');
  if (!section || section.dataset.scrollPanelsInitialized) return;
  section.dataset.scrollPanelsInitialized = 'true';

  const wrapper = section.querySelector('[data-panels-wrapper]');
  const sticky = section.querySelector('[data-panels-sticky]');
  const panels = section.querySelectorAll('[data-panel]');
  const progress = section.querySelector('[data-panels-progress]');
  const progressDots = section.querySelectorAll('[data-progress-dot]');
  const panelCount = panels.length;

  if (panelCount === 0) return;

  let currentPanel = 0;
  let isInView = false;

  function updatePanels(scrollProgress) {
    // scrollProgress: 0 = start, 1 = end
    const panelProgress = scrollProgress * panelCount;
    const newCurrentPanel = Math.min(Math.floor(panelProgress), panelCount - 1);

    panels.forEach((panel, index) => {
      const panelStart = index / panelCount;
      const panelEnd = (index + 1) / panelCount;
      const withinPanel = scrollProgress >= panelStart && scrollProgress < panelEnd;

      let state = 'below';
      if (index < newCurrentPanel) {
        state = 'above';
      } else if (index === newCurrentPanel) {
        state = 'active';
      }

      panel.dataset.panelState = state;

      // Parallax effect on background image
      if (state === 'active') {
        const localProgress = (scrollProgress - panelStart) / (panelEnd - panelStart);
        const img = panel.querySelector('.scroll-panel-img');
        if (img) {
          const scale = 1.1 - (localProgress * 0.1);
          img.style.transform = `scale(${scale})`;
        }
      }
    });

    // Update progress dots
    if (newCurrentPanel !== currentPanel) {
      currentPanel = newCurrentPanel;
      progressDots.forEach((dot, index) => {
        dot.classList.toggle('is-active', index === currentPanel);
      });
    }
  }

  function handleScroll() {
    const rect = wrapper.getBoundingClientRect();
    const wrapperHeight = wrapper.offsetHeight;
    const viewportHeight = window.innerHeight;

    // Calculate scroll progress through the section
    const scrolled = -rect.top;
    const scrollableDistance = wrapperHeight - viewportHeight;
    const scrollProgress = Math.max(0, Math.min(1, scrolled / scrollableDistance));

    // Check if section is actively being scrolled through (sticky container is pinned)
    // Only show progress when the section is in the "active scroll" zone
    const sectionIsActive = rect.top <= 0 && rect.bottom >= viewportHeight;

    if (sectionIsActive !== isInView) {
      isInView = sectionIsActive;
      if (progress) {
        progress.classList.toggle('is-visible', isInView);
      }
    }

    // Update panels whenever section is at least partially visible
    if (rect.top < viewportHeight && rect.bottom > 0) {
      updatePanels(scrollProgress);
    }
  }

  // Progress dot click handlers
  progressDots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      const wrapperRect = wrapper.getBoundingClientRect();
      const wrapperTop = window.scrollY + wrapperRect.top;
      const wrapperHeight = wrapper.offsetHeight;
      const viewportHeight = window.innerHeight;
      const scrollableDistance = wrapperHeight - viewportHeight;

      // Target the middle of the panel's scroll range for reliable detection
      const targetProgress = (index + 0.5) / panelCount;
      const targetScroll = wrapperTop + (targetProgress * scrollableDistance);

      // Immediately update active dot for responsive feel
      progressDots.forEach((d, i) => {
        d.classList.toggle('is-active', i === index);
      });
      currentPanel = index;

      if (window.pieces && window.pieces.lenis) {
        window.pieces.lenis.scrollTo(targetScroll, { duration: 1 });
      } else {
        window.scrollTo({ top: targetScroll, behavior: 'smooth' });
      }
    });
  });

  // Use native scroll with RAF for performance
  let ticking = false;
  function onScroll() {
    if (!ticking) {
      requestAnimationFrame(() => {
        handleScroll();
        ticking = false;
      });
      ticking = true;
    }
  }

  window.addEventListener('scroll', onScroll, { passive: true });
  handleScroll(); // Initial call

  // Cleanup on Swup navigation
  window.addEventListener('swup:willReplaceContent', function cleanup() {
    window.removeEventListener('scroll', onScroll);
    window.removeEventListener('swup:willReplaceContent', cleanup);
  });
})();
</script>

{% schema %}
{
  "name": "Scroll Panels",
  "tag": "section",
  "class": "scroll-panels-section",
  "settings": [
    {
      "type": "header",
      "content": "Display"
    },
    {
      "type": "checkbox",
      "id": "show_numbers",
      "default": true,
      "label": "Show panel numbers"
    },
    {
      "type": "text_alignment",
      "id": "content_alignment",
      "default": "center",
      "label": "Content alignment"
    },
    {
      "type": "checkbox",
      "id": "show_progress",
      "default": true,
      "label": "Show progress indicator"
    },
    {
      "type": "header",
      "content": "Overlay"
    },
    {
      "type": "color",
      "id": "overlay_color",
      "default": "#000000",
      "label": "Overlay color"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 40,
      "unit": "%",
      "label": "Overlay opacity"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-3"
    }
  ],
  "blocks": [
    {
      "type": "panel",
      "name": "Panel",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Background image"
        },
        {
          "type": "text",
          "id": "title",
          "default": "Panel Title",
          "label": "Title"
        },
        {
          "type": "textarea",
          "id": "text",
          "default": "Add compelling copy that tells your brand story.",
          "label": "Text"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button text"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Button link"
        },
        {
          "type": "select",
          "id": "button_style",
          "label": "Button style",
          "default": "outline",
          "options": [
            { "value": "solid", "label": "Solid" },
            { "value": "outline", "label": "Outline" }
          ]
        },
        {
          "type": "select",
          "id": "button_color",
          "label": "Button color",
          "default": "primary",
          "options": [
            { "value": "primary", "label": "Primary (accent)" },
            { "value": "secondary", "label": "Secondary (neutral)" }
          ]
        },
        {
          "type": "select",
          "id": "button_size",
          "label": "Button size",
          "default": "default",
          "options": [
            { "value": "small", "label": "Small" },
            { "value": "default", "label": "Default" },
            { "value": "large", "label": "Large" }
          ]
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Scroll Panels",
      "category": "Scrolling & animation",
      "blocks": [
        {
          "type": "panel",
          "settings": {
            "title": "Discover Our Story",
            "text": "Every great brand has a story. This is where yours begins.",
            "button_text": "Learn More"
          }
        },
        {
          "type": "panel",
          "settings": {
            "title": "Crafted With Care",
            "text": "We believe in quality over quantity. Each product is made to last.",
            "button_text": "Our Process"
          }
        },
        {
          "type": "panel",
          "settings": {
            "title": "Join the Movement",
            "text": "Be part of something bigger. Shop consciously, live intentionally.",
            "button_text": "Shop Now"
          }
        }
      ]
    }
  ]
}
{% endschema %}
