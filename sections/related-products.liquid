{%- comment -%}
  Related Products Section - Carousel with GSAP animations
  Uses Shopify Product Recommendations API
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif
-%}

<style>
  .related-products-{{ section.id }} {
    --section-bg: {{ section.settings.background_color }};
    --section-text: {{ section.settings.text_color }};
    background-color: var(--section-bg);
    color: var(--section-text);
  }
  .related-products-{{ section.id }} .nav-btn:hover:not(:disabled) {
    background-color: var(--section-text);
    color: var(--section-bg);
    border-color: var(--section-text);
  }
  .related-products-{{ section.id }} .skeleton-bg {
    background-color: var(--section-text);
    opacity: 0.1;
  }
  /* Title line reveal animation */
  .related-products-title-line:nth-child(2) { margin-left: clamp(0.5rem, 4vw, 2rem); }
  /* Hide title initially to prevent FOUC before SplitText animation */
  [data-related-products-title] { opacity: 0; }
  html.animations-disabled [data-related-products-title] { opacity: 1; }
</style>

<section
  class="related-products-{{ section.id }} py-[--section-vertical-padding] overflow-hidden"
  data-related-products
  data-section-id="{{ section.id }}"
  data-product-id="{{ product.id }}"
  data-url="{{ routes.product_recommendations_url }}?limit={{ section.settings.products_to_show }}"
>
  <div class="{{ container_class }}">
    {%- comment -%} Header {%- endcomment -%}
    <div class="{% if section.settings.header_alignment == 'center' %}text-center{% elsif section.settings.header_alignment == 'right' %}text-right{% else %}flex items-end justify-between gap-6{% endif %} mb-12 lg:mb-16">
      <div>
        {% if section.settings.label != blank %}
          <span class="inline-block text-[0.65rem] font-semibold uppercase tracking-[0.2em] opacity-60 mb-4">
            {{ section.settings.label }}
          </span>
        {% endif %}

        {% if section.settings.title != blank %}
          <h2 class="text-3xl md:text-4xl lg:text-5xl font-bold font-heading tracking-tight leading-none" data-related-products-title>
            {{ section.settings.title }}
          </h2>
        {% endif %}
      </div>

      {%- comment -%} Navigation {%- endcomment -%}
      <div class="flex items-center gap-3 {% if section.settings.header_alignment == 'center' %}justify-center mt-6{% elsif section.settings.header_alignment == 'right' %}justify-end mt-6{% endif %}" data-carousel-nav>
        <button
          type="button"
          class="nav-btn w-12 h-12 flex items-center justify-center border border-current/30 rounded-full bg-transparent cursor-pointer transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed"
          data-carousel-prev
          aria-label="{{ 'accessibility.previous_products' | t }}"
          disabled
        >
          <i class="ph ph-arrow-left text-xl"></i>
        </button>
        <button
          type="button"
          class="nav-btn w-12 h-12 flex items-center justify-center border border-current/30 rounded-full bg-transparent cursor-pointer transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed"
          data-carousel-next
          aria-label="{{ 'accessibility.next_products' | t }}"
        >
          <i class="ph ph-arrow-right text-xl"></i>
        </button>
      </div>
    </div>

    {%- comment -%} Carousel Container {%- endcomment -%}
    <div class="relative">
      <div class="overflow-hidden" data-carousel-viewport>
        {%- comment -%} Loading State {%- endcomment -%}
        <div class="flex gap-6" data-carousel-loading>
          {% for i in (1..4) %}
            <div class="shrink-0 w-[calc(100%-2rem)] sm:w-[calc(50%-0.75rem)] lg:w-[calc(33.333%-1rem)] xl:w-[calc(25%-1.125rem)] animate-pulse">
              <div class="aspect-[3/4] rounded-lg skeleton-bg"></div>
              <div class="h-4 mt-4 rounded skeleton-bg w-3/4"></div>
              <div class="h-3.5 mt-2 rounded skeleton-bg w-2/5"></div>
            </div>
          {% endfor %}
        </div>

        {%- comment -%} Products will be loaded here via JS {%- endcomment -%}
        <div class="flex gap-6 p-1.5 transition-transform duration-500 ease-out items-stretch" data-carousel-track style="display: none;">
          {% if recommendations.performed and recommendations.products_count > 0 %}
            {% for recommendation in recommendations.products %}
              <div class="shrink-0 w-[calc(100%-2rem)] sm:w-[calc(50%-0.75rem)] lg:w-[calc(33.333%-1rem)] xl:w-[calc(25%-1.125rem)] min-w-0 flex [&_.product-card]:flex [&_.product-card]:flex-col [&_.product-card]:w-full [&_.product-card-content]:flex-1 [&_.product-card-content]:flex [&_.product-card-content]:flex-col [&_.product-card-image_img]:transition-transform [&_.product-card-image_img]:duration-500 [&:hover_.product-card-image_img]:scale-105 [&_.product-card-title]:transition-opacity [&_.product-card-title]:duration-300 [&:hover_.product-card-title]:opacity-70">
                {% render 'product-card',
                  product: recommendation,
                  index: forloop.index0,
                  show_vendor: section.settings.show_vendor,
                  show_quick_add: false,
                  lazy_load: true
                %}
              </div>
            {% endfor %}
          {% endif %}
        </div>
      </div>

      {%- comment -%} Progress Bar {%- endcomment -%}
      <div class="h-0.5 bg-current/15 rounded-sm overflow-hidden mt-8" data-carousel-progress>
        <div class="h-full bg-current transition-[width] duration-400 ease-out" data-carousel-progress-bar style="width: 0%"></div>
      </div>
    </div>
  </div>
</section>

<script>
  (function() {
    const section = document.querySelector('[data-related-products][data-section-id="{{ section.id }}"]');
    if (!section) return;

    const productId = section.dataset.productId;
    const baseUrl = section.dataset.url;
    const sectionId = section.dataset.sectionId;

    const track = section.querySelector('[data-carousel-track]');
    const loading = section.querySelector('[data-carousel-loading]');
    const prevBtn = section.querySelector('[data-carousel-prev]');
    const nextBtn = section.querySelector('[data-carousel-next]');
    const progressBar = section.querySelector('[data-carousel-progress-bar]');
    const nav = section.querySelector('[data-carousel-nav]');

    let currentIndex = 0;
    let slidesPerView = 4;
    let totalSlides = 0;

    function updateSlidesPerView() {
      const width = window.innerWidth;
      if (width < 640) slidesPerView = 1;
      else if (width < 1024) slidesPerView = 2;
      else if (width < 1280) slidesPerView = 3;
      else slidesPerView = 4;
    }

    function updateCarousel() {
      if (totalSlides === 0) return;

      const maxIndex = Math.max(0, totalSlides - slidesPerView);
      currentIndex = Math.min(currentIndex, maxIndex);

      const slideWidth = track.children[0]?.offsetWidth || 0;
      const gap = 24; // 1.5rem
      const offset = currentIndex * (slideWidth + gap);

      track.style.transform = `translateX(-${offset}px)`;

      // Update buttons
      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex >= maxIndex;

      // Update progress
      const progress = maxIndex > 0 ? ((currentIndex + slidesPerView) / totalSlides) * 100 : 100;
      progressBar.style.width = `${Math.min(100, progress)}%`;
    }

    function loadRecommendations() {
      const url = `${baseUrl}&product_id=${productId}&section_id=${sectionId}`;

      fetch(url)
        .then(response => response.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newTrack = doc.querySelector('[data-carousel-track]');

          if (newTrack && newTrack.children.length > 0) {
            track.innerHTML = newTrack.innerHTML;
            totalSlides = track.children.length;

            loading.style.display = 'none';
            track.style.display = 'flex';

            // Fix: Make dynamically loaded [data-intro] elements visible immediately
            track.querySelectorAll('[data-intro]').forEach(el => {
              el.classList.add('intro-visible');
            });

            updateSlidesPerView();
            updateCarousel();

            // Hide nav if not enough slides
            if (totalSlides <= slidesPerView) {
              nav.style.display = 'none';
            }
          } else {
            // No recommendations, hide the entire section
            section.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error loading recommendations:', error);
          section.style.display = 'none';
        });
    }

    // Event listeners
    prevBtn.addEventListener('click', () => {
      currentIndex = Math.max(0, currentIndex - 1);
      updateCarousel();
    });

    nextBtn.addEventListener('click', () => {
      const maxIndex = Math.max(0, totalSlides - slidesPerView);
      currentIndex = Math.min(maxIndex, currentIndex + 1);
      updateCarousel();
    });

    // Touch/swipe support
    let touchStartX = 0;
    let touchEndX = 0;

    track.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    track.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          // Swipe left - next
          nextBtn.click();
        } else {
          // Swipe right - prev
          prevBtn.click();
        }
      }
    }, { passive: true });

    // Resize handler
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        updateSlidesPerView();
        updateCarousel();

        // Update nav visibility
        if (totalSlides <= slidesPerView) {
          nav.style.display = 'none';
        } else {
          nav.style.display = 'flex';
        }
      }, 100);
    });

    // Initialize with Intersection Observer for lazy loading
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          loadRecommendations();
          observer.unobserve(section);
        }
      });
    }, { rootMargin: '200px' });

    observer.observe(section);
  })();

  // Title split text animation
  (function() {
    const section = document.querySelector('[data-related-products][data-section-id="{{ section.id }}"]');
    if (!section || section.dataset.titleAnimInitialized) return;
    section.dataset.titleAnimInitialized = 'true';

    // If animations disabled, skip
    if (typeof window.shouldAnimate === 'function' && !window.shouldAnimate()) return;

    function initTitleAnimation() {
      let gsap = window.gsap;
      if (!gsap && window.pieces && window.pieces.gsap) {
        gsap = window.pieces.gsap;
      }

      let SplitText = window.SplitText;
      if (!SplitText && window.pieces && window.pieces.SplitText) {
        SplitText = window.pieces.SplitText;
      }

      const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

      if (!gsap || !SplitText || !ScrollTrigger) {
        setTimeout(initTitleAnimation, 50);
        return;
      }

      const title = section.querySelector('[data-related-products-title]');
      if (!title) return;

      const scrollStart = window.getScrollStart ? window.getScrollStart('top 70%') : 'top 70%';
      const split = new SplitText(title, { type: 'lines', linesClass: 'related-products-title-line' });

      split.lines.forEach(line => {
        const lineWrapper = document.createElement('div');
        lineWrapper.style.overflow = 'hidden';
        lineWrapper.style.display = 'block';
        line.parentNode.insertBefore(lineWrapper, line);
        lineWrapper.appendChild(line);
      });

      gsap.set(split.lines, { yPercent: 120 });
      title.style.opacity = 1;

      gsap.to(split.lines, {
        yPercent: 0,
        duration: 1.2,
        ease: 'power4.out',
        stagger: 0.1,
        scrollTrigger: {
          trigger: section,
          start: scrollStart,
          once: true
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTitleAnimation);
    } else {
      requestAnimationFrame(initTitleAnimation);
    }

    if (window.onSwupContentReplaced) {
      window.onSwupContentReplaced('related_products_animation', () => {
        requestAnimationFrame(initTitleAnimation);
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Related Products",
  "tag": "section",
  "class": "related-products-section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Dynamic recommendations are based on the current product. To preview, view this section on a product page."
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label",
      "default": "You may also like"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Related Products"
    },
    {
      "type": "select",
      "id": "header_alignment",
      "label": "Header alignment",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 4,
      "max": 12,
      "step": 1,
      "default": 8,
      "label": "Products to show"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": false
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#000000"
    }
  ],
  "presets": [
    {
      "name": "Related Products",
      "category": "Products"
    }
  ],
  "enabled_on": {
    "templates": ["product"]
  }
}
{% endschema %}
