{%- comment -%}
  Background Zoom Section
  Image to Background zoom effect using GSAP Flip + ScrollTrigger

  Settings:
  - image: Main image for the zoom effect
  - title_before: Heading text before zoom
  - title_after: Heading text after zoom (scrolled content)
  - overlay_text: Text overlay on the image
  - color_scheme: Color scheme for background, text, and accent colors
{%- endcomment -%}

<style>
  #background-zoom-{{ section.id }} {
    --background-zoom-content-bg: {{ section.settings.content_bg_color | default: 'var(--color-background-secondary)' }};
    --background-zoom-overlay-text-color: {{ section.settings.overlay_text_color | default: 'var(--color-primary)' }};
    --background-zoom-dark-color: {{ section.settings.dark_overlay_color | default: 'rgba(0, 0, 0, 0.75)' }};
  }
</style>

<div
  id="background-zoom-{{ section.id }}"
  class="background-zoom color-{{ section.settings.color_scheme }}"
  data-bg-zoom-init
  data-section-id="{{ section.id }}">
  {%- comment -%} Title Before Zoom {%- endcomment -%}
  {% if section.settings.title_before != blank %}
    <div class="background-zoom__title">
      <h1 class="background-zoom__heading">
        {{ section.settings.title_before }}
        {% if section.settings.title_before_accent != blank %}
          <span class="background-zoom__heading-accent">{{ section.settings.title_before_accent }}</span>
        {% endif %}
      </h1>
    </div>
  {% endif %}

  {%- comment -%} Start Element - Initial circular state {%- endcomment -%}
  <div data-bg-zoom-start class="background-zoom__start">
    {%- comment -%} Content Element - This gets animated by Flip {%- endcomment -%}
    <div data-bg-zoom-content class="background-zoom__content">
      {%- comment -%} Image {%- endcomment -%}
      {% if section.settings.image != blank %}
        <img
          data-bg-zoom-img
          src="{{ section.settings.image | image_url: width: 1920 }}"
          alt="{{ section.settings.image.alt | default: section.settings.title_before }}"
          width="{{ section.settings.image.width }}"
          height="{{ section.settings.image.height }}"
          loading="eager"
          fetchpriority="high"
          class="background-zoom__img">
      {% else %}
        {{ 'lifestyle-1' | placeholder_svg_tag: 'background-zoom__img' }}
      {% endif %}

      {%- comment -%} Overlay Text {%- endcomment -%}
      {% if section.settings.overlay_text != blank %}
        <p class="background-zoom__overlay-text">{{ section.settings.overlay_text }}</p>
      {% endif %}

      {%- comment -%} Dark Overlay - fades in after zoom {%- endcomment -%}
      <div data-bg-zoom-dark class="background-zoom__dark"></div>
    </div>
  </div>

  {%- comment -%} End Element - Final full-viewport state {%- endcomment -%}
  <div data-bg-zoom-end class="background-zoom__end"></div>

  {%- comment -%} Text Content After Zoom {%- endcomment -%}
  <div class="background-zoom__text">
    {% for block in section.blocks %}
      {% case block.type %}
        {% when 'heading' %}
          <h2 class="background-zoom__heading{% if block.settings.add_margin_top %} is-margin-top{% endif %}" {{ block.shopify_attributes }}>
            {{ block.settings.text }}
            {% if block.settings.accent_text != blank %}
              <br><span class="background-zoom__heading-accent">{{ block.settings.accent_text }}</span>
            {% endif %}
          </h2>
        {% when 'text' %}
          <p class="text-lg md:text-xl opacity-80 max-w-2xl text-center" {{ block.shopify_attributes }}>
            {{ block.settings.text }}
          </p>
        {% when 'button' %}
          {% render 'button',
            text: block.settings.button_text,
            url: block.settings.button_link,
            style: block.settings.button_style,
            color: block.settings.button_color,
            size: block.settings.button_size,
            shopify_attributes: block.shopify_attributes
          %}
      {% endcase %}
    {% endfor %}
  </div>
</div>

{%- comment -%} Optional After Section {%- endcomment -%}
{% if section.settings.show_after_section %}
  <div class="background-zoom-after color-{{ section.settings.after_color_scheme | default: section.settings.color_scheme }}">
    {% if section.settings.after_overlay_text != blank %}
      <p class="background-zoom-after__text">{{ section.settings.after_overlay_text }}</p>
    {% endif %}
    {% if section.settings.after_heading != blank %}
      <h2 class="background-zoom__heading">{{ section.settings.after_heading }}</h2>
    {% endif %}
  </div>
{% endif %}

<script>
  (function() {
  const sectionId = '{{ section.id }}';
  const section = document.getElementById('background-zoom-' + sectionId);
  if (!section || section.dataset.bgZoomInitialized) return;
  section.dataset.bgZoomInitialized = 'true';

  // If animations disabled, skip
  if (typeof window.shouldAnimate === 'function' && !window.shouldAnimate()) return;

  function initBackgroundZoom() {
    // Get gsap from window.pieces or window
    if (typeof gsap === 'undefined') {
      if (window.pieces && window.pieces.gsap) {
        window.gsap = window.pieces.gsap;
      } else {
        requestAnimationFrame(initBackgroundZoom);
        return;
      }
    }

    // Get ScrollTrigger and Flip from window.pieces or window
    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);
    const Flip = window.Flip || (window.pieces && window.pieces.Flip);

    if (!ScrollTrigger || !Flip) {
      requestAnimationFrame(initBackgroundZoom);
      return;
    }

    gsap.registerPlugin(ScrollTrigger, Flip);

    // Wait for images to load
    const images = section.querySelectorAll('img');
    const imagePromises = Array.from(images).map(function(img) {
      if (img.complete) return Promise.resolve();
      return new Promise(function(resolve) {
        img.addEventListener('load', resolve, { once: true });
        img.addEventListener('error', resolve, { once: true });
      });
    });

    Promise.all(imagePromises).then(function() {
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          initZoomAnimation();
          ScrollTrigger.refresh(true);
        });
      });
    });
  }

  function initZoomAnimation() {
    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);
    const Flip = window.Flip || (window.pieces && window.pieces.Flip);

    const containers = document.querySelectorAll('[data-bg-zoom-init]');
    if (!containers.length) return;

    let masterTimeline;

    const getScrollRange = function(options) {
      const st = ScrollTrigger.create({
        trigger: options.trigger,
        start: options.start,
        endTrigger: options.endTrigger,
        end: options.end
      });
      const range = Math.max(1, st.end - st.start);
      st.kill();
      return range;
    };

    const bgZoomTimeline = function() {
      if (masterTimeline) {
        masterTimeline.scrollTrigger?.kill();
        masterTimeline.kill();
      }

      // Store animation data for each container
      const containerData = [];

      containers.forEach(function(container) {
        const startEl = container.querySelector('[data-bg-zoom-start]');
        const endEl = container.querySelector('[data-bg-zoom-end]');
        const contentEl = container.querySelector('[data-bg-zoom-content]');
        const darkEl = container.querySelector('[data-bg-zoom-dark]');
        const imgEl = container.querySelector('[data-bg-zoom-img]');
        if (!startEl || !endEl || !contentEl) return;

        const startRadius = getComputedStyle(startEl).borderRadius;
        const endRadius = getComputedStyle(endEl).borderRadius;
        const hasRadius = startRadius !== '0px' || endRadius !== '0px';
        contentEl.style.overflow = hasRadius ? 'hidden' : '';

        // Calculate scroll ranges
        const zoomScrollRange = getScrollRange({
          trigger: startEl,
          start: 'clamp(top bottom)',
          endTrigger: endEl,
          end: 'center center'
        });

        const afterScrollRange = getScrollRange({
          trigger: endEl,
          start: 'center center',
          endTrigger: container,
          end: 'bottom top'
        });

        // Get start and end states for Flip
        const startState = Flip.getState(contentEl);
        Flip.fit(contentEl, startEl, { scale: false });
        const startFitState = Flip.getState(contentEl);

        containerData.push({
          container, startEl, endEl, contentEl, darkEl, imgEl,
          startRadius, endRadius, hasRadius, zoomScrollRange, afterScrollRange, startFitState
        });

        // Reset initial state
        if (hasRadius) gsap.set(contentEl, { borderRadius: startRadius });
        if (imgEl) gsap.set(imgEl, { scale: 1, yPercent: 0, transformOrigin: '50% 50%' });
        if (darkEl) gsap.set(darkEl, { opacity: 0 });
      });

      // Create timeline with scrub
      masterTimeline = gsap.timeline({
        defaults: { ease: 'none' },
        scrollTrigger: {
          trigger: containers[0].querySelector('[data-bg-zoom-start]') || containers[0],
          start: 'clamp(top bottom)',
          endTrigger: containers[containers.length - 1],
          end: 'bottom top',
          scrub: true,
          invalidateOnRefresh: true
        }
      });

      containerData.forEach(function(data) {
        const { startEl, endEl, contentEl, darkEl, imgEl, startRadius, endRadius, hasRadius, zoomScrollRange, afterScrollRange } = data;

        // Flip animation from start to end
        masterTimeline.add(
          Flip.fit(contentEl, endEl, {
            duration: zoomScrollRange,
            ease: 'none',
            scale: false
          })
        );

        // Border Radius animation
        if (hasRadius) {
          masterTimeline.to(contentEl, {
            borderRadius: endRadius,
            duration: zoomScrollRange
          }, '<');
        }

        // Content Y Position after zoom
        masterTimeline.to(contentEl, {
          y: '+=' + afterScrollRange,
          duration: afterScrollRange
        });

        // Dark Overlay fade in
        if (darkEl) {
          masterTimeline.to(darkEl, {
            opacity: 0.75,
            duration: afterScrollRange * 0.25
          }, '<');
        }

        // Image scale and parallax
        if (imgEl) {
          masterTimeline.to(imgEl, {
            scale: 1.25,
            yPercent: -10,
            duration: afterScrollRange
          }, '<');
        }
      });

      // Refresh and sync to current scroll position
      ScrollTrigger.refresh(true);

      // Force timeline to current progress after refresh
      const st = masterTimeline.scrollTrigger;
      if (st) {
        masterTimeline.progress(st.progress, true);
      }
    };

    bgZoomTimeline();

    // Rebuild on resize
    let resizeTimer;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(bgZoomTimeline, 100);
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBackgroundZoom);
  } else {
    initBackgroundZoom();
  }
  })();
</script>

{% schema %}
{
  "name": "t:sections.background_zoom.name",
  "tag": "section",
  "class": "background-zoom-section no-header-offset",
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.image"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "t:shared.settings.image.label"
    },
    {
      "type": "header",
      "content": "t:sections.background_zoom.settings.header__title_before_zoom.content"
    },
    {
      "type": "text",
      "id": "title_before",
      "label": "t:sections.background_zoom.settings.title_before.label",
      "default": "t:sections.background_zoom.settings.title_before.default"
    },
    {
      "type": "text",
      "id": "title_before_accent",
      "label": "t:sections.background_zoom.settings.title_before_accent.label",
      "default": "t:sections.background_zoom.settings.title_before_accent.default"
    },
    {
      "type": "header",
      "content": "t:sections.background_zoom.settings.header__image_overlay.content"
    },
    {
      "type": "text",
      "id": "overlay_text",
      "label": "t:sections.background_zoom.settings.overlay_text.label",
      "info": "t:sections.background_zoom.settings.overlay_text.info"
    },
    {
      "type": "header",
      "content": "t:sections.background_zoom.settings.header__after_section.content"
    },
    {
      "type": "checkbox",
      "id": "show_after_section",
      "label": "t:sections.background_zoom.settings.show_after_section.label",
      "default": false
    },
    {
      "type": "text",
      "id": "after_heading",
      "label": "t:sections.background_zoom.settings.after_heading.label",
      "default": "t:sections.background_zoom.settings.after_heading.default"
    },
    {
      "type": "text",
      "id": "after_overlay_text",
      "label": "t:sections.background_zoom.settings.after_overlay_text.label"
    },
    {
      "type": "color_scheme",
      "id": "after_color_scheme",
      "label": "t:sections.background_zoom.settings.after_color_scheme.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-3"
    },
    {
      "type": "color",
      "id": "content_bg_color",
      "label": "t:sections.background_zoom.settings.content_bg_color.label",
      "info": "t:sections.background_zoom.settings.content_bg_color.info"
    },
    {
      "type": "color",
      "id": "overlay_text_color",
      "label": "t:sections.background_zoom.settings.overlay_text_color.label"
    },
    {
      "type": "color",
      "id": "dark_overlay_color",
      "label": "t:sections.background_zoom.settings.dark_overlay_color.label"
    }
  ],
  "blocks": [
    {
      "type": "heading",
      "name": "t:sections.background_zoom.blocks.heading.name",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "t:sections.background_zoom.blocks.heading.settings.text.label",
          "default": "t:sections.background_zoom.blocks.heading.settings.text.default"
        },
        {
          "type": "text",
          "id": "accent_text",
          "label": "t:sections.background_zoom.blocks.heading.settings.accent_text.label",
          "info": "t:sections.background_zoom.blocks.heading.settings.accent_text.info"
        },
        {
          "type": "checkbox",
          "id": "add_margin_top",
          "label": "t:sections.background_zoom.blocks.heading.settings.add_margin_top.label",
          "default": false,
          "info": "t:sections.background_zoom.blocks.heading.settings.add_margin_top.info"
        }
      ]
    },
    {
      "type": "text",
      "name": "t:sections.background_zoom.blocks.text.name",
      "settings": [
        {
          "type": "textarea",
          "id": "text",
          "label": "t:sections.background_zoom.blocks.text.settings.text.label",
          "default": "t:sections.background_zoom.blocks.text.settings.text.default"
        }
      ]
    },
    {
      "type": "button",
      "name": "t:sections.background_zoom.blocks.button.name",
      "settings": [
        {
          "type": "text",
          "id": "button_text",
          "label": "t:shared.settings.button_text.label",
          "default": "t:sections.background_zoom.blocks.button.settings.button_text.default"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "t:shared.settings.button_link.label"
        },
        {
          "type": "select",
          "id": "button_style",
          "label": "t:shared.settings.button_style.label",
          "default": "outline",
          "options": [
            {
              "value": "solid",
              "label": "t:shared.settings.button_style.options__0.label"
            },
            {
              "value": "outline",
              "label": "t:shared.settings.button_style.options__1.label"
            }
          ]
        },
        {
          "type": "select",
          "id": "button_color",
          "label": "t:shared.settings.button_color.label",
          "default": "primary",
          "options": [
            {
              "value": "primary",
              "label": "t:shared.settings.button_color.options__0.label"
            },
            {
              "value": "secondary",
              "label": "t:shared.settings.button_color.options__1.label"
            }
          ]
        },
        {
          "type": "select",
          "id": "button_size",
          "label": "t:shared.settings.button_size.label",
          "default": "default",
          "options": [
            {
              "value": "small",
              "label": "t:shared.settings.button_size.options__0.label"
            },
            {
              "value": "default",
              "label": "t:shared.settings.button_size.options__1.label"
            },
            {
              "value": "large",
              "label": "t:shared.settings.button_size.options__2.label"
            }
          ]
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.background_zoom.presets.background_zoom.name",
      "category": "t:sections.background_zoom.presets.background_zoom.category",
      "settings": {
        "title_before": "t:sections.background_zoom.presets.background_zoom.settings.title_before",
        "title_before_accent": "t:sections.background_zoom.presets.background_zoom.settings.title_before_accent",
        "overlay_text": "t:sections.background_zoom.presets.background_zoom.settings.overlay_text"
      },
      "blocks": [
        {
          "type": "heading",
          "settings": {
            "text": "t:sections.background_zoom.presets.background_zoom.blocks.heading.0.text",
            "accent_text": "t:sections.background_zoom.presets.background_zoom.blocks.heading.0.accent_text",
            "add_margin_top": false
          }
        },
        {
          "type": "heading",
          "settings": {
            "text": "t:sections.background_zoom.presets.background_zoom.blocks.heading.1.text",
            "add_margin_top": true
          }
        },
        {
          "type": "heading",
          "settings": {
            "text": "t:sections.background_zoom.presets.background_zoom.blocks.heading.2.text",
            "add_margin_top": true
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}