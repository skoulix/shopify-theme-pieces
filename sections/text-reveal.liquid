{%- comment -%}
  Text Reveal Section - Large typography that reveals on scroll
  Codrops-inspired scroll-triggered text animation
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width
  endcapture

  # Alignment modifier class
  case section.settings.header_alignment
    when 'center'
      assign alignment_class = 'text-reveal--center'
    when 'right'
      assign alignment_class = 'text-reveal--right'
    else
      assign alignment_class = ''
  endcase
-%}

<section
  class="text-reveal {{ alignment_class }} section-padding-lg color-{{ section.settings.color_scheme }} relative"
  style="--text-reveal-accent-color: {{ section.settings.accent_color }};"
  data-text-reveal-section="{{ section.id }}"
>
  {% if section.settings.show_background_number %}
    <span class="text-reveal-bg-number font-heading" aria-hidden="true">
      {{ section.settings.background_number }}
    </span>
  {% endif %}

  <div class="{{ container_class }} relative z-10">
    {% if section.settings.label != blank %}
      <p class="section-label" data-text-reveal-label>
        {{ section.settings.label }}
      </p>
    {% endif %}

    <h2 class="text-reveal-heading font-heading" data-text-reveal-heading>
      {%- assign lines = section.settings.text | newline_to_br | split: '<br />' -%}
      {%- for line in lines -%}
        <div class="text-reveal-line">
          {%- assign words = line | strip | split: ' ' -%}
          {%- for word in words -%}
            {%- if word contains '*' -%}
              {%- assign clean_word = word | remove: '*' -%}
              <span class="text-reveal-word" data-text-reveal-word>
                <span class="text-reveal-highlight">{{ clean_word }}</span>
              </span>
            {%- else -%}
              <span class="text-reveal-word" data-text-reveal-word>
                <span>{{ word }}</span>
              </span>
            {%- endif -%}
            {% unless forloop.last %}&nbsp;{% endunless %}
          {%- endfor -%}
        </div>
      {%- endfor -%}
    </h2>

    {% if section.settings.subtext != blank %}
      <p class="text-reveal-subtext section-description" data-text-reveal-subtext>
        {{ section.settings.subtext }}
      </p>
    {% endif %}

    {% if section.settings.button_text != blank and section.settings.button_link != blank %}
      {% if section.settings.button_type == 'link' %}
        <a href="{{ section.settings.button_link }}" class="link-cta section-cta uppercase" data-text-reveal-cta>
          <span class="link-cta-text"><span data-hover="{{ section.settings.button_text }}">{{ section.settings.button_text }}</span></span>
          <i class="ph ph-arrow-right"></i>
        </a>
      {% else %}
        {% render 'button',
          text: section.settings.button_text,
          url: section.settings.button_link,
          style: section.settings.button_style,
          color: section.settings.button_color,
          size: section.settings.button_size,
          extra_class: 'section-cta',
          data_attrs: 'data-text-reveal-cta'
        %}
      {% endif %}
    {% endif %}
  </div>
</section>

<script>
(function() {
  const section = document.querySelector('[data-text-reveal-section="{{ section.id }}"]');
  if (!section || section.dataset.textRevealInitialized) return;
  section.dataset.textRevealInitialized = 'true';

  // If animations disabled, show content immediately
  if (typeof window.shouldAnimate === 'function' && !window.shouldAnimate()) {
    const words = section.querySelectorAll('[data-text-reveal-word]');
    words.forEach(word => word.classList.add('is-visible'));
    return;
  }

  function initAnimation() {
    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    if (!gsap || !ScrollTrigger) {
      setTimeout(initAnimation, 50);
      return;
    }

    const words = section.querySelectorAll('[data-text-reveal-word]');
    const label = section.querySelector('[data-text-reveal-label]');
    const subtext = section.querySelector('[data-text-reveal-subtext]');
    const cta = section.querySelector('[data-text-reveal-cta]');

    const scrollStart = window.getScrollStart ? window.getScrollStart('top 80%') : 'top 80%';

    // Label animation
    if (label) {
      gsap.set(label, { opacity: 0, y: 20 });
      gsap.to(label, {
        opacity: 0.5,
        y: 0,
        duration: 0.8,
        ease: 'power3.out',
        scrollTrigger: {
          trigger: section,
          start: scrollStart,
          once: true
        }
      });
    }

    // Word-by-word reveal with Intersection Observer for performance
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const word = entry.target;
          const index = Array.from(words).indexOf(word);

          setTimeout(() => {
            word.classList.add('is-visible');
          }, index * 60); // Stagger by 60ms

          observer.unobserve(word);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '0px 0px -10% 0px'
    });

    words.forEach(word => observer.observe(word));

    const scrollStartSubtext = window.getScrollStart ? window.getScrollStart('top 85%') : 'top 85%';
    const scrollStartCta = window.getScrollStart ? window.getScrollStart('top 90%') : 'top 90%';

    // Subtext animation
    if (subtext) {
      gsap.set(subtext, { opacity: 0, y: 30 });
      gsap.to(subtext, {
        opacity: 0.7,
        y: 0,
        duration: 0.8,
        ease: 'power3.out',
        scrollTrigger: {
          trigger: subtext,
          start: scrollStartSubtext,
          once: true
        }
      });
    }

    // CTA animation
    if (cta) {
      gsap.set(cta, { opacity: 0, y: 20 });
      gsap.to(cta, {
        opacity: 1,
        y: 0,
        duration: 0.8,
        ease: 'power3.out',
        scrollTrigger: {
          trigger: cta,
          start: scrollStartCta,
          once: true
        }
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimation);
  } else {
    requestAnimationFrame(initAnimation);
  }

  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('text_reveal_animation', () => {
      requestAnimationFrame(initAnimation);
    });
  }
})();
</script>

{% schema %}
{
  "name": "Text Reveal",
  "tag": "section",
  "class": "text-reveal-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "default": "Our Mission",
      "label": "Label"
    },
    {
      "type": "textarea",
      "id": "text",
      "default": "Crafted with *care*,\ndesigned to *inspire*.",
      "label": "Heading text",
      "info": "Use * around words to highlight them (e.g., *word*). Use line breaks to create multiple lines."
    },
    {
      "type": "textarea",
      "id": "subtext",
      "default": "Every product we create is the result of countless hours of research, design, and craftsmanship. We believe that the details matter.",
      "label": "Subtext"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "default": "left",
      "label": "Header alignment"
    },
    {
      "type": "text",
      "id": "button_text",
      "default": "Learn More",
      "label": "Button text"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button link"
    },
    {
      "type": "select",
      "id": "button_type",
      "label": "Button type",
      "default": "link",
      "options": [
        { "value": "link", "label": "Text link" },
        { "value": "button", "label": "Button" }
      ]
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button style",
      "default": "solid",
      "options": [
        { "value": "solid", "label": "Solid" },
        { "value": "outline", "label": "Outline" }
      ],
      "info": "Only applies when Button type is set to Button"
    },
    {
      "type": "select",
      "id": "button_color",
      "label": "Button color",
      "default": "primary",
      "options": [
        { "value": "primary", "label": "Primary (accent)" },
        { "value": "secondary", "label": "Secondary (neutral)" }
      ]
    },
    {
      "type": "select",
      "id": "button_size",
      "label": "Button size",
      "default": "default",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "default", "label": "Default" },
        { "value": "large", "label": "Large" }
      ]
    },
    {
      "type": "header",
      "content": "Background Number"
    },
    {
      "type": "checkbox",
      "id": "show_background_number",
      "default": false,
      "label": "Show background number"
    },
    {
      "type": "text",
      "id": "background_number",
      "default": "01",
      "label": "Background number"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-3"
    },
    {
      "type": "color",
      "id": "accent_color",
      "default": "#6366f1",
      "label": "Accent color (highlighted words)"
    }
  ],
  "presets": [
    {
      "name": "Text Reveal",
      "category": "Text & content"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
  }
{% endschema %}
