{%- comment -%}
  Text Reveal Section - Large typography that reveals on scroll
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture

  # Alignment modifier class
  case section.settings.header_alignment
    when 'center'
      assign alignment_class = 'text-reveal--center'
    when 'right'
      assign alignment_class = 'text-reveal--right'
    else
      assign alignment_class = ''
  endcase
-%}

<div
  class="text-reveal {{ alignment_class }} section-padding{% unless section.settings.padding == 'default' %}-{{ section.settings.padding }}{% endunless %} color-{{ section.settings.color_scheme }} relative"
  data-text-reveal-section="{{ section.id }}"
>
  {% if section.settings.show_background_number %}
    <span class="text-reveal-bg-number font-heading" aria-hidden="true">
      {{ section.settings.background_number }}
    </span>
  {% endif %}

  <div class="{{ container_class }} relative z-10">
    {% if section.settings.label != blank %}
      <p class="section-label" data-text-reveal-label>
        {{ section.settings.label }}
      </p>
    {% endif %}

    <h2 class="text-reveal-heading font-heading" data-text-reveal-heading>
      {%- assign lines = section.settings.text | newline_to_br | split: '<br />' -%}
      {%- for line in lines -%}
        <div class="text-reveal-line">
          {%- assign words = line | strip | split: ' ' -%}
          {%- for word in words -%}
            {%- if word contains '*' -%}
              {%- assign clean_word = word | remove: '*' -%}
              <span class="text-reveal-word" data-text-reveal-word>
                <span class="text-reveal-highlight">{{ clean_word }}</span>
              </span>
            {%- else -%}
              <span class="text-reveal-word" data-text-reveal-word>
                <span>{{ word }}</span>
              </span>
            {%- endif -%}
            {% unless forloop.last %}&nbsp;{% endunless %}
          {%- endfor -%}
        </div>
      {%- endfor -%}
    </h2>

    {% if section.settings.subtext != blank %}
      <p class="text-reveal-subtext section-description" data-text-reveal-subtext>
        {{ section.settings.subtext }}
      </p>
    {% endif %}

    {% if section.settings.button_text != blank and section.settings.button_link != blank %}
      {% if section.settings.button_type == 'link' %}
        <a href="{{ section.settings.button_link }}" class="link-cta section-cta uppercase" data-text-reveal-cta>
          <span class="link-cta-text"><span data-hover="{{ section.settings.button_text }}">{{ section.settings.button_text }}</span></span>
          <i class="ph ph-arrow-right"></i>
        </a>
      {% else %}
        {% render 'button',
          text: section.settings.button_text,
          url: section.settings.button_link,
          style: section.settings.button_style,
          color: section.settings.button_color,
          size: section.settings.button_size,
          extra_class: 'section-cta',
          data_attrs: 'data-text-reveal-cta'
        %}
      {% endif %}
    {% endif %}
  </div>
</div>

<script>
(function() {
  const section = document.querySelector('[data-text-reveal-section="{{ section.id }}"]');
  if (!section || section.dataset.textRevealInitialized) return;
  section.dataset.textRevealInitialized = 'true';

  // If animations disabled, show content immediately
  if (typeof window.shouldAnimate === 'function' && !window.shouldAnimate()) {
    const words = section.querySelectorAll('[data-text-reveal-word]');
    words.forEach(word => word.classList.add('is-visible'));
    return;
  }

  function initAnimation() {
    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    if (!gsap || !ScrollTrigger) {
      setTimeout(initAnimation, 50);
      return;
    }

    const words = section.querySelectorAll('[data-text-reveal-word]');
    const label = section.querySelector('[data-text-reveal-label]');
    const subtext = section.querySelector('[data-text-reveal-subtext]');
    const cta = section.querySelector('[data-text-reveal-cta]');

    const scrollStart = window.getScrollStart ? window.getScrollStart('top 80%') : 'top 80%';

    // Label animation
    if (label) {
      gsap.set(label, { opacity: 0, y: 20 });
      gsap.to(label, {
        opacity: 0.5,
        y: 0,
        duration: 0.8,
        ease: 'power3.out',
        scrollTrigger: {
          trigger: section,
          start: scrollStart,
          once: true
        }
      });
    }

    // Word-by-word reveal with Intersection Observer for performance
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const word = entry.target;
          const index = Array.from(words).indexOf(word);

          setTimeout(() => {
            word.classList.add('is-visible');
          }, index * 60); // Stagger by 60ms

          observer.unobserve(word);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '0px 0px -10% 0px'
    });

    words.forEach(word => observer.observe(word));

    const scrollStartSubtext = window.getScrollStart ? window.getScrollStart('top 85%') : 'top 85%';
    const scrollStartCta = window.getScrollStart ? window.getScrollStart('top 90%') : 'top 90%';

    // Subtext animation
    if (subtext) {
      gsap.set(subtext, { opacity: 0, y: 30 });
      gsap.to(subtext, {
        opacity: 0.7,
        y: 0,
        duration: 0.8,
        ease: 'power3.out',
        scrollTrigger: {
          trigger: subtext,
          start: scrollStartSubtext,
          once: true
        }
      });
    }

    // CTA animation
    if (cta) {
      gsap.set(cta, { opacity: 0, y: 20 });
      gsap.to(cta, {
        opacity: 1,
        y: 0,
        duration: 0.8,
        ease: 'power3.out',
        scrollTrigger: {
          trigger: cta,
          start: scrollStartCta,
          once: true
        }
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimation);
  } else {
    requestAnimationFrame(initAnimation);
  }

  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('text_reveal_animation', () => {
      requestAnimationFrame(initAnimation);
    });
  }
})();
</script>

{% schema %}
{
  "name": "t:sections.text_reveal.name",
  "tag": "section",
  "class": "text-reveal-section",
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.content"
    },
    {
      "type": "text",
      "id": "label",
      "default": "t:sections.text_reveal.settings.label.default",
      "label": "t:shared.settings.label.label"
    },
    {
      "type": "textarea",
      "id": "text",
      "default": "t:sections.text_reveal.settings.text.default",
      "label": "t:shared.settings.text.label",
      "info": "t:shared.info.line_breaks_multiple_lines"
    },
    {
      "type": "textarea",
      "id": "subtext",
      "default": "t:sections.text_reveal.settings.subtext.default",
      "label": "t:sections.text_reveal.settings.subtext.label"
    },
    {
      "type": "text",
      "id": "button_text",
      "default": "t:shared.defaults.learn_more",
      "label": "t:shared.settings.button_text.label"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "t:shared.settings.button_link.label"
    },
    {
      "type": "select",
      "id": "button_type",
      "label": "t:shared.settings.button_type.label",
      "default": "link",
      "options": [
        {
          "value": "link",
          "label": "t:shared.options.link"
        },
        {
          "value": "button",
          "label": "t:shared.options.button"
        }
      ]
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "t:shared.settings.button_style.label",
      "default": "solid",
      "options": [
        {
          "value": "solid",
          "label": "t:shared.settings.button_style.options__0.label"
        },
        {
          "value": "outline",
          "label": "t:shared.settings.button_style.options__1.label"
        }
      ],
      "info": "t:shared.info.controls_button_style"
    },
    {
      "type": "select",
      "id": "button_color",
      "label": "t:shared.settings.button_color.label",
      "default": "primary",
      "options": [
        {
          "value": "primary",
          "label": "t:shared.settings.button_color.options__0.label"
        },
        {
          "value": "secondary",
          "label": "t:shared.settings.button_color.options__1.label"
        }
      ]
    },
    {
      "type": "select",
      "id": "button_size",
      "label": "t:shared.settings.button_size.label",
      "default": "default",
      "options": [
        {
          "value": "small",
          "label": "t:shared.settings.button_size.options__0.label"
        },
        {
          "value": "default",
          "label": "t:shared.settings.button_size.options__1.label"
        },
        {
          "value": "large",
          "label": "t:shared.settings.button_size.options__2.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:sections.text_reveal.settings.header__background_number.content"
    },
    {
      "type": "checkbox",
      "id": "show_background_number",
      "default": false,
      "label": "t:sections.text_reveal.settings.show_background_number.label"
    },
    {
      "type": "text",
      "id": "background_number",
      "default": "01",
      "label": "t:sections.text_reveal.settings.background_number.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "t:shared.settings.full_width.label"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "label": "t:shared.settings.header_alignment.label",
      "default": "left"
    },
    {
      "type": "select",
      "id": "padding",
      "label": "t:shared.settings.padding.label",
      "info": "t:shared.settings.padding.info",
      "default": "large",
      "options": [
        {
          "value": "default",
          "label": "t:shared.settings.padding.options__2.label"
        },
        {
          "value": "small",
          "label": "t:shared.settings.padding.options__1.label"
        },
        {
          "value": "large",
          "label": "t:shared.settings.padding.options__3.label"
        },
        {
          "value": "none",
          "label": "t:shared.settings.padding.options__0.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-3"
    }
  ],
  "presets": [
    {
      "name": "t:sections.text_reveal.presets.text_reveal.name",
      "category": "t:sections.text_reveal.presets.text_reveal.category"
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}
