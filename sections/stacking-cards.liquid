
{%- comment -%}
  Stacking Cards Section - Cards that stack on scroll
{%- endcomment -%}

{%- liquid
  capture header_container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture
-%}

<div
  class="stacking-cards color-{{ section.settings.color_scheme }}"
  data-stacking-cards="{{ section.id }}"
  style="--stacking-bg-position: {{ section.settings.background_image_position }};{% if section.settings.background_image_blur > 0 %} --stacking-bg-blur: {{ section.settings.background_image_blur }}px;{% endif %}"
>
  {%- comment -%} Background Image {%- endcomment -%}
  {% if section.settings.background_image != blank %}
    <div class="stacking-cards-bg{% if section.settings.background_image_blur > 0 %} stacking-cards-bg--blur{% endif %}">
      {{ section.settings.background_image | image_url: width: 2000 | image_tag:
        loading: 'eager',
        decoding: 'async',
        sizes: '100vw',
        widths: '800, 1200, 1600, 2000',
        alt: section.settings.background_image.alt | default: ''
      }}
    </div>
  {% endif %}

  {%- comment -%} Background Overlay {%- endcomment -%}
  {% if section.settings.background_overlay_color != blank and section.settings.background_overlay_opacity > 0 %}
    {%- assign overlay_opacity = section.settings.background_overlay_opacity | divided_by: 100.0 -%}
    <div class="stacking-cards-overlay" style="background-color: {{ section.settings.background_overlay_color | color_modify: 'alpha', overlay_opacity }};"></div>
  {% endif %}

  {%- comment -%} Header - always contained {%- endcomment -%}
  <div class="{{ header_container_class }} stacking-cards-header">
    {% render 'section-header',
      label: section.settings.label,
      title: section.settings.title,
      description: section.settings.text,
      alignment: section.settings.header_alignment,
      group_id: section.id
    %}
  </div>

  {%- comment -%} Cards {%- endcomment -%}
  <div class="stacking-cards-wrapper" style="min-height: {{ section.blocks.size | times: 100 }}vh;">
    <div class="stacking-cards-sticky" data-stacking-sticky>
      {% for block in section.blocks %}
        <div
          class="stacking-card"
          data-stacking-card
          data-card-index="{{ forloop.index0 }}"
          style="z-index: {{ forloop.index }};"
          {{ block.shopify_attributes }}
        >
          <div class="stacking-card-inner">
            <div class="stacking-card-image">
              {% if block.settings.image != blank %}
                {{ block.settings.image | image_url: width: 800 | image_tag:
                  loading: 'lazy',
                  decoding: 'async',
                  sizes: '(max-width: 768px) 100vw, 50vw',
                  widths: '400, 600, 800',
                  alt: block.settings.image.alt | default: block.settings.title | default: section.settings.heading
                }}
              {% else %}
                {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-cover' }}
              {% endif %}
            </div>

            <div class="stacking-card-content">
              <span class="stacking-card-number text-label-sm">
                {{ forloop.index | prepend: '00' | slice: -2, 2 }}
              </span>

              {% if block.settings.title != blank %}
                <h3 class="stacking-card-title font-heading">
                  {{ block.settings.title }}
                </h3>
              {% endif %}

              {% if block.settings.text != blank %}
                <p class="stacking-card-text">
                  {{ block.settings.text }}
                </p>
              {% endif %}

              {% if block.settings.link != blank and block.settings.link_text != blank %}
                <a href="{{ block.settings.link }}" class="stacking-card-link text-link-sm">
                  <span class="stacking-card-link-text-wrapper">
                    <span class="stacking-card-link-text" data-hover="{{ block.settings.link_text }}">{{ block.settings.link_text }}</span>
                  </span>
                  <i class="ph ph-arrow-right"></i>
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
(function() {
  const section = document.querySelector('[data-stacking-cards="{{ section.id }}"]');
  if (!section || section.dataset.stackingInitialized) return;
  section.dataset.stackingInitialized = 'true';

  function initAnimation() {
    const gsap = window.gsap || (window.pieces && window.pieces.gsap);
    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    if (!gsap || !ScrollTrigger) {
      setTimeout(initAnimation, 50);
      return;
    }

    const cards = section.querySelectorAll('[data-stacking-card]');
    const wrapper = section.querySelector('.stacking-cards-wrapper');
    const totalCards = cards.length;
    let activeCardIndex = -1;

    // Update which card is active (for pointer events)
    function setActiveCard(index) {
      if (index === activeCardIndex) return;
      activeCardIndex = index;
      cards.forEach((card, i) => {
        card.classList.toggle('is-active', i === index);
      });
    }

    // Title animations handled by global TweenManager via data-tween attributes

    // Card stacking animation
    cards.forEach((card, i) => {
      const cardIndex = parseInt(card.dataset.cardIndex);

      // Initial state - cards stacked below
      gsap.set(card, {
        opacity: 0,
        y: 100,
        scale: 0.95
      });

      // Animate card into view
      ScrollTrigger.create({
        trigger: wrapper,
        start: () => `top+=${cardIndex * (window.innerHeight * 0.5)} top`,
        end: () => `top+=${(cardIndex + 1) * (window.innerHeight * 0.5)} top`,
        scrub: 0.5,
        onUpdate: (self) => {
          const progress = self.progress;

          // Fade in and move up
          gsap.set(card, {
            opacity: Math.min(progress * 2, 1),
            y: 100 - (progress * 100),
            scale: 0.95 + (progress * 0.05)
          });

          // Set this card as active when it's mostly visible
          if (progress > 0.5) {
            setActiveCard(cardIndex);
          }
        }
      });

      // After card is in view, scale it down as next cards come in
      if (i < totalCards - 1) {
        ScrollTrigger.create({
          trigger: wrapper,
          start: () => `top+=${(cardIndex + 1) * (window.innerHeight * 0.5)} top`,
          end: () => `top+=${(totalCards) * (window.innerHeight * 0.5)} top`,
          scrub: 0.5,
          onUpdate: (self) => {
            const scaleReduction = (totalCards - 1 - cardIndex) * 0.02;
            const yOffset = (totalCards - 1 - cardIndex) * 15;

            gsap.set(card, {
              scale: 1 - (self.progress * scaleReduction),
              y: self.progress * yOffset
            });
          }
        });
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimation);
  } else {
    requestAnimationFrame(initAnimation);
  }

  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('stacking_cards_animation', () => {
      requestAnimationFrame(initAnimation);
    });
  }
})();
</script>

{% schema %}
{
  "name": "t:sections.stacking_cards.name",
  "tag": "section",
  "class": "stacking-cards-section",
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.content"
    },
    {
      "type": "text",
      "id": "label",
      "default": "t:sections.stacking_cards.settings.label.default",
      "label": "t:shared.settings.label.label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "t:sections.stacking_cards.settings.title.default",
      "label": "t:shared.settings.title.label"
    },
    {
      "type": "textarea",
      "id": "text",
      "default": "t:sections.stacking_cards.settings.text.default",
      "label": "t:shared.settings.text.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "t:shared.settings.full_width.label"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "label": "t:shared.settings.header_alignment.label",
      "default": "center"
    },
    {
      "type": "header",
      "content": "t:sections.stacking_cards.settings.header__background.content"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "t:shared.settings.background_image.label"
    },
    {
      "type": "select",
      "id": "background_image_position",
      "label": "t:shared.settings.background_image_position.label",
      "options": [
        {
          "value": "top left",
          "label": "t:shared.options.top_left"
        },
        {
          "value": "top center",
          "label": "t:shared.options.top_center"
        },
        {
          "value": "top right",
          "label": "t:shared.options.top_right"
        },
        {
          "value": "center left",
          "label": "t:shared.options.center_left"
        },
        {
          "value": "center center",
          "label": "t:shared.options.center"
        },
        {
          "value": "center right",
          "label": "t:shared.options.center_right"
        },
        {
          "value": "bottom left",
          "label": "t:shared.options.bottom_left"
        },
        {
          "value": "bottom center",
          "label": "t:shared.options.bottom_center"
        },
        {
          "value": "bottom right",
          "label": "t:shared.options.bottom_right"
        }
      ],
      "default": "center center"
    },
    {
      "type": "range",
      "id": "background_image_blur",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 0,
      "unit": "px",
      "label": "t:shared.settings.background_image_blur.label"
    },
    {
      "type": "color",
      "id": "background_overlay_color",
      "label": "t:sections.stacking_cards.settings.background_overlay_color.label"
    },
    {
      "type": "range",
      "id": "background_overlay_opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 0,
      "unit": "%",
      "label": "t:sections.stacking_cards.settings.background_overlay_opacity.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-1"
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "t:sections.stacking_cards.blocks.card.name",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "t:shared.settings.image.label"
        },
        {
          "type": "text",
          "id": "title",
          "default": "t:shared.defaults.feature_title",
          "label": "t:shared.settings.title.label"
        },
        {
          "type": "textarea",
          "id": "text",
          "default": "t:sections.stacking_cards.blocks.card.settings.text.default",
          "label": "t:shared.settings.text.label"
        },
        {
          "type": "text",
          "id": "link_text",
          "default": "t:shared.defaults.learn_more",
          "label": "t:shared.settings.link_text.label"
        },
        {
          "type": "url",
          "id": "link",
          "label": "t:shared.settings.link.label"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.stacking_cards.presets.stacking_cards.name",
      "category": "t:shared.categories.image_media",
      "blocks": [
        {
          "type": "card",
          "settings": {
            "title": "t:sections.stacking_cards.presets.stacking_cards.blocks.card.0.title",
            "text": "t:sections.stacking_cards.presets.stacking_cards.blocks.card.0.text"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "t:sections.stacking_cards.presets.stacking_cards.blocks.card.1.title",
            "text": "t:sections.stacking_cards.presets.stacking_cards.blocks.card.1.text"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "t:sections.stacking_cards.presets.stacking_cards.blocks.card.2.title",
            "text": "t:sections.stacking_cards.presets.stacking_cards.blocks.card.2.text"
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}