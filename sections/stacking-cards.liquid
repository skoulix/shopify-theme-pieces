{%- comment -%}
  Stacking Cards Section - Cards that stack on scroll
  Codrops-inspired scroll-pinned stacking effect
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif

  # Use global card settings
  assign card_radius = settings.card_radius
  assign card_border_width = settings.card_border_width
  assign card_shadow = settings.card_shadow
-%}

<style>
  .stacking-cards-{{ section.id }} {
    position: relative;
    background-color: var(--color-background);
    color: var(--color-text);
  }

  .stacking-cards-bg-{{ section.id }} {
    position: absolute;
    inset: 0;
    overflow: hidden;
    z-index: 0;
  }

  .stacking-cards-bg-{{ section.id }} img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: {{ section.settings.background_image_position }};
    {% if section.settings.background_image_blur > 0 %}
    filter: blur({{ section.settings.background_image_blur }}px);
    transform: scale(1.1);
    {% endif %}
  }

  .stacking-cards-overlay-{{ section.id }} {
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
  }

  .stacking-cards-wrapper-{{ section.id }} {
    min-height: {{ section.blocks.size | times: 100 }}vh;
    position: relative;
    z-index: 2;
  }

  .stacking-cards-header-{{ section.id }} {
    position: relative;
    z-index: 2;
    padding: var(--section-vertical-padding) 0;
    text-align: {{ section.settings.header_alignment }};
  }

  /* Label, title, description use global .section-* classes from utilities.css */
  .stacking-cards-header-{{ section.id }} .section-label {
    margin-bottom: 1.5rem;
  }

  .stacking-cards-header-{{ section.id }} .section-description {
    max-width: 50ch;
    {% if section.settings.header_alignment == 'center' %}
    margin-left: auto;
    margin-right: auto;
    {% elsif section.settings.header_alignment == 'right' %}
    margin-left: auto;
    {% endif %}
  }

  .stacking-cards-sticky-{{ section.id }} {
    position: sticky;
    top: 0;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .stacking-card-{{ section.id }} {
    position: absolute;
    width: 90%;
    max-width: 900px;
    background: var(--color-background);
    border-radius: {{ card_radius }}px;
    overflow: hidden;
    transform-origin: center top;
    {% if card_border_width > 0 %}
    border: {{ card_border_width }}px solid color-mix(in srgb, var(--color-text) 20%, transparent);
    {% endif %}
    {% case card_shadow %}
      {% when 'none' %}
      box-shadow: 0 25px 60px -15px rgba(0, 0, 0, 0.25), 0 10px 20px -10px rgba(0, 0, 0, 0.15);
      {% when 'sm' %}
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05), 0 25px 60px -15px rgba(0, 0, 0, 0.25), 0 10px 20px -10px rgba(0, 0, 0, 0.15);
      {% when 'md' %}
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1), 0 25px 60px -15px rgba(0, 0, 0, 0.25), 0 10px 20px -10px rgba(0, 0, 0, 0.15);
      {% when 'lg' %}
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1), 0 25px 60px -15px rgba(0, 0, 0, 0.3), 0 10px 20px -10px rgba(0, 0, 0, 0.2);
      {% when 'hard' %}
      box-shadow: 4px 4px 0 0 color-mix(in srgb, var(--color-text) 20%, transparent), 0 25px 60px -15px rgba(0, 0, 0, 0.25), 0 10px 20px -10px rgba(0, 0, 0, 0.15);
    {% endcase %}
  }

  .stacking-card-inner-{{ section.id }} {
    display: grid;
    grid-template-columns: 1fr;
    min-height: 400px;
  }

  @media (min-width: 768px) {
    .stacking-card-inner-{{ section.id }} {
      grid-template-columns: 1fr 1fr;
      min-height: 450px;
    }
  }

  .stacking-card-image-{{ section.id }} {
    position: relative;
    overflow: hidden;
    min-height: 250px;
  }

  .stacking-card-image-{{ section.id }} img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .stacking-card-{{ section.id }}:hover .stacking-card-image-{{ section.id }} img {
    transform: scale(1.05);
  }

  .stacking-card-content-{{ section.id }} {
    padding: clamp(2rem, 4vw, 3rem);
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: var(--color-text);
  }

  .stacking-card-number-{{ section.id }} {
    font-size: 0.8125rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    opacity: 0.4;
    margin-bottom: 1.5rem;
  }

  .stacking-card-title-{{ section.id }} {
    font-size: clamp(1.25rem, 2.5vw, 1.75rem);
    font-weight: 700;
    letter-spacing: calc(-0.02em + var(--heading-letter-spacing, 0em));
    line-height: 1.2;
    color: var(--color-text);
  }

  .stacking-card-text-{{ section.id }} {
    margin-top: 1rem;
    font-size: 0.9375rem;
    line-height: 1.7;
    opacity: 0.75;
  }

  .stacking-card-link-{{ section.id }} {
    margin-top: 2rem;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    {% if settings.headings_uppercase %}text-transform: uppercase;{% endif %}
    color: var(--color-text);
  }

  .stacking-card-link-text-wrapper-{{ section.id }} {
    overflow: hidden;
    display: inline-block;
  }

  .stacking-card-link-{{ section.id }} .stacking-card-link-text-{{ section.id }} {
    display: inline-block;
    position: relative;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .stacking-card-link-{{ section.id }} .stacking-card-link-text-{{ section.id }}::after {
    content: attr(data-hover);
    position: absolute;
    left: 0;
    top: 100%;
    white-space: nowrap;
  }

  .stacking-card-link-{{ section.id }}:hover .stacking-card-link-text-{{ section.id }} {
    transform: translateY(-100%);
  }

  /* Card stacking animation states */
  .stacking-card-{{ section.id }} {
    opacity: 0;
    transform: translateY(100px) scale(0.95);
    pointer-events: none;
  }

  /* Active card (set by JS when card becomes visible) */
  .stacking-card-{{ section.id }}.is-active {
    pointer-events: auto;
  }

  /* Note: This section requires scroll animation to function - no reduced motion fallback */
</style>

<section
  class="stacking-cards-{{ section.id }} color-{{ section.settings.color_scheme }}"
  data-stacking-cards="{{ section.id }}"
>
  {%- comment -%} Background Image {%- endcomment -%}
  {% if section.settings.background_image != blank %}
    <div class="stacking-cards-bg-{{ section.id }}">
      {{ section.settings.background_image | image_url: width: 2000 | image_tag:
        loading: 'eager',
        decoding: 'async',
        sizes: '100vw',
        widths: '800, 1200, 1600, 2000',
        alt: section.settings.background_image.alt | default: ''
      }}
    </div>
  {% endif %}

  {%- comment -%} Background Overlay {%- endcomment -%}
  {% if section.settings.background_overlay_color != blank and section.settings.background_overlay_opacity > 0 %}
    {%- assign overlay_opacity = section.settings.background_overlay_opacity | divided_by: 100.0 -%}
    <div class="stacking-cards-overlay-{{ section.id }}" style="background-color: {{ section.settings.background_overlay_color | color_modify: 'alpha', overlay_opacity }};"></div>
  {% endif %}

  {%- comment -%} Header - uses global data-tween system for animations {%- endcomment -%}
  {% if section.settings.label != blank or section.settings.title != blank %}
    <div class="{{ container_class }} stacking-cards-header-{{ section.id }}" data-tween-group="stacking-cards-header-{{ section.id }}">
      {% if section.settings.label != blank %}
        <span class="section-label" data-tween data-tween-type="fade-up">
          {{ section.settings.label }}
        </span>
      {% endif %}

      {% if section.settings.title != blank %}
        <h2 class="section-title font-heading" data-tween data-tween-type="split-text">
          {{ section.settings.title }}
        </h2>
      {% endif %}

      {% if section.settings.description != blank %}
        <p class="section-description mt-6" data-tween data-tween-type="fade-up">
          {{ section.settings.description }}
        </p>
      {% endif %}
    </div>
  {% endif %}

  {%- comment -%} Cards {%- endcomment -%}
  <div class="stacking-cards-wrapper-{{ section.id }}">
    <div class="stacking-cards-sticky-{{ section.id }}" data-stacking-sticky>
      {% for block in section.blocks %}
        <div
          class="stacking-card-{{ section.id }}"
          data-stacking-card
          data-card-index="{{ forloop.index0 }}"
          style="z-index: {{ forloop.index }};"
          {{ block.shopify_attributes }}
        >
          <div class="stacking-card-inner-{{ section.id }}">
            <div class="stacking-card-image-{{ section.id }}">
              {% if block.settings.image != blank %}
                {{ block.settings.image | image_url: width: 800 | image_tag:
                  loading: 'lazy',
                  decoding: 'async',
                  sizes: '(max-width: 768px) 100vw, 50vw',
                  widths: '400, 600, 800',
                  alt: block.settings.image.alt | default: block.settings.title | default: section.settings.heading
                }}
              {% else %}
                {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-cover' }}
              {% endif %}
            </div>

            <div class="stacking-card-content-{{ section.id }}">
              <span class="stacking-card-number-{{ section.id }}">
                {{ forloop.index | prepend: '00' | slice: -2, 2 }}
              </span>

              {% if block.settings.title != blank %}
                <h3 class="stacking-card-title-{{ section.id }} font-heading">
                  {{ block.settings.title }}
                </h3>
              {% endif %}

              {% if block.settings.text != blank %}
                <p class="stacking-card-text-{{ section.id }}">
                  {{ block.settings.text }}
                </p>
              {% endif %}

              {% if block.settings.link != blank and block.settings.link_text != blank %}
                <a href="{{ block.settings.link }}" class="stacking-card-link-{{ section.id }}">
                  <span class="stacking-card-link-text-wrapper-{{ section.id }}">
                    <span class="stacking-card-link-text-{{ section.id }}" data-hover="{{ block.settings.link_text }}">{{ block.settings.link_text }}</span>
                  </span>
                  <i class="ph ph-arrow-right"></i>
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<script>
(function() {
  const section = document.querySelector('[data-stacking-cards="{{ section.id }}"]');
  if (!section || section.dataset.stackingInitialized) return;
  section.dataset.stackingInitialized = 'true';

  function initAnimation() {
    const gsap = window.gsap || (window.pieces && window.pieces.gsap);
    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    if (!gsap || !ScrollTrigger) {
      setTimeout(initAnimation, 50);
      return;
    }

    const cards = section.querySelectorAll('[data-stacking-card]');
    const wrapper = section.querySelector('.stacking-cards-wrapper-{{ section.id }}');
    const totalCards = cards.length;
    let activeCardIndex = -1;

    // Update which card is active (for pointer events)
    function setActiveCard(index) {
      if (index === activeCardIndex) return;
      activeCardIndex = index;
      cards.forEach((card, i) => {
        card.classList.toggle('is-active', i === index);
      });
    }

    // Title animations handled by global TweenManager via data-tween attributes

    // Card stacking animation
    cards.forEach((card, i) => {
      const cardIndex = parseInt(card.dataset.cardIndex);

      // Initial state - cards stacked below
      gsap.set(card, {
        opacity: 0,
        y: 100,
        scale: 0.95
      });

      // Animate card into view
      ScrollTrigger.create({
        trigger: wrapper,
        start: () => `top+=${cardIndex * (window.innerHeight * 0.5)} top`,
        end: () => `top+=${(cardIndex + 1) * (window.innerHeight * 0.5)} top`,
        scrub: 0.5,
        onUpdate: (self) => {
          const progress = self.progress;

          // Fade in and move up
          gsap.set(card, {
            opacity: Math.min(progress * 2, 1),
            y: 100 - (progress * 100),
            scale: 0.95 + (progress * 0.05)
          });

          // Set this card as active when it's mostly visible
          if (progress > 0.5) {
            setActiveCard(cardIndex);
          }
        }
      });

      // After card is in view, scale it down as next cards come in
      if (i < totalCards - 1) {
        ScrollTrigger.create({
          trigger: wrapper,
          start: () => `top+=${(cardIndex + 1) * (window.innerHeight * 0.5)} top`,
          end: () => `top+=${(totalCards) * (window.innerHeight * 0.5)} top`,
          scrub: 0.5,
          onUpdate: (self) => {
            const scaleReduction = (totalCards - 1 - cardIndex) * 0.02;
            const yOffset = (totalCards - 1 - cardIndex) * 15;

            gsap.set(card, {
              scale: 1 - (self.progress * scaleReduction),
              y: self.progress * yOffset
            });
          }
        });
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimation);
  } else {
    requestAnimationFrame(initAnimation);
  }

  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('stacking_cards_animation', () => {
      requestAnimationFrame(initAnimation);
    });
  }
})();
</script>

{% schema %}
{
  "name": "Stacking Cards",
  "tag": "section",
  "class": "stacking-cards-section",
  "settings": [
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "label",
      "default": "Features",
      "label": "Label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "Why Choose Us",
      "label": "Title"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "Discover what makes our products stand out from the rest.",
      "label": "Description"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "default": "left",
      "label": "Header alignment"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "header",
      "content": "Background"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background image"
    },
    {
      "type": "select",
      "id": "background_image_position",
      "label": "Background image position",
      "options": [
        { "value": "top left", "label": "Top left" },
        { "value": "top center", "label": "Top center" },
        { "value": "top right", "label": "Top right" },
        { "value": "center left", "label": "Center left" },
        { "value": "center center", "label": "Center" },
        { "value": "center right", "label": "Center right" },
        { "value": "bottom left", "label": "Bottom left" },
        { "value": "bottom center", "label": "Bottom center" },
        { "value": "bottom right", "label": "Bottom right" }
      ],
      "default": "center center"
    },
    {
      "type": "range",
      "id": "background_image_blur",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 0,
      "unit": "px",
      "label": "Background image blur"
    },
    {
      "type": "color",
      "id": "background_overlay_color",
      "label": "Background overlay color"
    },
    {
      "type": "range",
      "id": "background_overlay_opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 0,
      "unit": "%",
      "label": "Background overlay opacity"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Card",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "title",
          "default": "Feature Title",
          "label": "Title"
        },
        {
          "type": "textarea",
          "id": "text",
          "default": "Describe this feature and how it benefits your customers. Keep it concise and compelling.",
          "label": "Text"
        },
        {
          "type": "text",
          "id": "link_text",
          "default": "Learn More",
          "label": "Link text"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Stacking Cards",
      "category": "Scrolling & animation",
      "blocks": [
        { "type": "card", "settings": { "title": "Premium Quality", "text": "We source only the finest materials and work with skilled artisans to create products that last." } },
        { "type": "card", "settings": { "title": "Sustainable Practices", "text": "Every step of our process is designed with the environment in mind, from sourcing to shipping." } },
        { "type": "card", "settings": { "title": "Customer First", "text": "Your satisfaction is our priority. We offer hassle-free returns and dedicated support." } }
      ]
    }
  ]
}
{% endschema %}