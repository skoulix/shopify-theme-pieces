{%- comment -%}
  Stacking Cards Section - Cards that stack on scroll
  Codrops-inspired scroll-pinned stacking effect
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width
  endcapture
-%}

<section
  class="stacking-cards color-{{ section.settings.color_scheme }}"
  data-stacking-cards="{{ section.id }}"
  style="--stacking-bg-position: {{ section.settings.background_image_position }};{% if section.settings.background_image_blur > 0 %} --stacking-bg-blur: {{ section.settings.background_image_blur }}px;{% endif %}"
>
  {%- comment -%} Background Image {%- endcomment -%}
  {% if section.settings.background_image != blank %}
    <div class="stacking-cards-bg{% if section.settings.background_image_blur > 0 %} stacking-cards-bg--blur{% endif %}">
      {{ section.settings.background_image | image_url: width: 2000 | image_tag:
        loading: 'eager',
        decoding: 'async',
        sizes: '100vw',
        widths: '800, 1200, 1600, 2000',
        alt: section.settings.background_image.alt | default: ''
      }}
    </div>
  {% endif %}

  {%- comment -%} Background Overlay {%- endcomment -%}
  {% if section.settings.background_overlay_color != blank and section.settings.background_overlay_opacity > 0 %}
    {%- assign overlay_opacity = section.settings.background_overlay_opacity | divided_by: 100.0 -%}
    <div class="stacking-cards-overlay" style="background-color: {{ section.settings.background_overlay_color | color_modify: 'alpha', overlay_opacity }};"></div>
  {% endif %}

  {%- comment -%} Header - uses global data-tween system for animations {%- endcomment -%}
  {% if section.settings.label != blank or section.settings.title != blank %}
    <div class="{{ container_class }} stacking-cards-header text-{{ section.settings.header_alignment }}" data-tween-group="stacking-cards-header-{{ section.id }}">
      {% if section.settings.label != blank %}
        <span class="section-label" data-tween data-tween-type="fade-up">
          {{ section.settings.label }}
        </span>
      {% endif %}

      {% if section.settings.title != blank %}
        <h2 class="section-title" data-tween data-tween-type="split-text">
          {{ section.settings.title }}
        </h2>
      {% endif %}

      {% if section.settings.description != blank %}
        <p class="section-description mt-6" data-tween data-tween-type="fade-up">
          {{ section.settings.description }}
        </p>
      {% endif %}
    </div>
  {% endif %}

  {%- comment -%} Cards {%- endcomment -%}
  <div class="stacking-cards-wrapper" style="min-height: {{ section.blocks.size | times: 100 }}vh;">
    <div class="stacking-cards-sticky" data-stacking-sticky>
      {% for block in section.blocks %}
        <div
          class="stacking-card"
          data-stacking-card
          data-card-index="{{ forloop.index0 }}"
          style="z-index: {{ forloop.index }};"
          {{ block.shopify_attributes }}
        >
          <div class="stacking-card-inner">
            <div class="stacking-card-image">
              {% if block.settings.image != blank %}
                {{ block.settings.image | image_url: width: 800 | image_tag:
                  loading: 'lazy',
                  decoding: 'async',
                  sizes: '(max-width: 768px) 100vw, 50vw',
                  widths: '400, 600, 800',
                  alt: block.settings.image.alt | default: block.settings.title | default: section.settings.heading
                }}
              {% else %}
                {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-cover' }}
              {% endif %}
            </div>

            <div class="stacking-card-content">
              <span class="stacking-card-number text-label-sm">
                {{ forloop.index | prepend: '00' | slice: -2, 2 }}
              </span>

              {% if block.settings.title != blank %}
                <h3 class="stacking-card-title font-heading">
                  {{ block.settings.title }}
                </h3>
              {% endif %}

              {% if block.settings.text != blank %}
                <p class="stacking-card-text">
                  {{ block.settings.text }}
                </p>
              {% endif %}

              {% if block.settings.link != blank and block.settings.link_text != blank %}
                <a href="{{ block.settings.link }}" class="stacking-card-link text-link-sm">
                  <span class="stacking-card-link-text-wrapper">
                    <span class="stacking-card-link-text" data-hover="{{ block.settings.link_text }}">{{ block.settings.link_text }}</span>
                  </span>
                  <i class="ph ph-arrow-right"></i>
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<script>
(function() {
  const section = document.querySelector('[data-stacking-cards="{{ section.id }}"]');
  if (!section || section.dataset.stackingInitialized) return;
  section.dataset.stackingInitialized = 'true';

  function initAnimation() {
    const gsap = window.gsap || (window.pieces && window.pieces.gsap);
    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    if (!gsap || !ScrollTrigger) {
      setTimeout(initAnimation, 50);
      return;
    }

    const cards = section.querySelectorAll('[data-stacking-card]');
    const wrapper = section.querySelector('.stacking-cards-wrapper');
    const totalCards = cards.length;
    let activeCardIndex = -1;

    // Update which card is active (for pointer events)
    function setActiveCard(index) {
      if (index === activeCardIndex) return;
      activeCardIndex = index;
      cards.forEach((card, i) => {
        card.classList.toggle('is-active', i === index);
      });
    }

    // Title animations handled by global TweenManager via data-tween attributes

    // Card stacking animation
    cards.forEach((card, i) => {
      const cardIndex = parseInt(card.dataset.cardIndex);

      // Initial state - cards stacked below
      gsap.set(card, {
        opacity: 0,
        y: 100,
        scale: 0.95
      });

      // Animate card into view
      ScrollTrigger.create({
        trigger: wrapper,
        start: () => `top+=${cardIndex * (window.innerHeight * 0.5)} top`,
        end: () => `top+=${(cardIndex + 1) * (window.innerHeight * 0.5)} top`,
        scrub: 0.5,
        onUpdate: (self) => {
          const progress = self.progress;

          // Fade in and move up
          gsap.set(card, {
            opacity: Math.min(progress * 2, 1),
            y: 100 - (progress * 100),
            scale: 0.95 + (progress * 0.05)
          });

          // Set this card as active when it's mostly visible
          if (progress > 0.5) {
            setActiveCard(cardIndex);
          }
        }
      });

      // After card is in view, scale it down as next cards come in
      if (i < totalCards - 1) {
        ScrollTrigger.create({
          trigger: wrapper,
          start: () => `top+=${(cardIndex + 1) * (window.innerHeight * 0.5)} top`,
          end: () => `top+=${(totalCards) * (window.innerHeight * 0.5)} top`,
          scrub: 0.5,
          onUpdate: (self) => {
            const scaleReduction = (totalCards - 1 - cardIndex) * 0.02;
            const yOffset = (totalCards - 1 - cardIndex) * 15;

            gsap.set(card, {
              scale: 1 - (self.progress * scaleReduction),
              y: self.progress * yOffset
            });
          }
        });
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimation);
  } else {
    requestAnimationFrame(initAnimation);
  }

  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('stacking_cards_animation', () => {
      requestAnimationFrame(initAnimation);
    });
  }
})();
</script>

{% schema %}
{
  "name": "Stacking Cards",
  "tag": "section",
  "class": "stacking-cards-section",
  "settings": [
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "label",
      "default": "Features",
      "label": "Label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "Why Choose Us",
      "label": "Title"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "Discover what makes our products stand out from the rest.",
      "label": "Description"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "default": "center",
      "label": "Header alignment"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "header",
      "content": "Background"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background image"
    },
    {
      "type": "select",
      "id": "background_image_position",
      "label": "Background image position",
      "options": [
        { "value": "top left", "label": "Top left" },
        { "value": "top center", "label": "Top center" },
        { "value": "top right", "label": "Top right" },
        { "value": "center left", "label": "Center left" },
        { "value": "center center", "label": "Center" },
        { "value": "center right", "label": "Center right" },
        { "value": "bottom left", "label": "Bottom left" },
        { "value": "bottom center", "label": "Bottom center" },
        { "value": "bottom right", "label": "Bottom right" }
      ],
      "default": "center center"
    },
    {
      "type": "range",
      "id": "background_image_blur",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 0,
      "unit": "px",
      "label": "Background image blur"
    },
    {
      "type": "color",
      "id": "background_overlay_color",
      "label": "Background overlay color"
    },
    {
      "type": "range",
      "id": "background_overlay_opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 0,
      "unit": "%",
      "label": "Background overlay opacity"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Card",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "title",
          "default": "Feature Title",
          "label": "Title"
        },
        {
          "type": "textarea",
          "id": "text",
          "default": "Describe this feature and how it benefits your customers. Keep it concise and compelling.",
          "label": "Text"
        },
        {
          "type": "text",
          "id": "link_text",
          "default": "Learn More",
          "label": "Link text"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Stacking Cards",
      "category": "Scrolling & animation",
      "blocks": [
        { "type": "card", "settings": { "title": "Premium Quality", "text": "We source only the finest materials and work with skilled artisans to create products that last." } },
        { "type": "card", "settings": { "title": "Sustainable Practices", "text": "Every step of our process is designed with the environment in mind, from sourcing to shipping." } },
        { "type": "card", "settings": { "title": "Customer First", "text": "Your satisfaction is our priority. We offer hassle-free returns and dedicated support." } }
      ]
    }
  ]
}
{% endschema %}