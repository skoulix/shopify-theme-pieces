{%- comment -%}
  Stacking Cards Section - Cards that stack on scroll
  Codrops-inspired scroll-pinned stacking effect
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif

  # Use global card settings
  assign card_radius = settings.card_radius
  assign card_border_width = settings.card_border_width
  assign card_shadow = settings.card_shadow
-%}

<style>
  .stacking-cards-{{ section.id }} {
    background-color: {{ section.settings.background_color }};
    color: {{ section.settings.text_color }};
  }

  .stacking-cards-wrapper-{{ section.id }} {
    min-height: {{ section.blocks.size | times: 100 }}vh;
    position: relative;
  }

  .stacking-cards-header-{{ section.id }} {
    height: 100vh;
    text-align: {{ section.settings.header_alignment }};
  }

  .stacking-cards-header-content-{{ section.id }} {
    padding-top: var(--section-vertical-padding);
  }

  .stacking-cards-label-{{ section.id }} {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    margin-bottom: 1.5rem;
  }

  .stacking-cards-label-{{ section.id }}.intro-visible {
    opacity: 0.5;
  }

  .stacking-cards-title-{{ section.id }} {
    font-size: calc(clamp(2rem, 5vw, 3.5rem) * var(--heading-font-scale, 1));
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1;
  }

  .stacking-cards-title-line:nth-child(2) {
    margin-left: clamp(0.5rem, 4vw, 2rem);
  }

  .stacking-cards-description-{{ section.id }} {
    margin-top: 1.5rem;
    font-size: clamp(0.875rem, 1.5vw, 1.125rem);
    max-width: 50ch;
    {% if section.settings.header_alignment == 'center' %}
    margin-left: auto;
    margin-right: auto;
    {% endif %}
  }

  .stacking-cards-description-{{ section.id }}.intro-visible {
    opacity: 0.7;
  }

  .stacking-cards-sticky-{{ section.id }} {
    position: sticky;
    top: 0;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .stacking-card-{{ section.id }} {
    position: absolute;
    width: 90%;
    max-width: 900px;
    background: {{ section.settings.card_background }};
    border-radius: {{ card_radius }}px;
    overflow: hidden;
    transform-origin: center top;
    {% if card_border_width > 0 %}
    border: {{ card_border_width }}px solid currentColor;
    border-color: {{ section.settings.card_text_color }}20;
    {% endif %}
    {% case card_shadow %}
      {% when 'none' %}
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
      {% when 'sm' %}
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05), 0 25px 50px -12px rgba(0, 0, 0, 0.15);
      {% when 'md' %}
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1), 0 25px 50px -12px rgba(0, 0, 0, 0.15);
      {% when 'lg' %}
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1), 0 25px 50px -12px rgba(0, 0, 0, 0.15);
      {% when 'hard' %}
      box-shadow: 4px 4px 0 0 {{ section.settings.card_text_color }}20, 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    {% endcase %}
  }

  .stacking-card-inner-{{ section.id }} {
    display: grid;
    grid-template-columns: 1fr;
    min-height: 400px;
  }

  @media (min-width: 768px) {
    .stacking-card-inner-{{ section.id }} {
      grid-template-columns: 1fr 1fr;
      min-height: 450px;
    }
  }

  .stacking-card-image-{{ section.id }} {
    position: relative;
    overflow: hidden;
    min-height: 250px;
  }

  .stacking-card-image-{{ section.id }} img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .stacking-card-{{ section.id }}:hover .stacking-card-image-{{ section.id }} img {
    transform: scale(1.05);
  }

  .stacking-card-content-{{ section.id }} {
    padding: clamp(2rem, 4vw, 3rem);
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: {{ section.settings.card_text_color }};
  }

  .stacking-card-number-{{ section.id }} {
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    opacity: 0.4;
    margin-bottom: 1.5rem;
  }

  .stacking-card-title-{{ section.id }} {
    font-size: clamp(1.25rem, 2.5vw, 1.75rem);
    font-weight: 700;
    letter-spacing: -0.02em;
    line-height: 1.2;
    color: {{ section.settings.card_text_color }};
  }

  .stacking-card-text-{{ section.id }} {
    margin-top: 1rem;
    font-size: 0.9375rem;
    line-height: 1.7;
    opacity: 0.75;
  }

  .stacking-card-link-{{ section.id }} {
    margin-top: 2rem;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: {{ section.settings.card_text_color }};
  }

  .stacking-card-link-text-wrapper-{{ section.id }} {
    overflow: hidden;
    display: inline-block;
  }

  .stacking-card-link-{{ section.id }} .stacking-card-link-text-{{ section.id }} {
    display: inline-block;
    position: relative;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .stacking-card-link-{{ section.id }} .stacking-card-link-text-{{ section.id }}::after {
    content: attr(data-hover);
    position: absolute;
    left: 0;
    top: 100%;
    white-space: nowrap;
  }

  .stacking-card-link-{{ section.id }}:hover .stacking-card-link-text-{{ section.id }} {
    transform: translateY(-100%);
  }

  /* Card stacking animation states - JS handles initial positioning */
  /* Note: This section requires scroll animation to function - no reduced motion fallback */

</style>

<section
  class="stacking-cards-{{ section.id }}"
  data-stacking-cards="{{ section.id }}"
>
  {%- comment -%} Wrapper contains both header and cards for scroll tracking {%- endcomment -%}
  <div class="stacking-cards-wrapper-{{ section.id }}">
    {%- comment -%} Sticky Header {%- endcomment -%}
    {% if section.settings.label != blank or section.settings.title != blank %}
      <div class="stacking-cards-header-{{ section.id }}" data-stacking-header>
        <div class="{{ container_class }} stacking-cards-header-content-{{ section.id }}" data-stacking-header-content>
          {% if section.settings.label != blank %}
            <span class="stacking-cards-label-{{ section.id }}" data-intro>
              {{ section.settings.label }}
            </span>
          {% endif %}

          {% if section.settings.title != blank %}
            <h2 class="stacking-cards-title-{{ section.id }} font-heading" data-stacking-title>
              {{ section.settings.title }}
            </h2>
          {% endif %}

          {% if section.settings.description != blank %}
            <p class="stacking-cards-description-{{ section.id }}" data-intro>
              {{ section.settings.description }}
            </p>
          {% endif %}
        </div>
      </div>
    {% endif %}
    <div class="stacking-cards-sticky-{{ section.id }}" data-stacking-sticky>
      {% for block in section.blocks %}
        {%- liquid
          if block.settings.card_background != blank
            assign card_bg = block.settings.card_background
          else
            assign card_bg = section.settings.card_background
          endif

          if block.settings.card_text_color != blank
            assign card_text = block.settings.card_text_color
          else
            assign card_text = section.settings.card_text_color
          endif
        -%}
        <div
          class="stacking-card-{{ section.id }}"
          data-stacking-card
          data-card-index="{{ forloop.index0 }}"
          style="z-index: {{ forloop.index }}; background: {{ card_bg }};"
          {{ block.shopify_attributes }}
        >
          <div class="stacking-card-inner-{{ section.id }}">
            <div class="stacking-card-image-{{ section.id }}">
              {% if block.settings.image != blank %}
                {{ block.settings.image | image_url: width: 800 | image_tag:
                  loading: 'lazy',
                  sizes: '(max-width: 768px) 100vw, 50vw',
                  widths: '400, 600, 800'
                }}
              {% else %}
                {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-cover' }}
              {% endif %}
            </div>

            <div class="stacking-card-content-{{ section.id }}" style="color: {{ card_text }};">
              <span class="stacking-card-number-{{ section.id }}">
                {{ forloop.index | prepend: '00' | slice: -2, 2 }}
              </span>

              {% if block.settings.title != blank %}
                <h3 class="stacking-card-title-{{ section.id }} font-heading" style="color: {{ card_text }};">
                  {{ block.settings.title }}
                </h3>
              {% endif %}

              {% if block.settings.text != blank %}
                <p class="stacking-card-text-{{ section.id }}">
                  {{ block.settings.text }}
                </p>
              {% endif %}

              {% if block.settings.link != blank and block.settings.link_text != blank %}
                <a href="{{ block.settings.link }}" class="stacking-card-link-{{ section.id }}" style="color: {{ card_text }};">
                  <span class="stacking-card-link-text-wrapper-{{ section.id }}">
                    <span class="stacking-card-link-text-{{ section.id }}" data-hover="{{ block.settings.link_text }}">{{ block.settings.link_text }}</span>
                  </span>
                  <i class="ph ph-arrow-right"></i>
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<script>
(function() {
  const section = document.querySelector('[data-stacking-cards="{{ section.id }}"]');
  if (!section || section.dataset.stackingInitialized) return;
  section.dataset.stackingInitialized = 'true';

  function initAnimation() {
    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    let SplitText = window.SplitText;
    if (!SplitText && window.pieces && window.pieces.SplitText) {
      SplitText = window.pieces.SplitText;
    }

    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    if (!gsap || !ScrollTrigger) {
      setTimeout(initAnimation, 50);
      return;
    }

    const cards = section.querySelectorAll('[data-stacking-card]');
    const wrapper = section.querySelector('.stacking-cards-wrapper-{{ section.id }}');
    const headerContent = section.querySelector('[data-stacking-header-content]');
    const title = section.querySelector('[data-stacking-title]');
    const totalCards = cards.length;

    // Header animation on scroll
    // Header starts at top, moves to center, then fades out before cards appear
    const header = section.querySelector('[data-stacking-header]');
    if (headerContent && header) {
      // Calculate the vertical distance to move to center
      const calculateCenterOffset = () => {
        const headerHeight = header.offsetHeight;
        const contentHeight = headerContent.offsetHeight;
        const paddingTop = parseFloat(getComputedStyle(headerContent).paddingTop) || 0;
        // Target Y is the center of the viewport minus half the content height, minus current padding
        return (headerHeight / 2) - (contentHeight / 2) - paddingTop;
      };

      // Phase 1: Move header content to center (first 60% of header scroll)
      ScrollTrigger.create({
        trigger: header,
        start: 'top top',
        end: 'center top',
        scrub: true,
        onUpdate: (self) => {
          const progress = self.progress;
          const centerOffset = calculateCenterOffset();
          gsap.set(headerContent, {
            y: progress * centerOffset
          });
        }
      });

      // Phase 2: Fade out header content (last 40% of header scroll)
      ScrollTrigger.create({
        trigger: header,
        start: 'center top',
        end: 'bottom top',
        scrub: true,
        onUpdate: (self) => {
          const progress = self.progress;
          gsap.set(headerContent, {
            opacity: 1 - progress,
            scale: 1 - (progress * 0.1)
          });
        }
      });
    }

    // Card stacking animation
    // Header scroll space is based on header height
    const headerEl = section.querySelector('[data-stacking-header]');
    const headerScrollSpace = headerEl ? headerEl.offsetHeight : 0;

    cards.forEach((card, i) => {
      const cardIndex = parseInt(card.dataset.cardIndex);

      // Initial state - cards stacked below
      gsap.set(card, {
        opacity: 0,
        y: 100,
        scale: 0.95
      });

      // Animate card into view (offset by header scroll space)
      ScrollTrigger.create({
        trigger: wrapper,
        start: () => `top+=${headerScrollSpace + cardIndex * (window.innerHeight * 0.5)} top`,
        end: () => `top+=${headerScrollSpace + (cardIndex + 1) * (window.innerHeight * 0.5)} top`,
        scrub: 0.5,
        onUpdate: (self) => {
          const progress = self.progress;

          // Fade in and move up
          gsap.set(card, {
            opacity: Math.min(progress * 2, 1),
            y: 100 - (progress * 100),
            scale: 0.95 + (progress * 0.05)
          });
        }
      });

      // After card is in view, scale it down as next cards come in
      if (i < totalCards - 1) {
        ScrollTrigger.create({
          trigger: wrapper,
          start: () => `top+=${headerScrollSpace + (cardIndex + 1) * (window.innerHeight * 0.5)} top`,
          end: () => `top+=${headerScrollSpace + (totalCards) * (window.innerHeight * 0.5)} top`,
          scrub: 0.5,
          onUpdate: (self) => {
            const scaleReduction = (totalCards - 1 - cardIndex) * 0.02;
            const yOffset = (totalCards - 1 - cardIndex) * 15;

            gsap.set(card, {
              scale: 1 - (self.progress * scaleReduction),
              y: self.progress * yOffset
            });
          }
        });
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimation);
  } else {
    requestAnimationFrame(initAnimation);
  }

  window.addEventListener('swup:contentReplaced', () => {
    requestAnimationFrame(initAnimation);
  });
})();
</script>

{% schema %}
{
  "name": "Stacking Cards",
  "tag": "section",
  "class": "stacking-cards-section",
  "settings": [
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "label",
      "default": "Features",
      "label": "Label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "Why Choose Us",
      "label": "Title"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "Discover what makes our products stand out from the rest.",
      "label": "Description"
    },
    {
      "type": "select",
      "id": "header_alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "center",
      "label": "Header alignment"
    },
    {
      "type": "header",
      "content": "Cards"
    },
    {
      "type": "range",
      "id": "card_radius",
      "min": 0,
      "max": 40,
      "step": 4,
      "default": 16,
      "unit": "px",
      "label": "Card corner radius"
    },
    {
      "type": "color",
      "id": "card_background",
      "default": "#ffffff",
      "label": "Card background"
    },
    {
      "type": "color",
      "id": "card_text_color",
      "default": "#000000",
      "label": "Card text color"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "default": "#f5f5f5",
      "label": "Background color"
    },
    {
      "type": "color",
      "id": "text_color",
      "default": "#000000",
      "label": "Text color"
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Card",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "title",
          "default": "Feature Title",
          "label": "Title"
        },
        {
          "type": "textarea",
          "id": "text",
          "default": "Describe this feature and how it benefits your customers. Keep it concise and compelling.",
          "label": "Text"
        },
        {
          "type": "text",
          "id": "link_text",
          "default": "Learn More",
          "label": "Link text"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        },
        {
          "type": "header",
          "content": "Colors"
        },
        {
          "type": "color",
          "id": "card_background",
          "label": "Card background"
        },
        {
          "type": "color",
          "id": "card_text_color",
          "label": "Card text color"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Stacking Cards",
      "category": "Scrolling & animation",
      "blocks": [
        { "type": "card", "settings": { "title": "Premium Quality", "text": "We source only the finest materials and work with skilled artisans to create products that last." } },
        { "type": "card", "settings": { "title": "Sustainable Practices", "text": "Every step of our process is designed with the environment in mind, from sourcing to shipping." } },
        { "type": "card", "settings": { "title": "Customer First", "text": "Your satisfaction is our priority. We offer hassle-free returns and dedicated support." } }
      ]
    }
  ]
}
{% endschema %}
