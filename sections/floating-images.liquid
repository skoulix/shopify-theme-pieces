{%- comment -%}
  Floating Images Section - Sticky content with parallax background images
{%- endcomment -%}

{%- liquid
  assign section_height = section.settings.section_height | default: 300
  assign section_height_mobile = section.settings.section_height_mobile | default: 200
  assign image_opacity_percent = section.settings.image_opacity | default: 15
  assign image_opacity = image_opacity_percent | divided_by: 100.0

  # Predefined positions for floating images (x%, y%, parallax speed, base width in px)
  # Y positions are percentages of section height (0-100), spread throughout section
  assign positions = '12,8,0.3,180|82,15,0.5,280|18,28,0.4,220|75,35,0.6,320|8,48,0.35,200|88,55,0.45,260|25,65,0.5,300|70,72,0.4,240|15,82,0.55,280|55,90,0.3,200|40,45,0.45,260' | split: '|'
-%}

<style>
  .floating-images-{{ section.id }} {
    height: {{ section_height_mobile }}vh;
  }

  @media (min-width: 768px) {
    .floating-images-{{ section.id }} {
      height: {{ section_height }}vh;
    }
  }

  /* Label, title, description use global .section-* classes from utilities.css */
  .floating-images-{{ section.id }} .section-label {
    margin-bottom: 1.5rem;
  }

  .floating-images-{{ section.id }} .parallax-image {
    will-change: transform;
    opacity: {{ image_opacity }};
  }

  /* Varied transition durations for organic movement */
  .floating-images-{{ section.id }} .parallax-image:nth-child(1) { transition: transform 0.15s ease-out; }
  .floating-images-{{ section.id }} .parallax-image:nth-child(2) { transition: transform 0.08s ease-out; }
  .floating-images-{{ section.id }} .parallax-image:nth-child(3) { transition: transform 0.12s ease-out; }
  .floating-images-{{ section.id }} .parallax-image:nth-child(4) { transition: transform 0.2s ease-out; }
  .floating-images-{{ section.id }} .parallax-image:nth-child(5) { transition: transform 0.1s ease-out; }
  .floating-images-{{ section.id }} .parallax-image:nth-child(6) { transition: transform 0.18s ease-out; }
  .floating-images-{{ section.id }} .parallax-image:nth-child(7) { transition: transform 0.14s ease-out; }
  .floating-images-{{ section.id }} .parallax-image:nth-child(8) { transition: transform 0.09s ease-out; }
  .floating-images-{{ section.id }} .parallax-image:nth-child(9) { transition: transform 0.16s ease-out; }
  .floating-images-{{ section.id }} .parallax-image:nth-child(10) { transition: transform 0.11s ease-out; }
  .floating-images-{{ section.id }} .parallax-image:nth-child(11) { transition: transform 0.13s ease-out; }
  .floating-images-{{ section.id }} .parallax-image:nth-child(12) { transition: transform 0.17s ease-out; }

  html.animations-disabled .floating-images-{{ section.id }} .parallax-image {
    transform: translate(-50%, -50%) !important;
  }
</style>

<section
  class="floating-images-{{ section.id }} color-{{ section.settings.color_scheme }} relative"
  data-floating-images-section="{{ section.id }}"
>
  {%- comment -%} Floating Background Images {%- endcomment -%}
  <div class="absolute inset-0 pointer-events-none overflow-hidden">
    {% for block in section.blocks %}
      {% if block.type == 'image' %}
        {%- liquid
          assign index = forloop.index0
          assign pos_index = index | modulo: 11
          assign position_data = positions[pos_index] | split: ','
          assign pos_x = position_data[0]
          assign pos_y = position_data[1]
          assign speed = position_data[2]
          assign base_width = position_data[3]

          # Placeholder names to cycle through
          assign placeholder_names = 'product-1,product-2,product-3,product-4,product-5,product-6,collection-1,collection-2,collection-3,collection-4' | split: ','
          assign placeholder_index = index | modulo: 10
          assign placeholder_name = placeholder_names[placeholder_index]
        -%}

        {% if block.settings.image != blank %}
          <img
            src="{{ block.settings.image | image_url: width: 800 }}"
            srcset="{{ block.settings.image | image_url: width: 200 }} 200w,
                    {{ block.settings.image | image_url: width: 400 }} 400w,
                    {{ block.settings.image | image_url: width: 600 }} 600w,
                    {{ block.settings.image | image_url: width: 800 }} 800w"
            sizes="(max-width: 768px) 150px, (max-width: 1024px) 250px, {{ base_width }}px"
            alt="{{ block.settings.image.alt | default: section.settings.title | default: section.settings.label }}"
            class="parallax-image absolute -translate-x-1/2 -translate-y-1/2 w-[120px] md:w-[180px] lg:w-[{{ base_width | minus: 80 }}px] xl:w-[{{ base_width }}px]"
            data-speed="{{ speed }}"
            style="left: {{ pos_x }}%; top: {{ pos_y }}%;"
            width="{{ block.settings.image.width }}"
            height="{{ block.settings.image.height }}"
            loading="lazy"
            decoding="async"
            {{ block.shopify_attributes }}
          >
        {% else %}
          <div
            class="parallax-image absolute -translate-x-1/2 -translate-y-1/2 w-[120px] md:w-[180px] lg:w-[{{ base_width | minus: 80 }}px] xl:w-[{{ base_width }}px]"
            data-speed="{{ speed }}"
            style="left: {{ pos_x }}%; top: {{ pos_y }}%;"
            {{ block.shopify_attributes }}
          >
            {{ placeholder_name | placeholder_svg_tag: 'w-full h-full' }}
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>

  {%- comment -%} Sticky Content - uses global data-tween system for animations {%- endcomment -%}
  <div class="sticky top-0 h-screen flex items-center justify-center z-10">
    <div class="text-center px-4 max-w-4xl mx-auto" data-tween-group="floating-images-content-{{ section.id }}">
      {% if section.settings.label != blank %}
        <span class="section-label" data-tween data-tween-type="fade-up">
          {{ section.settings.label }}
        </span>
      {% endif %}

      {% if section.settings.title != blank %}
        <h2 class="section-title font-heading mb-6" data-tween data-tween-type="split-text">
          {{ section.settings.title }}
        </h2>
      {% endif %}

      {% if section.settings.description != blank %}
        <p class="section-description mx-auto" data-tween data-tween-type="fade-up">
          {{ section.settings.description }}
        </p>
      {% endif %}

      {% if section.settings.button_text != blank %}
        <div class="mt-8" data-tween data-tween-type="fade-up">
          <a
            href="{{ section.settings.button_link | default: '#' }}"
            class="btn btn--secondary"
          >
            <span>{{ section.settings.button_text }}</span>
            <i class="ph ph-arrow-right"></i>
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<script>
(function() {
  'use strict';

  const sectionId = '{{ section.id }}';
  const section = document.querySelector('[data-floating-images-section="' + sectionId + '"]');
  if (!section) return;

  // Prevent duplicate initialization
  if (section.dataset.initialized) return;
  section.dataset.initialized = 'true';

  const enableParallax = {{ section.settings.enable_parallax | json }};

  // Parallax effect
  if (enableParallax) {
    const images = section.querySelectorAll('.parallax-image');
    let ticking = false;

    function updateParallax() {
      const scrolled = window.pageYOffset;
      const sectionTop = section.offsetTop;
      const sectionHeight = section.offsetHeight;
      const viewportHeight = window.innerHeight;

      // Calculate scroll progress through the section (0 to 1)
      const scrollStart = sectionTop - viewportHeight;
      const scrollEnd = sectionTop + sectionHeight;
      const scrollRange = scrollEnd - scrollStart;
      const progress = Math.max(0, Math.min(1, (scrolled - scrollStart) / scrollRange));

      // Only apply parallax when section is in or near viewport
      if (scrolled + viewportHeight > sectionTop && scrolled < sectionTop + sectionHeight) {
        images.forEach(function(img) {
          const speed = parseFloat(img.dataset.speed) || 0.5;
          // Move images based on scroll progress, scaled by speed
          const yPos = (progress - 0.5) * sectionHeight * speed * 0.5;
          img.style.transform = 'translate(-50%, calc(-50% + ' + yPos + 'px))';
        });
      }

      ticking = false;
    }

    function requestTick() {
      if (!ticking) {
        window.requestAnimationFrame(updateParallax);
        ticking = true;
      }
    }

    window.addEventListener('scroll', requestTick, { passive: true });
    window.addEventListener('resize', requestTick);

    // Initial call
    updateParallax();
  }

  // Header animations handled by global TweenManager via data-tween attributes
})();
</script>

{% schema %}
{
  "name": "Floating Images",
  "tag": "section",
  "class": "floating-images-section",
  "max_blocks": 12,
  "settings": [
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label",
      "default": "Discover"
    },
    {
      "type": "textarea",
      "id": "title",
      "label": "Title",
      "default": "Outstanding products with exceptional brands"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "header",
      "content": "Button"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "View More"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button link"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "section_height",
      "label": "Section height (desktop)",
      "default": 300,
      "min": 200,
      "max": 500,
      "step": 50,
      "unit": "vh",
      "info": "Total height for the scroll effect"
    },
    {
      "type": "range",
      "id": "section_height_mobile",
      "label": "Section height (mobile)",
      "default": 200,
      "min": 150,
      "max": 400,
      "step": 50,
      "unit": "vh"
    },
    {
      "type": "header",
      "content": "Images"
    },
    {
      "type": "range",
      "id": "image_opacity",
      "label": "Image opacity",
      "default": 50,
      "min": 5,
      "max": 100,
      "step": 5,
      "unit": "%",
      "info": "100% = fully visible"
    },
    {
      "type": "checkbox",
      "id": "enable_parallax",
      "label": "Enable parallax effect",
      "default": true,
      "info": "Adds subtle movement to images on scroll"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-3"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Floating Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Add alt text via the image's metadata in Files"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Floating Images",
      "category": "Scrolling & animation",
      "blocks": [
        { "type": "image" },
        { "type": "image" },
        { "type": "image" },
        { "type": "image" },
        { "type": "image" },
        { "type": "image" },
        { "type": "image" },
        { "type": "image" }
      ]
    }
  ]
}
{% endschema %}
