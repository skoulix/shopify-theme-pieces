{%- comment -%}
  Floating Images Section - Sticky content with parallax background images
{%- endcomment -%}

{%- liquid
  assign section_height = section.settings.section_height | default: 300
  assign section_height_mobile = section.settings.section_height_mobile | default: 200
  assign image_opacity_percent = section.settings.image_opacity | default: 15
  assign image_opacity = image_opacity_percent | divided_by: 100.0

  # Predefined positions for floating images (x%, y%, parallax speed, base width in px)
  # Y positions are percentages of section height (0-100), spread throughout section
  assign positions = '12,8,0.3,180|82,15,0.5,280|18,28,0.4,220|75,35,0.6,320|8,48,0.35,200|88,55,0.45,260|25,65,0.5,300|70,72,0.4,240|15,82,0.55,280|55,90,0.3,200|40,45,0.45,260' | split: '|'
-%}

<div
  class="floating-images color-{{ section.settings.color_scheme }}"
  style="--floating-images-height: {{ section_height }}vh; --floating-images-height-mobile: {{ section_height_mobile }}vh; --floating-images-opacity: {{ image_opacity }};"
  data-floating-images-section="{{ section.id }}"
>
  {%- comment -%} Floating Background Images {%- endcomment -%}
  <div class="absolute inset-0 pointer-events-none overflow-hidden">
    {% for block in section.blocks %}
      {% if block.type == 'image' %}
        {%- liquid
          assign index = forloop.index0
          assign pos_index = index | modulo: 11
          assign position_data = positions[pos_index] | split: ','
          assign pos_x = position_data[0]
          assign pos_y = position_data[1]
          assign speed = position_data[2]
          assign base_width = position_data[3]

          # Placeholder names to cycle through
          assign placeholder_names = 'product-1,product-2,product-3,product-4,product-5,product-6,collection-1,collection-2,collection-3,collection-4' | split: ','
          assign placeholder_index = index | modulo: 10
          assign placeholder_name = placeholder_names[placeholder_index]
        -%}

        {% if block.settings.image != blank %}
          <img
            src="{{ block.settings.image | image_url: width: 800 }}"
            srcset="{{ block.settings.image | image_url: width: 200 }} 200w,
                    {{ block.settings.image | image_url: width: 400 }} 400w,
                    {{ block.settings.image | image_url: width: 600 }} 600w,
                    {{ block.settings.image | image_url: width: 800 }} 800w"
            sizes="(max-width: 768px) 150px, (max-width: 1024px) 250px, {{ base_width }}px"
            alt="{{ block.settings.image.alt | default: section.settings.title | default: section.settings.label }}"
            class="parallax-image absolute -translate-x-1/2 -translate-y-1/2 w-[120px] md:w-[180px] lg:w-[{{ base_width | minus: 80 }}px] xl:w-[{{ base_width }}px]"
            data-speed="{{ speed }}"
            style="left: {{ pos_x }}%; top: {{ pos_y }}%;"
            width="{{ block.settings.image.width }}"
            height="{{ block.settings.image.height }}"
            loading="lazy"
            decoding="async"
            {{ block.shopify_attributes }}
          >
        {% else %}
          <div
            class="parallax-image absolute -translate-x-1/2 -translate-y-1/2 w-[120px] md:w-[180px] lg:w-[{{ base_width | minus: 80 }}px] xl:w-[{{ base_width }}px] aspect-square bg-(--color-background-secondary) rounded-(--card-radius) flex items-center justify-center p-4"
            data-speed="{{ speed }}"
            style="left: {{ pos_x }}%; top: {{ pos_y }}%;"
            {{ block.shopify_attributes }}
          >
            {{ placeholder_name | placeholder_svg_tag: 'max-w-full max-h-full' }}
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>

  {%- comment -%} Sticky Content {%- endcomment -%}
  <div class="sticky top-0 h-screen flex items-center justify-center z-10">
    <div class="text-center px-4 max-w-4xl mx-auto" data-tween-group="floating-images-content-{{ section.id }}">
      {% render 'section-header',
        label: section.settings.label,
        title: section.settings.title,
        description: section.settings.description,
        alignment: 'center',
        nowrap: true
      %}

      {% if section.settings.button_text != blank %}
        <div class="mt-8" data-tween data-tween-type="fade-up">
          {% render 'button',
            text: section.settings.button_text,
            url: section.settings.button_link,
            style: section.settings.button_style,
            color: section.settings.button_color,
            size: section.settings.button_size
          %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const sectionId = '{{ section.id }}';
  const section = document.querySelector('[data-floating-images-section="' + sectionId + '"]');
  if (!section) return;

  // Prevent duplicate initialization
  if (section.dataset.initialized) return;
  section.dataset.initialized = 'true';

  const enableParallax = {{ section.settings.enable_parallax | json }};

  // Parallax effect
  if (enableParallax) {
    const images = section.querySelectorAll('.parallax-image');
    let ticking = false;

    function updateParallax() {
      const scrolled = window.pageYOffset;
      const sectionTop = section.offsetTop;
      const sectionHeight = section.offsetHeight;
      const viewportHeight = window.innerHeight;

      // Calculate scroll progress through the section (0 to 1)
      const scrollStart = sectionTop - viewportHeight;
      const scrollEnd = sectionTop + sectionHeight;
      const scrollRange = scrollEnd - scrollStart;
      const progress = Math.max(0, Math.min(1, (scrolled - scrollStart) / scrollRange));

      // Only apply parallax when section is in or near viewport
      if (scrolled + viewportHeight > sectionTop && scrolled < sectionTop + sectionHeight) {
        images.forEach(function(img) {
          const speed = parseFloat(img.dataset.speed) || 0.5;
          // Move images based on scroll progress, scaled by speed
          const yPos = (progress - 0.5) * sectionHeight * speed * 0.5;
          img.style.transform = 'translate(-50%, calc(-50% + ' + yPos + 'px))';
        });
      }

      ticking = false;
    }

    function requestTick() {
      if (!ticking) {
        window.requestAnimationFrame(updateParallax);
        ticking = true;
      }
    }

    window.addEventListener('scroll', requestTick, { passive: true });
    window.addEventListener('resize', requestTick);

    // Initial call
    updateParallax();
  }

  // Header animations handled by global TweenManager via data-tween attributes
})();
</script>

{% schema %}
{
  "name": "t:sections.floating_images.name",
  "tag": "section",
  "class": "floating-images-section",
  "max_blocks": 12,
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.content"
    },
    {
      "type": "text",
      "id": "label",
      "label": "t:sections.floating_images.settings.label.label",
      "default": "t:sections.floating_images.settings.label.default"
    },
    {
      "type": "textarea",
      "id": "title",
      "label": "t:shared.settings.title.label",
      "default": "t:sections.floating_images.settings.title.default"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "t:shared.settings.description.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.button"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "t:shared.settings.button_text.label",
      "default": "t:sections.floating_images.settings.button_text.default"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "t:shared.settings.button_link.label"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "t:shared.settings.button_style.label",
      "default": "outline",
      "options": [
        {
          "value": "solid",
          "label": "t:shared.settings.button_style.options__0.label"
        },
        {
          "value": "outline",
          "label": "t:shared.settings.button_style.options__1.label"
        }
      ]
    },
    {
      "type": "select",
      "id": "button_color",
      "label": "t:shared.settings.button_color.label",
      "default": "primary",
      "options": [
        {
          "value": "primary",
          "label": "t:shared.settings.button_color.options__0.label"
        },
        {
          "value": "secondary",
          "label": "t:shared.settings.button_color.options__1.label"
        }
      ]
    },
    {
      "type": "select",
      "id": "button_size",
      "label": "t:shared.settings.button_size.label",
      "default": "default",
      "options": [
        {
          "value": "small",
          "label": "t:shared.settings.button_size.options__0.label"
        },
        {
          "value": "default",
          "label": "t:shared.settings.button_size.options__1.label"
        },
        {
          "value": "large",
          "label": "t:shared.settings.button_size.options__2.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:shared.headers.layout"
    },
    {
      "type": "range",
      "id": "section_height",
      "label": "t:sections.floating_images.settings.section_height.label",
      "default": 300,
      "min": 200,
      "max": 500,
      "step": 50,
      "unit": "vh",
      "info": "t:sections.floating_images.settings.section_height.info"
    },
    {
      "type": "range",
      "id": "section_height_mobile",
      "label": "t:sections.floating_images.settings.section_height_mobile.label",
      "default": 200,
      "min": 150,
      "max": 400,
      "step": 50,
      "unit": "vh"
    },
    {
      "type": "header",
      "content": "t:shared.headers.images"
    },
    {
      "type": "range",
      "id": "image_opacity",
      "label": "t:sections.floating_images.settings.image_opacity.label",
      "default": 50,
      "min": 5,
      "max": 100,
      "step": 5,
      "unit": "%",
      "info": "t:sections.floating_images.settings.image_opacity.info"
    },
    {
      "type": "checkbox",
      "id": "enable_parallax",
      "label": "t:sections.floating_images.settings.enable_parallax.label",
      "default": true,
      "info": "t:sections.floating_images.settings.enable_parallax.info"
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-3"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "t:sections.floating_images.blocks.image.name",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "t:shared.settings.image.label",
          "info": "t:sections.floating_images.blocks.image.settings.image.info"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.floating_images.presets.floating_images.name",
      "category": "t:sections.floating_images.presets.floating_images.category",
      "blocks": [
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}
