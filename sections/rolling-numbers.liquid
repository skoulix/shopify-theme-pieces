{%- comment -%}
  Rolling Numbers Section
  Animated statistics/metrics display with rolling number animations
  Uses layflags-rolling-number web component
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width
  endcapture
-%}

<style>
  /* Dynamic styles that depend on section settings */
  @media (min-width: 1024px) {
    #shopify-section-{{ section.id }} .rolling-numbers-grid {
      grid-template-columns: repeat({{ section.blocks.size | at_most: 4 }}, 1fr);
    }
  }

  #shopify-section-{{ section.id }} .rolling-numbers-item {
    text-align: {{ section.settings.content_alignment }};
  }

  #shopify-section-{{ section.id }} .rolling-numbers-value {
    justify-content: {{ section.settings.content_alignment }};
  }

  #shopify-section-{{ section.id }} .rolling-numbers-value layflags-rolling-number {
    --roll-duration: {{ section.settings.animation_duration }}ms;
  }

  #shopify-section-{{ section.id }} .rolling-numbers-header {
    text-align: {{ section.settings.content_alignment }};
  }

  #shopify-section-{{ section.id }} .rolling-numbers-description {
    {% if section.settings.content_alignment == 'center' %}
    margin-left: auto;
    margin-right: auto;
    {% elsif section.settings.content_alignment == 'right' %}
    margin-left: auto;
    {% endif %}
  }

  #shopify-section-{{ section.id }} .rolling-numbers-header .section-description {
    {% if section.settings.content_alignment == 'center' %}
    margin-left: auto;
    margin-right: auto;
    {% elsif section.settings.content_alignment == 'right' %}
    margin-left: auto;
    {% endif %}
  }

  /* Reduced motion: disable roll animation */
  @media (prefers-reduced-motion: reduce) {
    #shopify-section-{{ section.id }} .rolling-numbers-value layflags-rolling-number {
      --roll-duration: 0ms;
    }
  }
</style>

<section class="section-padding color-{{ section.settings.color_scheme }}" data-rolling-numbers="{{ section.id }}">
  <div class="{{ container_class }}">
    {% if section.settings.title != blank or section.settings.subtitle != blank %}
      <header class="rolling-numbers-header" data-tween-group="rolling-numbers-header-{{ section.id }}">
        {% if section.settings.title != blank %}
          <h2 class="section-title" data-tween data-tween-type="split-text">{{ section.settings.title }}</h2>
        {% endif %}
        {% if section.settings.subtitle != blank %}
          <p class="section-description" data-tween data-tween-type="fade-up">{{ section.settings.subtitle }}</p>
        {% endif %}
      </header>
    {% endif %}

    <div class="rolling-numbers-grid{% if section.settings.show_dividers %} rolling-numbers-grid--dividers{% endif %}">
      {% for block in section.blocks %}
        <div
          class="rolling-numbers-item"
          data-rolling-item
          style="transition-delay: {{ forloop.index0 | times: 150 }}ms;"
          {{ block.shopify_attributes }}
        >
          <div class="rolling-numbers-value">
            {% if block.settings.prefix != blank %}
              <span class="rolling-numbers-prefix">{{ block.settings.prefix }}</span>
            {% endif %}
            <layflags-rolling-number data-target="{{ block.settings.number }}">0</layflags-rolling-number>
            {% if block.settings.suffix != blank %}
              <span class="rolling-numbers-suffix">{{ block.settings.suffix }}</span>
            {% endif %}
          </div>
          {% if block.settings.label != blank %}
            <p class="rolling-numbers-label text-label">{{ block.settings.label }}</p>
          {% endif %}
          {% if block.settings.description != blank %}
            <p class="rolling-numbers-description">{{ block.settings.description }}</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<script type="module">
  // Load the rolling number web component
  import 'https://unpkg.com/@layflags/rolling-number@1.0.0/rolling-number.js';

  (function() {
    const section = document.querySelector('[data-rolling-numbers="{{ section.id }}"]');
    if (!section || section.dataset.initialized) return;
    section.dataset.initialized = 'true';

    const items = section.querySelectorAll('[data-rolling-item]');
    const rollingNumbers = section.querySelectorAll('layflags-rolling-number');

    // Check if animations should run
    const shouldAnimate = typeof window.shouldAnimate === 'function' ? window.shouldAnimate() : true;

    if (!shouldAnimate) {
      // Show everything immediately without animation
      items.forEach(item => item.classList.add('is-visible'));
      rollingNumbers.forEach(el => {
        const target = el.dataset.target;
        if (target) el.setAttribute('value', target);
      });
      return;
    }

    // Title animations handled by global TweenManager via data-tween attributes

    // Create intersection observer for scroll-triggered animation
    const observerOptions = {
      root: null,
      rootMargin: '0px 0px -10% 0px',
      threshold: 0.1
    };

    let hasAnimated = false;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !hasAnimated) {
          hasAnimated = true;

          // Animate items in
          items.forEach(item => {
            item.classList.add('is-visible');
          });

          // Trigger rolling numbers animation by setting value attribute
          rollingNumbers.forEach((el, index) => {
            const target = el.dataset.target;
            if (target) {
              // Small delay between each number
              setTimeout(() => {
                el.setAttribute('value', target);
              }, index * 100);
            }
          });

          observer.disconnect();
        }
      });
    }, observerOptions);

    observer.observe(section);
  })();
</script>

{% schema %}
{
  "name": "Rolling Numbers",
  "tag": "section",
  "class": "rolling-numbers-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "By the Numbers"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Subtitle"
    },
    {
      "type": "text_alignment",
      "id": "content_alignment",
      "default": "center",
      "label": "Content alignment"
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "range",
      "id": "animation_duration",
      "min": 500,
      "max": 3000,
      "step": 100,
      "default": 1500,
      "unit": "ms",
      "label": "Roll duration",
      "info": "How long the number rolling animation takes"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-3"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "checkbox",
      "id": "show_dividers",
      "default": true,
      "label": "Show dividers between items",
      "info": "Vertical lines between stats on desktop"
    }
  ],
  "blocks": [
    {
      "type": "stat",
      "name": "Statistic",
      "settings": [
        {
          "type": "text",
          "id": "number",
          "label": "Number",
          "default": "100",
          "info": "The target number to animate to"
        },
        {
          "type": "text",
          "id": "prefix",
          "label": "Prefix",
          "info": "Symbol before number (e.g., $, +)"
        },
        {
          "type": "text",
          "id": "suffix",
          "label": "Suffix",
          "info": "Symbol after number (e.g., %, K, M)"
        },
        {
          "type": "text",
          "id": "label",
          "label": "Label",
          "default": "Happy Customers"
        },
        {
          "type": "text",
          "id": "description",
          "label": "Description",
          "info": "Optional short description"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Rolling Numbers",
      "category": "Text & content",
      "blocks": [
        {
          "type": "stat",
          "settings": {
            "number": "50",
            "suffix": "K+",
            "label": "Happy Customers",
            "description": "Worldwide satisfaction"
          }
        },
        {
          "type": "stat",
          "settings": {
            "number": "98",
            "suffix": "%",
            "label": "Satisfaction Rate",
            "description": "Based on reviews"
          }
        },
        {
          "type": "stat",
          "settings": {
            "number": "150",
            "suffix": "+",
            "label": "Countries",
            "description": "Global shipping"
          }
        },
        {
          "type": "stat",
          "settings": {
            "number": "24",
            "suffix": "/7",
            "label": "Support",
            "description": "Always here to help"
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
  }
{% endschema %}
