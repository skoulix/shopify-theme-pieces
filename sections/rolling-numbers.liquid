{%- comment -%}
  Rolling Numbers Section
  Animated statistics/metrics display with rolling number animations
  Uses layflags-rolling-number web component
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture
-%}

<style>
  /* Dynamic styles that depend on section settings */
  @media (min-width: 1024px) {
    #shopify-section-{{ section.id }} .rolling-numbers-grid {
      grid-template-columns: repeat({{ section.blocks.size | at_most: 4 }}, 1fr);
    }
  }

  #shopify-section-{{ section.id }} .rolling-numbers-item {
    text-align: {{ section.settings.content_alignment }};
  }

  #shopify-section-{{ section.id }} .rolling-numbers-value {
    justify-content: {{ section.settings.content_alignment }};
  }

  #shopify-section-{{ section.id }} .rolling-numbers-value layflags-rolling-number {
    --roll-duration: {{ section.settings.animation_duration }}ms;
  }

  #shopify-section-{{ section.id }} .rolling-numbers-item-description {
    {% if section.settings.content_alignment == 'center' %}
    margin-left: auto;
    margin-right: auto;
    {% elsif section.settings.content_alignment == 'right' %}
    margin-left: auto;
    {% endif %}
  }

  /* Reduced motion: disable roll animation */
  @media (prefers-reduced-motion: reduce) {
    #shopify-section-{{ section.id }} .rolling-numbers-value layflags-rolling-number {
      --roll-duration: 0ms;
    }
  }
</style>

<div class="section-padding{% unless section.settings.padding == 'default' %}-{{ section.settings.padding }}{% endunless %} color-{{ section.settings.color_scheme }}" data-rolling-numbers="{{ section.id }}">
  <div class="{{ container_class }}">
    <div class="section-header-spacing">
      {% render 'section-header',
        label: section.settings.label,
        title: section.settings.title,
        description: section.settings.description,
        alignment: section.settings.header_alignment,
        group_id: section.id,
        animate: true
      %}
    </div>

    <div class="rolling-numbers-grid{% if section.settings.show_dividers %} rolling-numbers-grid--dividers{% endif %}">
      {% for block in section.blocks %}
        <div
          class="rolling-numbers-item"
          data-rolling-item
          style="transition-delay: {{ forloop.index0 | times: 150 }}ms;"
          {{ block.shopify_attributes }}
        >
          <div class="rolling-numbers-value">
            {% if block.settings.prefix != blank %}
              <span class="rolling-numbers-prefix">{{ block.settings.prefix }}</span>
            {% endif %}
            <layflags-rolling-number data-target="{{ block.settings.number }}">0</layflags-rolling-number>
            {% if block.settings.suffix != blank %}
              <span class="rolling-numbers-suffix">{{ block.settings.suffix }}</span>
            {% endif %}
          </div>
          {% if block.settings.label != blank %}
            <p class="rolling-numbers-label text-label">{{ block.settings.label }}</p>
          {% endif %}
          {% if block.settings.description != blank %}
            <p class="rolling-numbers-item-description">{{ block.settings.description }}</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script type="module">
  // Load the rolling number web component
  import 'https://unpkg.com/@layflags/rolling-number@1.0.0/rolling-number.js';

  (function() {
    const section = document.querySelector('[data-rolling-numbers="{{ section.id }}"]');
    if (!section || section.dataset.initialized) return;
    section.dataset.initialized = 'true';

    const items = section.querySelectorAll('[data-rolling-item]');
    const rollingNumbers = section.querySelectorAll('layflags-rolling-number');

    // Check if animations should run
    const shouldAnimate = typeof window.shouldAnimate === 'function' ? window.shouldAnimate() : true;

    if (!shouldAnimate) {
      // Show everything immediately without animation
      items.forEach(item => item.classList.add('is-visible'));
      rollingNumbers.forEach(el => {
        const target = el.dataset.target;
        if (target) el.setAttribute('value', target);
      });
      return;
    }

    // Title animations handled by global TweenManager via data-tween attributes

    // Create intersection observer for scroll-triggered animation
    const observerOptions = {
      root: null,
      rootMargin: '0px 0px -10% 0px',
      threshold: 0.1
    };

    let hasAnimated = false;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !hasAnimated) {
          hasAnimated = true;

          // Animate items in
          items.forEach(item => {
            item.classList.add('is-visible');
          });

          // Trigger rolling numbers animation by setting value attribute
          rollingNumbers.forEach((el, index) => {
            const target = el.dataset.target;
            if (target) {
              // Small delay between each number
              setTimeout(() => {
                el.setAttribute('value', target);
              }, index * 100);
            }
          });

          observer.disconnect();
        }
      });
    }, observerOptions);

    observer.observe(section);
  })();
</script>

{% schema %}
{
  "name": "t:sections.rolling_numbers.name",
  "tag": "section",
  "class": "rolling-numbers-section",
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.content"
    },
    {
      "type": "text",
      "id": "label",
      "label": "t:sections.rolling_numbers.settings.label.label"
    },
    {
      "type": "text",
      "id": "title",
      "label": "t:shared.settings.title.label",
      "default": "t:sections.rolling_numbers.settings.title.default"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "t:shared.settings.description.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "t:shared.settings.full_width.label"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "label": "t:shared.settings.header_alignment.label",
      "default": "center"
    },
    {
      "type": "text_alignment",
      "id": "content_alignment",
      "default": "center",
      "label": "t:shared.settings.content_alignment.label"
    },
    {
      "type": "checkbox",
      "id": "show_dividers",
      "default": true,
      "label": "t:sections.rolling_numbers.settings.show_dividers.label",
      "info": "t:sections.rolling_numbers.settings.show_dividers.info"
    },
    {
      "type": "select",
      "id": "padding",
      "label": "t:shared.settings.padding.label",
      "info": "t:shared.settings.padding.info",
      "default": "default",
      "options": [
        {
          "value": "default",
          "label": "t:shared.settings.padding.options__2.label"
        },
        {
          "value": "small",
          "label": "t:shared.settings.padding.options__1.label"
        },
        {
          "value": "large",
          "label": "t:shared.settings.padding.options__3.label"
        },
        {
          "value": "none",
          "label": "t:shared.settings.padding.options__0.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:shared.headers.animation"
    },
    {
      "type": "range",
      "id": "animation_duration",
      "min": 500,
      "max": 3000,
      "step": 100,
      "default": 1500,
      "unit": "ms",
      "label": "t:sections.rolling_numbers.settings.animation_duration.label",
      "info": "t:sections.rolling_numbers.settings.animation_duration.info"
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-3"
    }
  ],
  "blocks": [
    {
      "type": "stat",
      "name": "t:sections.rolling_numbers.blocks.stat.name",
      "settings": [
        {
          "type": "text",
          "id": "number",
          "label": "t:sections.rolling_numbers.blocks.stat.settings.number.label",
          "default": "100",
          "info": "t:sections.rolling_numbers.blocks.stat.settings.number.info"
        },
        {
          "type": "text",
          "id": "prefix",
          "label": "t:sections.rolling_numbers.blocks.stat.settings.prefix.label",
          "info": "t:sections.rolling_numbers.blocks.stat.settings.prefix.info"
        },
        {
          "type": "text",
          "id": "suffix",
          "label": "t:sections.rolling_numbers.blocks.stat.settings.suffix.label",
          "info": "t:sections.rolling_numbers.blocks.stat.settings.suffix.info"
        },
        {
          "type": "text",
          "id": "label",
          "label": "t:sections.rolling_numbers.blocks.stat.settings.label.label",
          "default": "t:sections.rolling_numbers.blocks.stat.settings.label.default"
        },
        {
          "type": "text",
          "id": "description",
          "label": "t:shared.settings.description.label",
          "info": "t:sections.rolling_numbers.blocks.stat.settings.description.info"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.rolling_numbers.presets.rolling_numbers.name",
      "category": "t:sections.rolling_numbers.presets.rolling_numbers.category",
      "settings": {
        "title": "t:sections.rolling_numbers.presets.rolling_numbers.settings.title",
        "description": "t:sections.rolling_numbers.presets.rolling_numbers.settings.description"
      },
      "blocks": [
        {
          "type": "stat",
          "settings": {
            "number": "50",
            "suffix": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.0.suffix",
            "label": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.0.label",
            "description": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.0.description"
          }
        },
        {
          "type": "stat",
          "settings": {
            "number": "98",
            "suffix": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.1.suffix",
            "label": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.1.label",
            "description": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.1.description"
          }
        },
        {
          "type": "stat",
          "settings": {
            "number": "150",
            "suffix": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.2.suffix",
            "label": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.2.label",
            "description": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.2.description"
          }
        },
        {
          "type": "stat",
          "settings": {
            "number": "24",
            "suffix": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.3.suffix",
            "label": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.3.label",
            "description": "t:sections.rolling_numbers.presets.rolling_numbers.blocks.stat.3.description"
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}
