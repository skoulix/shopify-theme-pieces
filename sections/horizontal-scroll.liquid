{%- comment -%}
  Horizontal Scroll Gallery - Codrops-inspired horizontal scroll section
  Scrolls horizontally while the user scrolls vertically
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = ''
  else
    assign container_class = 'page-container'
  endif
-%}

<style>
  .hscroll-section-{{ section.id }} {
    background-color: {{ section.settings.background_color }};
    color: {{ section.settings.text_color }};
  }

  .hscroll-wrapper-{{ section.id }} {
    /* Height = scroll distance (panels * 100vw) + viewport height for sticky */
    /* This ensures enough scroll room even when section is last on page */
    height: calc({{ section.blocks.size | times: 100 }}vw + 100vh);
  }

  .hscroll-sticky-{{ section.id }} {
    position: sticky;
    top: 0;
    height: 100vh;
    overflow: hidden;
  }

  .hscroll-track-{{ section.id }} {
    display: flex;
    height: 100%;
    will-change: transform;
  }

  .hscroll-panel-{{ section.id }} {
    flex-shrink: 0;
    width: 100vw;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .hscroll-intro-{{ section.id }} {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: {% if section.settings.header_alignment == 'center' %}center{% else %}flex-start{% endif %};
    text-align: {{ section.settings.header_alignment }};
    padding: clamp(2rem, 5vw, 6rem);
  }

  .hscroll-label-{{ section.id }} {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    opacity: 0.6;
    margin-bottom: 1.5rem;
  }

  .hscroll-title-{{ section.id }} {
    font-size: calc(clamp(2rem, 6vw, 4rem) * var(--heading-font-scale, 1));
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 0.95;
    max-width: 20ch;
  }

  .hscroll-title-line:nth-child(2) {
    margin-left: clamp(0.5rem, 4vw, 2rem);
  }

  .hscroll-description-{{ section.id }} {
    margin-top: 2rem;
    font-size: clamp(0.875rem, 1.5vw, 1.125rem);
    opacity: 0.7;
    max-width: 40ch;
    line-height: 1.7;
  }

  .hscroll-item-{{ section.id }} {
    position: relative;
    display: block;
    width: 80vw;
    max-width: 900px;
    height: 70vh;
    max-height: 600px;
    overflow: hidden;
    border-radius: {{ settings.card_radius }}px;
    text-decoration: none;
    color: inherit;
  }

  @media (min-width: 1024px) {
    .hscroll-item-{{ section.id }} {
      width: 60vw;
      height: 75vh;
      max-height: 700px;
    }
  }

  .hscroll-item-{{ section.id }} img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .hscroll-item-{{ section.id }}:hover img {
    transform: scale(1.05);
  }

  /* Placeholder styling */
  .hscroll-placeholder-{{ section.id }} {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
  }

  .hscroll-placeholder-{{ section.id }} i {
    font-size: 4rem;
    opacity: 0.15;
    color: #ffffff;
  }

  .hscroll-item-overlay-{{ section.id }} {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 50%);
    pointer-events: none;
  }

  .hscroll-item-content-{{ section.id }} {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: clamp(1.5rem, 3vw, 2.5rem);
    color: #ffffff;
  }

  .hscroll-item-label-{{ section.id }} {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    opacity: 0.7;
    margin-bottom: 0.75rem;
  }

  .hscroll-item-title-{{ section.id }} {
    font-size: clamp(1.25rem, 2.5vw, 2rem);
    font-weight: 700;
    letter-spacing: -0.02em;
    line-height: 1.1;
  }

  .hscroll-item-text-{{ section.id }} {
    margin-top: 0.75rem;
    font-size: 0.875rem;
    opacity: 0.8;
    max-width: 40ch;
    line-height: 1.6;
  }

  .hscroll-counter-{{ section.id }} {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10;
    color: {{ section.settings.text_color }};
  }

  .hscroll-section-{{ section.id }}.is-active .hscroll-counter-{{ section.id }} {
    opacity: 0.5;
  }

  .hscroll-progress-{{ section.id }} {
    position: fixed;
    bottom: 0;
    left: 0;
    height: 3px;
    background: {{ section.settings.text_color }};
    width: 0%;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10;
  }

  .hscroll-section-{{ section.id }}.is-active .hscroll-progress-{{ section.id }} {
    opacity: 0.3;
  }

  /* Animation states */
  html.animations-disabled .hscroll-title-{{ section.id }},
  html.animations-disabled .hscroll-label-{{ section.id }},
  html.animations-disabled .hscroll-description-{{ section.id }} {
    opacity: 1;
    transform: none;
  }
</style>

<section
  class="hscroll-section-{{ section.id }}"
  data-hscroll-section="{{ section.id }}"
>
  <div class="hscroll-wrapper-{{ section.id }}">
    <div class="hscroll-sticky-{{ section.id }}">
      <div class="hscroll-track-{{ section.id }}" data-hscroll-track>
        {%- comment -%} Intro Panel {%- endcomment -%}
        <div class="hscroll-panel-{{ section.id }} hscroll-intro-{{ section.id }} {{ container_class }}">
          <div>
            {% if section.settings.label != blank %}
              <span class="hscroll-label-{{ section.id }}" data-hscroll-label>
                {{ section.settings.label }}
              </span>
            {% endif %}

            {% if section.settings.title != blank %}
              <h2 class="hscroll-title-{{ section.id }} font-heading" data-hscroll-title>
                {{ section.settings.title }}
              </h2>
            {% endif %}

            {% if section.settings.description != blank %}
              <p class="hscroll-description-{{ section.id }}" data-hscroll-description>
                {{ section.settings.description }}
              </p>
            {% endif %}
          </div>
        </div>

        {%- comment -%} Image Panels {%- endcomment -%}
        {% for block in section.blocks %}
          <div class="hscroll-panel-{{ section.id }}" data-hscroll-panel {{ block.shopify_attributes }}>
            {% if block.settings.link != blank %}
              <a href="{{ block.settings.link }}" class="hscroll-item-{{ section.id }}" data-hscroll-item>
            {% else %}
              <div class="hscroll-item-{{ section.id }}" data-hscroll-item>
            {% endif %}
              {% if block.settings.image != blank %}
                {{ block.settings.image | image_url: width: 1600 | image_tag:
                  class: '',
                  loading: 'lazy',
                  sizes: '80vw',
                  widths: '800, 1000, 1200, 1400, 1600'
                }}
              {% else %}
                {%- assign placeholder_id = forloop.index | modulo: 4 | plus: 1 -%}
                {{ 'collection-' | append: placeholder_id | placeholder_svg_tag: 'w-full h-full object-cover' }}
              {% endif %}

              <div class="hscroll-item-overlay-{{ section.id }}"></div>

              <div class="hscroll-item-content-{{ section.id }}">
                {% if block.settings.label != blank %}
                  <span class="hscroll-item-label-{{ section.id }}">{{ block.settings.label }}</span>
                {% endif %}
                {% if block.settings.title != blank %}
                  <h3 class="hscroll-item-title-{{ section.id }} font-heading">{{ block.settings.title }}</h3>
                {% endif %}
                {% if block.settings.text != blank %}
                  <p class="hscroll-item-text-{{ section.id }}">{{ block.settings.text }}</p>
                {% endif %}
              </div>
            {% if block.settings.link != blank %}
              </a>
            {% else %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="hscroll-counter-{{ section.id }}" data-hscroll-counter>
    <span data-hscroll-current>1</span> / <span>{{ section.blocks.size }}</span>
  </div>

  <div class="hscroll-progress-{{ section.id }}" data-hscroll-progress></div>
</section>

<script>
(function() {
  const section = document.querySelector('[data-hscroll-section="{{ section.id }}"]');
  if (!section || section.dataset.hscrollInitialized) return;
  section.dataset.hscrollInitialized = 'true';

  function initHorizontalScroll() {
    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    let SplitText = window.SplitText;
    if (!SplitText && window.pieces && window.pieces.SplitText) {
      SplitText = window.pieces.SplitText;
    }

    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    if (!gsap || !ScrollTrigger) {
      setTimeout(initHorizontalScroll, 50);
      return;
    }

    const track = section.querySelector('[data-hscroll-track]');
    const panels = section.querySelectorAll('[data-hscroll-panel]');
    const items = section.querySelectorAll('[data-hscroll-item]');
    const counter = section.querySelector('[data-hscroll-counter]');
    const currentCounter = section.querySelector('[data-hscroll-current]');
    const progress = section.querySelector('[data-hscroll-progress]');
    const title = section.querySelector('[data-hscroll-title]');
    const label = section.querySelector('[data-hscroll-label]');
    const description = section.querySelector('[data-hscroll-description]');

    const totalPanels = panels.length;
    const scrollDistance = (totalPanels - 1) * window.innerWidth;

    // Check if animations should run
    const shouldAnimate = typeof window.shouldAnimate === 'function' ? window.shouldAnimate() : true;

    // Title animation
    if (shouldAnimate && title && SplitText) {
      const split = new SplitText(title, { type: 'lines', linesClass: 'hscroll-title-line' });

      split.lines.forEach(line => {
        const lineWrapper = document.createElement('div');
        lineWrapper.style.overflow = 'hidden';
        lineWrapper.style.display = 'block';
        line.parentNode.insertBefore(lineWrapper, line);
        lineWrapper.appendChild(line);
      });

      gsap.set(split.lines, { yPercent: 120 });

      gsap.to(split.lines, {
        yPercent: 0,
        duration: 1.2,
        ease: 'power4.out',
        stagger: 0.1,
        scrollTrigger: {
          trigger: section,
          start: 'top 70%',
          once: true
        }
      });
    }

    // Intro elements animation
    if (shouldAnimate) {
      if (label) {
        gsap.set(label, { opacity: 0, y: 20 });
        gsap.to(label, {
          opacity: 0.6,
          y: 0,
          duration: 0.8,
          ease: 'power3.out',
          scrollTrigger: {
            trigger: section,
            start: 'top 70%',
            once: true
          }
        });
      }

      if (description) {
        gsap.set(description, { opacity: 0, y: 30 });
        gsap.to(description, {
          opacity: 0.7,
          y: 0,
          duration: 0.8,
          delay: 0.3,
          ease: 'power3.out',
          scrollTrigger: {
            trigger: section,
            start: 'top 70%',
            once: true
          }
        });
      }
    }

    // Horizontal scroll animation
    const horizontalScroll = gsap.to(track, {
      x: -scrollDistance,
      ease: 'none',
      scrollTrigger: {
        trigger: section,
        start: 'top top',
        end: () => `+=${scrollDistance}`,
        scrub: 1,
        pin: false,
        onUpdate: (self) => {
          // Update counter
          const currentPanel = Math.min(Math.floor(self.progress * totalPanels) + 1, totalPanels);
          if (currentCounter) {
            currentCounter.textContent = Math.max(1, currentPanel - 1) || 1;
          }

          // Update progress bar
          if (progress) {
            progress.style.width = `${self.progress * 100}%`;
          }
        },
        onEnter: () => section.classList.add('is-active'),
        onLeave: () => section.classList.remove('is-active'),
        onEnterBack: () => section.classList.add('is-active'),
        onLeaveBack: () => section.classList.remove('is-active')
      }
    });

    // Parallax effect on items
    if (shouldAnimate) {
      items.forEach((item, i) => {
        gsap.fromTo(item,
          { scale: 0.85, opacity: 0.5 },
          {
            scale: 1,
            opacity: 1,
            ease: 'none',
            scrollTrigger: {
              trigger: section,
              start: () => `top+=${i * window.innerWidth} top`,
              end: () => `top+=${(i + 0.5) * window.innerWidth} top`,
              scrub: true
            }
          }
        );
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHorizontalScroll);
  } else {
    requestAnimationFrame(initHorizontalScroll);
  }

  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('horizontal_scroll_animation', () => {
      requestAnimationFrame(initHorizontalScroll);
    });
  }
})();
</script>

{% schema %}
{
  "name": "Horizontal Scroll",
  "tag": "section",
  "class": "horizontal-scroll-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "default": "Gallery",
      "label": "Label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "Explore Our Collection",
      "label": "Title"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "Scroll to discover our carefully curated selection of products and experiences.",
      "label": "Description"
    },
    {
      "type": "select",
      "id": "header_alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "left",
      "label": "Header alignment"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": true,
      "label": "Full width"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "default": "#000000",
      "label": "Background color"
    },
    {
      "type": "color",
      "id": "text_color",
      "default": "#ffffff",
      "label": "Text color"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "label",
          "default": "Category",
          "label": "Label"
        },
        {
          "type": "text",
          "id": "title",
          "default": "Image Title",
          "label": "Title"
        },
        {
          "type": "textarea",
          "id": "text",
          "default": "A brief description of this image or collection.",
          "label": "Text"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Horizontal Scroll",
      "category": "Scrolling & animation",
      "blocks": [
        { "type": "image", "settings": { "label": "01", "title": "Curated Selection", "text": "Discover our handpicked favorites" } },
        { "type": "image", "settings": { "label": "02", "title": "New Arrivals", "text": "The latest additions to our collection" } },
        { "type": "image", "settings": { "label": "03", "title": "Best Sellers", "text": "Our most loved products" } },
        { "type": "image", "settings": { "label": "04", "title": "Limited Edition", "text": "Exclusive items you won't find elsewhere" } }
      ]
    }
  ]
}
{% endschema %}
