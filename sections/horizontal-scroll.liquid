{%- comment -%}
  Horizontal Scroll Gallery
  Scrolls horizontally while the user scrolls vertically
{%- endcomment -%}

{%- liquid
  # Calculate wrapper height based on block count
  assign panel_count = section.blocks.size | plus: 1
  assign wrapper_height_vw = panel_count | times: 100
-%}

<div
  class="hscroll-section color-{{ section.settings.color_scheme }}"
  data-hscroll-section="{{ section.id }}"
  style="--hscroll-wrapper-height: calc({{ wrapper_height_vw }}vw + 100vh);"
>
  <div class="hscroll-wrapper">
    <div class="hscroll-sticky">
      {%- comment -%} Blurred background images {%- endcomment -%}
      <div class="hscroll-bg" data-hscroll-bg>
        {% for block in section.blocks %}
          {% if block.settings.image != blank %}
            <img
              src="{{ block.settings.image | image_url: width: 800 }}"
              class="hscroll-bg-image"
              loading="lazy"
              decoding="async"
              data-bg-index="{{ forloop.index0 }}"
              width="800"
              height="600"
              alt=""
            >
          {% endif %}
        {% endfor %}
        <div class="hscroll-bg-overlay"></div>
      </div>

      <div class="hscroll-track" data-hscroll-track>
        {%- comment -%} Intro Panel - uses global data-tween system for animations {%- endcomment -%}
        <div class="hscroll-panel hscroll-intro">
          {% render 'section-header',
            label: section.settings.label,
            title: section.settings.title,
            description: section.settings.text,
            group_id: section.id
          %}
        </div>

        {%- comment -%} Image Panels {%- endcomment -%}
        {% for block in section.blocks %}
          <div class="hscroll-panel" data-hscroll-panel {{ block.shopify_attributes }}>
            {% if block.settings.link != blank %}
              <a href="{{ block.settings.link }}" class="hscroll-item" data-hscroll-item>
            {% else %}
              <div class="hscroll-item" data-hscroll-item>
            {% endif %}
              {% if block.settings.image != blank %}
                {{ block.settings.image | image_url: width: 1600 | image_tag:
                  class: '',
                  loading: 'lazy',
                  decoding: 'async',
                  sizes: '80vw',
                  widths: '800, 1000, 1200, 1400, 1600',
                  alt: block.settings.image.alt | default: block.settings.title | default: section.settings.heading
                }}
              {% else %}
                <div class="hscroll-placeholder">
                  {{ 'image' | placeholder_svg_tag }}
                </div>
              {% endif %}

              <div class="hscroll-item-overlay"></div>

              <div class="hscroll-item-content">
                {% if block.settings.label != blank %}
                  <span class="hscroll-item-label text-label">{{ block.settings.label }}</span>
                {% endif %}
                {% if block.settings.title != blank %}
                  <h3 class="hscroll-item-title font-heading">{{ block.settings.title }}</h3>
                {% endif %}
                {% if block.settings.text != blank %}
                  <p class="hscroll-item-text">{{ block.settings.text }}</p>
                {% endif %}
              </div>
            {% if block.settings.link != blank %}
              </a>
            {% else %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="hscroll-counter text-counter" data-hscroll-counter>
    <span data-hscroll-current>1</span> / <span>{{ section.blocks.size }}</span>
  </div>

  <div class="hscroll-progress" data-hscroll-progress></div>
</div>

<script>
(function() {
  const section = document.querySelector('[data-hscroll-section="{{ section.id }}"]');
  if (!section || section.dataset.hscrollInitialized) return;
  section.dataset.hscrollInitialized = 'true';

  function initHorizontalScroll() {
    const gsap = window.gsap || (window.pieces && window.pieces.gsap);
    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    if (!gsap || !ScrollTrigger) {
      setTimeout(initHorizontalScroll, 50);
      return;
    }

    const track = section.querySelector('[data-hscroll-track]');
    const panels = section.querySelectorAll('[data-hscroll-panel]');
    const items = section.querySelectorAll('[data-hscroll-item]');
    const counter = section.querySelector('[data-hscroll-counter]');
    const currentCounter = section.querySelector('[data-hscroll-current]');
    const progress = section.querySelector('[data-hscroll-progress]');
    const bgImages = section.querySelectorAll('[data-bg-index]');

    const totalPanels = panels.length;
    // scrollDistance = panels.length * viewport width (intro panel is not counted in panels)
    const scrollDistance = totalPanels * window.innerWidth;

    let currentBgIndex = -1;

    // Check if animations should run
    const shouldAnimate = typeof window.shouldAnimate === 'function' ? window.shouldAnimate() : true;

    // Header animations handled by global TweenManager via data-tween attributes

    // Horizontal scroll animation
    const horizontalScroll = gsap.to(track, {
      x: -scrollDistance,
      ease: 'none',
      scrollTrigger: {
        trigger: section,
        start: 'top top',
        end: () => `+=${scrollDistance}`,
        scrub: 1,
        pin: false,
        onUpdate: (self) => {
          // Update counter
          const currentPanel = Math.min(Math.floor(self.progress * totalPanels) + 1, totalPanels);
          if (currentCounter) {
            currentCounter.textContent = Math.max(1, currentPanel - 1) || 1;
          }

          // Update progress bar
          if (progress) {
            progress.style.width = `${self.progress * 100}%`;
          }

          // Update blurred background - sync with centered image panel
          // scrollDistance covers all image panels (totalPanels * viewport)
          // At progress 0: intro is visible, first image panel is entering from right
          // At progress 1: last image panel is fully visible
          // Image panel i is most centered when progress = (i + 0.5) / totalPanels
          // But we want bg to show as soon as panel enters, so use floor
          const newBgIndex = Math.floor(self.progress * totalPanels);
          // Clamp to valid range (0 to totalPanels-1)
          const clampedBgIndex = Math.max(0, Math.min(newBgIndex, totalPanels - 1));

          if (clampedBgIndex !== currentBgIndex && bgImages.length > 0) {
            currentBgIndex = clampedBgIndex;
            bgImages.forEach((img, i) => {
              img.classList.toggle('is-active', i === currentBgIndex);
            });
          }
        },
        onEnter: () => section.classList.add('is-active'),
        onLeave: () => {
          section.classList.remove('is-active');
          bgImages.forEach(img => img.classList.remove('is-active'));
          currentBgIndex = -1;
        },
        onEnterBack: () => section.classList.add('is-active'),
        onLeaveBack: () => {
          section.classList.remove('is-active');
          bgImages.forEach(img => img.classList.remove('is-active'));
          currentBgIndex = -1;
        }
      }
    });

    // Parallax effect on items
    if (shouldAnimate) {
      items.forEach((item, i) => {
        gsap.fromTo(item,
          { scale: 0.85, opacity: 0.5 },
          {
            scale: 1,
            opacity: 1,
            ease: 'none',
            scrollTrigger: {
              trigger: section,
              start: () => `top+=${i * window.innerWidth} top`,
              end: () => `top+=${(i + 0.5) * window.innerWidth} top`,
              scrub: true
            }
          }
        );
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHorizontalScroll);
  } else {
    requestAnimationFrame(initHorizontalScroll);
  }

  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('horizontal_scroll_animation', () => {
      requestAnimationFrame(initHorizontalScroll);
    });
  }
})();
</script>

{% schema %}
{
  "name": "t:sections.horizontal_scroll.name",
  "tag": "section",
  "class": "horizontal-scroll-section no-header-offset",
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.content"
    },
    {
      "type": "text",
      "id": "label",
      "default": "t:sections.horizontal_scroll.settings.label.default",
      "label": "t:shared.settings.label.label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "t:sections.horizontal_scroll.settings.title.default",
      "label": "t:shared.settings.title.label"
    },
    {
      "type": "textarea",
      "id": "text",
      "default": "t:sections.horizontal_scroll.settings.text.default",
      "label": "t:shared.settings.text.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-3"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "t:shared.blocks.image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "t:shared.settings.image.label"
        },
        {
          "type": "text",
          "id": "label",
          "default": "t:sections.horizontal_scroll.blocks.image.settings.label.default",
          "label": "t:shared.settings.label.label"
        },
        {
          "type": "text",
          "id": "title",
          "default": "t:sections.horizontal_scroll.blocks.image.settings.title.default",
          "label": "t:shared.settings.title.label"
        },
        {
          "type": "textarea",
          "id": "text",
          "default": "t:sections.horizontal_scroll.blocks.image.settings.text.default",
          "label": "t:shared.settings.text.label"
        },
        {
          "type": "url",
          "id": "link",
          "label": "t:shared.settings.link.label"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.horizontal_scroll.presets.horizontal_scroll.name",
      "category": "t:sections.horizontal_scroll.presets.horizontal_scroll.category",
      "blocks": [
        {
          "type": "image",
          "settings": {
            "label": "01",
            "title": "t:sections.horizontal_scroll.presets.horizontal_scroll.blocks.image.0.title",
            "text": "t:sections.horizontal_scroll.presets.horizontal_scroll.blocks.image.0.text"
          }
        },
        {
          "type": "image",
          "settings": {
            "label": "02",
            "title": "t:sections.horizontal_scroll.presets.horizontal_scroll.blocks.image.1.title",
            "text": "t:sections.horizontal_scroll.presets.horizontal_scroll.blocks.image.1.text"
          }
        },
        {
          "type": "image",
          "settings": {
            "label": "03",
            "title": "t:sections.horizontal_scroll.presets.horizontal_scroll.blocks.image.2.title",
            "text": "t:sections.horizontal_scroll.presets.horizontal_scroll.blocks.image.2.text"
          }
        },
        {
          "type": "image",
          "settings": {
            "label": "04",
            "title": "t:sections.horizontal_scroll.presets.horizontal_scroll.blocks.image.3.title",
            "text": "t:sections.horizontal_scroll.presets.horizontal_scroll.blocks.image.3.text"
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}
