{%- comment -%}
  Horizontal Scroll Gallery - Codrops-inspired horizontal scroll section
  Scrolls horizontally while the user scrolls vertically
{%- endcomment -%}

{%- comment -%}
  Horizontal Scroll Gallery is always full-width by design
{%- endcomment -%}

<style>
  .hscroll-section-{{ section.id }} {
    background-color: var(--color-background);
    color: var(--color-text);
  }

  /* Blurred background layer */
  .hscroll-bg-{{ section.id }} {
    position: absolute;
    inset: 0;
    z-index: 0;
    overflow: hidden;
  }

  .hscroll-bg-image-{{ section.id }} {
    position: absolute;
    inset: -20px;
    width: calc(100% + 40px);
    height: calc(100% + 40px);
    object-fit: cover;
    filter: blur(25px) saturate(1.2);
    opacity: 0;
    transition: opacity 0.6s ease-out;
    transform: scale(1.1);
  }

  .hscroll-bg-image-{{ section.id }}.is-active {
    opacity: 0.4;
  }

  .hscroll-bg-overlay-{{ section.id }} {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to right,
      var(--color-background) 0%,
      transparent 30%,
      transparent 70%,
      var(--color-background) 100%
    );
    z-index: 1;
  }

  .hscroll-wrapper-{{ section.id }} {
    /* Height = scroll distance (intro + image panels * 100vw) + viewport height for sticky */
    /* This ensures enough scroll room even when section is last on page */
    /* blocks.size + 1 accounts for the intro panel */
    height: calc({{ section.blocks.size | plus: 1 | times: 100 }}vw + 100vh);
  }

  .hscroll-sticky-{{ section.id }} {
    position: sticky;
    top: 0;
    height: 100vh;
    overflow: hidden;
  }

  .hscroll-track-{{ section.id }} {
    position: relative;
    z-index: 2;
    display: flex;
    height: 100%;
    will-change: transform;
  }

  .hscroll-panel-{{ section.id }} {
    flex-shrink: 0;
    width: 100vw;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .hscroll-intro-{{ section.id }} {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start;
    text-align: left;
    padding: clamp(2rem, 5vw, 6rem);
  }

  /* Label, title, description use global .section-* classes from utilities.css */
  .hscroll-intro-{{ section.id }} .section-label {
    margin-bottom: 1.5rem;
  }

  .hscroll-intro-{{ section.id }} .section-title {
    max-width: 20ch;
  }

  .hscroll-intro-{{ section.id }} .section-description {
    margin-top: 2rem;
    max-width: 40ch;
  }

  .hscroll-item-{{ section.id }} {
    position: relative;
    display: block;
    width: 80vw;
    max-width: 900px;
    height: 70vh;
    max-height: 600px;
    overflow: hidden;
    border-radius: {{ settings.card_radius }}px;
    text-decoration: none;
    color: inherit;
  }

  @media (min-width: 1024px) {
    .hscroll-item-{{ section.id }} {
      width: 60vw;
      height: 75vh;
      max-height: 700px;
    }
  }

  .hscroll-item-{{ section.id }} img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .hscroll-item-{{ section.id }}:hover img {
    transform: scale(1.05);
  }

  /* Placeholder styling */
  .hscroll-placeholder-{{ section.id }} {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-background-secondary);
  }

  .hscroll-placeholder-{{ section.id }} svg {
    width: 60%;
    height: 60%;
    opacity: 0.3;
  }

  .hscroll-item-overlay-{{ section.id }} {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 50%);
    pointer-events: none;
  }

  .hscroll-item-content-{{ section.id }} {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: clamp(1.5rem, 3vw, 2.5rem);
    color: #ffffff;
  }

  .hscroll-item-label-{{ section.id }} {
    opacity: 0.7;
    margin-bottom: 0.75rem;
  }

  .hscroll-item-title-{{ section.id }} {
    font-size: clamp(1.25rem, 2.5vw, 2rem);
    font-weight: 700;
    letter-spacing: calc(-0.02em + var(--heading-letter-spacing, 0em));
    line-height: 1.1;
  }

  .hscroll-item-text-{{ section.id }} {
    margin-top: 0.75rem;
    font-size: 0.875rem;
    opacity: 0.8;
    max-width: 40ch;
    line-height: 1.6;
  }

  .hscroll-counter-{{ section.id }} {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10;
    color: var(--color-text);
  }

  .hscroll-section-{{ section.id }}.is-active .hscroll-counter-{{ section.id }} {
    opacity: 0.5;
  }

  .hscroll-progress-{{ section.id }} {
    position: fixed;
    bottom: 0;
    left: 0;
    height: 3px;
    background: var(--color-text);
    width: 0%;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10;
  }

  .hscroll-section-{{ section.id }}.is-active .hscroll-progress-{{ section.id }} {
    opacity: 0.3;
  }

</style>

<section
  class="hscroll-section-{{ section.id }} color-{{ section.settings.color_scheme }}"
  data-hscroll-section="{{ section.id }}"
>
  <div class="hscroll-wrapper-{{ section.id }}">
    <div class="hscroll-sticky-{{ section.id }}">
      {%- comment -%} Blurred background images {%- endcomment -%}
      <div class="hscroll-bg-{{ section.id }}" data-hscroll-bg>
        {% for block in section.blocks %}
          {% if block.settings.image != blank %}
            <img
              src="{{ block.settings.image | image_url: width: 800 }}"
              class="hscroll-bg-image-{{ section.id }}"
              loading="lazy"
              decoding="async"
              data-bg-index="{{ forloop.index0 }}"
              width="800"
              height="600"
              alt=""
            >
          {% endif %}
        {% endfor %}
        <div class="hscroll-bg-overlay-{{ section.id }}"></div>
      </div>

      <div class="hscroll-track-{{ section.id }}" data-hscroll-track>
        {%- comment -%} Intro Panel - uses global data-tween system for animations {%- endcomment -%}
        <div class="hscroll-panel-{{ section.id }} hscroll-intro-{{ section.id }}">
          <div data-tween-group="hscroll-header-{{ section.id }}">
            {% if section.settings.label != blank %}
              <span class="section-label" data-tween data-tween-type="fade-up">
                {{ section.settings.label }}
              </span>
            {% endif %}

            {% if section.settings.title != blank %}
              <h2 class="section-title" data-tween data-tween-type="split-text">
                {{ section.settings.title }}
              </h2>
            {% endif %}

            {% if section.settings.description != blank %}
              <p class="section-description" data-tween data-tween-type="fade-up">
                {{ section.settings.description }}
              </p>
            {% endif %}
          </div>
        </div>

        {%- comment -%} Image Panels {%- endcomment -%}
        {% for block in section.blocks %}
          <div class="hscroll-panel-{{ section.id }}" data-hscroll-panel {{ block.shopify_attributes }}>
            {% if block.settings.link != blank %}
              <a href="{{ block.settings.link }}" class="hscroll-item-{{ section.id }}" data-hscroll-item>
            {% else %}
              <div class="hscroll-item-{{ section.id }}" data-hscroll-item>
            {% endif %}
              {% if block.settings.image != blank %}
                {{ block.settings.image | image_url: width: 1600 | image_tag:
                  class: '',
                  loading: 'lazy',
                  decoding: 'async',
                  sizes: '80vw',
                  widths: '800, 1000, 1200, 1400, 1600',
                  alt: block.settings.image.alt | default: block.settings.title | default: section.settings.heading
                }}
              {% else %}
                <div class="hscroll-placeholder-{{ section.id }}">
                  {{ 'image' | placeholder_svg_tag }}
                </div>
              {% endif %}

              <div class="hscroll-item-overlay-{{ section.id }}"></div>

              <div class="hscroll-item-content-{{ section.id }}">
                {% if block.settings.label != blank %}
                  <span class="hscroll-item-label-{{ section.id }} text-label">{{ block.settings.label }}</span>
                {% endif %}
                {% if block.settings.title != blank %}
                  <h3 class="hscroll-item-title-{{ section.id }} font-heading">{{ block.settings.title }}</h3>
                {% endif %}
                {% if block.settings.text != blank %}
                  <p class="hscroll-item-text-{{ section.id }}">{{ block.settings.text }}</p>
                {% endif %}
              </div>
            {% if block.settings.link != blank %}
              </a>
            {% else %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="hscroll-counter-{{ section.id }} text-counter" data-hscroll-counter>
    <span data-hscroll-current>1</span> / <span>{{ section.blocks.size }}</span>
  </div>

  <div class="hscroll-progress-{{ section.id }}" data-hscroll-progress></div>
</section>

<script>
(function() {
  const section = document.querySelector('[data-hscroll-section="{{ section.id }}"]');
  if (!section || section.dataset.hscrollInitialized) return;
  section.dataset.hscrollInitialized = 'true';

  function initHorizontalScroll() {
    const gsap = window.gsap || (window.pieces && window.pieces.gsap);
    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    if (!gsap || !ScrollTrigger) {
      setTimeout(initHorizontalScroll, 50);
      return;
    }

    const track = section.querySelector('[data-hscroll-track]');
    const panels = section.querySelectorAll('[data-hscroll-panel]');
    const items = section.querySelectorAll('[data-hscroll-item]');
    const counter = section.querySelector('[data-hscroll-counter]');
    const currentCounter = section.querySelector('[data-hscroll-current]');
    const progress = section.querySelector('[data-hscroll-progress]');
    const bgImages = section.querySelectorAll('[data-bg-index]');

    const totalPanels = panels.length;
    // scrollDistance = panels.length * viewport width (intro panel is not counted in panels)
    const scrollDistance = totalPanels * window.innerWidth;

    let currentBgIndex = -1;

    // Check if animations should run
    const shouldAnimate = typeof window.shouldAnimate === 'function' ? window.shouldAnimate() : true;

    // Header animations handled by global TweenManager via data-tween attributes

    // Horizontal scroll animation
    const horizontalScroll = gsap.to(track, {
      x: -scrollDistance,
      ease: 'none',
      scrollTrigger: {
        trigger: section,
        start: 'top top',
        end: () => `+=${scrollDistance}`,
        scrub: 1,
        pin: false,
        onUpdate: (self) => {
          // Update counter
          const currentPanel = Math.min(Math.floor(self.progress * totalPanels) + 1, totalPanels);
          if (currentCounter) {
            currentCounter.textContent = Math.max(1, currentPanel - 1) || 1;
          }

          // Update progress bar
          if (progress) {
            progress.style.width = `${self.progress * 100}%`;
          }

          // Update blurred background - sync with centered image panel
          // scrollDistance covers all image panels (totalPanels * viewport)
          // At progress 0: intro is visible, first image panel is entering from right
          // At progress 1: last image panel is fully visible
          // Image panel i is most centered when progress = (i + 0.5) / totalPanels
          // But we want bg to show as soon as panel enters, so use floor
          const newBgIndex = Math.floor(self.progress * totalPanels);
          // Clamp to valid range (0 to totalPanels-1)
          const clampedBgIndex = Math.max(0, Math.min(newBgIndex, totalPanels - 1));

          if (clampedBgIndex !== currentBgIndex && bgImages.length > 0) {
            currentBgIndex = clampedBgIndex;
            bgImages.forEach((img, i) => {
              img.classList.toggle('is-active', i === currentBgIndex);
            });
          }
        },
        onEnter: () => section.classList.add('is-active'),
        onLeave: () => {
          section.classList.remove('is-active');
          bgImages.forEach(img => img.classList.remove('is-active'));
          currentBgIndex = -1;
        },
        onEnterBack: () => section.classList.add('is-active'),
        onLeaveBack: () => {
          section.classList.remove('is-active');
          bgImages.forEach(img => img.classList.remove('is-active'));
          currentBgIndex = -1;
        }
      }
    });

    // Parallax effect on items
    if (shouldAnimate) {
      items.forEach((item, i) => {
        gsap.fromTo(item,
          { scale: 0.85, opacity: 0.5 },
          {
            scale: 1,
            opacity: 1,
            ease: 'none',
            scrollTrigger: {
              trigger: section,
              start: () => `top+=${i * window.innerWidth} top`,
              end: () => `top+=${(i + 0.5) * window.innerWidth} top`,
              scrub: true
            }
          }
        );
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHorizontalScroll);
  } else {
    requestAnimationFrame(initHorizontalScroll);
  }

  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('horizontal_scroll_animation', () => {
      requestAnimationFrame(initHorizontalScroll);
    });
  }
})();
</script>

{% schema %}
{
  "name": "Horizontal Scroll",
  "tag": "section",
  "class": "horizontal-scroll-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "default": "Gallery",
      "label": "Label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "Explore Our Collection",
      "label": "Title"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "Scroll to discover our carefully curated selection of products and experiences.",
      "label": "Description"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-3"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "label",
          "default": "Category",
          "label": "Label"
        },
        {
          "type": "text",
          "id": "title",
          "default": "Image Title",
          "label": "Title"
        },
        {
          "type": "textarea",
          "id": "text",
          "default": "A brief description of this image or collection.",
          "label": "Text"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Horizontal Scroll",
      "category": "Scrolling & animation",
      "blocks": [
        { "type": "image", "settings": { "label": "01", "title": "Curated Selection", "text": "Discover our handpicked favorites" } },
        { "type": "image", "settings": { "label": "02", "title": "New Arrivals", "text": "The latest additions to our collection" } },
        { "type": "image", "settings": { "label": "03", "title": "Best Sellers", "text": "Our most loved products" } },
        { "type": "image", "settings": { "label": "04", "title": "Limited Edition", "text": "Exclusive items you won't find elsewhere" } }
      ]
    }
  ]
}
{% endschema %}
