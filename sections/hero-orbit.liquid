{%- comment -%}
  Hero Orbit Section
  Three animation styles: Orbit, Cascade, Spiral
{%- endcomment -%}

{%- liquid
  assign overlay_opacity = section.settings.overlay_opacity | divided_by: 100.0
-%}

<style>
  #hero-orbit-{{ section.id }} {
    --hero-orbit-card-bg: {{ section.settings.card_background }};
    --hero-orbit-image-fit: {{ section.settings.image_fit }};
    --hero-orbit-overlay-color: {{ section.settings.overlay_color }};
    --hero-orbit-overlay-opacity: {{ overlay_opacity }};
  }
  {% if section.settings.background_image_blur > 0 %}
  #hero-orbit-{{ section.id }} .hero-orbit-bg img {
    filter: blur({{ section.settings.background_image_blur }}px);
    transform: scale(1.1);
  }
  {% endif %}
  #hero-orbit-{{ section.id }} .hero-orbit-bg img {
    object-position: {{ section.settings.background_image_position }};
  }
</style>

<section
  id="hero-orbit-{{ section.id }}"
  class="hero-orbit color-{{ section.settings.color_scheme }} is-loading"
  data-hero-orbit="{{ section.id }}"
  data-animation-style="{{ section.settings.animation_style }}">
  {% if section.settings.background_image != blank %}
    <div class="hero-orbit-bg">
      {{ section.settings.background_image | image_url: width: 2000 | image_tag: loading: 'eager', decoding: 'async', fetchpriority: 'high', sizes: '100vw', widths: '600, 1000, 1400, 1800, 2000' }}
    </div>
  {% endif %}

  <div class="hero-orbit-scene" data-orbit-scene>
    <div class="hero-orbit-container" data-orbit-container>
      <div class="hero-orbit-group" data-orbit-group>
        {% for block in section.blocks %}
          <div
            class="hero-orbit-card"
            data-orbit-card="{{ forloop.index0 }}"
            {{ block.shopify_attributes }}>
            <div class="hero-orbit-card-inner">
              {% if block.settings.image != blank %}
                <img
                  class="hero-orbit-card-img"
                  src="{{ block.settings.image | image_url: width: 400 }}"
                  alt="{{ block.settings.image.alt | escape }}"
                  width="{{ block.settings.image.width }}"
                  height="{{ block.settings.image.height }}"
                  loading="eager"
                  decoding="async">
              {% else %}
                {%- assign placeholder_index = forloop.index | modulo: 6 | plus: 1 -%}
                {{ 'product-' | append: placeholder_index | placeholder_svg_tag: 'hero-orbit-card-img' }}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  {% if section.settings.overlay_opacity > 0 %}
    <div class="hero-orbit-overlay"></div>
  {% endif %}

  <div class="hero-orbit-content">
    <div class="hero-orbit-headings">
      {% if section.settings.title_line_1 != blank %}
        <h1 class="hero-orbit-title font-heading" data-orbit-title>
          {{ section.settings.title_line_1 }}
        </h1>
      {% endif %}

      {% if section.settings.title_line_2 != blank %}
        <h1 class="hero-orbit-title font-heading" data-orbit-title>
          {{ section.settings.title_line_2 }}
        </h1>
      {% endif %}

      {% if section.settings.subtitle != blank %}
        <p class="hero-orbit-subtitle text-label text-balance max-w-6xl" data-orbit-subtitle>
          {{ section.settings.subtitle }}
        </p>
      {% endif %}
    </div>

    {% if section.settings.button_text != blank and section.settings.button_link != blank %}
      <div class="hero-orbit-cta" data-orbit-cta>
        <a href="{{ section.settings.button_link }}" class="btn{%- render 'button-class', style: section.settings.button_style, color: section.settings.button_color -%}{% if section.settings.button_size == 'small' %} btn--sm{% elsif section.settings.button_size == 'large' %} btn--lg{% endif %}">
          <span>{{ section.settings.button_text }}</span>
          <i class="ph ph-arrow-right"></i>
        </a>
      </div>
    {% endif %}
  </div>

  {% if section.settings.show_scroll_indicator %}
    <div class="hero-orbit-scroll" data-orbit-scroll>
      <span class="text-label-sm">{{ 'accessibility.scroll_down' | t }}</span>
      <i class="ph ph-caret-down"></i>
    </div>
  {% endif %}
</section>

<script>
  (function() {
  const section = document.querySelector('[data-hero-orbit="{{ section.id }}"]');
  if (!section || section.dataset.heroOrbitInitialized) return;
  section.dataset.heroOrbitInitialized = 'true';

  const animationStyle = section.dataset.animationStyle || 'orbit';

  function initAnimation() {
    const gsap = window.gsap || (window.pieces && window.pieces.gsap);
    if (!gsap) {
      setTimeout(initAnimation, 50);
      return;
    }

    const group = section.querySelector('[data-orbit-group]');
    const cards = section.querySelectorAll('[data-orbit-card]');
    const titles = section.querySelectorAll('[data-orbit-title]');
    const subtitle = section.querySelector('[data-orbit-subtitle]');
    const cta = section.querySelector('[data-orbit-cta]');
    const scroll = section.querySelector('[data-orbit-scroll]');

    const cardCount = cards.length;
    if (cardCount === 0) return;

    // Get card dimensions for calculations
    const cardImg = cards[0]?.querySelector('div');
    const cardHeight = cardImg?.offsetHeight || 180;

    // Responsive radius
    const isMobile = window.innerWidth < 768;
    const radius = isMobile ? Math.min(window.innerWidth * 0.35, 150) : Math.min(window.innerWidth * 0.25, 280);
    const radius2 = isMobile ? Math.min(window.innerWidth * 0.3, 130) : Math.min(window.innerWidth * 0.2, 220);

    // Calculate positions for each card in a circle
    const sliceAngle = (2 * Math.PI) / cardCount;
    const cardTilt = {{ section.settings.card_tilt }};

    // Preload images
    const images = section.querySelectorAll('[data-orbit-card] img');
    let loadedCount = 0;
    const totalImages = images.length || 1;

    function checkAllLoaded() {
      loadedCount++;
      if (loadedCount >= totalImages) {
        runAnimation();
      }
    }

    // Check if images are already loaded or wait for them
    if (images.length === 0) {
      // No images, just placeholders
      runAnimation();
    } else {
      images.forEach(img => {
        if (img.complete) {
          checkAllLoaded();
        } else {
          img.addEventListener('load', checkAllLoaded, { once: true });
          img.addEventListener('error', checkAllLoaded, { once: true });
        }
      });
    }

    function runAnimation() {
      section.classList.remove('is-loading');

      switch(animationStyle) {
        case 'cascade':
          runCascadeAnimation();
          break;
        case 'spiral':
          runSpiralAnimation();
          break;
        default:
          runOrbitAnimation();
      }
    }

    // Animation Style 1: Orbit - Cards expand from center in a circle
    function runOrbitAnimation() {
      const tl = gsap.timeline();
      const entranceDuration = 1.2;
      const staggerDelay = 0.08;

      // Set initial card states
      cards.forEach((card) => {
        gsap.set(card, {
          opacity: 0,
          scale: 0,
          x: 0,
          y: 0,
          rotation: 0
        });
      });

      // Animate cards from center to circular positions
      cards.forEach((card, index) => {
        const angle = sliceAngle * index - Math.PI / 2; // Start from top
        const x = radius * Math.cos(angle);
        const y = radius * Math.sin(angle);

        tl.to(card, {
          opacity: 1,
          scale: 1,
          x: x,
          y: y,
          rotation: cardTilt,
          duration: entranceDuration,
          ease: 'expo.out'
        }, index * staggerDelay);
      });

      animateContent(tl, 0.6);

      // Start continuous animation after entrance completes
      tl.add(() => {
        setupContinuousAnimation();
      });
    }

    // Animation Style 2: Cascade - Cards flip up from below with 3D rotation
    function runCascadeAnimation() {
      const tl = gsap.timeline();
      const viewportHeight = window.innerHeight;

      // Set initial card states - below viewport with rotation
      cards.forEach((card) => {
        gsap.set(card, {
          opacity: 0,
          y: viewportHeight / 2 + cardHeight * 1.5,
          rotateX: -180,
          scale: 2.5
        });
      });

      // Phase 1: Cards flip up from below
      cards.forEach((card, index) => {
        tl.to(card, {
          opacity: 1,
          y: -radius,
          rotateX: 0,
          scale: 1,
          duration: 0.6,
          ease: 'power2.out'
        }, index * 0.1);
      });

      // Phase 2: Cards spread into circle
      cards.forEach((card, index) => {
        const angle = sliceAngle * index - Math.PI / 4;
        const x = radius2 * Math.cos(angle);
        const y = radius2 * Math.sin(angle) - radius * 0.3;

        tl.to(card, {
          x: x,
          y: y,
          rotation: cardTilt,
          duration: 1,
          ease: 'expo.out'
        }, 0.6 + index * 0.05);
      });

      // Phase 3: Flip cards
      cards.forEach((card, index) => {
        const cardInner = card.querySelector('div');
        if (cardInner) {
          tl.to(cardInner, {
            rotationY: 180,
            duration: 0.8,
            ease: 'power2.inOut'
          }, 1.2 + index * 0.05);
        }
      });

      animateContent(tl, 1.4);

      // Start continuous animation after entrance completes
      tl.add(() => {
        setupContinuousAnimation();
      });
    }

    // Animation Style 3: Spiral - Cards enter from sides and spiral in
    function runSpiralAnimation() {
      const tl = gsap.timeline();
      const viewportWidth = window.innerWidth;

      // Set initial card states - off screen left/right alternating
      cards.forEach((card, index) => {
        const isOdd = index % 2 === 1;
        gsap.set(card, {
          opacity: 0,
          x: isOdd ? -viewportWidth / 2 : viewportWidth / 2,
          y: 0,
          rotation: isOdd ? -90 : 90,
          scale: 3
        });
      });

      // Phase 1: Cards fly in from sides with stagger
      cards.forEach((card, index) => {
        const pairIndex = Math.floor(index / 2);
        tl.to(card, {
          opacity: 1,
          x: 0,
          rotation: 0,
          scale: 1,
          duration: 0.7,
          ease: 'power3.out'
        }, pairIndex * 0.15);
      });

      // Phase 2: Cards move to top position
      cards.forEach((card, index) => {
        tl.to(card, {
          y: -radius,
          duration: 0.5,
          ease: 'power2.out'
        }, 0.8);
      });

      // Phase 3: Cards spiral into circle formation
      cards.forEach((card, index) => {
        const angle = sliceAngle * index - Math.PI / 2;
        const x = radius * Math.cos(angle);
        const y = radius * Math.sin(angle);

        tl.to(card, {
          x: x,
          y: y,
          rotation: cardTilt,
          duration: 1.2,
          ease: 'expo.out'
        }, 1.3 + index * 0.06);
      });

      animateContent(tl, 1.6);

      // Start continuous animation after entrance completes
      tl.add(() => {
        setupContinuousAnimation();
      });
    }

    // Animate text content
    function animateContent(tl, startTime) {
      // Fade in titles with blur removal
      if (titles.length) {
        tl.to(titles, {
          opacity: 1,
          filter: 'blur(0px)',
          duration: 0.8,
          stagger: 0.1,
          ease: 'power2.out'
        }, startTime);
      }

      // Fade in subtitle
      if (subtitle) {
        tl.to(subtitle, {
          opacity: 1,
          filter: 'blur(0px)',
          duration: 0.6,
          ease: 'power2.out'
        }, startTime + 0.3);
      }

      // Fade in CTA
      if (cta) {
        tl.to(cta, {
          opacity: 1,
          y: 0,
          duration: 0.6,
          ease: 'power2.out'
        }, startTime + 0.4);
      }

      // Fade in scroll indicator
      if (scroll) {
        tl.to(scroll, {
          opacity: 0.6,
          duration: 0.6,
          ease: 'power2.out'
        }, startTime + 0.6);
      }
    }

    // Setup continuous animations
    function setupContinuousAnimation() {
      // Continuous slow rotation
      {% if section.settings.enable_rotation %}
      gsap.to(group, {
        rotation: '-=360',
        duration: {{ section.settings.rotation_speed }},
        ease: 'none',
        repeat: -1
      });

      // Counter-rotate cards to keep them upright while preserving their tilt
      cards.forEach((card, index) => {
        gsap.to(card, {
          rotation: '+=' + 360,
          duration: {{ section.settings.rotation_speed }},
          ease: 'none',
          repeat: -1
        });
      });
      {% endif %}

      // Random card flip effect
      {% if section.settings.enable_flip %}
      function flipRandomCard() {
        const randomIndex = Math.floor(Math.random() * cardCount);
        const card = cards[randomIndex];
        const cardInner = card.querySelector('div');

        if (cardInner) {
          gsap.to(cardInner, {
            rotationY: '+=180',
            duration: 0.6,
            ease: 'power2.inOut'
          });
        }
      }

      // Flip a random card every 2 seconds
      const flipInterval = setInterval(flipRandomCard, 2000);

      // Cleanup on Swup navigation
      window.addEventListener('swup:willReplaceContent', function cleanup() {
        clearInterval(flipInterval);
        window.removeEventListener('swup:willReplaceContent', cleanup);
      }, { once: true });
      {% endif %}
    }
  }

  // Start when ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimation);
  } else {
    initAnimation();
  }
  })();
</script>

{% schema %}
  {
    "name": "Hero Orbit",
    "tag": "section",
    "class": "hero-orbit-section",
    "settings": [
      {
        "type": "header",
        "content": "Content"
      },
      {
        "type": "text",
        "id": "title_line_1",
        "default": "Celestial",
        "label": "Title line 1"
      },
      {
        "type": "text",
        "id": "title_line_2",
        "default": "Visions",
        "label": "Title line 2"
      },
      {
        "type": "text",
        "id": "subtitle",
        "default": "2024",
        "label": "Subtitle"
      },
      {
        "type": "text",
        "id": "button_text",
        "label": "Button text"
      },
      {
        "type": "url",
        "id": "button_link",
        "label": "Button link"
      },
      {
        "type": "select",
        "id": "button_style",
        "label": "Button style",
        "default": "outline",
        "options": [
          {
            "value": "solid",
            "label": "Solid"
          },
          {
            "value": "outline",
            "label": "Outline"
          }
        ]
      },
      {
        "type": "select",
        "id": "button_color",
        "label": "Button color",
        "default": "primary",
        "options": [
          {
            "value": "primary",
            "label": "Primary (accent)"
          },
          {
            "value": "secondary",
            "label": "Secondary (neutral)"
          }
        ]
      },
      {
        "type": "select",
        "id": "button_size",
        "label": "Button size",
        "options": [
          {
            "value": "small",
            "label": "Small"
          },
          {
            "value": "default",
            "label": "Default"
          },
          {
            "value": "large",
            "label": "Large"
          }
        ],
        "default": "large"
      },
      {
        "type": "checkbox",
        "id": "show_scroll_indicator",
        "default": true,
        "label": "Show scroll indicator"
      },
      {
        "type": "header",
        "content": "Animation"
      },
      {
        "type": "select",
        "id": "animation_style",
        "label": "Animation style",
        "options": [
          {
            "value": "orbit",
            "label": "Orbit - Expand from center"
          },
          {
            "value": "cascade",
            "label": "Cascade - Flip up from below"
          },
          {
            "value": "spiral",
            "label": "Spiral - Enter from sides"
          }
        ],
        "default": "orbit",
        "info": "Choose how images animate into the circle"
      },
      {
        "type": "checkbox",
        "id": "enable_rotation",
        "default": true,
        "label": "Enable continuous rotation"
      },
      {
        "type": "range",
        "id": "rotation_speed",
        "min": 20,
        "max": 120,
        "step": 10,
        "default": 60,
        "unit": "s",
        "label": "Rotation speed",
        "info": "Time for one full rotation"
      },
      {
        "type": "checkbox",
        "id": "enable_flip",
        "default": true,
        "label": "Enable random card flips"
      },
      {
        "type": "header",
        "content": "Colors"
      },
      {
        "type": "color_scheme",
        "id": "color_scheme",
        "label": "Color scheme",
        "default": "scheme-3"
      },
      {
        "type": "image_picker",
        "id": "background_image",
        "label": "Background image"
      },
      {
        "type": "select",
        "id": "background_image_position",
        "label": "Background image position",
        "options": [
          {
            "value": "top left",
            "label": "Top left"
          },
          {
            "value": "top center",
            "label": "Top center"
          },
          {
            "value": "top right",
            "label": "Top right"
          },
          {
            "value": "center left",
            "label": "Center left"
          },
          {
            "value": "center center",
            "label": "Center"
          },
          {
            "value": "center right",
            "label": "Center right"
          },
          {
            "value": "bottom left",
            "label": "Bottom left"
          },
          {
            "value": "bottom center",
            "label": "Bottom center"
          },
          {
            "value": "bottom right",
            "label": "Bottom right"
          }
        ],
        "default": "center center"
      },
      {
        "type": "range",
        "id": "background_image_blur",
        "min": 0,
        "max": 20,
        "step": 1,
        "default": 0,
        "unit": "px",
        "label": "Background image blur"
      },
      {
        "type": "color",
        "id": "overlay_color",
        "default": "#000000",
        "label": "Overlay color"
      },
      {
        "type": "range",
        "id": "overlay_opacity",
        "min": 0,
        "max": 100,
        "step": 5,
        "default": 40,
        "unit": "%",
        "label": "Overlay opacity",
        "info": "Darkens the background for better text readability"
      },
      {
        "type": "header",
        "content": "Cards"
      },
      {
        "type": "color",
        "id": "card_background",
        "label": "Card background",
        "default": "#ffffff"
      },
      {
        "type": "select",
        "id": "image_fit",
        "label": "Image fit",
        "options": [
          {
            "value": "cover",
            "label": "Cover"
          },
          {
            "value": "contain",
            "label": "Contain"
          }
        ],
        "default": "cover",
        "info": "Cover fills the card, Contain shows the full image"
      },
      {
        "type": "range",
        "id": "card_tilt",
        "min": -30,
        "max": 30,
        "step": 1,
        "default": -15,
        "unit": "Â°",
        "label": "Card tilt",
        "info": "Subtle creative tilt applied to all cards"
      }
    ],
    "blocks": [
      {
        "type": "image",
        "name": "Image",
        "settings": [
          {
            "type": "image_picker",
            "id": "image",
            "label": "Image"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Hero Orbit",
        "category": "Image & media",
        "blocks": [
          {
            "type": "image"
          },
          {
            "type": "image"
          },
          {
            "type": "image"
          },
          {
            "type": "image"
          },
          {
            "type": "image"
          },
          {
            "type": "image"
          },
          {
            "type": "image"
          },
          {
            "type": "image"
          }
        ]
      }
    ]
  }
{% endschema %}