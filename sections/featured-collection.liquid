{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif

  assign collection = section.settings.collection
  assign products_to_show = section.settings.products_to_show
-%}

<style>
  .fc-{{ section.id }} .fc-title { font-size: calc(clamp(1.75rem, 7vw, 3rem) * var(--heading-font-scale, 1)); }
  @media (min-width: 1024px) { .fc-{{ section.id }} .fc-title { font-size: calc(clamp(2.5rem, 5vw, 4rem) * var(--heading-font-scale, 1)); } }
  @media (min-width: 1536px) { .fc-{{ section.id }} .fc-title { font-size: calc(clamp(3rem, 4vw, 4.5rem) * var(--heading-font-scale, 1)); } }
  .fc-title-line:nth-child(2) { margin-left: clamp(1rem, 6vw, 4rem); }
  /* Hide title initially to prevent FOUC before SplitText animation */
  [data-fc-title] { opacity: 0; }
  html.animations-disabled [data-fc-title] { opacity: 1; }
  @media (min-width: 1024px) { .fc-{{ section.id }} .fc-grid { grid-template-columns: repeat({{ section.settings.columns }}, 1fr); } }
  /* Initial clip-path state for swipe animation */
  .fc-{{ section.id }} .product-card-image { clip-path: inset(0 100% 0 0); }
  html.animations-disabled .fc-{{ section.id }} .product-card-image { clip-path: none; }
</style>

<section
  class="fc-{{ section.id }} py-[--section-vertical-padding] bg-[--color-background]"
  data-featured-collection="{{ section.id }}"
>
  <div class="{{ container_class }}">
    {%- comment -%} Header {%- endcomment -%}
    <header class="mb-[clamp(2rem,5vh,4rem)] flex flex-col gap-4 {% if section.settings.header_alignment == 'center' %}items-center text-center{% elsif section.settings.header_alignment == 'right' %}items-end text-right{% else %}md:flex-row md:justify-between md:items-end{% endif %}">
      <h2 class="fc-title font-bold tracking-tight leading-none text-[--color-text] font-heading" data-fc-title>
        {% if section.settings.title != blank %}
          {{ section.settings.title }}
        {% else %}
          {{ collection.title | default: 'Featured' }}
        {% endif %}
      </h2>

      {% if section.settings.show_view_all and collection %}
        <a href="{{ collection.url }}" class="text-hover-reveal inline-flex items-center gap-2 text-xs font-semibold tracking-[0.1em] text-[--color-text] opacity-70 hover:opacity-100 transition-opacity duration-300" data-intro>
          <span data-hover="{{ section.settings.view_all_text }}">{{ section.settings.view_all_text }}</span>
          <span class="sr-only">{{ collection.title }}</span>
          <i class="ph ph-arrow-right" aria-hidden="true"></i>
        </a>
      {% endif %}
    </header>

    {%- comment -%} Product Grid {%- endcomment -%}
    <div class="fc-grid grid grid-cols-2 md:grid-cols-3 gap-[clamp(1rem,3vw,2rem)]" data-fc-grid>
      {% if collection != blank %}
        {% for product in collection.products limit: products_to_show %}
          {% render 'product-card',
            product: product,
            collection: collection,
            index: forloop.index0,
            show_vendor: section.settings.show_vendor,
            lazy_load: true
          %}
        {% endfor %}
      {% else %}
        {%- comment -%} Placeholder cards when no collection selected {%- endcomment -%}
        {% for i in (1..products_to_show) %}
          {%- assign placeholder_index = forloop.index | modulo: 6 | plus: 1 -%}
          <div class="product-card flex flex-col cursor-pointer rounded-[--card-radius] overflow-hidden h-full" style="border: var(--card-border-width) solid var(--color-border); box-shadow: var(--card-shadow);" data-product-card="{{ forloop.index0 }}">
            <div class="product-card-image relative overflow-hidden aspect-[3/4]">
              {{ 'product-' | append: placeholder_index | placeholder_svg_tag: 'w-full h-full object-cover' }}
            </div>
            <div class="product-card-content flex-1 p-4 bg-[--color-background]">
              <h3 class="product-card-title mt-2 text-xs md:text-sm font-semibold tracking-wide text-[--color-text] font-heading">
                <span class="overflow-hidden inline-block"><span class="inline-block">{{ 'sections.featured_collection.placeholder_product' | t }}</span></span> <span class="overflow-hidden inline-block"><span class="inline-block">{{ forloop.index }}</span></span>
              </h3>
              <div class="product-card-price mt-2 text-sm text-[--color-text-secondary]">
                <span class="overflow-hidden inline-block"><span class="inline-block">$99.00</span></span>
              </div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>
</section>

<script>
  (function() {
    const section = document.querySelector('[data-featured-collection="{{ section.id }}"]');
    if (!section || section.dataset.fcAnimInitialized) return;
    section.dataset.fcAnimInitialized = 'true';

    // If animations disabled, skip
    if (typeof window.shouldAnimate === 'function' && !window.shouldAnimate()) return;

    function initAnimation() {
      // Get gsap from window.pieces or window
      if (typeof gsap === 'undefined') {
        if (window.pieces && window.pieces.gsap) {
          window.gsap = window.pieces.gsap;
        } else {
          requestAnimationFrame(initAnimation);
          return;
        }
      }

      // Get SplitText from pieces or window
      let SplitText = window.SplitText;
      if (!SplitText && window.pieces && window.pieces.SplitText) {
        SplitText = window.pieces.SplitText;
      }

      // Get ScrollTrigger from window.pieces or window
      const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);
      if (!ScrollTrigger || !SplitText) {
        requestAnimationFrame(initAnimation);
        return;
      }

      // Mark section as ready for animations
      section.dataset.fcAnimReady = 'true';

      const title = section.querySelector('[data-fc-title]');
      const cards = section.querySelectorAll('[data-product-card]');
      const scrollStart = window.getScrollStart ? window.getScrollStart('top 85%') : 'top 85%';

      // Animate title with SplitText line reveal
      if (title) {
        const split = new SplitText(title, { type: 'lines', linesClass: 'fc-title-line' });

        // Wrap each line in an overflow-hidden container for the reveal effect
        split.lines.forEach(line => {
          const lineWrapper = document.createElement('div');
          lineWrapper.style.overflow = 'hidden';
          lineWrapper.style.display = 'block';
          line.parentNode.insertBefore(lineWrapper, line);
          lineWrapper.appendChild(line);
        });

        gsap.set(split.lines, { yPercent: 120 });
        title.style.opacity = 1;

        gsap.to(split.lines, {
          yPercent: 0,
          duration: 1.2,
          ease: 'power4.out',
          stagger: 0.1,
          scrollTrigger: {
            trigger: section,
            start: scrollStart,
            once: true
          }
        });
      }

      // Animate product card images with clip-path swipe (initial state set in CSS)
      cards.forEach((card, index) => {
        const image = card.querySelector('.product-card-image');
        if (!image) return;

        // Stagger based on column position
        const delay = (index % {{ section.settings.columns }}) * 0.1;

        gsap.to(image, {
          clipPath: 'inset(0 0% 0 0)',
          duration: 1.2,
          ease: 'power3.out',
          delay: delay,
          scrollTrigger: {
            trigger: card,
            start: scrollStart,
            once: true
          }
        });
      });
    }

    requestAnimationFrame(initAnimation);
  })();
</script>

{% schema %}
{
  "name": "Featured Collection",
  "tag": "section",
  "class": "featured-collection-wrapper",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "info": "Leave blank to use collection title"
    },
    {
      "type": "select",
      "id": "header_alignment",
      "label": "Header alignment",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4,
      "label": "Products to show"
    },
    {
      "type": "range",
      "id": "columns",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4,
      "label": "Columns (desktop)"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "Show vendor"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "default": true,
      "label": "Show 'View All' link"
    },
    {
      "type": "text",
      "id": "view_all_text",
      "default": "View All",
      "label": "View all text"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    }
  ],
  "presets": [
    {
      "name": "Featured Collection",
      "category": "Products"
    }
  ]
}
{% endschema %}
