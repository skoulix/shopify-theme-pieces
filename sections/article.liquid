{%- comment -%}
  Article Section - Modern Editorial Layout
  Awwwards-style design with creative typography and animations
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'px-4 md:px-8'
  else
    assign container_class = 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8'
  endif
-%}

<style>
  /* Reading Progress Bar */
  .article-progress {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    z-index: 9999;
    background: transparent;
    pointer-events: none;
  }

  .article-progress-bar {
    height: 100%;
    width: 0%;
    background: var(--color-primary);
    transition: width 0.1s ease-out;
  }

  /* Article Hero */
  .article-hero {
    position: relative;
    padding: 6rem 0 4rem;
  }

  .article-hero-back {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-secondary);
    margin-bottom: 3rem;
    transition: gap 0.3s ease;
  }

  .article-hero-back:hover {
    gap: 0.75rem;
  }

  .article-hero-back i {
    transition: transform 0.3s ease;
  }

  .article-hero-back:hover i {
    transform: translateX(-2px);
  }

  .article-hero-category {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .article-hero-category::before {
    content: '';
    width: 2rem;
    height: 1px;
    background: var(--color-text-secondary);
  }

  .article-hero-title {
    font-size: clamp(1.75rem, 5vw, 2.75rem);
    font-weight: 700;
    line-height: 1.05;
    letter-spacing: -0.03em;
    color: var(--color-text);
    max-width: 900px;
  }

  @media (min-width: 1024px) {
    .article-hero-title {
      font-size: clamp(2.5rem, 4vw, 3.5rem);
    }
  }

  @media (min-width: 1536px) {
    .article-hero-title {
      font-size: clamp(3rem, 3.5vw, 4rem);
    }
  }

  .article-hero-title-line {
    display: block;
    overflow: hidden;
  }

  .article-hero-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1.5rem;
    margin-top: 2.5rem;
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
  }

  .article-hero-author {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .article-hero-author-avatar {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    background: var(--color-background-secondary, #f5f5f5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--color-text);
  }

  .article-hero-author-name {
    font-weight: 600;
    color: var(--color-text);
  }

  .article-hero-date {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .article-hero-date::before {
    content: '';
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--color-text-secondary);
  }

  .article-hero-reading-time {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .article-hero-reading-time::before {
    content: '';
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--color-text-secondary);
  }

  /* Featured Image */
  .article-image {
    position: relative;
    margin: 0 auto 4rem;
    overflow: hidden;
    clip-path: inset(0 100% 0 0);
  }

  .article-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Article Tags */
  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .article-tag {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.5rem 1rem;
    background: var(--color-background-secondary, #f5f5f5);
    color: var(--color-text-secondary);
    transition: all 0.3s ease;
  }

  .article-tag:hover {
    background: var(--color-primary);
    color: var(--color-primary-contrast);
  }

  /* Share Section */
  .article-share {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
  }

  .article-share-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-secondary);
  }

  .article-share-links {
    display: flex;
    gap: 0.75rem;
  }

  .article-share-link {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-border);
    color: var(--color-text);
    transition: all 0.3s ease;
  }

  .article-share-link:hover {
    background: var(--color-primary);
    color: var(--color-primary-contrast);
    border-color: var(--color-primary);
  }

  /* Navigation */
  .article-nav {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-top: 4rem;
    padding-top: 4rem;
    padding-bottom: 4rem;
    border-top: 1px solid var(--color-border);
  }

  .article-nav-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .article-nav-item--next {
    text-align: right;
    align-items: flex-end;
  }

  .article-nav-label {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .article-nav-item--next .article-nav-label {
    /* Arrow comes after "Next" text naturally */
  }

  .article-nav-link {
    text-decoration: none;
    color: inherit;
  }

  .article-nav-label i {
    transition: transform 0.3s ease;
  }

  .article-nav-item:hover .article-nav-label .ph-arrow-left {
    transform: translateX(-4px);
  }

  .article-nav-item:hover .article-nav-label .ph-arrow-right {
    transform: translateX(4px);
  }

  .article-nav-title-text {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
    transition: color 0.3s ease;
  }

  .article-nav-link:hover .article-nav-title-text {
    color: var(--color-primary);
  }

  /* Comments Section */
  .article-comments {
    margin-top: 6rem;
    padding-top: 4rem;
    border-top: 1px solid var(--color-border);
  }

  .article-comments-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 2rem;
  }

  .article-comment {
    padding: 1.5rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .article-comment:last-child {
    border-bottom: none;
  }

  .article-comment-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .article-comment-avatar {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: var(--color-background-secondary, #f5f5f5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.75rem;
  }

  .article-comment-author {
    font-weight: 600;
    font-size: 0.875rem;
  }

  .article-comment-date {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .article-comment-content {
    font-size: 0.9375rem;
    line-height: 1.6;
    color: var(--color-text-secondary);
  }

  /* Comment Form */
  .article-comment-form {
    margin-top: 3rem;
  }

  .article-comment-form-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
  }

  .article-form-grid {
    display: grid;
    gap: 1.5rem;
  }

  @media (min-width: 640px) {
    .article-form-grid--2col {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .article-form-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-secondary);
    margin-bottom: 0.5rem;
  }

  .article-form-input,
  .article-form-textarea {
    width: 100%;
    padding: 1rem;
    font-size: 0.9375rem;
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-text);
    transition: border-color 0.3s ease;
  }

  .article-form-input:focus,
  .article-form-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .article-form-textarea {
    min-height: 150px;
    resize: vertical;
  }

  /* Animation initial states */
  .article-wrapper.is-loading .article-image {
    clip-path: inset(0 100% 0 0);
  }
</style>

{%- comment -%} Reading Progress Bar {%- endcomment -%}
<div class="article-progress" data-article-progress>
  <div class="article-progress-bar" data-article-progress-bar></div>
</div>

<article class="article-wrapper is-loading" data-article-wrapper>
  {%- comment -%} Hero Section {%- endcomment -%}
  <header class="article-hero">
    <div class="{{ container_class }}">
      {%- comment -%} Back Link {%- endcomment -%}
      <a href="{{ blog.url }}" class="article-hero-back overflow-hidden">
        <i class="ph ph-arrow-left"></i>
        <span class="inline-block">Back to {{ blog.title }}</span>
      </a>

      {%- comment -%} Category {%- endcomment -%}
      {% if article.tags.size > 0 %}
        <p class="article-hero-category overflow-hidden">
          <span class="inline-block">{{ article.tags.first }}</span>
        </p>
      {% endif %}

      {%- comment -%} Title {%- endcomment -%}
      <h1 class="article-hero-title">
        {%- assign title_words = article.title | split: ' ' -%}
        {%- assign words_per_line = title_words.size | divided_by: 2 | plus: 1 -%}
        {%- for word in title_words -%}
          {%- assign word_index = forloop.index0 | modulo: words_per_line -%}
          {%- if word_index == 0 -%}
            <span class="article-hero-title-line">
          {%- endif -%}
          <span class="overflow-hidden inline-block"><span class="inline-block">{{ word }}</span></span>{% unless forloop.last %} {% endunless %}
          {%- assign next_index = forloop.index | modulo: words_per_line -%}
          {%- if next_index == 0 or forloop.last -%}
            </span>
          {%- endif -%}
        {%- endfor -%}
      </h1>

      {%- comment -%} Meta {%- endcomment -%}
      <div class="article-hero-meta" data-article-meta>
        <div class="article-hero-author">
          <div class="article-hero-author-avatar">
            {{ article.author | slice: 0 | upcase }}
          </div>
          <div>
            <p class="article-hero-author-name">{{ article.author }}</p>
          </div>
        </div>
        <time class="article-hero-date" datetime="{{ article.published_at | date: '%Y-%m-%d' }}">
          {{ article.published_at | date: '%B %d, %Y' }}
        </time>
        {% assign words = article.content | strip_html | split: ' ' | size %}
        {% assign reading_time = words | divided_by: 200 | plus: 1 %}
        <span class="article-hero-reading-time">{{ reading_time }} min read</span>
      </div>
    </div>
  </header>

  {%- comment -%} Featured Image {%- endcomment -%}
  {% if article.image %}
    <div class="article-image {{ container_class }}">
      {{ article.image | image_url: width: 1600 | image_tag:
        class: 'w-full',
        loading: 'eager',
        sizes: '100vw',
        widths: '600, 900, 1200, 1600'
      }}
    </div>
  {% endif %}

  {%- comment -%} Content {%- endcomment -%}
  <div class="{{ container_class }}">
    <div class="article-content" data-article-content>
      <div class="article-content-body prose prose-lg max-w-none">
        {{ article.content }}
      </div>

      {%- comment -%} Tags {%- endcomment -%}
      {% if article.tags.size > 0 %}
        <div class="article-tags">
          {% for tag in article.tags %}
            <a href="{{ blog.url }}/tagged/{{ tag | handle }}" class="article-tag">{{ tag }}</a>
          {% endfor %}
        </div>
      {% endif %}

      {%- comment -%} Share {%- endcomment -%}
      {% if section.settings.show_share %}
        <div class="article-share">
          <span class="article-share-label">Share</span>
          <div class="article-share-links">
            <a href="https://twitter.com/intent/tweet?url={{ shop.url }}{{ article.url }}&text={{ article.title | url_encode }}" target="_blank" rel="noopener" class="article-share-link" aria-label="Share on Twitter">
              <i class="ph ph-x-logo"></i>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u={{ shop.url }}{{ article.url }}" target="_blank" rel="noopener" class="article-share-link" aria-label="Share on Facebook">
              <i class="ph ph-facebook-logo"></i>
            </a>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ shop.url }}{{ article.url }}&title={{ article.title | url_encode }}" target="_blank" rel="noopener" class="article-share-link" aria-label="Share on LinkedIn">
              <i class="ph ph-linkedin-logo"></i>
            </a>
            <button type="button" class="article-share-link" aria-label="Copy link" data-copy-link="{{ shop.url }}{{ article.url }}">
              <i class="ph ph-link"></i>
            </button>
          </div>
        </div>
      {% endif %}

      {%- comment -%} Article Navigation {%- endcomment -%}
      {% if blog.previous_article or blog.next_article %}
        <nav class="article-nav">
          {% if blog.previous_article %}
            <a href="{{ blog.previous_article.url }}" class="article-nav-item article-nav-link">
              <span class="article-nav-label">
                <i class="ph ph-arrow-left"></i>
                Previous
              </span>
              <span class="article-nav-title-text">{{ blog.previous_article.title | truncate: 50 }}</span>
            </a>
          {% else %}
            <div></div>
          {% endif %}

          {% if blog.next_article %}
            <a href="{{ blog.next_article.url }}" class="article-nav-item article-nav-item--next article-nav-link">
              <span class="article-nav-label">
                Next
                <i class="ph ph-arrow-right"></i>
              </span>
              <span class="article-nav-title-text">{{ blog.next_article.title | truncate: 50 }}</span>
            </a>
          {% endif %}
        </nav>
      {% endif %}

      {%- comment -%} Comments {%- endcomment -%}
      {% if blog.comments_enabled? %}
        <section class="article-comments">
          <h2 class="article-comments-title">
            Comments{% if article.comments_count > 0 %} ({{ article.comments_count }}){% endif %}
          </h2>

          {% if article.comments_count > 0 %}
            <div class="article-comments-list">
              {% paginate article.comments by 10 %}
                {% for comment in article.comments %}
                  <div class="article-comment">
                    <div class="article-comment-header">
                      <div class="article-comment-avatar">
                        {{ comment.author | slice: 0 | upcase }}
                      </div>
                      <span class="article-comment-author">{{ comment.author }}</span>
                      <span class="article-comment-date">{{ comment.created_at | date: '%b %d, %Y' }}</span>
                    </div>
                    <div class="article-comment-content">
                      {{ comment.content }}
                    </div>
                  </div>
                {% endfor %}
              {% endpaginate %}
            </div>
          {% endif %}

          {%- comment -%} Comment Form {%- endcomment -%}
          {% form 'new_comment', article %}
            <div class="article-comment-form">
              <h3 class="article-comment-form-title">Leave a comment</h3>

              {{ form.errors | default_errors }}

              <div class="article-form-grid">
                <div class="article-form-grid article-form-grid--2col">
                  <div>
                    <label for="comment-author" class="article-form-label">Name</label>
                    <input
                      type="text"
                      name="comment[author]"
                      id="comment-author"
                      value="{{ form.author }}"
                      required
                      class="article-form-input"
                    >
                  </div>
                  <div>
                    <label for="comment-email" class="article-form-label">Email</label>
                    <input
                      type="email"
                      name="comment[email]"
                      id="comment-email"
                      value="{{ form.email }}"
                      required
                      class="article-form-input"
                    >
                  </div>
                </div>

                <div>
                  <label for="comment-body" class="article-form-label">Comment</label>
                  <textarea
                    name="comment[body]"
                    id="comment-body"
                    required
                    class="article-form-textarea"
                  >{{ form.body }}</textarea>
                </div>

                <div>
                  <button type="submit" class="btn btn--primary">
                    <span>Post Comment</span>
                  </button>
                </div>
              </div>
            </div>
          {% endform %}
        </section>
      {% endif %}
    </div>
  </div>
</article>

<script>
/**
 * Article Animation
 * Awwwards-style reveal with GSAP
 */
(function() {
  function initArticleAnimation() {
    const wrapper = document.querySelector('[data-article-wrapper]');
    if (!wrapper) return;
    if (wrapper.dataset.articleAnimInitialized) return;

    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    if (!gsap) {
      setTimeout(initArticleAnimation, 50);
      return;
    }

    wrapper.dataset.articleAnimInitialized = 'true';

    const backLink = wrapper.querySelector('.article-hero-back span');
    const category = wrapper.querySelector('.article-hero-category span');
    const titleSpans = wrapper.querySelectorAll('.article-hero-title .overflow-hidden span');
    const meta = wrapper.querySelector('[data-article-meta]');
    const image = wrapper.querySelector('.article-image');
    const content = wrapper.querySelector('[data-article-content]');

    // Set initial states
    if (backLink) gsap.set(backLink, { yPercent: 100 });
    if (category) gsap.set(category, { yPercent: 100 });
    if (titleSpans.length) gsap.set(titleSpans, { yPercent: 100 });
    if (meta) gsap.set(meta, { opacity: 0, y: 20 });
    if (content) gsap.set(content, { opacity: 0, y: 30 });

    // Create timeline
    const tl = gsap.timeline({
      onComplete: () => wrapper.classList.remove('is-loading')
    });

    // Back link
    if (backLink) {
      tl.to(backLink, {
        yPercent: 0,
        duration: 0.6,
        ease: 'power4.out'
      }, 0);
    }

    // Category
    if (category) {
      tl.to(category, {
        yPercent: 0,
        duration: 0.6,
        ease: 'power4.out'
      }, 0.1);
    }

    // Title
    if (titleSpans.length) {
      tl.to(titleSpans, {
        yPercent: 0,
        duration: 1.2,
        ease: 'power4.out',
        stagger: 0.05
      }, 0.2);
    }

    // Meta
    if (meta) {
      tl.to(meta, {
        opacity: 1,
        y: 0,
        duration: 0.8,
        ease: 'power3.out'
      }, 0.5);
    }

    // Image
    if (image) {
      tl.to(image, {
        clipPath: 'inset(0 0% 0 0)',
        duration: 1.8,
        ease: 'expo.inOut'
      }, 0.4);
    }

    // Content
    if (content) {
      tl.to(content, {
        opacity: 1,
        y: 0,
        duration: 0.8,
        ease: 'power3.out'
      }, 0.8);
    }
  }

  // Copy link functionality
  function initCopyLink() {
    const copyButtons = document.querySelectorAll('[data-copy-link]');
    copyButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const url = btn.dataset.copyLink;
        try {
          await navigator.clipboard.writeText(url);
          const icon = btn.querySelector('i');
          if (icon) {
            icon.className = 'ph ph-check';
            setTimeout(() => {
              icon.className = 'ph ph-link';
            }, 2000);
          }
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  }

  // Reading Progress Bar
  function initProgressBar() {
    const progressBar = document.querySelector('[data-article-progress-bar]');
    const wrapper = document.querySelector('[data-article-wrapper]');
    if (!progressBar || !wrapper) return;

    // Track if we've cleaned up
    let isDestroyed = false;

    function updateProgress() {
      if (isDestroyed) return;

      const wrapperRect = wrapper.getBoundingClientRect();
      const wrapperTop = window.scrollY + wrapperRect.top;
      const wrapperHeight = wrapper.offsetHeight;
      const windowHeight = window.innerHeight;
      const scrollY = window.scrollY;

      // Calculate progress based on article content
      const start = wrapperTop;
      const end = wrapperTop + wrapperHeight - windowHeight;
      const current = scrollY;

      let progress = 0;
      if (current >= start && current <= end) {
        progress = ((current - start) / (end - start)) * 100;
      } else if (current > end) {
        progress = 100;
      }

      progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`;
    }

    // Use requestAnimationFrame for smooth updates
    let ticking = false;
    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateProgress();
          ticking = false;
        });
        ticking = true;
      }
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    updateProgress(); // Initial update

    // Cleanup function for Swup navigation
    function cleanup() {
      isDestroyed = true;
      window.removeEventListener('scroll', onScroll);
    }

    // Store cleanup function
    window._articleProgressCleanup = cleanup;
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initArticleAnimation();
      initCopyLink();
      initProgressBar();
    });
  } else {
    initArticleAnimation();
    initCopyLink();
    initProgressBar();
  }

  // Reinitialize after Swup
  window.addEventListener('swup:contentReplaced', () => {
    // Cleanup previous progress bar listener
    if (window._articleProgressCleanup) {
      window._articleProgressCleanup();
    }

    requestAnimationFrame(() => {
      initArticleAnimation();
      initCopyLink();
      initProgressBar();
    });
  });
})();
</script>

{% schema %}
{
  "name": "Article",
  "settings": [
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "checkbox",
      "id": "show_share",
      "default": true,
      "label": "Show share buttons"
    }
  ]
}
{% endschema %}
