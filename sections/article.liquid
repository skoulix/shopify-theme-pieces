{%- comment -%}
  Article Section - Split Text Reveal Animations
{%- endcomment -%}

<style>
  /* Article intro animation initial states */
  .article-intro .article-intro__image {
    clip-path: inset(0 100% 0 0);
  }

  .article-intro .article-intro__content {
    opacity: 0;
    transform: translateY(30px);
  }

  /* Animated states */
  .article-intro--animated .article-intro__image {
    clip-path: inset(0 0% 0 0);
  }

  .article-intro--animated .article-intro__content {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<article class="bg-white article-intro" data-article-intro>
  <div class="mx-auto max-w-3xl px-4 py-16 sm:px-6 sm:py-24 lg:px-8">
    {% if article.image %}
      <div class="mb-8 overflow-hidden rounded-lg article-intro__image">
        {{ article.image | image_url: width: 1200 | image_tag:
          class: 'w-full object-cover'
        }}
      </div>
    {% endif %}

    <h1 class="article-intro__title text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">
      {%- assign title_words = article.title | split: ' ' -%}
      {%- for word in title_words -%}
        <span class="overflow-hidden inline-block"><span class="inline-block">{{ word }}</span></span>{% unless forloop.last %} {% endunless %}
      {%- endfor -%}
    </h1>

    <div class="article-intro__meta mt-4 flex items-center gap-x-4 text-sm text-gray-500">
      <span class="overflow-hidden">
        <time class="inline-block" datetime="{{ article.published_at | date: '%Y-%m-%d' }}">
          {{ article.published_at | date: '%B %d, %Y' }}
        </time>
      </span>
      <span class="overflow-hidden">
        <span class="inline-block">by {{ article.author }}</span>
      </span>
    </div>

    <div class="mt-8 prose prose-indigo max-w-none article-intro__content">
      {{ article.content }}
    </div>

    {% if blog.comments_enabled? %}
      <div class="mt-16 border-t border-gray-200 pt-16">
        <h2 class="text-2xl font-bold text-gray-900">{{ 'blog.article_comments' | t }}</h2>

        {% if article.comments_count > 0 %}
          <div class="mt-8 space-y-8">
            {% paginate article.comments by 10 %}
              {% for comment in article.comments %}
                <div class="border-l-2 border-gray-200 pl-4">
                  <p class="font-medium text-gray-900">{{ comment.author }}</p>
                  <p class="text-sm text-gray-500">{{ comment.created_at | date: '%B %d, %Y' }}</p>
                  <div class="mt-2 text-gray-600">{{ comment.content }}</div>
                </div>
              {% endfor %}
            {% endpaginate %}
          </div>
        {% endif %}

        {% form 'new_comment', article %}
          <div class="mt-8">
            <h3 class="text-lg font-semibold text-gray-900">{{ 'blog.comment_form_title' | t }}</h3>

            {{ form.errors | default_errors }}

            <div class="mt-6 grid gap-6 sm:grid-cols-2">
              <div>
                <label for="author" class="block text-sm font-medium text-gray-700">{{ 'blog.comment_form_name' | t }}</label>
                <input
                  type="text"
                  name="comment[author]"
                  id="author"
                  value="{{ form.author }}"
                  required
                  class="mt-1 block w-full rounded-md border-0 py-2 px-3 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
                >
              </div>

              <div>
                <label for="email" class="block text-sm font-medium text-gray-700">{{ 'blog.comment_form_email' | t }}</label>
                <input
                  type="email"
                  name="comment[email]"
                  id="email"
                  value="{{ form.email }}"
                  required
                  class="mt-1 block w-full rounded-md border-0 py-2 px-3 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
                >
              </div>

              <div class="sm:col-span-2">
                <label for="body" class="block text-sm font-medium text-gray-700">{{ 'blog.comment_form_body' | t }}</label>
                <textarea
                  name="comment[body]"
                  id="body"
                  rows="4"
                  required
                  class="mt-1 block w-full rounded-md border-0 py-2 px-3 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
                >{{ form.body }}</textarea>
              </div>
            </div>

            <div class="mt-6">
              <button type="submit" class="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500">
                {{ 'blog.comment_form_submit' | t }}
              </button>
            </div>
          </div>
        {% endform %}
      </div>
    {% endif %}
  </div>
</article>

<script>
  /**
   * Article Intro Animation
   * Split text reveal effect with GSAP
   */
  (function() {
    const section = document.querySelector('[data-article-intro]');
    if (!section) return;
    if (section.dataset.introInitialized) return;

    section.dataset.introInitialized = 'true';

    function runIntroAnimation() {
      // Check for GSAP
      let gsap = window.gsap;
      if (!gsap && window.pieces && window.pieces.gsap) {
        gsap = window.pieces.gsap;
      }

      if (!gsap) {
        // Fallback: just add animated class immediately
        section.classList.add('article-intro--animated');
        return;
      }

      const image = section.querySelector('.article-intro__image');
      const titleSpans = section.querySelectorAll('.article-intro__title .overflow-hidden span');
      const metaSpans = section.querySelectorAll('.article-intro__meta .overflow-hidden span, .article-intro__meta .overflow-hidden time');
      const content = section.querySelector('.article-intro__content');

      // Create timeline
      const tl = gsap.timeline({
        onComplete: () => section.classList.add('article-intro--animated')
      });

      // Small delay to ensure page is ready
      tl.addLabel('start', 0.1);

      // Animate image with clip-path reveal
      if (image) {
        tl.to(image, {
          clipPath: 'inset(0 0% 0 0)',
          duration: 1,
          ease: 'expo.out'
        }, 'start');
      }

      // Split text reveal for title - using yPercent
      if (titleSpans.length) {
        gsap.set(titleSpans, { yPercent: 100 });
        tl.to(titleSpans, {
          yPercent: 0,
          duration: 1.2,
          ease: 'power4.out',
          stagger: 0.1
        }, 'start+=0.2');
      }

      // Split text reveal for meta (date and author)
      if (metaSpans.length) {
        gsap.set(metaSpans, { yPercent: 100 });
        tl.to(metaSpans, {
          yPercent: 0,
          duration: 0.8,
          ease: 'power4.out',
          stagger: 0.1
        }, 'start+=0.5');
      }

      // Animate content
      if (content) {
        tl.to(content, {
          y: 0,
          opacity: 1,
          duration: 0.8,
          ease: 'power3.out'
        }, 'start+=0.7');
      }
    }

    // Run animation after page load
    if (document.readyState === 'complete') {
      runIntroAnimation();
    } else {
      window.addEventListener('load', runIntroAnimation);
    }

    // Also run on Swup content replace (for SPA navigation)
    window.addEventListener('swup:contentReplaced', () => {
      const newSection = document.querySelector('[data-article-intro]');
      if (newSection && !newSection.dataset.introInitialized) {
        newSection.dataset.introInitialized = 'true';
        runIntroAnimation();
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Article",
  "settings": []
}
{% endschema %}
