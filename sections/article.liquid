{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif
-%}

<style>
  .article-progress-bar { transition: width 0.1s ease-out; }
  .article-hero-title { font-size: calc(clamp(1.75rem, 5vw, 2.75rem) * var(--heading-font-scale, 1)); letter-spacing: -0.03em; line-height: 1.05; }
  @media (min-width: 1024px) { .article-hero-title { font-size: calc(clamp(2.5rem, 4vw, 3.5rem) * var(--heading-font-scale, 1)); } }
  @media (min-width: 1536px) { .article-hero-title { font-size: calc(clamp(3rem, 3.5vw, 4rem) * var(--heading-font-scale, 1)); } }
  .article-hero-title-line:nth-child(2) { margin-left: clamp(1rem, 6vw, 4rem); }
  .article-hero-title-line:nth-child(3) { margin-left: clamp(2rem, 10vw, 6rem); }
  .article-hero-category::before { content: ''; display: inline-block; width: 2rem; height: 1px; background: var(--color-text-secondary); }
  .article-hero-date::before, .article-hero-reading-time::before { content: ''; display: inline-block; width: 4px; height: 4px; border-radius: 50%; background: var(--color-text-secondary); }
  .article-image { clip-path: inset(0 100% 0 0); }
  .article-wrapper.is-loading .article-image { clip-path: inset(0 100% 0 0); }
  html.animations-disabled .article-image,
  html.animations-disabled .article-wrapper.is-loading .article-image { clip-path: none; }
</style>

<article class="article-wrapper is-loading py-[--page-vertical-padding]" data-article-wrapper>
  <header class="mb-12 lg:mb-16">
    <div class="{{ container_class }}">
      {%- capture back_text -%}{{ 'blog.back_to_blog' | t: blog: blog.title }}{%- endcapture -%}
      <div class="mb-12" data-intro>
        <a href="{{ blog.url }}" class="text-hover-reveal inline-flex items-center gap-2 text-xs font-semibold tracking-widest text-[--color-text-secondary]">
          <i class="ph ph-arrow-left" aria-hidden="true"></i>
          <span data-hover="{{ back_text }}">{{ back_text }}</span>
        </a>
      </div>

      {% if article.tags.size > 0 %}
        <p class="article-hero-category text-[0.65rem] font-semibold uppercase tracking-[0.2em] text-[--color-text-secondary] mb-6 flex items-center gap-4" data-intro>
          {{ article.tags.first }}
        </p>
      {% endif %}

      <h1 class="article-hero-title font-bold text-[--color-text] max-w-[900px] font-heading" data-article-title>
        {{ article.title }}
      </h1>

      <div class="flex flex-wrap items-center gap-6 mt-10 text-[0.8125rem] text-[--color-text-secondary]" data-intro>
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-[--color-background-secondary] flex items-center justify-center font-semibold text-sm text-[--color-text]">
            {{ article.author | slice: 0 | upcase }}
          </div>
          <p class="font-semibold text-[--color-text]">{{ article.author }}</p>
        </div>
        <time class="article-hero-date flex items-center gap-2" datetime="{{ article.published_at | date: '%Y-%m-%d' }}">
          {{ article.published_at | date: '%B %d, %Y' }}
        </time>
        {% assign words = article.content | strip_html | split: ' ' | size %}
        {% assign reading_time = words | divided_by: 200 | plus: 1 %}
        <span class="article-hero-reading-time flex items-center gap-2">{{ 'blog.min_read' | t: minutes: reading_time }}</span>
      </div>
    </div>
  </header>

  {% if article.image %}
    <div class="article-image relative mx-auto mb-16 overflow-hidden {{ container_class }}">
      {{ article.image | image_url: width: 1600 | image_tag:
        class: 'w-full h-auto block',
        loading: 'eager',
        sizes: '100vw',
        widths: '600, 900, 1200, 1600',
        alt: article.image.alt | default: article.title
      }}
    </div>
  {% endif %}

  <div class="{{ container_class }}">
    <div data-article-content>
      <div class="prose max-w-none">
        {{ article.content }}
      </div>

      {% if article.tags.size > 0 %}
        <div class="flex flex-wrap gap-2 mt-16 pt-8 border-t border-[--color-border]">
          {% for tag in article.tags %}
            <a href="{{ blog.url }}/tagged/{{ tag | handle }}" class="text-[0.6875rem] font-semibold uppercase tracking-widest py-2 px-4 bg-[--color-background-secondary] text-[--color-text-secondary] hover:bg-[--color-primary] hover:text-[--color-primary-contrast] transition-all duration-300">{{ tag }}</a>
          {% endfor %}
        </div>
      {% endif %}

      {% if section.settings.show_share %}
        <div class="flex items-center gap-4 mt-8">
          <span class="text-xs font-semibold uppercase tracking-widest text-[--color-text-secondary]">{{ 'general.share' | t }}</span>
          <div class="flex gap-3">
            <a href="https://twitter.com/intent/tweet?url={{ shop.url }}{{ article.url }}&text={{ article.title | url_encode }}" target="_blank" rel="noopener" class="w-10 h-10 flex items-center justify-center border border-[--color-border] text-[--color-text] hover:bg-[--color-primary] hover:text-[--color-primary-contrast] hover:border-[--color-primary] transition-all duration-300" aria-label="{{ 'accessibility.share_on_twitter' | t }}">
              <i class="ph ph-x-logo"></i>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u={{ shop.url }}{{ article.url }}" target="_blank" rel="noopener" class="w-10 h-10 flex items-center justify-center border border-[--color-border] text-[--color-text] hover:bg-[--color-primary] hover:text-[--color-primary-contrast] hover:border-[--color-primary] transition-all duration-300" aria-label="{{ 'accessibility.share_on_facebook' | t }}">
              <i class="ph ph-facebook-logo"></i>
            </a>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ shop.url }}{{ article.url }}&title={{ article.title | url_encode }}" target="_blank" rel="noopener" class="w-10 h-10 flex items-center justify-center border border-[--color-border] text-[--color-text] hover:bg-[--color-primary] hover:text-[--color-primary-contrast] hover:border-[--color-primary] transition-all duration-300" aria-label="{{ 'accessibility.share_on_linkedin' | t }}">
              <i class="ph ph-linkedin-logo"></i>
            </a>
            <button type="button" class="w-10 h-10 flex items-center justify-center border border-[--color-border] text-[--color-text] hover:bg-[--color-primary] hover:text-[--color-primary-contrast] hover:border-[--color-primary] transition-all duration-300 cursor-pointer" aria-label="{{ 'accessibility.copy_link' | t }}" data-copy-link="{{ shop.url }}{{ article.url }}">
              <i class="ph ph-link"></i>
            </button>
          </div>
        </div>
      {% endif %}

      {% if blog.previous_article or blog.next_article %}
        <nav class="grid grid-cols-2 gap-8 mt-16 pt-16 border-t border-[--color-border]">
          {% if blog.previous_article %}
            <a href="{{ blog.previous_article.url }}" class="flex flex-col gap-2 no-underline group">
              <span class="text-hover-reveal text-[0.65rem] font-semibold tracking-[0.15em] text-[--color-text-secondary] flex items-center gap-2">
                <i class="ph ph-arrow-left" aria-hidden="true"></i>
                <span data-hover="{{ 'general.previous' | t }}">{{ 'general.previous' | t }}</span>
              </span>
              <span class="text-base font-semibold text-[--color-text] group-hover:text-[--color-primary] transition-colors">{{ blog.previous_article.title | truncate: 50 }}</span>
            </a>
          {% else %}
            <div></div>
          {% endif %}

          {% if blog.next_article %}
            <a href="{{ blog.next_article.url }}" class="flex flex-col gap-2 text-right items-end no-underline group">
              <span class="text-hover-reveal text-[0.65rem] font-semibold tracking-[0.15em] text-[--color-text-secondary] flex items-center gap-2">
                <span data-hover="{{ 'general.next' | t }}">{{ 'general.next' | t }}</span>
                <i class="ph ph-arrow-right" aria-hidden="true"></i>
              </span>
              <span class="text-base font-semibold text-[--color-text] group-hover:text-[--color-primary] transition-colors">{{ blog.next_article.title | truncate: 50 }}</span>
            </a>
          {% endif %}
        </nav>
      {% endif %}

      {% if blog.comments_enabled? %}
        <section class="mt-24 pt-16 border-t border-[--color-border]">
          <h2 class="text-2xl font-bold mb-8 font-heading">
            {{ 'blog.article_comments' | t }}{% if article.comments_count > 0 %} ({{ article.comments_count }}){% endif %}
          </h2>

          {% if article.comments_count > 0 %}
            <div>
              {% paginate article.comments by 10 %}
                {% for comment in article.comments %}
                  <div class="py-6 border-b border-[--color-border] last:border-b-0">
                    <div class="flex items-center gap-3 mb-3">
                      <div class="w-8 h-8 rounded-full bg-[--color-background-secondary] flex items-center justify-center font-semibold text-xs">
                        {{ comment.author | slice: 0 | upcase }}
                      </div>
                      <span class="font-semibold text-sm">{{ comment.author }}</span>
                      <span class="text-xs text-[--color-text-secondary]">{{ comment.created_at | date: '%b %d, %Y' }}</span>
                    </div>
                    <div class="text-[0.9375rem] leading-relaxed text-[--color-text-secondary]">
                      {{ comment.content }}
                    </div>
                  </div>
                {% endfor %}
              {% endpaginate %}
            </div>
          {% endif %}

          {% form 'new_comment', article %}
            <div class="mt-12">
              <h3 class="text-lg font-semibold mb-6 font-heading">{{ 'blog.comment_form_title' | t }}</h3>

              {{ form.errors | default_errors }}

              <div class="grid gap-6">
                <div class="grid gap-6 sm:grid-cols-2">
                  <div>
                    <label for="comment-author" class="block text-xs font-semibold uppercase tracking-widest text-[--color-text-secondary] mb-2">{{ 'blog.comment_form_name' | t }}</label>
                    <input type="text" name="comment[author]" id="comment-author" value="{{ form.author }}" required class="w-full p-4 text-[0.9375rem] bg-transparent border border-[--color-border] text-[--color-text] focus:border-[--color-primary] focus:outline-none transition-colors duration-300">
                  </div>
                  <div>
                    <label for="comment-email" class="block text-xs font-semibold uppercase tracking-widest text-[--color-text-secondary] mb-2">{{ 'blog.comment_form_email' | t }}</label>
                    <input type="email" name="comment[email]" id="comment-email" value="{{ form.email }}" required class="w-full p-4 text-[0.9375rem] bg-transparent border border-[--color-border] text-[--color-text] focus:border-[--color-primary] focus:outline-none transition-colors duration-300">
                  </div>
                </div>

                <div>
                  <label for="comment-body" class="block text-xs font-semibold uppercase tracking-widest text-[--color-text-secondary] mb-2">{{ 'blog.comment_form_body' | t }}</label>
                  <textarea name="comment[body]" id="comment-body" required class="w-full p-4 text-[0.9375rem] bg-transparent border border-[--color-border] text-[--color-text] focus:border-[--color-primary] focus:outline-none transition-colors duration-300 min-h-[150px] resize-y">{{ form.body }}</textarea>
                </div>

                <div>
                  <button type="submit" class="btn btn--primary">
                    <span>{{ 'blog.comment_form_submit' | t }}</span>
                  </button>
                </div>
              </div>
            </div>
          {% endform %}
        </section>
      {% endif %}
    </div>
  </div>
</article>

<script>
(function() {
  function initArticleAnimation(forceReinit = false) {
    const wrapper = document.querySelector('[data-article-wrapper]');
    if (!wrapper) return;
    if (!forceReinit && wrapper.dataset.articleAnimInitialized) return;

    // If animations disabled, just show content immediately
    if (!window.shouldAnimate()) {
      wrapper.classList.remove('is-loading');
      wrapper.dataset.articleAnimInitialized = 'true';
      return;
    }

    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    let SplitText = window.SplitText;
    if (!SplitText && window.pieces && window.pieces.SplitText) {
      SplitText = window.pieces.SplitText;
    }

    if (!gsap || !SplitText) {
      setTimeout(() => initArticleAnimation(forceReinit), 50);
      return;
    }

    wrapper.dataset.articleAnimInitialized = 'true';
    wrapper.classList.remove('is-loading');

    const image = wrapper.querySelector('.article-image');
    const title = wrapper.querySelector('[data-article-title]');

    const tl = gsap.timeline();

    // Split title into lines and animate
    if (title) {
      const split = new SplitText(title, { type: 'lines', linesClass: 'article-hero-title-line' });

      // Wrap each line in an overflow-hidden container for the reveal effect
      split.lines.forEach(line => {
        const wrapper = document.createElement('div');
        wrapper.style.overflow = 'hidden';
        wrapper.style.display = 'block';
        line.parentNode.insertBefore(wrapper, line);
        wrapper.appendChild(line);
      });

      gsap.set(split.lines, { yPercent: 120 });
      tl.to(split.lines, {
        yPercent: 0,
        duration: 1.2,
        ease: 'power4.out',
        stagger: 0.1
      }, 0);
    }

    // Animate article image with clip-path swipe
    if (image) {
      gsap.set(image, { clipPath: 'inset(0 100% 0 0)' });
      tl.to(image, {
        clipPath: 'inset(0 0% 0 0)',
        duration: 1.8,
        ease: 'expo.inOut'
      }, 0.2);
    }
  }

  // Copy link functionality
  function initCopyLink() {
    const copyButtons = document.querySelectorAll('[data-copy-link]');
    copyButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const url = btn.dataset.copyLink;
        try {
          await navigator.clipboard.writeText(url);
          const icon = btn.querySelector('i');
          if (icon) {
            icon.className = 'ph ph-check';
            setTimeout(() => {
              icon.className = 'ph ph-link';
            }, 2000);
          }
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  }

  // Initialize
  function init() {
    initArticleAnimation(true);
    initCopyLink();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    requestAnimationFrame(init);
  }
})();
</script>

{% schema %}
{
  "name": "Article",
  "settings": [
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "checkbox",
      "id": "show_share",
      "default": true,
      "label": "Show share buttons"
    }
  ]
}
{% endschema %}
