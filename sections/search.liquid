{%- comment -%}
  Search Section - Modern design with GSAP animations and predictive search
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif
-%}

<style>
  .search-page-title { font-size: calc(clamp(2.5rem, 10vw, 4.5rem) * var(--heading-font-scale, 1)); letter-spacing: calc(-0.03em + var(--heading-letter-spacing, 0em)); line-height: 0.9; }
  @media (min-width: 1024px) { .search-page-title { font-size: calc(clamp(3.5rem, 7vw, 6rem) * var(--heading-font-scale, 1)); } }
  /* Title line stagger (managed by TweenManager) */
  .search-page-title .tween-split-line:nth-child(2) { margin-left: clamp(1.5rem, 10vw, 8rem); }
  .search-input-container { position: relative; }
  .search-input { width: 100%; padding: 1.25rem 1.5rem; padding-right: 4rem; font-size: 1rem; background: transparent; border: 1px solid var(--color-border); color: var(--color-text); transition: border-color 0.2s; }
  .search-input:focus { outline: none; border-color: var(--color-primary); }
  .search-input::placeholder { color: var(--color-text-secondary); }
  .search-submit { position: absolute; right: 0; top: 0; height: 100%; padding: 0 1.5rem; background: transparent; border: none; color: var(--color-text); cursor: pointer; transition: color 0.2s; }
  .search-submit:hover { color: var(--color-primary); }
  .search-result-image { aspect-ratio: 1; overflow: hidden; background: var(--color-background-secondary); }
  .search-grid { display: grid; grid-template-columns: repeat(var(--columns-mobile, 1), 1fr); gap: 2rem; }
  @media (min-width: 640px) { .search-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (min-width: 1024px) { .search-grid { grid-template-columns: repeat(4, 1fr); } }
  /* Remove horizontal padding when card has no border AND no shadow */
  {% if settings.card_border_width == 0 and settings.card_shadow == 'none' %}
  .search-result-content { padding-left: 0; padding-right: 0; }
  {% endif %}
</style>

<div class="min-h-screen py-[--page-vertical-padding]" data-search-wrapper>
  <header class="mb-12 lg:mb-16 {{ container_class }}" data-tween-group="search-header" data-tween-start="top bottom">
    <h1 class="search-page-title font-bold text-[--color-text] font-heading" data-tween data-tween-type="split-text">
      {{ 'search.title' | t }}
    </h1>

    <div id="search-subtitle-fragment">
      {% if search.performed %}
        <p class="page-header-subtitle mt-6">
          <span class="page-header-subtitle-line" data-subtitle-line></span>
          <span class="overflow-hidden"><span class="inline-block" data-subtitle-text>
            {% if search.results_count > 0 %}
              {{ 'search.results_for_html' | t: count: search.results_count, terms: search.terms }}
            {% elsif search.terms != blank %}
              {{ 'search.no_results_html' | t: terms: search.terms }}
            {% endif %}
          </span></span>
        </p>
      {% endif %}
    </div>
  </header>

  {%- comment -%} Search Form - Simple form without predictive search (use drawer for that) {%- endcomment -%}
  <div class="{{ container_class }} relative z-10">
    <div class="max-w-2xl" data-tween data-tween-type="fade-up" data-tween-start="top bottom">
      <form action="{{ routes.search_url }}" method="get" role="search" class="search-input-container">
        <input type="hidden" name="type" value="product,article,page">
        <input type="hidden" name="options[prefix]" value="last">
        <label for="search-page-input" class="sr-only">{{ 'search.placeholder' | t }}</label>
        <input
          type="search"
          id="search-page-input"
          name="q"
          value="{{ search.terms | escape }}"
          class="search-input rounded-[--input-radius] !pr-16"
          placeholder="{{ 'search.placeholder' | t }}"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
          data-search-input
        >
        <button type="submit" class="search-submit" aria-label="{{ 'search.submit' | t }}">
          <i class="ph ph-magnifying-glass text-xl"></i>
        </button>
      </form>

      {%- comment -%} Search Type Filters - Only show when there are results {%- endcomment -%}
      <div id="search-filters-fragment">
        {% if search.performed and search.results_count > 0 %}
          <div class="flex flex-wrap gap-2 mt-6">
            <a
              href="{{ routes.search_url }}?q={{ search.terms | url_encode }}&type=product,article,page"
              class="px-4 py-2 text-sm uppercase tracking-wider font-medium border rounded-[--button-radius] transition-colors {% if search.types.size > 1 %}bg-[--color-text] text-[--color-background] border-[--color-text]{% else %}border-[--color-border] text-[--color-text-secondary] hover:border-[--color-text] hover:text-[--color-text]{% endif %}"
            >
              {{ 'search.filter_all' | t }}
            </a>
            <a
              href="{{ routes.search_url }}?q={{ search.terms | url_encode }}&type=product"
              class="px-4 py-2 text-sm uppercase tracking-wider font-medium border rounded-[--button-radius] transition-colors {% if search.types contains 'product' and search.types.size == 1 %}bg-[--color-text] text-[--color-background] border-[--color-text]{% else %}border-[--color-border] text-[--color-text-secondary] hover:border-[--color-text] hover:text-[--color-text]{% endif %}"
            >
              {{ 'search.filter_products' | t }}
            </a>
            <a
              href="{{ routes.search_url }}?q={{ search.terms | url_encode }}&type=article"
              class="px-4 py-2 text-sm uppercase tracking-wider font-medium border rounded-[--button-radius] transition-colors {% if search.types contains 'article' and search.types.size == 1 %}bg-[--color-text] text-[--color-background] border-[--color-text]{% else %}border-[--color-border] text-[--color-text-secondary] hover:border-[--color-text] hover:text-[--color-text]{% endif %}"
            >
              {{ 'search.filter_articles' | t }}
            </a>
            <a
              href="{{ routes.search_url }}?q={{ search.terms | url_encode }}&type=page"
              class="px-4 py-2 text-sm uppercase tracking-wider font-medium border rounded-[--button-radius] transition-colors {% if search.types contains 'page' and search.types.size == 1 %}bg-[--color-text] text-[--color-background] border-[--color-text]{% else %}border-[--color-border] text-[--color-text-secondary] hover:border-[--color-text] hover:text-[--color-text]{% endif %}"
            >
              {{ 'search.filter_pages' | t }}
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {%- comment -%} Search Results {%- endcomment -%}
  <div id="search-results-fragment" class="{{ container_class }} pt-12 relative z-0">
    {% if search.performed %}
      {% if search.results_count > 0 %}
        {% paginate search.results by 20 %}
          <div class="search-grid" data-search-results>
            {% for result in search.results %}
              <article class="group rounded-[--card-radius] overflow-hidden border-[length:var(--card-border-width)] border-solid border-[--color-border]" style="box-shadow: var(--card-shadow);" data-tween data-tween-type="fade-up">
                <a href="{{ result.url }}" class="block">
                  {%- comment -%} Image {%- endcomment -%}
                  <div class="search-result-image relative" data-tween data-tween-type="clip-right">
                    {% assign featured_image = result.featured_image | default: result.image %}
                    {% if featured_image %}
                      {{ featured_image | image_url: width: 600 | image_tag:
                        class: 'w-full h-full object-cover scale-100 transition-transform duration-500 group-hover:scale-105',
                        loading: 'lazy',
          decoding: 'async',
                        alt: featured_image.alt | default: result.title
                      }}
                    {% else %}
                      <div class="w-full h-full flex items-center justify-center">
                        {% if result.object_type == 'product' %}
                          <i class="ph ph-package text-4xl text-[--color-text-secondary] opacity-30"></i>
                        {% elsif result.object_type == 'article' %}
                          <i class="ph ph-article text-4xl text-[--color-text-secondary] opacity-30"></i>
                        {% else %}
                          <i class="ph ph-file-text text-4xl text-[--color-text-secondary] opacity-30"></i>
                        {% endif %}
                      </div>
                    {% endif %}

                    {%- comment -%} Type Badge {%- endcomment -%}
                    <span class="absolute top-3 left-3 px-2 py-1 text-[11px] uppercase tracking-wider font-medium bg-[--color-background] text-[--color-text] rounded-[--badge-radius]">
                      {% if result.object_type == 'product' %}
                        {{ 'search.type_product' | t }}
                      {% elsif result.object_type == 'article' %}
                        {{ 'search.type_article' | t }}
                      {% else %}
                        {{ 'search.type_page' | t }}
                      {% endif %}
                    </span>
                  </div>

                  {%- comment -%} Content {%- endcomment -%}
                  <div class="search-result-content p-4 bg-[--color-background]">
                    <h3 class="card-title text-[--color-text] font-heading group-hover:text-[--color-primary] transition-colors">
                      {{ result.title }}
                    </h3>

                    {% if result.object_type == 'product' %}
                      <p class="mt-1 text-sm text-[--color-text-secondary]">
                        {% if result.compare_at_price > result.price %}
                          <span class="line-through opacity-60 mr-2">{{ result.compare_at_price | money }}</span>
                        {% endif %}
                        {{ result.price | money }}
                      </p>
                    {% elsif result.object_type == 'article' %}
                      <p class="mt-1 text-sm text-[--color-text-secondary]">
                        {{ result.published_at | date: '%B %d, %Y' }}
                      </p>
                    {% endif %}

                    {% if result.content != blank or result.description != blank %}
                      <p class="mt-2 text-sm text-[--color-text-secondary] line-clamp-2">
                        {{ result.content | default: result.description | strip_html | truncate: 100 }}
                      </p>
                    {% endif %}
                  </div>
                </a>
              </article>
            {% endfor %}
          </div>

          {%- comment -%} Pagination {%- endcomment -%}
          {% if paginate.pages > 1 %}
            <nav class="flex items-center justify-center gap-4 pt-16">
              {% if paginate.previous %}
                <a href="{{ paginate.previous.url }}" class="btn btn--secondary btn--sm">
                  <i class="ph ph-arrow-left"></i>
                  <span>{{ 'accessibility.previous' | t }}</span>
                </a>
              {% endif %}

              <span class="px-4 py-2 text-sm text-[--color-text-secondary]">
                Page {{ paginate.current_page }} of {{ paginate.pages }}
              </span>

              {% if paginate.next %}
                <a href="{{ paginate.next.url }}" class="btn btn--secondary btn--sm">
                  <span>{{ 'accessibility.next' | t }}</span>
                  <i class="ph ph-arrow-right"></i>
                </a>
              {% endif %}
            </nav>
          {% endif %}
        {% endpaginate %}
      {% else %}
        {%- comment -%} No Results {%- endcomment -%}
        <div class="max-w-2xl -mt-6" data-tween data-tween-type="fade-up" data-tween-start="top bottom">
          <p class="text-[--color-text-secondary]">{{ 'search.no_results_description' | t }}</p>

          <div class="mt-8 flex flex-wrap gap-3">
            <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary">
              <i class="ph ph-storefront"></i>
              <span>{{ '404.browse_products' | t }}</span>
            </a>
            <a href="{{ routes.root_url }}" class="btn btn--secondary">
              <i class="ph ph-house"></i>
              <span>{{ '404.back_home' | t }}</span>
            </a>
          </div>

          {%- comment -%} Popular Searches {%- endcomment -%}
          {% if section.settings.show_popular_searches %}
            <div class="mt-12 pt-12 border-t border-[--color-border]">
              <p class="text-sm uppercase tracking-wider font-medium text-[--color-text-secondary] mb-4">{{ 'search.popular_searches' | t }}</p>
              <div class="flex flex-wrap gap-2">
                {% assign popular_terms = section.settings.popular_searches | split: ',' %}
                {% for term in popular_terms %}
                  {% assign trimmed_term = term | strip %}
                  {% if trimmed_term != blank %}
                    <a
                      href="{{ routes.search_url }}?q={{ trimmed_term | url_encode }}"
                      class="px-4 py-2 text-sm border border-[--color-border] rounded-[--button-radius] text-[--color-text] hover:bg-[--color-text] hover:text-[--color-background] transition-colors"
                    >
                      {{ trimmed_term }}
                    </a>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      {%- comment -%} Initial State - No search performed yet {%- endcomment -%}
      <div class="-mt-6" data-tween data-tween-type="fade-up" data-tween-start="top bottom">
        <p class="text-[--color-text-secondary]">
          {{ 'search.initial_prompt' | t }}
        </p>

        {%- comment -%} Popular Searches {%- endcomment -%}
        {% if section.settings.show_popular_searches %}
          <div class="mt-12 pt-12 border-t border-[--color-border]">
            <p class="text-sm uppercase tracking-wider font-medium text-[--color-text-secondary] mb-4">{{ 'search.popular_searches' | t }}</p>
            <div class="flex flex-wrap gap-2">
              {% assign popular_terms = section.settings.popular_searches | split: ',' %}
              {% for term in popular_terms %}
                {% assign trimmed_term = term | strip %}
                {% if trimmed_term != blank %}
                  <a
                    href="{{ routes.search_url }}?q={{ trimmed_term | url_encode }}"
                    class="px-4 py-2 text-sm border border-[--color-border] rounded-[--button-radius] text-[--color-text] hover:bg-[--color-text] hover:text-[--color-background] transition-colors"
                  >
                    {{ trimmed_term }}
                  </a>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<script>
(function() {
  // Focus search input on page load if empty
  const searchInput = document.querySelector('[data-search-input]');
  if (searchInput && !searchInput.value) {
    setTimeout(() => searchInput.focus(), 500);
  }

  // Subtitle animation
  if (document.documentElement.classList.contains('animations-disabled')) return;

  const wrapper = document.querySelector('[data-search-wrapper]');
  if (!wrapper) return;

  const initAnimation = () => {
    if (typeof gsap === 'undefined') {
      requestAnimationFrame(initAnimation);
      return;
    }

    const tl = gsap.timeline();

    // Subtitle line draw animation
    const subtitleLine = wrapper.querySelector('[data-subtitle-line]');
    if (subtitleLine) {
      gsap.set(subtitleLine, { scaleX: 0, transformOrigin: 'left center' });
      tl.to(subtitleLine, {
        scaleX: 1,
        duration: 0.8,
        ease: 'power3.out'
      }, 0.4);
    }

    // Subtitle text reveal
    const subtitleText = wrapper.querySelector('[data-subtitle-text]');
    if (subtitleText) {
      gsap.set(subtitleText, { yPercent: 120 });
      tl.to(subtitleText, {
        yPercent: 0,
        duration: 0.8,
        ease: 'power4.out'
      }, 0.6);
    }
  };

  initAnimation();
})();
</script>

{% schema %}
{
  "name": "Search",
  "settings": [
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_popular_searches",
      "label": "Show popular searches",
      "default": true,
      "info": "Displayed when no search has been performed"
    },
    {
      "type": "text",
      "id": "popular_searches",
      "label": "Popular search terms",
      "default": "New arrivals, Sale, Best sellers",
      "info": "Comma-separated list of terms"
    }
  ]
}
{% endschema %}
