{%- comment -%}
  Countdown Section
  Animated countdown timer to a specific date
  Hides automatically when the target date has passed

  Designs:
  - Hero: Large dramatic countdown with title, subtitle, and CTA
  - Compact: Medium-sized countdown, good for mid-page placement
  - Minimal: Inline countdown perfect for headers and announcement bars
{%- endcomment -%}

{%- liquid
  assign design = section.settings.design

  # Minimal design is always full width
  assign is_full_width = section.settings.full_width
  if design == 'minimal'
    assign is_full_width = true
  endif

  capture container_class
    render 'container-class', full_width: is_full_width
  endcapture

  # Build design class
  assign design_class = 'countdown--' | append: design
  if section.settings.show_dividers
    assign design_class = design_class | append: ' show-dividers'
  endif

  # Alignment class for hero
  capture align_class
    render 'alignment-classes', alignment: section.settings.content_alignment, output: 'text'
  endcapture
-%}
{%- capture btn_class -%}{%- render 'button-class', style: section.settings.button_style, color: section.settings.button_color -%}{%- endcapture -%}

{% case design %}
{% when 'hero' %}
{%- comment -%} HERO DESIGN {%- endcomment -%}
<section
  class="countdown-section {{ design_class }} {{ align_class }} section-padding color-{{ section.settings.color_scheme }}"
  data-countdown="{{ section.id }}"
  data-target-date="{{ section.settings.target_date }}"
  data-design="hero"
>
  <div class="{{ container_class }}">
    {% if section.settings.title != blank or section.settings.subtitle != blank %}
      <header class="countdown-header" data-tween-group="countdown-header-{{ section.id }}">
        {% if section.settings.title != blank %}
          <h2 class="section-title" data-tween data-tween-type="split-text">{{ section.settings.title }}</h2>
        {% endif %}
        {% if section.settings.subtitle != blank %}
          {%- capture desc_margin -%}{%- render 'alignment-classes', alignment: section.settings.content_alignment, output: 'margin' -%}{%- endcapture -%}
          <p class="section-description {{ desc_margin }}" data-tween data-tween-type="fade-up">{{ section.settings.subtitle }}</p>
        {% endif %}
      </header>
    {% endif %}

    <div class="countdown-grid">
      <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 0ms;">
        <div class="countdown-value" data-countdown-days>00</div>
        <p class="countdown-label">{{ section.settings.days_label }}</p>
      </div>
      <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 150ms;">
        <div class="countdown-value" data-countdown-hours>00</div>
        <p class="countdown-label">{{ section.settings.hours_label }}</p>
      </div>
      <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 300ms;">
        <div class="countdown-value" data-countdown-minutes>00</div>
        <p class="countdown-label">{{ section.settings.minutes_label }}</p>
      </div>
      <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 450ms;">
        <div class="countdown-value" data-countdown-seconds>00</div>
        <p class="countdown-label">{{ section.settings.seconds_label }}</p>
      </div>
    </div>

    {% if section.settings.cta_type == 'link' and section.settings.button_text != blank and section.settings.button_link != blank %}
      <div class="countdown-cta" data-tween data-tween-type="fade-up">
        <a href="{{ section.settings.button_link }}" class="btn{{ btn_class }}">
          <span>{{ section.settings.button_text }}</span>
          <i class="ph ph-arrow-right"></i>
        </a>
      </div>
    {% elsif section.settings.cta_type == 'email_form' %}
      <div class="countdown-form" data-countdown-form data-tween data-tween-type="fade-up">
        {% form 'customer', id: 'countdown-form-hero' %}
          <div class="countdown-form-inner">
            <input
              type="email"
              name="contact[email]"
              placeholder="{{ section.settings.form_placeholder | default: 'Enter your email' }}"
              required
              autocomplete="email"
            >
            <input type="hidden" name="contact[tags]" value="countdown,notify">
            <button type="submit" class="btn{{ btn_class }}">
              <span>{{ section.settings.button_text | default: 'Notify Me' }}</span>
            </button>
          </div>
          <div class="countdown-form-message" style="display: none;" data-form-message></div>
          {% if form.posted_successfully? %}
            <p class="countdown-form-message success">{{ 'general.newsletter.success' | t }}</p>
          {% endif %}
          {% if form.errors %}
            <p class="countdown-form-message error">{{ form.errors.messages['email'] }}</p>
          {% endif %}
        {% endform %}
      </div>
    {% endif %}
  </div>
</section>

{% when 'compact' %}
{%- comment -%} COMPACT DESIGN {%- endcomment -%}
<section
  class="countdown-section {{ design_class }} color-{{ section.settings.color_scheme }}"
  data-countdown="{{ section.id }}"
  data-target-date="{{ section.settings.target_date }}"
  data-design="compact"
>
  <div class="{{ container_class }}">
    <div class="countdown-inner" data-tween-group="countdown-compact-{{ section.id }}">
      {% if section.settings.title != blank or section.settings.subtitle != blank %}
        <div class="countdown-header">
          {% if section.settings.title != blank %}
            <h2 class="countdown-title font-heading" data-tween data-tween-type="fade-up">{{ section.settings.title }}</h2>
          {% endif %}
          {% if section.settings.subtitle != blank %}
            <p class="countdown-subtitle" data-tween data-tween-type="fade-up">{{ section.settings.subtitle }}</p>
          {% endif %}
        </div>
      {% endif %}

      <div class="countdown-grid">
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 0ms;">
          <div class="countdown-item-inner">
            <div class="countdown-value" data-countdown-days>00</div>
            <p class="countdown-label">{{ section.settings.days_label }}</p>
          </div>
          {% if section.settings.show_dividers %}<span class="countdown-divider">:</span>{% endif %}
        </div>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 100ms;">
          <div class="countdown-item-inner">
            <div class="countdown-value" data-countdown-hours>00</div>
            <p class="countdown-label">{{ section.settings.hours_label }}</p>
          </div>
          {% if section.settings.show_dividers %}<span class="countdown-divider">:</span>{% endif %}
        </div>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 200ms;">
          <div class="countdown-item-inner">
            <div class="countdown-value" data-countdown-minutes>00</div>
            <p class="countdown-label">{{ section.settings.minutes_label }}</p>
          </div>
          {% if section.settings.show_dividers %}<span class="countdown-divider">:</span>{% endif %}
        </div>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 300ms;">
          <div class="countdown-item-inner">
            <div class="countdown-value" data-countdown-seconds>00</div>
            <p class="countdown-label">{{ section.settings.seconds_label }}</p>
          </div>
        </div>
      </div>

      {% if section.settings.cta_type == 'link' and section.settings.button_text != blank and section.settings.button_link != blank %}
        <div class="countdown-cta" data-tween data-tween-type="fade-up">
          <a href="{{ section.settings.button_link }}" class="btn btn--sm{{ btn_class }}">
            <span>{{ section.settings.button_text }}</span>
            <i class="ph ph-arrow-right"></i>
          </a>
        </div>
      {% elsif section.settings.cta_type == 'email_form' %}
        <div class="countdown-form" data-countdown-form data-tween data-tween-type="fade-up">
          {% form 'customer', id: 'countdown-form-compact' %}
            <div class="countdown-form-inner">
              <input
                type="email"
                name="contact[email]"
                placeholder="{{ section.settings.form_placeholder | default: 'Enter your email' }}"
                required
                autocomplete="email"
              >
              <input type="hidden" name="contact[tags]" value="countdown,notify">
              <button type="submit" class="btn{{ btn_class }}">
                <span>{{ section.settings.button_text | default: 'Notify Me' }}</span>
              </button>
            </div>
            {% if form.posted_successfully? %}
              <p class="countdown-form-message success">{{ 'general.newsletter.success' | t }}</p>
            {% endif %}
            {% if form.errors %}
              <p class="countdown-form-message error">{{ form.errors.messages['email'] }}</p>
            {% endif %}
          {% endform %}
        </div>
      {% endif %}
    </div>
  </div>
</section>

{% when 'minimal' %}
{%- comment -%} MINIMAL DESIGN - for headers/announcements {%- endcomment -%}
<div
  class="countdown-section {{ design_class }} color-{{ section.settings.color_scheme }}"
  data-countdown="{{ section.id }}"
  data-target-date="{{ section.settings.target_date }}"
  data-design="minimal"
>
  <div class="{{ container_class }}">
    <div class="countdown-inner">
      {% if section.settings.title != blank %}
        <span class="countdown-text">{{ section.settings.title }}</span>
      {% endif %}

      <div class="countdown-grid">
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}">
          <span class="countdown-value" data-countdown-days>00</span>
          <span class="countdown-label">{{ section.settings.days_label | slice: 0 }}</span>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}">
          <span class="countdown-value" data-countdown-hours>00</span>
          <span class="countdown-label">{{ section.settings.hours_label | slice: 0 }}</span>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}">
          <span class="countdown-value" data-countdown-minutes>00</span>
          <span class="countdown-label">{{ section.settings.minutes_label | slice: 0 }}</span>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}">
          <span class="countdown-value" data-countdown-seconds>00</span>
          <span class="countdown-label">{{ section.settings.seconds_label | slice: 0 }}</span>
        </div>
      </div>

      {% if section.settings.cta_type == 'link' and section.settings.button_text != blank and section.settings.button_link != blank %}
        <div class="countdown-cta">
          <a href="{{ section.settings.button_link }}" class="btn{{ btn_class }}">{{ section.settings.button_text }}</a>
        </div>
      {% elsif section.settings.cta_type == 'email_form' %}
        <div class="countdown-form" data-countdown-form>
          {% form 'customer', id: 'countdown-form-minimal' %}
            <div class="countdown-form-inner">
              <input
                type="email"
                name="contact[email]"
                placeholder="{{ section.settings.form_placeholder | default: 'Enter your email' }}"
                required
                autocomplete="email"
              >
              <input type="hidden" name="contact[tags]" value="countdown,notify">
              <button type="submit" class="btn{{ btn_class }}">
                <span>{{ section.settings.button_text | default: 'Notify Me' }}</span>
              </button>
            </div>
          {% endform %}
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endcase %}

<script>
  (function() {
    const section = document.querySelector('[data-countdown="{{ section.id }}"]');
    if (!section || section.dataset.initialized) return;
    section.dataset.initialized = 'true';

    const targetDateStr = section.dataset.targetDate;
    const design = section.dataset.design;

    if (!targetDateStr) {
      section.classList.add('is-expired');
      return;
    }

    const targetDate = new Date(targetDateStr + 'T00:00:00').getTime();
    const items = section.querySelectorAll('[data-countdown-item]');
    const daysEl = section.querySelector('[data-countdown-days]');
    const hoursEl = section.querySelector('[data-countdown-hours]');
    const minutesEl = section.querySelector('[data-countdown-minutes]');
    const secondsEl = section.querySelector('[data-countdown-seconds]');

    // Check if already expired
    if (Date.now() >= targetDate) {
      section.classList.add('is-expired');
      return;
    }

    // Check if animations should run
    const shouldAnimate = typeof window.shouldAnimate === 'function' ? window.shouldAnimate() : true;

    // Minimal design doesn't need entrance animations
    if (design === 'minimal' || !shouldAnimate) {
      items.forEach(item => item.classList.add('is-visible'));
      updateCountdown();
      startCountdown();

      if (design !== 'minimal' && !shouldAnimate) return;
      if (design === 'minimal') return;
    }

    // Title animations handled by global TweenManager via data-tween attributes

    // Intersection observer for items animation
    const observerOptions = {
      root: null,
      rootMargin: '0px 0px -10% 0px',
      threshold: 0.1
    };

    let hasAnimated = false;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !hasAnimated) {
          hasAnimated = true;

          items.forEach(item => {
            item.classList.add('is-visible');
          });

          // Start countdown after animation
          setTimeout(() => {
            startCountdown();
          }, design === 'hero' ? 600 : 400);

          observer.disconnect();
        }
      });
    }, observerOptions);

    observer.observe(section);

    // Update countdown display
    function updateCountdown() {
      const now = Date.now();
      const distance = targetDate - now;

      if (distance <= 0) {
        section.classList.add('is-expired');
        return false;
      }

      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      if (daysEl) daysEl.textContent = String(days).padStart(2, '0');
      if (hoursEl) hoursEl.textContent = String(hours).padStart(2, '0');
      if (minutesEl) minutesEl.textContent = String(minutes).padStart(2, '0');
      if (secondsEl) secondsEl.textContent = String(seconds).padStart(2, '0');

      return true;
    }

    // Start the countdown interval
    function startCountdown() {
      updateCountdown();
      const interval = setInterval(() => {
        if (!updateCountdown()) {
          clearInterval(interval);
        }
      }, 1000);

      // Cleanup on Swup navigation
      window.addEventListener('swup:willReplaceContent', function cleanup() {
        clearInterval(interval);
        window.removeEventListener('swup:willReplaceContent', cleanup);
      }, { once: true });
    }

    // Initial update and start
    startCountdown();
  })();
</script>

{% schema %}
{
  "name": "Countdown",
  "tag": "section",
  "class": "countdown-section",
  "settings": [
    {
      "type": "header",
      "content": "Design"
    },
    {
      "type": "select",
      "id": "design",
      "label": "Design style",
      "options": [
        { "value": "hero", "label": "Hero - Large dramatic" },
        { "value": "compact", "label": "Compact - Medium size" },
        { "value": "minimal", "label": "Minimal - Inline (for headers)" }
      ],
      "default": "hero",
      "info": "Minimal is perfect for announcement bars and headers"
    },
    {
      "type": "header",
      "content": "Countdown"
    },
    {
      "type": "text",
      "id": "target_date",
      "label": "Target date",
      "info": "Format: YYYY-MM-DD (e.g., 2026-12-25)",
      "default": "2026-12-31"
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Coming Soon"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Something exciting is on the way. Stay tuned!",
      "info": "Not shown in minimal design"
    },
    {
      "type": "text_alignment",
      "id": "content_alignment",
      "default": "center",
      "label": "Content alignment"
    },
    {
      "type": "header",
      "content": "Labels"
    },
    {
      "type": "text",
      "id": "days_label",
      "label": "Days label",
      "default": "Days",
      "info": "Minimal design shows only first letter"
    },
    {
      "type": "text",
      "id": "hours_label",
      "label": "Hours label",
      "default": "Hours"
    },
    {
      "type": "text",
      "id": "minutes_label",
      "label": "Minutes label",
      "default": "Minutes"
    },
    {
      "type": "text",
      "id": "seconds_label",
      "label": "Seconds label",
      "default": "Seconds"
    },
    {
      "type": "header",
      "content": "Call to action"
    },
    {
      "type": "select",
      "id": "cta_type",
      "label": "CTA type",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "link", "label": "Link button" },
        { "value": "email_form", "label": "Email signup form" }
      ],
      "default": "email_form",
      "info": "Email form collects emails as Shopify customers with 'countdown' and 'notify' tags. Minimal design only supports link."
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Notify Me"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button link",
      "info": "Required when using 'Link button' type"
    },
    {
      "type": "text",
      "id": "form_placeholder",
      "label": "Email placeholder",
      "default": "Enter your email",
      "info": "Placeholder text for email input (email form only)"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button style",
      "default": "solid",
      "options": [
        { "value": "solid", "label": "Solid" },
        { "value": "outline", "label": "Outline" }
      ]
    },
    {
      "type": "select",
      "id": "button_color",
      "label": "Button color",
      "default": "primary",
      "options": [
        { "value": "primary", "label": "Primary (accent)" },
        { "value": "secondary", "label": "Secondary (neutral)" }
      ]
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-3"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width",
      "info": "Minimal design is always full width"
    },
    {
      "type": "checkbox",
      "id": "show_dividers",
      "default": true,
      "label": "Show dividers between items",
      "info": "Hero and Compact designs only"
    }
  ],
  "presets": [
    {
      "name": "Countdown",
      "category": "Text & content",
      "settings": {
        "design": "hero",
        "target_date": "2026-12-31",
        "title": "Coming Soon",
        "subtitle": "Something exciting is on the way. Stay tuned!",
        "cta_type": "email_form",
        "button_text": "Notify Me",
        "form_placeholder": "Enter your email",
        "color_scheme": "scheme-3"
      }
    }
  ]
}
{% endschema %}
