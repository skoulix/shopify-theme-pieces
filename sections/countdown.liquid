{%- comment -%}
  Countdown Section
  Animated countdown timer to a specific date
  Hides automatically when the target date has passed

  Designs:
  - Hero: Large dramatic countdown with title, subtitle, and CTA
  - Compact: Medium-sized countdown, good for mid-page placement
  - Minimal: Inline countdown perfect for headers and announcement bars
{%- endcomment -%}

{%- liquid
  assign design = section.settings.design

  # Minimal design is always full width
  assign is_full_width = section.settings.full_width
  if design == 'minimal'
    assign is_full_width = true
  endif

  capture container_class
    render 'container-class', full_width: is_full_width, full_class: 'container-fluid'
  endcapture

  # Build design class
  assign design_class = 'countdown--' | append: design
  if section.settings.show_dividers
    assign design_class = design_class | append: ' show-dividers'
  endif

  # Alignment class for hero
  capture align_class
    render 'alignment-classes', alignment: section.settings.content_alignment, output: 'text'
  endcapture
-%}
{%- capture btn_class -%}{%- render 'button-class', style: section.settings.button_style, color: section.settings.button_color -%}{%- endcapture -%}
{%- capture btn_size -%}
  {%- case section.settings.button_size -%}
    {%- when 'small' -%} btn--sm
    {%- when 'large' -%} btn--lg
  {%- endcase -%}
{%- endcapture -%}

{% case design %}
{% when 'hero' %}
{%- comment -%} HERO DESIGN {%- endcomment -%}
<div
  class="countdown-section {{ design_class }} {{ align_class }} section-padding{% unless section.settings.padding == 'default' %}-{{ section.settings.padding }}{% endunless %} color-{{ section.settings.color_scheme }}"
  data-countdown="{{ section.id }}"
  data-target-date="{{ section.settings.target_date }}"
  data-design="hero"
>
  <div class="{{ container_class }}">
    <div class="countdown-wrapper">
      <div class="countdown-header">
        {% render 'section-header',
          label: section.settings.label,
          title: section.settings.title,
          description: section.settings.text,
          alignment: section.settings.content_alignment,
          group_id: section.id,
          animate: true
        %}
      </div>

      <div class="countdown-grid">
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 0ms;">
          <div class="countdown-value" data-countdown-days>00</div>
          <p class="countdown-label">{{ section.settings.days_label }}</p>
        </div>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 150ms;">
          <div class="countdown-value" data-countdown-hours>00</div>
          <p class="countdown-label">{{ section.settings.hours_label }}</p>
        </div>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 300ms;">
          <div class="countdown-value" data-countdown-minutes>00</div>
          <p class="countdown-label">{{ section.settings.minutes_label }}</p>
        </div>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 450ms;">
          <div class="countdown-value" data-countdown-seconds>00</div>
          <p class="countdown-label">{{ section.settings.seconds_label }}</p>
        </div>
      </div>

      {% if section.settings.cta_type == 'link' and section.settings.button_text != blank and section.settings.button_link != blank %}
        <div class="countdown-cta" data-tween data-tween-type="fade-up">
          <a href="{{ section.settings.button_link }}" class="btn{{ btn_class }} {{ btn_size }}">
            <span>{{ section.settings.button_text }}</span>
            <i class="ph ph-arrow-right"></i>
          </a>
        </div>
      {% elsif section.settings.cta_type == 'email_form' %}
        <div class="countdown-form" data-countdown-form data-tween data-tween-type="fade-up">
          {% form 'customer', id: 'countdown-form-hero' %}
            <div class="countdown-form-inner">
              <input
                type="email"
                name="contact[email]"
                placeholder="{{ section.settings.form_placeholder | default: 'Enter your email' }}"
                required
                autocomplete="email"
              >
              <input type="hidden" name="contact[tags]" value="countdown,notify">
              <button type="submit" class="btn{{ btn_class }} {{ btn_size }}">
                <span>{{ section.settings.button_text | default: 'Notify Me' }}</span>
              </button>
            </div>
            <div class="countdown-form-message" style="display: none;" data-form-message></div>
            {% if form.posted_successfully? %}
              <p class="countdown-form-message success">{{ 'general.newsletter.success' | t }}</p>
            {% endif %}
            {% if form.errors %}
              <p class="countdown-form-message error">{{ form.errors.messages['email'] }}</p>
            {% endif %}
          {% endform %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% when 'compact' %}
{%- comment -%} COMPACT DESIGN {%- endcomment -%}
<div
  class="countdown-section {{ design_class }} {{ align_class }} color-{{ section.settings.color_scheme }}"
  data-countdown="{{ section.id }}"
  data-target-date="{{ section.settings.target_date }}"
  data-design="compact"
>
  <div class="{{ container_class }}">
    <div class="countdown-inner" data-tween-group="countdown-compact-{{ section.id }}">
      {% if section.settings.label != blank or section.settings.title != blank or section.settings.text != blank %}
        <div class="countdown-header">
          {% if section.settings.label != blank %}
            <span class="section-label" data-tween data-tween-type="fade-up">{{ section.settings.label }}</span>
          {% endif %}
          {% if section.settings.title != blank %}
            <h2 class="countdown-title font-heading" data-tween data-tween-type="fade-up">{{ section.settings.title }}</h2>
          {% endif %}
          {% if section.settings.text != blank %}
            <p class="countdown-description" data-tween data-tween-type="fade-up">{{ section.settings.text }}</p>
          {% endif %}
        </div>
      {% endif %}

      <div class="countdown-grid">
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 0ms;">
          <div class="countdown-item-inner">
            <div class="countdown-value" data-countdown-days>00</div>
            <p class="countdown-label">{{ section.settings.days_label }}</p>
          </div>
          {% if section.settings.show_dividers %}<span class="countdown-divider">:</span>{% endif %}
        </div>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 100ms;">
          <div class="countdown-item-inner">
            <div class="countdown-value" data-countdown-hours>00</div>
            <p class="countdown-label">{{ section.settings.hours_label }}</p>
          </div>
          {% if section.settings.show_dividers %}<span class="countdown-divider">:</span>{% endif %}
        </div>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 200ms;">
          <div class="countdown-item-inner">
            <div class="countdown-value" data-countdown-minutes>00</div>
            <p class="countdown-label">{{ section.settings.minutes_label }}</p>
          </div>
          {% if section.settings.show_dividers %}<span class="countdown-divider">:</span>{% endif %}
        </div>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}" data-countdown-item style="transition-delay: 300ms;">
          <div class="countdown-item-inner">
            <div class="countdown-value" data-countdown-seconds>00</div>
            <p class="countdown-label">{{ section.settings.seconds_label }}</p>
          </div>
        </div>
      </div>

      {% if section.settings.cta_type == 'link' and section.settings.button_text != blank and section.settings.button_link != blank %}
        <div class="countdown-cta" data-tween data-tween-type="fade-up">
          <a href="{{ section.settings.button_link }}" class="btn{{ btn_class }} {{ btn_size }}">
            <span>{{ section.settings.button_text }}</span>
            <i class="ph ph-arrow-right"></i>
          </a>
        </div>
      {% elsif section.settings.cta_type == 'email_form' %}
        <div class="countdown-form" data-countdown-form data-tween data-tween-type="fade-up">
          {% form 'customer', id: 'countdown-form-compact' %}
            <div class="countdown-form-inner">
              <input
                type="email"
                name="contact[email]"
                placeholder="{{ section.settings.form_placeholder | default: 'Enter your email' }}"
                required
                autocomplete="email"
              >
              <input type="hidden" name="contact[tags]" value="countdown,notify">
              <button type="submit" class="btn{{ btn_class }} {{ btn_size }}">
                <span>{{ section.settings.button_text | default: 'Notify Me' }}</span>
              </button>
            </div>
            {% if form.posted_successfully? %}
              <p class="countdown-form-message success">{{ 'general.newsletter.success' | t }}</p>
            {% endif %}
            {% if form.errors %}
              <p class="countdown-form-message error">{{ form.errors.messages['email'] }}</p>
            {% endif %}
          {% endform %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% when 'minimal' %}
{%- comment -%} MINIMAL DESIGN - for headers/announcements {%- endcomment -%}
<div
  class="countdown-section {{ design_class }} color-{{ section.settings.color_scheme }}"
  data-countdown="{{ section.id }}"
  data-target-date="{{ section.settings.target_date }}"
  data-design="minimal"
>
  <div class="{{ container_class }}">
    <div class="countdown-inner">
      {% if section.settings.title != blank %}
        <span class="countdown-text">{{ section.settings.title }}</span>
      {% endif %}

      <div class="countdown-grid">
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}">
          <span class="countdown-value" data-countdown-days>00</span>
          <span class="countdown-label">{{ section.settings.days_label | slice: 0 }}</span>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}">
          <span class="countdown-value" data-countdown-hours>00</span>
          <span class="countdown-label">{{ section.settings.hours_label | slice: 0 }}</span>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}">
          <span class="countdown-value" data-countdown-minutes>00</span>
          <span class="countdown-label">{{ section.settings.minutes_label | slice: 0 }}</span>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-item{% if settings.headings_uppercase %} uppercase{% endif %}">
          <span class="countdown-value" data-countdown-seconds>00</span>
          <span class="countdown-label">{{ section.settings.seconds_label | slice: 0 }}</span>
        </div>
      </div>

      {% if section.settings.cta_type == 'link' and section.settings.button_text != blank and section.settings.button_link != blank %}
        <div class="countdown-cta">
          <a href="{{ section.settings.button_link }}" class="btn{{ btn_class }} {{ btn_size }}">{{ section.settings.button_text }}</a>
        </div>
      {% elsif section.settings.cta_type == 'email_form' %}
        <div class="countdown-form" data-countdown-form>
          {% form 'customer', id: 'countdown-form-minimal' %}
            <div class="countdown-form-inner">
              <input
                type="email"
                name="contact[email]"
                placeholder="{{ section.settings.form_placeholder | default: 'Enter your email' }}"
                required
                autocomplete="email"
              >
              <input type="hidden" name="contact[tags]" value="countdown,notify">
              <button type="submit" class="btn{{ btn_class }} {{ btn_size }}">
                <span>{{ section.settings.button_text | default: 'Notify Me' }}</span>
              </button>
            </div>
          {% endform %}
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endcase %}

<script>
  (function() {
    const section = document.querySelector('[data-countdown="{{ section.id }}"]');
    if (!section || section.dataset.initialized) return;
    section.dataset.initialized = 'true';

    const targetDateStr = section.dataset.targetDate;
    const design = section.dataset.design;

    if (!targetDateStr) {
      section.classList.add('is-expired');
      return;
    }

    const targetDate = new Date(targetDateStr + 'T00:00:00').getTime();
    const items = section.querySelectorAll('[data-countdown-item]');
    const daysEl = section.querySelector('[data-countdown-days]');
    const hoursEl = section.querySelector('[data-countdown-hours]');
    const minutesEl = section.querySelector('[data-countdown-minutes]');
    const secondsEl = section.querySelector('[data-countdown-seconds]');

    // Check if already expired
    if (Date.now() >= targetDate) {
      section.classList.add('is-expired');
      return;
    }

    // Check if animations should run
    const shouldAnimate = typeof window.shouldAnimate === 'function' ? window.shouldAnimate() : true;

    // Minimal design doesn't need entrance animations
    if (design === 'minimal' || !shouldAnimate) {
      items.forEach(item => item.classList.add('is-visible'));
      updateCountdown();
      startCountdown();

      if (design !== 'minimal' && !shouldAnimate) return;
      if (design === 'minimal') return;
    }

    // Title animations handled by global TweenManager via data-tween attributes

    // Intersection observer for items animation
    const observerOptions = {
      root: null,
      rootMargin: '0px 0px -10% 0px',
      threshold: 0.1
    };

    let hasAnimated = false;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !hasAnimated) {
          hasAnimated = true;

          items.forEach(item => {
            item.classList.add('is-visible');
          });

          // Start countdown after animation
          setTimeout(() => {
            startCountdown();
          }, design === 'hero' ? 600 : 400);

          observer.disconnect();
        }
      });
    }, observerOptions);

    observer.observe(section);

    // Update countdown display
    function updateCountdown() {
      const now = Date.now();
      const distance = targetDate - now;

      if (distance <= 0) {
        section.classList.add('is-expired');
        return false;
      }

      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      if (daysEl) daysEl.textContent = String(days).padStart(2, '0');
      if (hoursEl) hoursEl.textContent = String(hours).padStart(2, '0');
      if (minutesEl) minutesEl.textContent = String(minutes).padStart(2, '0');
      if (secondsEl) secondsEl.textContent = String(seconds).padStart(2, '0');

      return true;
    }

    // Start the countdown interval
    function startCountdown() {
      updateCountdown();
      const interval = setInterval(() => {
        if (!updateCountdown()) {
          clearInterval(interval);
        }
      }, 1000);

      // Cleanup on Swup navigation
      window.addEventListener('swup:willReplaceContent', function cleanup() {
        clearInterval(interval);
        window.removeEventListener('swup:willReplaceContent', cleanup);
      }, { once: true });
    }

    // Initial update and start
    startCountdown();
  })();
</script>

{% schema %}
{
  "name": "t:sections.countdown.name",
  "tag": "section",
  "class": "countdown-section",
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.content"
    },
    {
      "type": "text",
      "id": "label",
      "label": "t:sections.countdown.settings.label.label"
    },
    {
      "type": "text",
      "id": "title",
      "label": "t:shared.settings.title.label",
      "default": "t:sections.countdown.settings.title.default"
    },
    {
      "type": "textarea",
      "id": "text",
      "label": "t:shared.settings.text.label",
      "default": "t:sections.countdown.settings.text.default",
      "info": "t:sections.countdown.settings.text.info"
    },
    {
      "type": "header",
      "content": "t:sections.countdown.settings.header__countdown.content"
    },
    {
      "type": "text",
      "id": "target_date",
      "label": "t:sections.countdown.settings.target_date.label",
      "info": "t:sections.countdown.settings.target_date.info",
      "default": "2026-12-31"
    },
    {
      "type": "header",
      "content": "t:shared.headers.layout"
    },
    {
      "type": "select",
      "id": "design",
      "label": "t:sections.countdown.settings.design.label",
      "options": [
        {
          "value": "hero",
          "label": "t:sections.countdown.settings.design.options__0.label"
        },
        {
          "value": "compact",
          "label": "t:sections.countdown.settings.design.options__1.label"
        },
        {
          "value": "minimal",
          "label": "t:sections.countdown.settings.design.options__2.label"
        }
      ],
      "default": "hero",
      "info": "t:sections.countdown.settings.design.info"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "t:shared.settings.full_width.label",
      "info": "t:sections.countdown.settings.full_width.info"
    },
    {
      "type": "text_alignment",
      "id": "content_alignment",
      "default": "center",
      "label": "t:shared.settings.content_alignment.label"
    },
    {
      "type": "checkbox",
      "id": "show_dividers",
      "default": true,
      "label": "t:sections.countdown.settings.show_dividers.label",
      "info": "t:sections.countdown.settings.show_dividers.info"
    },
    {
      "type": "select",
      "id": "padding",
      "label": "t:shared.settings.padding.label",
      "info": "t:shared.settings.padding.info",
      "default": "default",
      "options": [
        {
          "value": "default",
          "label": "t:shared.settings.padding.options__2.label"
        },
        {
          "value": "small",
          "label": "t:shared.settings.padding.options__1.label"
        },
        {
          "value": "large",
          "label": "t:shared.settings.padding.options__3.label"
        },
        {
          "value": "none",
          "label": "t:shared.settings.padding.options__0.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:shared.headers.labels"
    },
    {
      "type": "text",
      "id": "days_label",
      "label": "t:sections.countdown.settings.days_label.label",
      "default": "t:sections.countdown.settings.days_label.default",
      "info": "t:sections.countdown.settings.days_label.info"
    },
    {
      "type": "text",
      "id": "hours_label",
      "label": "t:sections.countdown.settings.hours_label.label",
      "default": "t:sections.countdown.settings.hours_label.default"
    },
    {
      "type": "text",
      "id": "minutes_label",
      "label": "t:sections.countdown.settings.minutes_label.label",
      "default": "t:sections.countdown.settings.minutes_label.default"
    },
    {
      "type": "text",
      "id": "seconds_label",
      "label": "t:sections.countdown.settings.seconds_label.label",
      "default": "t:sections.countdown.settings.seconds_label.default"
    },
    {
      "type": "header",
      "content": "t:sections.countdown.settings.header__call_to_action.content"
    },
    {
      "type": "select",
      "id": "cta_type",
      "label": "t:sections.countdown.settings.cta_type.label",
      "options": [
        {
          "value": "none",
          "label": "t:sections.countdown.settings.cta_type.options__0.label"
        },
        {
          "value": "link",
          "label": "t:sections.countdown.settings.cta_type.options__1.label"
        },
        {
          "value": "email_form",
          "label": "t:sections.countdown.settings.cta_type.options__2.label"
        }
      ],
      "default": "email_form",
      "info": "t:sections.countdown.settings.cta_type.info"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "t:shared.settings.button_text.label",
      "default": "t:sections.countdown.settings.button_text.default"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "t:shared.settings.button_link.label",
      "info": "t:sections.countdown.settings.button_link.info"
    },
    {
      "type": "text",
      "id": "form_placeholder",
      "label": "t:sections.countdown.settings.form_placeholder.label",
      "default": "t:sections.countdown.settings.form_placeholder.default",
      "info": "t:sections.countdown.settings.form_placeholder.info"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "t:shared.settings.button_style.label",
      "default": "solid",
      "options": [
        {
          "value": "solid",
          "label": "t:shared.settings.button_style.options__0.label"
        },
        {
          "value": "outline",
          "label": "t:shared.settings.button_style.options__1.label"
        }
      ]
    },
    {
      "type": "select",
      "id": "button_color",
      "label": "t:shared.settings.button_color.label",
      "default": "primary",
      "options": [
        {
          "value": "primary",
          "label": "t:shared.settings.button_color.options__0.label"
        },
        {
          "value": "secondary",
          "label": "t:shared.settings.button_color.options__1.label"
        }
      ]
    },
    {
      "type": "select",
      "id": "button_size",
      "label": "t:shared.settings.button_size.label",
      "default": "default",
      "options": [
        {
          "value": "small",
          "label": "t:shared.settings.button_size.options__0.label"
        },
        {
          "value": "default",
          "label": "t:shared.settings.button_size.options__1.label"
        },
        {
          "value": "large",
          "label": "t:shared.settings.button_size.options__2.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-3"
    }
  ],
  "presets": [
    {
      "name": "t:sections.countdown.presets.countdown.name",
      "category": "t:sections.countdown.presets.countdown.category",
      "settings": {
        "design": "t:sections.countdown.presets.countdown.settings.design",
        "target_date": "2026-12-31",
        "title": "t:sections.countdown.presets.countdown.settings.title",
        "cta_type": "t:sections.countdown.presets.countdown.settings.cta_type",
        "button_text": "t:sections.countdown.presets.countdown.settings.button_text",
        "form_placeholder": "t:sections.countdown.presets.countdown.settings.form_placeholder",
        "color_scheme": "t:sections.countdown.presets.countdown.settings.color_scheme",
        "text": "t:sections.countdown.presets.countdown.settings.text"
      }
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}
