{%- comment -%}
  Testimonials Section - Creative testimonials carousel with large quotes
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture

  capture header_container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture
-%}

<section
  class="testimonials-section-wrapper section-padding color-{{ section.settings.color_scheme }}"
  data-testimonials="{{ section.id }}"
  style="--slides-mobile: {{ section.settings.slides_mobile }}; --slides-tablet: {{ section.settings.slides_tablet }}; --slides-desktop: {{ section.settings.slides_desktop }}; --testimonial-text-size: {{ section.settings.text_size }};"
>
  {%- comment -%} Header with Navigation - always contained {%- endcomment -%}
  <div class="{{ header_container_class }}">
    {% render 'section-header-nav',
      label: section.settings.label,
      title: section.settings.title,
      alignment: section.settings.header_alignment,
      group_id: section.id,
      nav_data_prefix: 'testimonials',
      show_nav: section.blocks.size > 1
    %}
  </div>

  <div class="{{ container_class }}">
    {%- comment -%} Slider {%- endcomment -%}
    <div class="sr-only" aria-live="polite" aria-atomic="true" data-testimonials-status></div>
    <div class="testimonials-slider" data-tween data-tween-type="fade-up" role="region" aria-label="{{ 'accessibility.testimonials' | t | default: 'Testimonials' }}">
      <div class="testimonials-track" data-testimonials-track>
        {% for block in section.blocks %}
          <div class="testimonial" data-testimonial {{ block.shopify_attributes }}>
            <div class="testimonial-inner">
              <span class="testimonial-quote-icon" aria-hidden="true">"</span>

              <div class="testimonial-text-wrapper">
                {% if section.settings.show_rating %}
                  <div class="testimonial-rating" aria-label="{{ block.settings.rating }} out of 5 stars">
                    {% for i in (1..5) %}
                      {% if i <= block.settings.rating %}
                        <i class="ph-fill ph-star"></i>
                      {% else %}
                        <i class="ph ph-star"></i>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}

                <blockquote class="testimonial-text">
                  "{{ block.settings.quote }}"
                </blockquote>
              </div>

              <div class="testimonial-author">
                <div class="testimonial-avatar">
                  {% if block.settings.avatar != blank %}
                    {{ block.settings.avatar | image_url: width: 120 | image_tag:
                      loading: 'lazy',
                      decoding: 'async',
                      sizes: '56px',
                      widths: '56, 112',
                      alt: block.settings.avatar.alt | default: block.settings.author
                    }}
                  {% else %}
                    <div class="testimonial-avatar-placeholder">
                      {{ block.settings.author | slice: 0 | upcase }}
                    </div>
                  {% endif %}
                </div>

                <div class="testimonial-author-info">
                  <div class="testimonial-author-name">
                    {{ block.settings.author }}
                  </div>
                  {% if block.settings.author_title != blank %}
                    <div class="testimonial-author-title">
                      {{ block.settings.author_title }}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {%- comment -%} Progress Bar {%- endcomment -%}
      {% if section.settings.show_progress_bar %}
        <div class="h-0.5 bg-current/15 rounded-sm overflow-hidden mt-8" data-testimonials-progress>
          <div class="h-full w-0 bg-current transition-[width] duration-400 ease-out" data-testimonials-progress-bar></div>
        </div>
      {% endif %}
    </div>

  </div>
</section>

<script>
(function() {
  const section = document.querySelector('[data-testimonials="{{ section.id }}"]');
  if (!section || section.dataset.testimonialsInitialized) return;
  section.dataset.testimonialsInitialized = 'true';

  const track = section.querySelector('[data-testimonials-track]');
  const slides = section.querySelectorAll('[data-testimonial]');
  const prevBtn = section.querySelector('[data-testimonials-prev]');
  const nextBtn = section.querySelector('[data-testimonials-next]');
  const nav = section.querySelector('[data-testimonials-nav]');
  const statusEl = section.querySelector('[data-testimonials-status]');
  const progressBar = section.querySelector('[data-testimonials-progress-bar]');
  const progressContainer = section.querySelector('[data-testimonials-progress]');

  if (!track || slides.length <= 1) return;

  const totalSlides = slides.length;
  let isAnimating = false;

  // Get slides per view for current breakpoint
  function getSlidesPerView() {
    const width = window.innerWidth;
    if (width >= 1024) return {{ section.settings.slides_desktop }};
    if (width >= 768) return {{ section.settings.slides_tablet }};
    return {{ section.settings.slides_mobile }};
  }

  // Get max scroll index (last position where we can scroll to)
  function getMaxIndex() {
    const slidesPerView = getSlidesPerView();
    return Math.max(0, totalSlides - slidesPerView);
  }

  // Get current slide index based on scroll position
  function getCurrentIndex() {
    const slideWidth = slides[0].offsetWidth;
    const gap = parseFloat(getComputedStyle(track).gap) || 0;
    return Math.round(track.scrollLeft / (slideWidth + gap));
  }

  // Scroll to specific slide
  function scrollToSlide(index) {
    const slide = slides[index];
    if (!slide || isAnimating) return;

    isAnimating = true;
    // Pre-update button states and progress bar for target position (instant feedback)
    const maxIndex = getMaxIndex();
    const slidesPerView = getSlidesPerView();
    if (prevBtn) prevBtn.disabled = index <= 0;
    if (nextBtn) nextBtn.disabled = index >= maxIndex;
    if (progressBar) {
      const progress = maxIndex > 0 ? ((index + slidesPerView) / totalSlides) * 100 : 100;
      progressBar.style.width = `${Math.min(100, progress)}%`;
    }

    const slideWidth = slide.offsetWidth;
    const gap = parseFloat(getComputedStyle(track).gap) || 0;
    const targetScroll = index * (slideWidth + gap);

    track.scrollTo({ left: targetScroll, behavior: 'smooth' });
  }

  // Update button states and progress bar based on current position
  function updateButtonStates(index) {
    const maxIndex = getMaxIndex();
    const slidesPerView = getSlidesPerView();

    if (prevBtn) {
      prevBtn.disabled = index <= 0;
    }
    if (nextBtn) {
      nextBtn.disabled = index >= maxIndex;
    }

    // Update progress bar
    if (progressBar) {
      const progress = maxIndex > 0 ? ((index + slidesPerView) / totalSlides) * 100 : 100;
      progressBar.style.width = `${Math.min(100, progress)}%`;
    }

    // Announce to screen readers
    if (statusEl) {
      statusEl.textContent = `Testimonial ${index + 1} of ${totalSlides}`;
    }
  }

  // Update nav and progress bar visibility based on whether scrolling is needed
  function updateNavVisibility() {
    const slidesPerView = getSlidesPerView();
    const shouldHide = totalSlides <= slidesPerView;

    if (nav) {
      if (shouldHide) {
        nav.classList.add('is-hidden');
      } else {
        nav.classList.remove('is-hidden');
      }
    }

    if (progressContainer) {
      progressContainer.style.display = shouldHide ? 'none' : '';
    }

    // Also update button states after visibility change
    updateButtonStates(getCurrentIndex());
  }

  // Navigation buttons
  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      const current = getCurrentIndex();
      if (current > 0) {
        scrollToSlide(current - 1);
      }
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      const current = getCurrentIndex();
      const maxIndex = getMaxIndex();
      if (current < maxIndex) {
        scrollToSlide(current + 1);
      }
    });
  }

  // Sync button states and progress bar with scroll position
  let scrollTimeout;
  track.addEventListener('scroll', () => {
    // Update progress bar and button states immediately during scroll (real-time feedback)
    const currentIndex = getCurrentIndex();
    const maxIndex = getMaxIndex();
    const slidesPerView = getSlidesPerView();
    if (progressBar) {
      const progress = maxIndex > 0 ? ((currentIndex + slidesPerView) / totalSlides) * 100 : 100;
      progressBar.style.width = `${Math.min(100, progress)}%`;
    }
    if (prevBtn) prevBtn.disabled = currentIndex <= 0;
    if (nextBtn) nextBtn.disabled = currentIndex >= maxIndex;

    // Debounce isAnimating reset
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      isAnimating = false;
    }, 50);
  }, { passive: true });

  // Update on resize
  window.addEventListener('resize', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(updateNavVisibility, 100);
  });

  // Initial state
  updateNavVisibility();
  updateButtonStates(0);
})();
</script>

{% schema %}
{
  "name": "Testimonials",
  "tag": "section",
  "class": "testimonials-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "default": "Testimonials",
      "label": "Label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "What Our Customers Say",
      "label": "Title"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": true,
      "label": "Show star rating"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "select",
      "id": "header_alignment",
      "label": "Header alignment",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "select",
      "id": "slides_mobile",
      "default": "1",
      "label": "Slides per view (mobile)",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ]
    },
    {
      "type": "select",
      "id": "slides_tablet",
      "default": "2",
      "label": "Slides per view (tablet)",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" }
      ]
    },
    {
      "type": "select",
      "id": "slides_desktop",
      "default": "2",
      "label": "Slides per view (desktop)",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" }
      ]
    },
    {
      "type": "checkbox",
      "id": "show_progress_bar",
      "default": true,
      "label": "Show progress bar"
    },
    {
      "type": "header",
      "content": "Text"
    },
    {
      "type": "select",
      "id": "text_size",
      "default": "medium",
      "label": "Quote text size",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ]
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-2"
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "textarea",
          "id": "quote",
          "default": "This product exceeded all my expectations. The quality is outstanding and the customer service was exceptional.",
          "label": "Quote"
        },
        {
          "type": "range",
          "id": "rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5,
          "label": "Rating"
        },
        {
          "type": "image_picker",
          "id": "avatar",
          "label": "Author photo"
        },
        {
          "type": "text",
          "id": "author",
          "default": "Sarah Johnson",
          "label": "Author name"
        },
        {
          "type": "text",
          "id": "author_title",
          "default": "Verified Buyer",
          "label": "Author title"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonials",
      "category": "Social proof",
      "blocks": [
        { "type": "testimonial", "settings": { "quote": "Absolutely love my purchase! The quality is incredible and it arrived faster than expected. Will definitely be ordering again.", "author": "Sarah Johnson", "author_title": "Verified Buyer", "rating": 5 } },
        { "type": "testimonial", "settings": { "quote": "Best customer service I've ever experienced. They went above and beyond to help me with my order.", "author": "Michael Chen", "author_title": "Loyal Customer", "rating": 5 } },
        { "type": "testimonial", "settings": { "quote": "I've recommended this to all my friends. The attention to detail is remarkable and the craftsmanship is outstanding.", "author": "Emily Davis", "author_title": "Repeat Customer", "rating": 5 } },
        { "type": "testimonial", "settings": { "quote": "This exceeded all my expectations. The quality speaks for itself and shipping was incredibly fast.", "author": "David Wilson", "author_title": "Verified Buyer", "rating": 5 } },
        { "type": "testimonial", "settings": { "quote": "Finally found a brand that actually delivers on its promises. Worth every penny and then some.", "author": "Rachel Thompson", "author_title": "First-time Buyer", "rating": 5 } },
        { "type": "testimonial", "settings": { "quote": "Outstanding quality and the packaging was beautiful. Felt like opening a gift. Can't wait to order more.", "author": "James Martinez", "author_title": "Repeat Customer", "rating": 5 } }
      ]
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
  }
{% endschema %}
