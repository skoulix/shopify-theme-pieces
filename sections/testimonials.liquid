{%- comment -%}
  Testimonials Section - Creative testimonials carousel with large quotes
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif
-%}

<section
  class="testimonials-section-wrapper section-padding color-{{ section.settings.color_scheme }}"
  data-testimonials="{{ section.id }}"
>
  <div class="{{ container_class }}">
    {%- comment -%} Header - uses global data-tween system for animations {%- endcomment -%}
    {% if section.settings.label != blank or section.settings.title != blank %}
      <div class="testimonials-header text-{{ section.settings.header_alignment }}" data-tween-group="testimonials-header-{{ section.id }}">
        {% if section.settings.label != blank %}
          <span class="section-label" data-tween data-tween-type="fade-up">
            {{ section.settings.label }}
          </span>
        {% endif %}

        {% if section.settings.title != blank %}
          <h2 class="section-title" data-tween data-tween-type="split-text">
            {{ section.settings.title }}
          </h2>
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} Slider {%- endcomment -%}
    <div class="sr-only" aria-live="polite" aria-atomic="true" data-testimonials-status></div>
    <div class="testimonials-slider" data-tween data-tween-type="fade-up" role="region" aria-label="{{ 'accessibility.testimonials' | t | default: 'Testimonials' }}">
      <div class="testimonials-track" data-testimonials-track>
        {% for block in section.blocks %}
          <div class="testimonial" data-testimonial {{ block.shopify_attributes }}>
            <div class="testimonial-inner">
              <span class="testimonial-quote-icon" aria-hidden="true">"</span>

              <div class="testimonial-text-wrapper">
                {% if section.settings.show_rating %}
                  <div class="testimonial-rating" aria-label="{{ block.settings.rating }} out of 5 stars">
                    {% for i in (1..5) %}
                      {% if i <= block.settings.rating %}
                        <i class="ph-fill ph-star"></i>
                      {% else %}
                        <i class="ph ph-star"></i>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}

                <blockquote class="testimonial-text">
                  "{{ block.settings.quote }}"
                </blockquote>
              </div>

              <div class="testimonial-author">
                <div class="testimonial-avatar">
                  {% if block.settings.avatar != blank %}
                    {{ block.settings.avatar | image_url: width: 120 | image_tag:
                      loading: 'lazy',
                      decoding: 'async',
                      sizes: '56px',
                      widths: '56, 112',
                      alt: block.settings.avatar.alt | default: block.settings.author
                    }}
                  {% else %}
                    <div class="testimonial-avatar-placeholder">
                      {{ block.settings.author | slice: 0 | upcase }}
                    </div>
                  {% endif %}
                </div>

                <div class="testimonial-author-info">
                  <div class="testimonial-author-name">
                    {{ block.settings.author }}
                  </div>
                  {% if block.settings.author_title != blank %}
                    <div class="testimonial-author-title">
                      {{ block.settings.author_title }}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    {%- comment -%} Navigation {%- endcomment -%}
    {% if section.blocks.size > 1 %}
      <div class="testimonials-nav" data-tween data-tween-type="fade-up">
        <button class="testimonials-nav-btn" data-testimonials-prev aria-label="{{ 'accessibility.previous_testimonial' | t }}">
          <i class="ph ph-arrow-left"></i>
        </button>

        <div class="testimonials-dots" data-testimonials-dots>
          {% for block in section.blocks %}
            <button
              class="testimonials-dot{% if forloop.first %} is-active{% endif %}"
              data-testimonials-dot="{{ forloop.index0 }}"
              aria-label="{{ 'accessibility.go_to_testimonial' | t: index: forloop.index }}"
            ></button>
          {% endfor %}
        </div>

        <button class="testimonials-nav-btn" data-testimonials-next aria-label="{{ 'accessibility.next_testimonial' | t }}">
          <i class="ph ph-arrow-right"></i>
        </button>
      </div>
    {% endif %}
  </div>
</section>

<script>
(function() {
  const section = document.querySelector('[data-testimonials="{{ section.id }}"]');
  if (!section || section.dataset.testimonialsInitialized) return;
  section.dataset.testimonialsInitialized = 'true';

  // Slider functionality
  const track = section.querySelector('[data-testimonials-track]');
  const slides = section.querySelectorAll('[data-testimonial]');
  const prevBtn = section.querySelector('[data-testimonials-prev]');
  const nextBtn = section.querySelector('[data-testimonials-next]');
  const dots = section.querySelectorAll('[data-testimonials-dot]');

  if (slides.length <= 1) return;

  let currentIndex = 0;
  const totalSlides = slides.length;

  function getSlideWidth() {
    const slide = slides[0];
    const trackStyle = getComputedStyle(track);
    const gap = parseFloat(trackStyle.gap) || 0;
    return slide.offsetWidth + gap;
  }

  function getMaxTranslate() {
    // Calculate total track width
    const slideWidth = slides[0].offsetWidth;
    const trackStyle = getComputedStyle(track);
    const gap = parseFloat(trackStyle.gap) || 0;
    const totalTrackWidth = (slideWidth * totalSlides) + (gap * (totalSlides - 1));
    const containerWidth = track.parentElement.offsetWidth;

    // Max translate is when the last slide's right edge aligns with container's right edge
    return Math.max(0, totalTrackWidth - containerWidth);
  }

  function updateSlider(index) {
    const slideWidth = getSlideWidth();

    // Start from left edge (no offset for first slide)
    let translateX = index * slideWidth;

    // Clamp to max translate so last slide ends within container
    const maxTranslate = getMaxTranslate();
    translateX = Math.min(translateX, maxTranslate);

    track.style.transform = `translateX(${-translateX}px)`;

    // Update dots
    dots.forEach((dot, i) => {
      dot.classList.toggle('is-active', i === index);
    });

    currentIndex = index;

    // Announce slide change to screen readers
    const statusEl = section.querySelector('[data-testimonials-status]');
    if (statusEl) {
      statusEl.textContent = '{{ "accessibility.testimonial_x_of_y" | t }}'.replace('{{ current }}', index + 1).replace('{{ total }}', totalSlides);
    }
  }

  function nextSlide() {
    const next = (currentIndex + 1) % totalSlides;
    updateSlider(next);
  }

  function prevSlide() {
    const prev = (currentIndex - 1 + totalSlides) % totalSlides;
    updateSlider(prev);
  }

  // Event listeners
  if (prevBtn) prevBtn.addEventListener('click', prevSlide);
  if (nextBtn) nextBtn.addEventListener('click', nextSlide);

  dots.forEach(dot => {
    dot.addEventListener('click', () => {
      const index = parseInt(dot.dataset.testimonialsDot);
      updateSlider(index);
    });
  });

  // Touch/swipe support
  let touchStartX = 0;
  track.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
  }, { passive: true });

  track.addEventListener('touchend', (e) => {
    const touchEndX = e.changedTouches[0].clientX;
    const diff = touchStartX - touchEndX;

    if (Math.abs(diff) > 50) {
      if (diff > 0) {
        nextSlide();
      } else {
        prevSlide();
      }
    }
  }, { passive: true });

  // Initial position
  updateSlider(0);

  // Recalculate on resize (debounced)
  let testimonialsResizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(testimonialsResizeTimeout);
    testimonialsResizeTimeout = setTimeout(() => updateSlider(currentIndex), 150);
  });
})();
</script>

{% schema %}
{
  "name": "Testimonials",
  "tag": "section",
  "class": "testimonials-section",
  "settings": [
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "label",
      "default": "Testimonials",
      "label": "Label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "What Our Customers Say",
      "label": "Title"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "default": "left",
      "label": "Header alignment"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": true,
      "label": "Show star rating"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-2"
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "textarea",
          "id": "quote",
          "default": "This product exceeded all my expectations. The quality is outstanding and the customer service was exceptional.",
          "label": "Quote"
        },
        {
          "type": "range",
          "id": "rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5,
          "label": "Rating"
        },
        {
          "type": "image_picker",
          "id": "avatar",
          "label": "Author photo"
        },
        {
          "type": "text",
          "id": "author",
          "default": "Sarah Johnson",
          "label": "Author name"
        },
        {
          "type": "text",
          "id": "author_title",
          "default": "Verified Buyer",
          "label": "Author title"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonials",
      "category": "Social proof",
      "blocks": [
        { "type": "testimonial", "settings": { "quote": "Absolutely love my purchase! The quality is incredible and it arrived faster than expected. Will definitely be ordering again.", "author": "Sarah Johnson", "author_title": "Verified Buyer", "rating": 5 } },
        { "type": "testimonial", "settings": { "quote": "Best customer service I've ever experienced. They went above and beyond to help me with my order.", "author": "Michael Chen", "author_title": "Loyal Customer", "rating": 5 } },
        { "type": "testimonial", "settings": { "quote": "I've recommended this to all my friends. The attention to detail is remarkable and the craftsmanship is outstanding.", "author": "Emily Davis", "author_title": "Repeat Customer", "rating": 5 } },
        { "type": "testimonial", "settings": { "quote": "This exceeded all my expectations. The quality speaks for itself and shipping was incredibly fast.", "author": "David Wilson", "author_title": "Verified Buyer", "rating": 5 } },
        { "type": "testimonial", "settings": { "quote": "Finally found a brand that actually delivers on its promises. Worth every penny and then some.", "author": "Rachel Thompson", "author_title": "First-time Buyer", "rating": 5 } },
        { "type": "testimonial", "settings": { "quote": "Outstanding quality and the packaging was beautiful. Felt like opening a gift. Can't wait to order more.", "author": "James Martinez", "author_title": "Repeat Customer", "rating": 5 } }
      ]
    }
  ]
}
{% endschema %}
