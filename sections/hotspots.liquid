
{%- comment -%}
  Hotspots Section - Interactive image with clickable hotspots and popovers
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width
  endcapture

  capture header_container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture

  # Header alignment CSS custom properties
  if section.settings.header_alignment == 'center'
    assign description_ml = 'auto'
    assign description_mr = 'auto'
  elsif section.settings.header_alignment == 'right'
    assign description_ml = 'auto'
    assign description_mr = '0'
  else
    assign description_ml = '0'
    assign description_mr = '0'
  endif

  # Image border and shadow (using global card settings)
  assign border_width = settings.card_border_width | default: 0
  assign shadow = settings.card_shadow | default: 'none'

  if border_width > 0
    assign image_border = border_width | append: 'px solid var(--color-border)'
    assign popover_border = image_border
  else
    assign image_border = 'none'
    assign popover_border = 'none'
  endif

  if shadow != 'none'
    assign image_shadow = shadow
    assign popover_shadow = shadow
  else
    assign image_shadow = 'none'
    assign popover_shadow = '0 10px 40px rgba(0, 0, 0, 0.15)'
  endif
-%}

<div
  class="hotspots-section section-padding{% unless section.settings.padding == 'default' %}-{{ section.settings.padding }}{% endunless %} color-{{ section.settings.color_scheme }}"
  style="--hotspots-align: {{ section.settings.header_alignment }}; --hotspots-description-ml: {{ description_ml }}; --hotspots-description-mr: {{ description_mr }}; --hotspots-border: {{ image_border }}; --hotspots-shadow: {{ image_shadow }}; --hotspots-popover-shadow: {{ popover_shadow }}; --hotspots-popover-border: {{ popover_border }};"
  data-hotspots-section="{{ section.id }}"
>
  {%- comment -%} Header - always contained {%- endcomment -%}
  <div class="{{ header_container_class }}">
    <header class="hotspots-header">
      {% render 'section-header',
        label: section.settings.label,
        title: section.settings.title,
        description: section.settings.text,
        alignment: section.settings.header_alignment,
        group_id: section.id
      %}
    </header>
  </div>

  <div class="{{ container_class }}">
    {%- comment -%} Image with Hotspots {%- endcomment -%}
    <div class="hotspots-container" data-tween data-tween-type="fade-up">
      {% if section.settings.desktop_image != blank %}
        {%- comment -%} Desktop Image {%- endcomment -%}
        <img
          src="{{ section.settings.desktop_image | image_url: width: 1920 }}"
          srcset="{{ section.settings.desktop_image | image_url: width: 960 }} 960w,
                  {{ section.settings.desktop_image | image_url: width: 1280 }} 1280w,
                  {{ section.settings.desktop_image | image_url: width: 1920 }} 1920w"
          sizes="100vw"
          alt="{{ section.settings.desktop_image.alt | default: section.settings.title }}"
          class="hotspots-image hidden md:block"
          loading="lazy"
          decoding="async"
          width="{{ section.settings.desktop_image.width }}"
          height="{{ section.settings.desktop_image.height }}"
        >

        {%- comment -%} Mobile Image {%- endcomment -%}
        {% if section.settings.mobile_image != blank %}
          <img
            src="{{ section.settings.mobile_image | image_url: width: 800 }}"
            srcset="{{ section.settings.mobile_image | image_url: width: 400 }} 400w,
                    {{ section.settings.mobile_image | image_url: width: 600 }} 600w,
                    {{ section.settings.mobile_image | image_url: width: 800 }} 800w"
            sizes="100vw"
            alt="{{ section.settings.mobile_image.alt | default: section.settings.desktop_image.alt | default: section.settings.title }}"
            class="hotspots-image block md:hidden"
            loading="lazy"
            decoding="async"
            width="{{ section.settings.mobile_image.width }}"
            height="{{ section.settings.mobile_image.height }}"
          >
        {% else %}
          <img
            src="{{ section.settings.desktop_image | image_url: width: 800 }}"
            alt="{{ section.settings.desktop_image.alt | default: section.settings.title }}"
            class="hotspots-image block md:hidden"
            loading="lazy"
            decoding="async"
            width="{{ section.settings.desktop_image.width }}"
            height="{{ section.settings.desktop_image.height }}"
          >
        {% endif %}
      {% else %}
        {%- comment -%} Placeholder when no image {%- endcomment -%}
        <div class="hotspots-image w-full aspect-[16/9] bg-(--color-background-secondary) flex items-center justify-center">
          {{ 'lifestyle-1' | placeholder_svg_tag: 'w-full h-full object-cover' }}
        </div>
      {% endif %}

      {%- comment -%} Hotspot Dots {%- endcomment -%}
      {% for block in section.blocks %}
        {% if block.type == 'hotspot' %}
          {%- liquid
            assign dot_color = block.settings.dot_color | default: '#000000'
            assign icon_color = block.settings.icon_color | default: '#ffffff'
            assign position_x = block.settings.position_x | default: 50
            assign position_y = block.settings.position_y | default: 50
            assign position_x_mobile = block.settings.position_x_mobile
            assign position_y_mobile = block.settings.position_y_mobile
          -%}

          <div
            class="hotspot-dot"
            data-hotspot-id="{{ block.id }}"
            style="left: {{ position_x }}%; top: {{ position_y }}%;{% if position_x_mobile != blank %} --mobile-x: {{ position_x_mobile }}%;{% endif %}{% if position_y_mobile != blank %} --mobile-y: {{ position_y_mobile }}%;{% endif %}"
            {{ block.shopify_attributes }}
          >
            {%- liquid
              if block.settings.title != blank
                assign hotspot_aria_label = block.settings.title
              else
                assign hotspot_aria_label = 'sections.hotspots.view_details' | t
              endif
            -%}
            <button
              type="button"
              class="hotspot-trigger"
              style="background-color: {{ dot_color }};"
              aria-label="{{ hotspot_aria_label }}"
              aria-haspopup="dialog"
              aria-expanded="false"
              data-hotspot-trigger
              popovertarget="popover-{{ block.id }}"
            >
              <span class="hotspot-pulse" style="background-color: {{ dot_color }};"></span>
              <i class="ph ph-plus relative z-2" style="color: {{ icon_color }};"></i>
            </button>
          </div>

          {%- comment -%} Popover Content {%- endcomment -%}
          {%- liquid
            assign title_color = block.settings.title_color | default: '#000000'
            assign description_color = block.settings.description_color | default: '#666666'
            assign link_color = block.settings.link_color | default: '#000000'
            assign popover_position = block.settings.popover_position | default: 'right'
          -%}

          <div
            id="popover-{{ block.id }}"
            popover
            role="dialog"
            aria-labelledby="popover-title-{{ block.id }}"
            class="hotspot-popover"
            data-position="{{ popover_position }}"
            data-trigger-id="hotspot-{{ block.id }}"
          >
            <div class="hotspot-popover-content w-full md:w-96">
              {%- comment -%} Close button - positioned at top right {%- endcomment -%}
              <button
                class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-black/10 hover:bg-black/20 transition-colors close-popover-btn z-10"
                data-popover-id="popover-{{ block.id }}"
                aria-label="{{ 'accessibility.close' | t }}"
              >
                <i class="ph ph-x text-base"></i>
              </button>

              <div class="p-6 pr-14">
                {% if block.settings.title != blank %}
                  <h3 id="popover-title-{{ block.id }}" class="popup-title text-base mb-3" style="color: {{ title_color }};">
                    {{ block.settings.title }}
                  </h3>
                {% endif %}

                {% if block.settings.text != blank %}
                  <p class="text-sm leading-relaxed {% if block.settings.link_text != blank %}mb-4{% endif %}" style="color: {{ description_color }};">
                    {{ block.settings.text }}
                  </p>
                {% endif %}

                {% if block.settings.link_text != blank %}
                  <a
                    href="{{ block.settings.link_url | default: '#' }}"
                    class="inline-flex items-center gap-2 text-sm font-medium hover:gap-3 transition-all"
                    style="color: {{ link_color }};"
                  >
                    {{ block.settings.link_text }}
                    <i class="ph ph-arrow-right"></i>
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const sectionId = '{{ section.id }}';
  const section = document.querySelector('[data-hotspots-section="' + sectionId + '"]');
  if (!section) return;

  // Prevent duplicate initialization
  if (section.dataset.initialized) return;
  section.dataset.initialized = 'true';

  // Position popovers relative to their triggers
  function positionPopover(popover) {
    const triggerId = popover.dataset.triggerId;
    if (!triggerId) return;

    const trigger = document.querySelector('[popovertarget="' + popover.id + '"]');
    if (!trigger) return;

    // Skip positioning on mobile (popover is fixed to bottom)
    if (window.innerWidth < 768) return;

    const triggerRect = trigger.getBoundingClientRect();
    const popoverRect = popover.getBoundingClientRect();
    const position = popover.dataset.position || 'right';
    const gap = 20;

    let left, top;

    switch(position) {
      case 'right':
        left = triggerRect.right + gap;
        top = triggerRect.top + (triggerRect.height / 2) - (popoverRect.height / 2);
        break;
      case 'left':
        left = triggerRect.left - popoverRect.width - gap;
        top = triggerRect.top + (triggerRect.height / 2) - (popoverRect.height / 2);
        break;
      case 'top':
        left = triggerRect.left + (triggerRect.width / 2) - (popoverRect.width / 2);
        top = triggerRect.top - popoverRect.height - gap;
        break;
      case 'bottom':
        left = triggerRect.left + (triggerRect.width / 2) - (popoverRect.width / 2);
        top = triggerRect.bottom + gap;
        break;
      default:
        left = triggerRect.right + gap;
        top = triggerRect.top + (triggerRect.height / 2) - (popoverRect.height / 2);
    }

    // Keep within viewport
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;

    if (left + popoverRect.width > viewportWidth) {
      left = triggerRect.left - popoverRect.width - gap;
    }
    if (left < 0) {
      left = gap;
    }
    if (top + popoverRect.height > viewportHeight) {
      top = viewportHeight - popoverRect.height - gap;
    }
    if (top < 0) {
      top = gap;
    }

    popover.style.left = left + 'px';
    popover.style.top = top + 'px';
  }

  // Get all hotspot triggers for keyboard navigation
  const triggers = Array.from(section.querySelectorAll('[data-hotspot-trigger]'));

  // Get all popovers in this section by finding triggers and their targets
  const popovers = Array.from(section.querySelectorAll('[data-hotspot-trigger]')).map(function(trigger) {
    return document.getElementById(trigger.getAttribute('popovertarget'));
  }).filter(Boolean);

  // Update aria-expanded when popovers toggle
  popovers.forEach(function(popover) {
    popover.addEventListener('toggle', function(event) {
      const trigger = document.querySelector('[popovertarget="' + popover.id + '"]');

      if (event.newState === 'open') {
        // Update aria-expanded
        if (trigger) trigger.setAttribute('aria-expanded', 'true');

        // Close other popovers and update their aria-expanded
        popovers.forEach(function(otherPopover) {
          if (otherPopover !== popover && otherPopover.matches(':popover-open')) {
            otherPopover.hidePopover();
            const otherTrigger = document.querySelector('[popovertarget="' + otherPopover.id + '"]');
            if (otherTrigger) otherTrigger.setAttribute('aria-expanded', 'false');
          }
        });

        positionPopover(popover);

        // Focus the close button for accessibility
        const closeBtn = popover.querySelector('.close-popover-btn');
        if (closeBtn) {
          requestAnimationFrame(function() { closeBtn.focus(); });
        }
      } else {
        // Update aria-expanded when closed
        if (trigger) trigger.setAttribute('aria-expanded', 'false');
      }
    });
  });

  // Keyboard navigation between hotspots
  section.addEventListener('keydown', function(event) {
    const currentTrigger = document.activeElement;
    if (!currentTrigger || !currentTrigger.hasAttribute('data-hotspot-trigger')) return;

    const currentIndex = triggers.indexOf(currentTrigger);
    if (currentIndex === -1) return;

    let nextIndex;

    switch (event.key) {
      case 'ArrowRight':
      case 'ArrowDown':
        event.preventDefault();
        nextIndex = (currentIndex + 1) % triggers.length;
        triggers[nextIndex].focus();
        break;
      case 'ArrowLeft':
      case 'ArrowUp':
        event.preventDefault();
        nextIndex = (currentIndex - 1 + triggers.length) % triggers.length;
        triggers[nextIndex].focus();
        break;
      case 'Home':
        event.preventDefault();
        triggers[0].focus();
        break;
      case 'End':
        event.preventDefault();
        triggers[triggers.length - 1].focus();
        break;
    }
  });

  // Handle close buttons - return focus to trigger
  section.querySelectorAll('.close-popover-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      const popover = e.target.closest('[popover]');
      if (popover) {
        const trigger = document.querySelector('[popovertarget="' + popover.id + '"]');
        popover.hidePopover();
        // Return focus to the trigger button
        if (trigger) trigger.focus();
      }
    });
  });

  // Close popovers on scroll (desktop only)
  window.addEventListener('scroll', function() {
    if (window.innerWidth >= 768) {
      popovers.forEach(function(popover) {
        if (popover.matches(':popover-open')) {
          popover.hidePopover();
        }
      });
    }
  });

  // Reposition on resize (debounced)
  let hotspotsResizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(hotspotsResizeTimeout);
    hotspotsResizeTimeout = setTimeout(function() {
      popovers.forEach(function(popover) {
        if (popover.matches(':popover-open')) {
          positionPopover(popover);
        }
      });
    }, 150);
  });
})();
</script>

{% schema %}
{
  "name": "t:sections.hotspots.name",
  "tag": "section",
  "class": "hotspots-section",
  "max_blocks": 10,
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.content"
    },
    {
      "type": "text",
      "id": "label",
      "label": "t:shared.settings.label.label",
      "default": "t:sections.hotspots.settings.label.default"
    },
    {
      "type": "text",
      "id": "title",
      "label": "t:shared.settings.title.label",
      "default": "t:sections.hotspots.settings.title.default"
    },
    {
      "type": "textarea",
      "id": "text",
      "label": "t:shared.settings.text.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.images"
    },
    {
      "type": "image_picker",
      "id": "desktop_image",
      "label": "t:sections.hotspots.settings.desktop_image.label",
      "info": "t:sections.hotspots.settings.desktop_image.info"
    },
    {
      "type": "image_picker",
      "id": "mobile_image",
      "label": "t:sections.hotspots.settings.mobile_image.label",
      "info": "t:sections.hotspots.settings.mobile_image.info"
    },
    {
      "type": "header",
      "content": "t:shared.headers.layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "t:shared.settings.full_width.label",
      "default": false
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "label": "t:shared.settings.header_alignment.label",
      "default": "left"
    },
    {
      "type": "select",
      "id": "padding",
      "label": "t:shared.settings.padding.label",
      "info": "t:shared.settings.padding.info",
      "default": "default",
      "options": [
        {
          "value": "default",
          "label": "t:shared.settings.padding.options__2.label"
        },
        {
          "value": "small",
          "label": "t:shared.settings.padding.options__1.label"
        },
        {
          "value": "large",
          "label": "t:shared.settings.padding.options__3.label"
        },
        {
          "value": "none",
          "label": "t:shared.settings.padding.options__0.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-1"
    }
  ],
  "blocks": [
    {
      "type": "hotspot",
      "name": "t:sections.hotspots.blocks.hotspot.name",
      "settings": [
        {
          "type": "header",
          "content": "t:sections.hotspots.blocks.hotspot.settings.header__position.content"
        },
        {
          "type": "range",
          "id": "position_x",
          "label": "t:shared.settings.position_x.label",
          "default": 50,
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%"
        },
        {
          "type": "range",
          "id": "position_y",
          "label": "t:shared.settings.position_y.label",
          "default": 50,
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%"
        },
        {
          "type": "range",
          "id": "position_x_mobile",
          "label": "t:shared.settings.position_x_mobile.label",
          "default": 50,
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%"
        },
        {
          "type": "range",
          "id": "position_y_mobile",
          "label": "t:shared.settings.position_y_mobile.label",
          "default": 50,
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%"
        },
        {
          "type": "header",
          "content": "t:shared.headers.content"
        },
        {
          "type": "text",
          "id": "title",
          "label": "t:shared.settings.title.label",
          "default": "t:shared.defaults.feature_title"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "t:shared.settings.text.label",
          "default": "t:sections.hotspots.blocks.hotspot.settings.text.default"
        },
        {
          "type": "text",
          "id": "link_text",
          "label": "t:shared.settings.link_text.label"
        },
        {
          "type": "url",
          "id": "link_url",
          "label": "t:sections.hotspots.blocks.hotspot.settings.link_url.label"
        },
        {
          "type": "header",
          "content": "t:sections.hotspots.blocks.hotspot.settings.header__dot_appearance.content"
        },
        {
          "type": "color",
          "id": "dot_color",
          "label": "t:shared.settings.dot_color.label",
          "default": "#000000"
        },
        {
          "type": "color",
          "id": "icon_color",
          "label": "t:shared.settings.icon_color.label",
          "default": "#ffffff"
        },
        {
          "type": "header",
          "content": "t:sections.hotspots.blocks.hotspot.settings.header__popover_appearance.content"
        },
        {
          "type": "select",
          "id": "popover_position",
          "label": "t:sections.hotspots.blocks.hotspot.settings.popover_position.label",
          "default": "right",
          "options": [
            {
              "value": "top",
              "label": "t:shared.options.top"
            },
            {
              "value": "right",
              "label": "t:shared.options.right"
            },
            {
              "value": "bottom",
              "label": "t:shared.options.bottom"
            },
            {
              "value": "left",
              "label": "t:shared.options.left"
            }
          ]
        },
        {
          "type": "color",
          "id": "title_color",
          "label": "t:sections.hotspots.blocks.hotspot.settings.title_color.label",
          "default": "#000000"
        },
        {
          "type": "color",
          "id": "description_color",
          "label": "t:sections.hotspots.blocks.hotspot.settings.description_color.label",
          "default": "#666666"
        },
        {
          "type": "color",
          "id": "link_color",
          "label": "t:sections.hotspots.blocks.hotspot.settings.link_color.label",
          "default": "#000000"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.hotspots.presets.hotspots.name",
      "category": "t:sections.hotspots.presets.hotspots.category",
      "blocks": [
        {
          "type": "hotspot",
          "settings": {
            "position_x": 25,
            "position_y": 30,
            "title": "t:sections.hotspots.presets.hotspots.blocks.hotspot.0.title",
            "text": "t:sections.hotspots.presets.hotspots.blocks.hotspot.0.text"
          }
        },
        {
          "type": "hotspot",
          "settings": {
            "position_x": 75,
            "position_y": 40,
            "title": "t:sections.hotspots.presets.hotspots.blocks.hotspot.1.title",
            "text": "t:sections.hotspots.presets.hotspots.blocks.hotspot.1.text"
          }
        },
        {
          "type": "hotspot",
          "settings": {
            "position_x": 50,
            "position_y": 70,
            "title": "t:sections.hotspots.presets.hotspots.blocks.hotspot.2.title",
            "text": "t:sections.hotspots.presets.hotspots.blocks.hotspot.2.text"
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}
