{%- comment -%}
  Before/After Comparison Section - Interactive image comparison slider
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width
  endcapture

  capture header_align_class
    render 'alignment-classes', alignment: section.settings.header_alignment, output: 'text'
  endcapture
-%}

<section
  class="before-after-section section-padding color-{{ section.settings.color_scheme }}{% if section.settings.full_width %} is-full-width{% endif %}"
  data-before-after-section="{{ section.id }}"
  style="--before-after-aspect-ratio: {{ section.settings.aspect_ratio }};"
>
  <div class="{{ container_class }}">
    {%- comment -%} Header {%- endcomment -%}
    {% if section.settings.label != blank or section.settings.title != blank %}
      <div class="before-after-header {{ header_align_class }}" data-tween-group="before-after-header-{{ section.id }}">
        {% render 'section-header',
          label: section.settings.label,
          title: section.settings.title,
          description: section.settings.description,
          alignment: section.settings.header_alignment,
          nowrap: true
        %}
      </div>
    {% endif %}

    {%- comment -%} Comparison Slider {%- endcomment -%}
    <div
      class="before-after-container bg-(--color-background-secondary)"
      data-before-after-container
      data-tween data-tween-type="fade-up"
      role="img"
      aria-label="{{ 'sections.before_after.comparison_label' | t: before: section.settings.before_label, after: section.settings.after_label }}"
    >
      {%- comment -%} After Image (Background) {%- endcomment -%}
      {% if section.settings.image_after != blank %}
        {{ section.settings.image_after | image_url: width: 2000 | image_tag:
          class: 'before-after-image',
          loading: 'lazy',
          decoding: 'async',
          sizes: '(max-width: 1000px) 100vw, 1000px',
          widths: '600, 800, 1000, 1200, 1600, 2000',
          alt: section.settings.after_label
        }}
      {% else %}
        {{ 'product-1' | placeholder_svg_tag: 'before-after-image' }}
      {% endif %}

      {%- comment -%} Before Image (Overlay) {%- endcomment -%}
      <div class="before-after-before" data-before-after-before>
        {% if section.settings.image_before != blank %}
          {{ section.settings.image_before | image_url: width: 2000 | image_tag:
            class: 'before-after-image',
            loading: 'lazy',
            decoding: 'async',
            sizes: '(max-width: 1000px) 100vw, 1000px',
            widths: '600, 800, 1000, 1200, 1600, 2000',
            alt: section.settings.before_label
          }}
        {% else %}
          {{ 'product-2' | placeholder_svg_tag: 'before-after-image' }}
        {% endif %}
      </div>

      {%- comment -%} Handle {%- endcomment -%}
      <div class="before-after-handle" data-before-after-handle>
        <button
          class="before-after-handle-btn"
          aria-label="{{ 'accessibility.drag_to_compare' | t }}"
          tabindex="0"
        >
          <i class="ph ph-caret-left"></i>
          <i class="ph ph-caret-right"></i>
        </button>
      </div>

      {%- comment -%} Labels {%- endcomment -%}
      {% if section.settings.show_labels %}
        <div class="before-after-labels">
          <span class="before-after-label-tag text-label">{{ section.settings.before_label }}</span>
          <span class="before-after-label-tag text-label">{{ section.settings.after_label }}</span>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<script>
(function() {
  const section = document.querySelector('[data-before-after-section="{{ section.id }}"]');
  if (!section || section.dataset.beforeAfterInitialized) return;
  section.dataset.beforeAfterInitialized = 'true';

  // Header animations handled by global TweenManager via data-tween attributes

  // Slider functionality
  const container = section.querySelector('[data-before-after-container]');
  const before = section.querySelector('[data-before-after-before]');
  const handle = section.querySelector('[data-before-after-handle]');
  const beforeImage = before ? before.querySelector('img, svg') : null;

  if (!container || !before || !handle) return;

  // Set before image width to match container width (prevents scaling when dragging)
  function updateBeforeImageWidth() {
    if (beforeImage) {
      beforeImage.style.width = container.offsetWidth + 'px';
    }
  }

  updateBeforeImageWidth();
  // Debounced resize handler
  let beforeAfterResizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(beforeAfterResizeTimeout);
    beforeAfterResizeTimeout = setTimeout(updateBeforeImageWidth, 150);
  });

  let isDragging = false;

  function updatePosition(x) {
    const rect = container.getBoundingClientRect();
    let position = (x - rect.left) / rect.width;
    position = Math.max(0, Math.min(1, position));

    const percentage = position * 100;
    before.style.width = `${percentage}%`;
    handle.style.left = `${percentage}%`;
  }

  function startDrag(e) {
    isDragging = true;
    container.style.cursor = 'grabbing';

    const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    updatePosition(x);
  }

  function onDrag(e) {
    if (!isDragging) return;

    const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    updatePosition(x);
  }

  function endDrag() {
    isDragging = false;
    container.style.cursor = 'ew-resize';
  }

  // Mouse events
  container.addEventListener('mousedown', startDrag);
  document.addEventListener('mousemove', onDrag);
  document.addEventListener('mouseup', endDrag);

  // Touch events
  container.addEventListener('touchstart', startDrag, { passive: true });
  document.addEventListener('touchmove', onDrag, { passive: true });
  document.addEventListener('touchend', endDrag);

  // Keyboard support
  handle.querySelector('button').addEventListener('keydown', (e) => {
    const currentLeft = parseFloat(handle.style.left) || 50;
    let newPosition = currentLeft;

    if (e.key === 'ArrowLeft') {
      newPosition = Math.max(0, currentLeft - 5);
    } else if (e.key === 'ArrowRight') {
      newPosition = Math.min(100, currentLeft + 5);
    }

    before.style.width = `${newPosition}%`;
    handle.style.left = `${newPosition}%`;
  });
})();
</script>

{% schema %}
{
  "name": "Before/After",
  "tag": "section",
  "class": "before-after-section",
  "settings": [
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "label",
      "default": "Compare",
      "label": "Label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "See the Difference",
      "label": "Title"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "Drag the slider to compare before and after.",
      "label": "Description"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "default": "left",
      "label": "Header alignment"
    },
    {
      "type": "header",
      "content": "Images"
    },
    {
      "type": "image_picker",
      "id": "image_before",
      "label": "Before image"
    },
    {
      "type": "image_picker",
      "id": "image_after",
      "label": "After image"
    },
    {
      "type": "select",
      "id": "aspect_ratio",
      "options": [
        { "value": "16/9", "label": "Landscape (16:9)" },
        { "value": "4/3", "label": "Standard (4:3)" },
        { "value": "1/1", "label": "Square (1:1)" },
        { "value": "3/4", "label": "Portrait (3:4)" }
      ],
      "default": "16/9",
      "label": "Aspect ratio"
    },
    {
      "type": "header",
      "content": "Labels"
    },
    {
      "type": "checkbox",
      "id": "show_labels",
      "default": true,
      "label": "Show labels"
    },
    {
      "type": "text",
      "id": "before_label",
      "default": "Before",
      "label": "Before label"
    },
    {
      "type": "text",
      "id": "after_label",
      "default": "After",
      "label": "After label"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    }
  ],
  "presets": [
    {
      "name": "Before/After",
      "category": "Image & media"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
  }
{% endschema %}
