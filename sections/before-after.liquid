{%- comment -%}
  Before/After Comparison Section - Interactive image comparison slider
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width
  endcapture

  capture header_container_class
    render 'container-class', full_width: false
  endcapture

  capture header_align_class
    render 'alignment-classes', alignment: section.settings.header_alignment, output: 'text'
  endcapture
-%}

<div
  class="before-after-section section-padding{% unless section.settings.padding == 'default' %}-{{ section.settings.padding }}{% endunless %} color-{{ section.settings.color_scheme }}{% if section.settings.full_width %} is-full-width{% endif %}"
  data-before-after-section="{{ section.id }}"
  style="--before-after-aspect-ratio: {{ section.settings.aspect_ratio }};"
>
  {%- comment -%} Header - always contained {%- endcomment -%}
  {% if section.settings.label != blank or section.settings.title != blank %}
    <div class="{{ header_container_class }}">
      <div class="before-after-header {{ header_align_class }}" data-tween-group="before-after-header-{{ section.id }}">
        {% render 'section-header',
          label: section.settings.label,
          title: section.settings.title,
          description: section.settings.description,
          alignment: section.settings.header_alignment,
          nowrap: true
        %}
      </div>
    </div>
  {% endif %}

  {%- comment -%} Comparison Slider {%- endcomment -%}
  <div class="{{ container_class }}">
    <div
      class="before-after-container bg-(--color-background-secondary)"
      data-before-after-container
      data-tween data-tween-type="fade-up"
      role="img"
      aria-label="{{ 'sections.before_after.comparison_label' | t: before: section.settings.before_label, after: section.settings.after_label }}"
    >
      {%- comment -%} After Image (Background) {%- endcomment -%}
      {% if section.settings.image_after != blank %}
        {{ section.settings.image_after | image_url: width: 2000 | image_tag:
          class: 'before-after-image',
          loading: 'lazy',
          decoding: 'async',
          sizes: '(max-width: 1000px) 100vw, 1000px',
          widths: '600, 800, 1000, 1200, 1600, 2000',
          alt: section.settings.after_label
        }}
      {% else %}
        <div class="before-after-image before-after-placeholder bg-neutral-200">
          {{ 'product-1' | placeholder_svg_tag }}
        </div>
      {% endif %}

      {%- comment -%} Before Image (Overlay) {%- endcomment -%}
      <div class="before-after-before" data-before-after-before>
        {% if section.settings.image_before != blank %}
          {{ section.settings.image_before | image_url: width: 2000 | image_tag:
            class: 'before-after-image',
            loading: 'lazy',
            decoding: 'async',
            sizes: '(max-width: 1000px) 100vw, 1000px',
            widths: '600, 800, 1000, 1200, 1600, 2000',
            alt: section.settings.before_label
          }}
        {% else %}
          <div class="before-after-image before-after-placeholder bg-neutral-200">
            {{ 'product-2' | placeholder_svg_tag }}
          </div>
        {% endif %}
      </div>

      {%- comment -%} Handle {%- endcomment -%}
      <div class="before-after-handle" data-before-after-handle>
        <button
          class="before-after-handle-btn"
          aria-label="{{ 'accessibility.drag_to_compare' | t }}"
          tabindex="0"
        >
          <i class="ph ph-caret-left"></i>
          <i class="ph ph-caret-right"></i>
        </button>
      </div>

      {%- comment -%} Labels {%- endcomment -%}
      {% if section.settings.show_labels %}
        <div class="before-after-labels">
          <span class="before-after-label-tag text-label">{{ section.settings.before_label }}</span>
          <span class="before-after-label-tag text-label">{{ section.settings.after_label }}</span>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function() {
  const section = document.querySelector('[data-before-after-section="{{ section.id }}"]');
  if (!section || section.dataset.beforeAfterInitialized) return;
  section.dataset.beforeAfterInitialized = 'true';

  // Header animations handled by global TweenManager via data-tween attributes

  // Slider functionality
  const container = section.querySelector('[data-before-after-container]');
  const before = section.querySelector('[data-before-after-before]');
  const handle = section.querySelector('[data-before-after-handle]');
  const beforeImage = before ? before.querySelector('img, svg') : null;

  if (!container || !before || !handle) return;

  // Set before image width to match container width (prevents scaling when dragging)
  function updateBeforeImageWidth() {
    if (beforeImage) {
      beforeImage.style.width = container.offsetWidth + 'px';
    }
  }

  updateBeforeImageWidth();
  // Debounced resize handler
  let beforeAfterResizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(beforeAfterResizeTimeout);
    beforeAfterResizeTimeout = setTimeout(updateBeforeImageWidth, 150);
  });

  let isDragging = false;

  function updatePosition(x) {
    const rect = container.getBoundingClientRect();
    let position = (x - rect.left) / rect.width;
    position = Math.max(0, Math.min(1, position));

    const percentage = position * 100;
    before.style.width = `${percentage}%`;
    handle.style.left = `${percentage}%`;
  }

  function startDrag(e) {
    isDragging = true;
    container.style.cursor = 'grabbing';

    const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    updatePosition(x);
  }

  function onDrag(e) {
    if (!isDragging) return;

    const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    updatePosition(x);
  }

  function endDrag() {
    isDragging = false;
    container.style.cursor = 'ew-resize';
  }

  // Mouse events
  container.addEventListener('mousedown', startDrag);
  document.addEventListener('mousemove', onDrag);
  document.addEventListener('mouseup', endDrag);

  // Touch events
  container.addEventListener('touchstart', startDrag, { passive: true });
  document.addEventListener('touchmove', onDrag, { passive: true });
  document.addEventListener('touchend', endDrag);

  // Keyboard support
  handle.querySelector('button').addEventListener('keydown', (e) => {
    const currentLeft = parseFloat(handle.style.left) || 50;
    let newPosition = currentLeft;

    if (e.key === 'ArrowLeft') {
      newPosition = Math.max(0, currentLeft - 5);
    } else if (e.key === 'ArrowRight') {
      newPosition = Math.min(100, currentLeft + 5);
    }

    before.style.width = `${newPosition}%`;
    handle.style.left = `${newPosition}%`;
  });
})();
</script>

{% schema %}
{
  "name": "t:sections.before_after.name",
  "tag": "section",
  "class": "before-after-section",
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.content"
    },
    {
      "type": "text",
      "id": "label",
      "default": "t:sections.before_after.settings.label.default",
      "label": "t:sections.before_after.settings.label.label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "t:sections.before_after.settings.title.default",
      "label": "t:shared.settings.title.label"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "t:sections.before_after.settings.description.default",
      "label": "t:shared.settings.description.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.images"
    },
    {
      "type": "image_picker",
      "id": "image_before",
      "label": "t:sections.before_after.settings.image_before.label"
    },
    {
      "type": "image_picker",
      "id": "image_after",
      "label": "t:sections.before_after.settings.image_after.label"
    },
    {
      "type": "select",
      "id": "aspect_ratio",
      "options": [
        {
          "value": "16/9",
          "label": "t:sections.before_after.settings.aspect_ratio.options__0.label"
        },
        {
          "value": "4/3",
          "label": "t:sections.before_after.settings.aspect_ratio.options__1.label"
        },
        {
          "value": "1/1",
          "label": "t:sections.before_after.settings.aspect_ratio.options__2.label"
        },
        {
          "value": "3/4",
          "label": "t:sections.before_after.settings.aspect_ratio.options__3.label"
        }
      ],
      "default": "16/9",
      "label": "t:sections.before_after.settings.aspect_ratio.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.labels"
    },
    {
      "type": "checkbox",
      "id": "show_labels",
      "default": true,
      "label": "t:sections.before_after.settings.show_labels.label"
    },
    {
      "type": "text",
      "id": "before_label",
      "default": "t:sections.before_after.settings.before_label.default",
      "label": "t:sections.before_after.settings.before_label.label"
    },
    {
      "type": "text",
      "id": "after_label",
      "default": "t:sections.before_after.settings.after_label.default",
      "label": "t:sections.before_after.settings.after_label.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "t:shared.settings.full_width.label"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "label": "t:shared.settings.header_alignment.label",
      "default": "left"
    },
    {
      "type": "select",
      "id": "padding",
      "label": "t:shared.settings.padding.label",
      "info": "t:shared.settings.padding.info",
      "default": "default",
      "options": [
        {
          "value": "default",
          "label": "t:shared.settings.padding.options__2.label"
        },
        {
          "value": "small",
          "label": "t:shared.settings.padding.options__1.label"
        },
        {
          "value": "large",
          "label": "t:shared.settings.padding.options__3.label"
        },
        {
          "value": "none",
          "label": "t:shared.settings.padding.options__0.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-1"
    }
  ],
  "presets": [
    {
      "name": "t:sections.before_after.presets.before_after.name",
      "category": "t:sections.before_after.presets.before_after.category"
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}
