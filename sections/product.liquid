{%- comment -%}
  Product Section - Minimal Skeleton + Tailwind UI Design
  With intro animations and split text reveal
{%- endcomment -%}

{% assign current_variant = product.selected_or_first_available_variant %}

<style>
  /* Product intro animation initial states */
  .product-intro .product-intro__image {
    clip-path: inset(0 100% 0 0);
    transform: scale(1.1);
  }

  .product-intro .product-intro__form {
    opacity: 0;
    transform: translateY(30px);
  }

  /* Animated states */
  .product-intro--animated .product-intro__image {
    clip-path: inset(0 0% 0 0);
    transform: scale(1);
  }

  .product-intro--animated .product-intro__form {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<section class="bg-white product-intro" data-product-intro>
  <div class="mx-auto max-w-7xl px-4 py-16 sm:px-6 sm:py-24 lg:px-8">
    <div class="lg:grid lg:grid-cols-2 lg:items-start lg:gap-x-12">

      {%- comment -%} Product Images {%- endcomment -%}
      <div class="space-y-4">
        {% for image in product.images %}
          <div class="aspect-square w-full overflow-hidden rounded-lg bg-gray-100 product-intro__image">
            {{ image | image_url: width: 1200 | image_tag:
              class: 'h-full w-full object-cover object-center',
              loading: forloop.first | default: 'lazy'
            }}
          </div>
        {% else %}
          <div class="aspect-square w-full overflow-hidden rounded-lg bg-gray-100 product-intro__image">
            <div class="flex h-full items-center justify-center">
              <i class="ph ph-image text-6xl text-gray-300"></i>
            </div>
          </div>
        {% endfor %}
      </div>

      {%- comment -%} Product Info {%- endcomment -%}
      <div class="mt-10 px-4 sm:mt-16 sm:px-0 lg:sticky lg:top-24 lg:mt-0">
        <h1 class="product-intro__title text-3xl md:text-4xl lg:text-5xl font-bold tracking-tight text-gray-900">
          {%- assign title_words = product.title | split: ' ' -%}
          {%- for word in title_words -%}
            <span class="overflow-hidden inline-block"><span class="inline-block">{{ word }}</span></span>{% unless forloop.last %} {% endunless %}
          {%- endfor -%}
        </h1>

        {%- comment -%} Price {%- endcomment -%}
        <div class="mt-3 product-intro__price" id="product-price">
          <p class="text-3xl tracking-tight text-gray-900 overflow-hidden" data-product-price>
            <span class="inline-block">{{ current_variant.price | money }}</span>
          </p>
          {% if current_variant.compare_at_price > current_variant.price %}
            <p class="mt-1 text-sm text-gray-500 line-through overflow-hidden" data-compare-price>
              <span class="inline-block">{{ current_variant.compare_at_price | money }}</span>
            </p>
          {% endif %}
        </div>

        {%- comment -%} Description {%- endcomment -%}
        <div class="mt-6 product-intro__description">
          <div class="prose prose-sm text-gray-600">
            {%- assign desc_words = product.description | strip_html | split: ' ' -%}
            {%- for word in desc_words -%}
              <span class="overflow-hidden inline-block"><span class="inline-block">{{ word }}</span></span>{% unless forloop.last %} {% endunless %}
            {%- endfor -%}
          </div>
        </div>

        {%- comment -%} Product Form {%- endcomment -%}
        <div class="mt-8 product-intro__form">
          {% form 'product', product %}
            {%- comment -%} Variant Selector {%- endcomment -%}
            <div class="mb-6">
              <label for="variant-select" class="block text-sm font-medium text-gray-700">Options</label>
              <select
                id="variant-select"
                name="id"
                class="mt-2 block w-full rounded-md border-0 py-3 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
              >
                {% for variant in product.variants %}
                  <option
                    value="{{ variant.id }}"
                    {% if variant == current_variant %}selected{% endif %}
                  >
                    {{ variant.title }} - {{ variant.price | money }}
                  </option>
                {% endfor %}
              </select>
            </div>

            {%- comment -%} Quantity {%- endcomment -%}
            <div class="mb-6">
              <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
              <input
                type="number"
                id="quantity"
                name="quantity"
                value="1"
                min="1"
                class="mt-2 block w-20 rounded-md border-0 py-2 px-3 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm"
              >
            </div>

            {%- comment -%} Add to Cart Button {%- endcomment -%}
            <button
              type="submit"
              data-add-to-cart
              class="flex w-full items-center justify-center rounded-md border border-transparent bg-indigo-600 px-8 py-3 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:bg-gray-300 disabled:cursor-not-allowed"
              {% unless current_variant.available %}disabled{% endunless %}
            >
              {% if current_variant.available %}
                <i class="ph ph-bag mr-2"></i>Add to cart
              {% else %}
                Sold out
              {% endif %}
            </button>

            {%- comment -%} Dynamic Checkout {%- endcomment -%}
            <div class="mt-4 [&_.shopify-payment-button__button]:rounded-md [&_.shopify-payment-button__button]:py-3">
              {{ form | payment_button }}
            </div>
          {% endform %}
        </div>
      </div>

    </div>
  </div>
</section>

<script>
  (function() {
    const variants = {{ product.variants | json }};
    const moneyFormat = {{ shop.money_format | json }};
    const select = document.getElementById('variant-select');
    const priceEl = document.querySelector('[data-product-price]');
    const compareEl = document.querySelector('[data-compare-price]');
    const addButton = document.querySelector('[data-add-to-cart]');

    function formatMoney(cents) {
      const amount = (cents / 100).toFixed(2);
      return moneyFormat.replace(/\{\{\s*amount\s*\}\}/, amount)
                        .replace(/\{\{\s*amount_no_decimals\s*\}\}/, Math.round(cents / 100))
                        .replace(/\{\{\s*amount_with_comma_separator\s*\}\}/, amount.replace('.', ','));
    }

    if (!select) return;

    select.addEventListener('change', function() {
      const variant = variants.find(v => v.id === parseInt(this.value));
      if (!variant) return;

      // Update price
      if (priceEl) {
        priceEl.textContent = formatMoney(variant.price);
      }

      // Update compare price
      if (compareEl) {
        if (variant.compare_at_price && variant.compare_at_price > variant.price) {
          compareEl.textContent = formatMoney(variant.compare_at_price);
          compareEl.style.display = '';
        } else {
          compareEl.style.display = 'none';
        }
      }

      // Update button state
      if (addButton) {
        if (variant.available) {
          addButton.disabled = false;
          addButton.innerHTML = '<i class="ph ph-bag mr-2"></i>Add to cart';
        } else {
          addButton.disabled = true;
          addButton.textContent = 'Sold out';
        }
      }

      // Update URL with variant
      const url = new URL(window.location);
      url.searchParams.set('variant', variant.id);
      window.history.replaceState({}, '', url);
    });
  })();
</script>

<script>
  /**
   * Product Intro Animation
   * Split text reveal effect with GSAP
   */
  (function() {
    function initProductIntro() {
      const section = document.querySelector('[data-product-intro]');
      if (!section) return;
      if (section.dataset.introInitialized) return;

      // Check for GSAP - wait if not loaded yet
      let gsap = window.gsap;
      if (!gsap && window.pieces && window.pieces.gsap) {
        gsap = window.pieces.gsap;
      }

      if (!gsap) {
        // GSAP not loaded yet, retry shortly
        setTimeout(initProductIntro, 50);
        return;
      }

      section.dataset.introInitialized = 'true';

      const images = section.querySelectorAll('.product-intro__image');
      const titleSpans = section.querySelectorAll('.product-intro__title .overflow-hidden span');
      const priceSpans = section.querySelectorAll('.product-intro__price .overflow-hidden span');
      const descSpans = section.querySelectorAll('.product-intro__description .overflow-hidden span');
      const form = section.querySelector('.product-intro__form');

      // Create timeline
      const tl = gsap.timeline({
        onComplete: () => section.classList.add('product-intro--animated')
      });

      // Small delay to ensure page is ready
      tl.addLabel('start', 0.1);

      // Animate images with clip-path reveal
      if (images.length) {
        tl.to(images, {
          clipPath: 'inset(0 0% 0 0)',
          scale: 1,
          duration: 1,
          ease: 'expo.out',
          stagger: 0.1
        }, 'start');
      }

      // Split text reveal for title - using yPercent
      if (titleSpans.length) {
        gsap.set(titleSpans, { yPercent: 100 });
        tl.to(titleSpans, {
          yPercent: 0,
          duration: 1.2,
          ease: 'power4.out',
          stagger: 0.1
        }, 'start+=0.2');
      }

      // Split text reveal for price
      if (priceSpans.length) {
        gsap.set(priceSpans, { yPercent: 100 });
        tl.to(priceSpans, {
          yPercent: 0,
          duration: 0.8,
          ease: 'power4.out',
          stagger: 0.05
        }, 'start+=0.4');
      }

      // Split text reveal for description
      if (descSpans.length) {
        gsap.set(descSpans, { yPercent: 100 });
        tl.to(descSpans, {
          yPercent: 0,
          duration: 0.8,
          ease: 'power4.out',
          stagger: 0.01
        }, 'start+=0.5');
      }

      // Animate form
      if (form) {
        tl.to(form, {
          y: 0,
          opacity: 1,
          duration: 0.6,
          ease: 'power3.out'
        }, 'start+=0.7');
      }
    }

    // Run when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initProductIntro);
    } else {
      initProductIntro();
    }
  })();
</script>

{% schema %}
{
  "name": "Product",
  "settings": [],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
