
{% assign current_variant = product.selected_or_first_available_variant %}

{% comment %} Dynamic styles that depend on Liquid theme settings {% endcomment %}
<style>
  {% if settings.headings_uppercase %}
    .product-description {
      text-transform: uppercase;
    }
  {% endif %}

  {% if settings.buttons_uppercase %}
    .shopify-payment-button__button,
    .shopify-payment-button__button--unbranded {
      text-transform: uppercase !important;
    }
  {% endif %}
</style>

<div class="product-section-wrapper{% if section.settings.full_width %} is-full-width{% endif %}">
  <div class="product-hero color-{{ section.settings.color_scheme }}" data-product-section>
    <div class="product-gallery{% if section.settings.image_fit != 'cover' %} fit-{{ section.settings.image_fit }}{% endif %}" data-product-gallery>
      <div class="product-gallery-main" data-gallery-main>
        {% for media in product.media %}
          {%- case media.media_type -%}
            {%- when 'image' -%}
              <div
                class="product-gallery-image{% if forloop.first %} is-active{% endif %}"
                data-gallery-image="{{ forloop.index0 }}"
                data-media-id="{{ media.id }}"
                data-media-type="image">
                {%- if forloop.first -%}
                  {{ media | image_url: width: 1800 | image_tag: class: '', loading: 'eager', fetchpriority: 'high', decoding: 'async', sizes: '(max-width: 1024px) 100vw, 55vw', widths: '600, 900, 1200, 1800'
                  }}
                {%- else -%}
                  {{ media | image_url: width: 1800 | image_tag: class: '', loading: 'lazy', decoding: 'async', sizes: '(max-width: 1024px) 100vw, 55vw', widths: '600, 900, 1200, 1800'
                  }}
                {%- endif -%}
                {% if section.settings.enable_lightbox %}
                  <button
                    type="button"
                    class="product-zoom-btn"
                    data-zoom-btn="{{ forloop.index0 }}"
                    aria-label="{{ 'products.product.zoom' | t | default: 'Zoom image' }}">
                    <i class="ph ph-magnifying-glass-plus"></i>
                  </button>
                {% endif %}
              </div>

            {%- when 'video' -%}
              <div
                class="product-gallery-media{% if forloop.first %} is-active{% endif %}"
                data-gallery-image="{{ forloop.index0 }}"
                data-media-id="{{ media.id }}"
                data-media-type="video">
                <div class="product-media-wrapper">
                  <div class="product-media-poster" data-video-poster>
                    {{ media.preview_image | image_url: width: 1800 | image_tag: loading: 'lazy', decoding: 'async', alt: media.alt | default: product.title
                    }}
                    <span class="play-icon" aria-hidden="true">
                      <i class="ph ph-play text-xl"></i>
                    </span>
                  </div>
                  {{ media | video_tag: controls: true, loop: section.settings.video_loop, muted: section.settings.video_autoplay, autoplay: false, preload: 'metadata', class: 'product-video'
                  }}
                </div>
              </div>

            {%- when 'external_video' -%}
              <div
                class="product-gallery-media{% if forloop.first %} is-active{% endif %}"
                data-gallery-image="{{ forloop.index0 }}"
                data-media-id="{{ media.id }}"
                data-media-type="external_video"
                data-external-video-id="{{ media.external_id }}"
                data-external-video-host="{{ media.host }}">
                <div class="product-media-wrapper">
                  <div class="product-media-poster" data-video-poster>
                    {{ media.preview_image | image_url: width: 1800 | image_tag: loading: 'lazy', decoding: 'async', alt: media.alt | default: product.title
                    }}
                    <span class="play-icon" aria-hidden="true">
                      <i class="ph ph-play text-xl"></i>
                    </span>
                  </div>
                  <template data-external-video-template>
                    {%- if media.host == 'youtube' -%}
                      <iframe
                        src="https://www.youtube.com/embed/{{ media.external_id }}?enablejsapi=1&autoplay=1"
                        allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                        loading="lazy"></iframe>
                    {%- elsif media.host == 'vimeo' -%}
                      <iframe
                        src="https://player.vimeo.com/video/{{ media.external_id }}?autoplay=1"
                        allow="autoplay; fullscreen; picture-in-picture"
                        allowfullscreen
                        loading="lazy"></iframe>
                    {%- endif -%}
                  </template>
                </div>
              </div>

            {%- when 'model' -%}
              <div
                class="product-gallery-media{% if forloop.first %} is-active{% endif %}"
                data-gallery-image="{{ forloop.index0 }}"
                data-media-id="{{ media.id }}"
                data-media-type="model">
                <div class="product-media-wrapper">
                  {{ media | model_viewer_tag: reveal: 'interaction', toggleable: true, image_size: '1800x', ar: true, ar-modes: 'webxr scene-viewer quick-look', camera-controls: true, touch-action: 'pan-y', interaction-prompt: 'auto', poster: media.preview_image | image_url: width: 1800
                  }}
                  <div class="model-viewer-ui">
                    <button
                      type="button"
                      data-model-reset
                      aria-label="{{ 'products.product.media.reset_3d_model' | t }}">
                      <i class="ph ph-arrows-counter-clockwise"></i>
                    </button>
                    {%- if media.sources[0].url contains 'usdz' or media.sources[1].url contains 'usdz' -%}
                      <button
                        type="button"
                        data-model-ar
                        aria-label="{{ 'products.product.media.view_in_ar' | t }}">
                        <i class="ph ph-cube"></i>
                      </button>
                    {%- endif -%}
                  </div>
                </div>
              </div>
          {%- endcase -%}
        {% else %}
          <div class="product-gallery-image is-active">
            <div class="w-full h-full flex items-center justify-center bg-(--color-background-secondary)">
              <i class="ph ph-image text-8xl text-(--color-text-secondary) opacity-30"></i>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if product.media.size > 1 %}
        <div class="product-image-counter text-counter" data-image-counter>
          <span class="product-image-counter-current" data-counter-current>01</span>
          <span>/</span>
          <span>{{ product.media.size | prepend: '00' | slice: -2, 2 }}</span>
        </div>

        <div class="product-thumbnails{% if section.settings.thumbnail_position == 'left' %} thumbnails-left{% elsif section.settings.thumbnail_position == 'bottom' %} thumbnails-bottom{% endif %}" data-thumbnails>
          {% for media in product.media %}
            <button
              class="product-thumbnail{% if forloop.first %} is-active{% endif %}"
              data-thumbnail="{{ forloop.index0 }}"
              data-media-id="{{ media.id }}"
              data-media-type="{{ media.media_type }}"
              aria-label="{{ 'accessibility.view_media' | t: index: forloop.index, total: product.media.size }}">
              {{ media.preview_image | image_url: width: 150 | image_tag: loading: 'lazy', decoding: 'async', alt: media.alt | default: product.title }}
              {%- if media.media_type == 'video' or media.media_type == 'external_video' -%}
                <span class="product-thumbnail-icon">
                  <i class="ph ph-play"></i>
                </span>
              {%- elsif media.media_type == 'model' -%}
                <span class="product-thumbnail-icon">
                  <i class="ph ph-cube"></i>
                </span>
              {%- endif -%}
            </button>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="product-info {% if section.settings.full_width %} is-full-width{% endif %}">
      <div class="{% if section.settings.full_width %}lg:max-w-2xl{% endif %}">
        {%- assign product_form_id = 'product-form-' | append: section.id -%}

        {%- for block in section.blocks -%}
          {%- case block.type -%}

            {%- when 'breadcrumbs' -%}
              <div class="mb-4" {{ block.shopify_attributes }}>
                {% render 'breadcrumbs'
                  , separator: block.settings.separator
                  , show_home_icon: block.settings.show_home_icon
                %}
              </div>

            {%- when 'vendor' -%}
              {% if product.vendor != blank %}
                <div
                  class="product-vendor text-meta overflow-hidden"
                  data-tween
                  data-tween-type="fade-up"
                  {{ block.shopify_attributes }}>
                  <span class="inline-block">{{ product.vendor }}</span>
                </div>
              {% endif %}

            {%- when 'title' -%}
              <h1 class="product-title font-heading" {{ block.shopify_attributes }}>
                {%- if block.settings.split_words -%}
                  {%- assign title_words = product.title | split: ' ' -%}
                  {%- for word in title_words -%}
                    <span class="product-title-line">
                      <span class="inline-block">{{ word }}</span>
                    </span>
                  {%- endfor -%}
                {%- else -%}
                  <span class="product-title-line">
                    <span class="inline-block">{{ product.title }}</span>
                  </span>
                {%- endif -%}
              </h1>

            {%- when 'price' -%}
              <div
                class="product-price-display mt-6"
                data-tween
                data-tween-type="fade-up"
                data-price-display
                {{ block.shopify_attributes }}>
                {% if current_variant.compare_at_price > current_variant.price %}
                  <span class="compare-price" data-compare-price>{{ current_variant.compare_at_price | money }}</span>
                {% endif %}
                <span data-product-price>{{ current_variant.price | money }}</span>
                {% if settings.show_sale_badge %}
                  <span class="badge badge--sale{% unless current_variant.compare_at_price > current_variant.price %} hidden{% endunless %}" data-sale-badge>
                    {%- assign save_percent = current_variant.compare_at_price | minus: current_variant.price | times: 100.0 | divided_by: current_variant.compare_at_price | round -%}
                    -<span data-sale-percent>{{ save_percent }}</span>%
                  </span>
                {% endif %}
                {%- if current_variant.unit_price_measurement -%}
                  <div class="unit-price text-sm text-(--color-text-secondary) mt-1" data-unit-price>
                    <span class="visually-hidden">{{ 'accessibility.unit_price_separator' | t }}</span>
                    <span data-unit-price-value>{{ current_variant.unit_price | money }}</span>/<span data-unit-price-unit>{{ current_variant.unit_price_measurement.reference_value }}{{ current_variant.unit_price_measurement.reference_unit }}</span>
                  </div>
                {%- endif -%}
              </div>

            {%- when 'inventory_countdown' -%}
              <div
                class="mt-4"
                data-tween
                data-tween-type="fade-up"
                data-inventory-block
                {{ block.shopify_attributes }}>
                {% render 'inventory-countdown'
                  , variant: current_variant
                  , threshold: block.settings.threshold
                  , show_exact: block.settings.show_exact_count
                  , style: block.settings.style
                  , icon: block.settings.show_icon
                %}
              </div>

            {%- when 'description' -%}
              {% if product.description != blank %}
                {%- assign desc_text = product.description | strip_html | truncate: block.settings.truncate_length -%}
                <div
                  class="product-description"
                  {% if block.settings.enable_shuffle %}
                  data-shuffle-text
                  data-original-text="{{ desc_text | escape }}"
                  {% else %}
                  data-tween
                  data-tween-type="fade-up"
                  {% endif %}
                  {{ block.shopify_attributes }}>
                  {{ desc_text }}
                </div>
              {% endif %}

            {%- when 'variant_picker' -%}
              {% if product.variants.size > 1 %}
                <div
                  class="mt-8"
                  data-tween
                  data-tween-type="fade-up">
                  {% render 'product-variant-picker'
                    , product: product
                    , block: block
                    , product_form_id: product_form_id
                    , section_id: section.id
                  %}
                </div>
              {% endif %}

            {%- when 'quantity_selector' -%}
              <div
                class="product-form-group mt-8"
                data-tween
                data-tween-type="fade-up"
                {{ block.shopify_attributes }}>
                <label class="product-form-label text-label-sm">
                  {% if block.settings.label != blank %}
                    {{ block.settings.label }}
                  {% else %}
                    {{ 'products.product.quantity' | t }}{% endif %}
                </label>
                <div class="product-quantity" data-quantity-wrapper>
                  <button
                    type="button"
                    class="product-quantity-btn"
                    data-quantity-minus
                    aria-label="{{ 'products.product.decrease_quantity' | t }}">
                    <i class="ph ph-minus"></i>
                  </button>
                  <div class="product-quantity-value border-none!">
                    <input
                      type="number"
                      id="quantity-{{ section.id }}"
                      name="quantity"
                      form="{{ product_form_id }}"
                      value="1"
                      min="1"
                      class="product-quantity-input border-none!"
                      data-quantity-input
                      aria-label="{{ 'products.product.quantity' | t }}">
                  </div>
                  <button
                    type="button"
                    class="product-quantity-btn"
                    data-quantity-plus
                    aria-label="{{ 'products.product.increase_quantity' | t }}">
                    <i class="ph ph-plus"></i>
                  </button>
                </div>
              </div>

            {%- when 'buy_buttons' -%}
              <div
                class="product-form"
                data-tween
                data-tween-type="fade-up"
                data-product-form
                {{ block.shopify_attributes }}>
                {% form 'product'
                  , product
                  , id: product_form_id %}
                  {%- comment -%} Hidden variant input if no variant picker block or single variant {%- endcomment -%}
                  {%- assign needs_hidden_input = false -%}
                  {%- if product.has_only_default_variant or product.variants.size == 1 -%}
                    {%- comment -%} Single variant - always need hidden input {%- endcomment -%}
                    {%- assign needs_hidden_input = true -%}
                  {%- else -%}
                    {%- comment -%} Multiple variants - check if variant picker block exists {%- endcomment -%}
                    {%- assign has_variant_picker = false -%}
                    {%- for b in section.blocks -%}
                      {%- if b.type == 'variant_picker' -%}
                        {%- assign has_variant_picker = true -%}
                        {%- break -%}
                      {%- endif -%}
                    {%- endfor -%}
                    {%- unless has_variant_picker -%}
                      {%- assign needs_hidden_input = true -%}
                    {%- endunless -%}
                  {%- endif -%}
                  {%- if needs_hidden_input -%}
                    <input
                      type="hidden"
                      name="id"
                      value="{{ current_variant.id }}">
                {%- endif -%}

                  {%- comment -%} Gift Card Recipient - Required for Theme Store {%- endcomment -%}
                  {%- render 'gift-card-recipient'
                    , product: product
                    , form: form
                    , section: section -%}

                  {%- liquid
                    if block.settings.add_to_cart_text != blank
                      assign btn_add_to_cart = block.settings.add_to_cart_text
                    else
                      assign btn_add_to_cart = 'products.product.add_to_cart' | t
                    endif
                    if block.settings.sold_out_text != blank
                      assign btn_sold_out = block.settings.sold_out_text
                    else
                      assign btn_sold_out = 'products.product.sold_out' | t
                    endif
                  -%}
                  <button
                    type="submit"
                    class="btn btn--primary btn--lg btn--full product-add-btn"
                    data-add-to-cart
                    {% unless current_variant.available %}
                    disabled{% endunless %}>
                    <span class="product-add-btn-text">
                      {% if current_variant.available %}
                        <i class="ph ph-bag"></i>
                        {% render 'button-text', text: btn_add_to_cart %}
                      {% else %}
                        {% render 'button-text', text: btn_sold_out %}
                      {% endif %}
                    </span>
                  </button>

                  {% if block.settings.show_dynamic_checkout and current_variant.available %}
                    <div>
                      {{ form | payment_button }}
                    </div>
                {% endif %}

                  {%- comment -%} Shop Pay Installments - Required for Theme Store {%- endcomment -%}
                  {{ form | payment_terms }}
                {% endform %}
              </div>

            {%- when 'pickup_availability' -%}
              {% if current_variant.available %}
                <div
                  data-tween
                  data-tween-type="fade-up"
                  data-pickup-availability
                  {{ block.shopify_attributes }}>
                  {%- render 'pickup-availability'
                    , product: product -%}
                </div>
              {% endif %}

            {%- when 'delivery_estimator' -%}
              {% if current_variant.available %}
                <div
                  data-tween
                  data-tween-type="fade-up"
                  data-delivery-estimator
                  {{ block.shopify_attributes }}>
                  {%- render 'delivery-estimator' -%}
                </div>
              {% endif %}

            {%- when 'social_proof' -%}
              <div
                data-tween
                data-tween-type="fade-up"
                {{ block.shopify_attributes }}>
                {%- render 'social-proof'
                  , product: product -%}
              </div>

            {%- when 'text' -%}
              <div
                class="product-custom-text mt-4 text-sm text-(--color-text-secondary)"
                data-tween
                data-tween-type="fade-up"
                {{ block.shopify_attributes }}>
                {{ block.settings.text }}
              </div>

            {%- when 'collapsible_tab' -%}
              <details
                class="product-accordion border-t border-(--color-border) group first-of-type:mt-4"
                data-tween
                data-tween-type="fade-up"
                {{ block.shopify_attributes }}>
                <summary class="flex items-center justify-between py-4 cursor-pointer list-none [&::-webkit-details-marker]:hidden">
                  <span class="text-sm font-medium">{{ block.settings.heading }}</span>
                  <i class="ph ph-plus text-sm group-open:hidden"></i>
                  <i class="ph ph-minus text-sm hidden group-open:inline"></i>
                </summary>
                <div class="pb-4 text-sm text-(--color-text-secondary) leading-relaxed">
                  {{ block.settings.content }}
                </div>
              </details>

            {%- when 'size_chart' -%}
              {%- comment -%} Size chart link and modal - excluded from gift cards {%- endcomment -%}
              {%- liquid
                assign has_size_option = false
                unless product.gift_card?
                  for option in product.options
                    assign option_downcase = option | downcase
                    if option_downcase contains 'size' or option_downcase contains 'taille'
                      assign has_size_option = true
                      break
                    endif
                  endfor
                endunless
              -%}
              {% unless product.gift_card? %}
                {% if has_size_option or block.settings.show_always %}
                  {%- liquid
                    assign link_text = block.settings.link_text
                    if link_text == blank
                      assign link_text = 'products.size_chart.title' | t
                    endif
                    assign drawer_heading = block.settings.drawer_heading
                    if drawer_heading == blank
                      assign drawer_heading = 'products.size_chart.title' | t
                    endif
                  -%}
                  <div
                    class="size-chart-trigger mt-4"
                    data-tween
                    data-tween-type="fade-up"
                    {{ block.shopify_attributes }}>
                    <button
                      type="button"
                      class="inline-flex items-center gap-2 text-sm text-(--color-text-secondary) hover:text-(--color-primary) transition-colors"
                      data-size-chart-open
                      aria-haspopup="dialog">
                      <i class="ph ph-ruler text-lg"></i>
                      <span class="underline underline-offset-2">{{ link_text }}</span>
                    </button>
                  </div>

                  {%- comment -%} Update global size chart drawer content on open {%- endcomment -%}
                  {%- liquid
                    assign size_chart_page = block.settings.page
                    assign size_chart_content = block.settings.content
                    assign use_page = false
                    assign use_custom = false

                    if size_chart_page != blank
                      assign use_page = true
                    else
                      # For richtext, strip HTML tags and check if actual text content exists
                      assign content_text_only = size_chart_content | strip_html | strip
                      if content_text_only != blank
                        assign use_custom = true
                      endif
                    endif
                  -%}
                  <script>
                                    (function() {
                                      const heading = {{ drawer_heading | json }};
                                      {% if use_page %}
                    const content = {{ size_chart_page.content | json }};
                                      {% elsif use_custom %}
                    const content = {{ size_chart_content | json }};
                                      {% else %}
                    const content = null;
                                      {% endif %}

                                      function updateDrawer() {
                    const drawer = document.getElementById('size-chart-drawer');
                    if (!drawer) return;

                    const titleEl = drawer.querySelector('[data-size-chart-title]');
                    const bodyEl = drawer.querySelector('[data-size-chart-body]');

                    if (titleEl) {
                      titleEl.textContent = heading;
                    }

                    if (bodyEl && content) {
                      bodyEl.innerHTML = '<div class="prose prose-sm max-w-none">' + content + '</div>';
                    }
                                      }

                                      // Update on click (before drawer opens)
                                      document.addEventListener('click', (e) => {
                    if (e.target.closest('[data-size-chart-open]')) {
                      updateDrawer();
                    }
                                      });

                                      // Also update on custom event
                                      document.addEventListener('size-chart:open', updateDrawer);
                                    })();
                  </script>
                {% endif %}
              {% endunless %}

            {%- when 'back_in_stock' -%}
              {%- comment -%} Back in stock notification form {%- endcomment -%}
              <div
                data-tween
                data-tween-type="fade-up"
                {{ block.shopify_attributes }}>
                {% render 'back-in-stock-form'
                  , product: product
                  , variant: current_variant %}
              </div>

            {%- when 'complementary_products' -%}
              {%- comment -%} Complementary Products Block - Horizontal Layout {%- endcomment -%}
              {%- liquid
                assign block_title = block.settings.title
                if block_title == blank
                  assign block_title = 'products.complementary.title' | t
                endif
              -%}
              <div
                class="mt-6"
                data-complementary-block
                data-product-id="{{ product.id }}"
                data-limit="{{ block.settings.products_to_show }}"
                data-show-add-all="{{ block.settings.show_add_all }}"
                data-title="{{ block_title | escape }}"
                style="display: none;"
                {{ block.shopify_attributes }}>
                <p
                  class="section-label section-label--inline mb-3"
                  data-tween
                  data-tween-type="fade-up">{{ block_title }}</p>
                {%- comment -%} Skeleton Loading State {%- endcomment -%}
                <div
                  class="flex flex-col gap-3"
                  data-complementary-loading
                  data-tween
                  data-tween-type="fade-up">
                  {% for i in (1..block.settings.products_to_show) %}
                    <div class="flex items-center gap-3 p-2 border border-(--color-border) rounded-(--card-radius) animate-pulse">
                      <div class="shrink-0 w-12 h-12 rounded-(--card-radius) bg-(--color-text) opacity-10"></div>
                      <div class="flex-1">
                        <div class="h-3.5 w-3/4 bg-(--color-text) opacity-10 rounded"></div>
                        <div class="h-3 w-1/3 bg-(--color-text) opacity-10 rounded mt-1.5"></div>
                      </div>
                      <div class="shrink-0 w-8 h-8 rounded-full bg-(--color-text) opacity-10"></div>
                    </div>
                  {% endfor %}
                </div>
                {%- comment -%} Products List {%- endcomment -%}
                <div
                  class="flex flex-col gap-3"
                  data-complementary-list
                  data-tween
                  data-tween-type="fade-up"
                  style="display: none;"></div>
                {%- if block.settings.show_add_all -%}
                  <button
                    type="button"
                    class="btn btn--secondary btn--sm w-full mt-3 hidden"
                    data-complementary-add-all
                    data-tween
                    data-tween-type="fade-up">
                    <i class="ph ph-plus"></i>
                    <span data-add-all-text>{{ 'products.complementary.add_all' | t }}</span>
                  </button>
                {%- endif -%}
              </div>

            {%- when 'wishlist_button' -%}
              {%- if settings.enable_wishlist -%}
                {%- capture wishlist_product_json -%}
                {"id":{{ product.id | json }},"handle":{{ product.handle | json }},"title":{{ product.title | json }},"url":{{ product.url | json }},"image":{{ product.featured_image | image_url: width: 800 | json }},"price":{{ product.price | json }},"compareAtPrice":{{ product.compare_at_price | default: 0 | json }},"vendor":{{ product.vendor | json }},"available":{{ product.available | json }}}
              {%- endcapture -%}
                <div
                  class="mt-4"
                  data-tween
                  data-tween-type="fade-up"
                  {{ block.shopify_attributes }}>
                  {%- assign wb_icon_size = 'text-base' -%}
                  {%- assign wb_btn_class = 'btn btn--secondary btn--sm' -%}
                  {%- if block.settings.style == 'icon_only' -%}
                    {%- assign wb_icon_size = 'text-xl' -%}
                    {%- assign wb_btn_class = 'w-11 h-11 flex items-center justify-center rounded-full border border-(--color-border) text-(--color-text) transition-all duration-300 hover:bg-(--color-text) hover:text-(--color-background) hover:border-(--color-text)' -%}
                  {%- endif -%}
                  <button
                    type="button"
                    class="product-wishlist-btn {{ wb_btn_class }} [&.is-active]:bg-(--color-sale) [&.is-active]:text-white [&.is-active]:border-(--color-sale)"
                    data-wishlist-toggle="{{ product.id }}"
                    data-product-json='{{ wishlist_product_json | strip_newlines }}'
                    aria-label="{{ 'products.wishlist.add_to_wishlist' | t | default: 'Add to wishlist' }}"
                    aria-pressed="false">
                    {%- if block.settings.style != 'text_only' -%}
                      <i class="ph ph-heart {{ wb_icon_size }}" aria-hidden="true"></i>
                    {%- endif -%}
                    {%- if block.settings.style != 'icon_only' -%}
                      <span data-wishlist-btn-text>{{ 'products.wishlist.add_to_wishlist' | t | default: 'Add to Wishlist' }}</span>
                    {%- endif -%}
                  </button>
                </div>
              {%- endif -%}

            {%- when 'compare_button' -%}
              {%- if settings.enable_compare -%}
                {%- capture compare_product_json -%}
                {"id":{{ product.id | json }},"handle":{{ product.handle | json }},"title":{{ product.title | json }},"url":{{ product.url | json }},"image":{{ product.featured_image | image_url: width: 800 | json }},"price":{{ product.price | json }},"compareAtPrice":{{ product.compare_at_price | default: 0 | json }},"vendor":{{ product.vendor | json }},"type":{{ product.type | json }},"sku":{{ product.selected_or_first_available_variant.sku | json }},"available":{{ product.available | json }}}
              {%- endcapture -%}
                <div
                  class="mt-4"
                  data-tween
                  data-tween-type="fade-up"
                  {{ block.shopify_attributes }}>
                  {%- assign cb_icon_size = 'text-base' -%}
                  {%- assign cb_btn_class = 'btn btn--secondary btn--sm' -%}
                  {%- if block.settings.style == 'icon_only' -%}
                    {%- assign cb_icon_size = 'text-xl' -%}
                    {%- assign cb_btn_class = 'w-11 h-11 flex items-center justify-center rounded-full border border-(--color-border) text-(--color-text) transition-all duration-300 hover:bg-(--color-text) hover:text-(--color-background) hover:border-(--color-text)' -%}
                  {%- endif -%}
                  <button
                    type="button"
                    class="product-compare-btn {{ cb_btn_class }} [&.is-active]:bg-(--color-text) [&.is-active]:text-(--color-background)"
                    data-compare-toggle="{{ product.id }}"
                    data-product-json='{{ compare_product_json | strip_newlines }}'
                    aria-label="{{ 'products.compare.add_to_compare' | t | default: 'Add to compare' }}"
                    aria-pressed="false">
                    {%- if block.settings.style != 'text_only' -%}
                      <i class="ph ph-scales {{ cb_icon_size }}" aria-hidden="true"></i>
                    {%- endif -%}
                    {%- if block.settings.style != 'icon_only' -%}
                      <span data-compare-btn-text>{{ 'products.compare.add_to_compare' | t | default: 'Add to Compare' }}</span>
                    {%- endif -%}
                  </button>
                </div>
              {%- endif -%}

            {%- when 'wc_buttons' -%}
              {%- if settings.enable_wishlist or settings.enable_compare -%}
                {%- capture wc_wishlist_json -%}
                {"id":{{ product.id | json }},"handle":{{ product.handle | json }},"title":{{ product.title | json }},"url":{{ product.url | json }},"image":{{ product.featured_image | image_url: width: 800 | json }},"price":{{ product.price | json }},"compareAtPrice":{{ product.compare_at_price | default: 0 | json }},"vendor":{{ product.vendor | json }},"available":{{ product.available | json }}}
              {%- endcapture -%}
                {%- capture wc_compare_json -%}
                {"id":{{ product.id | json }},"handle":{{ product.handle | json }},"title":{{ product.title | json }},"url":{{ product.url | json }},"image":{{ product.featured_image | image_url: width: 800 | json }},"price":{{ product.price | json }},"compareAtPrice":{{ product.compare_at_price | default: 0 | json }},"vendor":{{ product.vendor | json }},"type":{{ product.type | json }},"sku":{{ product.selected_or_first_available_variant.sku | json }},"available":{{ product.available | json }}}
              {%- endcapture -%}
                {%- assign wc_display_style = block.settings.display_style | default: 'icon_text' -%}
                {%- assign wc_show_icon = true -%}
                {%- assign wc_show_text = true -%}
                {%- assign wc_icon_size = 'text-base' -%}
                {%- assign wc_btn_class = 'btn btn--secondary btn--sm' -%}
                {%- if wc_display_style == 'icon_only' -%}
                  {%- assign wc_show_text = false -%}
                  {%- assign wc_icon_size = 'text-xl' -%}
                  {%- assign wc_btn_class = 'w-11 h-11 flex items-center justify-center rounded-full border border-(--color-border) text-(--color-text) transition-all duration-300 hover:bg-(--color-text) hover:text-(--color-background) hover:border-(--color-text)' -%}
                {%- elsif wc_display_style == 'text_only' -%}
                  {%- assign wc_show_icon = false -%}
                {%- endif -%}
                <div
                  class="mt-4 flex justify-start gap-3"
                  data-tween
                  data-tween-type="fade-up"
                  {{ block.shopify_attributes }}>
                  {%- if settings.enable_wishlist -%}
                    <button
                      type="button"
                      class="{{ wc_btn_class }} product-wishlist-btn [&.is-active]:bg-(--color-sale) [&.is-active]:text-white [&.is-active]:border-(--color-sale)"
                      data-wishlist-toggle="{{ product.id }}"
                      data-product-json='{{ wc_wishlist_json | strip_newlines }}'
                      aria-label="{{ 'products.wishlist.add_to_wishlist' | t | default: 'Add to wishlist' }}"
                      aria-pressed="false">
                      {%- if wc_show_icon -%}
                        <i class="ph ph-heart {{ wc_icon_size }}" aria-hidden="true"></i>
                      {%- endif -%}
                      {%- if wc_show_text -%}
                        <span data-wishlist-btn-text>{{ 'products.wishlist.add_to_wishlist' | t | default: 'Add to Wishlist' }}</span>
                      {%- endif -%}
                    </button>
                  {%- endif -%}
                  {%- if settings.enable_compare -%}
                    <button
                      type="button"
                      class="{{ wc_btn_class }} product-compare-btn [&.is-active]:bg-(--color-text) [&.is-active]:text-(--color-background)"
                      data-compare-toggle="{{ product.id }}"
                      data-product-json='{{ wc_compare_json | strip_newlines }}'
                      aria-label="{{ 'products.compare.add_to_compare' | t | default: 'Add to compare' }}"
                      aria-pressed="false">
                      {%- if wc_show_icon -%}
                        <i class="ph ph-scales {{ wc_icon_size }}" aria-hidden="true"></i>
                      {%- endif -%}
                      {%- if wc_show_text -%}
                        <span data-compare-btn-text>{{ 'products.compare.add_to_compare' | t | default: 'Add to Compare' }}</span>
                      {%- endif -%}
                    </button>
                  {%- endif -%}
                </div>
              {%- endif -%}

            {%- when 'social_actions' -%}
              {%- capture social_wishlist_json -%}
              {"id":{{ product.id | json }},"handle":{{ product.handle | json }},"title":{{ product.title | json }},"url":{{ product.url | json }},"image":{{ product.featured_image | image_url: width: 800 | json }},"price":{{ product.price | json }},"compareAtPrice":{{ product.compare_at_price | default: 0 | json }},"vendor":{{ product.vendor | json }},"available":{{ product.available | json }}}
            {%- endcapture -%}
              {%- capture social_compare_json -%}
              {"id":{{ product.id | json }},"handle":{{ product.handle | json }},"title":{{ product.title | json }},"url":{{ product.url | json }},"image":{{ product.featured_image | image_url: width: 800 | json }},"price":{{ product.price | json }},"compareAtPrice":{{ product.compare_at_price | default: 0 | json }},"vendor":{{ product.vendor | json }},"type":{{ product.type | json }},"sku":{{ product.selected_or_first_available_variant.sku | json }},"available":{{ product.available | json }}}
            {%- endcapture -%}
              <div
                class="mt-4 flex flex-wrap items-center gap-3"
                data-tween
                data-tween-type="fade-up"
                {{ block.shopify_attributes }}>
                {%- if settings.enable_wishlist -%}
                  <button
                    type="button"
                    class="product-wishlist-btn inline-flex items-center justify-center w-10 h-10 border border-(--color-border) rounded-full text-sm transition-all duration-300 hover:border-(--color-text) [&.is-active]:bg-(--color-sale) [&.is-active]:text-white [&.is-active]:border-(--color-sale)"
                    data-wishlist-toggle="{{ product.id }}"
                    data-product-json='{{ social_wishlist_json | strip_newlines }}'
                    aria-label="{{ 'products.wishlist.add_to_wishlist' | t | default: 'Add to wishlist' }}"
                    aria-pressed="false">
                    <i class="ph ph-heart text-lg" aria-hidden="true"></i>
                  </button>
                {%- endif -%}
                {%- if settings.enable_compare -%}
                  <button
                    type="button"
                    class="product-compare-btn inline-flex items-center justify-center w-10 h-10 border border-(--color-border) rounded-full text-sm transition-all duration-300 hover:border-(--color-text) [&.is-active]:bg-(--color-text) [&.is-active]:text-(--color-background)"
                    data-compare-toggle="{{ product.id }}"
                    data-product-json='{{ social_compare_json | strip_newlines }}'
                    aria-label="{{ 'products.compare.add_to_compare' | t | default: 'Add to compare' }}"
                    aria-pressed="false">
                    <i class="ph ph-scales text-lg" aria-hidden="true"></i>
                  </button>
                {%- endif -%}
                {%- if block.settings.show_share -%}
                  {%- liquid
                    assign share_url = shop.url | append: product.url
                    assign share_title = product.title | url_encode
                    assign share_image = product.featured_image | image_url: width: 1200
                  -%}
                  <div class="relative" data-share-wrapper>
                    <button
                      type="button"
                      class="product-share-btn inline-flex items-center justify-center w-10 h-10 border border-(--color-border) rounded-full text-sm transition-all duration-300 hover:border-(--color-text) hover:bg-(--color-text) hover:text-(--color-background)"
                      data-share-trigger
                      data-share-url="{{ share_url }}"
                      data-share-title="{{ product.title | escape }}"
                      aria-label="{{ 'products.product.share' | t | default: 'Share' }}"
                      aria-expanded="false"
                      aria-haspopup="true">
                      <i class="ph ph-share-network text-lg" aria-hidden="true"></i>
                    </button>
                  </div>
                  {%- comment -%} Share popup rendered outside section via portal {%- endcomment -%}
                  <template data-share-popup-template>
                    <div
                      class="share-popup fixed bg-(--color-background) border border-(--color-border) shadow-xl p-4 opacity-0 invisible translate-y-2 transition-all duration-200 z-9999 min-w-[200px]"
                      data-share-popup
                      role="menu">
                      <p class="text-sm font-semibold uppercase tracking-widest text-(--color-text-secondary) mb-3">{{ 'general.share' | t }}</p>
                      <div class="flex flex-col gap-2">
                        <a
                          href="https://www.facebook.com/sharer/sharer.php?u={{ share_url }}"
                          target="_blank"
                          rel="noopener"
                          class="flex items-center gap-3 py-2 px-3 text-sm text-(--color-text) hover:bg-(--color-background-secondary) transition-colors duration-200"
                          role="menuitem"
                          aria-label="{{ 'accessibility.share_on_facebook' | t }}">
                          <i class="ph ph-facebook-logo text-lg"></i>
                          <span>Facebook</span>
                        </a>
                        <a
                          href="https://twitter.com/intent/tweet?url={{ share_url }}&text={{ share_title }}"
                          target="_blank"
                          rel="noopener"
                          class="flex items-center gap-3 py-2 px-3 text-sm text-(--color-text) hover:bg-(--color-background-secondary) transition-colors duration-200"
                          role="menuitem"
                          aria-label="{{ 'accessibility.share_on_twitter' | t }}">
                          <i class="ph ph-x-logo text-lg"></i>
                          <span>X (Twitter)</span>
                        </a>
                        <a
                          href="https://pinterest.com/pin/create/button/?url={{ share_url }}&media={{ share_image }}&description={{ share_title }}"
                          target="_blank"
                          rel="noopener"
                          class="flex items-center gap-3 py-2 px-3 text-sm text-(--color-text) hover:bg-(--color-background-secondary) transition-colors duration-200"
                          role="menuitem"
                          aria-label="{{ 'accessibility.share_on_pinterest' | t }}">
                          <i class="ph ph-pinterest-logo text-lg"></i>
                          <span>Pinterest</span>
                        </a>
                        <a
                          href="mailto:?subject={{ share_title }}&body={{ share_url }}"
                          class="flex items-center gap-3 py-2 px-3 text-sm text-(--color-text) hover:bg-(--color-background-secondary) transition-colors duration-200"
                          role="menuitem"
                          aria-label="{{ 'accessibility.share_via_email' | t }}">
                          <i class="ph ph-envelope text-lg"></i>
                          <span>Email</span>
                        </a>
                        <button
                          type="button"
                          class="flex items-center gap-3 py-2 px-3 text-sm text-(--color-text) hover:bg-(--color-background-secondary) transition-colors duration-200 w-full text-left"
                          data-copy-link="{{ share_url }}"
                          role="menuitem"
                          aria-label="{{ 'accessibility.copy_link' | t }}">
                          <i class="ph ph-link text-lg"></i>
                          <span data-copy-text>{{ 'accessibility.copy_link' | t }}</span>
                        </button>
                      </div>
                    </div>
                  </template>
                {%- endif -%}
              </div>

          {%- endcase -%}
        {%- endfor -%}
      </div>
    </div>
  </div>

  {% if section.settings.show_sticky_bar %}
    {% render 'sticky-product-bar'
      , product: product
      , current_variant: current_variant %}
  {% endif %}
</div>

<script>
  (function() {
  const section = document.querySelector('[data-product-section]');
  if (!section) return;

  // Variant handling (with inventory data for dynamic updates)
  const variants = [
    {%- for variant in product.variants -%}
      {
        "id": {{ variant.id | json }},
        "title": {{ variant.title | json }},
        "options": {{ variant.options | json }},
        "price": {{ variant.price }},
        "compare_at_price": {{ variant.compare_at_price | json }},
        "available": {{ variant.available | json }},
        "featured_media": {{ variant.featured_media | json }},
        "featured_image": {{ variant.featured_image | json }},
        "inventory_management": {{ variant.inventory_management | json }},
        "inventory_policy": {{ variant.inventory_policy | json }},
        "inventory_quantity": {{ variant.inventory_quantity | default: 0 }}
      }{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  ];
  const moneyFormat = {{ shop.money_format | json }};
  const variantPicker = section.querySelector('[data-variant-picker]');
  const hiddenSelect = section.querySelector('[data-variant-select]');
  const priceEl = section.querySelector('[data-product-price]');
  const compareEl = section.querySelector('[data-compare-price]');
  const addButton = section.querySelector('[data-add-to-cart]');
  const galleryImages = section.querySelectorAll('[data-gallery-image]');
  const thumbnails = section.querySelectorAll('[data-thumbnail]');
  const counterCurrent = section.querySelector('[data-counter-current]');

  function formatMoney(cents) {
    const amount = (cents / 100).toFixed(2);
    return moneyFormat.replace(/\{\{\s*amount\s*\}\}/, amount)
                      .replace(/\{\{\s*amount_no_decimals\s*\}\}/, Math.round(cents / 100))
                      .replace(/\{\{\s*amount_with_comma_separator\s*\}\}/, amount.replace('.', ','));
  }

  // Show media by index (used by both thumbnails and variant switching)
  function showImageByIndex(index) {
    galleryImages.forEach((media, i) => {
      const isActive = i === index;
      media.classList.toggle('is-active', isActive);

      // Pause/stop media when switching away
      if (!isActive) {
        // Pause native videos
        const video = media.querySelector('video');
        if (video) {
          video.pause();
        }

        // Remove external video iframes (they will reload when shown again)
        const iframe = media.querySelector('iframe');
        if (iframe && media.dataset.mediaType === 'external_video') {
          iframe.remove();
          const poster = media.querySelector('[data-video-poster]');
          if (poster) poster.classList.remove('is-hidden');
        }
      }

      {% if section.settings.video_autoplay %}
      // Autoplay video when switching to it
      if (isActive && media.dataset.mediaType === 'video') {
        const video = media.querySelector('video');
        const poster = media.querySelector('[data-video-poster]');
        if (video) {
          if (poster) poster.classList.add('is-hidden');
          video.play().catch(() => {
            if (poster) poster.classList.remove('is-hidden');
          });
        }
      }
      {% endif %}
    });
    thumbnails.forEach((thumb, i) => {
      thumb.classList.toggle('is-active', i === index);
    });
    if (counterCurrent) {
      counterCurrent.textContent = String(index + 1).padStart(2, '0');
    }
  }

  function updateVariant(variant) {
    if (!variant) return;

    // Update hidden select for form submission
    if (hiddenSelect) {
      hiddenSelect.value = variant.id;
    }

    // Update price
    if (priceEl) {
      priceEl.textContent = formatMoney(variant.price);
    }

    // Update compare price
    if (compareEl) {
      if (variant.compare_at_price && variant.compare_at_price > variant.price) {
        compareEl.textContent = formatMoney(variant.compare_at_price);
        compareEl.style.display = '';
      } else {
        compareEl.style.display = 'none';
      }
    }

    // Update sale badge
    const saleBadge = section.querySelector('[data-sale-badge]');
    if (saleBadge) {
      if (variant.compare_at_price && variant.compare_at_price > variant.price) {
        const savePercent = Math.round((variant.compare_at_price - variant.price) * 100 / variant.compare_at_price);
        const percentEl = saleBadge.querySelector('[data-sale-percent]');
        if (percentEl) percentEl.textContent = savePercent;
        saleBadge.classList.remove('hidden');
      } else {
        saleBadge.classList.add('hidden');
      }
    }

    // Update button state and availability-dependent elements
    if (addButton) {
      const dynamicCheckout = section.querySelector('.shopify-payment-button');
      const deliveryEstimator = section.querySelector('[data-delivery-estimator]');
      const pickupAvailability = section.querySelector('[data-pickup-availability]');
      if (variant.available) {
        addButton.disabled = false;
        addButton.querySelector('.product-add-btn-text').innerHTML = '<i class="ph ph-bag"></i><span>{{ 'products.product.add_to_cart' | t }}</span>';
        if (dynamicCheckout) dynamicCheckout.parentElement.style.display = '';
        if (deliveryEstimator) deliveryEstimator.style.display = '';
        if (pickupAvailability) pickupAvailability.style.display = '';
      } else {
        addButton.disabled = true;
        addButton.querySelector('.product-add-btn-text').innerHTML = '<span>{{ 'products.product.sold_out' | t }}</span>';
        if (dynamicCheckout) dynamicCheckout.parentElement.style.display = 'none';
        if (deliveryEstimator) deliveryEstimator.style.display = 'none';
        if (pickupAvailability) pickupAvailability.style.display = 'none';
      }
    }

    // Update URL
    const url = new URL(window.location);
    url.searchParams.set('variant', variant.id);
    window.history.replaceState({}, '', url);

    // Update image if variant has a featured image
    if (variant.featured_media && galleryImages.length > 0) {
      const variantMediaId = variant.featured_media.id;
      // Find the gallery media with matching media ID
      const matchingMedia = Array.from(galleryImages).find(media =>
        parseInt(media.dataset.mediaId) === variantMediaId
      );
      if (matchingMedia) {
        const index = parseInt(matchingMedia.dataset.galleryImage);
        showImageByIndex(index);
      }
    } else if (variant.featured_image && galleryImages.length > 0) {
      // Fallback to featured_image for backwards compatibility
      const variantImageId = variant.featured_image.id;
      const matchingMedia = Array.from(galleryImages).find(media =>
        parseInt(media.dataset.mediaId) === variantImageId
      );
      if (matchingMedia) {
        const index = parseInt(matchingMedia.dataset.galleryImage);
        showImageByIndex(index);
      }
    }

    // Update inventory countdown
    updateInventoryCountdown(variant);

    // Dispatch event for other components (e.g., sticky bar)
    document.dispatchEvent(new CustomEvent('variant:change', {
      detail: { variant: variant }
    }));
  }

  function updateInventoryCountdown(variant) {
    const wrapper = section.querySelector('[data-inventory-wrapper]');
    if (!wrapper) return;

    const threshold = parseInt(wrapper.dataset.threshold) || 10;
    const showExact = wrapper.dataset.showExact === 'true';
    const style = wrapper.dataset.style || 'bar';
    const showIcon = wrapper.dataset.showIcon === 'true';
    const strings = JSON.parse(wrapper.dataset.strings || '{}');

    // Check if variant has trackable inventory
    const isTracked = variant.inventory_management === 'shopify' && variant.inventory_policy === 'deny';
    const quantity = variant.inventory_quantity || 0;
    const canShow = isTracked && quantity > 0 && quantity <= threshold;

    // Show/hide wrapper
    wrapper.classList.toggle('hidden', !canShow);

    if (!canShow) return;

    // Calculate urgency
    let urgency = 'low';
    if (quantity <= 3) urgency = 'critical';
    else if (quantity <= 5) urgency = 'high';

    // Generate HTML based on style
    let html = '';

    if (style === 'minimal') {
      const icon = showIcon ? '<i class="ph ph-warning-circle text-lg leading-none" aria-hidden="true"></i>' : '';
      const text = showExact
        ? strings.only_x_left.replace('[COUNT]', quantity)
        : strings.low_stock;
      html = `
        <div class="inventory-countdown inventory-countdown--minimal flex items-center gap-2 text-sm font-medium text-(--color-sale)" data-inventory-countdown>
          ${icon}
          <span>${text}</span>
        </div>
      `;
    } else if (style === 'badge') {
      const iconClass = urgency === 'critical' ? 'ph-fire-fill' : 'ph-fire';
      const icon = showIcon ? `<i class="ph ${iconClass} text-lg leading-none" aria-hidden="true"></i>` : '';
      let text = strings.low_stock;
      if (showExact) {
        text = strings.only_x_left.replace('[COUNT]', quantity);
      } else if (urgency === 'critical') {
        text = strings.almost_gone;
      } else if (urgency === 'high') {
        text = strings.selling_fast;
      }
      const bgClass = urgency === 'critical' ? 'bg-red-100 text-red-700' :
                      urgency === 'high' ? 'bg-orange-100 text-orange-700' : 'bg-yellow-100 text-yellow-700';
      html = `
        <div class="inventory-countdown inventory-countdown--badge inline-flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-full ${bgClass}" data-inventory-countdown>
          ${icon}
          <span>${text}</span>
        </div>
      `;
    } else if (style === 'bar') {
      const fillPercent = Math.round((quantity / threshold) * 100);
      const icon = showIcon ? '<i class="ph ph-package text-lg leading-none" aria-hidden="true"></i>' : '';
      const barColor = urgency === 'critical' ? 'bg-red-500' :
                       urgency === 'high' ? 'bg-orange-500' : 'bg-yellow-500';
      let urgencyText = strings.low_stock_warning;
      if (urgency === 'critical') urgencyText = strings.hurry_almost_gone;
      else if (urgency === 'high') urgencyText = strings.order_soon;

      html = `
        <div class="inventory-countdown inventory-countdown--bar" data-inventory-countdown>
          <div class="flex items-center justify-between mb-2">
            <span class="inline-flex items-center gap-1.5 text-sm font-medium text-(--color-text-secondary)">
              ${icon}
              ${strings.stock_level}
            </span>
            ${showExact ? `<span class="text-sm font-semibold text-(--color-sale)">${quantity} ${strings.remaining}</span>` : ''}
          </div>
          <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
            <div
              class="h-full rounded-full transition-all duration-500 ${barColor}"
              style="width: ${fillPercent}%"
              role="progressbar"
              aria-valuenow="${quantity}"
              aria-valuemin="0"
              aria-valuemax="${threshold}"
            ></div>
          </div>
          ${!showExact ? `<p class="mt-2 text-sm text-(--color-sale)">${urgencyText}</p>` : ''}
        </div>
      `;
    }

    wrapper.innerHTML = html;
  }

  function getSelectedOptions() {
    const options = [];
    if (!variantPicker) return options;

    // Get from radio buttons (button/swatch pickers)
    const radioInputs = variantPicker.querySelectorAll('input[type="radio"]:checked');
    radioInputs.forEach(input => {
      const position = parseInt(input.dataset.optionPosition);
      if (position) {
        options[position - 1] = input.value;
      }
    });

    // Get from select dropdowns
    const selects = variantPicker.querySelectorAll('.variant-picker__select');
    selects.forEach(select => {
      const position = parseInt(select.dataset.optionPosition);
      if (position) {
        options[position - 1] = select.value;
      }
    });

    return options;
  }

  function findVariantFromOptions(options) {
    return variants.find(variant => {
      return variant.options.every((opt, index) => opt === options[index]);
    });
  }

  function updateSelectedLabels() {
    if (!variantPicker) return;
    const selectedLabels = variantPicker.querySelectorAll('[data-option-selected]');
    selectedLabels.forEach(label => {
      const optionIndex = parseInt(label.dataset.optionSelected);
      const options = getSelectedOptions();
      if (options[optionIndex]) {
        label.textContent = options[optionIndex];
      }
    });
  }

  function updateDropdownSwatches() {
    if (!variantPicker) return;
    const dropdownSwatches = variantPicker.querySelectorAll('[data-dropdown-swatch]');
    dropdownSwatches.forEach(swatchWrapper => {
      const optionIndex = parseInt(swatchWrapper.dataset.dropdownSwatch);
      const select = variantPicker.querySelector(`.variant-picker__select[data-option-position="${optionIndex + 1}"]`);
      if (!select) return;

      const selectedOption = select.options[select.selectedIndex];
      const swatch = swatchWrapper.querySelector('.swatch');
      if (!swatch) return;

      const swatchColor = selectedOption.dataset.swatchColor;
      const swatchImage = selectedOption.dataset.swatchImage;

      if (swatchImage) {
        swatch.style.setProperty('--swatch-bg', `url(${swatchImage})`);
        swatch.classList.remove('swatch--unavailable');
      } else if (swatchColor) {
        swatch.style.setProperty('--swatch-bg', swatchColor);
        swatch.classList.remove('swatch--unavailable');
      } else {
        swatch.style.removeProperty('--swatch-bg');
        swatch.classList.add('swatch--unavailable');
      }
    });
  }

  function handleOptionChange() {
    const options = getSelectedOptions();
    const variant = findVariantFromOptions(options);
    updateVariant(variant);
    updateSelectedLabels();
    updateDropdownSwatches();
  }

  if (variantPicker) {
    // Listen for radio button changes (button/swatch pickers)
    variantPicker.addEventListener('change', (e) => {
      if (e.target.matches('input[type="radio"]') || e.target.matches('.variant-picker__select')) {
        handleOptionChange();
      }
    });
  }

  // Fallback: Listen for changes on hidden select (if no variant picker)
  if (hiddenSelect && !variantPicker) {
    hiddenSelect.addEventListener('change', function() {
      const variant = variants.find(v => v.id === parseInt(this.value));
      updateVariant(variant);
    });
  }

  // Quantity buttons with animation
  const quantityWrapper = section.querySelector('[data-quantity-wrapper]');
  const quantityInput = section.querySelector('[data-quantity-input]');
  const minusBtn = section.querySelector('[data-quantity-minus]');
  const plusBtn = section.querySelector('[data-quantity-plus]');

  function animateQuantityChange() {
    if (quantityWrapper) {
      quantityWrapper.classList.remove('is-changing');
      // Trigger reflow
      void quantityWrapper.offsetWidth;
      quantityWrapper.classList.add('is-changing');
    }
  }

  if (minusBtn && plusBtn && quantityInput) {
    minusBtn.addEventListener('click', () => {
      const val = parseInt(quantityInput.value) || 1;
      if (val > 1) {
        quantityInput.value = val - 1;
        animateQuantityChange();
      }
    });

    plusBtn.addEventListener('click', () => {
      const val = parseInt(quantityInput.value) || 1;
      quantityInput.value = val + 1;
      animateQuantityChange();
    });

    // Also animate on direct input change
    quantityInput.addEventListener('change', animateQuantityChange);
  }

  // Image gallery - uses showImageByIndex defined above
  let currentImageIndex = 0;

  function showImage(index) {
    showImageByIndex(index);
    currentImageIndex = index;
  }

  thumbnails.forEach((thumb, index) => {
    thumb.addEventListener('click', () => showImage(index));
  });

  // Video poster click - play video
  section.querySelectorAll('[data-video-poster]').forEach(poster => {
    poster.addEventListener('click', () => {
      const mediaWrapper = poster.closest('[data-gallery-image]');
      if (!mediaWrapper) return;

      const mediaType = mediaWrapper.dataset.mediaType;

      if (mediaType === 'video') {
        // Native video - just play it
        const video = mediaWrapper.querySelector('video');
        if (video) {
          poster.classList.add('is-hidden');
          video.play();
        }
      } else if (mediaType === 'external_video') {
        // External video - load iframe from template
        const template = mediaWrapper.querySelector('[data-external-video-template]');
        if (template) {
          const wrapper = poster.closest('.product-media-wrapper');
          poster.classList.add('is-hidden');
          wrapper.insertAdjacentHTML('beforeend', template.innerHTML);
        }
      }
    });
  });

  // Video autoplay when visible (IntersectionObserver)
  {% if section.settings.video_autoplay %}
  const videoAutoplayObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const video = entry.target.querySelector('video');
      const poster = entry.target.querySelector('[data-video-poster]');
      if (!video) return;

      if (entry.isIntersecting && entry.target.classList.contains('is-active')) {
        // Video is visible and active - autoplay
        if (poster) poster.classList.add('is-hidden');
        video.play().catch(() => {
          // Autoplay failed (browser policy), show poster
          if (poster) poster.classList.remove('is-hidden');
        });
      } else {
        // Video is not visible or not active - pause
        video.pause();
      }
    });
  }, { threshold: 0.5 });

  // Observe all video media items
  section.querySelectorAll('[data-gallery-image][data-media-type="video"]').forEach(media => {
    videoAutoplayObserver.observe(media);
  });
  {% endif %}

  // 3D Model controls
  section.querySelectorAll('[data-model-reset]').forEach(btn => {
    btn.addEventListener('click', () => {
      const modelViewer = btn.closest('.product-media-wrapper')?.querySelector('model-viewer');
      if (modelViewer) {
        modelViewer.cameraOrbit = modelViewer.getAttribute('camera-orbit') || 'auto auto auto';
        modelViewer.fieldOfView = 'auto';
      }
    });
  });

  section.querySelectorAll('[data-model-ar]').forEach(btn => {
    btn.addEventListener('click', () => {
      const modelViewer = btn.closest('.product-media-wrapper')?.querySelector('model-viewer');
      if (modelViewer && modelViewer.canActivateAR) {
        modelViewer.activateAR();
      }
    });
  });

  // Share button functionality (portal approach for z-index)
  const shareWrapper = section.querySelector('[data-share-wrapper]');
  const shareTemplate = section.querySelector('[data-share-popup-template]');
  if (shareWrapper && shareTemplate) {
    const shareTrigger = shareWrapper.querySelector('[data-share-trigger]');
    let sharePopup = null;
    let isOpen = false;

    // Create popup from template and append to body
    function createPopup() {
      if (sharePopup) return;
      const content = shareTemplate.content.cloneNode(true);
      sharePopup = content.querySelector('[data-share-popup]');
      document.body.appendChild(sharePopup);

      // Copy link functionality
      const copyLinkBtn = sharePopup.querySelector('[data-copy-link]');
      const copyText = sharePopup.querySelector('[data-copy-text]');
      if (copyLinkBtn) {
        const originalText = copyText?.textContent;
        copyLinkBtn.addEventListener('click', async () => {
          const url = copyLinkBtn.dataset.copyLink;
          try {
            await navigator.clipboard.writeText(url);
            if (copyText) {
              copyText.textContent = {{ 'accessibility.link_copied' | t | json }};
              setTimeout(() => {
                copyText.textContent = originalText;
              }, 2000);
            }
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        });
      }
    }

    function positionPopup() {
      if (!sharePopup) return;
      const rect = shareTrigger.getBoundingClientRect();
      const popupWidth = 200;
      let left = rect.right - popupWidth;
      // Keep popup in viewport
      if (left < 10) left = 10;
      if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - popupWidth - 10;
      }
      sharePopup.style.top = `${rect.bottom + 8}px`;
      sharePopup.style.left = `${left}px`;
    }

    function openPopup() {
      createPopup();
      positionPopup();
      isOpen = true;
      sharePopup.classList.remove('opacity-0', 'invisible', 'translate-y-2');
      sharePopup.classList.add('opacity-100', 'visible', 'translate-y-0');
      shareTrigger.setAttribute('aria-expanded', 'true');
    }

    function closePopup() {
      if (!sharePopup) return;
      isOpen = false;
      sharePopup.classList.add('opacity-0', 'invisible', 'translate-y-2');
      sharePopup.classList.remove('opacity-100', 'visible', 'translate-y-0');
      shareTrigger.setAttribute('aria-expanded', 'false');
    }

    // Try native share API first (mobile/modern browsers)
    shareTrigger.addEventListener('click', async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: shareTrigger.dataset.shareTitle || document.title,
            url: shareTrigger.dataset.shareUrl || window.location.href
          });
          return;
        } catch (err) {
          // User cancelled or error - fall back to popup
          if (err.name === 'AbortError') return;
        }
      }
      // Fallback to popup
      if (isOpen) {
        closePopup();
      } else {
        openPopup();
      }
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
      if (isOpen && !shareWrapper.contains(e.target) && sharePopup && !sharePopup.contains(e.target)) {
        closePopup();
      }
    });

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (isOpen && e.key === 'Escape') {
        closePopup();
        shareTrigger.focus();
      }
    });

    // Reposition on scroll/resize
    window.addEventListener('scroll', () => { if (isOpen) positionPopup(); }, { passive: true });
    window.addEventListener('resize', () => { if (isOpen) positionPopup(); }, { passive: true });
  }

  // Initialize lightbox for product gallery
  {% if section.settings.enable_lightbox %}
  function setupLightbox() {
    if (!window.pieces || !window.pieces.lightbox) return false;

    const gallery = section.querySelector('[data-product-gallery]');
    if (!gallery) return false;

    window.pieces.lightbox.init(gallery);

    // Bind zoom button clicks
    section.querySelectorAll('[data-zoom-btn]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const index = parseInt(btn.dataset.zoomBtn, 10);
        window.pieces.lightbox.open(index);
      });
    });

    return true;
  }

  if (!setupLightbox()) {
    // Wait for pieces to be ready using requestAnimationFrame instead of setTimeout
    function waitForLightbox() {
      if (setupLightbox()) return;
      requestAnimationFrame(waitForLightbox);
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForLightbox);
    } else {
      requestAnimationFrame(waitForLightbox);
    }
  }
  {% endif %}

  // Product animation (consolidated into same IIFE)
  function initProductAnimation() {
    if (section.dataset.animInitialized) return;

    // If animations disabled, skip
    if (typeof window.shouldAnimate === 'function' && !window.shouldAnimate()) {
      section.dataset.animInitialized = 'true';
      return;
    }

    // Check for GSAP
    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    if (!gsap) {
      requestAnimationFrame(initProductAnimation);
      return;
    }

    section.dataset.animInitialized = 'true';

    const galleryMain = section.querySelector('[data-gallery-main]');
    const titleLines = section.querySelectorAll('.product-title-line > span');
    const thumbnails = section.querySelector('[data-thumbnails]');
    const counter = section.querySelector('[data-image-counter]');

    // Set initial animation states
    if (galleryMain) {
      gsap.set(galleryMain, { clipPath: 'inset(0 100% 0 0)' });
    }
    if (titleLines.length) {
      gsap.set(titleLines, { yPercent: 100 });
    }
    if (thumbnails) {
      gsap.set(thumbnails, { opacity: 0 });
    }
    if (counter) {
      gsap.set(counter, { opacity: 0 });
    }

    const tl = gsap.timeline({
      onComplete: () => {
        // Clear inline clip-path so CSS takes over cleanly
        if (galleryMain) {
          gsap.set(galleryMain, { clearProps: 'clipPath' });
        }
        section.classList.add('is-ready');
      }
    });

    // Image reveal and title reveal together - both start at 0
    if (galleryMain) {
      tl.to(galleryMain, {
        clipPath: 'inset(0 0% 0 0)',
        duration: 1.2,
        ease: 'power3.out'
      }, 0);
    }

    // Title reveal - starts at same time as image
    if (titleLines.length) {
      tl.to(titleLines, {
        yPercent: 0,
        duration: 1.2,
        ease: 'power4.out',
        stagger: 0.1
      }, 0);
    }

    // Thumbnails and counter - appear after main animations
    if (thumbnails) {
      tl.to(thumbnails, {
        opacity: 1,
        duration: 0.6,
        ease: 'power3.out'
      }, 0.8);
    }

    if (counter) {
      tl.to(counter, {
        opacity: 1,
        duration: 0.6,
        ease: 'power3.out'
      }, 0.8);
    }

    // Description shuffle animation
    const descShuffle = section.querySelector('[data-shuffle-text]');
    if (descShuffle) {
      const originalText = descShuffle.dataset.originalText || descShuffle.textContent.trim();
      // Use only similar-width characters to prevent layout shift during shuffle
      const chars = 'ABCDEFGHJKLMNPRSTUVWXYZ';

      // Lock dimensions to prevent layout shift during shuffle
      const rect = descShuffle.getBoundingClientRect();
      descShuffle.style.width = rect.width + 'px';
      descShuffle.style.height = rect.height + 'px';
      descShuffle.style.overflow = 'hidden';

      // Set initial state
      gsap.set(descShuffle, { opacity: 0 });

      // Fade in first
      tl.to(descShuffle, {
        opacity: 1,
        duration: 0.4,
        ease: 'power2.out'
      }, 0.6);

      // Shuffle animation - characters reveal left to right with scrambling
      const shuffleObj = { progress: 0 };
      tl.to(shuffleObj, {
        progress: 1,
        duration: 1.8,
        ease: 'none',
        onUpdate: () => {
          const progress = shuffleObj.progress;
          const revealedCount = Math.floor(progress * originalText.length);

          descShuffle.textContent = originalText.split('').map((char, i) => {
            if (i < revealedCount) {
              return char;
            } else if (char === ' ') {
              return ' ';
            } else {
              return chars[Math.floor(Math.random() * chars.length)];
            }
          }).join('');
        },
        onComplete: () => {
          descShuffle.textContent = originalText;
          // Remove dimension locks after animation
          descShuffle.style.width = '';
          descShuffle.style.height = '';
          descShuffle.style.overflow = '';
        }
      }, 0.6);
    }
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProductAnimation);
  } else {
    initProductAnimation();
  }

  // Reinitialize after Swup (use helper to prevent duplicate listeners)
  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('product-animation', () => {
      requestAnimationFrame(initProductAnimation);
    });
  }

  // Buy button hover effect (consolidated)
  function setupBuyButton() {
    const buyButtonWrapper = document.querySelector('shopify-buy-it-now-button');
    if (!buyButtonWrapper) {
      requestAnimationFrame(setupBuyButton);
      return;
    }

    const button = buyButtonWrapper.querySelector('button');
    if (!button) {
      requestAnimationFrame(setupBuyButton);
      return;
    }

    // Check if already set up
    if (button.dataset.piecesHover) return;
    button.dataset.piecesHover = 'true';

    // Create the fill overlay element
    const fillOverlay = document.createElement('span');
    fillOverlay.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--color-primary);
      transform: scaleX(0);
      transform-origin: right;
      transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 0;
      pointer-events: none;
    `;

    // Wrap button text in a span for z-index control
    const buttonText = button.textContent;
    button.textContent = '';

    const textSpan = document.createElement('span');
    textSpan.textContent = buttonText;
    textSpan.style.cssText = `
      position: relative;
      z-index: 1;
      transition: color 0.4s ease;
    `;

    button.appendChild(fillOverlay);
    button.appendChild(textSpan);

    // Add hover listeners
    button.addEventListener('mouseenter', () => {
      fillOverlay.style.transformOrigin = 'left';
      fillOverlay.style.transform = 'scaleX(1)';
      textSpan.style.color = 'var(--color-primary-contrast)';
    });

    button.addEventListener('mouseleave', () => {
      fillOverlay.style.transformOrigin = 'right';
      fillOverlay.style.transform = 'scaleX(0)';
      textSpan.style.color = '';
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupBuyButton);
  } else {
    setupBuyButton();
  }

  // Watch for dynamic insertion of the button
  const observer = new MutationObserver(() => {
    const buyButtonWrapper = document.querySelector('shopify-buy-it-now-button');
    if (buyButtonWrapper && buyButtonWrapper.querySelector('button')) {
      setupBuyButton();
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });

  // Reinitialize after Swup page transitions
  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('product-buy-button', () => {
      requestAnimationFrame(setupBuyButton);
    });
  }

  // AJAX Add to Cart (consolidated)
  function initAddToCart() {

    const form = section.querySelector('form[action*="/cart/add"]');
    if (!form) return;
    if (form.dataset.ajaxInitialized) return;

    form.dataset.ajaxInitialized = 'true';

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const addButton = form.querySelector('[data-add-to-cart]');
      const originalText = addButton.innerHTML;

      // Loading state
      addButton.disabled = true;
      addButton.innerHTML = '<span class="product-add-btn-text"><i class="ph ph-spinner animate-spin"></i><span>{{ 'cart.adding' | t }}</span></span>';

      try {
        const formData = new FormData(form);
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('Failed to add to cart');
        }

        const item = await response.json();

        // Get updated cart for count
        const cartResponse = await fetch('/cart.js');
        const cart = await cartResponse.json();

        // Update cart count in header
        document.querySelectorAll('[data-cart-count]').forEach(el => {
          el.textContent = cart.item_count;
          el.classList.toggle('hidden', cart.item_count === 0);
        });

        // Dispatch cart updated event for reactive components (e.g., free shipping bar)
        document.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart } }));

        // Get product info for notification
        const productInfo = {
          title: item.product_title,
          variant_title: item.variant_title !== 'Default Title' ? item.variant_title : null,
          image: item.image ? item.image.replace(/(\.[^.]+)$/, '_200x$1') : null
        };

        // Trigger appropriate cart behavior based on theme settings
        const cartType = window.themeSettings?.cartType || 'drawer';

        if (cartType === 'drawer') {
          // Refresh cart drawer content then open it
          if (window.refreshCartDrawer) {
            await window.refreshCartDrawer();
          }
          document.dispatchEvent(new CustomEvent('cart:open', { detail: { skipFetch: true } }));
        } else if (cartType === 'notification') {
          // Show notification
          document.dispatchEvent(new CustomEvent('cart:notification', {
            detail: {
              product: productInfo,
              cart: cart
            }
          }));
        } else {
          // cartType === 'page' - redirect to cart
          window.location.href = window.routes?.cartUrl || '/cart';
          return;
        }

        // Success state
        addButton.innerHTML = '<span class="product-add-btn-text"><i class="ph ph-check"></i><span>{{ 'cart.added' | t }}</span></span>';

        setTimeout(() => {
          addButton.innerHTML = originalText;
          addButton.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('Add to cart error:', error);

        // Error state
        addButton.innerHTML = '<span class="product-add-btn-text"><i class="ph ph-x"></i><span>{{ 'cart.error' | t }}</span></span>';

        setTimeout(() => {
          addButton.innerHTML = originalText;
          addButton.disabled = false;
        }, 2000);
      }
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAddToCart);
  } else {
    initAddToCart();
  }

  // Reinitialize after Swup
  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('product-add-to-cart', () => {
      requestAnimationFrame(initAddToCart);
    });
  }
})();
</script>

<script>
  /**
   * Complementary Products - Vanilla JS with JSON API
   */
  (function() {
  const block = document.querySelector('[data-complementary-block]');
  if (!block) return;

  const i18n = {
    addAll: {{ 'products.complementary.add_all' | t | json }},
    adding: {{ 'products.complementary.adding' | t | json }},
    added: {{ 'products.complementary.added' | t | json }},
    error: {{ 'products.complementary.error' | t | json }}
  };

  const productId = block.dataset.productId;
  const limit = block.dataset.limit || 4;
  const showAddAll = block.dataset.showAddAll === 'true';
  const loading = block.querySelector('[data-complementary-loading]');
  const list = block.querySelector('[data-complementary-list]');
  const addAllBtn = block.querySelector('[data-complementary-add-all]');

  // Helpers
  function resizeImage(url, size) {
    if (!url) return '';
    return url.replace(/(\.[^.]+)$/, `_${size}$1`);
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function formatMoney(cents) {
    const amount = (cents / 100).toFixed(2);
    const currency = window.Shopify?.currency?.active || 'USD';
    try {
      return new Intl.NumberFormat(document.documentElement.lang || 'en', {
        style: 'currency',
        currency
      }).format(amount);
    } catch {
      return `$${amount}`;
    }
  }

  async function addAllToCart() {
    const items = Array.from(block.querySelectorAll('[data-quick-add]')).map(btn => ({
      id: btn.dataset.quickAdd,
      quantity: 1
    }));

    if (items.length === 0) return;

    const textEl = addAllBtn.querySelector('[data-add-all-text]');
    const originalText = textEl?.textContent;
    addAllBtn.disabled = true;
    if (textEl) textEl.textContent = i18n.adding;

    try {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      });

      if (!response.ok) throw new Error('Failed to add to cart');

      const cartResponse = await fetch('/cart.js');
      const cart = await cartResponse.json();
      document.querySelectorAll('[data-cart-count]').forEach(el => {
        el.textContent = cart.item_count;
        el.classList.toggle('hidden', cart.item_count === 0);
      });

      // Dispatch cart updated event for reactive components (e.g., free shipping bar)
      document.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart } }));

      const cartType = window.themeSettings?.cartType || 'drawer';
      if (cartType === 'drawer') {
        if (window.refreshCartDrawer) await window.refreshCartDrawer();
        document.dispatchEvent(new CustomEvent('cart:open', { detail: { skipFetch: true } }));
      }

      if (textEl) textEl.textContent = i18n.added;
      setTimeout(() => {
        if (textEl) textEl.textContent = originalText;
        addAllBtn.disabled = false;
      }, 2000);
    } catch (error) {
      console.error('Add all to cart error:', error);
      if (textEl) textEl.textContent = i18n.error;
      setTimeout(() => {
        if (textEl) textEl.textContent = originalText;
        addAllBtn.disabled = false;
      }, 2000);
    }
  }

  // Fetch and render products
  async function loadComplementaryProducts() {
    try {
      const url = `/recommendations/products.json?product_id=${productId}&limit=${limit}&intent=complementary`;
      const response = await fetch(url);
      const data = await response.json();

      if (!data.products || data.products.length === 0) {
        block.remove();
        return;
      }

      let allSingleVariant = true;

      data.products.forEach(product => {
        const href = product.url;
        const imgSrc = product.featured_image ? resizeImage(product.featured_image, '100x100') : '';
        const price = formatMoney(product.price);
        const comparePrice = product.compare_at_price > product.price ? formatMoney(product.compare_at_price) : null;
        const hasSingleVariant = product.variants.length === 1;
        const isAvailable = product.available;
        const variantId = product.variants[0]?.id;

        if (!hasSingleVariant || !isAvailable) allSingleVariant = false;

        const item = document.createElement('div');
        item.className = 'flex items-center gap-3 p-2 border border-primary/10 hover:border-primary/30 transition-colors';
        item.style.borderRadius = 'var(--card-radius)';
        if (variantId) item.dataset.variantId = variantId;

        let actionHtml = '';
        if (isAvailable && hasSingleVariant && variantId) {
          actionHtml = `<button type="button" class="shrink-0 w-8 h-8 inline-flex items-center justify-center bg-transparent border border-primary/20 rounded-full text-primary hover:bg-primary hover:text-background hover:border-primary transition-all" data-quick-add="${variantId}" aria-label="{{ 'products.product.add_to_cart' | t }}"><span data-add-text class="flex items-center justify-center"><i class="ph ph-plus text-sm"></i></span><span data-adding-text class="hidden flex items-center justify-center"><i class="ph ph-spinner text-sm animate-spin"></i></span><span data-added-text class="hidden flex items-center justify-center"><i class="ph ph-check text-sm"></i></span></button>`;
        } else if (isAvailable) {
          actionHtml = `<a href="${href}" class="shrink-0 w-8 h-8 inline-flex items-center justify-center bg-transparent border border-primary/20 rounded-full text-primary hover:bg-primary hover:text-background hover:border-primary transition-all" aria-label="{{ 'products.product.select_options' | t }}"><i class="ph ph-eye text-sm"></i></a>`;
        }

        item.innerHTML = `
          <a href="${href}" class="shrink-0 w-12 h-12 overflow-hidden bg-secondary/5" style="border-radius: var(--card-radius)">
            ${imgSrc ? `<img src="${imgSrc}" alt="${escapeHtml(product.title)}" loading="lazy" decoding="async" width="100" height="100" class="w-full h-full object-cover">` : ''}
          </a>
          <div class="flex-1 min-w-0">
            <a href="${href}" class="text-[0.8125rem] font-medium text-primary truncate block no-underline">${escapeHtml(product.title)}</a>
            <div class="text-xs text-secondary mt-0.5">
              ${comparePrice ? `<span class="line-through opacity-60 mr-1">${comparePrice}</span>` : ''}${price}
            </div>
          </div>
          ${actionHtml}
        `;

        list.appendChild(item);
      });

      // Hide loading, show list
      if (loading) loading.style.display = 'none';
      list.style.display = '';

      // Trigger tween animations for the newly visible list
      requestAnimationFrame(() => {
        if (window.pieces?.tween) {
          window.pieces.tween.reinit();
        }
      });

      // Show "Add all" button if applicable
      if (showAddAll && allSingleVariant && addAllBtn) {
        addAllBtn.classList.remove('hidden');
        addAllBtn.addEventListener('click', addAllToCart);
      }
    } catch (error) {
      console.error('[ComplementaryProducts] Error:', error);
      block.remove();
    }
  }

  // Show block with skeleton loaders immediately
  block.style.display = '';

  // Trigger tween animations after browser paint
  requestAnimationFrame(() => {
    if (window.pieces?.tween) {
      window.pieces.tween.reinit();
    }
  });

  // Load products
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadComplementaryProducts);
  } else {
    loadComplementaryProducts();
  }
  })();
</script>

{%- comment -%} Track Recently Viewed Product {%- endcomment -%}
<script>
  (function() {
  const STORAGE_KEY = 'pieces_recently_viewed';
  const MAX_PRODUCTS = 12;

  const productData = {
    id: '{{ product.id }}',
    handle: '{{ product.handle }}',
    title: {{ product.title | json }},
    url: '{{ product.url }}',
    image: '{{ product.featured_image | image_url: width: 800 }}',
    price: {{ product.price }},
    compareAtPrice: {{ product.compare_at_price | default: 0 }},
    vendor: {{ product.vendor | json }},
    available: {{ product.available }}
  };

  function addProduct() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      let products = stored ? JSON.parse(stored) : [];

      // Remove if already exists
      products = products.filter(p => p.id !== productData.id);

      // Add to beginning
      products.unshift({
        ...productData,
        addedAt: Date.now()
      });

      // Limit to max products
      products = products.slice(0, MAX_PRODUCTS);

      localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
    } catch {
      // localStorage might be unavailable
    }
  }

  // Track immediately - no delay needed, localStorage is synchronous
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addProduct);
  } else {
    addProduct();
  }
  })();
</script>

{% schema %}
{
  "name": "t:sections.product.name",
  "tag": "section",
  "class": "product-section no-header-offset",
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": true,
      "label": "t:shared.settings.full_width.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "image_fit",
      "label": "t:shared.settings.image_fit.label",
      "default": "cover",
      "options": [
        {
          "value": "cover",
          "label": "t:shared.options.cover"
        },
        {
          "value": "contain",
          "label": "t:shared.options.contain"
        },
        {
          "value": "square",
          "label": "t:shared.options.square"
        },
        {
          "value": "portrait",
          "label": "t:sections.product.settings.image_fit.options__3.label"
        },
        {
          "value": "landscape",
          "label": "t:sections.product.settings.image_fit.options__4.label"
        }
      ]
    },
    {
      "type": "select",
      "id": "thumbnail_position",
      "label": "t:sections.product.settings.thumbnail_position.label",
      "default": "right",
      "options": [
        {
          "value": "left",
          "label": "t:shared.options.left"
        },
        {
          "value": "right",
          "label": "t:shared.options.right"
        },
        {
          "value": "bottom",
          "label": "t:shared.options.bottom"
        }
      ]
    },
    {
      "type": "checkbox",
      "id": "enable_lightbox",
      "label": "t:sections.product.settings.enable_lightbox.label",
      "default": true,
      "info": "t:sections.product.settings.enable_lightbox.info"
    },
    {
      "type": "header",
      "content": "t:shared.headers.video"
    },
    {
      "type": "checkbox",
      "id": "video_loop",
      "label": "t:sections.product.settings.video_loop.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "video_autoplay",
      "label": "t:sections.product.settings.video_autoplay.label",
      "default": false,
      "info": "t:sections.product.settings.video_autoplay.info"
    },
    {
      "type": "header",
      "content": "t:sections.product.settings.header__sticky_add_to_cart.content"
    },
    {
      "type": "checkbox",
      "id": "show_sticky_bar",
      "default": true,
      "label": "t:sections.product.settings.show_sticky_bar.label",
      "info": "t:sections.product.settings.show_sticky_bar.info"
    }
  ],
  "blocks": [
    {
      "type": "breadcrumbs",
      "name": "t:sections.product.blocks.breadcrumbs.name",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "separator",
          "label": "t:sections.product.blocks.breadcrumbs.settings.separator.label",
          "default": "/"
        },
        {
          "type": "checkbox",
          "id": "show_home_icon",
          "label": "t:sections.product.blocks.breadcrumbs.settings.show_home_icon.label",
          "default": false,
          "info": "t:sections.product.blocks.breadcrumbs.settings.show_home_icon.info"
        }
      ]
    },
    {
      "type": "vendor",
      "name": "t:sections.product.blocks.vendor.name",
      "limit": 1
    },
    {
      "type": "title",
      "name": "t:sections.product.blocks.title.name",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "split_words",
          "label": "t:sections.product.blocks.title.settings.split_words.label",
          "default": true,
          "info": "t:sections.product.blocks.title.settings.split_words.info"
        }
      ]
    },
    {
      "type": "price",
      "name": "t:sections.product.blocks.price.name",
      "limit": 1
    },
    {
      "type": "inventory_countdown",
      "name": "t:sections.product.blocks.inventory_countdown.name",
      "limit": 1,
      "settings": [
        {
          "type": "range",
          "id": "threshold",
          "label": "t:sections.product.blocks.inventory_countdown.settings.threshold.label",
          "min": 3,
          "max": 20,
          "step": 1,
          "default": 10,
          "info": "t:sections.product.blocks.inventory_countdown.settings.threshold.info"
        },
        {
          "type": "select",
          "id": "style",
          "label": "t:shared.settings.style.label",
          "options": [
            {
              "value": "bar",
              "label": "t:shared.options.bar"
            },
            {
              "value": "minimal",
              "label": "t:shared.options.minimal"
            },
            {
              "value": "badge",
              "label": "t:sections.product.blocks.inventory_countdown.settings.style.options__2.label"
            }
          ],
          "default": "bar"
        },
        {
          "type": "checkbox",
          "id": "show_exact_count",
          "label": "t:sections.product.blocks.inventory_countdown.settings.show_exact_count.label",
          "default": true,
          "info": "t:sections.product.blocks.inventory_countdown.settings.show_exact_count.info"
        },
        {
          "type": "checkbox",
          "id": "show_icon",
          "label": "t:sections.product.blocks.inventory_countdown.settings.show_icon.label",
          "default": true
        }
      ]
    },
    {
      "type": "description",
      "name": "t:sections.product.blocks.description.name",
      "limit": 1,
      "settings": [
        {
          "type": "range",
          "id": "truncate_length",
          "label": "t:sections.product.blocks.description.settings.truncate_length.label",
          "min": 50,
          "max": 500,
          "step": 10,
          "default": 200
        },
        {
          "type": "checkbox",
          "id": "enable_shuffle",
          "label": "t:sections.product.blocks.description.settings.enable_shuffle.label",
          "default": false,
          "info": "t:shared.info.shuffles_description"
        }
      ]
    },
    {
      "type": "variant_picker",
      "name": "t:sections.product.blocks.variant_picker.name",
      "limit": 1,
      "settings": [
        {
          "type": "select",
          "id": "picker_type",
          "label": "t:sections.product.blocks.variant_picker.settings.picker_type.label",
          "options": [
            {
              "value": "dropdown",
              "label": "t:shared.options.dropdown"
            },
            {
              "value": "button",
              "label": "t:shared.options.button"
            }
          ],
          "default": "button"
        },
        {
          "type": "select",
          "id": "swatch_shape",
          "label": "t:shared.settings.swatch_shape.label",
          "info": "t:shared.info.only_color_image_swatches",
          "options": [
            {
              "value": "circle",
              "label": "t:shared.options.circle"
            },
            {
              "value": "square",
              "label": "t:shared.options.square"
            },
            {
              "value": "none",
              "label": "t:shared.options.none"
            }
          ],
          "default": "circle"
        }
      ]
    },
    {
      "type": "quantity_selector",
      "name": "t:sections.product.blocks.quantity_selector.name",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "t:shared.settings.label.label",
          "default": "t:sections.product.blocks.quantity_selector.settings.label.default"
        }
      ]
    },
    {
      "type": "buy_buttons",
      "name": "t:sections.product.blocks.buy_buttons.name",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "add_to_cart_text",
          "label": "t:sections.product.blocks.buy_buttons.settings.add_to_cart_text.label",
          "info": "t:shared.info.leave_blank_default"
        },
        {
          "type": "text",
          "id": "sold_out_text",
          "label": "t:sections.product.blocks.buy_buttons.settings.sold_out_text.label",
          "info": "t:shared.info.leave_blank_default"
        },
        {
          "type": "checkbox",
          "id": "show_dynamic_checkout",
          "label": "t:sections.product.blocks.buy_buttons.settings.show_dynamic_checkout.label",
          "info": "t:sections.product.blocks.buy_buttons.settings.show_dynamic_checkout.info",
          "default": true
        }
      ]
    },
    {
      "type": "pickup_availability",
      "name": "t:sections.product.blocks.pickup_availability.name",
      "limit": 1,
      "settings": []
    },
    {
      "type": "delivery_estimator",
      "name": "t:sections.product.blocks.delivery_estimator.name",
      "limit": 1,
      "settings": []
    },
    {
      "type": "social_proof",
      "name": "t:sections.product.blocks.social_proof.name",
      "limit": 1,
      "settings": []
    },
    {
      "type": "text",
      "name": "t:shared.blocks.text",
      "settings": [
        {
          "type": "richtext",
          "id": "text",
          "label": "t:shared.settings.text.label",
          "default": "t:sections.product.blocks.text.settings.text.default"
        }
      ]
    },
    {
      "type": "collapsible_tab",
      "name": "t:sections.product.blocks.collapsible_tab.name",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "t:shared.settings.heading.label",
          "default": "t:sections.product.blocks.collapsible_tab.settings.heading.default"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "t:shared.settings.content.label",
          "default": "t:sections.product.blocks.collapsible_tab.settings.content.default"
        }
      ]
    },
    {
      "type": "size_chart",
      "name": "t:sections.product.blocks.size_chart.name",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "link_text",
          "label": "t:shared.settings.link_text.label",
          "info": "t:shared.info.leave_blank_default"
        },
        {
          "type": "text",
          "id": "drawer_heading",
          "label": "t:sections.product.blocks.size_chart.settings.drawer_heading.label",
          "info": "t:shared.info.leave_blank_default"
        },
        {
          "type": "page",
          "id": "page",
          "label": "t:sections.product.blocks.size_chart.settings.page.label",
          "info": "t:sections.product.blocks.size_chart.settings.page.info"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "t:shared.settings.content.label",
          "info": "t:sections.product.blocks.size_chart.settings.content.info"
        },
        {
          "type": "checkbox",
          "id": "show_always",
          "label": "t:sections.product.blocks.size_chart.settings.show_always.label",
          "default": false,
          "info": "t:sections.product.blocks.size_chart.settings.show_always.info"
        }
      ]
    },
    {
      "type": "back_in_stock",
      "name": "t:sections.product.blocks.back_in_stock.name",
      "limit": 1,
      "settings": []
    },
    {
      "type": "complementary_products",
      "name": "t:sections.product.blocks.complementary_products.name",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "t:sections.product.blocks.complementary_products.settings.paragraph__description.content"
        },
        {
          "type": "text",
          "id": "title",
          "label": "t:shared.settings.title.label",
          "info": "t:sections.product.blocks.complementary_products.settings.title.info"
        },
        {
          "type": "range",
          "id": "products_to_show",
          "min": 1,
          "max": 4,
          "step": 1,
          "default": 2,
          "label": "t:shared.settings.products_to_show.label"
        },
        {
          "type": "checkbox",
          "id": "show_add_all",
          "label": "t:shared.settings.show_add_all.label",
          "default": true,
          "info": "t:shared.info.show_add_all"
        }
      ]
    },
    {
      "type": "wishlist_button",
      "name": "t:sections.product.blocks.wishlist_button.name",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "t:sections.product.blocks.wishlist_button.settings.paragraph__description.content"
        },
        {
          "type": "select",
          "id": "style",
          "label": "t:shared.settings.style.label",
          "default": "icon_text",
          "options": [
            {
              "value": "icon_only",
              "label": "t:shared.options.icon_only"
            },
            {
              "value": "icon_text",
              "label": "t:shared.options.icon_and_text"
            },
            {
              "value": "text_only",
              "label": "t:shared.options.text_only"
            }
          ]
        }
      ]
    },
    {
      "type": "compare_button",
      "name": "t:sections.product.blocks.compare_button.name",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "t:sections.product.blocks.compare_button.settings.paragraph__description.content"
        },
        {
          "type": "select",
          "id": "style",
          "label": "t:shared.settings.style.label",
          "default": "icon_text",
          "options": [
            {
              "value": "icon_only",
              "label": "t:shared.options.icon_only"
            },
            {
              "value": "icon_text",
              "label": "t:shared.options.icon_and_text"
            },
            {
              "value": "text_only",
              "label": "t:shared.options.text_only"
            }
          ]
        }
      ]
    },
    {
      "type": "wc_buttons",
      "name": "t:sections.product.blocks.wc_buttons.name",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "t:sections.product.blocks.wc_buttons.settings.paragraph__description.content"
        },
        {
          "type": "select",
          "id": "display_style",
          "label": "t:sections.product.blocks.wc_buttons.settings.display_style.label",
          "default": "icon_text",
          "options": [
            {
              "value": "icon_only",
              "label": "t:shared.options.icon_only"
            },
            {
              "value": "icon_text",
              "label": "t:shared.options.icon_and_text"
            },
            {
              "value": "text_only",
              "label": "t:shared.options.text_only"
            }
          ]
        }
      ]
    },
    {
      "type": "social_actions",
      "name": "t:sections.product.blocks.social_actions.name",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "t:sections.product.blocks.social_actions.settings.paragraph__description.content"
        },
        {
          "type": "checkbox",
          "id": "show_share",
          "label": "t:shared.settings.show_share.label",
          "default": true
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}