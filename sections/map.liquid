{%- comment -%}
  Interactive Map Section
  Uses OpenStreetMap with Leaflet.js (free, no API key required)
{%- endcomment -%}

{%- liquid
  # Map container: empty when full width (edge-to-edge), page-container otherwise
  if section.settings.full_width
    assign map_container_class = ''
  else
    assign map_container_class = 'page-container'
  endif

  # Header and info containers: container-fluid when full width (side padding, no max-width)
  capture content_container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture

  # Default coordinates (New York City) if none provided
  assign default_lat = 40.7128
  assign default_lng = -74.0060

  assign lat = section.settings.latitude | default: default_lat
  assign lng = section.settings.longitude | default: default_lng
-%}

<div class="map-section section-padding color-{{ section.settings.color_scheme }}" style="--map-height: {{ section.settings.map_height }}px;">
  {%- comment -%} Header {%- endcomment -%}
  <div class="{{ content_container_class }} section-header-spacing">
    {% render 'section-header',
      label: section.settings.label,
      title: section.settings.title,
      alignment: section.settings.header_alignment,
      group_id: section.id,
      animate: true
    %}
  </div>

  <div class="{{ map_container_class }}">
    <div
      id="map-{{ section.id }}"
      class="map-container {% if section.settings.full_width %}full-width{% endif %} {% if section.settings.grayscale %}grayscale{% endif %}"
      data-map
      data-lat="{{ lat }}"
      data-lng="{{ lng }}"
      data-zoom="{{ section.settings.zoom }}"
      data-address="{{ section.settings.address | escape }}"
      data-location-name="{{ section.settings.location_name | escape }}"
      data-marker-color="{{ section.settings.marker_color }}"
      data-section-id="{{ section.id }}"
      data-leaflet-css="{{ 'leaflet.css' | asset_url }}"
      data-leaflet-js="{{ 'leaflet.js' | asset_url }}"
    >
      <div class="map-loading" data-map-loading>
        <div class="map-loading-spinner"></div>
      </div>
    </div>
  </div>

  {% if section.blocks.size > 0 %}
    <div class="map-info {{ content_container_class }}">
      <div class="map-info-grid">
        {% for block in section.blocks %}
          <div class="map-info-item" {{ block.shopify_attributes }} data-tween data-tween-type="fade-up">
            {% if block.settings.title != blank %}
              <h3 class="text-label">{{ block.settings.title }}</h3>
            {% endif %}
            {% case block.type %}
              {% when 'address' %}
                <p class="whitespace-pre-line">{{ block.settings.address }}</p>
              {% when 'hours' %}
                <p class="whitespace-pre-line">{{ block.settings.hours }}</p>
              {% when 'contact' %}
                {% if block.settings.phone != blank %}
                  <p><a href="tel:{{ block.settings.phone | remove: ' ' | remove: '-' | remove: '(' | remove: ')' }}">{{ block.settings.phone }}</a></p>
                {% endif %}
                {% if block.settings.email != blank %}
                  <p><a href="mailto:{{ block.settings.email }}">{{ block.settings.email }}</a></p>
                {% endif %}
              {% when 'custom' %}
                <div>{{ block.settings.content }}</div>
            {% endcase %}
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

<script>
(function() {
  const mapContainer = document.getElementById('map-{{ section.id }}');
  if (!mapContainer || mapContainer.dataset.mapInitialized) return;
  mapContainer.dataset.mapInitialized = 'true';

  const loadingEl = mapContainer.querySelector('[data-map-loading]');
  let leafletLoaded = false;
  let mapInstance = null;

  /**
   * Load Leaflet CSS dynamically
   */
  function loadLeafletCSS() {
    return new Promise((resolve) => {
      const cssUrl = mapContainer.dataset.leafletCss;
      if (!cssUrl || document.querySelector(`link[href="${cssUrl}"]`)) {
        resolve();
        return;
      }

      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = cssUrl;
      link.addEventListener('load', resolve, { once: true });
      link.addEventListener('error', resolve, { once: true });
      document.head.appendChild(link);
    });
  }

  /**
   * Load Leaflet JS dynamically
   */
  function loadLeafletJS() {
    return new Promise((resolve, reject) => {
      if (typeof L !== 'undefined') {
        resolve();
        return;
      }

      const jsUrl = mapContainer.dataset.leafletJs;
      if (!jsUrl) {
        reject(new Error('Leaflet JS URL not found'));
        return;
      }

      const script = document.createElement('script');
      script.src = jsUrl;
      script.addEventListener('load', resolve, { once: true });
      script.addEventListener('error', reject, { once: true });
      document.head.appendChild(script);
    });
  }

  /**
   * Initialize the map once Leaflet is loaded
   */
  function initMap() {
    if (mapInstance) return;

    const lat = parseFloat(mapContainer.dataset.lat);
    const lng = parseFloat(mapContainer.dataset.lng);
    const zoom = parseInt(mapContainer.dataset.zoom) || 14;
    const address = mapContainer.dataset.address;
    const locationName = mapContainer.dataset.locationName;
    const markerColor = mapContainer.dataset.markerColor || '#000000';
    const sectionId = mapContainer.dataset.sectionId;

    // Initialize map
    mapInstance = L.map(mapContainer, {
      scrollWheelZoom: false,
      zoomControl: true
    }).setView([lat, lng], zoom);

    // Add tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(mapInstance);

    // Custom marker icon
    const markerIcon = L.divIcon({
      className: 'custom-map-marker',
      html: `<div style="
        width: 32px;
        height: 32px;
        background-color: ${markerColor};
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      ">
        <div style="
          width: 12px;
          height: 12px;
          background-color: white;
          border-radius: 50%;
          transform: rotate(45deg);
        "></div>
      </div>`,
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    // Add marker
    const marker = L.marker([lat, lng], { icon: markerIcon }).addTo(mapInstance);

    // Add popup if location name or address exists
    if (locationName || address) {
      const popupContent = `
        <div class="map-popup">
          ${locationName ? `<div class="map-popup-title">${locationName}</div>` : ''}
          ${address ? `<div class="map-popup-address">${address.replace(/\n/g, '<br>')}</div>` : ''}
        </div>
      `;
      marker.bindPopup(popupContent, {
        className: 'map-popup'
      });

      // Open popup by default if setting enabled
      {% if section.settings.show_popup %}
      marker.openPopup();
      {% endif %}
    }

    // Enable scroll zoom on click
    mapInstance.on('click', function() {
      mapInstance.scrollWheelZoom.enable();
    });

    // Disable scroll zoom when mouse leaves
    mapInstance.on('mouseout', function() {
      mapInstance.scrollWheelZoom.disable();
    });

    // Handle resize (debounced to avoid excessive map recalculations)
    function handleResize() {
      if (mapInstance) mapInstance.invalidateSize();
    }
    let mapResizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(mapResizeTimeout);
      mapResizeTimeout = setTimeout(handleResize, 200);
    });

    // Handle Swup transitions
    if (window.onSwupContentReplaced) {
      window.onSwupContentReplaced('map-resize-{{ section.id }}', handleResize);
    }

    // Hide loading spinner
    if (loadingEl) {
      loadingEl.classList.add('is-hidden');
    }
  }

  /**
   * Load Leaflet and initialize map
   */
  async function loadAndInitMap() {
    if (leafletLoaded) return;
    leafletLoaded = true;

    try {
      // Load CSS and JS in parallel
      await Promise.all([
        loadLeafletCSS(),
        loadLeafletJS()
      ]);

      // Small delay to ensure Leaflet is fully initialized
      requestAnimationFrame(() => {
        initMap();
      });
    } catch (error) {
      // Hide loading spinner on error
      if (loadingEl) {
        loadingEl.classList.add('is-hidden');
      }
    }
  }

  /**
   * Set up IntersectionObserver for lazy loading
   */
  function setupLazyLoad() {
    // Use IntersectionObserver to load only when map is near viewport
    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              loadAndInitMap();
              observer.disconnect();
            }
          });
        },
        {
          rootMargin: '200px 0px', // Start loading 200px before visible
          threshold: 0
        }
      );

      observer.observe(mapContainer);
    } else {
      // Fallback for browsers without IntersectionObserver
      loadAndInitMap();
    }
  }

  // Initialize lazy loading
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupLazyLoad);
  } else {
    setupLazyLoad();
  }
})();
</script>

{% schema %}
{
  "name": "Map",
  "tag": "section",
  "class": "map-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label",
      "default": "Visit Us"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Our Location"
    },
    {
      "type": "header",
      "content": "Location"
    },
    {
      "type": "text",
      "id": "location_name",
      "label": "Location name",
      "default": "Our Store",
      "info": "Shown in the map popup"
    },
    {
      "type": "textarea",
      "id": "address",
      "label": "Address",
      "default": "123 Main Street\nNew York, NY 10001",
      "info": "Shown in the map popup"
    },
    {
      "type": "text",
      "id": "latitude",
      "label": "Latitude",
      "default": "40.7128",
      "info": "Get coordinates from Google Maps or similar"
    },
    {
      "type": "text",
      "id": "longitude",
      "label": "Longitude",
      "default": "-74.0060",
      "info": "Right-click location on Google Maps â†’ 'What's here?'"
    },
    {
      "type": "range",
      "id": "zoom",
      "min": 10,
      "max": 18,
      "step": 1,
      "default": 14,
      "label": "Zoom level",
      "info": "Higher = more zoomed in"
    },
    {
      "type": "checkbox",
      "id": "show_popup",
      "label": "Show popup by default",
      "default": true
    },
    {
      "type": "header",
      "content": "Styling"
    },
    {
      "type": "range",
      "id": "map_height",
      "min": 300,
      "max": 700,
      "step": 50,
      "default": 450,
      "unit": "px",
      "label": "Map height"
    },
    {
      "type": "color",
      "id": "marker_color",
      "label": "Marker color",
      "default": "#000000"
    },
    {
      "type": "checkbox",
      "id": "grayscale",
      "label": "Grayscale map",
      "default": false,
      "info": "Apply grayscale filter to map tiles"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "label": "Header alignment",
      "default": "left"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    }
  ],
  "blocks": [
    {
      "type": "address",
      "name": "Address",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Address"
        },
        {
          "type": "textarea",
          "id": "address",
          "label": "Address",
          "default": "123 Main Street\nNew York, NY 10001"
        }
      ]
    },
    {
      "type": "hours",
      "name": "Hours",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Hours"
        },
        {
          "type": "textarea",
          "id": "hours",
          "label": "Hours",
          "default": "Mon - Fri: 9am - 6pm\nSat: 10am - 4pm\nSun: Closed"
        }
      ]
    },
    {
      "type": "contact",
      "name": "Contact Info",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Contact"
        },
        {
          "type": "text",
          "id": "phone",
          "label": "Phone"
        },
        {
          "type": "text",
          "id": "email",
          "label": "Email"
        }
      ]
    },
    {
      "type": "custom",
      "name": "Custom Content",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Map",
      "category": "Store information",
      "blocks": [
        {
          "type": "address",
          "settings": {
            "title": "Address",
            "address": "123 Main Street\nNew York, NY 10001"
          }
        },
        {
          "type": "hours",
          "settings": {
            "title": "Hours",
            "hours": "Mon - Fri: 9am - 6pm\nSat: 10am - 4pm\nSun: Closed"
          }
        },
        {
          "type": "contact",
          "settings": {
            "title": "Contact",
            "phone": "(555) 123-4567",
            "email": "hello@example.com"
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
  }
{% endschema %}
