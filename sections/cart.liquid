{%- comment -%}
  Cart Section - Modern design with GSAP animations
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width
  endcapture
-%}

<style>
  /* Title line stagger (managed by TweenManager) */
  .cart-wrapper .page-title .tween-split-line:nth-child(2) {
    margin-left: clamp(1.5rem, 10vw, 8rem);
  }
  .cart-wrapper .page-title .tween-split-line:nth-child(3) {
    margin-left: clamp(3rem, 18vw, 14rem);
  }
  .cart-quantity {
    display: inline-flex;
    align-items: center;
    background: transparent;
    border-radius: var(--input-radius);
    padding: 0;
    position: relative;
    overflow: hidden;
    border: var(--input-border-width) solid var(--color-border);
    box-shadow: var(--input-shadow);
  }
  .cart-quantity-btn {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--color-text);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .cart-quantity-btn:hover {
    background: var(--color-primary);
    color: var(--color-primary-contrast);
  }
  .cart-quantity-btn:active {
    transform: scale(0.95);
  }
  .cart-quantity-value {
    width: 3.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .cart-quantity-input {
    width: 100%;
    height: 100%;
    text-align: center;
    font-size: 1rem;
    font-weight: 600;
    background: transparent;
    border: none !important;
    border-width: 0 !important;
    box-shadow: none !important;
    color: var(--color-text);
    -moz-appearance: textfield;
    outline: none;
  }
  .cart-quantity-input::-webkit-outer-spin-button,
  .cart-quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .cart-quantity-input:focus {
    outline: none;
    border: none !important;
  }
  .cart-quantity:focus-within {
    border-color: var(--color-primary);
    box-shadow: var(--input-shadow-focus);
  }
  .cart-quantity.is-changing .cart-quantity-input {
    animation: cartQuantityPop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  @keyframes cartQuantityPop {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
    }
  }
  .cart-wrapper.is-updating {
    cursor: wait;
  }
  .cart-wrapper.is-updating * {
    cursor: wait !important;
  }
  .cart-wrapper.is-updating [data-cart-form] {
    opacity: 0.5;
    pointer-events: none;
  }
  /* Dynamic checkout buttons styling */
  .cart-dynamic-checkout {
    margin-top: 0.75rem;
  }
  .cart-dynamic-checkout .dynamic-checkout__buttons {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .cart-dynamic-checkout [data-shopify-buttoncontainer] {
    justify-content: stretch;
  }
</style>

<div class="cart-wrapper min-h-screen page-padding" data-cart-wrapper>
  <header
    class="section-header-spacing {{ container_class }} {% if section.settings.header_alignment == 'center' %}text-center{% elsif section.settings.header_alignment == 'right' %}text-right{% endif %}"
    data-tween-group="cart-header"
    data-tween-start="top bottom">
    <h1
      class="page-title"
      data-tween
      data-tween-type="split-text">
      {{ 'cart.title' | t }}
    </h1>

    <p class="page-header-subtitle {% if section.settings.header_alignment == 'center' %}justify-center{% elsif section.settings.header_alignment == 'right' %}justify-end{% endif %}">
      <span class="page-header-subtitle-line" data-subtitle-line></span>
      <span class="overflow-hidden">
        <span class="inline-block" data-subtitle-text>{{ cart.item_count }} {{ cart.item_count | pluralize: 'Item', 'Items' }}</span>
      </span>
    </p>
  </header>

  {% if cart.item_count > 0 %}
    <div class="{{ container_class }}">
      <div class="lg:grid lg:grid-cols-12 lg:gap-x-12">
        {%- comment -%} Cart Items {%- endcomment -%}
        <div class="lg:col-span-7">
          <form
            action="{{ routes.cart_url }}"
            method="post"
            id="cart-form"
            data-cart-form>
            <ul role="list" class="divide-y divide-(--color-border)">
              {% for item in cart.items %}
                <li
                  class="py-8 first:pt-0"
                  data-cart-item
                  data-line="{{ forloop.index }}"
                  data-tween
                  data-tween-type="fade-up">
                  <div class="flex gap-6">
                    {%- comment -%} Image {%- endcomment -%}
                    <div class="w-28 h-36 flex-shrink-0 overflow-hidden bg-(--color-background-secondary)">
                      {% if item.image %}
                        <a href="{{ item.url }}" aria-label="{{ item.product.title }}">
                          {{ item.image | image_url: width: 300 | image_tag: class: 'w-full h-full object-cover', loading: 'lazy', fetchpriority: 'low', decoding: 'async', alt: item.image.alt | default: item.product.title
                          }}
                        </a>
                      {% endif %}
                    </div>

                    {%- comment -%} Details {%- endcomment -%}
                    <div class="flex flex-1 flex-col justify-between">
                      <div>
                        <div class="flex justify-between">
                          <div>
                            <h3 class="text-base font-medium text-(--color-text)">
                              <a href="{{ item.url }}" class="hover:text-(--color-primary) transition-colors">
                                {{ item.product.title }}
                              </a>
                            </h3>
                            {% unless item.product.has_only_default_variant %}
                              <p class="mt-1 text-sm text-(--color-text-secondary)">{{ item.variant.title }}</p>
                            {% endunless %}
                            {% if item.selling_plan_allocation %}
                              <p class="mt-1 text-xs text-(--color-text-secondary)">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                            {% endif %}
                          </div>
                          <div class="text-right">
                            {%- liquid
                              assign has_compare_at = false
                              if item.variant.compare_at_price > item.variant.price
                                assign has_compare_at = true
                                assign compare_at_line_price = item.variant.compare_at_price | times: item.quantity
                              endif
                              assign has_discount = false
                              if item.original_line_price != item.final_line_price
                                assign has_discount = true
                              endif
                            -%}
                            <p class="text-base font-medium {% if has_compare_at or has_discount %}text-red-600{% else %}text-(--color-text){% endif %}">{{ item.final_line_price | money }}</p>
                            {% if has_compare_at %}
                              <p class="text-sm text-(--color-text-secondary) line-through">{{ compare_at_line_price | money }}</p>
                            {% elsif has_discount %}
                              <p class="text-sm text-(--color-text-secondary) line-through">{{ item.original_line_price | money }}</p>
                            {% endif %}
                            {%- if item.unit_price_measurement -%}
                              <p class="text-xs text-(--color-text-secondary) mt-1">
                                {{ item.unit_price | money }}/{{ item.unit_price_measurement.reference_value }}{{ item.unit_price_measurement.reference_unit }}</p>
                            {%- endif -%}
                          </div>
                        </div>

                        {%- comment -%} Line-level discount display - Required for Theme Store {%- endcomment -%}
                        {%- if item.line_level_discount_allocations.size > 0 -%}
                          <ul
                            class="mt-2 list-none p-0"
                            role="list"
                            aria-label="{{ 'accessibility.discount' | t }}">
                            {%- for discount in item.line_level_discount_allocations -%}
                              <li class="inline-flex items-center gap-1 text-xs text-green-600">
                                <i class="ph ph-tag"></i>
                                <span>{{ discount.discount_application.title }} (-{{ discount.amount | money }})</span>
                              </li>
                            {%- endfor -%}
                          </ul>
                        {%- endif -%}
                      </div>

                      <div class="flex items-center justify-between mt-4">
                        {%- comment -%} Quantity {%- endcomment -%}
                        <div class="cart-quantity" data-quantity-wrapper>
                          <button
                            type="button"
                            class="cart-quantity-btn"
                            data-quantity-minus
                            aria-label="{{ 'accessibility.decrease_quantity' | t }}">
                            <i class="ph ph-minus"></i>
                          </button>
                          <div class="cart-quantity-value">
                            <input
                              type="number"
                              name="updates[]"
                              value="{{ item.quantity }}"
                              min="0"
                              class="cart-quantity-input"
                              data-quantity-input
                              data-line="{{ forloop.index }}"
                              aria-label="{{ 'accessibility.quantity' | t }}">
                          </div>
                          <button
                            type="button"
                            class="cart-quantity-btn"
                            data-quantity-plus
                            aria-label="{{ 'accessibility.increase_quantity' | t }}">
                            <i class="ph ph-plus"></i>
                          </button>
                        </div>

                        {%- comment -%} Remove {%- endcomment -%}
                        <button
                          type="button"
                          class="text-sm uppercase tracking-wider font-medium text-(--color-text-secondary) hover:text-(--color-text) transition-colors"
                          data-remove-item
                          data-line="{{ forloop.index }}">
                          {{ 'cart.remove' | t }}
                        </button>
                      </div>
                    </div>
                  </div>
                </li>
              {% endfor %}
            </ul>
          </form>
        </div>

        {%- comment -%} Summary {%- endcomment -%}
        <div class="lg:col-span-5 mt-12 lg:mt-0">
          <div
            class="sticky top-12 bg-(--color-background-secondary) p-8"
            data-tween
            data-tween-type="fade-up">
            {%- comment -%} Free Shipping Progress {%- endcomment -%}
            <div class="mb-6" data-free-shipping-wrapper>
              {% render 'free-shipping-progress' %}
            </div>

            <h2 class="card-title">{{ 'cart.summary' | t }}</h2>

            <dl class="mt-6 space-y-4">
              <div class="flex items-center justify-between">
                <dt class="text-sm text-(--color-text-secondary)">{{ 'cart.subtotal' | t }}</dt>
                <dd class="text-sm font-medium text-(--color-text)" data-cart-subtotal>{{ cart.total_price | money }}</dd>
              </div>
              {% if cart.cart_level_discount_applications.size > 0 %}
                {% for discount in cart.cart_level_discount_applications %}
                  <div class="flex items-center justify-between">
                    <dt class="text-sm text-(--color-text-secondary)">
                      <i class="ph ph-tag mr-1"></i>
                      {{ discount.title }}
                    </dt>
                    <dd class="text-sm font-medium text-green-600">-{{ discount.total_allocated_amount | money }}</dd>
                  </div>
                {% endfor %}
              {% endif %}
            </dl>

            <div class="mt-6 pt-6 border-t border-(--color-border)">
              <div class="flex items-center justify-between">
                <dt class="text-base font-medium text-(--color-text)">{{ 'cart.total' | t }}</dt>
                <dd class="text-base font-medium text-(--color-text)" data-cart-total>{{ cart.total_price | money }}</dd>
              </div>
              <p class="mt-1 text-xs text-(--color-text-secondary)">{{ 'cart.taxes_shipping_note' | t }}</p>
            </div>

            {%- comment -%} Cart Note {%- endcomment -%}
            <details class="mt-6">
              <summary class="text-sm uppercase tracking-wider font-medium text-(--color-text-secondary) cursor-pointer hover:text-(--color-text) transition-colors flex items-center justify-between">
                <span>{{ 'cart.add_note' | t }}</span>
                <i class="ph ph-caret-down text-sm transition-transform"></i>
              </summary>
              <div class="mt-4">
                <textarea
                  name="note"
                  form="cart-form"
                  class="w-full p-3 text-sm bg-transparent border border-(--color-border) text-(--color-text) resize-none focus:border-(--color-primary) focus:outline-none"
                  rows="3"
                  placeholder="{{ 'cart.note_placeholder' | t }}"
                  data-cart-note>{{ cart.note }}</textarea>
              </div>
            </details>

            {%- comment -%} Actions {%- endcomment -%}
            <div class="mt-8 space-y-3">
              {%- assign btn_checkout = 'cart.checkout' | t -%}
              <form action="{{ routes.cart_url }}" method="post">
                <button
                  type="submit"
                  name="checkout"
                  class="btn btn--primary btn--full">
                  <i class="ph ph-lock-simple"></i>
                  {% render 'button-text', text: btn_checkout %}
                </button>
              </form>

              {%- comment -%} Dynamic Checkout / Accelerated Checkout Buttons (Shop Pay, Apple Pay, etc.) {%- endcomment -%}
              {%- if additional_checkout_buttons -%}
                <div class="cart-dynamic-checkout">
                  {{ content_for_additional_checkout_buttons }}
                </div>
              {%- endif -%}

              {%- assign btn_continue_shopping = 'cart.continue_shopping' | t -%}
              <a href="{{ routes.all_products_collection_url }}" class="btn btn--secondary btn--full">
                <i class="ph ph-arrow-left"></i>
                {% render 'button-text', text: btn_continue_shopping %}
              </a>
            </div>

            {%- comment -%} Trust Badges {%- endcomment -%}
            {% if section.settings.show_trust_badges %}
              <div class="mt-8 pt-6 border-t border-(--color-border)">
                <div class="flex items-center justify-center gap-6 text-(--color-text-secondary)">
                  {% if section.settings.badge_1_text != blank %}
                    <div class="flex items-center gap-2 text-xs">
                      <i class="ph ph-{{ section.settings.badge_1_icon }} text-lg"></i>
                      <span>{{ section.settings.badge_1_text }}</span>
                    </div>
                  {% endif %}
                  {% if section.settings.badge_2_text != blank %}
                    <div class="flex items-center gap-2 text-xs">
                      <i class="ph ph-{{ section.settings.badge_2_icon }} text-lg"></i>
                      <span>{{ section.settings.badge_2_text }}</span>
                    </div>
                  {% endif %}
                  {% if section.settings.badge_3_text != blank %}
                    <div class="flex items-center gap-2 text-xs">
                      <i class="ph ph-{{ section.settings.badge_3_icon }} text-lg"></i>
                      <span>{{ section.settings.badge_3_text }}</span>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div
      class="{{ container_class }} px-0 text-center"
      data-tween
      data-tween-type="fade-up"
      data-tween-start="top bottom">
      <h2 class="section-title">{{ 'cart.empty' | t }}</h2>
      <p class="mt-4 text-(--color-text-secondary) max-w-sm mx-auto">{{ 'cart.empty_description' | t }}</p>

      {%- assign btn_start_shopping = 'cart.start_shopping' | t -%}
      {%- assign btn_back_home = '404.back_home' | t -%}
      <div class="mt-10 flex flex-col sm:flex-row gap-4 mx-auto sm:justify-center">
        <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary w-full sm:w-auto">
          <i class="ph ph-storefront"></i>
          {% render 'button-text', text: btn_start_shopping %}
        </a>
        <a href="{{ routes.root_url }}" class="btn btn--secondary w-full sm:w-auto">
          <i class="ph ph-house"></i>
          {% render 'button-text', text: btn_back_home %}
        </a>
      </div>
    </div>
  {% endif %}
</div>

{%- comment -%} Cart page functionality is now handled by CartPageManager in the bundled JS {%- endcomment -%}

<script>
  (function() {
  if (document.documentElement.classList.contains('animations-disabled')) return;

  const wrapper = document.querySelector('[data-cart-wrapper]');
  if (!wrapper) return;

  // Wait for GSAP
  const initAnimation = () => {
    if (typeof gsap === 'undefined') {
      requestAnimationFrame(initAnimation);
      return;
    }

    const tl = gsap.timeline();

    // Subtitle line draw animation
    const subtitleLine = wrapper.querySelector('[data-subtitle-line]');
    if (subtitleLine) {
      gsap.set(subtitleLine, { scaleX: 0, transformOrigin: 'left center' });
      tl.to(subtitleLine, {
        scaleX: 1,
        duration: 0.8,
        ease: 'power3.out'
      }, 0.4);
    }

    // Subtitle text reveal
    const subtitleText = wrapper.querySelector('[data-subtitle-text]');
    if (subtitleText) {
      gsap.set(subtitleText, { yPercent: 120 });
      tl.to(subtitleText, {
        yPercent: 0,
        duration: 0.8,
        ease: 'power4.out'
      }, 0.6);
    }
  };

  initAnimation();
  })();
</script>

{% schema %}
  {
    "name": "Cart",
    "settings": [
      {
        "type": "checkbox",
        "id": "full_width",
        "label": "Full width",
        "default": false
      },
      {
        "type": "text_alignment",
        "id": "header_alignment",
        "default": "left",
        "label": "Header alignment"
      },
      {
        "type": "header",
        "content": "Trust badges"
      },
      {
        "type": "checkbox",
        "id": "show_trust_badges",
        "label": "Show trust badges",
        "default": true
      },
      {
        "type": "text",
        "id": "badge_1_icon",
        "label": "Badge 1 icon",
        "default": "shield-check",
        "info": "Phosphor icon name (e.g., shield-check, lock, credit-card)"
      },
      {
        "type": "text",
        "id": "badge_1_text",
        "label": "Badge 1 text",
        "default": "Secure"
      },
      {
        "type": "text",
        "id": "badge_2_icon",
        "label": "Badge 2 icon",
        "default": "truck",
        "info": "Phosphor icon name (e.g., truck, package, airplane)"
      },
      {
        "type": "text",
        "id": "badge_2_text",
        "label": "Badge 2 text",
        "default": "Fast Shipping"
      },
      {
        "type": "text",
        "id": "badge_3_icon",
        "label": "Badge 3 icon",
        "default": "arrows-counter-clockwise",
        "info": "Phosphor icon name (e.g., arrows-counter-clockwise, arrow-u-up-left)"
      },
      {
        "type": "text",
        "id": "badge_3_text",
        "label": "Badge 3 text",
        "default": "Easy Returns"
      }
    ],
    "disabled_on": {
      "groups": ["header", "footer"]
    }
    }
{% endschema %}