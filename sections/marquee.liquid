{%- comment -%}
  Marquee Section - Infinite scrolling text ticker
  Advanced version with scroll direction detection and speed acceleration
{%- endcomment -%}

<div
  class="marquee-section overflow-hidden section-padding{% unless section.settings.padding == 'default' %}-{{ section.settings.padding }}{% endunless %} color-{{ section.settings.color_scheme }}"
  data-marquee-section="{{ section.id }}"
  data-marquee-direction="{{ section.settings.direction }}"
  data-marquee-speed="{{ section.settings.speed }}"
  data-marquee-scroll-aware="{{ section.settings.scroll_aware }}"
  data-marquee-scroll-speed="{{ section.settings.scroll_speed }}"
  data-marquee-pause-on-hover="{{ section.settings.pause_on_hover }}"
  data-marquee-status="normal">
  <div class="marquee-wrapper">
    <div class="marquee-content">
      {% for block in section.blocks %}
        <div class="marquee-item" {{ block.shopify_attributes }}>
          {% case block.type %}
            {% when 'text' %}
              <span class="marquee-text{% if block.settings.outline %} outline{% endif %}">
                {{ block.settings.text }}
              </span>
            {% when 'separator' %}
              {% if block.settings.style == 'dot' %}
                <span class="marquee-separator"></span>
              {% elsif block.settings.style == 'icon' %}
                <i class="marquee-icon ph ph-{{ block.settings.icon }}"></i>
              {% endif %}
          {% endcase %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  (function() {
  const sectionId = '{{ section.id }}';
  const section = document.querySelector(`[data-marquee-section="${sectionId}"]`);
  if (!section || section.dataset.marqueeInitialized) return;
  section.dataset.marqueeInitialized = 'true';

  const wrapper = section.querySelector('.marquee-wrapper');
  const content = section.querySelector('.marquee-content');
  if (!wrapper || !content) return;

  // Configuration from data attributes
  const direction = section.dataset.marqueeDirection === 'right' ? 1 : -1;
  const baseSpeed = parseFloat(section.dataset.marqueeSpeed) || 30;
  const scrollAware = section.dataset.marqueeScrollAware === 'true';
  const scrollSpeedMultiplier = parseFloat(section.dataset.marqueeScrollSpeed) || 2;
  const pauseOnHover = section.dataset.marqueePauseOnHover === 'true';

  let tween = null;
  let isHovered = false;
  // Direction multiplier: -1 = left (content moves left/negative x), 1 = right (content moves right/positive x)
  // Setting "left" means visual movement to left, setting "right" means visual movement to right
  let currentDirection = direction === 1 ? 1 : -1; // right setting = 1, left setting = -1

  function initMarquee() {
    const gsap = window.pieces?.gsap || window.gsap;
    const ScrollTrigger = window.pieces?.ScrollTrigger || window.ScrollTrigger;

    if (!gsap || !ScrollTrigger) {
      requestAnimationFrame(initMarquee);
      return;
    }

    // Duplicate content for seamless loop
    const items = content.querySelectorAll('.marquee-item');
    if (items.length === 0) return;

    // Calculate total width of original content
    let totalWidth = 0;
    items.forEach(item => {
      totalWidth += item.offsetWidth;
    });

    // Add gap to total width calculation
    const style = getComputedStyle(content);
    const gap = parseFloat(style.gap) || 0;
    totalWidth += gap * items.length;

    // Clone items until we have enough for seamless scroll
    const viewportWidth = window.innerWidth;
    const clonesNeeded = Math.ceil((viewportWidth * 3) / totalWidth) + 1;

    for (let i = 0; i < clonesNeeded; i++) {
      items.forEach(item => {
        const clone = item.cloneNode(true);
        clone.setAttribute('aria-hidden', 'true');
        content.appendChild(clone);
      });
    }

    // Recalculate total width after cloning (one set width for looping)
    let oneSetWidth = 0;
    for (let i = 0; i < items.length; i++) {
      oneSetWidth += items[i].offsetWidth + gap;
    }

    // Create wrap function for seamless looping
    const wrapX = gsap.utils.wrap(-oneSetWidth, 0);

    // Set initial position based on direction
    // For right direction (1), start at -oneSetWidth so we can move towards 0 (positive movement)
    // For left direction (-1), start at 0 so we can move towards -oneSetWidth (negative movement)
    const startX = currentDirection === 1 ? -oneSetWidth : 0;
    gsap.set(content, { x: startX });

    // Speed in pixels per second
    const pixelsPerSecond = oneSetWidth / baseSpeed;
    let currentX = startX;

    // Use gsap.ticker for smooth continuous animation
    function animate(time, deltaTime) {
      if (!tween || tween.paused) return;

      // Calculate movement based on direction and delta time
      const movement = (pixelsPerSecond * deltaTime / 1000) * currentDirection;
      currentX += movement;

      // Wrap the position
      currentX = wrapX(currentX);

      gsap.set(content, { x: currentX });
    }

    // Create a simple object to control play/pause state
    tween = {
      paused: false,
      pause: function() { this.paused = true; },
      play: function() { this.paused = false; },
      kill: function() { gsap.ticker.remove(animate); }
    };

    gsap.ticker.add(animate);

    // Scroll-aware direction inversion and acceleration (only if enabled in section settings)
    if (scrollAware) {
      // Store the initial direction for reference
      const initialDirection = currentDirection;
      let lastScrollY = window.scrollY;
      let scrollDelta = 0;
      const scrollThreshold = 50; // Minimum scroll distance to trigger direction change
      let currentScrollState = null; // null = initial, 'down' = scrolling down, 'up' = scrolling up

      // Direction inversion on scroll
      ScrollTrigger.create({
        trigger: section,
        start: 'top bottom',
        end: 'bottom top',
        onUpdate: function(self) {
          if (isHovered || !tween) return;

          // Calculate actual scroll delta
          const currentScrollY = window.scrollY;
          const delta = currentScrollY - lastScrollY;
          lastScrollY = currentScrollY;

          // Ignore tiny movements (Lenis settling, momentum)
          if (Math.abs(delta) < 3) return;

          // Accumulate scroll in same direction, reset if direction changes
          if ((delta > 0 && scrollDelta >= 0) || (delta < 0 && scrollDelta <= 0)) {
            scrollDelta += delta;
          } else {
            // Direction changed, reset delta
            scrollDelta = delta;
          }

          // Only trigger direction change after significant scroll
          if (Math.abs(scrollDelta) < scrollThreshold) return;

          // Determine new scroll state
          const newScrollState = scrollDelta > 0 ? 'down' : 'up';

          // Only change if scroll state actually changed
          if (currentScrollState === newScrollState) return;
          currentScrollState = newScrollState;
          scrollDelta = 0; // Reset after state change

          // Calculate new direction:
          // - Scroll down = NORMAL (same as initial)
          // - Scroll up = INVERTED (opposite of initial)
          let newDirection;
          if (newScrollState === 'down') {
            // Normal: same as initial direction
            newDirection = initialDirection;
            section.dataset.marqueeStatus = 'normal';
          } else {
            // Inverted: flip the initial direction
            newDirection = -initialDirection;
            section.dataset.marqueeStatus = 'inverted';
          }

          // Only change if direction actually changes
          if (currentDirection === newDirection) return;

          currentDirection = newDirection;
        }
      });

      // Scroll acceleration effect using scrub
      // Expand the wrapper and move it with scroll for acceleration illusion
      const scrollAcceleration = scrollSpeedMultiplier * 5; // Convert 1-5 to vw amount

      // Set wrapper styles for scroll effect
      wrapper.style.marginLeft = -scrollAcceleration + 'vw';
      wrapper.style.width = (scrollAcceleration * 2) + 100 + 'vw';

      // Create scrubbed timeline for scroll acceleration
      gsap.timeline({
        scrollTrigger: {
          trigger: section,
          start: 'top bottom',
          end: 'bottom top',
          scrub: 0
        }
      }).fromTo(wrapper,
        { x: (direction === -1 ? scrollAcceleration : -scrollAcceleration) + 'vw' },
        { x: (direction === -1 ? -scrollAcceleration : scrollAcceleration) + 'vw', ease: 'none' }
      );
    }

    // Pause on hover
    if (pauseOnHover) {
      let statusBeforeHover = section.dataset.marqueeStatus || 'normal';

      section.addEventListener('mouseenter', function() {
        statusBeforeHover = section.dataset.marqueeStatus || 'normal';
        isHovered = true;
        section.dataset.marqueeStatus = 'paused';
        tween.pause();
      });

      section.addEventListener('mouseleave', function() {
        isHovered = false;
        section.dataset.marqueeStatus = statusBeforeHover;
        tween.play();
      });
    }

    // IntersectionObserver for play/pause optimization
    let statusBeforeOffscreen = section.dataset.marqueeStatus || 'normal';

    const observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          if (!isHovered && tween) {
            tween.play();
            section.dataset.marqueeStatus = statusBeforeOffscreen;
          }
        } else {
          if (tween) {
            statusBeforeOffscreen = section.dataset.marqueeStatus || 'normal';
            tween.pause();
            section.dataset.marqueeStatus = 'paused';
          }
        }
      });
    }, { threshold: 0 });

    observer.observe(section);
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMarquee);
  } else {
    requestAnimationFrame(initMarquee);
  }
  })();
</script>

{% schema %}
{
  "name": "t:sections.marquee.name",
  "tag": "section",
  "class": "marquee-section-wrapper",
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.animation"
    },
    {
      "type": "select",
      "id": "direction",
      "options": [
        {
          "value": "left",
          "label": "t:sections.marquee.settings.direction.options__0.label"
        },
        {
          "value": "right",
          "label": "t:sections.marquee.settings.direction.options__1.label"
        }
      ],
      "default": "left",
      "label": "t:sections.marquee.settings.direction.label"
    },
    {
      "type": "range",
      "id": "speed",
      "min": 10,
      "max": 60,
      "step": 5,
      "default": 30,
      "unit": "s",
      "label": "t:sections.marquee.settings.speed.label",
      "info": "t:sections.marquee.settings.speed.info"
    },
    {
      "type": "checkbox",
      "id": "scroll_aware",
      "default": true,
      "label": "t:sections.marquee.settings.scroll_aware.label",
      "info": "t:sections.marquee.settings.scroll_aware.info"
    },
    {
      "type": "range",
      "id": "scroll_speed",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 2,
      "label": "t:sections.marquee.settings.scroll_speed.label",
      "info": "t:sections.marquee.settings.scroll_speed.info"
    },
    {
      "type": "checkbox",
      "id": "pause_on_hover",
      "default": true,
      "label": "t:sections.marquee.settings.pause_on_hover.label"
    },
    {
      "type": "header",
      "content": "t:shared.headers.padding"
    },
    {
      "type": "select",
      "id": "padding",
      "label": "t:sections.marquee.settings.padding.label",
      "default": "small",
      "info": "t:shared.settings.padding.info",
      "options": [
        {
          "value": "none",
          "label": "t:shared.settings.padding.options__0.label"
        },
        {
          "value": "small",
          "label": "t:shared.settings.padding.options__1.label"
        },
        {
          "value": "default",
          "label": "t:shared.settings.padding.options__2.label"
        },
        {
          "value": "large",
          "label": "t:shared.settings.padding.options__3.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-3"
    }
  ],
  "blocks": [
    {
      "type": "text",
      "name": "t:sections.marquee.blocks.text.name",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "default": "t:sections.marquee.blocks.text.settings.text.default",
          "label": "t:sections.marquee.blocks.text.settings.text.label"
        },
        {
          "type": "checkbox",
          "id": "outline",
          "default": false,
          "label": "t:sections.marquee.blocks.text.settings.outline.label"
        }
      ]
    },
    {
      "type": "separator",
      "name": "t:sections.marquee.blocks.separator.name",
      "settings": [
        {
          "type": "select",
          "id": "style",
          "options": [
            {
              "value": "dot",
              "label": "t:sections.marquee.blocks.separator.settings.style.options__0.label"
            },
            {
              "value": "icon",
              "label": "t:sections.marquee.blocks.separator.settings.style.options__1.label"
            }
          ],
          "default": "dot",
          "label": "t:sections.marquee.blocks.separator.settings.style.label"
        },
        {
          "type": "select",
          "id": "icon",
          "default": "star-four",
          "label": "t:sections.marquee.blocks.separator.settings.icon.label",
          "options": [
            {
              "value": "star-four",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__0.label"
            },
            {
              "value": "star",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__1.label"
            },
            {
              "value": "sparkle",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__2.label"
            },
            {
              "value": "diamond",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__3.label"
            },
            {
              "value": "heart",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__4.label"
            },
            {
              "value": "lightning",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__5.label"
            },
            {
              "value": "fire",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__6.label"
            },
            {
              "value": "circle",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__7.label"
            },
            {
              "value": "flower",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__8.label"
            },
            {
              "value": "arrow-right",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__9.label"
            },
            {
              "value": "caret-right",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__10.label"
            },
            {
              "value": "minus",
              "label": "t:sections.marquee.blocks.separator.settings.icon.options__11.label"
            }
          ]
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.marquee.presets.marquee.name",
      "category": "t:sections.marquee.presets.marquee.category",
      "blocks": [
        {
          "type": "text",
          "settings": {
            "text": "t:sections.marquee.presets.marquee.blocks.text.0.text"
          }
        },
        {
          "type": "separator",
          "settings": {
            "style": "t:sections.marquee.presets.marquee.blocks.separator.1.style"
          }
        },
        {
          "type": "text",
          "settings": {
            "text": "t:sections.marquee.presets.marquee.blocks.text.2.text",
            "outline": true
          }
        },
        {
          "type": "separator",
          "settings": {
            "style": "t:sections.marquee.presets.marquee.blocks.separator.3.style",
            "icon": "star-four"
          }
        },
        {
          "type": "text",
          "settings": {
            "text": "t:sections.marquee.presets.marquee.blocks.text.4.text"
          }
        },
        {
          "type": "separator",
          "settings": {
            "style": "t:sections.marquee.presets.marquee.blocks.separator.5.style"
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}