{%- comment -%}
  Footer Section - Multiple design options
  Designs: Minimal (centered), Modern (branding + newsletter), Classic (multi-column)
{%- endcomment -%}

{%- liquid
  assign footer_design = section.settings.footer_design | default: 'minimal'
  capture container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture
-%}

<style>
  {% if section.settings.enable_reveal_effect %}
  .footer-wrapper { position: fixed; bottom: 0; left: 0; right: 0; z-index: 0; }
  .site-content { position: relative; z-index: 1; background-color: var(--color-background); margin-bottom: var(--footer-height, 0px); }
  .footer-content-{{ section.id }}.has-reveal { opacity: 0; transform: translateY(40px); }
  {% endif %}
  .footer-section nav a, .footer-section .footer-classic__menu a { color: inherit; opacity: 0.7; transition: opacity 0.3s ease; }
  .footer-section nav a:hover, .footer-section .footer-classic__menu a:hover { opacity: 1; }
</style>

<div class="footer-wrapper" data-footer-wrapper>
<footer
  class="footer-section section-padding{% unless section.settings.padding == 'default' %}-{{ section.settings.padding }}{% endunless %} overflow-hidden color-{{ section.settings.color_scheme }}"
  data-footer-section
>
  <div class="{{ container_class }} footer-content-{{ section.id }}" data-footer-content>
    {%- case footer_design -%}
      {%- when 'minimal' -%}
        {%- render 'footer-minimal', section: section -%}
      {%- when 'modern' -%}
        {%- render 'footer-modern', section: section -%}
      {%- when 'classic' -%}
        {%- render 'footer-classic', section: section -%}
    {%- endcase -%}
  </div>
</footer>
</div>

<script>
(function() {
  const footerWrapper = document.querySelector('[data-footer-wrapper]');
  const footer = document.querySelector('[data-footer-section]');
  const footerContent = document.querySelector('[data-footer-content]');
  if (!footer) return;

  {% if section.settings.enable_reveal_effect %}
  let footerScrollTrigger = null;

  function updateFooterHeight() {
    if (footerWrapper) {
      const footerHeight = footerWrapper.offsetHeight;
      document.documentElement.style.setProperty('--footer-height', `${footerHeight}px`);
    }
  }

  function initFooterReveal() {
    const _gsap = window.pieces?.gsap || window.gsap;
    const _ScrollTrigger = window.pieces?.ScrollTrigger || window.ScrollTrigger;

    if (!_gsap || !_ScrollTrigger) return;
    if (!footerContent || !footerWrapper) return;

    // Get fresh reference to site-content (it changes after Swup navigation)
    const siteContent = document.querySelector('.site-content');
    if (!siteContent) return;

    _gsap.registerPlugin(_ScrollTrigger);

    // Kill any existing footer ScrollTrigger
    if (footerScrollTrigger) {
      footerScrollTrigger.kill();
      footerScrollTrigger = null;
    }

    // Kill any orphaned ScrollTriggers that might be targeting old site-content elements
    _ScrollTrigger.getAll().forEach(st => {
      // Check if this ScrollTrigger is for the footer reveal
      if (st.vars?.trigger?.classList?.contains('site-content') || st.trigger?.classList?.contains('site-content')) {
        st.kill();
      }
    });

    // Clear any existing GSAP properties
    _gsap.set(footerContent, { clearProps: 'all' });

    // Remove and re-add has-reveal class
    footerContent.classList.remove('has-reveal');
    footerContent.classList.add('has-reveal');

    // Set initial state
    _gsap.set(footerContent, { y: 40, opacity: 0 });

    // Update footer height before creating ScrollTrigger
    updateFooterHeight();

    const tween = _gsap.to(footerContent, {
      y: 0,
      opacity: 1,
      ease: 'none',
      scrollTrigger: {
        trigger: siteContent,
        start: 'bottom bottom',
        end: () => `bottom+=${footerWrapper.offsetHeight} bottom`,
        scrub: true,
        invalidateOnRefresh: true
      }
    });

    footerScrollTrigger = tween.scrollTrigger;

    // Refresh ScrollTrigger to recalculate positions after a brief delay
    // This ensures the DOM has fully settled
    requestAnimationFrame(() => {
      _ScrollTrigger.refresh();
    });
  }

  function waitForGsapAndFonts(callback) {
    if (window.pieces?.gsap && window.pieces?.ScrollTrigger) {
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(callback);
      } else {
        callback();
      }
    } else if (window.gsap && window.ScrollTrigger) {
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(callback);
      } else {
        callback();
      }
    } else {
      setTimeout(() => waitForGsapAndFonts(callback), 100);
    }
  }

  // Initial setup (only runs once)
  if (!footer.dataset.footerInitialized) {
    footer.dataset.footerInitialized = 'true';
    updateFooterHeight();
    // Debounced resize handler
    let footerResizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(footerResizeTimeout);
      footerResizeTimeout = setTimeout(updateFooterHeight, 150);
    });

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => waitForGsapAndFonts(initFooterReveal));
    } else {
      waitForGsapAndFonts(initFooterReveal);
    }

    // Register Swup callback to reinitialize after page transitions
    if (window.onSwupContentReplaced) {
      window.onSwupContentReplaced('footer-reveal', () => {
        // Wait for DOM and layout to fully settle after Swup navigation
        // Use multiple rAFs and a small delay to ensure content has rendered
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            setTimeout(() => {
              updateFooterHeight();
              initFooterReveal();
            }, 100);
          });
        });
      });
    }

    // Also listen to swup:transitionEnd which fires after all animations complete
    // This is a backup in case onSwupContentReplaced doesn't catch everything
    if (!window._footerTransitionEndRegistered) {
      window._footerTransitionEndRegistered = true;
      window.addEventListener('swup:transitionEnd', () => {
        // Small delay to ensure page content is fully laid out
        setTimeout(() => {
          updateFooterHeight();
          initFooterReveal();
        }, 50);
      });

      // Listen for dynamic content changes (e.g., compare page async content)
      window.addEventListener('content:resize', () => {
        setTimeout(() => {
          updateFooterHeight();
          initFooterReveal();
        }, 100);
      });
    }
  } else {
    // Footer already initialized, just reinitialize the reveal effect
    // This handles the case where the script runs again after Swup
    waitForGsapAndFonts(initFooterReveal);
  }
  {% endif %}

  // Back to top functionality
  const backToTopButtons = footer.querySelectorAll('[data-back-to-top]');
  backToTopButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      if (window.pieces && window.pieces.lenis) {
        window.pieces.lenis.scrollTo(0, { duration: 1.5 });
      } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
  });
})();
</script>

{% schema %}
{
  "name": "t:sections.footer.name",
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.layout"
    },
    {
      "type": "select",
      "id": "footer_design",
      "label": "t:sections.footer.settings.footer_design.label",
      "options": [
        {
          "value": "minimal",
          "label": "t:shared.options.minimal"
        },
        {
          "value": "modern",
          "label": "t:sections.footer.settings.footer_design.options__1.label"
        },
        {
          "value": "classic",
          "label": "t:sections.footer.settings.footer_design.options__2.label"
        }
      ],
      "default": "minimal",
      "info": "t:sections.footer.settings.footer_design.info"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "t:shared.settings.full_width.label"
    },
    {
      "type": "checkbox",
      "id": "enable_reveal_effect",
      "default": true,
      "label": "t:sections.footer.settings.enable_reveal_effect.label",
      "info": "t:sections.footer.settings.enable_reveal_effect.info"
    },
    {
      "type": "select",
      "id": "padding",
      "label": "t:shared.settings.padding.label",
      "info": "t:shared.settings.padding.info",
      "default": "default",
      "options": [
        {
          "value": "default",
          "label": "t:shared.settings.padding.options__2.label"
        },
        {
          "value": "small",
          "label": "t:shared.settings.padding.options__1.label"
        },
        {
          "value": "large",
          "label": "t:shared.settings.padding.options__3.label"
        },
        {
          "value": "none",
          "label": "t:shared.settings.padding.options__0.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-3"
    }
  ],
  "blocks": [
    {
      "type": "brand",
      "name": "t:sections.footer.blocks.brand.name",
      "limit": 1,
      "settings": [
        {
          "type": "image_picker",
          "id": "logo",
          "label": "t:shared.settings.logo.label",
          "info": "t:sections.footer.blocks.brand.settings.logo.info"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "t:shared.settings.text.label",
          "default": "t:sections.footer.blocks.brand.settings.text.default"
        },
        {
          "type": "checkbox",
          "id": "show_social",
          "label": "t:shared.settings.show_social.label",
          "default": true
        }
      ]
    },
    {
      "type": "navigation",
      "name": "t:sections.footer.blocks.navigation.name",
      "settings": [
        {
          "type": "link_list",
          "id": "menu",
          "label": "t:shared.settings.menu.label",
          "default": "t:sections.footer.blocks.navigation.settings.menu.default"
        },
        {
          "type": "checkbox",
          "id": "nav_uppercase",
          "default": false,
          "label": "t:shared.settings.nav_uppercase.label"
        }
      ]
    },
    {
      "type": "menu_column",
      "name": "t:sections.footer.blocks.menu_column.name",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "t:shared.settings.heading.label",
          "default": "t:sections.footer.blocks.menu_column.settings.heading.default"
        },
        {
          "type": "link_list",
          "id": "menu",
          "label": "t:shared.settings.menu.label",
          "default": "t:sections.footer.blocks.menu_column.settings.menu.default"
        }
      ]
    },
    {
      "type": "newsletter",
      "name": "t:sections.footer.blocks.newsletter.name",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "t:shared.settings.heading.label",
          "default": "t:sections.footer.blocks.newsletter.settings.heading.default"
        },
        {
          "type": "text",
          "id": "text",
          "label": "t:shared.settings.text.label",
          "default": "t:sections.footer.blocks.newsletter.settings.text.default"
        }
      ]
    },
    {
      "type": "social",
      "name": "t:sections.footer.blocks.social.name",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "t:sections.footer.blocks.social.settings.paragraph__social.content"
        }
      ]
    },
    {
      "type": "payment",
      "name": "t:sections.footer.blocks.payment.name",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "grayscale",
          "label": "t:shared.settings.grayscale.label",
          "default": false,
          "info": "t:sections.footer.blocks.payment.settings.grayscale.info"
        }
      ]
    },
    {
      "type": "copyright",
      "name": "t:sections.footer.blocks.copyright.name",
      "limit": 1,
      "settings": []
    },
    {
      "type": "back_to_top",
      "name": "t:sections.footer.blocks.back_to_top.name",
      "limit": 1,
      "settings": []
    },
    {
      "type": "text",
      "name": "t:shared.blocks.text",
      "settings": [
        {
          "type": "richtext",
          "id": "text",
          "label": "t:shared.settings.text.label",
          "default": "t:sections.footer.blocks.text.settings.text.default"
        }
      ]
    },
    {
      "type": "spacer",
      "name": "t:sections.footer.blocks.spacer.name",
      "settings": [
        {
          "type": "range",
          "id": "height",
          "min": 10,
          "max": 100,
          "step": 5,
          "unit": "px",
          "label": "t:sections.footer.blocks.spacer.settings.height.label",
          "default": 40
        }
      ]
    },
    {
      "type": "localization",
      "name": "t:sections.footer.blocks.localization.name",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_country",
          "label": "t:sections.footer.blocks.localization.settings.show_country.label",
          "default": true,
          "info": "t:sections.footer.blocks.localization.settings.show_country.info"
        },
        {
          "type": "checkbox",
          "id": "show_language",
          "label": "t:sections.footer.blocks.localization.settings.show_language.label",
          "default": true,
          "info": "t:sections.footer.blocks.localization.settings.show_language.info"
        }
      ]
    },
    {
      "type": "follow_on_shop",
      "name": "t:sections.footer.blocks.follow_on_shop.name",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "t:sections.footer.blocks.follow_on_shop.settings.paragraph__follow.content"
        }
      ]
    }
  ]
}
{% endschema %}
