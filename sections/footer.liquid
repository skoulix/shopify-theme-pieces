{%- comment -%}
  Footer Section - Multiple design options
  Designs: Minimal (centered), Modern (branding + newsletter), Classic (multi-column)
{%- endcomment -%}

{%- liquid
  assign footer_design = section.settings.footer_design | default: 'minimal'
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif
-%}

<style>
  {% if section.settings.enable_reveal_effect %}
  .footer-wrapper { position: fixed; bottom: 0; left: 0; right: 0; z-index: 0; }
  .site-content { position: relative; z-index: 1; background-color: var(--color-background); margin-bottom: var(--footer-height, 0px); }
  {% endif %}
  .footer-section { padding: var(--section-vertical-padding) 0; }
  .footer-section nav a, .footer-section .footer-classic__menu a { color: inherit; opacity: 0.7; transition: opacity 0.3s ease; }
  .footer-section nav a:hover, .footer-section .footer-classic__menu a:hover { opacity: 1; }
  .back-to-top { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; background: none; border: none; color: inherit; padding: 0; }
  .back-to-top-text { position: relative; display: inline-block; overflow: hidden; }
  .back-to-top-text span { display: inline-block; transition: transform 0.3s ease; }
  .back-to-top-text span::after { content: attr(data-hover); position: absolute; left: 0; top: 100%; white-space: nowrap; }
  .back-to-top:hover .back-to-top-text span { transform: translateY(-100%); }
</style>

<div class="footer-wrapper" data-footer-wrapper>
<footer
  class="footer-section overflow-hidden color-{{ section.settings.color_scheme }}"
  data-footer-section
>
  <div class="{{ container_class }} footer-content-{{ section.id }}" data-footer-content>
    {%- case footer_design -%}
      {%- when 'minimal' -%}
        {%- render 'footer-minimal', section: section -%}
      {%- when 'modern' -%}
        {%- render 'footer-modern', section: section -%}
      {%- when 'classic' -%}
        {%- render 'footer-classic', section: section -%}
    {%- endcase -%}
  </div>
</footer>
</div>

<script>
(function() {
  const footerWrapper = document.querySelector('[data-footer-wrapper]');
  const footer = document.querySelector('[data-footer-section]');
  const footerContent = document.querySelector('[data-footer-content]');
  if (!footer || footer.dataset.footerInitialized) return;
  footer.dataset.footerInitialized = 'true';

  {% if section.settings.enable_reveal_effect %}
  let footerScrollTrigger = null;
  let fallbackScrollHandler = null;

  function updateFooterHeight() {
    if (footerWrapper) {
      const footerHeight = footerWrapper.offsetHeight;
      document.documentElement.style.setProperty('--footer-height', `${footerHeight}px`);
    }
  }

  updateFooterHeight();
  window.addEventListener('resize', updateFooterHeight);

  // Fallback scroll handler in case ScrollTrigger fails
  function setupFallbackScroll() {
    if (fallbackScrollHandler) return; // Already set up

    fallbackScrollHandler = () => {
      const siteContent = document.querySelector('.site-content');
      if (!siteContent || !footerContent) return;

      const siteRect = siteContent.getBoundingClientRect();
      const footerHeight = footerWrapper.offsetHeight;
      const viewportHeight = window.innerHeight;

      // Calculate how much of the footer area is visible
      // When site-content bottom enters viewport + footer height zone, start revealing
      const triggerStart = viewportHeight;
      const triggerEnd = viewportHeight - footerHeight;
      const siteBottom = siteRect.bottom;

      if (siteBottom <= triggerEnd) {
        // Fully scrolled past - show footer completely
        footerContent.style.opacity = '1';
        footerContent.style.transform = 'translateY(0)';
      } else if (siteBottom >= triggerStart) {
        // Not yet in trigger zone - hide footer
        footerContent.style.opacity = '0';
        footerContent.style.transform = 'translateY(40px)';
      } else {
        // In the transition zone - interpolate
        const progress = 1 - (siteBottom - triggerEnd) / footerHeight;
        const clampedProgress = Math.max(0, Math.min(1, progress));
        footerContent.style.opacity = clampedProgress.toString();
        footerContent.style.transform = `translateY(${40 * (1 - clampedProgress)}px)`;
      }
    };

    // Use Lenis scroll event if available, otherwise native scroll
    // Note: window.pieces.lenis is the LenisManager, .lenis is the actual Lenis instance
    const lenisInstance = window.pieces?.lenis?.lenis;
    if (lenisInstance && typeof lenisInstance.on === 'function') {
      lenisInstance.on('scroll', fallbackScrollHandler);
    } else {
      window.addEventListener('scroll', fallbackScrollHandler, { passive: true });
    }

    // Initial call
    fallbackScrollHandler();
  }

  function removeFallbackScroll() {
    if (!fallbackScrollHandler) return;

    const lenisInstance = window.pieces?.lenis?.lenis;
    if (lenisInstance && typeof lenisInstance.off === 'function') {
      lenisInstance.off('scroll', fallbackScrollHandler);
    } else {
      window.removeEventListener('scroll', fallbackScrollHandler);
    }
    fallbackScrollHandler = null;
  }

  function initFooterReveal() {
    const _gsap = window.pieces?.gsap || window.gsap;
    const _ScrollTrigger = window.pieces?.ScrollTrigger || window.ScrollTrigger;

    // Remove any existing fallback handler
    removeFallbackScroll();

    // If GSAP/ScrollTrigger not available, use fallback
    if (!_gsap || !_ScrollTrigger) {
      setupFallbackScroll();
      return;
    }

    if (!footerContent || !footerWrapper) return;

    const siteContent = document.querySelector('.site-content');
    if (!siteContent) return;

    _gsap.registerPlugin(_ScrollTrigger);

    // Kill any existing footer ScrollTrigger
    if (footerScrollTrigger) {
      footerScrollTrigger.kill();
      footerScrollTrigger = null;
    }

    // Reset content state before animating
    _gsap.set(footerContent, { clearProps: 'all' });

    // Get footer height for calculations
    const footerHeight = footerWrapper.offsetHeight;

    // Check if page is scrollable - if content is shorter than viewport,
    // show footer immediately (no reveal effect needed)
    const pageHeight = siteContent.offsetHeight;
    const viewportHeight = window.innerHeight;

    if (pageHeight <= viewportHeight) {
      // Page is not scrollable, show footer immediately
      _gsap.set(footerContent, { y: 0, opacity: 1 });
      return;
    }

    // Set initial state - fully hidden
    _gsap.set(footerContent, { y: 40, opacity: 0 });

    const tween = _gsap.to(footerContent, {
      y: 0,
      opacity: 1,
      ease: 'none',
      scrollTrigger: {
        trigger: siteContent,
        start: () => `bottom-=${footerWrapper.offsetHeight} bottom`,
        end: 'bottom bottom',
        scrub: true,
        invalidateOnRefresh: true,
        onUpdate: (self) => {
          // Ensure footer becomes fully visible at end
          if (self.progress >= 0.99) {
            _gsap.set(footerContent, { y: 0, opacity: 1 });
          }
        }
      }
    });

    footerScrollTrigger = tween.scrollTrigger;

    // Force a refresh after a brief delay to ensure page layout is complete
    requestAnimationFrame(() => {
      _ScrollTrigger.refresh();

      // Safety check: if footer is still hidden after 1 second and we've scrolled,
      // fall back to manual scroll handler
      setTimeout(() => {
        const currentProgress = footerScrollTrigger?.progress ?? 0;
        const scrollY = window.scrollY || window.pageYOffset;
        const maxScroll = document.documentElement.scrollHeight - window.innerHeight;

        // If we're scrolled more than 50% but progress is still 0, ScrollTrigger isn't working
        if (scrollY > maxScroll * 0.5 && currentProgress < 0.1) {
          if (footerScrollTrigger) {
            footerScrollTrigger.kill();
            footerScrollTrigger = null;
          }
          setupFallbackScroll();
        }
      }, 1000);
    });
  }

  function waitForGsapAndFonts(callback) {
    if (window.pieces?.gsap && window.pieces?.ScrollTrigger) {
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(callback);
      } else {
        callback();
      }
    } else if (window.gsap && window.ScrollTrigger) {
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(callback);
      } else {
        callback();
      }
    } else {
      setTimeout(() => waitForGsapAndFonts(callback), 100);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => waitForGsapAndFonts(initFooterReveal));
  } else {
    waitForGsapAndFonts(initFooterReveal);
  }

  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('footer-reveal', () => {
      // Double RAF to ensure DOM is fully settled after Swup transition
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          updateFooterHeight();
          waitForGsapAndFonts(initFooterReveal);
        });
      });
    });
  }

  // Also reinitialize after Swup transition completes (backup for timing issues)
  if (!window._footerTransitionEndListener) {
    window._footerTransitionEndListener = true;
    window.addEventListener('swup:transitionEnd', () => {
      // Wait for images to load before calculating page height
      const images = document.querySelectorAll('.site-content img');
      const imagePromises = Array.from(images).map(img => {
        if (img.complete) return Promise.resolve();
        return new Promise(resolve => {
          img.addEventListener('load', resolve, { once: true });
          img.addEventListener('error', resolve, { once: true });
        });
      });

      // Initialize after images load (or timeout after 500ms)
      Promise.race([
        Promise.all(imagePromises),
        new Promise(resolve => setTimeout(resolve, 500))
      ]).then(() => {
        updateFooterHeight();
        initFooterReveal();
      });
    });
  }
  {% endif %}

  // Back to top functionality
  const backToTopButtons = footer.querySelectorAll('[data-back-to-top]');
  backToTopButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      if (window.pieces && window.pieces.lenis) {
        window.pieces.lenis.scrollTo(0, { duration: 1.5 });
      } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
  });
})();
</script>

{% schema %}
{
  "name": "Footer",
  "settings": [
    {
      "type": "header",
      "content": "Design"
    },
    {
      "type": "select",
      "id": "footer_design",
      "label": "Footer design",
      "options": [
        { "value": "minimal", "label": "Minimal" },
        { "value": "modern", "label": "Modern" },
        { "value": "classic", "label": "Classic" }
      ],
      "default": "minimal",
      "info": "Minimal: Centered blocks. Modern: Split layout with newsletter. Classic: Multi-column."
    },
    {
      "type": "checkbox",
      "id": "enable_reveal_effect",
      "default": true,
      "label": "Enable reveal effect",
      "info": "Footer stays fixed at the bottom and is revealed as you scroll past the content"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-3"
    }
  ],
  "blocks": [
    {
      "type": "brand",
      "name": "Brand",
      "limit": 1,
      "settings": [
        {
          "type": "image_picker",
          "id": "logo",
          "label": "Logo",
          "info": "If not set, shop name will be displayed."
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "default": "Your brand tagline or brief description goes here."
        },
        {
          "type": "checkbox",
          "id": "show_social",
          "label": "Show social links",
          "default": true
        }
      ]
    },
    {
      "type": "navigation",
      "name": "Navigation",
      "settings": [
        {
          "type": "link_list",
          "id": "menu",
          "label": "Menu",
          "default": "footer"
        },
        {
          "type": "checkbox",
          "id": "nav_uppercase",
          "default": false,
          "label": "Uppercase navigation"
        }
      ]
    },
    {
      "type": "menu_column",
      "name": "Menu column",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Quick links"
        },
        {
          "type": "link_list",
          "id": "menu",
          "label": "Menu",
          "default": "footer"
        }
      ]
    },
    {
      "type": "newsletter",
      "name": "Newsletter",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Subscribe to our newsletter"
        },
        {
          "type": "text",
          "id": "description",
          "label": "Description",
          "default": "Get the latest updates and offers."
        }
      ]
    },
    {
      "type": "social",
      "name": "Social links",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "Social links can be managed in Theme settings > Social media"
        }
      ]
    },
    {
      "type": "payment",
      "name": "Payment icons",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "grayscale",
          "label": "Grayscale",
          "default": false,
          "info": "Display payment icons in grayscale for a more minimal look"
        }
      ]
    },
    {
      "type": "copyright",
      "name": "Copyright",
      "limit": 1,
      "settings": []
    },
    {
      "type": "back_to_top",
      "name": "Back to top",
      "limit": 1,
      "settings": []
    },
    {
      "type": "text",
      "name": "Text",
      "settings": [
        {
          "type": "richtext",
          "id": "text",
          "label": "Text",
          "default": "<p>Custom footer text</p>"
        }
      ]
    },
    {
      "type": "spacer",
      "name": "Spacer",
      "settings": [
        {
          "type": "range",
          "id": "height",
          "min": 10,
          "max": 100,
          "step": 5,
          "unit": "px",
          "label": "Height",
          "default": 40
        }
      ]
    },
    {
      "type": "localization",
      "name": "Country/Language selector",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_country",
          "label": "Show country selector",
          "default": true,
          "info": "Allows customers to change their currency"
        },
        {
          "type": "checkbox",
          "id": "show_language",
          "label": "Show language selector",
          "default": true,
          "info": "Allows customers to change their language"
        }
      ]
    },
    {
      "type": "follow_on_shop",
      "name": "Follow on Shop",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "Allow customers to follow your shop on the Shop app. [Learn more](https://help.shopify.com/manual/online-store/themes/customizing-themes/follow-on-shop)"
        }
      ]
    }
  ]
}
{% endschema %}
