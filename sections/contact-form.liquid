{%- comment -%}
  Contact Form Section - Large typography header matching collection/page templates
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif

  assign heading = section.settings.title | default: 'Contact'

  case section.settings.text_alignment
    when 'center'
      assign text_align = 'text-center'
      assign form_align = 'mx-auto'
    when 'right'
      assign text_align = 'text-right'
      assign form_align = 'ml-auto'
    else
      assign text_align = 'text-left'
      assign form_align = ''
  endcase
-%}

<style>
  .contact-section-{{ section.id }} {
    --section-bg: {{ section.settings.background_color }};
    --section-text: {{ section.settings.text_color }};
    background-color: var(--section-bg);
    color: var(--section-text);
  }
  .contact-header-title { font-size: calc(clamp(2.5rem, 10vw, 4.5rem) * var(--heading-font-scale, 1)); letter-spacing: -0.03em; line-height: 0.9; }
  @media (min-width: 1024px) { .contact-header-title { font-size: calc(clamp(3.5rem, 7vw, 6rem) * var(--heading-font-scale, 1)); } }
  @media (min-width: 1536px) { .contact-header-title { font-size: calc(clamp(4.5rem, 6vw, 8rem) * var(--heading-font-scale, 1)); } }
  .contact-header-title-line:nth-child(2) { margin-left: clamp(1.5rem, 10vw, 8rem); }
  .contact-header-title-line:nth-child(3) { margin-left: clamp(3rem, 18vw, 14rem); }
  .contact-wrapper.is-loading [data-contact-title] { opacity: 0; }
  html.animations-disabled .contact-wrapper.is-loading [data-contact-title] { opacity: 1; }
  .contact-wrapper.is-loading [data-contact-label] { opacity: 0; transform: translateY(10px); }
  .contact-wrapper.is-loading [data-contact-description] { opacity: 0; }
  html.animations-disabled .contact-wrapper.is-loading [data-contact-label] { opacity: 1; transform: none; }
  html.animations-disabled .contact-wrapper.is-loading [data-contact-description] { opacity: 1; }
  .contact-form-input { transition: border-color 0.3s ease, box-shadow 0.3s ease; }
  .contact-form-input:focus { box-shadow: 0 0 0 2px rgba(var(--color-primary-rgb, 79, 70, 229), 0.1); }
</style>

<section class="contact-section-{{ section.id }} contact-wrapper is-loading py-[--page-vertical-padding]" data-contact-wrapper>
  <header class="mb-12 lg:mb-16 {{ container_class }} {{ text_align }}">
    {% if section.settings.label != blank %}
      <span class="inline-block text-[0.65rem] font-semibold uppercase tracking-[0.2em] opacity-60 mb-4" data-contact-label>{{ section.settings.label }}</span>
    {% endif %}

    {% if heading != blank %}
      <h1 class="contact-header-title font-bold font-heading" data-contact-title>
        {{ heading }}
      </h1>
    {% endif %}

    {% if section.settings.description != blank %}
      <p class="mt-8 max-w-[420px] text-xs uppercase tracking-[0.05em] leading-relaxed text-[--color-text-secondary] {{ form_align }}" data-contact-description{% if section.settings.enable_description_shuffle %} data-shuffle-text data-original-text="{{ section.settings.description | escape }}"{% endif %}>
        {{ section.settings.description }}
      </p>
    {% endif %}
  </header>

  <div class="{{ container_class }}">
    <div class="contact-form max-w-2xl {{ form_align }}">
      {% form 'contact', id: 'ContactForm' %}
        {% if form.posted_successfully? %}
          <div class="mb-8 rounded-[--card-radius] bg-green-50 p-4">
            <div class="flex items-center">
              <i class="ph ph-check-circle text-green-400 text-xl mr-3"></i>
              <p class="text-sm font-medium text-green-800">{{ 'contact.form.success' | t }}</p>
            </div>
          </div>
        {% endif %}

        {% if form.errors %}
          <div class="mb-8 rounded-[--card-radius] bg-red-50 p-4">
            <div class="flex items-center">
              <i class="ph ph-warning text-red-400 text-xl mr-3"></i>
              <p class="text-sm font-medium text-red-800">
                {{ form.errors.translated_fields.email | capitalize }} {{ form.errors.messages.email }}
              </p>
            </div>
          </div>
        {% endif %}

        <div class="grid gap-6 sm:grid-cols-2">
          <div class="contact-form-group" data-tween data-tween-type="fade-up">
            <label for="ContactForm-name" class="block text-xs font-semibold uppercase tracking-[0.1em] text-[--color-text-secondary] mb-2">{{ 'contact.form.name' | t }}</label>
            <input
              type="text"
              id="ContactForm-name"
              name="contact[name]"
              autocomplete="name"
              value="{% if form.name %}{{ form.name }}{% elsif customer %}{{ customer.name }}{% endif %}"
              class="contact-form-input block w-full py-3 px-4 text-[--color-text] bg-[--color-background] border-[length:var(--input-border-width)] border-solid border-[--color-border] rounded-[--input-radius] placeholder:text-[--color-text-secondary] focus:border-[--color-primary] focus:outline-none text-sm"
            >
          </div>

          <div class="contact-form-group" data-tween data-tween-type="fade-up">
            <label for="ContactForm-email" class="block text-xs font-semibold uppercase tracking-[0.1em] text-[--color-text-secondary] mb-2">{{ 'contact.form.email' | t }} *</label>
            <input
              type="email"
              id="ContactForm-email"
              name="contact[email]"
              autocomplete="email"
              required
              value="{% if form.email %}{{ form.email }}{% elsif customer %}{{ customer.email }}{% endif %}"
              class="contact-form-input block w-full py-3 px-4 text-[--color-text] bg-[--color-background] border-[length:var(--input-border-width)] border-solid border-[--color-border] rounded-[--input-radius] placeholder:text-[--color-text-secondary] focus:border-[--color-primary] focus:outline-none text-sm"
            >
          </div>

          <div class="contact-form-group sm:col-span-2" data-intro>
            <label for="ContactForm-phone" class="block text-xs font-semibold uppercase tracking-[0.1em] text-[--color-text-secondary] mb-2">{{ 'contact.form.phone' | t }}</label>
            <input
              type="tel"
              id="ContactForm-phone"
              name="contact[phone]"
              autocomplete="tel"
              value="{% if form.phone %}{{ form.phone }}{% endif %}"
              class="contact-form-input block w-full py-3 px-4 text-[--color-text] bg-[--color-background] border-[length:var(--input-border-width)] border-solid border-[--color-border] rounded-[--input-radius] placeholder:text-[--color-text-secondary] focus:border-[--color-primary] focus:outline-none text-sm"
            >
          </div>

          <div class="contact-form-group sm:col-span-2" data-intro>
            <label for="ContactForm-body" class="block text-xs font-semibold uppercase tracking-[0.1em] text-[--color-text-secondary] mb-2">{{ 'contact.form.message' | t }}</label>
            <textarea
              id="ContactForm-body"
              name="contact[body]"
              rows="5"
              class="contact-form-input block w-full py-3 px-4 text-[--color-text] bg-[--color-background] border-[length:var(--input-border-width)] border-solid border-[--color-border] rounded-[--input-radius] placeholder:text-[--color-text-secondary] focus:border-[--color-primary] focus:outline-none text-sm resize-none"
            >{{ form.body }}</textarea>
          </div>
        </div>

        <div class="contact-form-submit mt-8" data-tween data-tween-type="fade-up">
          <button type="submit" class="btn btn--primary">
            <span>{{ 'contact.form.submit' | t }}</span>
            <i class="ph ph-arrow-right"></i>
          </button>
        </div>
      {% endform %}
    </div>
  </div>
</section>

<script>
(function() {
  const wrapper = document.querySelector('[data-contact-wrapper]');
  if (!wrapper || wrapper.dataset.contactInitialized) return;
  wrapper.dataset.contactInitialized = 'true';

  // If animations disabled, just show content
  if (typeof window.shouldAnimate === 'function' && !window.shouldAnimate()) {
    wrapper.classList.remove('is-loading');
    return;
  }

  function animateIntro() {
    const label = wrapper.querySelector('[data-contact-label]');
    const title = wrapper.querySelector('[data-contact-title]');
    const description = wrapper.querySelector('[data-contact-description]');

    // Get GSAP and SplitText from pieces or window
    let gsap = window.gsap;
    if (!gsap && window.pieces && window.pieces.gsap) {
      gsap = window.pieces.gsap;
    }

    let SplitText = window.SplitText;
    if (!SplitText && window.pieces && window.pieces.SplitText) {
      SplitText = window.pieces.SplitText;
    }

    if (!gsap || !SplitText) {
      requestAnimationFrame(animateIntro);
      return;
    }

    wrapper.classList.remove('is-loading');

    const tl = gsap.timeline();

    // Animate label
    if (label) {
      tl.to(label, {
        y: 0,
        opacity: 1,
        duration: 0.6,
        ease: 'power2.out'
      }, 0);
    }

    // Split title into lines and animate
    if (title) {
      const split = new SplitText(title, { type: 'lines', linesClass: 'contact-header-title-line' });

      // Wrap each line in an overflow-hidden container for the reveal effect
      split.lines.forEach(line => {
        const lineWrapper = document.createElement('div');
        lineWrapper.style.overflow = 'hidden';
        lineWrapper.style.display = 'block';
        line.parentNode.insertBefore(lineWrapper, line);
        lineWrapper.appendChild(line);
      });

      gsap.set(split.lines, { yPercent: 120 });
      tl.to(split.lines, {
        yPercent: 0,
        duration: 1.2,
        ease: 'power4.out',
        stagger: 0.1
      }, 0);
    }

    // Description animation - matches collection page shuffle effect
    if (description) {
      const shouldShuffle = description.hasAttribute('data-shuffle-text');

      if (shouldShuffle) {
        // Use data attribute for original text (survives Swup navigation)
        const originalText = description.dataset.originalText || description.textContent.trim();
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&*';

        // Lock height before animation to prevent layout shifts
        const initialHeight = description.offsetHeight;
        description.style.height = initialHeight + 'px';

        // Start with scrambled text and hidden
        description.textContent = originalText.split('').map(char =>
          char === ' ' ? ' ' : chars[Math.floor(Math.random() * chars.length)]
        ).join('');
        gsap.set(description, { opacity: 0 });

        // Fade in
        tl.to(description, {
          opacity: 1,
          duration: 0.4,
          ease: 'power2.out'
        }, 0.6);

        // Shuffle animation - characters reveal left to right with scrambling
        const shuffleObj = { progress: 0 };
        tl.to(shuffleObj, {
          progress: 1,
          duration: 1.8,
          ease: 'none',
          onUpdate: () => {
            const progress = shuffleObj.progress;
            const revealedCount = Math.floor(progress * originalText.length);

            description.textContent = originalText.split('').map((char, i) => {
              if (char === ' ') return ' ';
              if (i < revealedCount) return char;
              // Keep scrambling unrevealed characters
              return chars[Math.floor(Math.random() * chars.length)];
            }).join('');
          },
          onComplete: () => {
            description.textContent = originalText;
            // Remove fixed height after animation completes
            description.style.height = '';
          }
        }, 0.6);
      } else {
        // Simple fade in without shuffle
        tl.to(description, {
          opacity: 1,
          duration: 0.6,
          ease: 'power2.out'
        }, 0.5);
      }
    }
  }

  if (document.readyState === 'complete') {
    animateIntro();
  } else {
    window.addEventListener('load', animateIntro);
  }

  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('contact_form_animation', () => {
      const newWrapper = document.querySelector('[data-contact-wrapper]');
      if (newWrapper && !newWrapper.dataset.contactInitialized) {
        newWrapper.dataset.contactInitialized = 'true';
        animateIntro();
      }
    });
  }
})();
</script>

{% schema %}
{
  "name": "Contact form",
  "settings": [
    {
      "type": "text",
      "id": "label",
      "label": "Label"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Contact"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Have a question or want to work together? Drop us a message and we'll get back to you as soon as possible."
    },
    {
      "type": "checkbox",
      "id": "enable_description_shuffle",
      "label": "Enable description shuffle effect",
      "default": true,
      "info": "Animate description with text scramble effect on page load"
    },
    {
      "type": "text_alignment",
      "id": "text_alignment",
      "label": "Text alignment",
      "default": "left"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#000000"
    }
  ],
  "presets": [
    {
      "name": "Contact form",
      "category": "Store information"
    }
  ]
}
{% endschema %}
