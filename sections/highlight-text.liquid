{%- comment -%}
  Highlight Text on Scroll Section
  Text highlight effect using GSAP ScrollTrigger + SplitText

  Settings:
  - heading: The heading text to highlight on scroll
  - heading_tag: HTML heading tag (h2-h6)
  - scroll_start: When the animation starts
  - scroll_end: When the animation ends
  - fade_opacity: Opacity of unhighlighted text
  - stagger: Stagger duration between characters
  - color_scheme: Color scheme for the section
{%- endcomment -%}

<style>
  #highlight-text-{{ section.id }} {
    --highlight-text-padding-top: {{ section.settings.padding_top }}px;
    --highlight-text-padding-bottom: {{ section.settings.padding_bottom }}px;
  }
</style>

<div
  id="highlight-text-{{ section.id }}"
  class="highlight-text color-{{ section.settings.color_scheme }}"
  data-section-id="{{ section.id }}"
  data-alignment="{{ section.settings.text_alignment }}">

  <div class="highlight-text__container page-width">
    {% for block in section.blocks %}
      {% case block.type %}
        {% when 'heading' %}
          <{{ block.settings.heading_tag | default: 'h2' }}
            class="highlight-text__heading"
            data-highlight-text
            data-size="{{ block.settings.heading_size | default: 'xl' }}"
            data-highlight-scroll-start="{{ block.settings.scroll_start | default: 'top 90%' }}"
            data-highlight-scroll-end="{{ block.settings.scroll_end | default: 'center 40%' }}"
            data-highlight-fade="{{ block.settings.fade_opacity | default: 0.2 }}"
            data-highlight-stagger="{{ block.settings.stagger | default: 0.1 }}"
            {{ block.shopify_attributes }}>
            {{ block.settings.heading }}
          </{{ block.settings.heading_tag | default: 'h2' }}>

        {% when 'text' %}
          <p class="highlight-text__text" {{ block.shopify_attributes }}>
            {{ block.settings.text }}
          </p>

        {% when 'button' %}
          {% render 'button',
            text: block.settings.button_text,
            url: block.settings.button_link,
            style: block.settings.button_style,
            color: block.settings.button_color,
            size: block.settings.button_size,
            shopify_attributes: block.shopify_attributes
          %}
      {% endcase %}
    {% endfor %}
  </div>
</div>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const section = document.getElementById('highlight-text-' + sectionId);
  if (!section || section.dataset.highlightInitialized) return;
  section.dataset.highlightInitialized = 'true';

  // Skip if animations disabled
  if (typeof window.shouldAnimate === 'function' && !window.shouldAnimate()) return;

  function initHighlightText() {
    // Get GSAP from window.pieces or window
    if (typeof gsap === 'undefined') {
      if (window.pieces && window.pieces.gsap) {
        window.gsap = window.pieces.gsap;
      } else {
        requestAnimationFrame(initHighlightText);
        return;
      }
    }

    // Get ScrollTrigger and SplitText
    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);
    const SplitText = window.SplitText || (window.pieces && window.pieces.SplitText);

    if (!ScrollTrigger || !SplitText) {
      requestAnimationFrame(initHighlightText);
      return;
    }

    gsap.registerPlugin(ScrollTrigger, SplitText);

    // Target only headings within this section
    const headings = section.querySelectorAll('[data-highlight-text]');

    headings.forEach(function(heading) {
      const scrollStart = heading.getAttribute('data-highlight-scroll-start') || 'top 90%';
      const scrollEnd = heading.getAttribute('data-highlight-scroll-end') || 'center 40%';
      const fadedValue = parseFloat(heading.getAttribute('data-highlight-fade')) || 0.2;
      const staggerValue = parseFloat(heading.getAttribute('data-highlight-stagger')) || 0.1;

      new SplitText(heading, {
        type: 'words, chars',
        autoSplit: true,
        onSplit: function(self) {
          const tl = gsap.timeline({
            scrollTrigger: {
              scrub: true,
              trigger: heading,
              start: scrollStart,
              end: scrollEnd
            }
          });

          tl.from(self.chars, {
            autoAlpha: fadedValue,
            stagger: staggerValue,
            ease: 'linear'
          });

          return tl;
        }
      });
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHighlightText);
  } else {
    initHighlightText();
  }
})();
</script>

{% schema %}
{
  "name": "t:sections.highlight_text.name",
  "tag": "section",
  "class": "highlight-text-section",
  "settings": [
    {
      "type": "header",
      "content": "t:shared.headers.layout"
    },
    {
      "type": "text_alignment",
      "id": "text_alignment",
      "label": "t:shared.settings.text_alignment.label",
      "default": "center"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "t:shared.settings.padding_top.label",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 100,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "t:shared.settings.padding_bottom.label",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 100,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "t:shared.headers.colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:shared.settings.color_scheme.label",
      "default": "scheme-1"
    }
  ],
  "blocks": [
    {
      "type": "heading",
      "name": "t:shared.blocks.heading",
      "settings": [
        {
          "type": "textarea",
          "id": "heading",
          "label": "t:shared.settings.heading.label",
          "default": "t:sections.highlight_text.blocks.heading.settings.heading.default"
        },
        {
          "type": "select",
          "id": "heading_tag",
          "label": "t:sections.highlight_text.blocks.heading.settings.heading_tag.label",
          "default": "h2",
          "options": [
            {
              "value": "h2",
              "label": "t:sections.highlight_text.blocks.heading.settings.heading_tag.options__0.label"
            },
            {
              "value": "h3",
              "label": "t:sections.highlight_text.blocks.heading.settings.heading_tag.options__1.label"
            },
            {
              "value": "h4",
              "label": "t:sections.highlight_text.blocks.heading.settings.heading_tag.options__2.label"
            },
            {
              "value": "h5",
              "label": "t:sections.highlight_text.blocks.heading.settings.heading_tag.options__3.label"
            },
            {
              "value": "h6",
              "label": "t:sections.highlight_text.blocks.heading.settings.heading_tag.options__4.label"
            }
          ]
        },
        {
          "type": "select",
          "id": "heading_size",
          "label": "t:sections.highlight_text.blocks.heading.settings.heading_size.label",
          "default": "xl",
          "options": [
            {
              "value": "sm",
              "label": "t:sections.highlight_text.blocks.heading.settings.heading_size.options__0.label"
            },
            {
              "value": "md",
              "label": "t:sections.highlight_text.blocks.heading.settings.heading_size.options__1.label"
            },
            {
              "value": "lg",
              "label": "t:sections.highlight_text.blocks.heading.settings.heading_size.options__2.label"
            },
            {
              "value": "xl",
              "label": "t:sections.highlight_text.blocks.heading.settings.heading_size.options__3.label"
            },
            {
              "value": "2xl",
              "label": "t:sections.highlight_text.blocks.heading.settings.heading_size.options__4.label"
            }
          ]
        },
        {
          "type": "header",
          "content": "t:shared.headers.animation"
        },
        {
          "type": "text",
          "id": "scroll_start",
          "label": "t:shared.settings.scroll_start.label",
          "default": "t:sections.highlight_text.blocks.heading.settings.scroll_start.default",
          "info": "t:sections.highlight_text.blocks.heading.settings.scroll_start.info"
        },
        {
          "type": "text",
          "id": "scroll_end",
          "label": "t:shared.settings.scroll_end.label",
          "default": "t:sections.highlight_text.blocks.heading.settings.scroll_end.default",
          "info": "t:sections.highlight_text.blocks.heading.settings.scroll_end.info"
        },
        {
          "type": "range",
          "id": "fade_opacity",
          "label": "t:sections.highlight_text.blocks.heading.settings.fade_opacity.label",
          "min": 0.1,
          "max": 0.9,
          "step": 0.1,
          "default": 0.2,
          "info": "t:sections.highlight_text.blocks.heading.settings.fade_opacity.info"
        },
        {
          "type": "range",
          "id": "stagger",
          "label": "t:sections.highlight_text.blocks.heading.settings.stagger.label",
          "min": 0.1,
          "max": 1,
          "step": 0.1,
          "default": 0.1,
          "info": "t:sections.highlight_text.blocks.heading.settings.stagger.info"
        }
      ]
    },
    {
      "type": "text",
      "name": "t:shared.blocks.text",
      "settings": [
        {
          "type": "textarea",
          "id": "text",
          "label": "t:shared.settings.text.label",
          "default": "t:sections.highlight_text.blocks.text.settings.text.default"
        }
      ]
    },
    {
      "type": "button",
      "name": "t:shared.blocks.button",
      "settings": [
        {
          "type": "text",
          "id": "button_text",
          "label": "t:shared.settings.button_text.label",
          "default": "t:shared.defaults.learn_more"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "t:shared.settings.button_link.label"
        },
        {
          "type": "select",
          "id": "button_style",
          "label": "t:shared.settings.button_style.label",
          "default": "solid",
          "options": [
            {
              "value": "solid",
              "label": "t:shared.settings.button_style.options__0.label"
            },
            {
              "value": "outline",
              "label": "t:shared.settings.button_style.options__1.label"
            }
          ]
        },
        {
          "type": "select",
          "id": "button_color",
          "label": "t:shared.settings.button_color.label",
          "default": "primary",
          "options": [
            {
              "value": "primary",
              "label": "t:shared.settings.button_color.options__0.label"
            },
            {
              "value": "secondary",
              "label": "t:shared.settings.button_color.options__1.label"
            }
          ]
        },
        {
          "type": "select",
          "id": "button_size",
          "label": "t:shared.settings.button_size.label",
          "default": "default",
          "options": [
            {
              "value": "small",
              "label": "t:shared.settings.button_size.options__0.label"
            },
            {
              "value": "default",
              "label": "t:shared.settings.button_size.options__1.label"
            },
            {
              "value": "large",
              "label": "t:shared.settings.button_size.options__2.label"
            }
          ]
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "t:sections.highlight_text.presets.highlight_text.name",
      "category": "t:sections.highlight_text.presets.highlight_text.category",
      "blocks": [
        {
          "type": "heading",
          "settings": {
            "heading": "t:sections.highlight_text.presets.highlight_text.blocks.heading.0.heading",
            "heading_size": "t:sections.highlight_text.presets.highlight_text.blocks.heading.0.heading_size"
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": [
      "header",
      "footer"
    ]
  }
}
{% endschema %}
