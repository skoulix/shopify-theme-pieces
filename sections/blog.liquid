{%- comment -%}
  Blog Section - Grid with Split Text Reveal Animations
{%- endcomment -%}

<style>
  /* Content Grid - CSS Grid with custom properties */
  .blog-grid {
    display: grid;
    grid-template-columns: repeat(var(--columns-mobile, 1), 1fr);
    gap: 2rem;
  }

  @media (min-width: 640px) {
    .blog-grid {
      grid-template-columns: repeat(var(--columns-tablet, 2), 1fr);
    }
  }

  @media (min-width: 1024px) {
    .blog-grid {
      grid-template-columns: repeat(var(--columns-desktop, 3), 1fr);
    }
  }

  /* Loading state - initial hidden state for reveal */
  .blog-wrapper.is-loading .blog-item__imgwrap {
    clip-path: inset(0 100% 0 0);
  }

  /* Transitioning state */
  .blog-wrapper.is-transitioning {
    pointer-events: none;
  }
</style>

<section class="blog-wrapper is-loading min-h-screen bg-white" data-blog-wrapper style="--columns-desktop: 3; --columns-tablet: 2; --columns-mobile: 1;">
  <div class="max-w-7xl mx-auto px-4 md:px-8 pt-16 pb-8">
    <h1 class="blog-header__title text-4xl md:text-5xl lg:text-6xl font-bold uppercase tracking-tight">
      {%- assign title_words = blog.title | split: ' ' -%}
      {%- for word in title_words -%}
        <span class="overflow-hidden inline-block"><span class="inline-block">{{ word }}</span></span>{% unless forloop.last %} {% endunless %}
      {%- endfor -%}
    </h1>
  </div>

  {% paginate blog.articles by 9 %}
    <div class="blog-grid max-w-7xl mx-auto px-4 md:px-8 pb-16" data-blog-grid>
      {% for article in blog.articles %}
        <article
          class="blog-item cursor-pointer"
          data-blog-item="{{ forloop.index0 }}"
          data-article-url="{{ article.url }}"
        >
          <a href="{{ article.url }}" class="blog-item__imgwrap block relative overflow-hidden aspect-video bg-gray-100 rounded-lg">
            {% if article.image %}
              {{ article.image | image_url: width: 800 | image_tag:
                class: 'w-full h-full object-cover',
                loading: 'lazy'
              }}
            {% else %}
              <div class="w-full h-full flex items-center justify-center bg-gray-100">
                <i class="ph ph-article text-5xl text-gray-300"></i>
              </div>
            {% endif %}
          </a>

          <div class="mt-4">
            <div class="blog-item__date text-xs text-gray-500 overflow-hidden">
              <span class="inline-block">
                <time datetime="{{ article.published_at | date: '%Y-%m-%d' }}">
                  {{ article.published_at | date: '%B %d, %Y' }}
                </time>
              </span>
            </div>

            <h2 class="blog-item__title mt-2 text-lg font-semibold leading-6 text-gray-900">
              {%- assign title_words = article.title | split: ' ' -%}
              {%- for word in title_words -%}
                <span class="overflow-hidden inline-block"><span class="inline-block">{{ word }}</span></span>{% unless forloop.last %} {% endunless %}
              {%- endfor -%}
            </h2>

            <div class="blog-item__excerpt mt-2 text-sm leading-6 text-gray-600 line-clamp-3">
              {%- assign excerpt_words = article.excerpt_or_content | strip_html | truncate: 100 | split: ' ' -%}
              {%- for word in excerpt_words -%}
                <span class="overflow-hidden inline-block"><span class="inline-block">{{ word }}</span></span>{% unless forloop.last %} {% endunless %}
              {%- endfor -%}
            </div>

            <div class="blog-item__link mt-4 overflow-hidden">
              <a href="{{ article.url }}" class="inline-block text-sm font-semibold text-indigo-600 hover:text-indigo-500">
                Read more <span aria-hidden="true">â†’</span>
              </a>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>

    {% if paginate.pages > 1 %}
      <nav class="flex items-center justify-center gap-2 pb-16">
        {% if paginate.previous %}
          <a href="{{ paginate.previous.url }}" class="px-4 py-2 text-sm border border-gray-200 rounded hover:bg-gray-50 transition-colors">
            <i class="ph ph-arrow-left"></i>
          </a>
        {% endif %}

        {% for part in paginate.parts %}
          {% if part.is_link %}
            <a href="{{ part.url }}" class="px-4 py-2 text-sm border border-gray-200 rounded hover:bg-gray-50 transition-colors">{{ part.title }}</a>
          {% else %}
            {% if part.title == paginate.current_page %}
              <span class="px-4 py-2 text-sm bg-black text-white rounded">{{ part.title }}</span>
            {% else %}
              <span class="px-4 py-2 text-sm">{{ part.title }}</span>
            {% endif %}
          {% endif %}
        {% endfor %}

        {% if paginate.next %}
          <a href="{{ paginate.next.url }}" class="px-4 py-2 text-sm border border-gray-200 rounded hover:bg-gray-50 transition-colors">
            <i class="ph ph-arrow-right"></i>
          </a>
        {% endif %}
      </nav>
    {% endif %}
  {% endpaginate %}
</section>

<script>
(function() {
  const wrapper = document.querySelector('[data-blog-wrapper]');
  if (!wrapper) return;
  if (wrapper.dataset.blogInitialized) return;
  wrapper.dataset.blogInitialized = 'true';

  function initBlog() {
    if (typeof gsap === 'undefined') {
      if (window.pieces && window.pieces.gsap) {
        window.gsap = window.pieces.gsap;
      } else {
        setTimeout(initBlog, 100);
        return;
      }
    }

    const blogItems = wrapper.querySelectorAll('[data-blog-item]');
    let isAnimating = false;

    // Intro reveal animation
    function runIntroAnimation() {
      const tl = gsap.timeline({
        onComplete: () => {
          wrapper.classList.remove('is-loading');
        }
      });

      // Split text reveal for header title
      const headerTitleSpans = wrapper.querySelectorAll('.blog-header__title .overflow-hidden span');
      if (headerTitleSpans.length) {
        gsap.set(headerTitleSpans, { yPercent: 100 });
        tl.to(headerTitleSpans, {
          yPercent: 0,
          duration: 1.2,
          ease: 'power4.out',
          stagger: 0.1
        }, 0);
      }

      // Animate each item with stagger
      blogItems.forEach((item, index) => {
        const imgWrap = item.querySelector('.blog-item__imgwrap');
        const dateSpan = item.querySelector('.blog-item__date span');
        const titleSpans = item.querySelectorAll('.blog-item__title .overflow-hidden span');
        const excerptSpans = item.querySelectorAll('.blog-item__excerpt .overflow-hidden span');
        const linkEl = item.querySelector('.blog-item__link a');

        const delay = 0.3 + index * 0.08;

        // Horizontal reveal - clip from left to right
        tl.to(imgWrap, {
          clipPath: 'inset(0 0% 0 0)',
          duration: 0.8,
          ease: 'power3.out'
        }, delay);

        // Split text reveal for date
        if (dateSpan) {
          gsap.set(dateSpan, { yPercent: 100 });
          tl.to(dateSpan, {
            yPercent: 0,
            duration: 0.6,
            ease: 'power4.out'
          }, delay + 0.2);
        }

        // Split text reveal for title words
        if (titleSpans.length) {
          gsap.set(titleSpans, { yPercent: 100 });
          tl.to(titleSpans, {
            yPercent: 0,
            duration: 0.8,
            ease: 'power4.out',
            stagger: 0.05
          }, delay + 0.25);
        }

        // Split text reveal for excerpt words
        if (excerptSpans.length) {
          gsap.set(excerptSpans, { yPercent: 100 });
          tl.to(excerptSpans, {
            yPercent: 0,
            duration: 0.6,
            ease: 'power4.out',
            stagger: 0.01
          }, delay + 0.35);
        }

        // Reveal link
        if (linkEl) {
          gsap.set(linkEl, { yPercent: 100 });
          tl.to(linkEl, {
            yPercent: 0,
            duration: 0.5,
            ease: 'power4.out'
          }, delay + 0.45);
        }
      });
    }

    // Run intro animation
    runIntroAnimation();

    // Navigate to article page with Swup
    function navigateToArticle(url) {
      if (window.pieces && window.pieces.swup && window.pieces.swup.swup) {
        window.pieces.swup.navigateTo(url);
      } else {
        window.location.href = url;
      }
    }

    // Hover effects
    blogItems.forEach((item) => {
      const imgWrap = item.querySelector('.blog-item__imgwrap');
      const img = item.querySelector('.blog-item__imgwrap img');

      item.addEventListener('mouseenter', () => {
        if (isAnimating) return;

        gsap.to(imgWrap, {
          scale: 0.98,
          duration: 0.5,
          ease: 'power2.out'
        });

        if (img) {
          gsap.to(img, {
            scale: 1.08,
            duration: 0.5,
            ease: 'power2.out'
          });
        }
      });

      item.addEventListener('mouseleave', () => {
        if (isAnimating) return;

        gsap.to(imgWrap, {
          scale: 1,
          duration: 0.5,
          ease: 'power2.out'
        });

        if (img) {
          gsap.to(img, {
            scale: 1,
            duration: 0.5,
            ease: 'power2.out'
          });
        }
      });
    });

    // Click handler - animate out then navigate
    function handleItemClick(e, clickedIndex) {
      // Allow link clicks to work normally if not on the card itself
      if (e.target.tagName === 'A') return;

      e.preventDefault();
      if (isAnimating) return;
      isAnimating = true;

      const clickedItem = blogItems[clickedIndex];
      const articleUrl = clickedItem.dataset.articleUrl;

      wrapper.classList.add('is-transitioning');

      const tl = gsap.timeline({
        onComplete: () => {
          navigateToArticle(articleUrl);
        }
      });

      // Animate out header title with split text
      const headerTitleSpans = wrapper.querySelectorAll('.blog-header__title .overflow-hidden span');
      tl.to(headerTitleSpans, {
        yPercent: -100,
        duration: 0.5,
        ease: 'power4.in',
        stagger: 0.02
      }, 0);

      // Animate all items out
      blogItems.forEach((item, index) => {
        const imgWrap = item.querySelector('.blog-item__imgwrap');
        const dateSpan = item.querySelector('.blog-item__date span');
        const titleSpans = item.querySelectorAll('.blog-item__title .overflow-hidden span');
        const excerptSpans = item.querySelectorAll('.blog-item__excerpt .overflow-hidden span');
        const linkEl = item.querySelector('.blog-item__link a');

        // Stagger based on distance from clicked item
        const distance = Math.abs(index - clickedIndex);
        const delay = distance * 0.04;

        // Split text reveal out
        if (dateSpan) {
          tl.to(dateSpan, {
            yPercent: -100,
            duration: 0.3,
            ease: 'power4.in'
          }, delay);
        }

        tl.to(titleSpans, {
          yPercent: -100,
          stagger: 0.02,
          duration: 0.4,
          ease: 'power4.in'
        }, delay);

        tl.to(excerptSpans, {
          yPercent: -100,
          stagger: 0.005,
          duration: 0.3,
          ease: 'power4.in'
        }, delay);

        if (linkEl) {
          tl.to(linkEl, {
            yPercent: -100,
            duration: 0.3,
            ease: 'power4.in'
          }, delay);
        }

        // Horizontal swipe - clip from right to left
        tl.to(imgWrap, {
          clipPath: 'inset(0 0 0 100%)',
          duration: 0.6,
          ease: 'power3.inOut'
        }, delay + 0.05);
      });
    }

    // Attach click handlers
    blogItems.forEach((item, index) => {
      item.addEventListener('click', (e) => handleItemClick(e, index));
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBlog);
  } else {
    initBlog();
  }
})();
</script>

{% schema %}
{
  "name": "Blog",
  "settings": []
}
{% endschema %}
