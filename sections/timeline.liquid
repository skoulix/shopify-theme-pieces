{%- comment -%}
  Timeline Section - Animated vertical timeline for brand story
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture

  capture header_container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture
-%}

<div
  class="timeline-section-wrapper section-padding{% unless section.settings.padding == 'default' %}-{{ section.settings.padding }}{% endunless %} color-{{ section.settings.color_scheme }}"
  data-timeline-section="{{ section.id }}"
>
  {%- comment -%} Header - always contained {%- endcomment -%}
  <div class="{{ header_container_class }}">
    <div class="timeline-header">
      {% render 'section-header',
        label: section.settings.label,
        title: section.settings.title,
        alignment: section.settings.header_alignment,
        group_id: section.id
      %}
    </div>
  </div>

  <div class="{{ container_class }}">
    {%- comment -%} Timeline {%- endcomment -%}
    <div class="timeline-wrapper" data-timeline-wrapper>
      <div class="timeline-line">
        <div class="timeline-line-progress" data-timeline-progress></div>
      </div>

      {% for block in section.blocks %}
        <div
          class="timeline-item{% if forloop.first %} is-active{% endif %}"
          data-timeline-item
          data-tween
          data-tween-type="fade-up"
          {{ block.shopify_attributes }}
        >
          <div class="timeline-dot" data-timeline-dot></div>

          {% if block.settings.year != blank %}
            <div class="timeline-year font-heading">
              {{ block.settings.year }}
            </div>
          {% endif %}

          <div class="timeline-content">
            {% if block.settings.title != blank %}
              <h3 class="timeline-item-title font-heading">
                {{ block.settings.title }}
              </h3>
            {% endif %}

            {% if block.settings.text != blank %}
              <p class="timeline-item-text">
                {{ block.settings.text }}
              </p>
            {% endif %}

            {% if block.settings.image != blank %}
              <div class="timeline-item-image">
                {{ block.settings.image | image_url: width: 600 | image_tag:
                  loading: 'lazy',
                  decoding: 'async',
                  sizes: '300px',
                  widths: '300, 600',
                  alt: block.settings.image.alt | default: block.settings.title | default: section.settings.title
                }}
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
(function() {
  const section = document.querySelector('[data-timeline-section="{{ section.id }}"]');
  if (!section || section.dataset.timelineInitialized) return;
  section.dataset.timelineInitialized = 'true';

  function initTimeline() {
    const ScrollTrigger = window.ScrollTrigger || (window.pieces && window.pieces.ScrollTrigger);

    if (!ScrollTrigger) {
      setTimeout(initTimeline, 50);
      return;
    }

    const items = section.querySelectorAll('[data-timeline-item]');
    const progress = section.querySelector('[data-timeline-progress]');
    const wrapper = section.querySelector('[data-timeline-wrapper]');

    // Progress line animation
    if (progress && wrapper) {
      ScrollTrigger.create({
        trigger: wrapper,
        start: 'top center',
        end: 'bottom center',
        scrub: 0.5,
        onUpdate: (self) => {
          progress.style.height = `${self.progress * 100}%`;
        }
      });
    }

    // Item activation on scroll
    items.forEach((item) => {
      ScrollTrigger.create({
        trigger: item,
        start: 'top center',
        end: 'bottom center',
        onEnter: () => {
          items.forEach(i => i.classList.remove('is-active'));
          item.classList.add('is-active');
        },
        onEnterBack: () => {
          items.forEach(i => i.classList.remove('is-active'));
          item.classList.add('is-active');
        }
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTimeline);
  } else {
    requestAnimationFrame(initTimeline);
  }
})();
</script>

{% schema %}
{
  "name": "Timeline",
  "tag": "section",
  "class": "timeline-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "default": "Our Journey",
      "label": "Label"
    },
    {
      "type": "text",
      "id": "title",
      "default": "How We Got Here",
      "label": "Title"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": false,
      "label": "Full width"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "label": "Header alignment",
      "default": "center"
    },
    {
      "type": "select",
      "id": "padding",
      "label": "Section padding",
      "info": "Default padding is set in global theme settings",
      "default": "default",
      "options": [
        { "value": "default", "label": "Default" },
        { "value": "small", "label": "Small" },
        { "value": "large", "label": "Large" },
        { "value": "none", "label": "None" }
      ]
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-2"
    }
  ],
  "blocks": [
    {
      "type": "milestone",
      "name": "Milestone",
      "settings": [
        {
          "type": "text",
          "id": "year",
          "default": "2020",
          "label": "Year"
        },
        {
          "type": "text",
          "id": "title",
          "default": "Milestone Title",
          "label": "Title"
        },
        {
          "type": "textarea",
          "id": "text",
          "default": "Describe this milestone and what it meant for your brand's journey.",
          "label": "Description"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image (optional)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Timeline",
      "category": "Text & content",
      "blocks": [
        { "type": "milestone", "settings": { "year": "2018", "title": "The Beginning", "text": "Started with a simple idea and a passion for quality products." } },
        { "type": "milestone", "settings": { "year": "2019", "title": "First Collection", "text": "Launched our inaugural product line to overwhelming response." } },
        { "type": "milestone", "settings": { "year": "2021", "title": "Going Global", "text": "Expanded to international markets and grew our community." } },
        { "type": "milestone", "settings": { "year": "2024", "title": "Today", "text": "Continuing to innovate and create products you love." } }
      ]
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
  }
{% endschema %}
