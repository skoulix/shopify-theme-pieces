{%- comment -%}
  Slideshow Section
  Full-width image/video slideshow with text overlays
  Features: autoplay, navigation dots/arrows, parallax effect
{%- endcomment -%}

{%- liquid
  assign section_height = section.settings.section_height
  assign autoplay = section.settings.autoplay
  assign autoplay_speed = section.settings.autoplay_speed
  assign show_arrows = section.settings.show_arrows
  assign show_dots = section.settings.show_dots
  assign parallax = section.settings.parallax
  assign overlay_opacity = section.settings.overlay_opacity
-%}

<style>
  #slideshow-{{ section.id }} {
    --slideshow-height: {{ section_height }}vh;
    --overlay-opacity: {{ overlay_opacity | divided_by: 100.0 }};
  }

  #slideshow-{{ section.id }} .slideshow {
    position: relative;
    height: var(--slideshow-height);
    overflow: hidden;
  }

  #slideshow-{{ section.id }} .slideshow__slide {
    position: absolute;
    inset: 0;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.8s ease, visibility 0.8s ease;
  }

  #slideshow-{{ section.id }} .slideshow__slide.is-active {
    opacity: 1;
    visibility: visible;
    position: relative;
  }

  #slideshow-{{ section.id }} .slideshow__media {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  {% if parallax %}
  #slideshow-{{ section.id }} .slideshow__media {
    height: 120%;
    top: -10%;
  }
  {% endif %}

  #slideshow-{{ section.id }} .slideshow__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, var(--overlay-opacity));
    pointer-events: none;
  }

  #slideshow-{{ section.id }} .slideshow__content {
    position: relative;
    z-index: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 2rem;
  }

  #slideshow-{{ section.id }} .slideshow__text {
    max-width: 42rem;
  }

  /* Navigation arrows */
  #slideshow-{{ section.id }} .slideshow__arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.3s, background 0.3s;
  }

  #slideshow-{{ section.id }} .slideshow:hover .slideshow__arrow {
    opacity: 1;
  }

  #slideshow-{{ section.id }} .slideshow__arrow:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  #slideshow-{{ section.id }} .slideshow__arrow--prev {
    left: 1rem;
  }

  #slideshow-{{ section.id }} .slideshow__arrow--next {
    right: 1rem;
  }

  @media (min-width: 768px) {
    #slideshow-{{ section.id }} .slideshow__arrow--prev {
      left: 2rem;
    }
    #slideshow-{{ section.id }} .slideshow__arrow--next {
      right: 2rem;
    }
  }

  /* Navigation dots */
  #slideshow-{{ section.id }} .slideshow__dots {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    display: flex;
    gap: 0.5rem;
  }

  #slideshow-{{ section.id }} .slideshow__dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.4);
    border: none;
    cursor: pointer;
    transition: background 0.3s, transform 0.3s;
  }

  #slideshow-{{ section.id }} .slideshow__dot.is-active {
    background: white;
    transform: scale(1.25);
  }

  #slideshow-{{ section.id }} .slideshow__dot:hover {
    background: rgba(255, 255, 255, 0.8);
  }

  /* Progress bar for autoplay */
  #slideshow-{{ section.id }} .slideshow__progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: rgba(255, 255, 255, 0.6);
    z-index: 10;
    width: 0;
  }

  #slideshow-{{ section.id }} .slideshow__progress.is-animating {
    animation: slideshow-progress {{ autoplay_speed }}s linear forwards;
  }

  @keyframes slideshow-progress {
    from { width: 0; }
    to { width: 100%; }
  }
</style>

<section id="slideshow-{{ section.id }}" class="slideshow-section" data-slideshow>
  <div class="slideshow" aria-label="{{ 'accessibility.slideshow' | t }}" role="region">
    {%- comment -%} Slides {%- endcomment -%}
    {% for block in section.blocks %}
      {%- liquid
        assign text_position = block.settings.text_position
        assign text_alignment = block.settings.text_alignment
        assign text_color = block.settings.text_color

        case text_position
          when 'top_left'
            assign content_justify = 'justify-start'
            assign content_items = 'items-start'
          when 'top_center'
            assign content_justify = 'justify-start'
            assign content_items = 'items-center'
          when 'top_right'
            assign content_justify = 'justify-start'
            assign content_items = 'items-end'
          when 'middle_left'
            assign content_justify = 'justify-center'
            assign content_items = 'items-start'
          when 'middle_center'
            assign content_justify = 'justify-center'
            assign content_items = 'items-center'
          when 'middle_right'
            assign content_justify = 'justify-center'
            assign content_items = 'items-end'
          when 'bottom_left'
            assign content_justify = 'justify-end'
            assign content_items = 'items-start'
          when 'bottom_center'
            assign content_justify = 'justify-end'
            assign content_items = 'items-center'
          when 'bottom_right'
            assign content_justify = 'justify-end'
            assign content_items = 'items-end'
        endcase
      -%}

      <div
        class="slideshow__slide{% if forloop.first %} is-active{% endif %}"
        data-slide-index="{{ forloop.index0 }}"
        {{ block.shopify_attributes }}
      >
        {%- comment -%} Media (Image or Video) {%- endcomment -%}
        {% if block.settings.video != blank %}
          {{ block.settings.video | video_tag:
            class: 'slideshow__media',
            autoplay: true,
            muted: true,
            loop: true,
            playsinline: true,
            poster: block.settings.image | image_url: width: 1920
          }}
        {% elsif block.settings.image != blank %}
          <img
            src="{{ block.settings.image | image_url: width: 1920 }}"
            srcset="{{ block.settings.image | image_url: width: 768 }} 768w,
                    {{ block.settings.image | image_url: width: 1200 }} 1200w,
                    {{ block.settings.image | image_url: width: 1920 }} 1920w"
            sizes="100vw"
            alt="{{ block.settings.image.alt | escape }}"
            class="slideshow__media"
            loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
            {% if parallax %}data-parallax-media{% endif %}
          >
        {% else %}
          <div class="slideshow__media bg-gradient-to-br from-gray-800 to-gray-900"></div>
        {% endif %}

        {%- comment -%} Overlay {%- endcomment -%}
        <div class="slideshow__overlay"></div>

        {%- comment -%} Content {%- endcomment -%}
        <div class="slideshow__content page-container {{ content_justify }} {{ content_items }}" style="color: {{ text_color }};">
          <div class="slideshow__text text-{{ text_alignment }}">
            {% if block.settings.subheading != blank %}
              <p class="text-sm uppercase tracking-wider mb-4 opacity-80" data-intro>
                {{ block.settings.subheading }}
              </p>
            {% endif %}

            {% if block.settings.heading != blank %}
              <h2 class="text-4xl sm:text-5xl lg:text-6xl font-bold font-heading mb-6 leading-tight" data-intro>
                {{ block.settings.heading }}
              </h2>
            {% endif %}

            {% if block.settings.text != blank %}
              <p class="text-lg opacity-90 mb-8 max-w-lg {% if text_alignment == 'center' %}mx-auto{% elsif text_alignment == 'right' %}ml-auto{% endif %}" data-intro>
                {{ block.settings.text }}
              </p>
            {% endif %}

            {% if block.settings.button_label != blank %}
              <div data-intro>
                <a
                  href="{{ block.settings.button_link }}"
                  class="btn btn-primary"
                  style="{% if block.settings.button_style == 'outline' %}background: transparent; border-color: currentColor;{% endif %}"
                >
                  <span>{{ block.settings.button_label }}</span>
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}

    {%- comment -%} Navigation Arrows {%- endcomment -%}
    {% if show_arrows and section.blocks.size > 1 %}
      <button type="button" class="slideshow__arrow slideshow__arrow--prev" data-slideshow-prev aria-label="{{ 'accessibility.previous_slide' | t }}">
        <i class="ph ph-caret-left text-xl"></i>
      </button>
      <button type="button" class="slideshow__arrow slideshow__arrow--next" data-slideshow-next aria-label="{{ 'accessibility.next_slide' | t }}">
        <i class="ph ph-caret-right text-xl"></i>
      </button>
    {% endif %}

    {%- comment -%} Navigation Dots {%- endcomment -%}
    {% if show_dots and section.blocks.size > 1 %}
      <div class="slideshow__dots">
        {% for block in section.blocks %}
          <button
            type="button"
            class="slideshow__dot{% if forloop.first %} is-active{% endif %}"
            data-slideshow-dot="{{ forloop.index0 }}"
            aria-label="{{ 'accessibility.go_to_slide' | t: index: forloop.index }}"
          ></button>
        {% endfor %}
      </div>
    {% endif %}

    {%- comment -%} Progress Bar {%- endcomment -%}
    {% if autoplay and section.blocks.size > 1 %}
      <div class="slideshow__progress" data-slideshow-progress></div>
    {% endif %}
  </div>
</section>

{% if section.blocks.size > 1 %}
<script>
  (function() {
    const container = document.querySelector('#slideshow-{{ section.id }}');
    if (!container) return;

    const slides = container.querySelectorAll('[data-slide-index]');
    const dots = container.querySelectorAll('[data-slideshow-dot]');
    const prevBtn = container.querySelector('[data-slideshow-prev]');
    const nextBtn = container.querySelector('[data-slideshow-next]');
    const progress = container.querySelector('[data-slideshow-progress]');
    const parallaxMedia = container.querySelectorAll('[data-parallax-media]');

    let currentSlide = 0;
    let autoplayInterval = null;
    let isPaused = false;
    const autoplay = {{ autoplay }};
    const autoplaySpeed = {{ autoplay_speed }} * 1000;
    const totalSlides = slides.length;

    function showSlide(index, direction = 'next') {
      // Update slides
      slides.forEach((slide, i) => {
        slide.classList.toggle('is-active', i === index);
      });

      // Update dots
      dots.forEach((dot, i) => {
        dot.classList.toggle('is-active', i === index);
      });

      currentSlide = index;

      // Reset and restart progress bar
      if (progress && autoplay) {
        progress.classList.remove('is-animating');
        void progress.offsetWidth; // Force reflow
        progress.classList.add('is-animating');
      }
    }

    function nextSlide() {
      const next = (currentSlide + 1) % totalSlides;
      showSlide(next, 'next');
    }

    function prevSlide() {
      const prev = (currentSlide - 1 + totalSlides) % totalSlides;
      showSlide(prev, 'prev');
    }

    // Event listeners
    if (prevBtn) prevBtn.addEventListener('click', () => { prevSlide(); resetAutoplay(); });
    if (nextBtn) nextBtn.addEventListener('click', () => { nextSlide(); resetAutoplay(); });

    dots.forEach((dot, i) => {
      dot.addEventListener('click', () => {
        showSlide(i);
        resetAutoplay();
      });
    });

    // Touch/swipe support
    let touchStartX = 0;
    let touchEndX = 0;

    container.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    container.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    }, { passive: true });

    function handleSwipe() {
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          nextSlide();
        } else {
          prevSlide();
        }
        resetAutoplay();
      }
    }

    // Autoplay
    function startAutoplay() {
      if (!autoplay || isPaused) return;
      stopAutoplay();
      autoplayInterval = setInterval(nextSlide, autoplaySpeed);
      if (progress) {
        progress.classList.add('is-animating');
      }
    }

    function stopAutoplay() {
      if (autoplayInterval) {
        clearInterval(autoplayInterval);
        autoplayInterval = null;
      }
      if (progress) {
        progress.classList.remove('is-animating');
      }
    }

    function resetAutoplay() {
      stopAutoplay();
      startAutoplay();
    }

    // Pause on hover/focus
    container.addEventListener('mouseenter', () => {
      isPaused = true;
      stopAutoplay();
    });

    container.addEventListener('mouseleave', () => {
      isPaused = false;
      startAutoplay();
    });

    container.addEventListener('focusin', () => {
      isPaused = true;
      stopAutoplay();
    });

    container.addEventListener('focusout', () => {
      isPaused = false;
      startAutoplay();
    });

    // Parallax effect
    {% if parallax %}
    if (parallaxMedia.length > 0) {
      function updateParallax(scrollY) {
        const rect = container.getBoundingClientRect();
        const viewportHeight = window.innerHeight;

        // Only update when visible
        if (rect.bottom < 0 || rect.top > viewportHeight) return;

        const progress = (viewportHeight - rect.top) / (viewportHeight + rect.height);
        const translateY = (progress - 0.5) * 20; // Max 20% movement

        parallaxMedia.forEach(media => {
          media.style.transform = `translateY(${translateY}%)`;
        });
      }

      // Use Lenis if available, otherwise native scroll
      function initParallax() {
        if (window.pieces && window.pieces.lenis && window.pieces.lenis.lenis) {
          window.pieces.lenis.lenis.on('scroll', (e) => {
            updateParallax(e.scroll);
          });
        } else {
          window.addEventListener('scroll', () => {
            requestAnimationFrame(() => updateParallax(window.scrollY));
          }, { passive: true });
        }
      }

      // Wait for Lenis to be ready
      let attempts = 0;
      function tryInitParallax() {
        if (window.pieces && window.pieces.lenis && window.pieces.lenis.lenis) {
          initParallax();
        } else if (attempts < 20) {
          attempts++;
          setTimeout(tryInitParallax, 100);
        } else {
          // Fallback to native scroll
          initParallax();
        }
      }
      tryInitParallax();
    }
    {% endif %}

    // Initialize
    startAutoplay();
    if (progress && autoplay) {
      progress.classList.add('is-animating');
    }
  })();
</script>
{% endif %}

{% schema %}
{
  "name": "Slideshow",
  "tag": "section",
  "class": "slideshow-section-wrapper",
  "settings": [
    {
      "type": "range",
      "id": "section_height",
      "min": 50,
      "max": 100,
      "step": 5,
      "default": 80,
      "unit": "vh",
      "label": "Section height"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "min": 0,
      "max": 80,
      "step": 5,
      "default": 30,
      "unit": "%",
      "label": "Overlay opacity"
    },
    {
      "type": "header",
      "content": "Autoplay"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "default": true,
      "label": "Enable autoplay"
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 3,
      "max": 10,
      "step": 1,
      "default": 5,
      "unit": "s",
      "label": "Autoplay speed"
    },
    {
      "type": "header",
      "content": "Navigation"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "default": true,
      "label": "Show arrows"
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "default": true,
      "label": "Show dots"
    },
    {
      "type": "header",
      "content": "Effects"
    },
    {
      "type": "checkbox",
      "id": "parallax",
      "default": false,
      "label": "Enable parallax effect"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "header",
          "content": "Media"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video",
          "info": "Video will override image if both are set"
        },
        {
          "type": "header",
          "content": "Content"
        },
        {
          "type": "text",
          "id": "subheading",
          "label": "Subheading"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Slide heading"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "Text"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button label",
          "default": "Shop Now"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Button link"
        },
        {
          "type": "select",
          "id": "button_style",
          "label": "Button style",
          "default": "solid",
          "options": [
            { "value": "solid", "label": "Solid" },
            { "value": "outline", "label": "Outline" }
          ]
        },
        {
          "type": "header",
          "content": "Layout"
        },
        {
          "type": "select",
          "id": "text_position",
          "label": "Text position",
          "default": "middle_center",
          "options": [
            { "value": "top_left", "label": "Top left" },
            { "value": "top_center", "label": "Top center" },
            { "value": "top_right", "label": "Top right" },
            { "value": "middle_left", "label": "Middle left" },
            { "value": "middle_center", "label": "Middle center" },
            { "value": "middle_right", "label": "Middle right" },
            { "value": "bottom_left", "label": "Bottom left" },
            { "value": "bottom_center", "label": "Bottom center" },
            { "value": "bottom_right", "label": "Bottom right" }
          ]
        },
        {
          "type": "select",
          "id": "text_alignment",
          "label": "Text alignment",
          "default": "center",
          "options": [
            { "value": "left", "label": "Left" },
            { "value": "center", "label": "Center" },
            { "value": "right", "label": "Right" }
          ]
        },
        {
          "type": "color",
          "id": "text_color",
          "label": "Text color",
          "default": "#ffffff"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Slideshow",
      "blocks": [
        {
          "type": "slide",
          "settings": {
            "heading": "Welcome to our store",
            "text": "Discover our latest collection of premium products",
            "button_label": "Shop Now"
          }
        },
        {
          "type": "slide",
          "settings": {
            "heading": "New arrivals",
            "text": "Check out what's new this season",
            "button_label": "View Collection"
          }
        }
      ]
    }
  ]
}
{% endschema %}
