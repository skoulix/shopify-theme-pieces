{%- comment -%}
  Slideshow Section
  Full-width image/video slideshow with text overlays
  Features: autoplay, navigation dots/arrows, parallax effect, GSAP transitions
{%- endcomment -%}

{%- liquid
  assign section_height = section.settings.section_height
  assign autoplay = section.settings.autoplay
  assign autoplay_speed = section.settings.autoplay_speed
  assign show_arrows = section.settings.show_arrows
  assign show_dots = section.settings.show_dots
  assign parallax = section.settings.parallax
  assign overlay_color = section.settings.overlay_color
  assign overlay_opacity = section.settings.overlay_opacity
  assign overlay_alpha = overlay_opacity | divided_by: 100.0
  assign transition_effect = section.settings.transition_effect
  assign progress_type = section.settings.progress_type
  assign pause_on_hover = section.settings.pause_on_hover
-%}

<style>
  #slideshow-{{ section.id }} {
    --slideshow-height: {{ section_height }}dvh;
  }
  @supports not (height: 1dvh) {
    #slideshow-{{ section.id }} { --slideshow-height: {{ section_height }}vh; }
  }

  /* Base slide states */
  #slideshow-{{ section.id }} .slideshow__slide {
    opacity: 0;
    visibility: hidden;
    z-index: 0;
  }
  #slideshow-{{ section.id }} .slideshow__slide.is-active {
    opacity: 1;
    visibility: visible;
    z-index: 1;
  }

  /* Navigation dots with circular timer */
  #slideshow-{{ section.id }} .slideshow__dot.is-active {
    background: white;
  }
  #slideshow-{{ section.id }} .slideshow__dot-timer {
    transition: opacity 0.3s ease;
  }
  #slideshow-{{ section.id }} .slideshow__dot.is-active + .slideshow__dot-timer {
    opacity: 1 !important;
  }
  #slideshow-{{ section.id }} .slideshow__dot-timer .timer-progress {
    transform: rotate(-90deg);
    transform-origin: 14px 14px;
    stroke-dasharray: 75.4;
    stroke-dashoffset: 75.4;
  }
  #slideshow-{{ section.id }} .slideshow__dot-timer .timer-progress.is-animating {
    animation: dot-timer-{{ section.id }} {{ autoplay_speed }}s linear forwards;
  }
  @keyframes dot-timer-{{ section.id }} {
    from { stroke-dashoffset: 75.4; }
    to { stroke-dashoffset: 0; }
  }
  #slideshow-{{ section.id }} .slideshow__progress.is-animating {
    animation: slideshow-progress-{{ section.id }} {{ autoplay_speed }}s linear forwards;
  }
  @keyframes slideshow-progress-{{ section.id }} {
    from { width: 0; }
    to { width: 100%; }
  }
  @media (min-width: 768px) {
    #slideshow-{{ section.id }} .slideshow__arrow { opacity: 0; }
    #slideshow-{{ section.id }} .slideshow:hover .slideshow__arrow { opacity: 1; }
  }

  {% if parallax %}
  #slideshow-{{ section.id }} .slideshow__media-wrapper { height: 120%; top: -10%; }
  {% endif %}

  /* Initial loading state - hide content until JS animates it */
  #slideshow-{{ section.id }} .slideshow__subheading,
  #slideshow-{{ section.id }} .slideshow__heading,
  #slideshow-{{ section.id }} .slideshow__text,
  #slideshow-{{ section.id }} .slideshow__cta { opacity: 0; }

  /* Per-slide button styles */
  {% for block in section.blocks %}
  {%- assign btn_text_color = block.settings.text_color -%}
  {%- assign btn_contrast_color = btn_text_color | color_brightness | round -%}
  {%- if btn_contrast_color > 128 -%}
    {%- assign btn_solid_text = '#000000' -%}
  {%- else -%}
    {%- assign btn_solid_text = '#ffffff' -%}
  {%- endif -%}
  /* Outline button */
  #slideshow-{{ section.id }} [data-slide-index="{{ forloop.index0 }}"] .slideshow__btn {
    color: {{ btn_text_color }};
    border: var(--button-border-width, 1px) solid {{ btn_text_color }};
    background-color: transparent;
  }
  #slideshow-{{ section.id }} [data-slide-index="{{ forloop.index0 }}"] .slideshow__btn::before { background: {{ btn_text_color }}; }
  #slideshow-{{ section.id }} [data-slide-index="{{ forloop.index0 }}"] .slideshow__btn:hover,
  #slideshow-{{ section.id }} [data-slide-index="{{ forloop.index0 }}"] .slideshow__btn:hover span { color: {{ btn_solid_text }}; }
  /* Solid button - no border */
  #slideshow-{{ section.id }} [data-slide-index="{{ forloop.index0 }}"] .slideshow__btn--solid {
    background-color: {{ btn_text_color }};
    color: {{ btn_solid_text }};
    border: none;
  }
  #slideshow-{{ section.id }} [data-slide-index="{{ forloop.index0 }}"] .slideshow__btn--solid span { color: {{ btn_solid_text }}; }
  #slideshow-{{ section.id }} [data-slide-index="{{ forloop.index0 }}"] .slideshow__btn--solid::before { background: {{ btn_solid_text }}; }
  #slideshow-{{ section.id }} [data-slide-index="{{ forloop.index0 }}"] .slideshow__btn--solid:hover,
  #slideshow-{{ section.id }} [data-slide-index="{{ forloop.index0 }}"] .slideshow__btn--solid:hover span { color: {{ btn_text_color }}; }
  {% endfor %}
</style>

<section id="slideshow-{{ section.id }}" class="slideshow-section" data-slideshow data-transition="{{ transition_effect }}">
  <div class="slideshow relative overflow-hidden h-[--slideshow-height] min-h-[400px]" aria-label="{{ 'accessibility.slideshow' | t }}" role="region">
    {%- comment -%} Slides {%- endcomment -%}
    {% for block in section.blocks %}
      {%- liquid
        assign text_position = block.settings.text_position
        assign text_alignment = block.settings.text_alignment
        assign text_color = block.settings.text_color

        case text_position
          when 'top_left'
            assign content_justify = 'justify-start'
            assign content_items = 'items-start'
          when 'top_center'
            assign content_justify = 'justify-start'
            assign content_items = 'items-center'
          when 'top_right'
            assign content_justify = 'justify-start'
            assign content_items = 'items-end'
          when 'middle_left'
            assign content_justify = 'justify-center'
            assign content_items = 'items-start'
          when 'middle_center'
            assign content_justify = 'justify-center'
            assign content_items = 'items-center'
          when 'middle_right'
            assign content_justify = 'justify-center'
            assign content_items = 'items-end'
          when 'bottom_left'
            assign content_justify = 'justify-end'
            assign content_items = 'items-start'
          when 'bottom_center'
            assign content_justify = 'justify-end'
            assign content_items = 'items-center'
          when 'bottom_right'
            assign content_justify = 'justify-end'
            assign content_items = 'items-end'
        endcase
      -%}

      <div
        class="slideshow__slide absolute inset-0{% if forloop.first %} is-active{% endif %}"
        data-slide-index="{{ forloop.index0 }}"
        {{ block.shopify_attributes }}
      >
        {%- comment -%} Media wrapper with overflow hidden to contain zoom effects {%- endcomment -%}
        <div class="slideshow__media-wrapper absolute inset-0 overflow-hidden">
          {% if block.settings.video != blank %}
            {{ block.settings.video | video_tag:
              class: 'slideshow__media absolute inset-0 w-full h-full object-cover',
              autoplay: true,
              muted: true,
              loop: true,
              playsinline: true,
              poster: block.settings.image
            }}
          {% elsif block.settings.image != blank %}
            {%- assign img_aspect = block.settings.image.aspect_ratio | default: 1.78 -%}
            {%- assign img_height = 1920 | divided_by: img_aspect | round -%}
            <img
              src="{{ block.settings.image | image_url: width: 1920 }}"
              srcset="{{ block.settings.image | image_url: width: 768 }} 768w,
                      {{ block.settings.image | image_url: width: 1200 }} 1200w,
                      {{ block.settings.image | image_url: width: 1920 }} 1920w"
              sizes="100vw"
              alt="{{ block.settings.image.alt | escape }}"
              class="slideshow__media absolute inset-0 w-full h-full object-cover"
              width="1920"
              height="{{ img_height }}"
              loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
              decoding="async"
              {% if parallax %}data-parallax-media{% endif %}
            >
          {% else %}
            <div class="slideshow__media absolute inset-0 w-full h-full bg-gradient-to-br from-gray-800 to-gray-900"></div>
          {% endif %}
        </div>

        {%- comment -%} Overlay {%- endcomment -%}
        <div class="slideshow__overlay absolute inset-0 pointer-events-none" style="background-color: {{ overlay_color | color_modify: 'alpha', overlay_alpha }};"></div>

        {%- comment -%} Content {%- endcomment -%}
        <div class="slideshow__content relative z-[1] h-full flex flex-col p-8 page-container {{ content_justify }} {{ content_items }}" style="color: {{ text_color }};">
          <div class="max-w-[42rem] text-{{ text_alignment }}">
            {% if block.settings.subheading != blank %}
              <p class="slideshow__subheading text-sm uppercase tracking-wider mb-4 opacity-80" data-intro>
                {{ block.settings.subheading }}
              </p>
            {% endif %}

            {% if block.settings.heading != blank %}
              <h2 class="slideshow__heading text-4xl sm:text-5xl lg:text-6xl font-bold font-heading mb-6 leading-tight" data-intro>
                {{ block.settings.heading }}
              </h2>
            {% endif %}

            {% if block.settings.text != blank %}
              <p class="slideshow__text text-lg opacity-90 mb-8 max-w-lg {% if text_alignment == 'center' %}mx-auto{% elsif text_alignment == 'right' %}ml-auto{% endif %}" data-intro>
                {{ block.settings.text }}
              </p>
            {% endif %}

            {% if block.settings.button_label != blank %}
              <div class="slideshow__cta" data-intro>
                <a
                  href="{{ block.settings.button_link }}"
                  class="btn slideshow__btn{% if block.settings.button_style == 'solid' %} slideshow__btn--solid{% endif %}"
                >
                  <span>{{ block.settings.button_label }}</span>
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}

    {%- comment -%} Navigation Arrows {%- endcomment -%}
    {% if show_arrows and section.blocks.size > 1 %}
      <button
        type="button"
        class="slideshow__arrow absolute top-1/2 -translate-y-1/2 left-4 md:left-8 z-10 w-12 h-12 flex items-center justify-center bg-white/10 backdrop-blur-md border border-white/20 rounded-full text-white cursor-pointer transition-all duration-300 hover:bg-white/20"
        data-slideshow-prev
        aria-label="{{ 'accessibility.previous_slide' | t }}"
      >
        <i class="ph ph-caret-left text-xl"></i>
      </button>
      <button
        type="button"
        class="slideshow__arrow absolute top-1/2 -translate-y-1/2 right-4 md:right-8 z-10 w-12 h-12 flex items-center justify-center bg-white/10 backdrop-blur-md border border-white/20 rounded-full text-white cursor-pointer transition-all duration-300 hover:bg-white/20"
        data-slideshow-next
        aria-label="{{ 'accessibility.next_slide' | t }}"
      >
        <i class="ph ph-caret-right text-xl"></i>
      </button>
    {% endif %}

    {%- comment -%} Navigation Dots {%- endcomment -%}
    {% if show_dots and section.blocks.size > 1 %}
      <div class="absolute bottom-8 left-1/2 -translate-x-1/2 z-10 flex items-center gap-5">
        {% for block in section.blocks %}
          <div class="slideshow__dot-wrapper relative">
            <button
              type="button"
              class="slideshow__dot block rounded-full bg-white/40 border-0 cursor-pointer transition-all duration-300 hover:bg-white/80 w-[10px] h-[10px]{% if forloop.first %} is-active{% endif %}"
              data-slideshow-dot="{{ forloop.index0 }}"
              aria-label="{{ 'accessibility.go_to_slide' | t: index: forloop.index }}"
            ></button>
{% if autoplay and progress_type == 'dots' %}
            <div class="slideshow__dot-timer" style="position:absolute;top:-9px;left:-9px;width:28px;height:28px;pointer-events:none;opacity:0;">
              <svg width="28" height="28" viewBox="0 0 28 28" style="display:block;">
                <circle cx="14" cy="14" r="12" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                <circle class="timer-progress" cx="14" cy="14" r="12" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" data-dot-progress/>
              </svg>
            </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {%- comment -%} Progress Bar {%- endcomment -%}
    {% if autoplay and section.blocks.size > 1 and progress_type == 'bar' %}
      <div class="slideshow__progress absolute bottom-0 left-0 h-[3px] bg-white/60 z-10 w-0" data-slideshow-progress></div>
    {% endif %}
  </div>
</section>

<script>
  (function() {
    const container = document.querySelector('#slideshow-{{ section.id }}');
    if (!container || container.dataset.slideshowInitialized) return;
    container.dataset.slideshowInitialized = 'true';

    // Wait for GSAP and SplitText
    function initSlideshow() {
      if (typeof gsap === 'undefined') {
        if (window.pieces && window.pieces.gsap) {
          window.gsap = window.pieces.gsap;
        } else {
          requestAnimationFrame(initSlideshow);
          return;
        }
      }

      // Get SplitText from pieces or window
      let SplitText = window.SplitText;
      if (!SplitText && window.pieces && window.pieces.SplitText) {
        SplitText = window.pieces.SplitText;
      }

      if (!SplitText) {
        requestAnimationFrame(initSlideshow);
        return;
      }

      const slides = container.querySelectorAll('[data-slide-index]');
      const dots = container.querySelectorAll('[data-slideshow-dot]');
      const prevBtn = container.querySelector('[data-slideshow-prev]');
      const nextBtn = container.querySelector('[data-slideshow-next]');
      const progress = container.querySelector('[data-slideshow-progress]');
      const parallaxMedia = container.querySelectorAll('[data-parallax-media]');
      const transition = container.dataset.transition || 'fade';
      const totalSlides = slides.length;

      // Split headings for line-by-line animation
      const headingSplits = new Map();
      slides.forEach(slide => {
        const heading = slide.querySelector('.slideshow__heading');
        if (heading) {
          const split = new SplitText(heading, { type: 'lines', linesClass: 'slideshow__heading-line' });
          // Wrap each line for overflow hidden reveal
          split.lines.forEach(line => {
            const wrapper = document.createElement('div');
            wrapper.style.overflow = 'hidden';
            wrapper.style.display = 'block';
            line.parentNode.insertBefore(wrapper, line);
            wrapper.appendChild(line);
          });
          // Set lines off-screen BEFORE making heading visible
          gsap.set(split.lines, { yPercent: 120 });
          // Now make heading visible (lines are already positioned off-screen)
          heading.style.opacity = 1;
          headingSplits.set(slide, split);
        }
      });

      let currentSlide = 0;
      let autoplayInterval = null;
      let isPaused = false;
      let isAnimating = false;
      const autoplayEnabled = {{ autoplay }};
      const autoplaySpeed = {{ autoplay_speed }} * 1000;

      // Transition configurations
      const transitions = {
        fade: {
          duration: 0.8,
          enter: (slide) => gsap.fromTo(slide, { opacity: 0 }, { opacity: 1, duration: 0.8, ease: 'power2.inOut' }),
          exit: (slide) => gsap.to(slide, { opacity: 0, duration: 0.8, ease: 'power2.inOut' })
        },
        slide: {
          duration: 1.2,
          enter: (slide, dir) => {
            const media = slide.querySelector('.slideshow__media');
            // Slide enters from 100%
            gsap.set(slide, { xPercent: dir === 'next' ? 100 : -100, opacity: 1, visibility: 'visible' });
            // Media is scaled up and offset in opposite direction - creates parallax as it settles
            gsap.set(media, { scale: 1.2, xPercent: dir === 'next' ? -20 : 20 });
            gsap.to(media, { scale: 1, xPercent: 0, duration: 1.4, ease: 'power2.out' });
            return gsap.to(slide, { xPercent: 0, duration: 1.2, ease: 'power3.inOut' });
          },
          exit: (slide, dir) => {
            const media = slide.querySelector('.slideshow__media');
            // Media moves slower than slide, creating depth
            gsap.to(media, { xPercent: dir === 'next' ? 20 : -20, scale: 1.1, duration: 1.2, ease: 'power2.inOut' });
            return gsap.to(slide, { xPercent: dir === 'next' ? -100 : 100, duration: 1.2, ease: 'power3.inOut' });
          }
        },
        'zoom-in': {
          duration: 1.4,
          enter: (slide) => {
            const media = slide.querySelector('.slideshow__media');
            gsap.set(slide, { opacity: 0, visibility: 'visible' });
            gsap.set(media, { scale: 1, transformOrigin: 'center center' });
            // Fade in slide while zooming media
            gsap.to(slide, { opacity: 1, duration: 0.8, ease: 'power2.out' });
            return gsap.to(media, { scale: 1.15, duration: 1.4, ease: 'power2.out' });
          },
          exit: (slide) => {
            const media = slide.querySelector('.slideshow__media');
            // Fade out while continuing zoom slightly
            gsap.to(media, { scale: 1.2, duration: 0.6, ease: 'power2.in' });
            return gsap.to(slide, { opacity: 0, duration: 0.6, ease: 'power2.in' });
          }
        },
        'zoom-out': {
          duration: 1.4,
          enter: (slide) => {
            const media = slide.querySelector('.slideshow__media');
            gsap.set(slide, { opacity: 0, visibility: 'visible' });
            gsap.set(media, { scale: 1.3, transformOrigin: 'center center' });
            // Fade in slide while zooming out media
            gsap.to(slide, { opacity: 1, duration: 0.8, ease: 'power2.out' });
            return gsap.to(media, { scale: 1, duration: 1.4, ease: 'power2.out' });
          },
          exit: (slide) => {
            const media = slide.querySelector('.slideshow__media');
            // Fade out while continuing to zoom out slightly
            gsap.to(media, { scale: 0.95, duration: 0.6, ease: 'power2.in' });
            return gsap.to(slide, { opacity: 0, duration: 0.6, ease: 'power2.in' });
          }
        },
        swipe: {
          duration: 1.2,
          enter: (slide, dir) => {
            const media = slide.querySelector('.slideshow__media');
            // Next: reveal from right (clip left side), Prev: reveal from left (clip right side)
            gsap.set(slide, { clipPath: dir === 'next' ? 'inset(0 0 0 100%)' : 'inset(0 100% 0 0)', opacity: 1, visibility: 'visible' });
            // Media parallax - offset in opposite direction and scale up
            gsap.set(media, { scale: 1.15, xPercent: dir === 'next' ? 15 : -15 });
            gsap.to(media, { scale: 1, xPercent: 0, duration: 1.4, ease: 'power2.out' });
            return gsap.to(slide, { clipPath: 'inset(0 0% 0 0%)', duration: 1.2, ease: 'power4.inOut' });
          },
          exit: (slide, dir) => {
            const media = slide.querySelector('.slideshow__media');
            gsap.to(media, { xPercent: dir === 'next' ? -15 : 15, scale: 1.1, duration: 1.2, ease: 'power2.inOut' });
            return gsap.to(slide, {
              clipPath: dir === 'next' ? 'inset(0 100% 0 0)' : 'inset(0 0 0 100%)',
              duration: 1.2,
              ease: 'power4.inOut'
            });
          }
        }
      };
      // Alias for backwards compatibility
      transitions.reveal = transitions.swipe;

      function animateContent(slide, show = true) {
        const subheading = slide.querySelector('.slideshow__subheading');
        const text = slide.querySelector('.slideshow__text');
        const cta = slide.querySelector('.slideshow__cta');
        const split = headingSplits.get(slide);

        if (show) {
          const tl = gsap.timeline();
          let delay = 0.3;

          // Subheading fade up
          if (subheading) {
            tl.fromTo(subheading, { y: 30, opacity: 0 }, { y: 0, opacity: 1, duration: 0.8, ease: 'power3.out' }, delay);
            delay += 0.1;
          }

          // Heading line-by-line reveal
          if (split && split.lines.length) {
            gsap.set(split.lines, { yPercent: 120 });
            tl.to(split.lines, { yPercent: 0, duration: 1, ease: 'power4.out', stagger: 0.1 }, delay);
            delay += 0.2;
          }

          // Text fade up
          if (text) {
            tl.fromTo(text, { y: 30, opacity: 0 }, { y: 0, opacity: 1, duration: 0.8, ease: 'power3.out' }, delay + 0.3);
          }

          // CTA fade up
          if (cta) {
            tl.fromTo(cta, { y: 20, opacity: 0 }, { y: 0, opacity: 1, duration: 0.6, ease: 'power3.out' }, delay + 0.5);
          }
        } else {
          // Animate out - simpler exit
          const elements = [subheading, text, cta].filter(Boolean);
          if (split && split.lines.length) {
            gsap.to(split.lines, { yPercent: -120, duration: 0.4, ease: 'power2.in' });
          }
          gsap.to(elements, { y: -20, opacity: 0, duration: 0.4, ease: 'power2.in' });
        }
      }

      function showSlide(index, direction = 'next') {
        if (isAnimating || index === currentSlide) return;
        isAnimating = true;

        const prevIndex = currentSlide;
        const prevSlide = slides[prevIndex];
        const nextSlide = slides[index];
        const trans = transitions[transition] || transitions.fade;

        // Animate out content first
        animateContent(prevSlide, false);

        // Setup z-index
        gsap.set(nextSlide, { zIndex: 1, visibility: 'visible' });
        gsap.set(prevSlide, { zIndex: 0 });

        // Run transitions
        const enterAnim = trans.enter(nextSlide, direction);
        trans.exit(prevSlide, direction);

        // Animate in content
        animateContent(nextSlide, true);

        // Update classes after animation
        setTimeout(() => {
          slides.forEach((slide, i) => {
            slide.classList.toggle('is-active', i === index);
            if (i !== index) {
              gsap.set(slide, { clearProps: 'all' });
              const media = slide.querySelector('.slideshow__media');
              if (media) gsap.set(media, { clearProps: 'transform' });
              slide.style.opacity = '0';
              slide.style.visibility = 'hidden';
              slide.style.zIndex = '0';
            }
          });
          gsap.set(nextSlide, { opacity: 1, visibility: 'visible', zIndex: 1 });
          isAnimating = false;
        }, trans.duration * 1000);

        // Update dots and their timers
        dots.forEach((dot, i) => {
          dot.classList.toggle('is-active', i === index);
          // Find timer via parent wrapper
          const wrapper = dot.closest('.slideshow__dot-wrapper');
          const dotProgress = wrapper?.querySelector('[data-dot-progress]');
          if (dotProgress) {
            dotProgress.classList.remove('is-animating');
            if (i === index && autoplayEnabled) {
              void dotProgress.getBoundingClientRect(); // Force reflow
              dotProgress.classList.add('is-animating');
            }
          }
        });
        currentSlide = index;

        // Reset progress bar
        if (progress && autoplayEnabled) {
          progress.classList.remove('is-animating');
          void progress.offsetWidth;
          progress.classList.add('is-animating');
        }

        // Always reset autoplay interval to sync with timer animation
        if (autoplayEnabled && !isPaused) {
          if (autoplayInterval) clearInterval(autoplayInterval);
          autoplayInterval = setInterval(nextSlide, autoplaySpeed);
        }
      }

      function nextSlide() {
        const next = (currentSlide + 1) % totalSlides;
        showSlide(next, 'next');
      }

      function prevSlide() {
        const prev = (currentSlide - 1 + totalSlides) % totalSlides;
        showSlide(prev, 'prev');
      }

      // Event listeners
      if (prevBtn) prevBtn.addEventListener('click', () => { prevSlide(); resetAutoplay(); });
      if (nextBtn) nextBtn.addEventListener('click', () => { nextSlide(); resetAutoplay(); });

      dots.forEach((dot, i) => {
        dot.addEventListener('click', () => {
          const direction = i > currentSlide ? 'next' : 'prev';
          showSlide(i, direction);
          resetAutoplay();
        });
      });

      // Touch/swipe support
      let touchStartX = 0;
      let touchEndX = 0;

      container.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      container.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        const diff = touchStartX - touchEndX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) nextSlide();
          else prevSlide();
          resetAutoplay();
        }
      }, { passive: true });

      // Autoplay
      function startAutoplay() {
        if (!autoplayEnabled || isPaused) return;
        stopAutoplay();
        autoplayInterval = setInterval(nextSlide, autoplaySpeed);
        if (progress) progress.classList.add('is-animating');
      }

      function getActiveDotProgress() {
        const activeDot = dots[currentSlide];
        if (!activeDot) return null;
        // Use parentElement to find the wrapper, then query within it
        const wrapper = activeDot.closest('.slideshow__dot-wrapper');
        if (wrapper) {
          return wrapper.querySelector('[data-dot-progress]');
        }
        return null;
      }

      function stopAutoplay() {
        if (!autoplayInterval) return; // Don't pause if not running
        clearInterval(autoplayInterval);
        autoplayInterval = null;
        if (progress) progress.classList.remove('is-animating');
        // Pause dot timer
        const activeDotProgress = getActiveDotProgress();
        if (activeDotProgress) activeDotProgress.style.animationPlayState = 'paused';
      }

      function resetAutoplay() {
        // Clear the interval without pausing dot timer (showSlide handles dot timer)
        if (autoplayInterval) {
          clearInterval(autoplayInterval);
          autoplayInterval = null;
        }
        // Restart interval
        if (!isPaused && autoplayEnabled) {
          autoplayInterval = setInterval(nextSlide, autoplaySpeed);
        }
      }

      function resumeAutoplay() {
        isPaused = false;
        // Resume dot timer
        const activeDotProgress = getActiveDotProgress();
        if (activeDotProgress) activeDotProgress.style.animationPlayState = 'running';
        startAutoplay();
      }

      {% if pause_on_hover %}
      container.addEventListener('mouseenter', () => { isPaused = true; stopAutoplay(); });
      container.addEventListener('mouseleave', resumeAutoplay);
      container.addEventListener('focusin', () => { isPaused = true; stopAutoplay(); });
      container.addEventListener('focusout', resumeAutoplay);
      {% endif %}

      {% if parallax %}
      // Parallax effect
      if (parallaxMedia.length > 0) {
        function updateParallax() {
          const rect = container.getBoundingClientRect();
          const viewportHeight = window.innerHeight;
          if (rect.bottom < 0 || rect.top > viewportHeight) return;

          const progress = (viewportHeight - rect.top) / (viewportHeight + rect.height);
          const translateY = (progress - 0.5) * 20;
          parallaxMedia.forEach(media => {
            gsap.set(media, { y: `${translateY}%` });
          });
        }

        if (window.pieces && window.pieces.lenis && window.pieces.lenis.lenis) {
          window.pieces.lenis.lenis.on('scroll', updateParallax);
        } else {
          window.addEventListener('scroll', () => requestAnimationFrame(updateParallax), { passive: true });
        }
      }
      {% endif %}

      // Initialize first slide with intro animation
      const firstSlide = slides[0];
      if (firstSlide) {
        // Animate in immediately (content is already hidden by CSS)
        animateContent(firstSlide, true);
      }

      // Initialize first dot timer animation BEFORE starting autoplay
      if (autoplayEnabled) {
        const firstDotProgress = container.querySelector('.slideshow__dot-wrapper [data-dot-progress]');
        if (firstDotProgress) {
          firstDotProgress.classList.add('is-animating');
        }
      }

      startAutoplay();
      if (progress && autoplayEnabled) progress.classList.add('is-animating');
    }

    // Start initialization as early as possible
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSlideshow);
    } else {
      initSlideshow();
    }
  })();
</script>

{% schema %}
{
  "name": "Slideshow",
  "tag": "section",
  "class": "slideshow-section-wrapper",
  "settings": [
    {
      "type": "range",
      "id": "section_height",
      "min": 50,
      "max": 100,
      "step": 5,
      "default": 80,
      "unit": "vh",
      "label": "Section height"
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "Overlay color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "min": 0,
      "max": 80,
      "step": 5,
      "default": 30,
      "unit": "%",
      "label": "Overlay opacity"
    },
    {
      "type": "header",
      "content": "Transition"
    },
    {
      "type": "select",
      "id": "transition_effect",
      "label": "Transition effect",
      "default": "fade",
      "options": [
        { "value": "fade", "label": "Fade" },
        { "value": "zoom-in", "label": "Zoom in" },
        { "value": "zoom-out", "label": "Zoom out" },
        { "value": "slide", "label": "Slide" },
        { "value": "swipe", "label": "Swipe" }
      ]
    },
    {
      "type": "header",
      "content": "Autoplay"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "default": true,
      "label": "Enable autoplay"
    },
    {
      "type": "checkbox",
      "id": "pause_on_hover",
      "default": true,
      "label": "Pause on hover"
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 3,
      "max": 10,
      "step": 1,
      "default": 5,
      "unit": "s",
      "label": "Autoplay speed"
    },
    {
      "type": "select",
      "id": "progress_type",
      "label": "Progress indicator",
      "default": "dots",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "dots", "label": "Circular dot timer" },
        { "value": "bar", "label": "Progress bar" }
      ],
      "info": "Visual indicator for autoplay progress"
    },
    {
      "type": "header",
      "content": "Navigation"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "default": true,
      "label": "Show arrows"
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "default": true,
      "label": "Show dots"
    },
    {
      "type": "header",
      "content": "Effects"
    },
    {
      "type": "checkbox",
      "id": "parallax",
      "default": false,
      "label": "Enable parallax effect"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "header",
          "content": "Media"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video",
          "info": "Video will override image if both are set"
        },
        {
          "type": "header",
          "content": "Content"
        },
        {
          "type": "text",
          "id": "subheading",
          "label": "Subheading"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Slide heading"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "Text"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button label",
          "default": "Shop Now"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Button link"
        },
        {
          "type": "select",
          "id": "button_style",
          "label": "Button style",
          "default": "solid",
          "options": [
            { "value": "solid", "label": "Solid" },
            { "value": "outline", "label": "Outline" }
          ]
        },
        {
          "type": "header",
          "content": "Layout"
        },
        {
          "type": "select",
          "id": "text_position",
          "label": "Text position",
          "default": "middle_center",
          "options": [
            { "value": "top_left", "label": "Top left" },
            { "value": "top_center", "label": "Top center" },
            { "value": "top_right", "label": "Top right" },
            { "value": "middle_left", "label": "Middle left" },
            { "value": "middle_center", "label": "Middle center" },
            { "value": "middle_right", "label": "Middle right" },
            { "value": "bottom_left", "label": "Bottom left" },
            { "value": "bottom_center", "label": "Bottom center" },
            { "value": "bottom_right", "label": "Bottom right" }
          ]
        },
        {
          "type": "text_alignment",
          "id": "text_alignment",
          "label": "Text alignment",
          "default": "center"
        },
        {
          "type": "color",
          "id": "text_color",
          "label": "Text color",
          "default": "#ffffff"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Slideshow",
      "blocks": [
        {
          "type": "slide",
          "settings": {
            "heading": "Welcome to our store",
            "text": "Discover our latest collection of premium products",
            "button_label": "Shop Now"
          }
        },
        {
          "type": "slide",
          "settings": {
            "heading": "New arrivals",
            "text": "Check out what's new this season",
            "button_label": "View Collection"
          }
        }
      ]
    }
  ]
}
{% endschema %}
