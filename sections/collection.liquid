{%- comment -%}
  Collection Section - Grid with Modern Transitions
  Features intro/outro animations and smooth page transitions
{%- endcomment -%}

<style>
  /* Content Grid - CSS Grid with custom properties */
  .collection-grid {
    display: grid;
    grid-template-columns: repeat(var(--columns-mobile, 1), 1fr);
    gap: 2rem;
  }

  @media (min-width: 768px) {
    .collection-grid {
      grid-template-columns: repeat(var(--columns-tablet, 2), 1fr);
    }
  }

  @media (min-width: 1024px) {
    .collection-grid {
      grid-template-columns: repeat(var(--columns-desktop, 3), 1fr);
    }
  }

  /* Loading state - initial hidden state for reveal */
  .collection-wrapper.is-loading .collection-item__imgwrap {
    clip-path: inset(0 100% 0 0);
  }
</style>

<div class="collection-wrapper is-loading min-h-screen bg-white" data-collection-wrapper style="--columns-desktop: {{ section.settings.columns_desktop }}; --columns-tablet: {{ section.settings.columns_tablet }}; --columns-mobile: {{ section.settings.columns_mobile }};">
  {%- comment -%} Header {%- endcomment -%}
  <header class="collection-header max-w-7xl mx-auto pt-16 pb-8 px-4 md:px-8">
    <h1 class="collection-header__title text-4xl md:text-5xl lg:text-6xl font-bold uppercase tracking-tight">
      {%- assign title_words = collection.title | split: ' ' -%}
      {%- for word in title_words -%}
        <span class="overflow-hidden inline-block"><span class="inline-block">{{ word }}</span></span>{% unless forloop.last %} {% endunless %}
      {%- endfor -%}
    </h1>
    {% if collection.description != blank %}
      <div class="collection-header__description mt-4 text-base text-gray-600 max-w-xl">
        {%- assign desc_words = collection.description | strip_html | split: ' ' -%}
        {%- for word in desc_words -%}
          <span class="overflow-hidden inline-block"><span class="inline-block">{{ word }}</span></span>{% unless forloop.last %} {% endunless %}
        {%- endfor -%}
      </div>
    {% endif %}
  </header>

  {%- comment -%} Product Grid {%- endcomment -%}
  <div class="collection-grid max-w-7xl mx-auto px-4 md:px-8 pb-16" data-collection-grid>
    {% paginate collection.products by section.settings.products_per_page %}
      {% for product in collection.products %}
        <article
          class="collection-item cursor-pointer"
          data-collection-item="{{ forloop.index0 }}"
          data-product-url="{{ product.url }}"
        >
          <div class="collection-item__imgwrap relative overflow-hidden aspect-[3/4] bg-gray-100">
            {% if product.featured_image %}
              {{ product.featured_image | image_url: width: 1200 | image_tag:
                class: 'w-full h-full object-cover',
                loading: 'lazy',
                sizes: '(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 33vw',
                widths: '400, 600, 800, 1200',
                alt: product.title
              }}
            {% else %}
              <div class="w-full h-full flex items-center justify-center bg-gray-100">
                <i class="ph ph-image text-5xl text-gray-300"></i>
              </div>
            {% endif %}
          </div>
          <h3 class="collection-item__title mt-3 text-xs md:text-sm font-semibold uppercase tracking-wide">
            {%- assign title_words = product.title | split: ' ' -%}
            {%- for word in title_words -%}
              <span class="overflow-hidden inline-block"><span class="inline-block">{{ word }}</span></span>{% unless forloop.last %} {% endunless %}
            {%- endfor -%}
          </h3>
          <div class="collection-item__meta mt-2 text-sm text-gray-600 overflow-hidden">
            <span class="inline-block">{{ product.price | money }}</span>
          </div>
        </article>
      {% endfor %}

      {% if paginate.pages > 1 %}
        <nav class="flex items-center justify-center gap-2 py-8" style="grid-column: 1 / -1;">
          {% if paginate.previous %}
            <a href="{{ paginate.previous.url }}" data-no-swup class="px-4 py-2 text-sm border border-gray-200 rounded hover:bg-gray-50 transition-colors">
              <i class="ph ph-arrow-left"></i>
            </a>
          {% endif %}

          {% for part in paginate.parts %}
            {% if part.is_link %}
              <a href="{{ part.url }}" data-no-swup class="px-4 py-2 text-sm border border-gray-200 rounded hover:bg-gray-50 transition-colors">{{ part.title }}</a>
            {% else %}
              {% if part.title == paginate.current_page %}
                <span class="px-4 py-2 text-sm bg-black text-white rounded">{{ part.title }}</span>
              {% else %}
                <span class="px-4 py-2 text-sm">{{ part.title }}</span>
              {% endif %}
            {% endif %}
          {% endfor %}

          {% if paginate.next %}
            <a href="{{ paginate.next.url }}" data-no-swup class="px-4 py-2 text-sm border border-gray-200 rounded hover:bg-gray-50 transition-colors">
              <i class="ph ph-arrow-right"></i>
            </a>
          {% endif %}
        </nav>
      {% endif %}
    {% endpaginate %}
  </div>
</div>

<script>
(function() {
  const wrapper = document.querySelector('[data-collection-wrapper]');
  if (!wrapper) return;
  if (wrapper.dataset.collectionInitialized) return;
  wrapper.dataset.collectionInitialized = 'true';

  function initCollection() {
    if (typeof gsap === 'undefined') {
      if (window.pieces && window.pieces.gsap) {
        window.gsap = window.pieces.gsap;
      } else {
        setTimeout(initCollection, 100);
        return;
      }
    }

    const contentItems = wrapper.querySelectorAll('[data-collection-item]');
    let isAnimating = false;

    // Intro reveal animation
    function runIntroAnimation() {
      const tl = gsap.timeline({
        onComplete: () => {
          wrapper.classList.remove('is-loading');
        }
      });

      // Split text reveal for header title
      const headerTitleSpans = wrapper.querySelectorAll('.collection-header__title .overflow-hidden span');
      if (headerTitleSpans.length) {
        gsap.set(headerTitleSpans, { yPercent: 100 });
        tl.to(headerTitleSpans, {
          yPercent: 0,
          duration: 1.2,
          ease: 'power4.out',
          stagger: 0.1
        }, 0);
      }

      // Split text reveal for header description
      const headerDescSpans = wrapper.querySelectorAll('.collection-header__description .overflow-hidden span');
      if (headerDescSpans.length) {
        gsap.set(headerDescSpans, { yPercent: 100 });
        tl.to(headerDescSpans, {
          yPercent: 0,
          duration: 0.8,
          ease: 'power4.out',
          stagger: 0.01
        }, 0.2);
      }

      // Animate each item with stagger
      contentItems.forEach((item, index) => {
        const imgWrap = item.querySelector('.collection-item__imgwrap');
        const titleSpans = item.querySelectorAll('.collection-item__title .overflow-hidden span');
        const priceSpan = item.querySelector('.collection-item__meta span');

        const delay = 0.3 + index * 0.08;

        // Horizontal reveal - clip from left to right
        tl.to(imgWrap, {
          clipPath: 'inset(0 0% 0 0)',
          duration: 0.8,
          ease: 'power3.out'
        }, delay);

        // Split text reveal for title words
        if (titleSpans.length) {
          gsap.set(titleSpans, { yPercent: 100 });
          tl.to(titleSpans, {
            yPercent: 0,
            duration: 0.8,
            ease: 'power4.out',
            stagger: 0.05
          }, delay + 0.2);
        }

        // Split text reveal for price
        if (priceSpan) {
          gsap.set(priceSpan, { yPercent: 100 });
          tl.to(priceSpan, {
            yPercent: 0,
            duration: 0.6,
            ease: 'power4.out'
          }, delay + 0.3);
        }
      });
    }

    // Run intro animation
    runIntroAnimation();

    // Navigate to product page with Swup
    function navigateToProduct(url) {
      if (window.pieces && window.pieces.swup && window.pieces.swup.swup) {
        window.pieces.swup.navigateTo(url);
      } else {
        window.location.href = url;
      }
    }

    // Hover effects - simple and subtle
    contentItems.forEach((item) => {
      const imgWrap = item.querySelector('.collection-item__imgwrap');
      const img = item.querySelector('.collection-item__imgwrap img');

      item.addEventListener('mouseenter', () => {
        if (isAnimating) return;

        gsap.to(imgWrap, {
          scale: 0.98,
          duration: 0.5,
          ease: 'power2.out'
        });

        if (img) {
          gsap.to(img, {
            scale: 1.08,
            duration: 0.5,
            ease: 'power2.out'
          });
        }
      });

      item.addEventListener('mouseleave', () => {
        if (isAnimating) return;

        gsap.to(imgWrap, {
          scale: 1,
          duration: 0.5,
          ease: 'power2.out'
        });

        if (img) {
          gsap.to(img, {
            scale: 1,
            duration: 0.5,
            ease: 'power2.out'
          });
        }
      });
    });

    // Click handler - animate out then navigate
    function handleItemClick(clickedIndex) {
      if (isAnimating) return;
      isAnimating = true;

      const clickedItem = contentItems[clickedIndex];
      const productUrl = clickedItem.dataset.productUrl;

      wrapper.classList.add('is-transitioning');

      // Lock scroll to prevent scrollbar jump during transition
      const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
      document.body.style.setProperty('--scrollbar-width', scrollbarWidth + 'px');

      if (window.pieces && window.pieces.lenis) {
        window.pieces.lenis.stop();
      }
      document.documentElement.classList.add('scroll-locked');

      const tl = gsap.timeline({
        onComplete: () => {
          navigateToProduct(productUrl);
        }
      });

      // Animate out header title with split text
      const headerTitleSpans = wrapper.querySelectorAll('.collection-header__title .overflow-hidden span');
      tl.to(headerTitleSpans, {
        yPercent: -100,
        duration: 0.5,
        ease: 'power4.in',
        stagger: 0.02
      }, 0);

      // Animate out header description with split text
      const headerDescSpans = wrapper.querySelectorAll('.collection-header__description .overflow-hidden span');
      if (headerDescSpans.length) {
        tl.to(headerDescSpans, {
          yPercent: -100,
          duration: 0.4,
          ease: 'power4.in',
          stagger: 0.005
        }, 0);
      }

      // Animate all items out
      contentItems.forEach((item, index) => {
        const imgWrap = item.querySelector('.collection-item__imgwrap');
        const titleSpans = item.querySelectorAll('.collection-item__title .overflow-hidden span');
        const priceSpan = item.querySelector('.collection-item__meta span');

        // Stagger based on distance from clicked item
        const distance = Math.abs(index - clickedIndex);
        const delay = distance * 0.04;

        // Split text reveal out for title words
        tl.to(titleSpans, {
          yPercent: -100,
          stagger: 0.02,
          duration: 0.4,
          ease: 'power4.in'
        }, delay);

        // Split text reveal out for price
        if (priceSpan) {
          tl.to(priceSpan, {
            yPercent: -100,
            duration: 0.3,
            ease: 'power4.in'
          }, delay);
        }

        // Horizontal swipe - clip from right to left
        tl.to(imgWrap, {
          clipPath: 'inset(0 0 0 100%)',
          duration: 0.6,
          ease: 'power3.inOut'
        }, delay + 0.05);
      });
    }

    // Attach click handlers
    contentItems.forEach((item, index) => {
      item.addEventListener('click', () => handleItemClick(index));
    });

    // Cleanup on Swup navigation
    window.addEventListener('swup:contentReplaced', () => {
      isAnimating = false;
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCollection);
  } else {
    initCollection();
  }
})();
</script>

{% schema %}
{
  "name": "Collection",
  "settings": [
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 3,
      "label": "Columns on desktop"
    },
    {
      "type": "range",
      "id": "columns_tablet",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2,
      "label": "Columns on tablet"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Columns on mobile",
      "options": [
        {
          "value": "1",
          "label": "1"
        },
        {
          "value": "2",
          "label": "2"
        }
      ],
      "default": "1"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 4,
      "max": 24,
      "step": 1,
      "default": 12,
      "label": "Products per page"
    }
  ]
}
{% endschema %}
