{%- comment -%}
  Announcement Bar Section
  Displays rotating promotional messages with optional countdown timer
  Features: multiple messages, auto-rotation, dismissible, countdown timer
{%- endcomment -%}

{%- if section.blocks.size > 0 -%}
  {%- liquid
    assign bar_bg = section.settings.background_color
    assign bar_text = section.settings.text_color
    assign bar_height = section.settings.bar_height
    assign rotation_speed = section.settings.rotation_speed
    assign show_arrows = section.settings.show_arrows
    assign dismissible = section.settings.dismissible
  -%}

  <style>
  {%- liquid
    assign bg_color = section.settings.background_color | default: 'transparent'
    assign text_color = section.settings.text_color | default: 'inherit'
  -%}
  #announcement-bar-{{ section.id }} {
      --bar-bg: {{ bar_bg }};
      --bar-text: {{ bar_text }};
      --bar-height: {{ bar_height }}px;
    }

    #announcement-bar-{{ section.id }} .announcement-bar {
      background-color: var(--bar-bg);
      color: var(--bar-text);
      min-height: var(--bar-height);
    }

    #announcement-bar-{{ section.id }} .announcement-bar a {
      color: var(--bar-text);
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    #announcement-bar-{{ section.id }} .announcement-bar a:hover {
      opacity: 0.8;
    }

    #announcement-bar-{{ section.id }} .announcement-bar__slide {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    #announcement-bar-{{ section.id }} .announcement-bar__slide.is-active {
      position: relative;
      opacity: 1;
      visibility: visible;
    }

    #announcement-bar-{{ section.id }} .announcement-bar__countdown {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-left: 0.75rem;
      font-variant-numeric: tabular-nums;
    }

    #announcement-bar-{{ section.id }} .announcement-bar__countdown-unit {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 2rem;
    }

    #announcement-bar-{{ section.id }} .announcement-bar__countdown-value {
      font-weight: 600;
      font-size: 0.875rem;
    }

    #announcement-bar-{{ section.id }} .announcement-bar__countdown-label {
      font-size: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.7;
    }

    #announcement-bar-{{ section.id }} .announcement-bar.is-dismissed {
      display: none;
    }

    /* Arrow buttons */
    #announcement-bar-{{ section.id }} .announcement-bar__arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--bar-text);
      padding: 0.5rem;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s;
      z-index: 1;
    }

    #announcement-bar-{{ section.id }} .announcement-bar__arrow:hover {
      opacity: 1;
    }

    #announcement-bar-{{ section.id }} .announcement-bar__arrow--prev {
      left: 0.5rem;
    }

    #announcement-bar-{{ section.id }} .announcement-bar__arrow--next {
      right: {% if dismissible %}2.5rem{% else %}0.5rem{% endif %};
    }

    /* Close button */
    #announcement-bar-{{ section.id }} .announcement-bar__close {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--bar-text);
      padding: 0.5rem;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    #announcement-bar-{{ section.id }} .announcement-bar__close:hover {
      opacity: 1;
    }
  </style>

  <div id="announcement-bar-{{ section.id }}" data-announcement-bar>
    <div class="announcement-bar relative flex items-center justify-center px-10 py-2 text-center text-sm" role="region" aria-label="Announcement">
      {%- comment -%} Navigation Arrows {%- endcomment -%}
      {% if show_arrows and section.blocks.size > 1 %}
        <button type="button" class="announcement-bar__arrow announcement-bar__arrow--prev" data-announcement-prev aria-label="{{ 'accessibility.previous' | t }}">
          <i class="ph ph-caret-left"></i>
        </button>
        <button type="button" class="announcement-bar__arrow announcement-bar__arrow--next" data-announcement-next aria-label="{{ 'accessibility.next' | t }}">
          <i class="ph ph-caret-right"></i>
        </button>
      {% endif %}

      {%- comment -%} Slides {%- endcomment -%}
      <div class="announcement-bar__slides relative w-full">
        {% for block in section.blocks %}
          <div
            class="announcement-bar__slide{% if forloop.first %} is-active{% endif %}"
            data-announcement-slide="{{ forloop.index0 }}"
            {{ block.shopify_attributes }}
          >
            <div class="flex items-center justify-center flex-wrap gap-x-2">
              {%- comment -%} Icon {%- endcomment -%}
              {% if block.settings.icon != 'none' %}
                <i class="ph ph-{{ block.settings.icon }}"></i>
              {% endif %}

              {%- comment -%} Message {%- endcomment -%}
              {% if block.settings.link != blank %}
                <a href="{{ block.settings.link }}">{{ block.settings.text }}</a>
              {% else %}
                <span>{{ block.settings.text }}</span>
              {% endif %}

              {%- comment -%} Countdown Timer {%- endcomment -%}
              {% if block.settings.show_countdown and block.settings.countdown_date != blank %}
                <div class="announcement-bar__countdown" data-countdown="{{ block.settings.countdown_date | date: '%Y-%m-%dT%H:%M:%S' }}">
                  <div class="announcement-bar__countdown-unit" data-countdown-days>
                    <span class="announcement-bar__countdown-value">00</span>
                    <span class="announcement-bar__countdown-label">Days</span>
                  </div>
                  <span>:</span>
                  <div class="announcement-bar__countdown-unit" data-countdown-hours>
                    <span class="announcement-bar__countdown-value">00</span>
                    <span class="announcement-bar__countdown-label">Hrs</span>
                  </div>
                  <span>:</span>
                  <div class="announcement-bar__countdown-unit" data-countdown-mins>
                    <span class="announcement-bar__countdown-value">00</span>
                    <span class="announcement-bar__countdown-label">Min</span>
                  </div>
                  <span>:</span>
                  <div class="announcement-bar__countdown-unit" data-countdown-secs>
                    <span class="announcement-bar__countdown-value">00</span>
                    <span class="announcement-bar__countdown-label">Sec</span>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      {%- comment -%} Close Button {%- endcomment -%}
      {% if dismissible %}
        <button type="button" class="announcement-bar__close" data-announcement-close aria-label="{{ 'accessibility.close' | t }}">
          <i class="ph ph-x"></i>
        </button>
      {% endif %}
    </div>
  </div>

  <script>
    (function() {
      const container = document.querySelector('#announcement-bar-{{ section.id }}');
      if (!container) return;

      const bar = container.querySelector('.announcement-bar');
      const slides = container.querySelectorAll('[data-announcement-slide]');
      const prevBtn = container.querySelector('[data-announcement-prev]');
      const nextBtn = container.querySelector('[data-announcement-next]');
      const closeBtn = container.querySelector('[data-announcement-close]');
      const countdowns = container.querySelectorAll('[data-countdown]');

      let currentSlide = 0;
      let autoRotateInterval = null;
      const rotationSpeed = {{ rotation_speed }} * 1000;
      const storageKey = 'announcement_dismissed_{{ section.id }}';

      // Check if dismissed
      if (localStorage.getItem(storageKey)) {
        bar.classList.add('is-dismissed');
        return;
      }

      // Slide functions
      function showSlide(index) {
        slides.forEach((slide, i) => {
          slide.classList.toggle('is-active', i === index);
        });
        currentSlide = index;
      }

      function nextSlide() {
        const next = (currentSlide + 1) % slides.length;
        showSlide(next);
      }

      function prevSlide() {
        const prev = (currentSlide - 1 + slides.length) % slides.length;
        showSlide(prev);
      }

      // Auto rotation
      if (slides.length > 1 && rotationSpeed > 0) {
        autoRotateInterval = setInterval(nextSlide, rotationSpeed);

        // Pause on hover
        bar.addEventListener('mouseenter', () => clearInterval(autoRotateInterval));
        bar.addEventListener('mouseleave', () => {
          autoRotateInterval = setInterval(nextSlide, rotationSpeed);
        });
      }

      // Navigation
      if (prevBtn) prevBtn.addEventListener('click', prevSlide);
      if (nextBtn) nextBtn.addEventListener('click', nextSlide);

      // Dismiss
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          bar.classList.add('is-dismissed');
          localStorage.setItem(storageKey, 'true');
          // Dispatch event so header spacer can recalculate height
          window.dispatchEvent(new CustomEvent('announcement:dismissed'));
        });
      }

      // Countdown timers
      countdowns.forEach(countdown => {
        const targetDate = new Date(countdown.dataset.countdown).getTime();

        function updateCountdown() {
          const now = Date.now();
          const diff = targetDate - now;

          if (diff <= 0) {
            countdown.innerHTML = '<span>Expired</span>';
            return;
          }

          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const secs = Math.floor((diff % (1000 * 60)) / 1000);

          const daysEl = countdown.querySelector('[data-countdown-days] .announcement-bar__countdown-value');
          const hoursEl = countdown.querySelector('[data-countdown-hours] .announcement-bar__countdown-value');
          const minsEl = countdown.querySelector('[data-countdown-mins] .announcement-bar__countdown-value');
          const secsEl = countdown.querySelector('[data-countdown-secs] .announcement-bar__countdown-value');

          if (daysEl) daysEl.textContent = String(days).padStart(2, '0');
          if (hoursEl) hoursEl.textContent = String(hours).padStart(2, '0');
          if (minsEl) minsEl.textContent = String(mins).padStart(2, '0');
          if (secsEl) secsEl.textContent = String(secs).padStart(2, '0');
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
      });
    })();
  </script>
{%- endif -%}

{% schema %}
{
  "name": "Announcement bar",
  "tag": "section",
  "class": "announcement-bar-section",
  "settings": [
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      
    },
    {
      "type": "range",
      "id": "bar_height",
      "min": 32,
      "max": 60,
      "step": 4,
      "default": 40,
      "unit": "px",
      "label": "Bar height"
    },
    {
      "type": "range",
      "id": "rotation_speed",
      "min": 0,
      "max": 10,
      "step": 1,
      "default": 5,
      "unit": "s",
      "label": "Auto-rotate speed",
      "info": "Set to 0 to disable auto-rotation"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "default": false,
      "label": "Show navigation arrows"
    },
    {
      "type": "checkbox",
      "id": "dismissible",
      "default": true,
      "label": "Allow dismissal",
      "info": "Shows close button and remembers user preference"
    }
  ],
  "blocks": [
    {
      "type": "message",
      "name": "Message",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "Free shipping on orders over $50"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        },
        {
          "type": "select",
          "id": "icon",
          "label": "Icon",
          "default": "none",
          "options": [
            { "value": "none", "label": "None" },
            { "value": "truck", "label": "Truck (Shipping)" },
            { "value": "tag", "label": "Tag (Sale)" },
            { "value": "gift", "label": "Gift" },
            { "value": "star", "label": "Star" },
            { "value": "sparkle", "label": "Sparkle" },
            { "value": "percent", "label": "Percent" },
            { "value": "lightning", "label": "Lightning" },
            { "value": "heart", "label": "Heart" },
            { "value": "fire", "label": "Fire" },
            { "value": "clock", "label": "Clock" },
            { "value": "calendar", "label": "Calendar" }
          ]
        },
        {
          "type": "header",
          "content": "Countdown timer"
        },
        {
          "type": "checkbox",
          "id": "show_countdown",
          "default": false,
          "label": "Show countdown timer"
        },
        {
          "type": "text",
          "id": "countdown_date",
          "label": "End date and time",
          "info": "Format: YYYY-MM-DD HH:MM (e.g., 2024-12-31 23:59)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Announcement bar",
      "blocks": [
        {
          "type": "message",
          "settings": {
            "text": "Free shipping on orders over $50",
            "icon": "truck"
          }
        },
        {
          "type": "message",
          "settings": {
            "text": "Use code SAVE20 for 20% off",
            "icon": "tag"
          }
        }
      ]
    }
  ]
}
{% endschema %}
