{%- comment -%}
  Recently Viewed Products Section - Carousel showing products from localStorage
  Client-side only - uses RecentlyViewedManager for data
{%- endcomment -%}

{%- liquid
  capture container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture

  capture header_container_class
    render 'container-class', full_width: section.settings.full_width, full_class: 'container-fluid'
  endcapture
-%}

<style>
  .recently-viewed-{{ section.id }} .skeleton-bg {
    background-color: var(--color-text);
    opacity: 0.1;
  }
  /* Hide scrollbar for native scroll-snap track */
  .recently-viewed-{{ section.id }} .recently-viewed-track::-webkit-scrollbar {
    display: none;
  }
  /* Responsive slide widths using CSS variables from section settings */
  .recently-viewed-{{ section.id }} .recently-viewed-slide {
    --gap: 1rem;
    width: calc((100% - (var(--gap) * (var(--slides-mobile) - 1))) / var(--slides-mobile));
  }
  @media (min-width: 768px) {
    .recently-viewed-{{ section.id }} .recently-viewed-slide {
      --gap: 1.5rem;
      width: calc((100% - (var(--gap) * (var(--slides-tablet) - 1))) / var(--slides-tablet));
    }
  }
  @media (min-width: 1024px) {
    .recently-viewed-{{ section.id }} .recently-viewed-slide {
      width: calc((100% - (var(--gap) * (var(--slides-desktop) - 1))) / var(--slides-desktop));
    }
  }
  /* Title line reveal animation (managed by TweenManager) */
  .tween-split-line:nth-child(2) { margin-left: clamp(0.5rem, 4vw, 2rem); }
</style>

{%- liquid
  # Get product card settings
  case settings.product_card_image_ratio
    when 'portrait'
      assign image_ratio_class = 'aspect-[3/4]'
    when 'square'
      assign image_ratio_class = 'aspect-square'
    when 'landscape'
      assign image_ratio_class = 'aspect-[4/3]'
    else
      assign image_ratio_class = 'aspect-[3/4]'
  endcase
-%}
<div
  class="recently-viewed-{{ section.id }} color-{{ section.settings.color_scheme }} section-padding{% unless section.settings.padding == 'default' %}-{{ section.settings.padding }}{% endunless %} overflow-hidden"
  data-recently-viewed
  data-section-id="{{ section.id }}"
  data-current-product-id="{{ product.id }}"
  data-products-to-show="{{ section.settings.products_to_show }}"
  data-show-vendor="{{ settings.show_vendor }}"
  data-image-ratio-class="{{ image_ratio_class }}"
  data-show-sale-badge="{{ settings.show_sale_badge }}"
  data-sale-badge-style="{{ settings.sale_badge_style }}"
  data-show-sold-out-badge="{{ settings.show_sold_out_badge }}"
  data-enable-wishlist="{{ settings.enable_wishlist }}"
  data-enable-compare="{{ settings.enable_compare }}"
  data-enable-quick-view="{{ settings.enable_quick_view }}"
  data-slides-mobile="{{ section.settings.slides_mobile }}"
  data-slides-tablet="{{ section.settings.slides_tablet }}"
  data-slides-desktop="{{ section.settings.slides_desktop }}"
  style="display: none; --slides-mobile: {{ section.settings.slides_mobile }}; --slides-tablet: {{ section.settings.slides_tablet }}; --slides-desktop: {{ section.settings.slides_desktop }};"
>
  {%- comment -%} Header - always contained {%- endcomment -%}
  <div class="{{ header_container_class }}">
    <div class="section-header-spacing">
      {% render 'section-header-nav',
        label: section.settings.label,
        title: section.settings.title,
        description: section.settings.description,
        alignment: section.settings.header_alignment,
        group_id: section.id,
        nav_data_prefix: 'carousel',
        nav_prev_label: 'accessibility.previous_products' | t,
        nav_next_label: 'accessibility.next_products' | t
      %}
    </div>
  </div>

  <div class="{{ container_class }}">
    {%- comment -%} Carousel Container {%- endcomment -%}
    <div class="relative">
      {%- comment -%} Products will be rendered here via JS - Native scroll-snap {%- endcomment -%}
      <div class="recently-viewed-track flex gap-4 md:gap-6 overflow-x-auto items-stretch" data-carousel-track style="scroll-snap-type: x mandatory; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none;">
      </div>

      {%- comment -%} Progress Bar {%- endcomment -%}
      {% if section.settings.show_progress_bar %}
        <div class="h-0.5 bg-current/15 rounded-sm overflow-hidden mt-8" data-carousel-progress>
          <div class="h-full w-0 bg-current transition-[width] duration-400 ease-out" data-carousel-progress-bar></div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function() {
    const section = document.querySelector('[data-recently-viewed][data-section-id="{{ section.id }}"]');
    if (!section) return;

    const STORAGE_KEY = 'pieces_recently_viewed';
    const currentProductId = section.dataset.currentProductId;
    const maxProducts = parseInt(section.dataset.productsToShow, 10) || 8;
    const showVendor = section.dataset.showVendor === 'true';
    const imageRatioClass = section.dataset.imageRatioClass || 'aspect-[3/4]';
    const showSaleBadge = section.dataset.showSaleBadge === 'true';
    const saleBadgeStyle = section.dataset.saleBadgeStyle || 'text';
    const showSoldOutBadge = section.dataset.showSoldOutBadge === 'true';
    const enableWishlist = section.dataset.enableWishlist === 'true';
    const enableCompare = section.dataset.enableCompare === 'true';
    const enableQuickView = section.dataset.enableQuickView === 'true';
    const showActionButtons = enableWishlist || enableCompare || enableQuickView;

    // Slides per view settings from data attributes
    const slidesMobile = parseInt(section.dataset.slidesMobile, 10) || 1;
    const slidesTablet = parseInt(section.dataset.slidesTablet, 10) || 2;
    const slidesDesktop = parseInt(section.dataset.slidesDesktop, 10) || 4;

    const track = section.querySelector('[data-carousel-track]');
    const prevBtn = section.querySelector('[data-carousel-prev]');
    const nextBtn = section.querySelector('[data-carousel-next]');
    const progressBar = section.querySelector('[data-carousel-progress-bar]');
    const progressContainer = section.querySelector('[data-carousel-progress]');
    const nav = section.querySelector('[data-carousel-nav]');

    let totalSlides = 0;
    let isAnimating = false;

    // Get slides per view for current breakpoint
    function getSlidesPerView() {
      const width = window.innerWidth;
      if (width >= 1024) return slidesDesktop;
      if (width >= 768) return slidesTablet;
      return slidesMobile;
    }

    // Get max scroll index
    function getMaxIndex() {
      const slidesPerView = getSlidesPerView();
      return Math.max(0, totalSlides - slidesPerView);
    }

    // Get current slide index based on scroll position
    function getCurrentIndex() {
      if (!track.children.length) return 0;
      const slideWidth = track.children[0].offsetWidth;
      const gap = parseFloat(getComputedStyle(track).gap) || 0;
      return Math.round(track.scrollLeft / (slideWidth + gap));
    }

    // Scroll to specific slide
    function scrollToSlide(index) {
      const slides = track.children;
      if (!slides[index] || isAnimating) return;

      isAnimating = true;
      // Pre-update button states and progress bar for target position (instant feedback)
      const maxIndex = getMaxIndex();
      const slidesPerView = getSlidesPerView();
      if (prevBtn) prevBtn.disabled = index <= 0;
      if (nextBtn) nextBtn.disabled = index >= maxIndex;
      if (progressBar) {
        const progress = maxIndex > 0 ? ((index + slidesPerView) / totalSlides) * 100 : 100;
        progressBar.style.width = `${Math.min(100, progress)}%`;
      }

      const slideWidth = slides[0].offsetWidth;
      const gap = parseFloat(getComputedStyle(track).gap) || 0;
      const targetScroll = index * (slideWidth + gap);

      track.scrollTo({ left: targetScroll, behavior: 'smooth' });
    }

    // Update button states and progress bar
    function updateButtonStates(index) {
      const maxIndex = getMaxIndex();
      const slidesPerView = getSlidesPerView();

      if (prevBtn) prevBtn.disabled = index <= 0;
      if (nextBtn) nextBtn.disabled = index >= maxIndex;

      // Update progress bar
      if (progressBar) {
        const progress = maxIndex > 0 ? ((index + slidesPerView) / totalSlides) * 100 : 100;
        progressBar.style.width = `${Math.min(100, progress)}%`;
      }
    }

    // Update nav and progress bar visibility
    function updateNavVisibility() {
      const slidesPerView = getSlidesPerView();
      const shouldHide = totalSlides <= slidesPerView;

      if (nav) {
        if (shouldHide) {
          nav.classList.add('is-hidden');
        } else {
          nav.classList.remove('is-hidden');
        }
      }

      if (progressContainer) {
        progressContainer.style.display = shouldHide ? 'none' : '';
      }

      updateButtonStates(getCurrentIndex());
    }

    function getProducts() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        const products = stored ? JSON.parse(stored) : [];
        // Filter out current product if on product page
        return products.filter(p => p.id !== currentProductId).slice(0, maxProducts);
      } catch {
        return [];
      }
    }

    function formatMoney(cents) {
      // Handle string input - remove any non-numeric chars except decimal
      if (typeof cents === 'string') {
        cents = cents.replace(/[^\d.-]/g, '');
        // If it has a decimal, it might be dollars - convert to cents
        if (cents.includes('.')) {
          cents = Math.round(parseFloat(cents) * 100);
        } else {
          cents = parseInt(cents, 10);
        }
      }
      cents = cents || 0;

      const moneyFormat = window.themeSettings?.moneyFormat || '${{amount}}';
      const value = cents / 100;
      const amount = value.toFixed(2);
      const amountNoDecimals = Math.floor(value);

      // Format with thousand separators
      const amountFormatted = value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const amountWithComma = value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const amountNoDecimalsWithComma = amountNoDecimals.toLocaleString('de-DE');
      const amountWithApostrophe = value.toLocaleString('de-CH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      return moneyFormat
        .replace(/\{\{\s*amount_with_comma_separator\s*\}\}/g, amountWithComma)
        .replace(/\{\{\s*amount_no_decimals_with_comma_separator\s*\}\}/g, amountNoDecimalsWithComma)
        .replace(/\{\{\s*amount_with_apostrophe_separator\s*\}\}/g, amountWithApostrophe)
        .replace(/\{\{\s*amount_no_decimals\s*\}\}/g, amountNoDecimals.toLocaleString('en-US'))
        .replace(/\{\{\s*amount\s*\}\}/g, amountFormatted);
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function escapeAttr(str) {
      // Escape for use in HTML attributes (especially double-quoted)
      return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function buildProductJsonAttr(product) {
      // Build the data-product-json attribute value as a JSON object
      const data = {
        id: product.id,
        handle: product.handle,
        title: product.title,
        url: product.url,
        image: product.image || '',
        price: product.price,
        compareAtPrice: product.compareAtPrice || 0,
        vendor: product.vendor || '',
        available: product.available !== false
      };
      // Escape for use in single-quoted HTML attribute
      return JSON.stringify(data).replace(/'/g, '&#39;');
    }

    function renderProducts(products) {
      if (products.length === 0) {
        section.style.display = 'none';
        // Trigger ScrollTrigger refresh for footer reveal
        const _ScrollTrigger = window.pieces?.ScrollTrigger || window.ScrollTrigger;
        if (_ScrollTrigger) _ScrollTrigger.refresh();
        return;
      }

      section.style.display = '';

      // Calculate sale percentage
      function getSalePercent(compareAtPrice, price) {
        if (!compareAtPrice || compareAtPrice <= price) return 0;
        return Math.round((compareAtPrice - price) / compareAtPrice * 100);
      }

      track.innerHTML = products.map((product, index) => {
        const hasSale = product.compareAtPrice && product.compareAtPrice > product.price;
        const salePercent = getSalePercent(product.compareAtPrice, product.price);

        return `
        <div class="recently-viewed-slide shrink-0 min-w-0 flex" style="scroll-snap-align: start;">
          <article
            class="product-card group relative flex flex-col no-underline text-inherit rounded-(--card-radius) overflow-hidden h-full w-full border-solid border-(--color-border)"
            style="box-shadow: var(--card-shadow); border-width: var(--card-border-width);"
          >
            <div class="product-card-image relative overflow-hidden ${imageRatioClass}" data-tween data-tween-type="clip-right">
              <a href="${escapeHtml(product.url)}" class="block w-full h-full" aria-label="${escapeHtml(product.title)}">
                ${product.image ? `
                  <img
                    src="${escapeHtml(product.image)}"
                    alt="${escapeHtml(product.title)}"
                    class="w-full h-full object-cover scale-100 transition-transform duration-500 group-hover:scale-105"
                    loading="lazy"
                    decoding="async"
                  >
                ` : `
                  <div class="w-full h-full flex items-center justify-center bg-(--color-background-secondary)">
                    <i class="ph ph-image text-5xl text-(--color-text-secondary) opacity-30" aria-hidden="true"></i>
                  </div>
                `}
              </a>

              <!-- Badges -->
              <div class="absolute top-3 left-3 flex flex-col gap-2 pointer-events-none">
                ${showSaleBadge && hasSale ? `
                  <span class="inline-block px-2 py-1 text-xs font-semibold bg-(--color-sale) text-white rounded">
                    ${saleBadgeStyle === 'percentage' ? `-${salePercent}%` : `{{ 'products.product.on_sale' | t }}`}
                  </span>
                ` : ''}
                ${showSoldOutBadge && !product.available ? `
                  <span class="inline-block px-2 py-1 text-xs font-semibold bg-(--color-text) text-(--color-background) rounded">
                    {{ 'products.product.sold_out' | t }}
                  </span>
                ` : ''}
              </div>

              <!-- Action buttons -->
              ${showActionButtons ? `
                <div class="product-card-actions absolute bottom-3 left-3 right-3 z-10 flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  ${enableQuickView && product.available ? `
                    <button
                      type="button"
                      class="product-card-quick-view w-10 h-10 flex items-center justify-center rounded-full bg-(--color-background) text-(--color-text) shadow-md transform scale-90 group-hover:scale-100 transition-all duration-300 hover:bg-(--color-text) hover:text-(--color-background)"
                      data-quick-view-trigger="${escapeHtml(product.handle)}"
                      aria-label="{{ 'products.product.quick_view' | t | default: 'Quick view' }}: ${escapeHtml(product.title)}"
                    >
                      <i class="ph ph-eye text-lg" aria-hidden="true"></i>
                    </button>
                  ` : ''}
                  ${enableWishlist ? `
                    <button
                      type="button"
                      class="product-card-wishlist w-10 h-10 flex items-center justify-center rounded-full bg-(--color-background) text-(--color-text) shadow-md transform scale-90 group-hover:scale-100 transition-all duration-300 hover:bg-(--color-text) hover:text-(--color-background) [&.is-active]:bg-(--color-sale) [&.is-active]:text-white"
                      data-wishlist-toggle="${product.id}"
                      data-product-json='${buildProductJsonAttr(product)}'
                      aria-label="{{ 'products.wishlist.add_to_wishlist' | t | default: 'Add to wishlist' }}: ${escapeHtml(product.title)}"
                      aria-pressed="false"
                    >
                      <i class="ph ph-heart text-lg" aria-hidden="true"></i>
                    </button>
                  ` : ''}
                  ${enableCompare ? `
                    <button
                      type="button"
                      class="product-card-compare w-10 h-10 flex items-center justify-center rounded-full bg-(--color-background) text-(--color-text) shadow-md transform scale-90 group-hover:scale-100 transition-all duration-300 hover:bg-(--color-text) hover:text-(--color-background) [&.is-active]:bg-(--color-text) [&.is-active]:text-(--color-background)"
                      data-compare-toggle="${product.id}"
                      data-product-json='${buildProductJsonAttr(product)}'
                      aria-label="{{ 'products.compare.add_to_compare' | t | default: 'Add to compare' }}: ${escapeHtml(product.title)}"
                      aria-pressed="false"
                    >
                      <i class="ph ph-scales text-lg" aria-hidden="true"></i>
                    </button>
                  ` : ''}
                </div>
              ` : ''}
            </div>

            <a href="${escapeHtml(product.url)}" class="product-card-content flex-1 p-4 bg-(--color-background) block no-underline" data-tween data-tween-type="fade-up">
              ${showVendor && product.vendor ? `
                <p class="product-card-vendor text-sm text-(--color-text-secondary) uppercase tracking-wide overflow-hidden">
                  <span class="inline-block">${escapeHtml(product.vendor)}</span>
                </p>
              ` : ''}

              <h3 class="product-card-title card-title mt-2">
                ${escapeHtml(product.title)}
              </h3>

              <div class="product-card-price mt-2 text-sm text-(--color-text-secondary)">
                ${hasSale ? `
                  <span class="overflow-hidden inline-block"><span class="inline-block line-through opacity-60 mr-2">${formatMoney(product.compareAtPrice)}</span></span>
                  <span class="overflow-hidden inline-block"><span class="inline-block text-(--color-sale)">${formatMoney(product.price)}</span></span>
                ` : `
                  <span class="overflow-hidden inline-block"><span class="inline-block">${formatMoney(product.price)}</span></span>
                `}
              </div>
            </a>
          </article>
        </div>
      `}).join('');

      totalSlides = products.length;
      updateNavVisibility();
      updateButtonStates(0);

      // Trigger tween animations for new elements
      // Need to wait for TweenManager to be available on initial page load
      function triggerTweenReinit() {
        if (window.pieces?.tween) {
          window.pieces.tween.reinit();
        } else {
          // TweenManager not ready yet, wait and retry
          requestAnimationFrame(triggerTweenReinit);
        }
      }
      triggerTweenReinit();
    }

    // Navigation buttons
    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        const current = getCurrentIndex();
        if (current > 0) {
          scrollToSlide(current - 1);
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        const current = getCurrentIndex();
        const maxIndex = getMaxIndex();
        if (current < maxIndex) {
          scrollToSlide(current + 1);
        }
      });
    }

    // Sync button states and progress bar with scroll position
    let scrollTimeout;
    track.addEventListener('scroll', () => {
      // Update progress bar and button states immediately during scroll (real-time feedback)
      const currentIndex = getCurrentIndex();
      const maxIndex = getMaxIndex();
      const slidesPerView = getSlidesPerView();
      if (progressBar) {
        const progress = maxIndex > 0 ? ((currentIndex + slidesPerView) / totalSlides) * 100 : 100;
        progressBar.style.width = `${Math.min(100, progress)}%`;
      }
      if (prevBtn) prevBtn.disabled = currentIndex <= 0;
      if (nextBtn) nextBtn.disabled = currentIndex >= maxIndex;

      // Debounce isAnimating reset
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        isAnimating = false;
      }, 50);
    }, { passive: true });

    // Update on resize
    window.addEventListener('resize', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(updateNavVisibility, 100);
    });

    // Initialize
    const products = getProducts();
    renderProducts(products);

    // Re-initialize on Swup navigation
    if (window.onSwupContentReplaced) {
      window.onSwupContentReplaced('recently_viewed_section', () => {
        const newSection = document.querySelector('[data-recently-viewed][data-section-id="{{ section.id }}"]');
        if (newSection) {
          const products = getProducts();
          renderProducts(products);
        }
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Recently Viewed",
  "tag": "section",
  "class": "recently-viewed-section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Shows products the customer has previously viewed. Data is stored in the browser's local storage."
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label",
      "default": "Recently browsed"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Recently Viewed"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "label": "Header alignment",
      "default": "left"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 4,
      "max": 12,
      "step": 1,
      "default": 8,
      "label": "Products to show"
    },
    {
      "type": "select",
      "id": "slides_mobile",
      "default": "1",
      "label": "Slides per view (mobile)",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ]
    },
    {
      "type": "select",
      "id": "slides_tablet",
      "default": "2",
      "label": "Slides per view (tablet)",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" }
      ]
    },
    {
      "type": "select",
      "id": "slides_desktop",
      "default": "4",
      "label": "Slides per view (desktop)",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" },
        { "value": "5", "label": "5" }
      ]
    },
    {
      "type": "checkbox",
      "id": "show_progress_bar",
      "default": true,
      "label": "Show progress bar"
    },
    {
      "type": "select",
      "id": "padding",
      "label": "Section padding",
      "info": "Default padding is set in global theme settings",
      "default": "default",
      "options": [
        { "value": "default", "label": "Default" },
        { "value": "small", "label": "Small" },
        { "value": "large", "label": "Large" },
        { "value": "none", "label": "None" }
      ]
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed",
      "category": "Products"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
  }
{% endschema %}
