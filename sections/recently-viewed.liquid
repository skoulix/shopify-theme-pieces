{%- comment -%}
  Recently Viewed Products Section - Carousel showing products from localStorage
  Client-side only - uses RecentlyViewedManager for data
{%- endcomment -%}

{%- liquid
  if section.settings.full_width
    assign container_class = 'page-full'
  else
    assign container_class = 'page-container'
  endif
-%}

<style>
  .recently-viewed-{{ section.id }} .nav-btn:hover:not(:disabled) {
    background-color: var(--color-text);
    color: var(--color-background);
    border-color: var(--color-text);
  }
  .recently-viewed-{{ section.id }} .skeleton-bg {
    background-color: var(--color-text);
    opacity: 0.1;
  }
  /* Title line reveal animation (managed by TweenManager) */
  .tween-split-line:nth-child(2) { margin-left: clamp(0.5rem, 4vw, 2rem); }
</style>

{%- liquid
  # Get product card settings
  case settings.product_card_image_ratio
    when 'portrait'
      assign image_ratio_class = 'aspect-[3/4]'
    when 'square'
      assign image_ratio_class = 'aspect-square'
    when 'landscape'
      assign image_ratio_class = 'aspect-[4/3]'
    else
      assign image_ratio_class = 'aspect-[3/4]'
  endcase
-%}
<section
  class="recently-viewed-{{ section.id }} color-{{ section.settings.color_scheme }} py-[--section-vertical-padding] overflow-hidden"
  data-recently-viewed
  data-section-id="{{ section.id }}"
  data-current-product-id="{{ product.id }}"
  data-products-to-show="{{ section.settings.products_to_show }}"
  data-show-vendor="{{ settings.show_vendor }}"
  data-image-ratio-class="{{ image_ratio_class }}"
  data-show-sale-badge="{{ settings.show_sale_badge }}"
  data-sale-badge-style="{{ settings.sale_badge_style }}"
  data-show-sold-out-badge="{{ settings.show_sold_out_badge }}"
  data-enable-wishlist="{{ settings.enable_wishlist }}"
  data-enable-compare="{{ settings.enable_compare }}"
  data-enable-quick-view="{{ settings.enable_quick_view }}"
  style="display: none;"
>
  <div class="{{ container_class }}">
    {%- comment -%} Header {%- endcomment -%}
    <div class="{% if section.settings.header_alignment == 'center' %}text-center{% elsif section.settings.header_alignment == 'right' %}text-right{% else %}flex items-end justify-between gap-6{% endif %} mb-12 lg:mb-16">
      <div data-tween-group="recently-viewed-header-{{ section.id }}">
        {% if section.settings.label != blank %}
          <span class="section-label mb-4" data-tween data-tween-type="fade-up">
            {{ section.settings.label }}
          </span>
        {% endif %}

        {% if section.settings.title != blank %}
          <h2 class="text-3xl md:text-4xl lg:text-5xl font-bold font-heading tracking-tight leading-none" data-tween data-tween-type="split-text">
            {{ section.settings.title }}
          </h2>
        {% endif %}
      </div>

      {%- comment -%} Navigation {%- endcomment -%}
      <div class="flex items-center gap-3 {% if section.settings.header_alignment == 'center' %}justify-center mt-6{% elsif section.settings.header_alignment == 'right' %}justify-end mt-6{% endif %}" data-carousel-nav>
        <button
          type="button"
          class="nav-btn w-12 h-12 flex items-center justify-center border border-current/30 rounded-full bg-transparent cursor-pointer transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed"
          data-carousel-prev
          aria-label="{{ 'accessibility.previous_products' | t }}"
          disabled
        >
          <i class="ph ph-arrow-left text-xl"></i>
        </button>
        <button
          type="button"
          class="nav-btn w-12 h-12 flex items-center justify-center border border-current/30 rounded-full bg-transparent cursor-pointer transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed"
          data-carousel-next
          aria-label="{{ 'accessibility.next_products' | t }}"
        >
          <i class="ph ph-arrow-right text-xl"></i>
        </button>
      </div>
    </div>

    {%- comment -%} Carousel Container {%- endcomment -%}
    <div class="relative">
      <div class="overflow-hidden" data-carousel-viewport>
        {%- comment -%} Products will be rendered here via JS {%- endcomment -%}
        <div class="flex gap-6 p-1.5 transition-transform duration-500 ease-out items-stretch" data-carousel-track>
        </div>
      </div>

      {%- comment -%} Progress Bar {%- endcomment -%}
      <div class="h-0.5 bg-current/15 rounded-sm overflow-hidden mt-8" data-carousel-progress>
        <div class="h-full w-0 bg-current transition-[width] duration-400 ease-out" data-carousel-progress-bar></div>
      </div>
    </div>
  </div>
</section>

<script>
  (function() {
    const section = document.querySelector('[data-recently-viewed][data-section-id="{{ section.id }}"]');
    if (!section) return;

    const STORAGE_KEY = 'pieces_recently_viewed';
    const currentProductId = section.dataset.currentProductId;
    const maxProducts = parseInt(section.dataset.productsToShow, 10) || 8;
    const showVendor = section.dataset.showVendor === 'true';
    const imageRatioClass = section.dataset.imageRatioClass || 'aspect-[3/4]';
    const showSaleBadge = section.dataset.showSaleBadge === 'true';
    const saleBadgeStyle = section.dataset.saleBadgeStyle || 'text';
    const showSoldOutBadge = section.dataset.showSoldOutBadge === 'true';
    const enableWishlist = section.dataset.enableWishlist === 'true';
    const enableCompare = section.dataset.enableCompare === 'true';
    const enableQuickView = section.dataset.enableQuickView === 'true';
    const showActionButtons = enableWishlist || enableCompare || enableQuickView;

    const track = section.querySelector('[data-carousel-track]');
    const prevBtn = section.querySelector('[data-carousel-prev]');
    const nextBtn = section.querySelector('[data-carousel-next]');
    const progressBar = section.querySelector('[data-carousel-progress-bar]');
    const nav = section.querySelector('[data-carousel-nav]');

    let currentIndex = 0;
    let slidesPerView = 4;
    let totalSlides = 0;

    function getProducts() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        const products = stored ? JSON.parse(stored) : [];
        // Filter out current product if on product page
        return products.filter(p => p.id !== currentProductId).slice(0, maxProducts);
      } catch {
        return [];
      }
    }

    function formatMoney(cents) {
      // Handle string input - remove any non-numeric chars except decimal
      if (typeof cents === 'string') {
        cents = cents.replace(/[^\d.-]/g, '');
        // If it has a decimal, it might be dollars - convert to cents
        if (cents.includes('.')) {
          cents = Math.round(parseFloat(cents) * 100);
        } else {
          cents = parseInt(cents, 10);
        }
      }
      cents = cents || 0;

      const moneyFormat = window.themeSettings?.moneyFormat || '${{amount}}';
      const value = cents / 100;
      const amount = value.toFixed(2);
      const amountNoDecimals = Math.floor(value);

      // Format with thousand separators
      const amountFormatted = value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const amountWithComma = value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const amountNoDecimalsWithComma = amountNoDecimals.toLocaleString('de-DE');
      const amountWithApostrophe = value.toLocaleString('de-CH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      return moneyFormat
        .replace(/\{\{\s*amount_with_comma_separator\s*\}\}/g, amountWithComma)
        .replace(/\{\{\s*amount_no_decimals_with_comma_separator\s*\}\}/g, amountNoDecimalsWithComma)
        .replace(/\{\{\s*amount_with_apostrophe_separator\s*\}\}/g, amountWithApostrophe)
        .replace(/\{\{\s*amount_no_decimals\s*\}\}/g, amountNoDecimals.toLocaleString('en-US'))
        .replace(/\{\{\s*amount\s*\}\}/g, amountFormatted);
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function escapeAttr(str) {
      // Escape for use in HTML attributes (especially double-quoted)
      return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function buildProductJsonAttr(product) {
      // Build the data-product-json attribute value as a JSON object
      const data = {
        id: product.id,
        handle: product.handle,
        title: product.title,
        url: product.url,
        image: product.image || '',
        price: product.price,
        compareAtPrice: product.compareAtPrice || 0,
        vendor: product.vendor || '',
        available: product.available !== false
      };
      // Escape for use in single-quoted HTML attribute
      return JSON.stringify(data).replace(/'/g, '&#39;');
    }

    function renderProducts(products) {
      if (products.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = '';

      // Calculate sale percentage
      function getSalePercent(compareAtPrice, price) {
        if (!compareAtPrice || compareAtPrice <= price) return 0;
        return Math.round((compareAtPrice - price) / compareAtPrice * 100);
      }

      track.innerHTML = products.map((product, index) => {
        const hasSale = product.compareAtPrice && product.compareAtPrice > product.price;
        const salePercent = getSalePercent(product.compareAtPrice, product.price);

        return `
        <div class="shrink-0 w-[calc(100%-2rem)] sm:w-[calc(50%-0.75rem)] lg:w-[calc(33.333%-1rem)] xl:w-[calc(25%-1.125rem)] min-w-0 flex">
          <article
            class="product-card group relative flex flex-col no-underline text-inherit rounded-[--card-radius] overflow-hidden h-full w-full border-[length:var(--card-border-width)] border-solid border-[--color-border] shadow-[--card-shadow]"
          >
            <div class="product-card-image relative overflow-hidden ${imageRatioClass}" data-tween data-tween-type="clip-right">
              <a href="${escapeHtml(product.url)}" class="block w-full h-full" aria-label="${escapeHtml(product.title)}">
                ${product.image ? `
                  <img
                    src="${escapeHtml(product.image)}"
                    alt="${escapeHtml(product.title)}"
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                    loading="lazy"
                    decoding="async"
                  >
                ` : `
                  <div class="w-full h-full flex items-center justify-center bg-[--color-background-secondary]">
                    <i class="ph ph-image text-5xl text-[--color-text-secondary] opacity-30" aria-hidden="true"></i>
                  </div>
                `}
              </a>

              <!-- Badges -->
              <div class="absolute top-3 left-3 flex flex-col gap-2 pointer-events-none">
                ${showSaleBadge && hasSale ? `
                  <span class="inline-block px-2 py-1 text-xs font-semibold bg-[--color-sale] text-white rounded">
                    ${saleBadgeStyle === 'percentage' ? `-${salePercent}%` : `{{ 'products.product.on_sale' | t }}`}
                  </span>
                ` : ''}
                ${showSoldOutBadge && !product.available ? `
                  <span class="inline-block px-2 py-1 text-xs font-semibold bg-[--color-text] text-[--color-background] rounded">
                    {{ 'products.product.sold_out' | t }}
                  </span>
                ` : ''}
              </div>

              <!-- Action buttons -->
              ${showActionButtons ? `
                <div class="product-card-actions absolute bottom-3 left-3 right-3 z-10 flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  ${enableQuickView && product.available ? `
                    <button
                      type="button"
                      class="product-card-quick-view w-10 h-10 flex items-center justify-center rounded-full bg-[--color-background] text-[--color-text] shadow-md transform scale-90 group-hover:scale-100 transition-all duration-300 hover:bg-[--color-text] hover:text-[--color-background]"
                      data-quick-view-trigger="${escapeHtml(product.handle)}"
                      aria-label="{{ 'products.product.quick_view' | t | default: 'Quick view' }}: ${escapeHtml(product.title)}"
                    >
                      <i class="ph ph-eye text-lg" aria-hidden="true"></i>
                    </button>
                  ` : ''}
                  ${enableWishlist ? `
                    <button
                      type="button"
                      class="product-card-wishlist w-10 h-10 flex items-center justify-center rounded-full bg-[--color-background] text-[--color-text] shadow-md transform scale-90 group-hover:scale-100 transition-all duration-300 hover:bg-[--color-text] hover:text-[--color-background] [&.is-active]:bg-[--color-sale] [&.is-active]:text-white"
                      data-wishlist-toggle="${product.id}"
                      data-product-json='${buildProductJsonAttr(product)}'
                      aria-label="{{ 'products.wishlist.add_to_wishlist' | t | default: 'Add to wishlist' }}: ${escapeHtml(product.title)}"
                      aria-pressed="false"
                    >
                      <i class="ph ph-heart text-lg" aria-hidden="true"></i>
                    </button>
                  ` : ''}
                  ${enableCompare ? `
                    <button
                      type="button"
                      class="product-card-compare w-10 h-10 flex items-center justify-center rounded-full bg-[--color-background] text-[--color-text] shadow-md transform scale-90 group-hover:scale-100 transition-all duration-300 hover:bg-[--color-text] hover:text-[--color-background] [&.is-active]:bg-[--color-text] [&.is-active]:text-[--color-background]"
                      data-compare-toggle="${product.id}"
                      data-product-json='${buildProductJsonAttr(product)}'
                      aria-label="{{ 'products.compare.add_to_compare' | t | default: 'Add to compare' }}: ${escapeHtml(product.title)}"
                      aria-pressed="false"
                    >
                      <i class="ph ph-scales text-lg" aria-hidden="true"></i>
                    </button>
                  ` : ''}
                </div>
              ` : ''}
            </div>

            <a href="${escapeHtml(product.url)}" class="product-card-content flex-1 p-4 bg-[--color-background] block no-underline" data-tween data-tween-type="fade-up">
              ${showVendor && product.vendor ? `
                <p class="product-card-vendor text-xs text-[--color-text-secondary] uppercase tracking-wide overflow-hidden">
                  <span class="inline-block">${escapeHtml(product.vendor)}</span>
                </p>
              ` : ''}

              <h3 class="product-card-title mt-2 text-xs md:text-sm font-semibold tracking-wide text-[--color-text] font-heading">
                ${escapeHtml(product.title)}
              </h3>

              <div class="product-card-price mt-2 text-sm text-[--color-text-secondary]">
                ${hasSale ? `
                  <span class="overflow-hidden inline-block"><span class="inline-block line-through opacity-60 mr-2">${formatMoney(product.compareAtPrice)}</span></span>
                  <span class="overflow-hidden inline-block"><span class="inline-block text-[--color-sale]">${formatMoney(product.price)}</span></span>
                ` : `
                  <span class="overflow-hidden inline-block"><span class="inline-block">${formatMoney(product.price)}</span></span>
                `}
              </div>
            </a>
          </article>
        </div>
      `}).join('');

      totalSlides = products.length;
      updateSlidesPerView();
      updateCarousel();

      // Hide nav if not enough slides
      if (totalSlides <= slidesPerView) {
        nav.style.display = 'none';
      } else {
        nav.style.display = 'flex';
      }

      // Trigger tween animations for new elements
      // Need to wait for TweenManager to be available on initial page load
      function triggerTweenReinit() {
        if (window.pieces?.tween) {
          window.pieces.tween.reinit();
        } else {
          // TweenManager not ready yet, wait and retry
          requestAnimationFrame(triggerTweenReinit);
        }
      }
      triggerTweenReinit();
    }

    function updateSlidesPerView() {
      const width = window.innerWidth;
      if (width < 640) slidesPerView = 1;
      else if (width < 1024) slidesPerView = 2;
      else if (width < 1280) slidesPerView = 3;
      else slidesPerView = 4;
    }

    function updateCarousel() {
      if (totalSlides === 0) return;

      const maxIndex = Math.max(0, totalSlides - slidesPerView);
      currentIndex = Math.min(currentIndex, maxIndex);

      const slideWidth = track.children[0]?.offsetWidth || 0;
      const gap = 24; // 1.5rem
      const offset = currentIndex * (slideWidth + gap);

      track.style.transform = `translateX(-${offset}px)`;

      // Update buttons
      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex >= maxIndex;

      // Update progress
      const progress = maxIndex > 0 ? ((currentIndex + slidesPerView) / totalSlides) * 100 : 100;
      progressBar.style.width = `${Math.min(100, progress)}%`;
    }

    // Event listeners
    prevBtn.addEventListener('click', () => {
      currentIndex = Math.max(0, currentIndex - 1);
      updateCarousel();
    });

    nextBtn.addEventListener('click', () => {
      const maxIndex = Math.max(0, totalSlides - slidesPerView);
      currentIndex = Math.min(maxIndex, currentIndex + 1);
      updateCarousel();
    });

    // Touch/swipe support
    let touchStartX = 0;
    let touchEndX = 0;

    track.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    track.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          nextBtn.click();
        } else {
          prevBtn.click();
        }
      }
    }, { passive: true });

    // Resize handler
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        updateSlidesPerView();
        updateCarousel();

        if (totalSlides <= slidesPerView) {
          nav.style.display = 'none';
        } else {
          nav.style.display = 'flex';
        }
      }, 100);
    });

    // Initialize
    const products = getProducts();
    renderProducts(products);

    // Re-initialize on Swup navigation
    if (window.onSwupContentReplaced) {
      window.onSwupContentReplaced('recently_viewed_section', () => {
        const newSection = document.querySelector('[data-recently-viewed][data-section-id="{{ section.id }}"]');
        if (newSection) {
          const products = getProducts();
          renderProducts(products);
        }
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Recently Viewed",
  "tag": "section",
  "class": "recently-viewed-section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Shows products the customer has previously viewed. Data is stored in the browser's local storage."
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label",
      "default": "Recently browsed"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Recently Viewed"
    },
    {
      "type": "text_alignment",
      "id": "header_alignment",
      "label": "Header alignment",
      "default": "left"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 4,
      "max": 12,
      "step": 1,
      "default": 8,
      "label": "Products to show"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed",
      "category": "Products"
    }
  ]
}
{% endschema %}
