{%- comment -%}
  Predictive Search Component
  Real-time search suggestions as user types
{%- endcomment -%}

<style>
  /* Hide native browser clear button on search inputs */
  .predictive-search__input::-webkit-search-cancel-button,
  .predictive-search__input::-webkit-search-decoration,
  .predictive-search__input::-webkit-search-results-button,
  .predictive-search__input::-webkit-search-results-decoration {
    -webkit-appearance: none;
    appearance: none;
    display: none;
  }

  /* Skeleton loading animation */
  @keyframes skeleton-shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  .predictive-search__skeleton {
    background: linear-gradient(
      90deg,
      var(--color-background-secondary) 25%,
      var(--color-border) 50%,
      var(--color-background-secondary) 75%
    );
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s ease-in-out infinite;
    border-radius: 0.25rem;
  }

  .predictive-search__skeleton-card {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
  }

  .predictive-search__skeleton-image {
    width: 3.5rem;
    height: 3.5rem;
    flex-shrink: 0;
    border-radius: 0.25rem;
  }

  .predictive-search__skeleton-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .predictive-search__skeleton-title {
    height: 0.875rem;
    width: 80%;
  }

  .predictive-search__skeleton-price {
    height: 0.75rem;
    width: 40%;
  }

  @media (max-width: 767px) {
    .predictive-search__skeleton-card {
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid var(--color-border);
    }

    .predictive-search__skeleton-card:last-child {
      border-bottom: none;
    }

    .predictive-search__skeleton-image {
      width: 4rem;
      height: 4rem;
      border-radius: 0.375rem;
    }
  }

  /* Product grid for larger screens - horizontal cards in 2 columns */
  @media (min-width: 768px) {
    .predictive-search__products-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      padding: 0.75rem;
    }

    .predictive-search__product-card {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      text-decoration: none;
      color: inherit;
      border-radius: var(--card-radius, 0.375rem);
      transition: background-color 0.2s ease;
    }

    .predictive-search__product-card:hover {
      background-color: var(--color-background-secondary);
    }

    .predictive-search__product-image {
      width: 3.5rem;
      height: 3.5rem;
      flex-shrink: 0;
      background: var(--color-background-secondary);
      border-radius: 0.25rem;
      overflow: hidden;
    }

    .predictive-search__product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .predictive-search__product-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .predictive-search__product-title {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--color-text);
      line-height: 1.3;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0;
    }

    .predictive-search__product-price {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      margin: 0;
    }
  }

  /* Mobile: keep list layout */
  @media (max-width: 767px) {
    .predictive-search__products-grid {
      display: flex;
      flex-direction: column;
    }

    .predictive-search__products-grid .predictive-search__product-card {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid var(--color-border);
    }

    .predictive-search__products-grid .predictive-search__product-card:last-child {
      border-bottom: none;
    }

    .predictive-search__products-grid .predictive-search__product-image {
      width: 4rem;
      height: 4rem;
      flex-shrink: 0;
      border-radius: 0.375rem;
      overflow: hidden;
      background: var(--color-background-secondary);
    }

    .predictive-search__products-grid .predictive-search__product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .predictive-search__products-grid .predictive-search__product-info {
      flex: 1;
      min-width: 0;
    }

    .predictive-search__products-grid .predictive-search__product-title {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0;
    }

    .predictive-search__products-grid .predictive-search__product-price {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin: 0;
    }
  }
</style>

<predictive-search
  class="predictive-search relative z-[999]"
  data-loading-text="{{ 'search.loading' | t }}"
  data-no-results-text="{{ 'search.no_results' | t }}"
  data-products-heading="{{ 'search.filter_products' | t }}"
  data-articles-heading="{{ 'search.filter_articles' | t }}"
  data-pages-heading="{{ 'search.filter_pages' | t }}"
  data-view-all-text="{{ 'search.view_all' | t }}"
  data-trending-heading="{{ 'search.trending' | t | default: 'Trending' }}"
>
  {%- liquid
    # Generate unique ID for this instance to support multiple instances on a page
    assign unique_id = 'now' | date: '%N' | slice: -6, 6
  -%}
  <form action="{{ routes.search_url }}" method="get" role="search" class="predictive-search__form">
    <div class="predictive-search__input-wrapper relative">
      <input type="hidden" name="type" value="product,article,page">
      <input type="hidden" name="options[prefix]" value="last">
      <label for="predictive-search-input-{{ unique_id }}" class="sr-only">{{ 'search.placeholder' | t }}</label>
      <input
        type="search"
        id="predictive-search-input-{{ unique_id }}"
        name="q"
        value="{{ search.terms | escape }}"
        class="predictive-search__input w-full py-3 px-4 pr-12 bg-transparent border border-[--color-border] rounded-[--input-radius] text-[--color-text] placeholder:text-[--color-text-secondary] focus:outline-none focus:border-[--color-primary] transition-colors"
        placeholder="{{ 'search.placeholder' | t }}"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
        aria-controls="predictive-search-results-{{ unique_id }}"
        aria-autocomplete="list"
        data-predictive-search-input
      >
      <button
        type="submit"
        class="predictive-search__submit absolute right-0 top-0 h-full px-4 text-[--color-text-secondary] hover:text-[--color-text] transition-colors"
        aria-label="{{ 'search.submit' | t }}"
      >
        <i class="ph ph-magnifying-glass text-xl"></i>
      </button>
      <button
        type="button"
        class="predictive-search__clear absolute right-14 top-1/2 -translate-y-1/2 p-2 text-[--color-text-secondary] hover:text-[--color-text] transition-colors hidden"
        aria-label="{{ 'search.clear' | t }}"
        data-predictive-search-clear
      >
        <i class="ph ph-x text-lg"></i>
      </button>
    </div>

    <div
      id="predictive-search-results-{{ unique_id }}"
      class="predictive-search__results absolute top-full left-0 right-0 mt-2 bg-[--color-background] border border-[--color-border] rounded-[--card-radius] shadow-xl overflow-hidden z-[999] hidden"
      role="listbox"
      data-predictive-search-results
    >
      <div class="predictive-search__loading bg-[--color-background] hidden" data-predictive-search-loading>
        <div class="px-4 py-2 bg-[--color-background-secondary]">
          <div class="predictive-search__skeleton h-3 w-20"></div>
        </div>
        <div class="predictive-search__products-grid p-3">
          {%- for i in (1..4) -%}
          <div class="predictive-search__skeleton-card">
            <div class="predictive-search__skeleton predictive-search__skeleton-image"></div>
            <div class="predictive-search__skeleton-info">
              <div class="predictive-search__skeleton predictive-search__skeleton-title"></div>
              <div class="predictive-search__skeleton predictive-search__skeleton-price"></div>
            </div>
          </div>
          {%- endfor -%}
        </div>
      </div>

      <div class="predictive-search__content bg-[--color-background]" data-predictive-search-content>
        {%- comment -%} Results injected here via JS {%- endcomment -%}
      </div>
    </div>
  </form>
</predictive-search>

<script>
if (!customElements.get('predictive-search')) {
class PredictiveSearch extends HTMLElement {
  constructor() {
    super();
    this.cachedResults = {};
    this.cachedRecommendations = null;
    this.debounceTimer = null;
  }

  connectedCallback() {
    // Query DOM elements after the element is connected
    this.input = this.querySelector('[data-predictive-search-input]');
    this.results = this.querySelector('[data-predictive-search-results]');
    this.content = this.querySelector('[data-predictive-search-content]');
    this.loading = this.querySelector('[data-predictive-search-loading]');
    this.clearBtn = this.querySelector('[data-predictive-search-clear]');

    if (!this.input || !this.results) return;

    this.setupEventListeners();

    // Show clear button if input already has value (e.g., on search results page)
    if (this.input.value.trim().length > 0) {
      this.clearBtn?.classList.remove('hidden');
    }
  }

  setupEventListeners() {
    this.input.addEventListener('input', this.debounce(() => this.onChange(), 300));
    this.input.addEventListener('focus', () => this.onFocus());
    this.clearBtn?.addEventListener('click', () => this.clear());

    // Close when clicking outside this specific instance
    document.addEventListener('click', (e) => {
      if (!this.contains(e.target)) this.close();
    });

    // Close on escape only if this instance's results are visible
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && this.results && !this.results.classList.contains('hidden')) {
        this.close();
        this.input?.blur();
      }
    });

    this.results.addEventListener('keydown', (e) => this.onKeydown(e));
  }

  debounce(fn, wait) {
    return (...args) => {
      clearTimeout(this.debounceTimer);
      this.debounceTimer = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  onChange() {
    const searchTerm = this.input.value.trim();

    if (searchTerm.length === 0) {
      this.clearBtn?.classList.add('hidden');
      // Show recommendations when input is cleared
      this.getRecommendations();
      return;
    }

    this.clearBtn?.classList.remove('hidden');

    if (searchTerm.length < 2) return;

    this.getSearchResults(searchTerm);
  }

  onFocus() {
    const searchTerm = this.input.value.trim();
    if (searchTerm.length >= 2) {
      this.getSearchResults(searchTerm);
    } else if (searchTerm.length === 0) {
      // Show recommendations when focusing empty input
      this.getRecommendations();
    }
  }

  async getSearchResults(searchTerm) {
    if (this.cachedResults[searchTerm]) {
      this.renderResults(this.cachedResults[searchTerm]);
      return;
    }

    this.showLoading();

    try {
      const response = await fetch(
        `${window.Shopify.routes.root}search/suggest.json?q=${encodeURIComponent(searchTerm)}&resources[type]=product,article,page&resources[limit]=4&resources[options][unavailable_products]=last`
      );

      if (!response.ok) throw new Error('Search failed');

      const data = await response.json();
      this.cachedResults[searchTerm] = data;
      this.renderResults(data);
    } catch (error) {
      console.error('Predictive search error:', error);
      this.close();
    }
  }

  async getRecommendations() {
    // Use cached recommendations if available
    if (this.cachedRecommendations) {
      this.renderRecommendations(this.cachedRecommendations);
      return;
    }

    this.showLoading();

    try {
      // Fetch trending/popular products using product recommendations API
      const response = await fetch(
        `${window.Shopify.routes.root}recommendations/products.json?limit=6&intent=related`
      );

      if (response.ok) {
        const data = await response.json();
        if (data.products && data.products.length > 0) {
          this.cachedRecommendations = data.products;
          this.renderRecommendations(data.products);
          return;
        }
      }

      // Fallback: fetch from a collection or search for popular terms
      const fallbackResponse = await fetch(
        `${window.Shopify.routes.root}search/suggest.json?q=*&resources[type]=product&resources[limit]=6&resources[options][unavailable_products]=last`
      );

      if (fallbackResponse.ok) {
        const fallbackData = await fallbackResponse.json();
        const products = fallbackData.resources?.results?.products || [];
        this.cachedRecommendations = products;
        this.renderRecommendations(products);
      } else {
        this.close();
      }
    } catch (error) {
      console.error('Recommendations error:', error);
      this.close();
    }
  }

  renderRecommendations(products) {
    if (!products || products.length === 0) {
      this.close();
      return;
    }

    const html = `
      <div class="predictive-search__section">
        <h3 class="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-[--color-text-secondary] bg-[--color-background-secondary]">
          ${this.dataset.trendingHeading}
        </h3>
        <div class="predictive-search__products-grid">
          ${products.map(product => {
            // Handle both API response formats
            const url = product.url || `/products/${product.handle}`;
            const image = product.image || (product.featured_image ? product.featured_image : (product.images && product.images[0] ? product.images[0] : null));
            const imageUrl = typeof image === 'string' ? image : (image?.src || '');
            const price = product.price || (product.price_min ? window.Shopify.formatMoney(product.price_min) : '');

            return `
              <a href="${url}" class="predictive-search__product-card" role="option">
                <div class="predictive-search__product-image">
                  ${imageUrl ? `<img src="${imageUrl}" alt="${product.title}" loading="lazy">` : ''}
                </div>
                <div class="predictive-search__product-info">
                  <p class="predictive-search__product-title">${product.title}</p>
                  <p class="predictive-search__product-price">${price}</p>
                </div>
              </a>
            `;
          }).join('')}
        </div>
      </div>
    `;

    this.content.innerHTML = html;
    this.loading.classList.add('hidden');
    this.content.classList.remove('hidden');
    this.results.classList.remove('hidden');
  }

  showLoading() {
    this.results.classList.remove('hidden');
    this.loading.classList.remove('hidden');
    this.content.classList.add('hidden');
  }

  renderResults(data) {
    const resources = data.resources?.results || {};
    const products = resources.products || [];
    const articles = resources.articles || [];
    const pages = resources.pages || [];

    if (products.length === 0 && articles.length === 0 && pages.length === 0) {
      if (!this.input.value.trim()) {
        this.close();
        return;
      }
      this.content.innerHTML = `
        <div class="p-6 text-center text-[--color-text-secondary]">
          <p class="text-sm">${this.dataset.noResultsText}</p>
        </div>
      `;
    } else {
      let html = '';

      if (products.length > 0) {
        html += `
          <div class="predictive-search__section">
            <h3 class="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-[--color-text-secondary] bg-[--color-background-secondary]">
              ${this.dataset.productsHeading}
            </h3>
            <div class="predictive-search__products-grid">
              ${products.map(product => `
                <a href="${product.url}" class="predictive-search__product-card" role="option">
                  <div class="predictive-search__product-image">
                    ${product.image ? `
                      <img src="${product.image}" alt="${product.title}" loading="lazy">
                    ` : ''}
                  </div>
                  <div class="predictive-search__product-info">
                    <p class="predictive-search__product-title">${product.title}</p>
                    <p class="predictive-search__product-price">${product.price}</p>
                  </div>
                </a>
              `).join('')}
            </div>
          </div>
        `;
      }

      if (articles.length > 0) {
        html += `
          <div class="predictive-search__section">
            <h3 class="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-[--color-text-secondary] bg-[--color-background-secondary]">
              ${this.dataset.articlesHeading}
            </h3>
            <ul class="divide-y divide-[--color-border]">
              ${articles.map(article => `
                <li>
                  <a href="${article.url}" class="block p-4 hover:bg-[--color-background-secondary] transition-colors" role="option">
                    <p class="text-sm font-medium text-[--color-text]">${article.title}</p>
                  </a>
                </li>
              `).join('')}
            </ul>
          </div>
        `;
      }

      if (pages.length > 0) {
        html += `
          <div class="predictive-search__section">
            <h3 class="px-4 py-2 text-xs font-semibold uppercase tracking-wider text-[--color-text-secondary] bg-[--color-background-secondary]">
              ${this.dataset.pagesHeading}
            </h3>
            <ul class="divide-y divide-[--color-border]">
              ${pages.map(page => `
                <li>
                  <a href="${page.url}" class="block p-4 hover:bg-[--color-background-secondary] transition-colors" role="option">
                    <p class="text-sm font-medium text-[--color-text]">${page.title}</p>
                  </a>
                </li>
              `).join('')}
            </ul>
          </div>
        `;
      }

      html += `
        <div class="p-4 border-t border-[--color-border]">
          <button type="submit" class="w-full btn btn--secondary !py-2.5 !text-sm">
            <span>${this.dataset.viewAllText} "${this.input.value}"</span>
          </button>
        </div>
      `;

      this.content.innerHTML = html;
    }

    this.loading.classList.add('hidden');
    this.content.classList.remove('hidden');
    this.results.classList.remove('hidden');
  }

  onKeydown(e) {
    const focusableElements = this.results.querySelectorAll('a, button');
    const firstElement = focusableElements[0];
    const lastElement = focusableElements[focusableElements.length - 1];

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (document.activeElement === this.input) {
        firstElement?.focus();
      } else {
        const currentIndex = Array.from(focusableElements).indexOf(document.activeElement);
        focusableElements[currentIndex + 1]?.focus();
      }
    }

    if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (document.activeElement === firstElement) {
        this.input.focus();
      } else {
        const currentIndex = Array.from(focusableElements).indexOf(document.activeElement);
        focusableElements[currentIndex - 1]?.focus();
      }
    }
  }

  clear() {
    this.input.value = '';
    this.input.focus();
    this.close();
    this.clearBtn?.classList.add('hidden');
  }

  close() {
    this.results.classList.add('hidden');
  }
}

customElements.define('predictive-search', PredictiveSearch);
}
</script>
