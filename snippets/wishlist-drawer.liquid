{%- comment -%}
  Wishlist/Favorites Drawer
  Slide-out panel showing saved products
{%- endcomment -%}

{%- comment -%} Drawer Container {%- endcomment -%}
<div class="wishlist-drawer-container group" data-wishlist-container role="dialog" aria-modal="true" aria-labelledby="wishlist-drawer-title" inert>
  {%- comment -%} Backdrop {%- endcomment -%}
  <div class="drawer-backdrop group-[.is-open]:opacity-100" data-wishlist-close></div>

  {%- comment -%} Drawer Panel {%- endcomment -%}
  <div class="wishlist-drawer color-scheme-1" data-wishlist-drawer data-lenis-prevent>
    <header class="wishlist-drawer__header">
      <h2 id="wishlist-drawer-title" class="wishlist-drawer__title">
        {{ 'products.wishlist.title' | t | default: 'Wishlist' }}
        <span class="wishlist-drawer__count" data-wishlist-drawer-count aria-label="{{ 'products.wishlist.items_count' | t | default: 'items' }}">0</span>
      </h2>
      <button type="button" class="wishlist-drawer__close" data-wishlist-close aria-label="{{ 'accessibility.close' | t }}">
        <i class="ph ph-x text-xl"></i>
      </button>
    </header>

    <div class="wishlist-drawer__content">
      <div class="wishlist-drawer__products" data-wishlist-products>
        {%- comment -%} Products rendered via JS {%- endcomment -%}
      </div>
    </div>

    <footer class="wishlist-drawer__footer">
      <a href="{{ pages['wishlist'].url | default: '/pages/wishlist' }}" class="btn btn--primary btn--full" data-wishlist-view-btn>
        <span>{{ 'products.wishlist.view_all' | t | default: 'View All Saved Items' }}</span>
      </a>
    </footer>
  </div>
</div>

<script data-swup-ignore-script>
(function() {
  // Prevent double initialization if script runs again
  if (window._wishlistDrawerInitialized) return;
  window._wishlistDrawerInitialized = true;

  const STORAGE_KEY = 'pieces_wishlist';

  const container = document.querySelector('[data-wishlist-container]');
  const drawer = document.querySelector('[data-wishlist-drawer]');
  const productsContainer = drawer?.querySelector('[data-wishlist-products]');
  const countEl = document.querySelector('[data-wishlist-drawer-count]');

  // Allow functionality even if drawer isn't found (click handlers still work)
  const hasDrawer = !!container;

  function getProducts() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch {
      return [];
    }
  }

  function saveProducts(products) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
    } catch {}
  }

  function formatMoney(cents) {
    // Handle string input - remove any non-numeric chars except decimal
    if (typeof cents === 'string') {
      cents = cents.replace(/[^\d.-]/g, '');
      if (cents.includes('.')) {
        cents = Math.round(parseFloat(cents) * 100);
      } else {
        cents = parseInt(cents, 10);
      }
    }
    cents = cents || 0;

    const moneyFormat = window.themeSettings?.moneyFormat || '${{amount}}';
    const value = cents / 100;
    const amountNoDecimals = Math.floor(value);
    const amountFormatted = value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const amountWithComma = value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const amountNoDecimalsWithComma = amountNoDecimals.toLocaleString('de-DE');
    const amountWithApostrophe = value.toLocaleString('de-CH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    return moneyFormat
      .replace(/\{\{\s*amount_with_comma_separator\s*\}\}/g, amountWithComma)
      .replace(/\{\{\s*amount_no_decimals_with_comma_separator\s*\}\}/g, amountNoDecimalsWithComma)
      .replace(/\{\{\s*amount_with_apostrophe_separator\s*\}\}/g, amountWithApostrophe)
      .replace(/\{\{\s*amount_no_decimals\s*\}\}/g, amountNoDecimals.toLocaleString('en-US'))
      .replace(/\{\{\s*amount\s*\}\}/g, amountFormatted);
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
  }

  function updateUI() {
    const products = getProducts();
    const count = products.length;

    // Update count
    if (countEl) countEl.textContent = count;

    // Update header icon count (hide when 0)
    document.querySelectorAll('[data-wishlist-count]').forEach(el => {
      el.textContent = count;
      el.classList.toggle('hidden', count === 0);
    });

    // Update wishlist buttons
    const productIds = products.map(p => String(p.id));
    document.querySelectorAll('[data-wishlist-toggle]').forEach(btn => {
      const productId = btn.dataset.wishlistToggle;
      const isInWishlist = productIds.includes(productId);
      btn.classList.toggle('is-active', isInWishlist);
      btn.setAttribute('aria-pressed', isInWishlist);
    });

    // Render products
    renderProducts(products);
  }

  function renderProducts(products) {
    if (!productsContainer) return;

    if (products.length === 0) {
      productsContainer.innerHTML = `
        <div class="wishlist-drawer__empty">
          <div class="wishlist-drawer__empty-icon">
            <i class="ph ph-heart"></i>
          </div>
          <h3 class="drawer-title">{{ 'products.wishlist.empty_title' | t | default: 'Your wishlist is empty' }}</h3>
          <p class="m-0 text-(--color-text-secondary) text-sm">{{ 'products.wishlist.empty_text' | t | default: 'Save your favorite products by clicking the heart icon' }}</p>
        </div>
      `;
      return;
    }

    productsContainer.innerHTML = products.map(product => `
      <div class="wishlist-drawer__product" data-product-id="${product.id}">
        <a href="${escapeHtml(product.url)}" class="wishlist-drawer__product-image">
          ${product.image ? `<img src="${escapeHtml(product.image)}" alt="${escapeHtml(product.title)}" loading="lazy" decoding="async">` : ''}
        </a>
        <div class="wishlist-drawer__product-info">
          <a href="${escapeHtml(product.url)}" class="wishlist-drawer__product-title">${escapeHtml(product.title)}</a>
          <div class="wishlist-drawer__product-price">
            ${product.compareAtPrice && product.compareAtPrice > product.price ? `
              <span class="compare-price">${formatMoney(product.compareAtPrice)}</span>
              <span class="sale-price">${formatMoney(product.price)}</span>
            ` : formatMoney(product.price)}
          </div>
          <div class="wishlist-drawer__product-actions">
            <a href="${escapeHtml(product.url)}" class="btn btn--primary btn--xs">
              <span>{{ 'products.wishlist.view' | t | default: 'View' }}</span>
            </a>
            <button type="button" class="btn btn--secondary btn--xs btn--icon-only" data-remove-wishlist="${product.id}" aria-label="{{ 'products.wishlist.remove' | t | default: 'Remove from wishlist' }}">
              <i class="ph ph-trash"></i>
            </button>
          </div>
        </div>
      </div>
    `).join('');

    // Add remove listeners
    productsContainer.querySelectorAll('[data-remove-wishlist]').forEach(btn => {
      btn.addEventListener('click', () => {
        removeProduct(btn.dataset.removeWishlist);
      });
    });
  }

  function removeProduct(productId) {
    const products = getProducts().filter(p => String(p.id) !== String(productId));
    saveProducts(products);
    updateUI();
    document.dispatchEvent(new CustomEvent('wishlist:removed', { detail: { productId } }));
  }

  let focusTrap = null;
  let previouslyFocused = null;

  function openDrawer() {
    if (!hasDrawer) return;
    previouslyFocused = document.activeElement;
    container.classList.add('is-open');
    container.removeAttribute('inert');
    document.body.style.overflow = 'hidden';

    // Create focus trap using global a11y utility
    if (window.a11y?.createFocusTrap) {
      focusTrap = window.a11y.createFocusTrap(container);
      focusTrap.activate();
    } else {
      // Fallback: focus close button
      container.querySelector('[data-wishlist-close]')?.focus();
    }
  }

  function closeDrawer() {
    if (!hasDrawer) return;
    // Deactivate focus trap
    if (focusTrap) {
      focusTrap.deactivate(false);
      focusTrap = null;
    }

    container.classList.remove('is-open');
    container.setAttribute('inert', '');
    document.body.style.overflow = '';

    // Restore focus to trigger element
    if (previouslyFocused && previouslyFocused.focus) {
      previouslyFocused.focus();
      previouslyFocused = null;
    }
  }

  // Event listeners (only if drawer exists)
  if (hasDrawer) {
    // Close on backdrop or close button click
    container.querySelectorAll('[data-wishlist-close]').forEach(el => {
      el.addEventListener('click', closeDrawer);
    });
  }

  // Listen for wishlist toggle from product cards
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-wishlist-toggle]');
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const productJson = btn.dataset.productJson;
    if (!productJson) return;

    try {
      const product = JSON.parse(productJson);

      const products = getProducts();
      const exists = products.some(p => String(p.id) === String(product.id));

      if (exists) {
        removeProduct(product.id);
      } else {
        products.unshift({ ...product, addedAt: Date.now() });
        saveProducts(products);
        updateUI();
        document.dispatchEvent(new CustomEvent('wishlist:added', { detail: { product } }));
      }
    } catch (err) {
      console.error('Wishlist: Failed to parse product data', err);
    }
  });

  // Listen for open drawer events
  document.addEventListener('click', (e) => {
    const trigger = e.target.closest('[data-wishlist-open]');
    if (trigger) {
      e.preventDefault();
      openDrawer();
    }
  });

  // Listen for storage changes from other tabs
  window.addEventListener('storage', (e) => {
    if (e.key === STORAGE_KEY) {
      updateUI();
    }
  });

  // Escape key to close
  document.addEventListener('keydown', (e) => {
    if (hasDrawer && e.key === 'Escape' && container.classList.contains('is-open')) {
      closeDrawer();
    }
  });

  // Close drawer when clicking "View All" link
  const viewAllBtn = container?.querySelector('[data-wishlist-view-btn]');
  viewAllBtn?.addEventListener('click', () => {
    closeDrawer();
  });

  // Close drawer if on wishlist page
  if (window.location.pathname.includes('/pages/wishlist')) {
    closeDrawer();
  }

  // Initialize
  updateUI();

  // Re-init on Swup navigation - listen to both events for reliability
  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('wishlist_drawer', () => {
      // Use requestAnimationFrame to ensure DOM is fully updated
      requestAnimationFrame(() => {
        updateUI();
        // Close drawer if navigated to wishlist page
        if (window.location.pathname.includes('/pages/wishlist')) {
          closeDrawer();
        }
      });
    });
  }

  // Also update after transition completes (for cached pages)
  window.addEventListener('swup:transitionEnd', () => {
    requestAnimationFrame(() => {
      updateUI();
      // Close drawer if navigated to wishlist page
      if (window.location.pathname.includes('/pages/wishlist')) {
        closeDrawer();
      }
    });
  });

  // Update after facet filtering replaces product grid
  document.addEventListener('facets:updated', updateUI);

  // Listen for wishlist changes from other sources (e.g., wishlist page section)
  document.addEventListener('wishlist:removed', updateUI);
  document.addEventListener('wishlist:added', updateUI);
  document.addEventListener('wishlist:cleared', updateUI);
})();
</script>
