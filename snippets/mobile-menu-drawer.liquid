{%- comment -%}
  Mobile Menu Drawer
  Full-screen navigation drawer with two style options:
  - Accordion: Expand-in-place submenus (2 levels)
  - Slide: Sliding panel navigation with back buttons (3 levels)

  Accepts:
  - menu: {Object} Menu linklist object
  - style: {String} 'accordion' or 'slide' (default: 'accordion')
  - show_search: {Boolean} Show search link in footer
  - show_cart: {Boolean} Show cart link in footer
  - nav_uppercase: {Boolean} Uppercase navigation text

  Usage:
  {% render 'mobile-menu-drawer',
    menu: section.settings.menu,
    style: section.settings.mobile_menu_style,
    show_search: section.settings.show_search,
    show_cart: section.settings.show_cart,
    nav_uppercase: section.settings.nav_uppercase
  %}
{%- endcomment -%}

{%- liquid
  assign mobile_menu_style = style | default: 'accordion'
  assign uppercase_class = ''
  if nav_uppercase
    assign uppercase_class = ' uppercase'
  endif
-%}

<div id="mobile-menu" class="mobile-nav mobile-nav--{{ mobile_menu_style }} group fixed inset-0 z-200 pointer-events-none invisible [&.is-open]:pointer-events-auto [&.is-open]:visible lg:hidden" role="dialog" aria-modal="true" inert data-mobile-menu-style="{{ mobile_menu_style }}">
  {%- comment -%} Backdrop {%- endcomment -%}
  <div class="mobile-nav__backdrop drawer-backdrop group-[.is-open]:opacity-100" data-mobile-nav-close></div>

  {%- comment -%} Drawer Panel {%- endcomment -%}
  <div class="mobile-nav__drawer absolute inset-0 bg-(--color-background) flex flex-col">
    {%- comment -%} Header {%- endcomment -%}
    <div class="mobile-nav__header flex items-center justify-end p-5">
      <button type="button" class="mobile-nav__close drawer-close drawer-close--lg" data-mobile-nav-close>
        <span class="sr-only">{{ 'accessibility.close_menu' | t }}</span>
        <i class="ph ph-x text-2xl"></i>
      </button>
    </div>

    {% if mobile_menu_style == 'slide' %}
      {%- comment -%} ========================================
          SLIDING PANELS NAVIGATION (3-level support)
      ======================================== {%- endcomment -%}
      <nav class="mobile-nav__content mobile-nav__panels flex-1 flex flex-col overflow-hidden relative" data-mobile-panels data-lenis-prevent>
        {%- comment -%} Main Panel (Level 1) {%- endcomment -%}
        <div class="mobile-nav__panel mobile-nav__panel--main is-active px-6 py-8" data-panel="main" data-panel-level="1">
          <ul class="mobile-nav__list list-none m-0 p-0 flex-1 overflow-y-auto{{ uppercase_class }}">
            {% for link in menu.links %}
              {%- liquid
                assign is_active = false
                if link.url == request.path
                  assign is_active = true
                elsif link.url != '/' and request.path contains link.url
                  assign is_active = true
                endif
                assign has_children = false
                if link.links.size > 0
                  assign has_children = true
                endif
              -%}
              <li class="mobile-nav__item overflow-hidden" style="--item-index: {{ forloop.index0 }}">
                {% if has_children %}
                  <button
                    type="button"
                    class="mobile-nav__link mobile-nav__link--parent font-heading flex items-center justify-between w-full gap-3 bg-none border-none cursor-pointer text-left{% if is_active %} is-active{% endif %}"
                    data-panel-trigger="panel-{{ forloop.index }}"
                  >
                    <span class="mobile-nav__link-text inline-block overflow-hidden">{{ link.title }}</span>
                    <i class="ph ph-caret-right mobile-nav__arrow-icon text-xl text-(--color-text-secondary)"></i>
                  </button>
                {% else %}
                  <a
                    href="{{ link.url }}"
                    class="mobile-nav__link font-heading block relative no-underline{% if is_active %} is-active{% endif %}"
                    data-mobile-nav-close
                    {% if is_active %}aria-current="page"{% endif %}
                  >
                    <span class="mobile-nav__link-text inline-block overflow-hidden">{{ link.title }}</span>
                  </a>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>

        {%- comment -%} Child Panels (Level 2) {%- endcomment -%}
        {% for link in menu.links %}
          {% if link.links.size > 0 %}
            <div class="mobile-nav__panel px-6 py-8" data-panel="panel-{{ forloop.index }}" data-panel-level="2" data-panel-parent="main">
              <div class="mobile-nav__panel-header flex items-center gap-4 mb-8">
                <button type="button" class="mobile-nav__back flex items-center justify-center w-10 h-10 -ml-2 bg-none border-none text-(--color-text) cursor-pointer" data-panel-back aria-label="Go back">
                  <i class="ph ph-arrow-left text-2xl"></i>
                </button>
                <span class="mobile-nav__panel-title font-heading text-(--color-text)">{{ link.title }}</span>
              </div>
              <ul class="mobile-nav__list list-none m-0 p-0 flex-1 overflow-y-auto{{ uppercase_class }}">
                {%- comment -%} View all link {%- endcomment -%}
                {% if link.url != '#' and link.url != '' %}
                  <li class="mobile-nav__item mobile-nav__item--view-all overflow-hidden">
                    <a
                      href="{{ link.url }}"
                      class="mobile-nav__link mobile-nav__link--view-all flex items-center justify-between !text-sm font-semibold uppercase tracking-widest text-(--color-primary) py-3 mb-2 border-b border-(--color-border) no-underline"
                      data-mobile-nav-close
                    >
                      <span class="mobile-nav__link-text">View All {{ link.title }}</span>
                      <i class="ph ph-arrow-right text-base"></i>
                    </a>
                  </li>
                {% endif %}

                {%- comment -%} Child links {%- endcomment -%}
                {% for child in link.links %}
                  {%- liquid
                    assign child_active = false
                    if child.url == request.path
                      assign child_active = true
                    endif
                    assign has_grandchildren = false
                    if child.links.size > 0
                      assign has_grandchildren = true
                    endif
                  -%}
                  <li class="mobile-nav__item overflow-hidden" style="--item-index: {{ forloop.index0 }}">
                    {% if has_grandchildren %}
                      <button
                        type="button"
                        class="mobile-nav__link mobile-nav__link--parent flex items-center justify-between w-full gap-3 bg-none border-none cursor-pointer text-left{% if child_active %} is-active{% endif %}"
                        data-panel-trigger="panel-{{ forloop.parentloop.index }}-{{ forloop.index }}"
                      >
                        <span class="mobile-nav__link-text inline-block overflow-hidden">{{ child.title }}</span>
                        <i class="ph ph-caret-right mobile-nav__arrow-icon text-xl text-(--color-text-secondary)"></i>
                      </button>
                    {% else %}
                      <a
                        href="{{ child.url }}"
                        class="mobile-nav__link block relative no-underline{% if child_active %} is-active{% endif %}"
                        data-mobile-nav-close
                        {% if child_active %}aria-current="page"{% endif %}
                      >
                        <span class="mobile-nav__link-text inline-block overflow-hidden">{{ child.title }}</span>
                      </a>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>

            {%- comment -%} Grandchild Panels (Level 3) {%- endcomment -%}
            {% for child in link.links %}
              {% if child.links.size > 0 %}
                <div class="mobile-nav__panel px-6 py-8" data-panel="panel-{{ forloop.parentloop.index }}-{{ forloop.index }}" data-panel-level="3" data-panel-parent="panel-{{ forloop.parentloop.index }}">
                  <div class="mobile-nav__panel-header flex items-center gap-4 mb-8">
                    <button type="button" class="mobile-nav__back flex items-center justify-center w-10 h-10 -ml-2 bg-none border-none text-(--color-text) cursor-pointer" data-panel-back aria-label="Go back">
                      <i class="ph ph-arrow-left text-2xl"></i>
                    </button>
                    <span class="mobile-nav__panel-title font-heading text-(--color-text)">{{ child.title }}</span>
                  </div>
                  <ul class="mobile-nav__list list-none m-0 p-0 flex-1 overflow-y-auto{{ uppercase_class }}">
                    {%- comment -%} View all link {%- endcomment -%}
                    {% if child.url != '#' and child.url != '' %}
                      <li class="mobile-nav__item mobile-nav__item--view-all overflow-hidden">
                        <a
                          href="{{ child.url }}"
                          class="mobile-nav__link mobile-nav__link--view-all flex items-center justify-between !text-sm font-semibold uppercase tracking-widest text-(--color-primary) py-3 mb-2 border-b border-(--color-border) no-underline"
                          data-mobile-nav-close
                        >
                          <span class="mobile-nav__link-text">View All {{ child.title }}</span>
                          <i class="ph ph-arrow-right text-base"></i>
                        </a>
                      </li>
                    {% endif %}

                    {%- comment -%} Grandchild links {%- endcomment -%}
                    {% for grandchild in child.links %}
                      {%- liquid
                        assign grandchild_active = false
                        if grandchild.url == request.path
                          assign grandchild_active = true
                        endif
                      -%}
                      <li class="mobile-nav__item overflow-hidden" style="--item-index: {{ forloop.index0 }}">
                        <a
                          href="{{ grandchild.url }}"
                          class="mobile-nav__link block relative no-underline{% if grandchild_active %} is-active{% endif %}"
                          data-mobile-nav-close
                          {% if grandchild_active %}aria-current="page"{% endif %}
                        >
                          <span class="mobile-nav__link-text inline-block overflow-hidden">{{ grandchild.title }}</span>
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      </nav>

    {% else %}
      {%- comment -%} ========================================
          ACCORDION NAVIGATION (original 2-level)
      ======================================== {%- endcomment -%}
      <nav class="mobile-nav__content flex-1 flex flex-col justify-center px-6 py-8 overflow-y-auto" data-lenis-prevent>
        <ul class="mobile-nav__list list-none m-0 p-0{{ uppercase_class }}">
          {% for link in menu.links %}
            {%- liquid
              assign is_active = false
              if link.url == request.path
                assign is_active = true
              elsif link.url != '/' and request.path contains link.url
                assign is_active = true
              endif
              assign has_children = false
              if link.links.size > 0
                assign has_children = true
              endif
            -%}
            <li class="mobile-nav__item overflow-hidden" style="--item-index: {{ forloop.index0 }}">
              {% if has_children %}
                {%- comment -%} Parent with submenu {%- endcomment -%}
                <div class="mobile-nav__parent relative" data-mobile-submenu>
                  <button
                    type="button"
                    class="mobile-nav__link mobile-nav__link--parent font-heading flex items-center gap-3 w-full bg-none border-none cursor-pointer text-left{% if is_active %} is-active{% endif %}"
                    data-mobile-submenu-toggle
                    aria-expanded="false"
                  >
                    <span class="mobile-nav__link-text inline-block overflow-hidden" data-mobile-nav-link-text>{{ link.title }}</span>
                    <i class="ph ph-plus mobile-nav__toggle-icon flex-shrink-0 transition-transform duration-400"></i>
                    <span class="mobile-nav__link-line"></span>
                  </button>

                  {%- comment -%} Submenu {%- endcomment -%}
                  <div class="mobile-nav__submenu grid overflow-hidden" data-mobile-submenu-panel>
                    <div class="mobile-nav__submenu-inner overflow-hidden">
                      {%- comment -%} View all link if parent has URL {%- endcomment -%}
                      {% if link.url != '#' and link.url != '' %}
                        <a
                          href="{{ link.url }}"
                          class="mobile-nav__submenu-all flex items-center justify-between py-3 pl-4 mt-2 text-sm font-semibold uppercase tracking-widest text-(--color-primary) no-underline transition-colors duration-200"
                          data-mobile-nav-close
                        >
                          <span>View All {{ link.title }}</span>
                          <i class="ph ph-arrow-right text-sm transition-transform duration-300"></i>
                        </a>
                      {% endif %}

                      {%- comment -%} Child links {%- endcomment -%}
                      {% for child in link.links %}
                        {%- liquid
                          assign child_active = false
                          if child.url == request.path
                            assign child_active = true
                          endif
                        -%}
                        <a
                          href="{{ child.url }}"
                          class="mobile-nav__submenu-link block relative pl-4 font-medium text-(--color-text-secondary) no-underline transition-all duration-300 hover:text-(--color-text) hover:translate-x-1{% if child_active %} is-active text-(--color-text){% endif %}"
                          data-mobile-nav-close
                          style="--child-index: {{ forloop.index0 }}"
                          {% if child_active %}aria-current="page"{% endif %}
                        >
                          <span class="mobile-nav__submenu-link-text inline-block">{{ child.title }}</span>
                          <span class="mobile-nav__submenu-link-line"></span>
                        </a>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              {% else %}
                <a
                  href="{{ link.url }}"
                  class="mobile-nav__link font-heading block relative no-underline{% if is_active %} is-active{% endif %}"
                  data-nav-link
                  data-mobile-nav-close
                  {% if is_active %}aria-current="page"{% endif %}
                >
                  <span class="mobile-nav__link-text inline-block overflow-hidden" data-mobile-nav-link-text>{{ link.title }}</span>
                  <span class="mobile-nav__link-line"></span>
                </a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </nav>
    {% endif %}

    {%- comment -%} Footer {%- endcomment -%}
    <div class="mobile-nav__footer p-5 border-t border-(--color-border)">
      <div class="mobile-nav__footer-links flex flex-wrap gap-4">
        {% if shop.customer_accounts_enabled %}
          <a href="{{ routes.account_url }}" class="mobile-nav__footer-link inline-flex items-center gap-2 text-sm font-semibold uppercase tracking-widest text-(--color-text-secondary) no-underline transition-colors duration-200 hover:text-(--color-text)" data-mobile-nav-close>
            <i class="ph ph-user text-lg"></i>
            <span>{{ 'accessibility.account' | t }}</span>
          </a>
        {% endif %}
        {% if show_search %}
          <a href="{{ routes.search_url }}" class="mobile-nav__footer-link inline-flex items-center gap-2 text-sm font-semibold uppercase tracking-widest text-(--color-text-secondary) no-underline transition-colors duration-200 hover:text-(--color-text)" data-mobile-nav-close>
            <i class="ph ph-magnifying-glass text-lg"></i>
            <span>{{ 'accessibility.search' | t }}</span>
          </a>
        {% endif %}
        {% if show_cart %}
          {% if settings.cart_type == 'drawer' %}
            <button
              type="button"
              class="mobile-nav__footer-link inline-flex items-center gap-2 text-sm font-semibold uppercase tracking-widest text-(--color-text-secondary) bg-transparent border-none cursor-pointer transition-colors duration-200 hover:text-(--color-text)"
              data-mobile-nav-close
              data-cart-drawer-toggle
            >
              <i class="ph ph-bag text-lg"></i>
              <span>Cart (<span data-cart-count>{{ cart.item_count }}</span>)</span>
            </button>
          {% else %}
            <a
              href="{{ routes.cart_url }}"
              class="mobile-nav__footer-link inline-flex items-center gap-2 text-sm font-semibold uppercase tracking-widest text-(--color-text-secondary) no-underline transition-colors duration-200 hover:text-(--color-text)"
              data-mobile-nav-close
            >
              <i class="ph ph-bag text-lg"></i>
              <span>Cart (<span data-cart-count>{{ cart.item_count }}</span>)</span>
            </a>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
