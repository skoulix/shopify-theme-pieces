{%- comment -%}
  Error Handling System
  Provides global error handling, toast notifications, and user-friendly error messages

  Include in theme.liquid: {% render 'error-handling' %}
{%- endcomment -%}

<style>
  /* Toast Container */
  .toast-container {
    position: fixed;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    display: flex;
    flex-direction: column-reverse;
    gap: 0.75rem;
    max-width: calc(100vw - 2rem);
    pointer-events: none;
  }

  @media (min-width: 640px) {
    .toast-container {
      bottom: 2rem;
      max-width: 400px;
    }
  }

  /* Toast Base */
  .toast {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: var(--color-text);
    color: var(--color-background);
    border-radius: var(--button-radius);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    font-size: 0.875rem;
    line-height: 1.4;
    pointer-events: auto;
    opacity: 0;
    transform: translateY(1rem) scale(0.95);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .toast--visible {
    opacity: 1;
    transform: translateY(0) scale(1);
  }

  .toast--leaving {
    opacity: 0;
    transform: translateY(-0.5rem) scale(0.95);
  }

  /* Toast Icon */
  .toast__icon {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    font-size: 1.125rem;
  }

  /* Toast Message */
  .toast__message {
    flex: 1;
    min-width: 0;
  }

  /* Toast Close Button */
  .toast__close {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    margin: -0.25rem -0.25rem -0.25rem 0;
    background: transparent;
    border: none;
    color: inherit;
    opacity: 0.6;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .toast__close:hover {
    opacity: 1;
  }

  /* Toast Types */
  .toast--success {
    background: #059669;
    color: white;
  }

  .toast--error {
    background: #dc2626;
    color: white;
  }

  .toast--warning {
    background: #d97706;
    color: white;
  }

  .toast--info {
    background: var(--color-text);
    color: var(--color-background);
  }

  /* Error Page Styles */
  .error-page {
    min-height: 60vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: var(--page-vertical-padding) var(--page-padding);
  }

  .error-page__icon {
    font-size: 4rem;
    color: var(--color-text-secondary);
    opacity: 0.3;
    margin-bottom: 1.5rem;
  }

  .error-page__title {
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    font-weight: 700;
    margin-bottom: 0.75rem;
  }

  .error-page__message {
    color: var(--color-text-secondary);
    max-width: 28rem;
    margin-bottom: 2rem;
  }

  /* Inline Error Styles */
  .inline-error {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: var(--input-radius);
    color: #991b1b;
    font-size: 0.875rem;
    margin-top: 0.5rem;
  }

  .inline-error__icon {
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  /* Form Error States */
  .has-error input,
  .has-error select,
  .has-error textarea {
    border-color: #dc2626;
  }

  .has-error input:focus,
  .has-error select:focus,
  .has-error textarea:focus {
    outline-color: #dc2626;
    border-color: #dc2626;
  }

  /* Loading/Error Overlay */
  .error-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(var(--color-background-rgb, 255, 255, 255), 0.9);
    backdrop-filter: blur(4px);
    z-index: 10;
  }

  .error-overlay__icon {
    font-size: 2.5rem;
    color: #dc2626;
    margin-bottom: 1rem;
  }

  .error-overlay__message {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    text-align: center;
    max-width: 16rem;
  }

  .error-overlay__retry {
    margin-top: 1rem;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .toast {
      transition: opacity 0.15s ease;
      transform: none;
    }

    .toast--visible,
    .toast--leaving {
      transform: none;
    }
  }
</style>

<script>
/**
 * Global Error Handler
 * Provides centralized error handling and user-friendly notifications
 */
window.errorHandler = window.errorHandler || (function() {
  'use strict';

  // Error messages with translations
  const messages = {
    network: `{{ 'errors.network' | t | default: 'Network error. Please check your connection and try again.' }}`,
    server: `{{ 'errors.server' | t | default: 'Something went wrong. Please try again later.' }}`,
    cart_add: `{{ 'errors.cart_add' | t | default: 'Could not add item to cart. Please try again.' }}`,
    cart_update: `{{ 'errors.cart_update' | t | default: 'Could not update cart. Please try again.' }}`,
    cart_remove: `{{ 'errors.cart_remove' | t | default: 'Could not remove item. Please try again.' }}`,
    form_submit: `{{ 'errors.form_submit' | t | default: 'Could not submit form. Please try again.' }}`,
    validation: `{{ 'errors.validation' | t | default: 'Please check your input and try again.' }}`,
    unauthorized: `{{ 'errors.unauthorized' | t | default: 'Please log in to continue.' }}`,
    not_found: `{{ 'errors.not_found' | t | default: 'The requested item was not found.' }}`,
    out_of_stock: `{{ 'errors.out_of_stock' | t | default: 'This item is currently out of stock.' }}`,
    generic: `{{ 'errors.generic' | t | default: 'An error occurred. Please try again.' }}`
  };

  /**
   * Show error toast notification
   * @param {string} message - Error message or key
   * @param {Object} options - Additional options
   */
  function showError(message, options = {}) {
    const text = messages[message] || message || messages.generic;
    showToast(text, { type: 'error', ...options });
  }

  /**
   * Show success toast notification
   * @param {string} message - Success message
   * @param {Object} options - Additional options
   */
  function showSuccess(message, options = {}) {
    showToast(message, { type: 'success', ...options });
  }

  /**
   * Show info toast notification
   * @param {string} message - Info message
   * @param {Object} options - Additional options
   */
  function showInfo(message, options = {}) {
    showToast(message, { type: 'info', ...options });
  }

  /**
   * Show warning toast notification
   * @param {string} message - Warning message
   * @param {Object} options - Additional options
   */
  function showWarning(message, options = {}) {
    showToast(message, { type: 'warning', ...options });
  }

  /**
   * Show toast notification
   * @param {string} message - Message to display
   * @param {Object} options - Toast options
   */
  function showToast(message, options = {}) {
    const { type = 'info', duration = type === 'error' ? 5000 : 4000 } = options;

    // Ensure container exists
    let container = document.querySelector('.toast-container');
    if (!container) {
      container = document.createElement('div');
      container.className = 'toast-container';
      container.setAttribute('role', 'status');
      container.setAttribute('aria-live', 'polite');
      document.body.appendChild(container);
    }

    // Create toast
    const toast = document.createElement('div');
    toast.className = `toast toast--${type}`;
    toast.innerHTML = `
      <span class="toast__icon">
        <i class="ph ${getIcon(type)}" aria-hidden="true"></i>
      </span>
      <span class="toast__message">${escapeHtml(message)}</span>
      <button class="toast__close" aria-label="{{ 'accessibility.close' | t | default: 'Dismiss' }}">
        <i class="ph ph-x" aria-hidden="true"></i>
      </button>
    `;

    // Close handler
    const closeBtn = toast.querySelector('.toast__close');
    closeBtn.addEventListener('click', () => dismissToast(toast), { once: true });

    // Add to container
    container.appendChild(toast);

    // Trigger animation
    requestAnimationFrame(() => {
      toast.classList.add('toast--visible');
    });

    // Auto dismiss
    if (duration > 0) {
      setTimeout(() => dismissToast(toast), duration);
    }

    // Announce to screen readers
    if (window.a11y?.announce) {
      window.a11y.announce(message, type === 'error' ? 'assertive' : 'polite');
    }

    return toast;
  }

  /**
   * Dismiss a toast
   */
  function dismissToast(toast) {
    if (!toast || !toast.parentNode) return;

    toast.classList.remove('toast--visible');
    toast.classList.add('toast--leaving');

    setTimeout(() => {
      toast.remove();
    }, 300);
  }

  /**
   * Get icon class for toast type
   */
  function getIcon(type) {
    const icons = {
      success: 'ph-check-circle',
      error: 'ph-warning-circle',
      warning: 'ph-warning',
      info: 'ph-info'
    };
    return icons[type] || icons.info;
  }

  /**
   * Escape HTML to prevent XSS
   */
  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  /**
   * Handle fetch errors
   * @param {Response} response - Fetch response
   * @returns {Promise} - Resolved or rejected promise
   */
  async function handleFetchError(response) {
    if (response.ok) return response;

    let errorMessage;
    switch (response.status) {
      case 400:
        errorMessage = 'validation';
        break;
      case 401:
        errorMessage = 'unauthorized';
        break;
      case 404:
        errorMessage = 'not_found';
        break;
      case 422:
        // Shopify specific - often inventory issues
        try {
          const data = await response.json();
          if (data.description?.includes('inventory')) {
            errorMessage = 'out_of_stock';
          } else {
            errorMessage = data.description || 'validation';
          }
        } catch {
          errorMessage = 'validation';
        }
        break;
      case 500:
      case 502:
      case 503:
        errorMessage = 'server';
        break;
      default:
        errorMessage = 'generic';
    }

    throw new Error(errorMessage);
  }

  /**
   * Wrap fetch with error handling
   * @param {string} url - URL to fetch
   * @param {Object} options - Fetch options
   * @returns {Promise} - Fetch promise with error handling
   */
  async function safeFetch(url, options = {}) {
    try {
      const response = await fetch(url, options);
      return await handleFetchError(response);
    } catch (error) {
      if (error.name === 'TypeError') {
        // Network error
        throw new Error('network');
      }
      throw error;
    }
  }

  // Global unhandled rejection handler
  window.addEventListener('unhandledrejection', (event) => {
    // Only show toast for non-suppressed errors
    if (event.reason?.showToast !== false) {
      console.error('Unhandled promise rejection:', event.reason);
      // Don't show toast for every unhandled rejection to avoid spam
      // Just log it - specific handlers should show toasts
    }
  });

  // Public API
  return {
    showError,
    showSuccess,
    showInfo,
    showWarning,
    showToast,
    dismissToast,
    handleFetchError,
    safeFetch,
    messages
  };
})();

// Expose globally for easy access
window.toast = {
  error: window.errorHandler.showError,
  success: window.errorHandler.showSuccess,
  info: window.errorHandler.showInfo,
  warning: window.errorHandler.showWarning,
  show: window.errorHandler.showToast
};
</script>
