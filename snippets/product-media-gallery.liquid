{% comment %}
  Renders a product media gallery - Tailwind version
  Modern, minimal design with smooth interactions

  Accepts:
  - product: {Object} Product liquid object
  - variant_images: {Array} Product images associated with a variant
  - limit: {Number} (optional) When passed, limits the number of media items to render

  Usage:
  {% render 'product-media-gallery' %}
{% endcomment %}

{%- liquid
  if section.settings.hide_variants and variant_images.size == product.media.size
    assign single_media_visible = true
  endif

  if limit == 1
    assign single_media_visible = true
  endif

  assign media_count = product.media.size
  if section.settings.hide_variants and media_count > 1 and variant_images.size > 0
    assign media_count = media_count | minus: variant_images.size | plus: 1
  endif

  if media_count == 1 or single_media_visible
    assign single_media_visible_mobile = true
  endif

  if media_count == 0 or single_media_visible_mobile or section.settings.mobile_thumbnails == 'show' or section.settings.mobile_thumbnails == 'columns' and media_count < 3
    assign hide_mobile_slider = true
  endif
-%}

<media-gallery
  id="MediaGallery-{{ section.id }}"
  role="region"
  class="{% if section.settings.enable_sticky_info %}lg:sticky lg:top-24{% endif %}"
  aria-label="{{ 'products.product.media.gallery_viewer' | t }}"
  data-desktop-layout="{{ section.settings.gallery_layout }}"
>
  <div id="GalleryStatus-{{ section.id }}" class="sr-only" role="status"></div>

  {%- comment -%} Main Image Slider {%- endcomment -%}
  <slider-component id="GalleryViewer-{{ section.id }}" class="relative">
    <a class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-10 bg-white px-4 py-2 rounded-lg" href="#ProductInfo-{{ section.id }}">
      {{ 'accessibility.skip_to_product_info' | t }}
    </a>

    <ul
      id="Slider-Gallery-{{ section.id }}"
      class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide gap-4 lg:flex-col lg:overflow-visible"
      role="list"
    >
      {%- if product.selected_or_first_available_variant.featured_media != null -%}
        {%- assign featured_media = product.selected_or_first_available_variant.featured_media -%}
        <li
          id="Slide-{{ section.id }}-{{ featured_media.id }}"
          class="flex-shrink-0 w-full snap-center lg:w-auto"
          data-media-id="{{ section.id }}-{{ featured_media.id }}"
        >
          {%- assign media_position = 1 -%}
          {% render 'product-thumbnail',
            media: featured_media,
            media_count: media_count,
            position: media_position,
            desktop_layout: section.settings.gallery_layout,
            mobile_layout: section.settings.mobile_thumbnails,
            loop: section.settings.enable_video_looping,
            modal_id: section.id,
            xr_button: true,
            media_fit: section.settings.media_fit,
            constrain_to_viewport: section.settings.constrain_to_viewport,
            lazy_load: false
          %}
        </li>
      {%- endif -%}

      {%- for media in product.media -%}
        {% if media_position >= limit
          or media_position >= 1
          and section.settings.hide_variants
          and variant_images contains media.src
        %}
          {% continue %}
        {% endif %}

        {%- unless media.id == product.selected_or_first_available_variant.featured_media.id -%}
          <li
            id="Slide-{{ section.id }}-{{ media.id }}"
            class="flex-shrink-0 w-full snap-center lg:w-auto {% if section.settings.gallery_layout == 'stacked' %}lg:mb-4{% endif %}"
            data-media-id="{{ section.id }}-{{ media.id }}"
          >
            {%- liquid
              assign media_position = media_position | default: 0 | plus: 1
              assign lazy_load = false
              if media_position > 1
                assign lazy_load = true
              endif
            -%}
            {% render 'product-thumbnail',
              media: media,
              media_count: media_count,
              position: media_position,
              desktop_layout: section.settings.gallery_layout,
              mobile_layout: section.settings.mobile_thumbnails,
              loop: section.settings.enable_video_looping,
              modal_id: section.id,
              xr_button: true,
              media_fit: section.settings.media_fit,
              constrain_to_viewport: section.settings.constrain_to_viewport,
              lazy_load: lazy_load
            %}
          </li>
        {%- endunless -%}
      {%- endfor -%}
    </ul>

    {%- comment -%} Mobile Slider Controls {%- endcomment -%}
    {%- unless hide_mobile_slider -%}
      <div class="flex items-center justify-center gap-4 mt-4 lg:hidden">
        <button
          type="button"
          class="slider-button slider-button--prev p-2 rounded-full bg-neutral-100 hover:bg-neutral-200 transition-colors disabled:opacity-40"
          name="previous"
          aria-label="{{ 'general.slider.previous_slide' | t }}"
        >
          {%- render 'icon', name: 'caret-left', size: '20' -%}
        </button>
        <div class="text-sm text-neutral-600">
          <span class="slider-counter--current">1</span>
          <span> / </span>
          <span class="slider-counter--total">{{ media_count }}</span>
        </div>
        <button
          type="button"
          class="slider-button slider-button--next p-2 rounded-full bg-neutral-100 hover:bg-neutral-200 transition-colors disabled:opacity-40"
          name="next"
          aria-label="{{ 'general.slider.next_slide' | t }}"
        >
          {%- render 'icon', name: 'caret-right', size: '20' -%}
        </button>
      </div>
    {%- endunless -%}
  </slider-component>

  {%- comment -%} 3D Model Button {%- endcomment -%}
  {%- if first_3d_model -%}
    <button
      class="mt-4 w-full flex items-center justify-center gap-2 py-3 px-4 bg-neutral-900 text-white text-sm font-medium rounded-lg hover:bg-neutral-800 transition-colors"
      type="button"
      aria-label="{{ 'products.product.xr_button_label' | t }}"
      data-shopify-xr
      data-shopify-model3d-id="{{ first_3d_model.id }}"
      data-shopify-title="{{ product.title | escape }}"
      data-shopify-xr-hidden
    >
      {%- render 'icon', name: 'cube', size: '20' -%}
      {{ 'products.product.xr_button' | t }}
    </button>
  {%- endif -%}

  {%- comment -%} Thumbnails {%- endcomment -%}
  {%- liquid
    assign is_not_limited_to_single_item = false
    if limit == null or limit > 1
      assign is_not_limited_to_single_item = true
    endif
  -%}

  {%- if is_not_limited_to_single_item
    and media_count > 1
    and section.settings.gallery_layout contains 'thumbnail'
    or section.settings.mobile_thumbnails == 'show'
  -%}
    <slider-component
      id="GalleryThumbnails-{{ section.id }}"
      class="mt-4 {% unless section.settings.gallery_layout contains 'thumbnail' %}hidden lg:hidden{% endunless %}{% if section.settings.mobile_thumbnails != 'show' %} hidden sm:block{% endif %}"
    >
      <div class="flex items-center gap-2">
        {%- if media_count > 4 -%}
          <button
            type="button"
            class="flex-shrink-0 p-1 rounded-full hover:bg-neutral-100 transition-colors"
            name="previous"
            aria-label="{{ 'general.slider.previous_slide' | t }}"
            aria-controls="GalleryThumbnails-{{ section.id }}"
            data-step="3"
          >
            {%- render 'icon', name: 'caret-left', size: '16' -%}
          </button>
        {%- endif -%}

        <ul
          id="Slider-Thumbnails-{{ section.id }}"
          class="flex-1 flex gap-2 overflow-x-auto scrollbar-hide"
        >
          {%- if featured_media != null -%}
            <li
              id="Slide-Thumbnails-{{ section.id }}-0"
              class="flex-shrink-0"
              data-target="{{ section.id }}-{{ featured_media.id }}"
            >
              <button
                class="thumbnail relative w-16 h-16 rounded-lg overflow-hidden border-2 border-transparent hover:border-neutral-300 focus:border-neutral-900 transition-colors aria-current:border-neutral-900"
                aria-current="true"
                aria-controls="GalleryViewer-{{ section.id }}"
              >
                <img
                  src="{{ featured_media.preview_image | image_url: width: 200 }}"
                  alt="{{ featured_media.alt | escape }}"
                  class="w-full h-full object-cover"
                  loading="lazy"
                  width="64"
                  height="64"
                >
              </button>
            </li>
          {%- endif -%}

          {%- for media in product.media -%}
            {%- unless media.id == product.selected_or_first_available_variant.featured_media.id -%}
              <li
                id="Slide-Thumbnails-{{ section.id }}-{{ forloop.index }}"
                class="flex-shrink-0 {% if section.settings.hide_variants and variant_images contains media.src %}hidden{% endif %}"
                data-target="{{ section.id }}-{{ media.id }}"
              >
                <button
                  class="thumbnail relative w-16 h-16 rounded-lg overflow-hidden border-2 border-transparent hover:border-neutral-300 focus:border-neutral-900 transition-colors"
                  aria-controls="GalleryViewer-{{ section.id }}"
                >
                  {%- if media.media_type == 'model' -%}
                    <span class="absolute inset-0 flex items-center justify-center bg-black/30 text-white">
                      {%- render 'icon', name: 'cube', size: '20' -%}
                    </span>
                  {%- elsif media.media_type == 'video' or media.media_type == 'external_video' -%}
                    <span class="absolute inset-0 flex items-center justify-center bg-black/30 text-white">
                      {%- render 'icon', name: 'play', size: '20' -%}
                    </span>
                  {%- endif -%}
                  <img
                    src="{{ media.preview_image | image_url: width: 200 }}"
                    alt="{{ media.alt | escape }}"
                    class="w-full h-full object-cover"
                    loading="lazy"
                    width="64"
                    height="64"
                  >
                </button>
              </li>
            {%- endunless -%}
          {%- endfor -%}
        </ul>

        {%- if media_count > 4 -%}
          <button
            type="button"
            class="flex-shrink-0 p-1 rounded-full hover:bg-neutral-100 transition-colors"
            name="next"
            aria-label="{{ 'general.slider.next_slide' | t }}"
            aria-controls="GalleryThumbnails-{{ section.id }}"
            data-step="3"
          >
            {%- render 'icon', name: 'caret-right', size: '16' -%}
          </button>
        {%- endif -%}
      </div>
    </slider-component>
  {%- endif -%}
</media-gallery>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
