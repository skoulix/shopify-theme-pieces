{% comment %}
  Renders a product media gallery - Tailwind UI Design
  Tab-based gallery with thumbnail selector

  Accepts:
  - product: {Object} Product liquid object
  - variant_images: {Array} Product images associated with a variant
  - limit: {Number} (optional) When passed, limits the number of media items to render

  Usage:
  {% render 'product-media-gallery' %}
{% endcomment %}

{%- liquid
  if section.settings.hide_variants and variant_images.size == product.media.size
    assign single_media_visible = true
  endif

  if limit == 1
    assign single_media_visible = true
  endif

  assign media_count = product.media.size
  if section.settings.hide_variants and media_count > 1 and variant_images.size > 0
    assign media_count = media_count | minus: variant_images.size | plus: 1
  endif

  if media_count == 1 or single_media_visible
    assign single_media_visible_mobile = true
  endif

  if media_count == 0 or single_media_visible_mobile or section.settings.mobile_thumbnails == 'show' or section.settings.mobile_thumbnails == 'columns' and media_count < 3
    assign hide_mobile_slider = true
  endif

  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
-%}

<product-lightbox
  id="MediaGallery-{{ section.id }}"
  role="region"
  class="flex flex-col-reverse"
  aria-label="{{ 'products.product.media.gallery_viewer' | t }}"
  data-desktop-layout="{{ section.settings.gallery_layout }}"
>
  <div id="GalleryStatus-{{ section.id }}" class="sr-only" role="status"></div>

  {%- comment -%} Thumbnail Selector (shown below main image) {%- endcomment -%}
  {%- if media_count > 1 -%}
    <div class="mx-auto mt-6 hidden w-full max-w-2xl sm:block lg:max-w-none">
      <div class="grid grid-cols-4 gap-6" role="tablist" aria-label="{{ 'products.product.media.gallery_viewer' | t }}">
        {%- assign thumb_index = 0 -%}
        {%- for media in product.media -%}
          {%- if section.settings.hide_variants and variant_images contains media.src -%}
            {%- continue -%}
          {%- endif -%}
          <button
            type="button"
            role="tab"
            aria-selected="{% if media.id == featured_media.id %}true{% else %}false{% endif %}"
            aria-controls="panel-{{ section.id }}-{{ media.id }}"
            id="tab-{{ section.id }}-{{ media.id }}"
            class="thumbnail-tab relative flex h-24 cursor-pointer items-center justify-center rounded-md bg-white text-sm font-medium uppercase text-gray-900 hover:bg-gray-50 focus:outline-none focus:ring focus:ring-indigo-500/50 focus:ring-offset-4"
            data-media-id="{{ media.id }}"
          >
            <span class="sr-only">{{ media.alt | default: product.title | escape }}</span>
            <span class="absolute inset-0 overflow-hidden rounded-md">
              <img
                src="{{ media.preview_image | image_url: width: 200 }}"
                alt=""
                class="size-full object-cover"
                loading="{% if thumb_index < 4 %}eager{% else %}lazy{% endif %}"
                width="200"
                height="200"
              >
              {%- if media.media_type == 'video' or media.media_type == 'external_video' -%}
                <span class="absolute inset-0 flex items-center justify-center bg-black/30">
                  <svg class="size-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </span>
              {%- elsif media.media_type == 'model' -%}
                <span class="absolute inset-0 flex items-center justify-center bg-black/30">
                  <svg class="size-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9"/>
                  </svg>
                </span>
              {%- endif -%}
            </span>
            <span aria-hidden="true" class="pointer-events-none absolute inset-0 rounded-md ring-2 ring-transparent ring-offset-2 [[aria-selected='true']&]:ring-indigo-500"></span>
          </button>
          {%- assign thumb_index = thumb_index | plus: 1 -%}
        {%- endfor -%}
      </div>
    </div>
  {%- endif -%}

  {%- comment -%} Main Image Panels {%- endcomment -%}
  <div class="aspect-square w-full" role="tabpanel" id="main-panel-{{ section.id }}">
    <a class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-10 bg-white px-4 py-2 rounded-lg" href="#ProductInfo-{{ section.id }}">
      {{ 'accessibility.skip_to_product_info' | t }}
    </a>

    {%- for media in product.media -%}
      {%- if section.settings.hide_variants and variant_images contains media.src -%}
        {%- continue -%}
      {%- endif -%}
      <div
        id="panel-{{ section.id }}-{{ media.id }}"
        role="tabpanel"
        aria-labelledby="tab-{{ section.id }}-{{ media.id }}"
        class="media-panel {% if media.id != featured_media.id %}hidden{% endif %}"
        data-media-id="{{ media.id }}"
      >
        {%- case media.media_type -%}
          {%- when 'image' -%}
            <a
              href="{{ media | image_url: width: 2048 }}"
              class="block cursor-zoom-in"
              data-lightbox
              data-no-swup
              data-pswp-width="{{ media.width | default: 1920 }}"
              data-pswp-height="{{ media.height | default: 1280 }}"
              data-media-type="image"
              data-alt="{{ media.alt | escape }}"
              data-media-id="{{ media.id }}"
            >
              <img
                src="{{ media | image_url: width: 1200 }}"
                alt="{{ media.alt | default: product.title | escape }}"
                class="aspect-square w-full object-cover sm:rounded-lg"
                loading="{% if media.id == featured_media.id %}eager{% else %}lazy{% endif %}"
                width="{{ media.width }}"
                height="{{ media.height }}"
              >
            </a>

          {%- when 'video' -%}
            {%- assign video_sources = media.sources | where: 'format', 'mp4' -%}
            {%- assign video_url = video_sources.first.url | default: media.sources.first.url -%}
            <a
              href="{{ video_url }}"
              class="block relative cursor-pointer"
              data-lightbox
              data-no-swup
              data-src="{{ video_url }}"
              data-media-type="video"
              data-video-host="local"
              data-alt="{{ media.alt | escape }}"
              data-media-id="{{ media.id }}"
            >
              <img
                src="{{ media.preview_image | image_url: width: 1200 }}"
                alt="{{ media.alt | default: product.title | escape }}"
                class="aspect-square w-full object-cover sm:rounded-lg"
                loading="lazy"
              >
              <span class="absolute inset-0 flex items-center justify-center">
                <span class="flex items-center justify-center w-16 h-16 bg-white/90 backdrop-blur-sm rounded-full text-gray-900 shadow-lg">
                  <svg class="size-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </span>
              </span>
            </a>

          {%- when 'external_video' -%}
            <a
              href="{% if media.host == 'youtube' %}https://www.youtube.com/watch?v={{ media.external_id }}{% else %}https://vimeo.com/{{ media.external_id }}{% endif %}"
              class="block relative cursor-pointer"
              data-lightbox
              data-no-swup
              data-src="{% if media.host == 'youtube' %}https://www.youtube.com/watch?v={{ media.external_id }}{% else %}https://vimeo.com/{{ media.external_id }}{% endif %}"
              data-media-type="external_video"
              data-video-host="{{ media.host }}"
              data-alt="{{ media.alt | escape }}"
              data-media-id="{{ media.id }}"
            >
              <img
                src="{{ media.preview_image | image_url: width: 1200 }}"
                alt="{{ media.alt | default: product.title | escape }}"
                class="aspect-square w-full object-cover sm:rounded-lg"
                loading="lazy"
              >
              <span class="absolute inset-0 flex items-center justify-center">
                <span class="flex items-center justify-center w-16 h-16 bg-white/90 backdrop-blur-sm rounded-full text-gray-900 shadow-lg">
                  <svg class="size-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </span>
              </span>
            </a>

          {%- when 'model' -%}
            <product-model class="block deferred-media" data-media-id="{{ media.id }}">
              <button id="Deferred-Poster-Modal-{{ media.id }}" class="block w-full relative group" type="button">
                <img
                  src="{{ media.preview_image | image_url: width: 1200 }}"
                  alt="{{ media.alt | default: product.title | escape }}"
                  class="aspect-square w-full object-cover sm:rounded-lg"
                  loading="lazy"
                >
                <span class="absolute inset-0 flex items-center justify-center">
                  <span class="flex items-center justify-center w-16 h-16 bg-white/90 backdrop-blur-sm rounded-full text-gray-900 shadow-lg group-hover:scale-110 transition-transform">
                    <span class="sr-only">{{ 'products.product.media.play_model' | t }}</span>
                    <svg class="size-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9"/>
                    </svg>
                  </span>
                </span>
              </button>
              <template>
                {{ media | media_tag: image_size: '2048x', toggleable: true }}
              </template>
            </product-model>
        {%- endcase -%}
      </div>
    {%- endfor -%}
  </div>

  {%- comment -%} Mobile Slider (below sm breakpoint) {%- endcomment -%}
  {%- unless hide_mobile_slider -%}
    <div class="flex items-center justify-center gap-2 mt-4 sm:hidden">
      {%- for media in product.media -%}
        {%- if section.settings.hide_variants and variant_images contains media.src -%}
          {%- continue -%}
        {%- endif -%}
        <button
          type="button"
          class="mobile-dot w-2 h-2 rounded-full transition-colors {% if media.id == featured_media.id %}bg-gray-900{% else %}bg-gray-300{% endif %}"
          data-media-id="{{ media.id }}"
          aria-label="{{ 'products.product.media.load_image' | t: index: forloop.index }}"
        ></button>
      {%- endfor -%}
    </div>
  {%- endunless -%}
</product-lightbox>

<script>
  // Tab-based gallery functionality
  document.addEventListener('DOMContentLoaded', function() {
    const gallery = document.getElementById('MediaGallery-{{ section.id }}');
    if (!gallery) return;

    const tabs = gallery.querySelectorAll('.thumbnail-tab');
    const panels = gallery.querySelectorAll('.media-panel');
    const mobileDots = gallery.querySelectorAll('.mobile-dot');

    function showMedia(mediaId) {
      // Update panels
      panels.forEach(panel => {
        const isActive = panel.dataset.mediaId == mediaId;
        panel.classList.toggle('hidden', !isActive);
      });

      // Update tabs
      tabs.forEach(tab => {
        const isActive = tab.dataset.mediaId == mediaId;
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });

      // Update mobile dots
      mobileDots.forEach(dot => {
        const isActive = dot.dataset.mediaId == mediaId;
        dot.classList.toggle('bg-gray-900', isActive);
        dot.classList.toggle('bg-gray-300', !isActive);
      });
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => showMedia(tab.dataset.mediaId));
    });

    mobileDots.forEach(dot => {
      dot.addEventListener('click', () => showMedia(dot.dataset.mediaId));
    });

    // Listen for variant changes to update featured media
    document.addEventListener('variant:change', function(e) {
      if (e.detail && e.detail.variant && e.detail.variant.featured_media) {
        showMedia(e.detail.variant.featured_media.id);
      }
    });
  });
</script>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
