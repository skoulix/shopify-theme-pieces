{%- comment -%}
  Newsletter Popup
  Triggered by time delay, scroll percentage, or exit intent
  Stores dismissal state in localStorage
{%- endcomment -%}

{%- if settings.popup_enabled -%}
  {%- liquid
    assign popup_bg = settings.popup_bg
    assign popup_text = settings.popup_text_color
    assign btn_bg = settings.popup_btn_bg
    assign btn_text = settings.popup_btn_text
    assign layout = settings.popup_layout
    assign size = settings.popup_size
    assign image = settings.popup_image

    # Size classes for popup width
    case size
      when 'small'
        assign size_class = 'max-w-sm'
        assign side_size_class = 'max-w-xl'
      when 'medium'
        assign size_class = 'max-w-md'
        assign side_size_class = 'max-w-2xl'
      when 'large'
        assign size_class = 'max-w-lg'
        assign side_size_class = 'max-w-4xl'
    endcase
  -%}

  {%- comment -%} CSS for dynamic colors (requires inline style for theme settings) {%- endcomment -%}
  <style>
    #newsletter-popup-wrapper {
      --popup-bg: {{ popup_bg }};
      --popup-text: {{ popup_text }};
      --btn-bg: {{ btn_bg }};
      --btn-text: {{ btn_text }};
    }

    /* Override primary button colors with popup theme settings */
    #newsletter-popup-wrapper .btn--primary {
      background-color: var(--btn-bg);
      color: var(--btn-text);
      border-color: var(--btn-bg);
    }

    #newsletter-popup-wrapper .btn--primary::before {
      background: var(--btn-text);
    }

    #newsletter-popup-wrapper .btn--primary:hover,
    #newsletter-popup-wrapper .btn--primary:hover span {
      color: var(--btn-bg);
    }

    {% unless settings.popup_show_mobile %}
      @media (max-width: 639px) {
        #newsletter-popup-wrapper {
          display: none !important;
        }
      }
    {% endunless %}
  </style>

  <div id="newsletter-popup-wrapper" class="contents">
    {%- comment -%} Overlay {%- endcomment -%}
    <div
      class="drawer-backdrop fixed inset-0 z-[9998] opacity-0 invisible pointer-events-none [&.is-visible]:opacity-100 [&.is-visible]:visible [&.is-visible]:pointer-events-auto transition-all duration-300"
      data-newsletter-popup-overlay
    ></div>

    {%- comment -%} Popup {%- endcomment -%}
    <div
      class="fixed top-1/2 left-1/2 z-[9999] w-[90vw] overflow-hidden overflow-y-auto max-h-[90vh] transition-all duration-300 -translate-x-1/2 -translate-y-1/2 scale-95 opacity-0 invisible pointer-events-none [&.is-visible]:scale-100 [&.is-visible]:opacity-100 [&.is-visible]:visible [&.is-visible]:pointer-events-auto {% if layout == 'side_image' and image %}flex {{ side_size_class }}{% else %}{{ size_class }}{% endif %}"
      style="background-color: var(--popup-bg); color: var(--popup-text); border-radius: {{ settings.card_radius }}px; border: 1px solid color-mix(in srgb, var(--popup-text) 15%, transparent); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);"
      data-newsletter-popup
      role="dialog"
      aria-modal="true"
      aria-labelledby="newsletter-popup-title"
      aria-describedby="newsletter-popup-description"
    >
    {%- comment -%} Side image {%- endcomment -%}
    {% if layout == 'side_image' and image %}
      <div class="hidden sm:block relative flex-[0_0_45%]">
        <img
          src="{{ image | image_url: width: 600 }}"
          alt=""
          width="600"
          height="{{ 600 | divided_by: image.aspect_ratio | round }}"
          loading="lazy"
          decoding="async"
          class="absolute inset-0 w-full h-full object-cover"
        >
      </div>
    {% endif %}

    {%- comment -%} Content {%- endcomment -%}
    <div class="flex-1 p-8 {% if layout == 'side_image' and image %}sm:p-10{% endif %}">
      {%- comment -%} Close button {%- endcomment -%}
      <button
        class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center bg-transparent border-none cursor-pointer opacity-60 hover:opacity-100 transition-opacity z-10 text-[--popup-text]"
        data-newsletter-popup-close
        aria-label="{{ 'accessibility.close' | t }}"
      >
        <i class="ph ph-x" aria-hidden="true"></i>
      </button>

      {%- comment -%} Form container {%- endcomment -%}
      <div data-newsletter-popup-form-container>
        <h2 class="text-2xl font-semibold mb-3 leading-tight font-heading" id="newsletter-popup-title">
          {{ settings.popup_title }}
        </h2>

        {% if settings.popup_text != blank %}
          <p class="text-[15px] opacity-70 mb-6 leading-relaxed" id="newsletter-popup-description">{{ settings.popup_text }}</p>
        {% endif %}

        {% form 'customer', id: 'newsletter-popup-form', class: 'flex flex-col gap-3' %}
          <input
            type="email"
            name="contact[email]"
            class="w-full py-3 px-4 text-[15px] bg-transparent border transition-colors focus:outline-none focus:ring-2 focus:ring-current focus:ring-offset-2"
            style="color: var(--popup-text); border-color: color-mix(in srgb, var(--popup-text) 20%, transparent); border-radius: {{ settings.input_radius }}px;"
            placeholder="{{ settings.popup_placeholder }}"
            required
            autocomplete="email"
            aria-label="{{ 'customers.register.email' | t }}"
          >
          <input type="hidden" name="contact[tags]" value="newsletter,popup">
          <button
            type="submit"
            class="btn btn--primary btn--full"
          >
            <span>{{ settings.popup_button_text }}</span>
          </button>
        {% endform %}

        <div class="mt-4 text-center">
          <button
            class="bg-transparent border-none text-[13px] opacity-50 cursor-pointer underline hover:opacity-80 transition-opacity text-[--popup-text]"
            data-newsletter-popup-close
          >
            {{ 'general.newsletter.no_thanks' | t }}
          </button>
        </div>
      </div>

      {%- comment -%} Success state {%- endcomment -%}
      <div data-newsletter-popup-success class="hidden" role="status" aria-live="polite">
        <p class="text-center py-3 text-sm text-green-500">
          {{ settings.popup_success_msg }}
        </p>

        {% if settings.popup_show_discount and settings.popup_discount_code != blank %}
          <div class="mt-6 p-4 text-center" style="background-color: color-mix(in srgb, var(--popup-text) 5%, transparent); border-radius: {{ settings.card_radius }}px;">
            {%- assign discount_msg = settings.popup_discount_msg | replace: '{code}', settings.popup_discount_code -%}
            <p>{{ discount_msg }}</p>
            <button
              type="button"
              class="inline-flex items-center gap-2 mt-2 py-2 px-4 font-mono text-lg font-semibold tracking-widest cursor-pointer transition-colors hover:bg-black/5 border-none"
              style="background-color: color-mix(in srgb, var(--popup-text) 8%, transparent); color: inherit; border-radius: {{ settings.input_radius }}px;"
              data-discount-code="{{ settings.popup_discount_code }}"
              aria-label="{{ 'general.newsletter.copy_code' | t }}: {{ settings.popup_discount_code }}"
            >
              <span aria-hidden="true">{{ settings.popup_discount_code }}</span>
              <i class="ph ph-copy text-base opacity-60" aria-hidden="true"></i>
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  </div>

  <script>
    (function() {
      const STORAGE_KEY = 'pieces_newsletter_popup';
      const DAYS_HIDDEN = {{ settings.popup_days_dismiss }};
      const DAYS_HIDDEN_AFTER_SIGNUP = {{ settings.popup_days_signup }};
      const TRIGGER_TYPE = '{{ settings.popup_trigger }}';
      const TRIGGER_DELAY = {{ settings.popup_delay }} * 1000;
      const TRIGGER_SCROLL = {{ settings.popup_scroll_percent }};
      const ENABLE_EXIT_INTENT = {{ settings.popup_exit_intent }};

      const popup = document.querySelector('[data-newsletter-popup]');
      const overlay = document.querySelector('[data-newsletter-popup-overlay]');
      const closeButtons = document.querySelectorAll('[data-newsletter-popup-close]');
      const form = document.getElementById('newsletter-popup-form');
      const formContainer = document.querySelector('[data-newsletter-popup-form-container]');
      const successContainer = document.querySelector('[data-newsletter-popup-success]');
      const discountCode = document.querySelector('[data-discount-code]');

      if (!popup || !overlay) return;

      // Check if user just subscribed via URL params
      const urlParams = new URLSearchParams(window.location.search);
      const justSubscribed = urlParams.get('customer_posted') === 'true' &&
                             window.location.hash === '#newsletter-popup-form';

      function shouldShowPopup() {
        if (Shopify.designMode) return false;
        // Always show if just subscribed (to display success/discount)
        if (justSubscribed) return true;
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return true;
        try {
          const data = JSON.parse(stored);
          return Date.now() > (data.hideUntil || 0);
        } catch (e) {
          return true;
        }
      }

      function saveState(type) {
        const days = type === 'subscribed' ? DAYS_HIDDEN_AFTER_SIGNUP : DAYS_HIDDEN;
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          type: type,
          hideUntil: Date.now() + (days * 24 * 60 * 60 * 1000)
        }));
      }

      let hasShown = false;
      let scrollPosition = 0;

      function showPopup(showSuccess = false) {
        if (hasShown && !showSuccess) return;
        if (!showSuccess && !shouldShowPopup()) return;
        hasShown = true;

        if (showSuccess) {
          formContainer.classList.add('hidden');
          successContainer.classList.remove('hidden');
          saveState('subscribed');
        }

        // Lock scroll
        scrollPosition = window.scrollY;
        document.body.style.top = `-${scrollPosition}px`;
        document.documentElement.classList.add('scroll-locked');
        if (window.lenis) window.lenis.stop();

        popup.classList.add('is-visible');
        overlay.classList.add('is-visible');
        if (!showSuccess) {
          popup.querySelector('button, input')?.focus();
        }
      }

      function hidePopup(type = 'dismissed') {
        popup.classList.remove('is-visible');
        overlay.classList.remove('is-visible');

        // Restore scroll
        document.documentElement.classList.remove('scroll-locked');
        document.body.style.top = '';
        window.scrollTo(0, scrollPosition);
        if (window.lenis) window.lenis.start();

        saveState(type);
      }

      closeButtons.forEach(btn => btn.addEventListener('click', () => hidePopup('dismissed')));
      overlay.addEventListener('click', () => hidePopup('dismissed'));

      // Keyboard handling: Escape to close and focus trap
      document.addEventListener('keydown', (e) => {
        if (!popup.classList.contains('is-visible')) return;

        if (e.key === 'Escape') {
          hidePopup('dismissed');
          return;
        }

        // Focus trap
        if (e.key === 'Tab') {
          const focusableEls = popup.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
          const firstEl = focusableEls[0];
          const lastEl = focusableEls[focusableEls.length - 1];

          if (e.shiftKey && document.activeElement === firstEl) {
            e.preventDefault();
            lastEl.focus();
          } else if (!e.shiftKey && document.activeElement === lastEl) {
            e.preventDefault();
            firstEl.focus();
          }
        }
      });

      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(form);
          // Remove return_to field to prevent redirect
          formData.delete('return_to');

          fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'application/json' }
          }).then(() => {
            formContainer.classList.add('hidden');
            successContainer.classList.remove('hidden');
            saveState('subscribed');
            {% unless settings.popup_show_discount and settings.popup_discount_code != blank %}
              setTimeout(() => hidePopup('subscribed'), 3000);
            {% endunless %}
          }).catch(() => {
            // Still show success even on error - email was likely captured
            formContainer.classList.add('hidden');
            successContainer.classList.remove('hidden');
            saveState('subscribed');
          });
        });
      }

      if (discountCode) {
        discountCode.addEventListener('click', function() {
          navigator.clipboard.writeText(this.dataset.discountCode).then(() => {
            const icon = this.querySelector('.ph');
            if (icon) {
              icon.classList.replace('ph-copy', 'ph-check');
              setTimeout(() => icon.classList.replace('ph-check', 'ph-copy'), 2000);
            }
          });
        });
      }

      // If user just subscribed, show success state immediately and clean URL
      if (justSubscribed) {
        showPopup(true);
        // Clean up URL params without reloading
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, '', cleanUrl);
      } else if (shouldShowPopup()) {
        if (TRIGGER_TYPE === 'delay') {
          setTimeout(showPopup, TRIGGER_DELAY);
        }

        if (TRIGGER_TYPE === 'scroll') {
          let triggered = false;
          window.addEventListener('scroll', function check() {
            if (triggered) return;
            if ((window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100 >= TRIGGER_SCROLL) {
              triggered = true;
              showPopup();
              window.removeEventListener('scroll', check);
            }
          }, { passive: true });
        }

        if (TRIGGER_TYPE === 'exit' || ENABLE_EXIT_INTENT) {
          let triggered = false;
          document.addEventListener('mouseleave', (e) => {
            if (!triggered && e.clientY < 10) {
              triggered = true;
              showPopup();
            }
          });
        }
      }
    })();
  </script>
{%- endif -%}
