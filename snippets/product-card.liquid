{%- comment -%}
  Product Card Snippet
  Renders a product card with split text reveal animation support

  Usage:
    {% render 'product-card', product: product, index: forloop.index0, collection: collection %}

  Parameters:
    - product: Product object (required)
    - collection: Collection object (optional) - preserves collection context in URL
    - index: Card index for animation stagger (optional, default: 0)
    - show_vendor: Show vendor name (optional, default: false)
    - show_quick_add: Show quick add button (optional, default: true)
    - animate_image: Add clip-path reveal animation to image (optional, default: false)
{%- endcomment -%}

{%- liquid
  assign index = index | default: 0
  assign show_quick_add = show_quick_add | default: true
  assign animate_image = animate_image | default: false

  # Use global settings for vendor display (can be overridden by parameter)
  if show_vendor == nil
    assign show_vendor = settings.show_vendor
  endif

  if collection
    assign product_url = product.url | within: collection
  else
    assign product_url = product.url
  endif

  assign first_available_variant = product.selected_or_first_available_variant
  assign has_variants = false
  if product.variants.size > 1
    assign has_variants = true
  endif

  # Image aspect ratio - use image's natural ratio for adapt mode to prevent CLS
  case settings.product_card_image_ratio
    when 'portrait'
      assign image_ratio_class = 'aspect-[3/4]'
    when 'square'
      assign image_ratio_class = 'aspect-square'
    when 'landscape'
      assign image_ratio_class = 'aspect-[4/3]'
    when 'adapt'
      if product.featured_image
        assign image_ratio_class = 'aspect-[' | append: product.featured_image.width | append: '/' | append: product.featured_image.height | append: ']'
      else
        assign image_ratio_class = 'aspect-[3/4]'
      endif
  endcase

  # Check if any action buttons are enabled
  assign show_action_buttons = false
  if settings.enable_wishlist or settings.enable_compare or settings.enable_quick_view
    assign show_action_buttons = true
  endif
-%}

{%- comment -%} Pre-generate product JSON once for reuse across all buttons {%- endcomment -%}
{%- capture product_json_base -%}
{"id":{{ product.id | json }},"handle":{{ product.handle | json }},"title":{{ product.title | json }},"url":{{ product.url | json }},"image":{{ product.featured_image | image_url: width: 800 | json }},"price":{{ product.price | json }},"compareAtPrice":{{ product.compare_at_price | default: 0 | json }},"vendor":{{ product.vendor | json }},"available":{{ product.available | json }}}
{%- endcapture -%}
{%- assign product_json_wishlist = product_json_base | strip_newlines | replace: "'", "&#39;" -%}
{%- capture product_json_compare_extra -%}
{"id":{{ product.id | json }},"handle":{{ product.handle | json }},"title":{{ product.title | json }},"url":{{ product.url | json }},"image":{{ product.featured_image | image_url: width: 800 | json }},"price":{{ product.price | json }},"compareAtPrice":{{ product.compare_at_price | default: 0 | json }},"vendor":{{ product.vendor | json }},"type":{{ product.type | json }},"sku":{{ product.selected_or_first_available_variant.sku | json }},"available":{{ product.available | json }}}
{%- endcapture -%}
{%- assign product_json_compare = product_json_compare_extra | strip_newlines | replace: "'", "&#39;" -%}

<div
  class="product-card group relative flex flex-col no-underline text-inherit rounded-(--card-radius) overflow-hidden h-full border-(--card-border-width) border-solid border-(--color-border)"
  style="box-shadow: var(--card-shadow);"
  data-product-card="{{ index }}"
  data-product-id="{{ product.id }}"
  {% unless animate_image %}data-tween data-tween-type="fade-up"{% endunless %}
>
  {%- comment -%} Image area with link {%- endcomment -%}
  <div class="product-card-image relative overflow-hidden {{ image_ratio_class }}"{% if animate_image %} data-tween data-tween-type="clip-right"{% endif %}>
    <a href="{{ product_url }}" class="block w-full h-full">
      {% if product.featured_image %}
        {%- assign focal_point = product.featured_image.presentation.focal_point | default: '50% 50%' -%}
        {%- assign focal_point_style = 'object-position: ' | append: focal_point -%}
        {%- assign has_secondary = false -%}
        {%- if product.images.size > 1 and settings.show_secondary_image -%}
          {%- assign has_secondary = true -%}
        {%- endif -%}
        {%- if has_secondary -%}
          {%- assign primary_class = 'image-primary has-secondary' -%}
        {%- else -%}
          {%- assign primary_class = 'image-primary' -%}
        {%- endif -%}
        {{ product.featured_image | image_url: width: 1200 | image_tag:
          class: primary_class,
          style: focal_point_style,
          loading: 'lazy',
          decoding: 'async',
          sizes: '(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 33vw',
          widths: '400, 600, 800, 1200',
          alt: product.title
        }}
        {%- comment -%} Secondary image on hover {%- endcomment -%}
        {% if has_secondary %}
          {%- assign secondary_focal_point = product.images[1].presentation.focal_point | default: '50% 50%' -%}
          {%- assign secondary_focal_point_style = 'object-position: ' | append: secondary_focal_point -%}
          {{ product.images[1] | image_url: width: 1200 | image_tag:
            class: 'image-secondary',
            style: secondary_focal_point_style,
            loading: 'lazy',
            decoding: 'async',
            sizes: '(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 33vw',
            widths: '400, 600, 800, 1200',
            alt: product.title
          }}
        {% endif %}
      {% else %}
        <div class="w-full h-full flex items-center justify-center bg-(--color-background-secondary)">
          <i class="ph ph-image text-5xl text-(--color-text-secondary) opacity-30" aria-hidden="true"></i>
        </div>
      {% endif %}
    </a>

    {%- comment -%} Badges - outside the link {%- endcomment -%}
    <div class="absolute top-3 left-3 flex flex-col gap-2 pointer-events-none">
      {% if product.compare_at_price > product.price and settings.show_sale_badge %}
        <span class="badge badge--sale">
          {% if settings.sale_badge_style == 'percentage' %}
            {%- assign save_percent = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round -%}
            -{{ save_percent }}%
          {% else %}
            {{ 'products.product.on_sale' | t }}
          {% endif %}
        </span>
      {% endif %}
      {% unless product.available %}
        {% if settings.show_sold_out_badge %}
          <span class="badge badge--soldout">
            {{ 'products.product.sold_out' | t }}
          </span>
        {% endif %}
      {% endunless %}
    </div>

    {%- comment -%} Action buttons - outside the link, grouped together {%- endcomment -%}
    {% if show_action_buttons %}
      <div class="product-card-actions absolute bottom-3 left-3 right-3 z-10 flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
        {%- comment -%} Quick View Button {%- endcomment -%}
        {% if settings.enable_quick_view and product.available %}
          <button
            type="button"
            class="card-action-btn"
            data-quick-view-trigger="{{ product.handle }}"
            aria-label="{{ 'products.product.quick_view' | t | default: 'Quick view' }}: {{ product.title }}"
          >
            <i class="ph ph-eye text-lg" aria-hidden="true"></i>
          </button>
        {% endif %}
        {%- comment -%} Wishlist Button {%- endcomment -%}
        {% if settings.enable_wishlist %}
          <button
            type="button"
            class="card-action-btn"
            data-wishlist-toggle="{{ product.id }}"
            data-product-json='{{ product_json_wishlist }}'
            aria-label="{{ 'products.wishlist.add_to_wishlist' | t | default: 'Add to wishlist' }}: {{ product.title }}"
            aria-pressed="false"
          >
            <i class="ph ph-heart text-lg" aria-hidden="true"></i>
          </button>
        {% endif %}
        {%- comment -%} Compare Button {%- endcomment -%}
        {% if settings.enable_compare %}
          <button
            type="button"
            class="card-action-btn"
            data-compare-toggle="{{ product.id }}"
            data-product-json='{{ product_json_compare }}'
            aria-label="{{ 'products.compare.add_to_compare' | t | default: 'Add to compare' }}: {{ product.title }}"
            aria-pressed="false"
          >
            <i class="ph ph-scales text-lg" aria-hidden="true"></i>
          </button>
        {% endif %}
      </div>
    {% endif %}
  </div>

  {%- comment -%} Content area with link {%- endcomment -%}
  <a href="{{ product_url }}" class="product-card-content flex-1 p-4 bg-(--color-background) block no-underline"{% if animate_image %} data-tween data-tween-type="fade-up"{% endif %}>
    {% if show_vendor and product.vendor != blank %}
      <p class="product-card-vendor card-meta overflow-hidden">
        <span class="inline-block">{{ product.vendor }}</span>
      </p>
    {% endif %}

    <h3 class="product-card-title card-title{% if show_vendor and product.vendor != blank %} mt-1{% endif %}">
      {%- assign title_words = product.title | split: ' ' -%}
      {%- for word in title_words -%}
        <span class="overflow-hidden inline-block"><span class="inline-block">{{ word }}</span></span>{% unless forloop.last %} {% endunless %}
      {%- endfor -%}
    </h3>

    <div class="product-card-price card-price">
      {% if product.compare_at_price > product.price %}
        <span class="overflow-hidden inline-block"><span class="inline-block card-price--compare">{{ product.compare_at_price | money }}</span></span>
        <span class="overflow-hidden inline-block"><span class="inline-block card-price--sale">{{ product.price | money }}</span></span>
      {% else %}
        <span class="overflow-hidden inline-block"><span class="inline-block">{{ product.price | money }}</span></span>
      {% endif %}
      {%- if product.selected_or_first_available_variant.unit_price_measurement -%}
        <div class="unit-price text-xs opacity-70 mt-1">
          <span class="visually-hidden">{{ 'accessibility.unit_price_separator' | t }}</span>
          {{ product.selected_or_first_available_variant.unit_price | money }}/{{ product.selected_or_first_available_variant.unit_price_measurement.reference_value }}{{ product.selected_or_first_available_variant.unit_price_measurement.reference_unit }}
        </div>
      {%- endif -%}
    </div>
  </a>

  {%- comment -%} List view buttons for mobile (2-column layout) - outside <a> to avoid nested links {%- endcomment -%}
  {% if show_quick_add and product.available %}
    <div class="product-card-list-buttons-mobile">
      {%- comment -%} Main button {%- endcomment -%}
      {% if has_variants %}
        <a href="{{ product_url }}" class="btn btn--primary btn--sm" aria-label="{{ 'products.product.select_options' | t }}: {{ product.title }}">
          <span>{{ 'products.product.select_options' | t }}</span>
        </a>
      {% else %}
        <button type="button" class="btn btn--primary btn--sm" data-quick-add="{{ first_available_variant.id }}" aria-label="{{ 'products.product.add_to_cart' | t }}: {{ product.title }}">
          <span data-add-text>{{ 'products.product.add_to_cart' | t }}</span>
          <span data-adding-text class="hidden">{{ 'cart.adding' | t }}</span>
          <span data-added-text class="hidden">{{ 'cart.added' | t }}</span>
        </button>
      {% endif %}
      {%- comment -%} Secondary action buttons {%- endcomment -%}
      {% if show_action_buttons %}
        <div class="product-card-list-actions-mobile flex gap-2">
          {% if settings.enable_quick_view and product.available %}
            <button type="button" class="btn btn--secondary btn--sm btn--icon" data-quick-view-trigger="{{ product.handle }}" aria-label="{{ 'products.product.quick_view' | t | default: 'Quick view' }}: {{ product.title }}">
              <i class="ph ph-eye" aria-hidden="true"></i>
            </button>
          {% endif %}
          {% if settings.enable_wishlist %}
            <button type="button" class="product-card-wishlist btn btn--secondary btn--sm btn--icon [&.is-active]:!bg-(--color-sale) [&.is-active]:!text-white [&.is-active]:!border-(--color-sale)" data-wishlist-toggle="{{ product.id }}" data-product-json='{{ product_json_wishlist }}' aria-label="{{ 'products.wishlist.add_to_wishlist' | t | default: 'Add to wishlist' }}: {{ product.title }}" aria-pressed="false">
              <i class="ph ph-heart" aria-hidden="true"></i>
            </button>
          {% endif %}
          {% if settings.enable_compare %}
            <button type="button" class="product-card-compare btn btn--secondary btn--sm btn--icon [&.is-active]:!bg-(--color-text) [&.is-active]:!text-(--color-background)" data-compare-toggle="{{ product.id }}" data-product-json='{{ product_json_compare }}' aria-label="{{ 'products.compare.add_to_compare' | t | default: 'Add to compare' }}: {{ product.title }}" aria-pressed="false">
              <i class="ph ph-scales" aria-hidden="true"></i>
            </button>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% endif %}

  {%- comment -%} Add to Cart / Select Options Button (grid view + list view desktop 3rd column) {%- endcomment -%}
  {% if show_quick_add and product.available %}
    <div class="product-card-quick-add px-4 pb-4 bg-(--color-background)"{% if animate_image %} data-tween data-tween-type="fade-up"{% endif %}>
      {% if has_variants %}
        <a href="{{ product_url }}" class="btn btn--primary w-full text-center" aria-label="{{ 'products.product.select_options' | t }}: {{ product.title }}">
          <span>{{ 'products.product.select_options' | t }}</span>
        </a>
      {% else %}
        <button type="button" class="btn btn--primary w-full" data-quick-add="{{ first_available_variant.id }}" aria-label="{{ 'products.product.add_to_cart' | t }}: {{ product.title }}">
          <span data-add-text>{{ 'products.product.add_to_cart' | t }}</span>
          <span data-adding-text class="hidden">{{ 'cart.adding' | t }}</span>
          <span data-added-text class="hidden">{{ 'cart.added' | t }}</span>
        </button>
      {% endif %}

      {%- comment -%} Action buttons for list view desktop (shown after main button) {%- endcomment -%}
      {% if show_action_buttons %}
        <div class="product-card-list-actions hidden gap-2">
          {% if settings.enable_quick_view and product.available %}
            <button type="button" class="btn btn--secondary btn--sm btn--icon" data-quick-view-trigger="{{ product.handle }}" aria-label="{{ 'products.product.quick_view' | t | default: 'Quick view' }}: {{ product.title }}">
              <i class="ph ph-eye" aria-hidden="true"></i>
            </button>
          {% endif %}
          {% if settings.enable_wishlist %}
            <button type="button" class="product-card-wishlist btn btn--secondary btn--sm btn--icon [&.is-active]:!bg-(--color-sale) [&.is-active]:!text-white [&.is-active]:!border-(--color-sale)" data-wishlist-toggle="{{ product.id }}" data-product-json='{{ product_json_wishlist }}' aria-label="{{ 'products.wishlist.add_to_wishlist' | t | default: 'Add to wishlist' }}: {{ product.title }}" aria-pressed="false">
              <i class="ph ph-heart" aria-hidden="true"></i>
            </button>
          {% endif %}
          {% if settings.enable_compare %}
            <button type="button" class="product-card-compare btn btn--secondary btn--sm btn--icon [&.is-active]:!bg-(--color-text) [&.is-active]:!text-(--color-background)" data-compare-toggle="{{ product.id }}" data-product-json='{{ product_json_compare }}' aria-label="{{ 'products.compare.add_to_compare' | t | default: 'Add to compare' }}: {{ product.title }}" aria-pressed="false">
              <i class="ph ph-scales" aria-hidden="true"></i>
            </button>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>
