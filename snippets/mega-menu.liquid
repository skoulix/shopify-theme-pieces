
{%- comment -%}
  Mega Menu Component
  Renders a full-width dropdown panel with featured collections, products, and promotional content.

  Accepts:
  - link: {Object} Menu link object
  - block: {Object} Mega menu block settings
  - position: {Number} Index position for animation stagger

  Usage:
  {% render 'mega-menu', link: link, block: block, position: forloop.index0 %}
{%- endcomment -%}

{%- liquid
  # Default full_width to true if not explicitly set to false
  assign mega_menu_full_width = true
  if block.settings.full_width == false
    assign mega_menu_full_width = false
  endif

  # Animation style - default to fade-slide
  assign mega_menu_animation = block.settings.animation | default: 'fade-slide'
-%}

<div class="mega-menu-wrapper relative" data-mega-menu data-mega-menu-position="{{ position }}" data-mega-menu-animation="{{ mega_menu_animation }}">
  {%- comment -%} Trigger button {%- endcomment -%}
  <button
    type="button"
    class="mega-menu-trigger group relative flex items-center gap-1 text-sm font-semibold leading-6 text-(--color-text) hover:text-(--color-primary) transition-colors"
    data-mega-menu-trigger
    aria-expanded="false"
  >
    <span>{{ link.title }}</span>
    <i class="ph ph-caret-down text-xs transition-transform duration-300 group-aria-expanded:rotate-180"></i>
  </button>

  {%- comment -%} Mega menu panel {%- endcomment -%}
  <div class="mega-menu-panel" data-mega-menu-panel>
    <div class="mega-menu-panel__inner {% if mega_menu_full_width %}page-full{% else %}page-container{% endif %}">
      <div class="mega-menu-grid">
        {%- comment -%} Navigation columns {%- endcomment -%}
        <div class="mega-menu-nav">
          {% if link.url != '#' and link.url != '' %}
            <a href="{{ link.url }}" class="mega-menu-nav__view-all text-label-sm" data-mega-menu-item>
              <span>{{ 'accessibility.explore' | t }} {{ link.title }}</span>
              <i class="ph ph-arrow-right"></i>
            </a>
          {% endif %}

          <div class="mega-menu-nav__columns">
            {% for child in link.links %}
              <div class="mega-menu-nav__column" style="--column-index: {{ forloop.index0 }}">
                {% if child.links.size > 0 %}
                  {%- comment -%} This child has grandchildren - render as category {%- endcomment -%}
                  <h3 class="mega-menu-nav__heading">
                    {% if child.url != '#' and child.url != '' %}
                      <a href="{{ child.url }}" data-mega-menu-item>{{ child.title }}</a>
                    {% else %}
                      {{ child.title }}
                    {% endif %}
                  </h3>
                  <ul class="mega-menu-nav__links">
                    {% for grandchild in child.links %}
                      <li style="--item-index: {{ forloop.index0 }}">
                        <a href="{{ grandchild.url }}" class="mega-menu-nav__link" data-mega-menu-item>
                          {{ grandchild.title }}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  {%- comment -%} No grandchildren - render as direct link {%- endcomment -%}
                  <a href="{{ child.url }}" class="mega-menu-nav__link mega-menu-nav__link--standalone" data-mega-menu-item>
                    {{ child.title }}
                  </a>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>

        {%- comment -%} Featured content area {%- endcomment -%}
        {% if block.settings.show_featured %}
          <div class="mega-menu-featured">
            {% if block.settings.featured_collection != blank %}
              {%- comment -%} Featured collection products {%- endcomment -%}
              <div class="mega-menu-featured__collection">
                <h4 class="mega-menu-featured__heading text-label-sm">
                  {{ block.settings.featured_heading | default: 'Featured' }}
                </h4>
                <div class="mega-menu-featured__products">
                  {%- assign featured_limit = block.settings.featured_limit | default: 3 -%}
                  {% for product in block.settings.featured_collection.products limit: featured_limit %}
                    <a href="{{ product.url }}" class="mega-menu-featured__product" data-mega-menu-item style="--product-index: {{ forloop.index0 }}">
                      <div class="mega-menu-featured__product-image">
                        {% if product.featured_image %}
                          {{ product.featured_image | image_url: width: 200 | image_tag:
                            class: 'w-full h-full object-cover',
                            loading: 'lazy',
                            decoding: 'async',
                            alt: product.title
                          }}
                        {% else %}
                          <div class="w-full h-full flex items-center justify-center bg-(--color-background-secondary)">
                            <i class="ph ph-image text-2xl text-(--color-text-secondary) opacity-30"></i>
                          </div>
                        {% endif %}
                      </div>
                      <div class="mega-menu-featured__product-info">
                        <span class="mega-menu-featured__product-title">{{ product.title | truncate: 30 }}</span>
                        <span class="mega-menu-featured__product-price">{{ product.price | money }}</span>
                      </div>
                    </a>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            {% if block.settings.promo_image != blank %}
              {%- comment -%} Promotional image {%- endcomment -%}
              <div class="mega-menu-featured__promo">
                {% if block.settings.promo_link != blank %}
                  <a href="{{ block.settings.promo_link }}" class="mega-menu-featured__promo-link" data-mega-menu-item>
                {% endif %}
                  <div class="mega-menu-featured__promo-image">
                    {{ block.settings.promo_image | image_url: width: 400 | image_tag:
                      class: 'w-full h-full object-cover',
                      loading: 'lazy',
                      decoding: 'async',
                      alt: block.settings.promo_heading | default: 'Promotional image'
                    }}
                    {% if block.settings.promo_heading != blank or block.settings.promo_text != blank %}
                      <div class="mega-menu-featured__promo-overlay">
                        {% if block.settings.promo_heading != blank %}
                          <span class="mega-menu-featured__promo-heading">{{ block.settings.promo_heading }}</span>
                        {% endif %}
                        {% if block.settings.promo_text != blank %}
                          <span class="mega-menu-featured__promo-text">{{ block.settings.promo_text }}</span>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                {% if block.settings.promo_link != blank %}
                  </a>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{%- comment -%}
  Mega menu JavaScript is initialized in header.liquid to ensure single initialization
{%- endcomment -%}
