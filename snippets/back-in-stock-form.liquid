{%- comment -%}
  Back In Stock Notification Form
  Renders a form for customers to sign up for notifications when a product comes back in stock.

  Accepts:
  - product: {Object} Product object
  - variant: {Object} Current variant (optional)

  Usage:
  {% render 'back-in-stock-form', product: product, variant: current_variant %}
{%- endcomment -%}

{%- liquid
  assign current_variant = variant | default: product.selected_or_first_available_variant
  assign is_sold_out = false
  unless current_variant.available
    assign is_sold_out = true
  endunless
-%}

<div
  class="back-in-stock-form{% unless is_sold_out %} hidden{% endunless %} mt-4 p-4 bg-[--color-background-secondary] rounded-lg"
  data-back-in-stock-form
  data-product-id="{{ product.id }}"
  data-variant-id="{{ current_variant.id }}"
>
  <div class="back-in-stock-form__content" data-form-content>
    <div class="flex items-start gap-3 mb-3">
      <i class="ph ph-bell-ringing text-xl text-[--color-primary] flex-shrink-0 mt-0.5"></i>
      <div>
        <h4 class="text-sm font-medium">{{ 'products.back_in_stock.title' | t }}</h4>
        <p class="text-xs text-[--color-text-secondary] mt-1">
          {{ 'products.back_in_stock.description' | t }}
        </p>
      </div>
    </div>

    <form class="back-in-stock-form__form space-y-3" data-notify-form>
      <div>
        <label for="back-in-stock-email-{{ product.id }}" class="sr-only">
          {{ 'products.back_in_stock.email_label' | t }}
        </label>
        <input
          type="email"
          id="back-in-stock-email-{{ product.id }}"
          name="email"
          required
          placeholder="{{ 'products.back_in_stock.email_placeholder' | t }}"
          class="input w-full text-sm"
          autocomplete="email"
        >
      </div>
      <button
        type="submit"
        class="btn btn-secondary w-full text-sm"
        data-notify-submit
      >
        <span data-btn-text>{{ 'products.back_in_stock.submit' | t }}</span>
        <span data-btn-loading class="hidden">
          <i class="ph ph-spinner animate-spin mr-2"></i>
          {{ 'products.back_in_stock.submitting' | t }}
        </span>
      </button>
    </form>
  </div>

  <div class="back-in-stock-form__success hidden text-center py-2" data-form-success>
    <i class="ph ph-check-circle text-2xl text-green-500 mb-2"></i>
    <p class="text-sm font-medium">{{ 'products.back_in_stock.success_title' | t }}</p>
    <p class="text-xs text-[--color-text-secondary] mt-1">
      {{ 'products.back_in_stock.success_message' | t }}
    </p>
  </div>

  <div class="back-in-stock-form__error hidden text-center py-2" data-form-error>
    <i class="ph ph-warning-circle text-2xl text-red-500 mb-2"></i>
    <p class="text-sm font-medium">{{ 'products.back_in_stock.error_title' | t }}</p>
    <p class="text-xs text-[--color-text-secondary] mt-1" data-error-message>
      {{ 'products.back_in_stock.error_message' | t }}
    </p>
  </div>
</div>

<script>
(function() {
  const forms = document.querySelectorAll('[data-back-in-stock-form]');

  forms.forEach(container => {
    const form = container.querySelector('[data-notify-form]');
    const content = container.querySelector('[data-form-content]');
    const success = container.querySelector('[data-form-success]');
    const error = container.querySelector('[data-form-error]');
    const errorMessage = container.querySelector('[data-error-message]');
    const submitBtn = container.querySelector('[data-notify-submit]');
    const btnText = container.querySelector('[data-btn-text]');
    const btnLoading = container.querySelector('[data-btn-loading]');

    if (!form) return;

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const email = form.querySelector('input[type="email"]').value;
      const productId = container.dataset.productId;
      const variantId = container.dataset.variantId;

      // Show loading state
      submitBtn.disabled = true;
      btnText.classList.add('hidden');
      btnLoading.classList.remove('hidden');

      try {
        // This integrates with Shopify's Back in Stock app or similar services
        // You'll need to configure this with your specific back-in-stock service endpoint
        // Common options: Klaviyo, Back in Stock, Notify Me

        // Example: Klaviyo integration
        // const response = await fetch('https://a.klaviyo.com/api/v2/list/LIST_ID/subscribe', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify({
        //     api_key: 'YOUR_PUBLIC_API_KEY',
        //     profiles: [{ email: email, $consent: ['email'] }]
        //   })
        // });

        // For now, we'll use localStorage to simulate subscription
        // In production, replace this with your actual back-in-stock service
        const subscriptions = JSON.parse(localStorage.getItem('backInStock') || '{}');
        if (!subscriptions[productId]) {
          subscriptions[productId] = [];
        }

        if (!subscriptions[productId].some(sub => sub.email === email && sub.variantId === variantId)) {
          subscriptions[productId].push({
            email: email,
            variantId: variantId,
            timestamp: Date.now()
          });
          localStorage.setItem('backInStock', JSON.stringify(subscriptions));
        }

        // Dispatch event for external integrations
        document.dispatchEvent(new CustomEvent('backInStock:subscribe', {
          detail: {
            email: email,
            productId: productId,
            variantId: variantId
          }
        }));

        // Show success state
        content.classList.add('hidden');
        success.classList.remove('hidden');

      } catch (err) {
        console.error('Back in stock subscription error:', err);

        // Show error state
        content.classList.add('hidden');
        error.classList.remove('hidden');

        if (errorMessage && err.message) {
          errorMessage.textContent = err.message;
        }

        // Reset after 5 seconds
        setTimeout(() => {
          error.classList.add('hidden');
          content.classList.remove('hidden');
          submitBtn.disabled = false;
          btnLoading.classList.add('hidden');
          btnText.classList.remove('hidden');
        }, 5000);
      }
    });
  });

  // Listen for variant changes to show/hide form
  document.addEventListener('variant:change', function(e) {
    const variant = e.detail.variant;
    if (!variant) return;

    const forms = document.querySelectorAll('[data-back-in-stock-form]');
    forms.forEach(form => {
      // Update variant ID
      form.dataset.variantId = variant.id;

      // Show/hide based on availability
      if (variant.available) {
        form.classList.add('hidden');
      } else {
        form.classList.remove('hidden');
        // Reset to form state if previously submitted
        const content = form.querySelector('[data-form-content]');
        const success = form.querySelector('[data-form-success]');
        const error = form.querySelector('[data-form-error]');
        if (content && success && error) {
          content.classList.remove('hidden');
          success.classList.add('hidden');
          error.classList.add('hidden');
        }
      }
    });
  });
})();
</script>
