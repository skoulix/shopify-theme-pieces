{%- comment -%}
  Compare Products Drawer
  Slide-out panel showing products to compare
{%- endcomment -%}

<style>
  .compare-drawer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 90;
    background: var(--color-background);
    border-top: 1px solid var(--color-border);
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
  }
  .compare-drawer.is-open { transform: translateY(0); }
  .compare-drawer__inner {
    max-width: var(--page-max-width);
    margin: 0 auto;
    padding: 1.5rem var(--page-padding);
  }
  .compare-drawer__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }
  .compare-drawer__title {
    font-size: 0.875rem;
    font-weight: 600;
    {% if settings.headings_uppercase %}text-transform: uppercase;{% endif %}
    letter-spacing: 0.15em;
    color: var(--color-text);
  }
  .compare-drawer__count {
    font-weight: 400;
    opacity: 0.6;
    margin-left: 0.5rem;
  }
  .compare-drawer__actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  .compare-drawer__close {
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--color-text);
    transition: opacity 0.2s ease;
  }
  .compare-drawer__close:hover { opacity: 0.6; }
  .compare-drawer__products {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
  }
  @media (max-width: 768px) {
    .compare-drawer__inner {
      padding: 1rem var(--page-padding) calc(1rem + env(safe-area-inset-bottom));
    }
    .compare-drawer__products {
      display: flex;
      gap: 0.75rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      scrollbar-width: none;
      -ms-overflow-style: none;
      margin: 0 calc(var(--page-padding) * -1);
      padding: 0 var(--page-padding);
    }
    .compare-drawer__products::-webkit-scrollbar {
      display: none;
    }
    .compare-drawer__product,
    .compare-drawer__empty-slot {
      flex: 0 0 200px;
      scroll-snap-align: start;
    }
    .compare-drawer__footer {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
    }
  }
  .compare-drawer__product {
    position: relative;
    display: flex;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--color-background-secondary);
    border-radius: var(--card-radius);
  }
  .compare-drawer__product-image {
    width: 60px;
    height: 60px;
    flex-shrink: 0;
    border-radius: calc(var(--card-radius) / 2);
    overflow: hidden;
    background: var(--color-background);
  }
  .compare-drawer__product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .compare-drawer__product-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .compare-drawer__product-title {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-decoration: none;
  }
  .compare-drawer__product-title:hover { text-decoration: underline; }
  .compare-drawer__product-price {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    margin-top: 0.25rem;
  }
  .compare-drawer__product-remove {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-background);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    color: var(--color-text-secondary);
    font-size: 0.75rem;
    transition: all 0.2s ease;
  }
  .compare-drawer__product-remove:hover {
    background: var(--color-text);
    color: var(--color-background);
  }
  .compare-drawer__empty-slot {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    background: var(--color-background-secondary);
    border-radius: var(--card-radius);
    border: 2px dashed var(--color-border);
    color: var(--color-text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  .compare-drawer__footer {
    display: flex;
    justify-content: flex-end;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
  }
  .compare-drawer__compare-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .compare-drawer__compare-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Floating compare button */
  .compare-floating-btn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 89;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    background: var(--color-text);
    color: var(--color-background);
    border: 1px solid color-mix(in srgb, var(--color-background) 20%, transparent);
    border-radius: var(--button-radius);
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    {% if settings.buttons_uppercase %}text-transform: uppercase;{% endif %}
    letter-spacing: 0.1em;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    transform: translateY(calc(100% + 4rem));
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, bottom 0.4s ease;
    opacity: 0;
  }
  .compare-floating-btn.is-visible {
    transform: translateY(0);
    opacity: 1;
  }

  /* Move floating button up when sticky product bar is visible */
  .compare-floating-btn.is-above-sticky-bar {
    bottom: 6rem;
  }

  @media (max-width: 767px) {
    .compare-floating-btn {
      right: 1rem;
      bottom: 1.5rem;
      padding: 0.75rem 1rem;
      font-size: 0;
      gap: 0;
    }
    .compare-floating-btn i {
      font-size: 1.25rem;
    }
    .compare-floating-btn span:not(.compare-floating-btn__count) {
      display: none;
    }
    .compare-floating-btn__count {
      position: absolute;
      top: -0.25rem;
      right: -0.25rem;
      width: 1.25rem;
      height: 1.25rem;
      font-size: 0.6875rem;
    }

    /* Move floating button up when sticky product bar is visible on mobile */
    .compare-floating-btn.is-above-sticky-bar {
      bottom: 5.5rem;
    }
  }
  .compare-floating-btn:hover {
    box-shadow: 0 6px 24px rgba(0,0,0,0.25);
  }
  .compare-floating-btn__count {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    background: var(--color-background);
    color: var(--color-text);
    border-radius: 50%;
    font-size: 0.75rem;
    font-weight: 700;
  }
</style>

{%- comment -%} Floating Button {%- endcomment -%}
<button type="button" class="compare-floating-btn" data-compare-floating-btn aria-label="{{ 'products.compare.view_compare' | t | default: 'View compare' }}" aria-expanded="false" aria-controls="compare-drawer">
  <i class="ph ph-scales text-lg" aria-hidden="true"></i>
  <span>{{ 'products.compare.compare' | t | default: 'Compare' }}</span>
  <span class="compare-floating-btn__count" data-compare-count aria-label="{{ 'products.compare.items_count' | t | default: 'items' }}">0</span>
</button>

{%- comment -%} Drawer {%- endcomment -%}
<div id="compare-drawer" class="compare-drawer" data-compare-drawer aria-hidden="true" inert role="region" aria-labelledby="compare-drawer-title">
  {%- comment -%} Live region for screen reader announcements {%- endcomment -%}
  <div class="sr-only" aria-live="polite" aria-atomic="true" data-compare-status></div>
  <div class="compare-drawer__inner">
    <div class="compare-drawer__header">
      <h3 id="compare-drawer-title" class="compare-drawer__title">
        {{ 'products.compare.compare_products' | t | default: 'Compare Products' }}
        <span class="compare-drawer__count" aria-live="polite">(<span data-compare-drawer-count>0</span>/4)</span>
      </h3>
      <div class="compare-drawer__actions">
        {%- assign clear_text = 'products.compare.clear_all' | t | default: 'Clear all' -%}
        <button type="button" class="text-hover-reveal inline-flex items-center gap-2 text-sm font-semibold tracking-[0.1em] text-[--color-text] opacity-70 hover:opacity-100 transition-opacity duration-300 bg-transparent border-none cursor-pointer p-0" data-compare-clear>
          <span data-hover="{{ clear_text }}">{{ clear_text }}</span>
        </button>
        <button type="button" class="compare-drawer__close" data-compare-drawer-close aria-label="{{ 'accessibility.close' | t }}">
          <i class="ph ph-x text-lg"></i>
        </button>
      </div>
    </div>

    <div class="compare-drawer__products" data-compare-products data-lenis-prevent>
      {%- comment -%} Products will be rendered via JS {%- endcomment -%}
    </div>

    <div class="compare-drawer__footer">
      <a href="/pages/compare" class="btn btn--primary btn--xs compare-drawer__compare-btn" data-compare-view-btn>
        <span>{{ 'products.compare.view_comparison' | t | default: 'View Comparison' }}</span>
        <i class="ph ph-arrow-right"></i>
      </a>
    </div>
  </div>
</div>

<script data-swup-ignore-script>
(function() {
  // Prevent double initialization if script runs again
  if (window._compareDrawerInitialized) return;
  window._compareDrawerInitialized = true;

  const STORAGE_KEY = 'pieces_compare_products';
  const MAX_PRODUCTS = 4;

  const floatingBtn = document.querySelector('[data-compare-floating-btn]');
  const drawer = document.querySelector('[data-compare-drawer]');
  const productsContainer = drawer?.querySelector('[data-compare-products]');
  const countEl = document.querySelector('[data-compare-count]');
  const drawerCountEl = document.querySelector('[data-compare-drawer-count]');
  const clearBtn = document.querySelector('[data-compare-clear]');
  const closeBtn = document.querySelector('[data-compare-drawer-close]');
  const viewBtn = document.querySelector('[data-compare-view-btn]');

  // Allow functionality even if drawer elements aren't found (click handlers still work)
  const hasDrawer = drawer && floatingBtn;

  function getProducts() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch {
      return [];
    }
  }

  function saveProducts(products) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
    } catch {
      // Storage error
    }
  }

  function formatMoney(cents) {
    // Handle string input - remove any non-numeric chars except decimal
    if (typeof cents === 'string') {
      cents = cents.replace(/[^\d.-]/g, '');
      if (cents.includes('.')) {
        cents = Math.round(parseFloat(cents) * 100);
      } else {
        cents = parseInt(cents, 10);
      }
    }
    cents = cents || 0;

    const moneyFormat = window.themeSettings?.moneyFormat || '${{amount}}';
    const value = cents / 100;
    const amountNoDecimals = Math.floor(value);
    const amountFormatted = value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const amountWithComma = value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const amountNoDecimalsWithComma = amountNoDecimals.toLocaleString('de-DE');
    const amountWithApostrophe = value.toLocaleString('de-CH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    return moneyFormat
      .replace(/\{\{\s*amount_with_comma_separator\s*\}\}/g, amountWithComma)
      .replace(/\{\{\s*amount_no_decimals_with_comma_separator\s*\}\}/g, amountNoDecimalsWithComma)
      .replace(/\{\{\s*amount_with_apostrophe_separator\s*\}\}/g, amountWithApostrophe)
      .replace(/\{\{\s*amount_no_decimals\s*\}\}/g, amountNoDecimals.toLocaleString('en-US'))
      .replace(/\{\{\s*amount\s*\}\}/g, amountFormatted);
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function updateUI() {
    const products = getProducts();
    const count = products.length;

    // Update all count elements (including facets toolbar)
    document.querySelectorAll('[data-compare-count]').forEach(el => {
      el.textContent = count;
    });
    if (drawerCountEl) drawerCountEl.textContent = count;

    // Show/hide floating button
    if (hasDrawer) {
      if (count > 0) {
        floatingBtn.classList.add('is-visible');
      } else {
        floatingBtn.classList.remove('is-visible');
        closeDrawer();
      }
    }

    // Show/hide facets toolbar compare button
    const facetsCompareBtn = document.querySelector('.facets-compare-btn');
    if (facetsCompareBtn) {
      facetsCompareBtn.classList.toggle('hidden', count === 0);
    }

    // Update view button
    if (viewBtn) {
      viewBtn.classList.toggle('btn--disabled', count < 2);
      if (count < 2) {
        viewBtn.setAttribute('aria-disabled', 'true');
        viewBtn.addEventListener('click', preventClick);
      } else {
        viewBtn.removeAttribute('aria-disabled');
        viewBtn.removeEventListener('click', preventClick);
      }
    }

    // Render products
    renderProducts(products);

    // Update compare buttons on page
    updateCompareButtons(products);
  }

  function preventClick(e) {
    e.preventDefault();
  }

  function renderProducts(products) {
    if (!productsContainer) return;

    let html = '';

    // Render products
    products.forEach(product => {
      html += `
        <div class="compare-drawer__product" data-product-id="${product.id}">
          <a href="${escapeHtml(product.url)}" class="compare-drawer__product-image">
            ${product.image ? `<img src="${escapeHtml(product.image)}" alt="${escapeHtml(product.title)}" loading="lazy" decoding="async">` : ''}
          </a>
          <div class="compare-drawer__product-info">
            <a href="${escapeHtml(product.url)}" class="compare-drawer__product-title">${escapeHtml(product.title)}</a>
            <div class="compare-drawer__product-price">${formatMoney(product.price)}</div>
          </div>
          <button type="button" class="compare-drawer__product-remove" data-remove-product="${product.id}" aria-label="{{ 'products.compare.remove' | t | default: 'Remove' }}">
            <i class="ph ph-x"></i>
          </button>
        </div>
      `;
    });

    // Add empty slots
    for (let i = products.length; i < MAX_PRODUCTS; i++) {
      html += `<div class="compare-drawer__empty-slot">{{ 'products.compare.add_product' | t | default: 'Add product' }}</div>`;
    }

    productsContainer.innerHTML = html;

    // Add remove listeners
    productsContainer.querySelectorAll('[data-remove-product]').forEach(btn => {
      btn.addEventListener('click', () => {
        const productId = btn.dataset.removeProduct;
        removeProduct(productId);
      });
    });
  }

  function removeProduct(productId) {
    const products = getProducts();
    const removedProduct = products.find(p => String(p.id) === String(productId));
    const filteredProducts = products.filter(p => String(p.id) !== String(productId));
    saveProducts(filteredProducts);
    updateUI();
    document.dispatchEvent(new CustomEvent('compare:removed', { detail: { productId } }));
    if (removedProduct) {
      announce(`${removedProduct.title} removed from comparison`);
    }
  }

  function clearProducts() {
    saveProducts([]);
    updateUI();
    document.dispatchEvent(new CustomEvent('compare:cleared'));
    announce('All products cleared from comparison');
  }

  /**
   * Announce status updates to screen readers
   */
  function announce(message) {
    const statusEl = drawer?.querySelector('[data-compare-status]');
    if (statusEl) {
      statusEl.textContent = message;
      setTimeout(() => { statusEl.textContent = ''; }, 1000);
    }
  }

  function updateCompareButtons(products) {
    const productIds = products.map(p => String(p.id));
    document.querySelectorAll('[data-compare-toggle]').forEach(btn => {
      const productId = btn.dataset.compareToggle;
      const isInCompare = productIds.includes(productId);
      btn.classList.toggle('is-active', isInCompare);
      btn.setAttribute('aria-pressed', isInCompare);
    });
  }

  function openDrawer() {
    if (!hasDrawer) return;
    drawer.classList.add('is-open');
    drawer.setAttribute('aria-hidden', 'false');
    drawer.removeAttribute('inert');
    floatingBtn.setAttribute('aria-expanded', 'true');
    document.body.style.paddingBottom = drawer.offsetHeight + 'px';

    // Focus first focusable element in drawer
    const firstFocusable = drawer.querySelector('button, a, input');
    if (firstFocusable) {
      requestAnimationFrame(() => firstFocusable.focus());
    }
  }

  function closeDrawer() {
    if (!hasDrawer) return;
    drawer.classList.remove('is-open');
    drawer.setAttribute('aria-hidden', 'true');
    drawer.setAttribute('inert', '');
    floatingBtn.setAttribute('aria-expanded', 'false');
    document.body.style.paddingBottom = '';
  }

  // Escape key handler
  document.addEventListener('keydown', (e) => {
    if (hasDrawer && e.key === 'Escape' && drawer.classList.contains('is-open')) {
      closeDrawer();
      floatingBtn.focus();
    }
  });

  // Event listeners
  if (hasDrawer) {
    floatingBtn.addEventListener('click', () => {
      if (drawer.classList.contains('is-open')) {
        closeDrawer();
      } else {
        openDrawer();
      }
    });

    closeBtn?.addEventListener('click', closeDrawer);
    clearBtn?.addEventListener('click', clearProducts);
  }

  // Handle drawer toggle buttons (like facets toolbar) - outside hasDrawer check
  // so it works even if floating button isn't rendered
  document.addEventListener('click', (e) => {
    const toggleBtn = e.target.closest('[data-compare-drawer-toggle]');
    if (!toggleBtn) return;
    e.preventDefault();
    if (drawer && drawer.classList.contains('is-open')) {
      closeDrawer();
    } else {
      openDrawer();
    }
  });

  // Listen for compare events from product cards
  document.addEventListener('compare:toggle', (e) => {
    const { product } = e.detail;
    if (!product) return;

    const products = getProducts();
    const exists = products.some(p => String(p.id) === String(product.id));

    if (exists) {
      removeProduct(product.id);
    } else if (products.length < MAX_PRODUCTS) {
      products.push({
        ...product,
        addedAt: Date.now()
      });
      saveProducts(products);
      updateUI();
      document.dispatchEvent(new CustomEvent('compare:added', { detail: { product } }));
      announce(`${product.title} added to comparison`);
    } else {
      announce('Maximum 4 products can be compared');
    }
  });

  // Listen for storage changes from other tabs
  window.addEventListener('storage', (e) => {
    if (e.key === STORAGE_KEY) {
      updateUI();
    }
  });

  // Click handler for compare toggle buttons on product cards
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-compare-toggle]');
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const productJson = btn.dataset.productJson;
    if (!productJson) return;

    try {
      const product = JSON.parse(productJson);
      // Dispatch the toggle event
      document.dispatchEvent(new CustomEvent('compare:toggle', { detail: { product } }));
    } catch (err) {
      console.error('Compare: Failed to parse product data', err);
    }
  });

  /**
   * Check if we're on the compare page and hide floating button + close drawer
   */
  function checkComparePageAndCloseDrawer() {
    const isComparePage = window.location.pathname.includes('/pages/compare');
    if (isComparePage) {
      // Hide floating button on compare page
      if (floatingBtn) {
        floatingBtn.style.display = 'none';
      }
      // Close drawer if open
      if (drawer && drawer.classList.contains('is-open')) {
        closeDrawer();
      }
    } else {
      // Show floating button on other pages (visibility controlled by updateUI)
      if (floatingBtn) {
        floatingBtn.style.display = '';
      }
    }
  }

  /**
   * Adjust floating button position based on sticky product bar visibility
   */
  function adjustFloatingBtnPosition() {
    if (!floatingBtn) return;
    const stickyBar = document.querySelector('.sticky-product-bar.is-visible');
    if (stickyBar) {
      floatingBtn.classList.add('is-above-sticky-bar');
    } else {
      floatingBtn.classList.remove('is-above-sticky-bar');
    }
  }

  // Watch for sticky bar visibility changes via MutationObserver
  const stickyBarObserver = new MutationObserver(() => {
    adjustFloatingBtnPosition();
  });

  // Observe sticky bar class changes
  function observeStickyBar() {
    const stickyBar = document.querySelector('.sticky-product-bar');
    if (stickyBar) {
      stickyBarObserver.observe(stickyBar, { attributes: true, attributeFilter: ['class'] });
    }
  }

  // Initialize
  updateUI();
  checkComparePageAndCloseDrawer();
  adjustFloatingBtnPosition();
  observeStickyBar();

  // Re-init on Swup navigation - listen to both events for reliability
  if (window.onSwupContentReplaced) {
    window.onSwupContentReplaced('compare_drawer', () => {
      // Use requestAnimationFrame to ensure DOM is fully updated
      requestAnimationFrame(() => {
        updateUI();
        checkComparePageAndCloseDrawer();
        adjustFloatingBtnPosition();
        observeStickyBar();
      });
    });
  }

  // Also update after transition completes (for cached pages)
  window.addEventListener('swup:transitionEnd', () => {
    requestAnimationFrame(() => {
      updateUI();
      checkComparePageAndCloseDrawer();
    });
  });

  // Update after facet filtering replaces product grid
  document.addEventListener('facets:updated', updateUI);
})();
</script>
