{%- comment -%}
  Size Chart Drawer
  Renders a drawer with size chart content.
  When rendered from theme.liquid, shows default content.
  Product section can populate it dynamically via data attributes.

  Accepts:
  - heading: {String} Drawer heading (optional)
  - page: {Page} Page object containing size chart content
  - content: {String} Rich text content if no page is specified

  Usage:
  {% render 'size-chart-drawer', heading: 'Size Guide', page: page %}
{%- endcomment -%}

<div
  id="size-chart-drawer"
  class="drawer-container group fixed inset-0 z-[999]"
  role="dialog"
  aria-modal="true"
  aria-labelledby="size-chart-drawer-title"
  data-size-chart-drawer
>
  {%- comment -%} Backdrop {%- endcomment -%}
  <div class="drawer-backdrop" data-size-chart-close></div>

  {%- comment -%} Panel {%- endcomment -%}
  <div class="absolute top-0 right-0 bottom-0 w-full max-w-[540px] h-full bg-[--color-background] flex flex-col transform translate-x-full transition-transform duration-300 shadow-[-4px_0_24px_rgba(0,0,0,0.15)] border-l border-[--color-border] group-[.is-open]:translate-x-0">
    {%- comment -%} Header {%- endcomment -%}
    <div class="flex items-center gap-3 px-6 py-5 border-b border-[--color-border]">
      <h2 id="size-chart-drawer-title" class="flex-1 text-xl font-[--font-heading-weight] m-0 font-heading" data-size-chart-title>
        {%- liquid
          if heading != blank
            echo heading
          else
            echo 'products.size_chart.title' | t
          endif
        -%}
      </h2>
      <button
        type="button"
        class="flex items-center justify-center w-10 h-10 -m-2 ml-auto bg-transparent border-none text-[--color-text] cursor-pointer transition-opacity hover:opacity-60"
        data-size-chart-close
        aria-label="{{ 'accessibility.close' | t }}"
      >
        <i class="ph ph-x text-xl"></i>
      </button>
    </div>

    {%- comment -%} Body {%- endcomment -%}
    <div class="flex-1 overflow-y-auto p-6" data-size-chart-body>
      {% if page != blank and page.content != blank %}
        <div class="prose prose-sm max-w-none">
          {{ page.content }}
        </div>
      {% elsif content != blank %}
        <div class="prose prose-sm max-w-none">
          {{ content }}
        </div>
      {% else %}
        {%- comment -%} Default size chart table {%- endcomment -%}
        <div class="space-y-6" data-size-chart-default>
          <div>
            <h3 class="text-sm font-medium mb-2">{{ 'products.size_chart.how_to_measure' | t }}</h3>
            <p class="text-sm text-[--color-text-secondary]">
              {{ 'products.size_chart.measure_instructions' | t }}
            </p>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-sm border-collapse">
              <thead>
                <tr class="border-b border-[--color-border]">
                  <th class="py-3 px-4 text-left font-medium">{{ 'products.size_chart.size' | t }}</th>
                  <th class="py-3 px-4 text-center font-medium">{{ 'products.size_chart.chest' | t }}</th>
                  <th class="py-3 px-4 text-center font-medium">{{ 'products.size_chart.waist' | t }}</th>
                  <th class="py-3 px-4 text-center font-medium">{{ 'products.size_chart.hips' | t }}</th>
                </tr>
              </thead>
              <tbody>
                <tr class="border-b border-[--color-border]">
                  <td class="py-3 px-4 font-medium">XS</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">32-34"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">24-26"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">34-36"</td>
                </tr>
                <tr class="border-b border-[--color-border]">
                  <td class="py-3 px-4 font-medium">S</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">34-36"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">26-28"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">36-38"</td>
                </tr>
                <tr class="border-b border-[--color-border]">
                  <td class="py-3 px-4 font-medium">M</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">36-38"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">28-30"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">38-40"</td>
                </tr>
                <tr class="border-b border-[--color-border]">
                  <td class="py-3 px-4 font-medium">L</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">38-40"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">30-32"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">40-42"</td>
                </tr>
                <tr class="border-b border-[--color-border]">
                  <td class="py-3 px-4 font-medium">XL</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">40-42"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">32-34"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">42-44"</td>
                </tr>
                <tr>
                  <td class="py-3 px-4 font-medium">XXL</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">42-44"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">34-36"</td>
                  <td class="py-3 px-4 text-center text-[--color-text-secondary]">44-46"</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="p-4 bg-[--color-background-secondary] rounded-lg">
            <p class="text-sm text-[--color-text-secondary]">
              <i class="ph ph-info mr-2"></i>
              {{ 'products.size_chart.fit_note' | t }}
            </p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function() {
  const drawer = document.getElementById('size-chart-drawer');
  if (!drawer || drawer.dataset.initialized) return;
  drawer.dataset.initialized = 'true';

  const closeButtons = drawer.querySelectorAll('[data-size-chart-close]');
  let isOpen = false;
  let scrollPosition = 0;

  function openDrawer() {
    if (isOpen) return;
    isOpen = true;

    scrollPosition = window.scrollY;
    document.body.style.top = `-${scrollPosition}px`;
    document.documentElement.classList.add('scroll-locked');
    if (window.lenis) window.lenis.stop();

    requestAnimationFrame(() => {
      drawer.classList.add('is-open');
    });
  }

  function closeDrawer() {
    if (!isOpen) return;
    isOpen = false;

    drawer.classList.remove('is-open');

    setTimeout(() => {
      document.documentElement.classList.remove('scroll-locked');
      document.body.style.top = '';
      window.scrollTo(0, scrollPosition);
      if (window.lenis) window.lenis.start();
    }, 300);
  }

  // Use event delegation for open triggers (works after Swup navigation)
  document.addEventListener('click', (e) => {
    const trigger = e.target.closest('[data-size-chart-open]');
    if (trigger) {
      e.preventDefault();
      openDrawer();
    }
  });

  // Close triggers
  closeButtons.forEach(btn => {
    btn.addEventListener('click', closeDrawer);
  });

  // Close on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isOpen) {
      closeDrawer();
    }
  });

  // Global events for opening/closing from elsewhere
  document.addEventListener('size-chart:open', openDrawer);
  document.addEventListener('size-chart:close', closeDrawer);
})();
</script>
