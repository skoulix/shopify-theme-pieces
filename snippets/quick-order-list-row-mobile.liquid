{% comment %}
  Variant List Row - Mobile version (Tailwind)

  Accepts:
  - item: {Object} Variant or Product object
  - sku: {String} Sku of Product or Variant (optional)
  - image: {Object} Product or Variant image (optional)
  - variant: {Object} Variant object
  - show_image: {Boolean} Show product image
  - show_sku: {Boolean} Show SKU

  Usage:
  {% render 'quick-order-list-row-mobile' variant: variant %}
{% endcomment %}

{% # theme-check-disable %}
{% assign cart_qty = cart | item_count_for_variant: variant.id %}
{% # theme-check-enable %}

{%- liquid
  assign check_against_inventory = true
  if variant.inventory_management != 'shopify' or variant.inventory_policy == 'continue'
    assign check_against_inventory = false
  endif
  if variant.quantity_rule.min > variant.inventory_quantity and check_against_inventory
    assign quantity_rule_soldout = true
  endif

  assign has_qty_rules = false
  if variant.quantity_rule.increment > 1 or variant.quantity_rule.min > 1 or variant.quantity_rule.max != null
    assign has_qty_rules = true
  endif

  assign has_vol_pricing = false
  if variant.quantity_price_breaks.size > 0
    assign has_vol_pricing = true
  endif

  assign is_available = false
  assign has_popover = false
  unless variant.available == false or quantity_rule_soldout
    assign is_available = true
  endunless
  if has_qty_rules or has_vol_pricing
    assign has_popover = true
  endif
-%}

<div
  class="variant-item grid gap-4{% if show_image %} grid-cols-[3rem_1fr]{% endif %}"
  id="Variant-Mobile-{{ variant.id }}"
  data-variant-id="{{ variant.id }}"
>
  {%- comment -%} Image {%- endcomment -%}
  {%- if show_image -%}
    <div class="w-12 h-12 flex-shrink-0 rounded-lg overflow-hidden bg-neutral-100{% unless is_modal %} gradient{% endunless %}">
      {% if image %}
        {%- assign img_height = 48 | divided_by: image.aspect_ratio | ceil -%}
        {{ image | image_url: width: 96 | image_tag:
          loading: 'lazy',
          fetchpriority: 'low',
          decoding: 'async',
          class: 'w-full h-full object-cover',
          width: 48,
          height: img_height,
          widths: '96',
          alt: image.alt | escape
        }}
      {% endif %}
    </div>
  {%- endif -%}

  {%- comment -%} Content {%- endcomment -%}
  <div class="flex flex-col gap-3">
    {%- comment -%} Title, SKU and Total {%- endcomment -%}
    <div class="flex justify-between items-start">
      <div>
        <span class="text-sm font-medium text-neutral-900 block">{{ item.title | escape }}</span>
        {%- if show_sku and sku -%}
          <span class="text-xs text-neutral-500">{{ sku | escape }}</span>
        {%- endif -%}
      </div>
      <div class="text-right relative">
        {%- render 'loading-spinner' -%}
        {% # theme-check-disable %}
        <span class="text-sm font-medium text-neutral-900">{{ cart | line_items_for: item | sum: 'original_line_price' | money }}</span>
        {% # theme-check-enable %}
      </div>
    </div>

    {%- comment -%} Price {%- endcomment -%}
    <div class="text-sm text-neutral-600">
      {%- assign item_price = item.price | money -%}
      {%- if item.compare_at_price -%}
        <s class="text-neutral-400 mr-2">{{ item.compare_at_price | money }}</s>
        {%- if variant.quantity_price_breaks.size > 0 -%}
          {%- liquid
            assign volume_pricing_array = variant.quantity_price_breaks | sort: 'quantity' | reverse
          -%}
          <price-per-item
            class="inline"
            id="Price-Per-Item-Mobile-{{ variant.id }}"
            data-variant-id="{{ variant.id }}"
          >
            {%- if cart_qty < volume_pricing_array.last.minimum_quantity -%}
              {%- assign variant_price = variant.price | money -%}
              <span class="price-per-item--current">{{ 'sections.quick_order_list.each' | t: money: variant_price }}</span>
            {%- else -%}
              {%- for price_break in volume_pricing_array -%}
                {%- if cart_qty >= price_break.minimum_quantity -%}
                  {%- assign price_break_price = price_break.price | money -%}
                  <span class="price-per-item--current">{{ 'sections.quick_order_list.each' | t: money: price_break_price }}</span>
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          </price-per-item>
        {%- else -%}
          <span>{{ 'sections.quick_order_list.each' | t: money: item_price }}</span>
        {%- endif -%}
      {%- else -%}
        {%- if variant.quantity_price_breaks.size > 0 -%}
          {%- liquid
            assign volume_pricing_array = variant.quantity_price_breaks | sort: 'quantity' | reverse
          -%}
          <price-per-item
            class="inline"
            id="Price-Per-Item-Mobile-{{ variant.id }}"
            data-variant-id="{{ variant.id }}"
          >
            {%- if cart_qty < volume_pricing_array.last.minimum_quantity -%}
              {%- assign variant_price = variant.price | money -%}
              <span class="price-per-item--current">{{ 'sections.quick_order_list.each' | t: money: variant_price }}</span>
            {%- else -%}
              {%- for price_break in volume_pricing_array -%}
                {%- if cart_qty >= price_break.minimum_quantity -%}
                  {%- assign price_break_price = price_break.price | money -%}
                  <span class="price-per-item--current">{{ 'sections.quick_order_list.each' | t: money: price_break_price }}</span>
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          </price-per-item>
        {%- else -%}
          <span>{{ 'sections.quick_order_list.each' | t: money: item_price }}</span>
        {%- endif -%}
      {%- endif -%}

      {%- if item.available and item.unit_price_measurement -%}
        <span class="block mt-1">
          {% render 'unit-price', price: item.unit_price, measurement: item.unit_price_measurement %}
        </span>
      {%- endif -%}
    </div>

    {%- comment -%} Quantity Controls {%- endcomment -%}
    <quantity-popover class="relative block">
      <div class="flex flex-wrap items-center gap-3">
        {%- if variant.available == false or quantity_rule_soldout -%}
          <span class="text-sm text-neutral-500">{{ 'products.product.sold_out' | t }}</span>
        {%- else -%}
          {% render 'quantity-input', variant: variant, min: 0 %}
        {%- endif -%}

        {% if cart_qty > 0 %}
          <div
            id="Remove-Mobile-{{ variant.id }}"
            class="quick-order-list-remove-button"
            data-index="{{ variant.id }}"
          >
            <button
              class="p-1 text-neutral-400 hover:text-neutral-900 transition-colors"
              aria-label="{{ 'sections.cart.remove_title' | t: title: item.title }}"
              data-target="remove-{{ variant.id }}"
            >
              {%- render 'icon', name: 'trash', size: '16' -%}
            </button>
          </div>
        {% endif %}
      </div>

      {%- comment -%} Volume pricing / qty rules info button {%- endcomment -%}
      {%- if has_popover -%}
        <button
          type="button"
          class="quantity-popover__info-button flex items-center gap-1 text-xs text-neutral-500 hover:text-neutral-900 transition-colors mt-2"
          aria-expanded="false"
        >
          {%- render 'icon', name: 'info', size: '14' -%}
          <span>
            {%- if has_vol_pricing -%}
              {{ 'products.product.volume_pricing.note' | t }}
            {%- elsif has_qty_rules -%}
              {{ 'products.product.quantity.note' | t }}
            {%- endif -%}
          </span>
        </button>

        <div
          class="quantity-popover__info mt-2 p-3 bg-neutral-50 rounded-lg"
          tabindex="-1"
          hidden
          id="quantity-popover-info-mobile-{{ variant.id }}"
        >
          <div class="flex justify-between items-start">
            <div>
              {%- if has_qty_rules == false -%}
                <span class="block text-xs font-medium text-neutral-700 mb-2">{{ 'products.product.volume_pricing.title' | t }}</span>
              {%- endif -%}
              <div class="text-xs text-neutral-600 space-y-1">
                {%- if variant.quantity_rule.increment > 1 -%}
                  <span class="block">{{ 'products.product.quantity.multiples_of' | t: quantity: variant.quantity_rule.increment }}</span>
                {%- endif -%}
                {%- if variant.quantity_rule.min > 1 -%}
                  <span class="block">{{ 'products.product.quantity.min_of' | t: quantity: variant.quantity_rule.min }}</span>
                {%- endif -%}
                {%- if variant.quantity_rule.max != null -%}
                  <span class="block">{{ 'products.product.quantity.max_of' | t: quantity: variant.quantity_rule.max }}</span>
                {%- endif -%}
              </div>
            </div>
            <button
              class="button-close p-1 text-neutral-400 hover:text-neutral-900 transition-colors"
              type="button"
              aria-label="{{ 'accessibility.close' | t }}"
            >
              {%- render 'icon', name: 'close', size: '16' -%}
            </button>
          </div>
          {%- if variant.quantity_price_breaks.size > 0 -%}
            <volume-pricing class="block mt-2">
              <ul class="text-xs divide-y divide-neutral-200">
                <li class="flex justify-between py-1">
                  <span>{{ variant.quantity_rule.min }}+</span>
                  {%- assign price = variant.price | money_with_currency -%}
                  <span>{{ 'sections.quick_order_list.each' | t: money: price }}</span>
                </li>
                {%- for price_break in variant.quantity_price_breaks -%}
                  <li class="flex justify-between py-1">
                    <span>{{ price_break.minimum_quantity }}+</span>
                    {%- assign price = price_break.price | money_with_currency -%}
                    <span>{{ 'sections.quick_order_list.each' | t: money: price }}</span>
                  </li>
                {%- endfor -%}
              </ul>
            </volume-pricing>
          {%- endif -%}
        </div>
      {%- endif -%}

      {%- comment -%} Error message {%- endcomment -%}
      <div
        class="variant-item__error flex items-center gap-2 text-red-600 text-xs mt-2"
        id="Quick-order-list-item-error-mobile-{{ variant.id }}"
        role="alert"
      >
        <small class="variant-item__error-text"></small>
        {%- render 'icon', name: 'error', size: '14' -%}
      </div>
    </quantity-popover>
  </div>
</div>
