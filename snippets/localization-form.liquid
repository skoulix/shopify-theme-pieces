{%- comment -%}
  Localization Form - Country and Language Selector
  Required for Shopify Theme Store submission
  Supports multi-currency and multi-language stores
{%- endcomment -%}

{%- liquid
  # Handle boolean defaults properly - Liquid's default filter treats false as falsy
  if show_country == nil
    assign show_country = true
  endif
  if show_language == nil
    assign show_language = true
  endif
  assign dropdown_direction = dropdown_direction | default: 'up'

  # Dropdown positioning classes based on direction
  if dropdown_direction == 'down'
    assign dropdown_position_class = 'top-full mt-2'
  else
    assign dropdown_position_class = 'bottom-full mb-2'
  endif
-%}

<div class="localization-form flex flex-wrap items-center gap-3" style="color: inherit;">
  {%- if show_country and localization.available_countries.size > 1 -%}
    <div class="localization-form__country relative">
      {%- form 'localization', id: 'country-form', class: 'localization-form__form' -%}
        <div class="relative">
          <button
            type="button"
            class="localization-form__button flex items-center gap-2 text-sm hover:opacity-70 transition-opacity"
            style="color: inherit;"
            aria-expanded="false"
            aria-controls="country-list"
            data-localization-trigger="country"
          >
            <span class="localization-form__flag">{{ localization.country.iso_code | replace: 'A', 'ðŸ‡¦' | replace: 'B', 'ðŸ‡§' | replace: 'C', 'ðŸ‡¨' | replace: 'D', 'ðŸ‡©' | replace: 'E', 'ðŸ‡ª' | replace: 'F', 'ðŸ‡«' | replace: 'G', 'ðŸ‡¬' | replace: 'H', 'ðŸ‡­' | replace: 'I', 'ðŸ‡®' | replace: 'J', 'ðŸ‡¯' | replace: 'K', 'ðŸ‡°' | replace: 'L', 'ðŸ‡±' | replace: 'M', 'ðŸ‡²' | replace: 'N', 'ðŸ‡³' | replace: 'O', 'ðŸ‡´' | replace: 'P', 'ðŸ‡µ' | replace: 'Q', 'ðŸ‡¶' | replace: 'R', 'ðŸ‡·' | replace: 'S', 'ðŸ‡¸' | replace: 'T', 'ðŸ‡¹' | replace: 'U', 'ðŸ‡º' | replace: 'V', 'ðŸ‡»' | replace: 'W', 'ðŸ‡¼' | replace: 'X', 'ðŸ‡½' | replace: 'Y', 'ðŸ‡¾' | replace: 'Z', 'ðŸ‡¿' }}</span>
            <span class="localization-form__currency">{{ localization.country.currency.iso_code }}</span>
            <i class="ph ph-caret-down text-xs transition-transform duration-200" data-caret></i>
          </button>

          <div
            id="country-list"
            class="localization-form__dropdown absolute {{ dropdown_position_class }} left-0 min-w-60 max-h-75 bg-(--color-background) text-(--color-text) border border-(--color-border) rounded-lg shadow-lg opacity-0 invisible translate-y-2 transition-all duration-200 z-50"
            data-localization-panel="country"
            data-lenis-prevent
          >
            <div class="p-2 border-b border-(--color-border)">
              <input
                type="text"
                class="w-full px-3 py-2 text-xs bg-(--color-background-secondary) border border-(--color-border) rounded-md outline-none focus:border-(--color-primary) transition-colors"
                placeholder="{{ 'localization.search_country' | t | default: 'Search countries...' }}"
                data-country-search
              >
            </div>
            <ul class="py-2 max-h-50 overflow-y-auto" role="listbox" aria-label="{{ 'localization.country_label' | t }}" data-country-list>
              {%- for country in localization.available_countries -%}
                <li>
                  <button
                    type="button"
                    class="w-full px-4 py-2 text-left text-xs text-(--color-text) hover:bg-(--color-background-secondary) transition-colors flex items-center justify-between gap-2{% if country.iso_code == localization.country.iso_code %} font-semibold{% endif %}"
                    data-country-code="{{ country.iso_code }}"
                    role="option"
                    aria-selected="{% if country.iso_code == localization.country.iso_code %}true{% else %}false{% endif %}"
                  >
                    <span class="flex items-center gap-2"><span>{{ country.iso_code | replace: 'A', 'ðŸ‡¦' | replace: 'B', 'ðŸ‡§' | replace: 'C', 'ðŸ‡¨' | replace: 'D', 'ðŸ‡©' | replace: 'E', 'ðŸ‡ª' | replace: 'F', 'ðŸ‡«' | replace: 'G', 'ðŸ‡¬' | replace: 'H', 'ðŸ‡­' | replace: 'I', 'ðŸ‡®' | replace: 'J', 'ðŸ‡¯' | replace: 'K', 'ðŸ‡°' | replace: 'L', 'ðŸ‡±' | replace: 'M', 'ðŸ‡²' | replace: 'N', 'ðŸ‡³' | replace: 'O', 'ðŸ‡´' | replace: 'P', 'ðŸ‡µ' | replace: 'Q', 'ðŸ‡¶' | replace: 'R', 'ðŸ‡·' | replace: 'S', 'ðŸ‡¸' | replace: 'T', 'ðŸ‡¹' | replace: 'U', 'ðŸ‡º' | replace: 'V', 'ðŸ‡»' | replace: 'W', 'ðŸ‡¼' | replace: 'X', 'ðŸ‡½' | replace: 'Y', 'ðŸ‡¾' | replace: 'Z', 'ðŸ‡¿' }}</span>{{ country.name }}</span>
                    <span class="text-(--color-text-secondary)">{{ country.currency.iso_code }} {{ country.currency.symbol }}</span>
                  </button>
                </li>
              {%- endfor -%}
            </ul>
          </div>

          <input type="hidden" name="country_code" value="{{ localization.country.iso_code }}" data-country-input>
        </div>
      {%- endform -%}
    </div>
  {%- endif -%}

  {%- if show_language and localization.available_languages.size > 1 -%}
    <div class="localization-form__language relative">
      {%- form 'localization', id: 'language-form', class: 'localization-form__form' -%}
        <div class="relative">
          <button
            type="button"
            class="localization-form__button flex items-center gap-2 text-sm hover:opacity-70 transition-opacity"
            style="color: inherit;"
            aria-expanded="false"
            aria-controls="language-list"
            data-localization-trigger="language"
          >
            <span class="localization-form__language-name">{{ localization.language.endonym_name | capitalize }}</span>
            <i class="ph ph-caret-down text-xs transition-transform duration-200" data-caret></i>
          </button>

          <div
            id="language-list"
            class="localization-form__dropdown absolute {{ dropdown_position_class }} left-0 min-w-50 max-h-75 overflow-y-auto bg-(--color-background) text-(--color-text) border border-(--color-border) rounded-lg shadow-lg opacity-0 invisible translate-y-2 transition-all duration-200 z-50"
            data-localization-panel="language"
            data-lenis-prevent
          >
            <ul class="py-2" role="listbox" aria-label="{{ 'localization.language_label' | t }}">
              {%- for language in localization.available_languages -%}
                <li>
                  <button
                    type="button"
                    class="w-full px-4 py-2 text-left text-xs text-(--color-text) hover:bg-(--color-background-secondary) transition-colors{% if language.iso_code == localization.language.iso_code %} font-semibold{% endif %}"
                    data-language-code="{{ language.iso_code }}"
                    hreflang="{{ language.iso_code }}"
                    role="option"
                    aria-selected="{% if language.iso_code == localization.language.iso_code %}true{% else %}false{% endif %}"
                  >
                    {{ language.endonym_name | capitalize }}
                  </button>
                </li>
              {%- endfor -%}
            </ul>
          </div>

          <input type="hidden" name="locale_code" value="{{ localization.language.iso_code }}" data-language-input>
        </div>
      {%- endform -%}
    </div>
  {%- endif -%}
</div>

<script>
(function() {
  const localizationForms = document.querySelectorAll('.localization-form');
  if (!localizationForms.length) return;

  localizationForms.forEach(form => {
    if (form.dataset.initialized) return;
    form.dataset.initialized = 'true';

    // Country selector
    const countryTrigger = form.querySelector('[data-localization-trigger="country"]');
    const countryPanel = form.querySelector('[data-localization-panel="country"]');
    const countryInput = form.querySelector('[data-country-input]');
    const countryForm = form.querySelector('#country-form');

    // Language selector
    const languageTrigger = form.querySelector('[data-localization-trigger="language"]');
    const languagePanel = form.querySelector('[data-localization-panel="language"]');
    const languageInput = form.querySelector('[data-language-input]');
    const languageForm = form.querySelector('#language-form');

    function openPanel(trigger, panel) {
      trigger.setAttribute('aria-expanded', 'true');
      panel.classList.remove('opacity-0', 'invisible', 'translate-y-2');
      panel.classList.add('opacity-100', 'visible', 'translate-y-0');
      const caret = trigger.querySelector('[data-caret]');
      if (caret) caret.style.transform = 'rotate(180deg)';
    }

    function closePanel(trigger, panel) {
      trigger.setAttribute('aria-expanded', 'false');
      panel.classList.add('opacity-0', 'invisible', 'translate-y-2');
      panel.classList.remove('opacity-100', 'visible', 'translate-y-0');
      const caret = trigger.querySelector('[data-caret]');
      if (caret) caret.style.transform = '';
    }

    function closeAllPanels() {
      if (countryTrigger && countryPanel) closePanel(countryTrigger, countryPanel);
      if (languageTrigger && languagePanel) closePanel(languageTrigger, languagePanel);
    }

    // Country toggle
    if (countryTrigger && countryPanel) {
      const countrySearch = countryPanel.querySelector('[data-country-search]');
      const countryList = countryPanel.querySelector('[data-country-list]');
      const countryItems = countryList ? countryList.querySelectorAll('li') : [];

      countryTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = countryTrigger.getAttribute('aria-expanded') === 'true';
        closeAllPanels();
        if (!isOpen) {
          openPanel(countryTrigger, countryPanel);
          if (countrySearch) {
            countrySearch.value = '';
            countryItems.forEach(item => item.style.display = '');
            setTimeout(() => countrySearch.focus(), 50);
          }
        }
      });

      // Country search
      if (countrySearch) {
        countrySearch.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          countryItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(query) ? '' : 'none';
          });
        });
        countrySearch.addEventListener('click', (e) => e.stopPropagation());
      }

      // Country selection
      countryPanel.querySelectorAll('[data-country-code]').forEach(btn => {
        btn.addEventListener('click', () => {
          countryInput.value = btn.dataset.countryCode;
          countryForm.submit();
        });
      });
    }

    // Language toggle
    if (languageTrigger && languagePanel) {
      languageTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = languageTrigger.getAttribute('aria-expanded') === 'true';
        closeAllPanels();
        if (!isOpen) openPanel(languageTrigger, languagePanel);
      });

      // Language selection
      languagePanel.querySelectorAll('[data-language-code]').forEach(btn => {
        btn.addEventListener('click', () => {
          languageInput.value = btn.dataset.languageCode;
          languageForm.submit();
        });
      });
    }

    // Close on outside click
    document.addEventListener('click', closeAllPanels);

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeAllPanels();
    });
  });
})();
</script>
