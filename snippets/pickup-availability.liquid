{%- comment -%}
  Pickup Availability
  Shows store pickup availability for the selected variant
  Required for Shopify Theme Store submission

  Required variables:
  - product: The product object
  - form_id: The ID of the product form (for variant change updates)

  Note: The pickup availability modal/drawer is rendered in theme.liquid
{%- endcomment -%}

{%- assign current_variant = product.selected_or_first_available_variant -%}

<pickup-availability
  class="pickup-availability block mt-4"
  data-root-url="{{ routes.root_url }}"
  data-variant-id="{{ current_variant.id }}"
  data-has-only-default-variant="{{ product.has_only_default_variant }}"
  {% if current_variant.available %}available{% endif %}
>
  <template>
    <div class="pickup-availability__preview flex items-start gap-3 p-4 border border-[--color-border] rounded-[--card-radius]">
      <div class="pickup-availability__icon flex-shrink-0 mt-0.5">
        <i class="ph ph-storefront text-xl"></i>
      </div>
      <div class="pickup-availability__info flex-1">
        <p class="pickup-availability__title text-sm font-medium" data-pickup-availability-title>
          {{ 'products.pickup_availability.pickup_available' | t }}
        </p>
        <button
          class="pickup-availability__button text-sm text-[--color-primary] underline underline-offset-2 mt-1"
          data-pickup-availability-modal-open
          type="button"
        >
          {{ 'products.pickup_availability.view_store_info' | t }}
        </button>
      </div>
    </div>
  </template>
</pickup-availability>

<script>
class PickupAvailability extends HTMLElement {
  constructor() {
    super();
    if (!this.hasAttribute('available')) return;
    this.render();
    this.initModal();
  }

  render() {
    const template = this.querySelector('template');
    if (template) {
      this.appendChild(template.content.cloneNode(true));
    }
  }

  initModal() {
    const modalOpenBtn = this.querySelector('[data-pickup-availability-modal-open]');
    if (modalOpenBtn) {
      modalOpenBtn.addEventListener('click', () => this.openModal());
    }
  }

  async openModal() {
    const modal = document.querySelector('[data-pickup-availability-modal]');
    const content = modal?.querySelector('[data-pickup-availability-modal-content]');
    if (!modal || !content) return;

    // Show modal - use requestAnimationFrame to ensure transition triggers
    document.body.style.overflow = 'hidden';
    requestAnimationFrame(() => {
      modal.classList.add('is-open');
    });

    // Fetch pickup availability info
    const variantId = this.dataset.variantId;
    const rootUrl = this.dataset.rootUrl;

    try {
      const response = await fetch(`${rootUrl}variants/${variantId}/?section_id=pickup-availability`);
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const pickupContent = doc.querySelector('.pickup-availability-list');

      if (pickupContent) {
        content.innerHTML = pickupContent.outerHTML;
      } else {
        content.innerHTML = `<p class="text-sm text-[--color-text-secondary]">{{ 'products.pickup_availability.unavailable' | t }}</p>`;
      }
    } catch (error) {
      console.error('Error fetching pickup availability:', error);
      content.innerHTML = `<p class="text-sm text-[--color-text-secondary]">{{ 'products.pickup_availability.unavailable' | t }}</p>`;
    }

    // Setup close handlers
    modal.querySelectorAll('[data-pickup-availability-modal-close]').forEach(btn => {
      btn.addEventListener('click', () => this.closeModal(), { once: true });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') this.closeModal();
    }, { once: true });
  }

  closeModal() {
    const modal = document.querySelector('[data-pickup-availability-modal]');
    if (!modal) return;

    modal.classList.remove('is-open');
    setTimeout(() => {
      document.body.style.overflow = '';
    }, 300);
  }

  update(variantId) {
    this.dataset.variantId = variantId;
    const inner = this.querySelector('.pickup-availability__preview');
    if (inner) inner.remove();

    // Fetch new availability
    fetch(`${this.dataset.rootUrl}variants/${variantId}/?section_id=pickup-availability`)
      .then(res => res.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const availability = doc.querySelector('pickup-availability');
        if (availability && availability.hasAttribute('available')) {
          this.setAttribute('available', '');
          this.render();
          this.initModal();
        } else {
          this.removeAttribute('available');
        }
      });
  }
}

if (!customElements.get('pickup-availability')) {
  customElements.define('pickup-availability', PickupAvailability);
}
</script>
