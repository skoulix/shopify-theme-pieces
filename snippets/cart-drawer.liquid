
{%- comment -%}
  Cart Drawer - Slide-out cart panel
  Renders when settings.cart_type == 'drawer'
{%- endcomment -%}

<div
  id="cart-drawer"
  class="drawer-container group fixed inset-0 z-200 pointer-events-none invisible [&.is-open]:pointer-events-auto [&.is-open]:visible [&.is-loading]:cursor-wait [&.is-updating]:cursor-wait"
  role="dialog"
  aria-modal="true"
  aria-busy="false"
  inert
  aria-label="{{ 'cart.title' | t }}"
>
  {%- comment -%} Live region for screen reader announcements {%- endcomment -%}
  <div class="sr-only" aria-live="polite" aria-atomic="true" data-cart-status></div>
  {%- comment -%} Backdrop {%- endcomment -%}
  <div class="drawer-backdrop group-[.is-open]:opacity-100" data-cart-drawer-close></div>

  {%- comment -%} Drawer Panel {%- endcomment -%}
  <div class="color-scheme-1 absolute top-0 right-0 w-full max-w-[460px] h-full bg-(--color-background) flex flex-col translate-x-full transition-transform duration-300 ease-out group-[.is-open]:translate-x-0 shadow-[-4px_0_24px_rgba(0,0,0,0.15)] border-l border-(--color-border)" data-cart-drawer-panel>
    {%- comment -%} Header {%- endcomment -%}
    <div class="flex items-center gap-3 px-6 py-5 border-b border-(--color-border)">
      <h2 class="flex-1 drawer-title text-xl m-0 flex items-center gap-3">
        {{ 'cart.title' | t }}
        <span class="cart-drawer__spinner" aria-hidden="true">
          <i class="ph ph-circle-notch text-base"></i>
        </span>
      </h2>
      <button type="button" class="drawer-close" data-cart-drawer-close>
        <span class="sr-only">{{ 'cart.close' | t }}</span>
        <i class="ph ph-x text-xl"></i>
      </button>
    </div>

    {%- comment -%} Free Shipping Progress - always render, JS handles visibility {%- endcomment -%}
    <div class="px-6 pt-4">
      {% render 'free-shipping-progress' %}
    </div>

    {%- comment -%} Cart Contents {%- endcomment -%}
    <div
      class="flex-1 overflow-y-auto p-6 transition-opacity group-[.is-loading]:opacity-50 group-[.is-loading]:pointer-events-none group-[.is-updating]:opacity-50 group-[.is-updating]:pointer-events-none overscroll-contain"
      data-cart-drawer-content
      data-lenis-prevent
    >
      {% if cart.item_count > 0 %}
        <ul class="list-none m-0 p-0 flex flex-col gap-6" role="list">
          {% for item in cart.items %}
            <li class="grid grid-cols-[80px_1fr] gap-4 pb-6 border-b border-(--color-border) last:pb-0 last:border-b-0" data-cart-item data-line-index="{{ forloop.index }}">
              <div class="aspect-square overflow-hidden bg-(--color-background-secondary)">
                {% if item.image %}
                  <a href="{{ item.url }}" aria-label="{{ item.product.title }}">
                    {{ item.image | image_url: width: 200 | image_tag:
                      class: 'w-full h-full object-cover',
                      loading: 'lazy',
                      decoding: 'async',
                      alt: item.image.alt | default: item.product.title
                    }}
                  </a>
                {% endif %}
              </div>

              <div class="flex flex-col gap-1">
                <a href="{{ item.url }}" class="text-sm font-medium text-(--color-text) no-underline leading-tight hover:text-(--color-primary)">
                  {{ item.product.title }}
                </a>
                {% unless item.product.has_only_default_variant %}
                  <p class="text-xs text-(--color-text-secondary) m-0">{{ item.variant.title }}</p>
                {% endunless %}

                {%- comment -%} Selling Plan - subscription info {%- endcomment -%}
                {% if item.selling_plan_allocation %}
                  <p class="text-xs text-(--color-primary) m-0">
                    {{ item.selling_plan_allocation.selling_plan.name }}
                  </p>
                {% endif %}

                <div class="text-sm font-medium mt-1">
                  {%- liquid
                    assign has_compare_at = false
                    if item.variant.compare_at_price > item.variant.price
                      assign has_compare_at = true
                      assign compare_at_line_price = item.variant.compare_at_price | times: item.quantity
                    endif
                    assign has_discount = false
                    if item.original_line_price != item.final_line_price
                      assign has_discount = true
                    endif
                  -%}
                  {% if has_compare_at %}
                    <span class="line-through text-(--color-text-secondary) mr-2">{{ compare_at_line_price | money }}</span>
                  {% elsif has_discount %}
                    <span class="line-through text-(--color-text-secondary) mr-2">{{ item.original_line_price | money }}</span>
                  {% endif %}
                  <span class="{% if has_compare_at or has_discount %}text-(--color-sale){% endif %}">
                    {{ item.final_line_price | money }}
                  </span>
                </div>

                {%- comment -%} Unit Price {%- endcomment -%}
                {%- if item.unit_price_measurement -%}
                  <div class="text-xs text-(--color-text-secondary)">
                    <span class="visually-hidden">{{ 'accessibility.unit_price_separator' | t }}</span>
                    {{ item.unit_price | money }}/{{ item.unit_price_measurement.reference_value }}{{ item.unit_price_measurement.reference_unit }}
                  </div>
                {%- endif -%}

                {%- comment -%} Line-level discount display - Required for Theme Store {%- endcomment -%}
                {%- if item.line_level_discount_allocations.size > 0 -%}
                  <ul class="list-none p-0 m-0 mt-1" role="list" aria-label="{{ 'accessibility.discount' | t }}">
                    {%- for discount in item.line_level_discount_allocations -%}
                      <li class="inline-flex items-center gap-1 text-xs text-green-600">
                        <i class="ph ph-tag"></i>
                        <span>{{ discount.discount_application.title }} (-{{ discount.amount | money }})</span>
                      </li>
                    {%- endfor -%}
                  </ul>
                {%- endif -%}

                <div class="flex items-center gap-3 mt-auto pt-2">
                  <div class="cart-drawer__quantity" data-quantity-wrapper style="display: inline-flex; align-items: center; height: 2.5rem; padding: 0; background-color: var(--color-background); border: var(--input-border-width) solid var(--color-border); border-radius: var(--input-radius); box-shadow: var(--input-shadow);">
                    <button
                      type="button"
                      class="cart-drawer__quantity-btn"
                      data-quantity-minus
                      data-line="{{ forloop.index }}"
                      aria-label="{{ 'products.product.decrease_quantity' | t }}"
                    >
                      <i class="ph ph-minus"></i>
                    </button>
                    <div class="cart-drawer__quantity-value">
                      <input
                        type="number"
                        class="cart-drawer__quantity-input"
                        value="{{ item.quantity }}"
                        min="0"
                        data-quantity-input
                        data-line="{{ forloop.index }}"
                        aria-label="{{ 'products.product.quantity' | t }}"
                        style="border: none !important; box-shadow: none !important; outline: none !important; background: transparent !important;"
                      >
                    </div>
                    <button
                      type="button"
                      class="cart-drawer__quantity-btn"
                      data-quantity-plus
                      data-line="{{ forloop.index }}"
                      aria-label="{{ 'products.product.increase_quantity' | t }}"
                    >
                      <i class="ph ph-plus"></i>
                    </button>
                  </div>
                  <button type="button" class="remove-btn" data-remove-item data-line="{{ forloop.index }}" aria-label="{{ 'cart.remove_item' | t: title: item.product.title }}">
                    <i class="ph ph-trash text-base"></i>
                  </button>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="flex flex-col items-center justify-center text-center px-6 py-8 gap-3 h-full">
          <div class="text-5xl text-(--color-text-secondary) opacity-30 mb-2">
            <i class="ph ph-bag"></i>
          </div>
          <h3 class="drawer-title">{{ 'cart.empty' | t }}</h3>
          <p class="m-0 text-(--color-text-secondary) text-sm">{{ 'cart.empty_description' | t }}</p>
          {%- assign btn_start_shopping = 'cart.start_shopping' | t -%}
          <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary btn--full mt-2" data-cart-drawer-close>
            <i class="ph ph-storefront"></i>
            {% render 'button-text', text: btn_start_shopping %}
          </a>
        </div>
      {% endif %}
    </div>

    {%- comment -%} Footer {%- endcomment -%}
    {% if cart.item_count > 0 %}
      <div class="p-6 border-t border-(--color-border) bg-(--color-background)" data-cart-drawer-footer>
        {%- comment -%} Cart Note {%- endcomment -%}
        <details class="mb-4 group/note">
          <summary class="flex items-center justify-between w-full py-3 text-sm font-semibold tracking-wide uppercase text-(--color-text-secondary) cursor-pointer transition-colors hover:text-(--color-text)">
            <span>{{ 'cart.add_note' | t }}</span>
            <i class="ph ph-caret-down text-base transition-transform group-open/note:rotate-180"></i>
          </summary>
          <div class="pb-4">
            <textarea
              name="note"
              class="w-full min-h-[80px] p-3 text-sm bg-transparent border border-(--color-border) text-(--color-text) resize-y focus:outline-2 focus:outline-(--color-primary) focus:-outline-offset-2"
              placeholder="{{ 'cart.note_placeholder' | t }}"
              data-cart-note
            >{{ cart.note }}</textarea>
          </div>
        </details>

        {%- comment -%} Subtotal {%- endcomment -%}
        <div class="flex justify-between items-center text-base font-semibold mb-2">
          <span>{{ 'cart.subtotal' | t }}</span>
          <span data-cart-subtotal>{{ cart.total_price | money }}</span>
        </div>
        <p class="text-sm text-(--color-text-secondary) m-0 mb-4">
          {{ 'cart.taxes_shipping_note' | t }}
        </p>

        {%- comment -%} Actions {%- endcomment -%}
        {%- assign btn_view_cart = 'cart.view_cart' | t -%}
        {%- assign btn_checkout = 'cart.checkout' | t -%}
        <div class="flex flex-col gap-3">
          <a href="{{ routes.cart_url }}" class="btn btn--secondary btn--full" data-cart-drawer-close>
            {% render 'button-text', text: btn_view_cart %}
          </a>
          <form action="{{ routes.cart_url }}" method="post" class="m-0">
            <button type="submit" name="checkout" class="btn btn--primary btn--full">
              <i class="ph ph-lock-simple"></i>
              {% render 'button-text', text: btn_checkout %}
            </button>
          </form>
        </div>
      </div>
    {% endif %}
  </div>
</div>
